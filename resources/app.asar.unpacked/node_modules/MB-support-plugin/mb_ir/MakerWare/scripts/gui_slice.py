#!/usr/bin/python

import run_python_34
run_python_34.bootstrap_v34()

import os
import sys
import json
import argparse
import tempfile
import subprocess

import tkinter, tkinter.constants, tkinter.filedialog, tkinter.messagebox

import pygrue
import package_makerbot_file

def run_toolpather(miracle_grue_exe, 
                   config_filename,
                   model_filename, 
                   args, 
                   makerbot_filename):
    
    
    with open(config_filename, 'r') as config_file:
        config = pygrue.load_commented_json(config_file)
    
    bad_keys = ['jsonToolpathOutput',                                       
                'jsonProgress',                                             
                'metadataOutput',                                           
                'outputFilepath',                                           
                'configPath']
    
    for key in bad_keys:
        if key in config:
            del config[key]

    temp_dir = tempfile.mkdtemp();                                              
    
    config_filename = os.path.join(temp_dir, "sanitized.config")

    with open(config_filename, 'w') as config_file:
        json.dump(config, config_file)

    toolpath_filename = os.path.join(temp_dir, "print.jsontoolpath")       
    metadata_filename = os.path.join(temp_dir, "meta.json")

    toolpather_args = [miracle_grue_exe, '-c', config_filename, model_filename,
            '--json-toolpath', '--metadata-output',
            '--toolpath-file', toolpath_filename,
            '--metadata-file', metadata_filename]

    toolpather_args += args
    
    print("Running toolpather with args:\n %s" % " ".join(toolpather_args))
    subprocess.check_call(toolpather_args, 
                          stdout=sys.stdout, 
                          stderr=sys.stderr)
    
    package_makerbot_file.package_toolpath(toolpath_filename,
                                           metadata_filename,
                                           makerbot_filename,
					   True)

def get_model_filenames(path):
    
    model_filenames = []

    for filename in os.listdir(path):
        if os.path.splitext(filename)[1] == '.stl' or \
           os.path.splitext(filename)[1] == '.thing':
            model_filenames.append(os.path.join(path, filename))

    return model_filenames

DESCRIPTION = \
"""
Simple TK GUI tool for creating a toolpath.
"""

if __name__ == "__main__":

    parser = argparse.ArgumentParser(description=DESCRIPTION)
    
    parser.add_argument('--slice-directory', dest='slice_directory',
                        action='store_true',
                        help='Slice a directory of files at once.',
                        default=False)

    args, remaining_args = parser.parse_known_args(sys.argv[1:])

    root = tkinter.Tk()
    root.withdraw() # hide root window
    
    miracle_grue_exe = tkinter.filedialog.askopenfilename(title="Select a miracle_grue executable...")
    
    model_filenames = []
    if not args.slice_directory: 
        model_filenames.append(tkinter.filedialog.askopenfilename(title="Select a .thing or .stl file..."))
    else:
        model_path = tkinter.filedialog.askdirectory(title="Select a directory of .thing or .stl files...")
        model_filenames = get_model_filenames(model_path)

    config_filename = tkinter.filedialog.askopenfilename(title="Select a JSON config profile...")
    
    if not args.slice_directory:
        makerbot_filename = tkinter.filedialog.asksaveasfilename(title="Save toolpath as...", filetypes=[("MakerBot File", "*.makerbot")])
    else:
        makerbot_directory = tkinter.filedialog.askdirectory(title="Select a directory for .makerbot files...")

    for model_filename in model_filenames:

        if args.slice_directory:
            makerbot_filename = os.path.join(makerbot_directory, os.path.basename(model_filename) + ".makerbot")

        try:
            run_toolpather(miracle_grue_exe, config_filename, model_filename, remaining_args, makerbot_filename)
        except Exception as e:
            tkinter.messagebox.showinfo("Slicing Failed!", "%s" % e)

 
