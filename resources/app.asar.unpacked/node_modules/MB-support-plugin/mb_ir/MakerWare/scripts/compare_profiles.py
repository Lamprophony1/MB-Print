#!/usr/bin/python

import run_python_34
run_python_34.bootstrap_v34()

import os
import sys
import argparse
import json
import tempfile

import pygrue

"""
Utility to diff and nicely display the differences between two directories of
JSON files.

TODO: Move most of this into pygrue as a utility, generalize to grouping two
sets of JSON diffs no matter where they come from?
"""

class JSONFileDiff:

    """
    A diff between two JSON files
    """

    def __init__(self, dir_a, filename_a,
                       dir_b, filename_b, json_diff=None):
        self.dir_a = dir_a
        self.dir_b = dir_b
        self.filename_a = filename_a
        self.filename_b = filename_b
        self.json_diff = json_diff
        
    def rel_filenames(self):

        rel_filename_a = os.path.relpath(self.filename_a, self.dir_a) \
            if self.filename_a else None
        rel_filename_b = os.path.relpath(self.filename_b, self.dir_b) \
            if self.filename_b else None
        return (rel_filename_a, rel_filename_b)
    
    def pretty_filenames(self):
        
        rel_filename_a, rel_filename_b = self.rel_filenames()
        
        if rel_filename_a == rel_filename_b:
            return rel_filename_a + " / (same)"
        else:
            return rel_filename_a + " / " + rel_filename_b 
    
    @staticmethod
    def rel_filename_key(file_diffs):
        rel_filename_key = [file_diff.rel_filenames() \
                            for file_diff in file_diffs]
        rel_filename_key.sort()
        return tuple(rel_filename_key)
        
class PrefixDiff:

    """
    A diff with a particular JSON path prefix - dot-notation
    Ex: JSONDiff(+++ 0.3 was added) @ "x.y"
    """

    def __init__(self, prefix, json_diff):
        self.prefix = prefix
        self.json_diff = json_diff
    
    def __eq__(self, other):
        return self.prefix == other.prefix and \
               self.json_diff == other.json_diff

    def __hash__(self):
        return (self.prefix, self.json_diff).__hash__()

    def pretty_str(self, indent_size=2, trim_size=12):

        builder = ""        

        prefix = self.prefix                                       
        if not prefix:                                                      
            prefix = "(root)"                                           
                                                                                
        diff_str = self.json_diff.pretty_str(indent_size, trim_size)            
                                                                                
        builder += ("%s:\n" % prefix) + (" " * indent_size) + \
                   diff_str.replace("\n",                                   
                                    "\n" + (" " * (2 * indent_size))) + "\n"
        
        return builder

    def build_child_diffs(self, level=1):
        
        prefix_diffs = []
        fringe = [(self, 0)]
        
        while fringe:

            prefix_diff, curr_level = fringe.pop()
            if level > 0 and curr_level == level:
                continue

            for key, value in prefix_diff.json_diff.dict_diff.items():

                next_prefix = (prefix_diff.prefix + "." if prefix_diff.prefix
                               else "") + str(key)

                prefix_diffs.append(PrefixDiff(next_prefix, value))
                fringe.append((prefix_diffs[-1], curr_level + 1))
        
        return prefix_diffs

    def is_part_of(self, json_diff, allow_flat_keys=True):
        
        deep_diff = self.json_diff
        path = self.prefix.split(".")
        
        while path:
            
            component = path[0]
            flat_component = ".".join(path)
            
            if component in json_diff.dict_diff:
                json_diff = json_diff.dict_diff[component]
            elif allow_flat_keys and flat_component in json_diff.dict_diff:
                json_diff = json_diff.dict_diff[flat_component]
                break
             
            path = path[1:]
        
        return deep_diff.__eq__(json_diff)

class JSONDirDiff:

    """
    A diff of two directories of JSON files.
    
    Supports pretty-printing and grouping of changes between the files into
    an easily-readable format.
    """

    def __init__(self, json_dir_a, json_dir_b):
        
        self.json_dir_a = json_dir_a
        self.json_dir_b = json_dir_b
        self.file_diffs = []

        for path, dirnames, filenames in os.walk(json_dir_a):
        
            for filename in filenames:
            
                if os.path.splitext(filename)[1] != '.json':
                    continue
            
                json_filename_a = os.path.join(path, filename)
                relative_filename_a = \
                    os.path.relpath(json_filename_a, json_dir_a)

                json_filename_b = os.path.join(json_dir_b, relative_filename_a)
            
                if not os.path.exists(json_filename_b) or \
                   not os.path.isfile(json_filename_b):
                    self.file_diffs.append(
                        JSONFileDiff(json_dir_a, json_filename_a,
                                     json_dir_b, None))
                    continue
            
                with open(json_filename_a, 'r') as json_file_a:
                    with open(json_filename_b, 'r') as json_file_b:
                        json_a = pygrue.load_commented_json(json_file_a)
                        json_b = pygrue.load_commented_json(json_file_b)
                        json_diff = pygrue.JSONDiff(json_a, json_b)
                        self.file_diffs.append(JSONFileDiff(json_dir_a,
                                                            json_filename_a,
                                                            json_dir_b,
                                                            json_filename_b,
                                                            json_diff))

        for path, dirnames, filenames in os.walk(json_dir_b):
        
            for filename in filenames:
            
                if os.path.splitext(filename)[1] != '.json':
                    continue
            
                json_filename_b = os.path.join(path, filename)
                relative_filename_b = \
                    os.path.relpath(json_filename_b, json_dir_b)

                json_filename_a = os.path.join(json_dir_a, relative_filename_b)
            
                if not os.path.exists(json_filename_a) or \
                   not os.path.isfile(json_filename_a):
                    self.file_diffs.append(JSONFileDiff(json_dir_a,
                                                        None,
                                                        json_dir_b,
                                                        json_filename_b))
    
        self.file_diffs.sort(key=lambda x: x.filename_a) 
    
    def ignore_numeric_type_diff(self):  
        
        for file_diff in self.file_diffs:
            if file_diff.json_diff:
                file_diff.json_diff.ignore_numeric_type_diff()

    def ignore_numeric_value_diff(self, tolerance):
        
        for file_diff in self.file_diffs:
            if file_diff.json_diff:
                file_diff.json_diff.ignore_numeric_value_diff(tolerance)

    def flatten(self):
        
        for file_diff in self.file_diffs:
            if file_diff.json_diff:
                file_diff.json_diff.flatten()
    
    def build_diff_groups(self):
        
        # We build diff groups by first grouping file diffs by (prefixed) json
        # diff subsets they share
        
        all_prefix_diffs = set([])
        for file_diff in self.file_diffs:
            
            if not file_diff.json_diff:
                continue
            
            if file_diff.json_diff.is_similar_value():
                continue
            
            for prefix_diff in \
                PrefixDiff("", file_diff.json_diff).build_child_diffs(level=-1):
                
                all_prefix_diffs.add(prefix_diff)

        prefix_groups = {}
        
        for prefix_diff in all_prefix_diffs:
            for file_diff in self.file_diffs:
                
                if not file_diff.json_diff:
                    continue
                
                if prefix_diff.is_part_of(file_diff.json_diff):
                    
                    prefix_group = \
                        prefix_groups.setdefault(prefix_diff, set([]))
                    
                    prefix_group.add(file_diff)
        
        # Since we generated all children of nested diffs, we have some 
        # duplicated information - a "higher-prefix" diff, for example at "x",
        # is be contained in multiple file diffs, and so will its children,
        # for example at "x.y" and "x.z".
        #
        # If the diff at "x" is contained in exactly the same file diffs as the
        # diff at "x.y" and the diff at "x.z", we should keep "x" and get rid
        # of the child prefix groups, since they're just duplicated information.
        # If "x.y" or "x.z" are contained in *different* file groups though,
        # we should get rid of the parent prefix group "x" and just report the
        # children.
        
        to_remove = set([])
        
        for prefix_diff, file_diffs in prefix_groups.items():
            
            child_diffs = prefix_diff.build_child_diffs() 
            
            if not child_diffs:
                continue
            
            # We are a parent diff - remove ourselves if our children differ,
            # remove children if they don't
            remove_parent = False
            for child_diff in child_diffs:
                
                child_file_diffs = prefix_groups.get(child_diff)
                
                if file_diffs != child_file_diffs:
                    remove_parent = True
                    break
            
            if remove_parent:
                to_remove.add(prefix_diff)
            else:    
                for child_diff in child_diffs:
                    to_remove.add(child_diff)    
        
        for prefix_diff in to_remove:
            del prefix_groups[prefix_diff]
        
        # We've now got all the file diffs grouped by prefixed json diffs they
        # share.  Invert this mapping to return (sorted) groups of file diffs
        # with all the (sorted) prefixed json diffs they share.
        
        file_groups = {}
        for prefix_diff, file_diffs in prefix_groups.items():
            
            file_group = file_groups.setdefault(
                JSONFileDiff.rel_filename_key(file_diffs), 
                (list(file_diffs), []))
            
            file_group[1].append(prefix_diff)
        
        file_groups = list(file_groups.values())
        file_groups.sort(key=lambda x: JSONFileDiff.rel_filename_key(x[0]))
        
        for i in range(0, len(file_groups)):
            file_groups[i][0].sort(key=lambda x: x.rel_filenames())
            file_groups[i][1].sort(key=lambda x: x.prefix)
        
        return file_groups

    def pretty_grouped_str(self, indent_size=2, trim_size=12):
        
        builder = ""
        indent = " " * indent_size
        
        for file_diffs, prefix_diffs in self.build_diff_groups():
            
            filenames = [file_diff.pretty_filenames() \
                         for file_diff in file_diffs]
            
            builder += "\n::: comparing .json files:\n::: " + \
                       "\n::: ".join(filenames) + "\n"
            
            for prefix_diff in prefix_diffs:
            
                prefix = prefix_diff.prefix
                if not prefix:
                    prefix = "(root)"
            
                diff_str = prefix_diff.json_diff.pretty_str(indent_size,
                                                              trim_size)
                
                diff_str = indent + indent + \
                           diff_str.replace("\n", "\n" + indent + indent)
                
                builder += indent + prefix + ":\n" + diff_str + "\n"
            
        return builder

    def pretty_str(self, group_changes=False, indent_size=2, trim_size=12):
        
        indent = " " * indent_size
        builder = ""

        for file_diff in self.file_diffs:
            if file_diff.filename_a and not file_diff.filename_b:
                builder += "\n--- no .json file to compare with:\n" + \
                           "--- " + file_diff.rel_filenames()[0] + "\n"
            elif file_diff.filename_b and not file_diff.filename_a:
                builder += "\n+++ no .json file to compare with:\n" + \
                           "+++ " + file_diff.rel_filenames()[1] + "\n"
            elif file_diff.json_diff.is_similar_value():
                builder += "\n=== .json files equal:\n" + \
                           "=== " + file_diff.pretty_filenames() + "\n"
            elif not group_changes:
                builder += "\n::: comparing .json files:\n" + \
                           "::: " + file_diff.pretty_filenames() + "\n"
                
                diff_str = \
                    file_diff.json_diff.pretty_str(indent_size=indent_size,
                                                   trim_size=trim_size)
                builder += (indent * 2) +\
                           diff_str.replace("\n", "\n" + (indent * 2)) +\
                           "\n"
        
        if group_changes:
            builder += self.pretty_grouped_str(indent_size=indent_size,
                                               trim_size=trim_size)
        
        return builder

DESCRIPTION = \
    """Compare JSON profile directories on the command line"""

if __name__ == "__main__":

    parser = argparse.ArgumentParser(
        description=DESCRIPTION)

    parser.add_argument(
        metavar='JSON_PROFILES_DIRS', dest='json_dirs', nargs=2, 
        help='JSON profile directories to compare')
   
    parser.add_argument(
        '--flatten', dest='flatten', action='store_true',
        help='Flatten diff before outputting',
        default=False)

    parser.add_argument(
        '--indent', dest='indent_size', type=int,
        help='Set output indentation',
        default=2)

    parser.add_argument(
        '--trim', dest='trim_size', type=int,
        help='Set output trim size',
        default=12)

    parser.add_argument(
        '--loose-numeric-checks', dest='loose_numeric_checks',
        action='store_true',
        help='Ignore numeric values that are similar',
        default=False)
 
    parser.add_argument(
        '--group-changes', dest='group_changes',
        action='store_true',
        help='Group changes to multiple files together',
        default=False)
 
    args = parser.parse_args(sys.argv[1:])
    
    if len(args.json_dirs) < 2:
        raise Exception("Need two profile directories to compare.")
     
    print("Comparing json in directories:\n %s\nand\n %s" \
          % (args.json_dirs[0], args.json_dirs[1]))

    diff = JSONDirDiff(args.json_dirs[0], args.json_dirs[1])

    if args.loose_numeric_checks:
        diff.ignore_numeric_type_diff()
        diff.ignore_numeric_value_diff(0.0001)
        
    if args.flatten:
        diff.flatten()
        
    print(diff.pretty_str(group_changes=args.group_changes,
                          indent_size=args.indent_size, 
                          trim_size=args.trim_size))
