#!/usr/bin/python

import run_python_34
run_python_34.bootstrap_v34()

import os
import sys
import argparse
import subprocess
import json

import pygrue

"""
Script which allows the comparison of gcode toolpaths to one another -
layers are diff'd
"""

class CLDiffs:
    
    """A Command-Line diff representation, parses 'diff' output into a standard
       data structure for later use."""

    ADDITION = 1
    DELETION = 2
    CHANGE = 3
 
    class Diff:
        
        """A single command-line diff region - addition, deletion, or change"""

        def __init__(self, diff_type, 
                     range_a, range_b, 
                     lines_a, lines_b):

            self.diff_type = diff_type
            self.range_a = range_a
            self.range_b = range_b
            self.lines_a = lines_a
            self.lines_b = lines_b
        
        def pretty_str(self):
            
            if self.diff_type == CLDiffs.ADDITION:
                return "+++ New Commands +++\n" + \
                       "\n".join([">" + str(line) for line in self.lines_b]) + \
                       "\n"

           
            elif self.diff_type == CLDiffs.DELETION:
                return "--- Removed Commands ---\n" + \
                       "\n".join(["<" + str(line) for line in self.lines_a]) + \
                       "\n"

            elif self.diff_type == CLDiffs.CHANGE:
                return "::: Changed Commands :::\n" + \
                       ("%s\n-----\n%s\n" % \
                        ("\n".join([">" + str(line) for line in self.lines_a]),
                         "\n".join(["<" + str(line) for line in self.lines_b])))
    
    def __init__(self, output, total_lines):
        
        """Parse the output of a 'diff' command into a data structure"""

        self.diffs = []
        self.total_lines = total_lines

        i = 0
        output = output.split('\n')

        while i < len(output):
            
            diff_type = None
            desc = output[i].strip()
            if 'a' in desc:
                diff_type = CLDiffs.ADDITION
                desc = desc.split('a')
            elif 'd' in desc:
                diff_type = CLDiffs.DELETION
                desc = desc.split('d')
            elif 'c' in desc:
                diff_type = CLDiffs.CHANGE
                desc = desc.split('c')
            else:
                i = i + 1
                continue

            range_a = [int(x) for x in desc[0].split(',')]
            range_b = [int(x) for x in desc[1].split(',')]

            if len(range_a) == 1:
                range_a = range_a + range_a
            if len(range_b) == 1:
                range_b = range_b + range_b
            
            i = i + 1
            lines_a = []
            lines_b = []
            while i < len(output):

                if not output[i].startswith("-") and \
                   not output[i].startswith("<") and \
                   not output[i].startswith(">"):
                    break
                
                if output[i].startswith("<"):
                    lines_a.append(output[i])
                elif output[i].startswith(">"):
                    lines_b.append(output[i])

                i = i + 1 
            
            self.diffs.append(CLDiffs.Diff(diff_type, range_a, range_b, 
                                                      lines_a, lines_b)) 
    
    def empty(self):
        return len(self.diffs) == 0
    
    def summary_str(self):
        
        counts = {}
        total_lines_different = 0

        for diff in self.diffs:
            counts[diff.diff_type] = counts.get(diff.diff_type, 0) + 1
            total_lines_different = total_lines_different + \
                                    len(diff.lines_a) + len(diff.lines_b)

        return ("%s additions, %s deletions, and %s changes"
                " (%s motions differ out of %s, %s)") % \
               (counts.get(CLDiffs.ADDITION, 0),
                counts.get(CLDiffs.DELETION, 0),
                counts.get(CLDiffs.CHANGE, 0),
                total_lines_different, self.total_lines,
                str(100 * total_lines_different / self.total_lines) + '%')

    def pretty_str(self):
    
        pretty = ""

        for diff in self.diffs:
        
            pretty = pretty + "\n" + diff.pretty_str()
        
        return pretty


def motion_command_range(toolpath, command_range):
    
    """Pulls out commands in a particular indexed range from a toolpath.
       Pretty slow if the toolpath is large."""

    index = 1
    commands = []
    for xyzab_motion, _, command in toolpath.xyzab_motions():
        
        if index > command_range[1]:
            break

        if index >= command_range[0]:
            commands.append((xyzab_motion, command)) 

        index = index + 1
    
    return commands

def toolpath_diff(toolpath_a, toolpath_b,
                  small_error_threshold=0.0):
    
    """Performs a diff on two toolpaths, returning a processed CLDiff object
       containing lines of formatted commands + motion"""

    digest_a_tempfile = pygrue.TemporaryFile()
    digest_b_tempfile = pygrue.TemporaryFile()
    
    if small_error_threshold == 0.0:
        template = "X: %s, Y: %s, Z: %s, A: %s, B: %s\n"
    else:
        template = "X: %.3f, Y: %.3f, Z: %.3f, A: %.3f, B: %.3f\n"
    
    num_toolpath_commands = 0

    for toolpath, digest_tempfile in [(toolpath_a, digest_a_tempfile),
                                      (toolpath_b, digest_b_tempfile)]:
        
        index = 0
        with open(digest_tempfile.name, 'w') as digest_file:
            
            for xyzab_motion, _, _ in toolpath.xyzab_motions():
                
                if index == 0:
                    digest_file.write("\n")
                else:
                    stringified = template % \
                        (xyzab_motion[0], xyzab_motion[1], xyzab_motion[2],
                         xyzab_motion[3], xyzab_motion[4])

                    digest_file.write(stringified)
                
                index = index + 1
                num_toolpath_commands = num_toolpath_commands + 1
    
    diff_process = subprocess.Popen(['diff', '-w', '--minimal',
                                     digest_a_tempfile.name,
                                     digest_b_tempfile.name],
                                     stdout=subprocess.PIPE,
                                     stderr=subprocess.PIPE)
    
    stdout, stderr = diff_process.communicate()
    if diff_process.returncode > 1:
        raise Exception("Could not run diff: %s" % stderr)
    
    cl_diffs = CLDiffs(stdout, num_toolpath_commands)
    
    if num_toolpath_commands < 10000:

        toolpath_a_commands = [(xyzab_motion, command) \
                               for xyzab_motion, _, command in toolpath_a.xyzab_motions()]
        toolpath_b_commands = [(xyzab_motion, command) \
                               for xyzab_motion, _, command in toolpath_b.xyzab_motions()]
        
        for cl_diff in cl_diffs.diffs:
            
            command_range_a = list(cl_diff.range_a)
            command_range_b = list(cl_diff.range_b)
            
            command_range_a[0] = \
                command_range_a[0] - 2 if command_range_a[0] > 1 else \
                command_range_a[0] - 1

            command_range_b[0] = \
                command_range_b[0] - 2 if command_range_b[0] > 1 else \
                command_range_b[0] - 1
            
            cl_diff.lines_a = \
                toolpath_a_commands[command_range_a[0]:command_range_a[1]]

            cl_diff.lines_b = \
                toolpath_b_commands[command_range_b[0]:command_range_b[1]]
    else:
        
        for cl_diff in cl_diffs.diffs:
            
            cl_diff.lines_a = motion_command_range(toolpath_a, cl_diff.range_a)
            cl_diff.lines_b = motion_command_range(toolpath_b, cl_diff.range_b)
    
    # Ignore small errors
    if small_error_threshold > 0:
        
        valid_diffs = []

        for cl_diff in cl_diffs.diffs:
            
            if len(cl_diff.lines_a) == len(cl_diff.lines_b):
                
                is_valid = False

                for i in range(0, len(cl_diff.lines_a)):

                    xyzab_motion_a, _ = cl_diff.lines_a[i]
                    xyzab_motion_b, _ = cl_diff.lines_b[i]
                    
                    for j in range(0, 5):
                        if abs(xyzab_motion_a[j] - xyzab_motion_b[j]) > \
                           small_error_threshold:
                            
                            is_valid = True
                            break

                    if is_valid:
                        break

                if is_valid:
                    valid_diffs.append(cl_diff)

        cl_diffs.diffs = valid_diffs
    
    for cl_diff in cl_diffs.diffs:

        for lines in [cl_diff.lines_a, cl_diff.lines_b]:

            for i in range(0, len(lines)):

                xyzab_motion, command = lines[i]
                
                template = " X %4.4f, Y %4.4f, Z %4.4f"
                values = [command['command']['parameters']['x'],
                          command['command']['parameters']['y'],
                          command['command']['parameters']['z']]
                
                if 'a' in command['command']['parameters']:
                    template = template + ", A %4.4f"
                    values.append(command['command']['parameters']['a'])
                if 'b' in command['command']['parameters']:
                    template = template + ", B %4.4f"
                    values.append(command['command']['parameters']['b'])
                
                template = template + " (dX %4.4f, dY %4.4f"
                values.extend([xyzab_motion[0], 
                               xyzab_motion[1]])
                
                if xyzab_motion[2] != 0:
                    template = template + ", dZ %4.4f"
                    values.append(xyzab_motion[2])
                if xyzab_motion[3] != 0:
                    template = template + ", dA %4.4f"
                    values.append(xyzab_motion[3])
                if xyzab_motion[4] != 0:
                    template = template + ", dB %4.4f"
                    values.append(xyzab_motion[4])

                template = template + ")"
                lines[i] = template % tuple(values) 

    return cl_diffs


class ToolpathDiff:
    
    class MissingLayer:
        
        def __init__(self, layer):
            self.layer = layer

    class ExtraLayer:

        def __init__(self, layer):
            self.layer = layer

    class SimilarLayer:
        
        def __init__(self, layer_a, layer_b, small_error_threshold):
            self.layer_a = layer_a
            self.layer_b = layer_b

            self.layer_diff = toolpath_diff(layer_a.toolpath,
                                            layer_b.toolpath,
                                            small_error_threshold)

    def __init__(self, toolpath_a, toolpath_b,
                 z_range=None,
                 small_error_threshold=0.0,
                 layer_z_offset=0.0):
        
        layers_a = toolpath_a.split_layers(z_range)
        layers_b = toolpath_b.split_layers(z_range)
        
        self.layers_a = layers_a
        self.layers_b = layers_b
        self.layer_diffs = []

        i = 0
        j = 0
        
        while True:
            
            layer_a = None if i >= len(layers_a) else layers_a[i]
            layer_b = None if j >= len(layers_b) else layers_b[j]
            
            if layer_a is None and layer_b is None:
                break
            
            layer_a_z = None if not layer_a else layer_a.z_height 
            layer_b_z = None if not layer_b else layer_b.z_height
            
            if layer_a_z:
                layer_a_z = layer_a_z + layer_z_offset

            if layer_a and layer_b and \
               abs(layer_a_z - layer_b_z) <= small_error_threshold:
                layer_b_z = layer_a_z
            
            if layer_a and layer_b:
                print("Comparing layers %s (%s) and %s (%s)..." % \
                      (layer_a.z_height,
                       layer_a_z,
                       layer_b.z_height,
                       layer_b_z))
            
            elif layer_a:
                print("Remaining layer %s..." % layer_a.z_height)

            elif layer_b:
                print("Extra layer %s..." % layer_b.z_height)

            if layer_a is None or \
               (layer_b is not None and layer_a_z > layer_b_z):
                self.layer_diffs.append(ToolpathDiff.ExtraLayer(layer_b))
                j = j + 1
                continue

            elif layer_b is None or \
                (layer_a is not None and layer_b_z > layer_a_z):
                self.layer_diffs.append(ToolpathDiff.MissingLayer(layer_a))
                i = i + 1
                continue
            
            if layer_a_z == layer_b_z:
                self.layer_diffs.append(
                    ToolpathDiff.SimilarLayer(layer_a, 
                                              layer_b,
                                              small_error_threshold))
                i = i + 1
                j = j + 1
                continue
            
            else:
                raise Exception("Unreachable!")

    def pretty_str(self, full_diff=False, indent="  "):

        pretty = ""

        for layer_diff in self.layer_diffs:

            if isinstance(layer_diff, ToolpathDiff.MissingLayer):
                
                pretty = pretty + "+++ Missing layer at %s\n" % \
                           layer_diff.layer.z_height

            if isinstance(layer_diff, ToolpathDiff.ExtraLayer):
            
                pretty = pretty + "+++ Extra layer at %s\n" % \
                           layer_diff.layer.z_height
            
            if isinstance(layer_diff, ToolpathDiff.SimilarLayer):
                
                if layer_diff.layer_diff.empty():
               
                    pretty = pretty + "::: Identical layers at %s\n" % \
                                      layer_diff.layer_a.z_height
                else:
                    
                    if full_diff:
                        report = layer_diff.layer_diff.pretty_str()
                    else:
                        report = layer_diff.layer_diff.summary_str()
                    
                    report = indent + report.replace("\n", "\n" + indent)

                    pretty = pretty + "::: Similar layers at %s\n%s\n" % \
                                      (layer_diff.layer_a.z_height,
                                       report)
             
        return pretty

def compare_gcode_files(gcode_filename_a, gcode_filename_b,
                        z_range, small_error_threshold, layer_z_offset):
    
    toolpath_a = pygrue.Toolpath(gcode_filename_a)
    toolpath_b = pygrue.Toolpath(gcode_filename_b)

    return ToolpathDiff(toolpath_a, toolpath_b, 
                        z_range,
                        small_error_threshold,
                        layer_z_offset)

DESCRIPTION = \
    """Compare gcode on the command line"""

if __name__ == "__main__":

    parser = argparse.ArgumentParser(
        description=DESCRIPTION)

    parser.add_argument(
        metavar='GCODE_FILE', dest='gcode_files', nargs=2, 
        help='.gcode files to compare')
   
    parser.add_argument(
        '--full-diff', dest='full_diff',
        action='store_true',
        help='Report all motions that differ.',
        default=False)

    parser.add_argument(
        '--z-range', dest='z_range',
        help='Specify z-range to diff.',
        default=None)

    parser.add_argument(
        '--ignore-small-errors', dest='ignore_small_errors',
        action='store_true',
        help='Ignore small errors.',
        default=False)

    parser.add_argument(
        '--layer-z-offset', dest='layer_z_offset', type=float,
        help='Compare offset for the z-layers in the first gcode',
        default=0.0)

    args = parser.parse_args(sys.argv[1:])
    
    if len(args.gcode_files) < 2:
        raise Exception("Need two json files to compare.")
    
    z_range = None
    if args.z_range:
        z_range = [float(x) for x in args.z_range.split("-")]

    diff = compare_gcode_files(args.gcode_files[0],
                               args.gcode_files[1],
                               z_range,
                               0.0 if not args.ignore_small_errors else 0.001,
                               args.layer_z_offset)
    
    print("Comparing gcode in files:\n %s\nand\n %s" % (args.gcode_files[0],
                                                        args.gcode_files[1]))

    print(diff.pretty_str(full_diff=args.full_diff))
