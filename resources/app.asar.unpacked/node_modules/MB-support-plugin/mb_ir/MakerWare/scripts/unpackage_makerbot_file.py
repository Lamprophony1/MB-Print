#!/usr/bin/python

import run_python_34
run_python_34.bootstrap_v34()

import os
import sys
import argparse
import shutil
import json
import tempfile

import pygrue


def write_gcode_to(toolpath, gcode_filename):
    print("Writing gcode output to %s..." % gcode_filename)

    LINES_PER_OUTPUT = 10000

    with open(gcode_filename, 'w') as gcode_file:
        num_lines = 0
        for gcode_line in toolpath.gcode_lines():
            gcode_file.write(gcode_line)

            num_lines = num_lines + 1
            if num_lines % LINES_PER_OUTPUT == 0:
                print("Wrote %s lines of gcode..." % num_lines)

    print("Done writing gcode output.")


def convert_json_toolpath(json_toolpath_filename,
                          gcode_filename=None):
    """
    Converts a .jsontoolpath into gcode
    """

    toolpath = pygrue.Toolpath(json_toolpath_filename,
                               toolpath_type='jsontoolpath')

    toolpath_name = \
        os.path.splitext(os.path.basename(json_toolpath_filename))[0]

    if not gcode_filename:
        gcode_filename = \
            os.path.join(os.path.dirname(json_toolpath_filename),
                         "%s.gcode" % toolpath_name)

    write_gcode_to(toolpath, gcode_filename)


def unpackage_makerbot(makerbot_filename,
                       gcode_filename=None,
                       meta_filename=None,
                       machine_config_filename=None,
                       slice_config_filename=None):
    """
    Converts a .makerbot toolpath into component parts
    """

    toolpath = pygrue.Toolpath(makerbot_filename, toolpath_type='makerbot')

    makerbot_name = \
        os.path.splitext(os.path.basename(makerbot_filename))[0]

    if not meta_filename:
        meta_filename = os.path.join(os.path.dirname(makerbot_filename),
                                     "%s.meta.json" % makerbot_name)

    bot_type = toolpath.metadata.get("bot_type", "(unknown)")
    slicer_version = toolpath.metadata.get("grue_version", "(unknown)")
    meta_version = toolpath.metadata.get("version", "0.0.0")

    print(("Makerbot file was created for bot of type %s, "
           "with slicer at version %s and packaged as meta version %s.") %
          (bot_type, slicer_version, meta_version))

    print("Writing meta information to %s..." %
          meta_filename)

    with open(meta_filename, 'w') as meta_file:
        json.dump(toolpath.metadata,
                  meta_file, indent=2, sort_keys=True)

    if 'machine_config' in toolpath.metadata:
        if not machine_config_filename:
            machine_config_filename = \
                os.path.join(os.path.dirname(makerbot_filename),
                             "%s.machine-config.json" % makerbot_name)

        print("Writing machine config information to %s..." %
              machine_config_filename)

        with open(machine_config_filename, 'w') as machine_config_file:
            json.dump(toolpath.metadata['machine_config'],
                      machine_config_file, sort_keys=True, indent=2)
    else:
        print("Machine config information not found in %s." % makerbot_filename)

    if 'miracle_config' in toolpath.metadata:
        if not slice_config_filename:
            slice_config_filename = \
                os.path.join(os.path.dirname(makerbot_filename),
                             "%s.slice-config.json" % makerbot_name)

        print("Writing slice config information to %s..." %
              slice_config_filename)

        with open(slice_config_filename, 'w') as slice_config_file:
            json.dump(toolpath.metadata['miracle_config'],
                      slice_config_file, sort_keys=True, indent=2)
    else:
        print("Slice config information not found in %s." % makerbot_filename)

    if not gcode_filename:
        gcode_filename = os.path.join(os.path.dirname(makerbot_filename),
                                      "%s.gcode" % makerbot_name)

    write_gcode_to(toolpath, gcode_filename)

DESCRIPTION = \
    """
    Unpackage .makerbot and .jsontoolpath information from command line.
    """

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description=DESCRIPTION)

    parser.add_argument(
        metavar='UNPACKAGE_FILE',
        dest='unpackage_file',
        help='.makerbot/.jsontoolpath to unpackage.')

    parser.add_argument(
        '--gcode-file',
        dest='gcode_file',
        help='.gcode file to create',
        default=None)

    parser.add_argument(
        '--meta-file',
        dest='meta_file',
        help='meta.json file to create (.makerbot only)',
        default=None)

    parser.add_argument(
        '--slice-config-file',
        dest='slice_config_file',
        help='slice-config.json file to create (.makerbot only)',
        default=None)

    parser.add_argument(
        '--machine-config-file',
        dest='machine_config_file',
        help='machine-config.json file to create (.makerbot only)',
        default=None)

    args = parser.parse_args(sys.argv[1:])

    unpackage_file = args.unpackage_file
    makerbot_file = None
    json_toolpath_file = None

    if os.path.splitext(unpackage_file)[1] == ".makerbot":
        makerbot_file = unpackage_file
    elif os.path.splitext(unpackage_file)[1] == ".jsontoolpath":
        json_toolpath_file = unpackage_file

    if not makerbot_file and not json_toolpath_file:
        raise Exception("No makerbot file or json toolpath specified.")

    if makerbot_file and json_toolpath_file:
        raise Exception(
            "Must specify only one of --makerbot-file or --json-toolpath.")

    if makerbot_file:
        unpackage_makerbot(makerbot_file,
                           args.gcode_file,
                           args.meta_file,
                           args.machine_config_file,
                           args.slice_config_file)

    if json_toolpath_file:
        convert_json_toolpath(json_toolpath_file,
                              args.gcode_file)
