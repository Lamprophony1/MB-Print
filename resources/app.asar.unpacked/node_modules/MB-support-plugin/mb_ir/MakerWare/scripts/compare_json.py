#!/usr/bin/python

import run_python_34
run_python_34.bootstrap_v34()

import os
import sys
import argparse
import json
import tempfile

import pygrue

def compare_json_files(json_filename_a, json_filename_b):
    with open(json_filename_a, 'r') as json_file_a:
        with open(json_filename_b, 'r') as json_file_b:
            json_a = pygrue.load_commented_json(json_file_a)
            json_b = pygrue.load_commented_json(json_file_b)

            return pygrue.JSONDiff(json_a, json_b)

def reformat_json_file(json_filename):
    contents = None
    with open(json_filename, 'r') as json_file:
        contents = pygrue.load_commented_json(json_file)
    with open(json_filename + ".reformat", 'w') as json_file:
        json.dump(contents, json_file, sort_keys=True, indent=4)

DESCRIPTION = \
    """Compare JSON on the command line"""

if __name__ == "__main__":

    parser = argparse.ArgumentParser(
        description=DESCRIPTION)

    parser.add_argument(
        metavar='JSON_FILE', dest='json_files', nargs=2, 
        help='JSON files to compare')
   
    parser.add_argument(
        '--flatten', dest='flatten', action='store_true',
        help='Flatten diff before outputting',
        default=False)

    parser.add_argument(
        '--indent', dest='indent_size', type=int,
        help='Set output indentation',
        default=2)

    parser.add_argument(
        '--trim', dest='trim_size', type=int,
        help='Set output trim size',
        default=12)

    parser.add_argument(
        '--loose-numeric-checks', dest='loose_numeric_checks',
        action='store_true',
        help='Ignore numeric values that are similar',
        default=False)
 
    parser.add_argument(
        '--reformat', dest='reformat',
        action='store_true',
        help='Reformat files in-place.',
        default=False)

    args = parser.parse_args(sys.argv[1:])
    
    if args.reformat:
        for json_filename in args.json_files:
            reformat_json_file(json_filename)

    if len(args.json_files) < 2 and args.reformat:
        sys.exit(0)

    if len(args.json_files) < 2:
        raise Exception("Need two json files to compare.")
    
    diff = compare_json_files(args.json_files[0], args.json_files[1])
    
    print("Comparing json in files:\n %s\nand\n %s" % (args.json_files[0], args.json_files[1]))

    if args.flatten:
        diff.flatten()

    if args.loose_numeric_checks:
        diff.ignore_numeric_type_diff()
        diff.ignore_numeric_value_diff(0.0001)

    print(diff.pretty_str(indent_size=args.indent_size, 
                          trim_size=args.trim_size))
