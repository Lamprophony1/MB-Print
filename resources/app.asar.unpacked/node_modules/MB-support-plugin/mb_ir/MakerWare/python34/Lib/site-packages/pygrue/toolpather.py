import os
import sys
import json
import subprocess
import shutil

from .toolpath import Toolpath
from . import utils
from . import thing

"""
Miracle_Grue Toolpather API for python
"""

EMPTY_STL= \
"""solid empty
  facet normal 0 0 1
    outer loop
      vertex 0 0 0
      vertex 1 0 0
      vertex 0 1 0
    endloop
  endfacet
endsolid empty"""

class Toolpather:

    """A versioned miracle_grue toolpather."""

    BAD_KEYS = ['jsonToolpathOutput',                            
                'jsonProgress',                                             
                'metadataOutput',                                           
                'outputFilepath',                                           
                'configPath']

    def __init__(self, exe_filename,
                 repo_dir=None,
                 check_version=True,
                 debug_toolpaths=False):

        self.exe_filename = exe_filename
        self.exe_md5 = utils.md5_hash(exe_filename)
        
        if check_version:

            version_json = { 'version' : 
                             subprocess.check_output([exe_filename,
                                                     '--version'])
                                       .decode(sys.stdout.encoding) }
            try:
                version_json = \
                    json.loads(
                        subprocess.check_output([exe_filename, 
                                                 '--version-json'])
                                  .decode(sys.stdout.encoding))
            except subprocess.CalledProcessError as ex:
                # Swallow, assume older miracle_grue version
                pass

        else:
            version_json = { 'version' : '0.0.0' }
        
        self.version = version_json['version']
         
        self.branch = version_json.get('branch', None)
        if self.branch == 'unknown branch':
            self.branch = None
        
        self.commit = version_json.get('commit', None)
        if self.commit == 'unknown commit':
            self.commit = None
        
        self.tags = version_json.get('tags', [])

        self.commit_message = None

        # Load git information from an active repository
        if check_version and repo_dir:
            
            git_info = utils.get_git_info(repo_dir) 
            if self.commit is None:

                self.branch = git_info.branch
                self.commit = git_info.commit
                self.commit_message = git_info.commit_message
                self.tags = git_info.tags

            elif self.commit == git_info.commit:

                if self.branch is None or self.branch == 'HEAD':
                    self.branch = git_info.branch

                self.commit_message = git_info.commit_message
                all_tags = set(self.tags + git_info.tags)
                self.tags = list(all_tags)
        
        # Get additional build information out of the version_json
        
        self.build_number = version_json.get('buildNumber', None)
        if self.build_number == 'unknown build':
            self.build_number = None

        self.build_utc_secs = version_json.get('buildUTCSecs', None)
        self.build_utc_str = version_json.get('buildUTCStr', None)
        
        self.debug_toolpaths = debug_toolpaths

    class Process(subprocess.Popen):

        """A miracle_grue process with output and metadata files."""

        def __init__(self, toolpather, config_filename, model_filename, 
                     toolpath_type="gcode",
                     args=[],
                     output_filename=None, meta_filename=None,
                     debug_name=None, dry_run=False,
                     **kwargs):
            
            self.toolpather = toolpather
            self.config_filename = config_filename
            self.model_filename = model_filename

            self.output_filename = output_filename
            if not self.output_filename:
                
                suffix = ""
                if toolpath_type == 'gcode':
                    suffix = ".gcode"
                elif toolpath_type == 'jsontoolpath':
                    suffix = ".jsontoolpath"
                
                self.output_tempfile = utils.TemporaryFile(suffix=suffix)
                self.output_filename = self.output_tempfile.name

            self.meta_filename = meta_filename
            if not self.meta_filename:
                self.meta_tempfile = utils.TemporaryFile()
                self.meta_filename = self.meta_tempfile.name
            
            if toolpather.version and toolpather.version.startswith('3.'):

                self.argv = [self.toolpather.exe_filename,
                             "-c", self.config_filename,
                             self.model_filename,
                             "-o", self.output_filename,
                             "--metadata-output",
                             "--metadata-file", self.meta_filename]

                if toolpath_type != "gcode":
                    self.argv.append("--json-toolpath-output")

            else:
                if toolpath_type == "gcode":
                    out_flag = "--gcode-toolpath-output"
                else:
                    out_flag = "--json-toolpath-output"

                self.argv = [self.toolpather.exe_filename,
                             "-c", self.config_filename,
                             self.model_filename,
                             out_flag, self.output_filename,
                            "--metadata-output",
                            self.meta_filename]
            
            self.argv.extend(args)
            
            if debug_name:
                print(("\n\n%s: running process:\n%s %s\n" % 
                      (debug_name, 
                       utils.get_grue_environ(), 
                       " ".join(self.argv))))
            
            self.empty_model_tempfile = None
            if dry_run:
                
                self.empty_model_tempfile = utils.TemporaryFile(suffix=".stl")
                with open(self.empty_model_tempfile.name, 'w') \
                    as empty_model_file:
                    empty_model_file.write(EMPTY_STL)
                
                self.argv[3] = self.empty_model_tempfile.name
            
            subprocess.Popen.__init__(self, self.argv, **kwargs)
            
            self.out = None
            self.err = None
    
    class ToolpathingError(subprocess.CalledProcessError):

        def __init__(self, rval, args, out, err):
            subprocess.CalledProcessError.__init__(self, rval, args, err)
            self.rval = rval
            self.args = args
            self.out = out
            self.err = err

        def __str__(self):
            return subprocess.CalledProcessError.__str__(self) + \
                "\n(stdout)\n" + self.out.decode(sys.stdout.encoding) + \
                "\n(stderr)\n" + self.err.decode(sys.stderr.encoding)

    
    def generate_toolpath(self, config_json_or_filename, model_or_filename,
                          toolpath_type='gcode', debug_name=None, **kwargs):
        
        config_json = config_json_or_filename
        
        # We need to strip keys out of the config that would interfere with
        # slicing.
        if isinstance(config_json_or_filename, str):
            with open(config_json_or_filename, 'r') as original_config_file: 
                config_json = json.load(original_config_file)
        
        for bad_key in Toolpather.BAD_KEYS:
            if bad_key in config_json:
                del config_json[bad_key]        
        
        config_tempfile = utils.TemporaryFile()
        with open(config_tempfile.name, 'w') as config_file:
            json.dump(config_json, config_file, sort_keys=True, indent=2)
        
        config_filename = config_tempfile.name
        
        model_filename = model_or_filename
        if isinstance(model_filename, thing.Model):
            model_filename = model_filename.filename 

        kwargs['env'] = os.environ
        kwargs['stdout'] = subprocess.PIPE
        kwargs['stderr'] = subprocess.PIPE
        
        args = []

        output_filename=None
        meta_filename=None
        
        if not debug_name and self.debug_toolpaths:
            debug_name = \
                utils.create_test_debug_dir(default_prefix="toolpath_debug").name
        
        if debug_name:
            
            new_config_filename = os.path.join(debug_name, "config.json")
            new_model_filename = \
                os.path.join(debug_name, os.path.split(model_filename)[1])
            
            output_filename = os.path.join(debug_name,
                "print.jsontoolpath" if toolpath_type == 'jsontoolpath' else \
                "print.gcode")
            
            meta_filename = os.path.join(debug_name, "meta.json")
            
            utils.mkdir_dash_p(debug_name)
            shutil.copy(config_filename, new_config_filename)
            shutil.copy(model_filename, new_model_filename)
            
            config_filename = new_config_filename
            model_filename = new_model_filename
            
        process = Toolpather.Process(self, 
                                     config_filename,
                                     model_filename,
                                     toolpath_type,
                                     args,
                                     output_filename=output_filename,
                                     meta_filename=meta_filename,
                                     debug_name=debug_name,
                                     **kwargs)
        
        process.out, process.err = process.communicate()
        rval = process.wait()

        if rval != 0:
            raise Toolpather.ToolpathingError(rval, process.argv, 
                                              process.out, process.err)
       
        metadata_json = None
        with open(process.meta_filename, 'r') as meta_file:
            metadata_json = json.load(meta_file)

        return Toolpath(process.output_filename, metadata_json, process,
                        toolpath_type=toolpath_type)
