import os
import ctypes

import sys
import json
import subprocess
import shutil

from . import utils

"""
Miracle_Grue Toolpather CTypes API for python
"""

# Load Miracle Grue DLL.
miracle_grue = utils.default_miracle_grue_lib_path()
_miracle_grue_interface = ctypes.CDLL(miracle_grue)

# Ctypes args
_miracle_grue_interface.runMiracleGrue.argtypes = [
    ctypes.c_char_p,  # config_file_path
    ctypes.c_char_p,  # model_path
    ctypes.c_char_p,  # json_output_path
    ctypes.c_char_p,  # metadata_path
    ctypes.c_char_p   # gcode_output_path
]
_miracle_grue_interface.runMiracleGrue.restype = ctypes.c_int

_miracle_grue_interface.createBasicSlice.argtypes = [
    ctypes.c_char_p,  # config_file_path
    ctypes.c_char_p,  # model_path
]
_miracle_grue_interface.createBasicSlice.restype = ctypes.c_void_p


_miracle_grue_interface.createRegionedSlice.argtypes = [
    ctypes.c_char_p,  # config_file_path
    ctypes.c_char_p,  # model_path
]
_miracle_grue_interface.createRegionedSlice.restype = ctypes.c_void_p


_miracle_grue_interface.createFilledSlice.argtypes = [
    ctypes.c_char_p,  # config_file_path
    ctypes.c_char_p,  # model_path
]
_miracle_grue_interface.createFilledSlice.restype = ctypes.c_void_p


_miracle_grue_interface.getChunkStackStats.argtypes = [
    ctypes.c_void_p,  # pointer to chunkstack
]
_miracle_grue_interface.getChunkStackStats.restype = ctypes.c_char_p

_miracle_grue_interface.getChunkStackJsonGeometry.argtypes = [
    ctypes.c_void_p,  # pointer to chunkstack
]
_miracle_grue_interface.getChunkStackJsonGeometry.restype = ctypes.c_char_p

_miracle_grue_interface.generateChunkStackSvg.argtypes = [
    ctypes.c_void_p,    # pointer to a chunkstack
    ctypes.c_char_p,    # preferences json string
    ctypes.c_char_p     # output directory
]
_miracle_grue_interface.generateChunkStackSvg.restype = ctypes.c_void_p


class ToolpatherCTypes:
    """
    This Toolpather exposes C pointers directly into the library dylib/dll/so
    - Meant for programmatic consumption only.  For Command Line executable
    with flags, use toolpather.py
    """

    def __init__(
            self,
            config_file_path,
            model_path):

        self.config_file_path = ctypes.c_char_p(
            bytes(config_file_path, encoding="utf-8"))
        self.model_path = ctypes.c_char_p(
            bytes(model_path, encoding="utf-8"))

    def run_miracle_grue(
            self,
            json_output_path,
            metadata_path,
            gcode_output_path):
        """
        runMiracleGrue() from /Miracle-Grue/miracle_grue_c_interface.cc
        """
        self.json_output_path = ctypes.c_char_p(
            bytes(json_output_path, encoding="utf-8"))
        self.metadata_path = ctypes.c_char_p(
            bytes(metadata_path, encoding="utf-8"))
        self.gcode_output_path = ctypes.c_char_p(
            bytes(gcode_output_path, encoding="utf-8"))
        try:
            return _miracle_grue_interface.runMiracleGrue(
                self.config_file_path,
                self.model_path,
                self.json_output_path,
                self.metadata_path,
                self.gcode_output_path)
        except TypeError as e:
            print(e.message)

    def create_basic_slice(self):
        try:
            return _miracle_grue_interface.createBasicSlice(
                self.config_file_path,
                self.model_path)
        except TypeError as e:
            print(e.message)

    def create_regioned_slice(self):
        try:
            return _miracle_grue_interface.createRegionedSlice(
                self.config_file_path,
                self.model_path)
        except TypeError as e:
            print(e.message)

    def create_filled_slice(self):
        try:
            return _miracle_grue_interface.createFilledSlice(
                self.config_file_path,
                self.model_path)
        except TypeError as e:
            print(e.message)


def get_chunkstack_stats(chunkstack_pointer):
    chunkstack_pointer = ctypes.c_void_p(chunkstack_pointer)
    try:
        json_stats = _miracle_grue_interface.getChunkStackStats(
            chunkstack_pointer)
        return json.loads(json_stats.decode())
    except TypeError as e:
        print(e.message)


def get_json_geometry(chunkstack_pointer):
    chunkstack_pointer = ctypes.c_void_p(chunkstack_pointer)
    try:
        json_geometry = _miracle_grue_interface.getChunkStackJsonGeometry(
            chunkstack_pointer)
        return json.loads(json_geometry.decode())
    except TypeError as e:
        print(e.message)


def generate_svgs(chunkstack, preferences_str, output_dir_str):
    try:
        _miracle_grue_interface.generateChunkStackSvg(
            ctypes.c_void_p(chunkstack),
            ctypes.c_char_p(bytes(preferences_str, encoding="utf-8")),
            ctypes.c_char_p(bytes(output_dir_str, encoding="utf-8")))
    except Exception as e:
        print(e)
