import os
import sys
import json
import subprocess

from . import utils

"""
Print Estimator (mbaccelerate) API for python
"""

class PrintEstimator:

    """A versioned miracle_grue mbaccelerate api."""

    DEFAULT_BOT_TYPE = 'replicator_5'

    def __init__(self, exe_filename,
                 repo_dir=None, 
                 default_fwconfig_filename_or_bot=None,
                 check_version=True):

        self.exe_filename = exe_filename
        self.exe_md5 = utils.md5_hash(exe_filename)
        
        if check_version:
            
            version_process = subprocess.Popen([exe_filename, '--version'],
                                               stdout=subprocess.PIPE,
                                               stderr=subprocess.PIPE)

            stdout, stderr = version_process.communicate()

            if version_process.returncode == 0:
                version_json = { 'version' : stdout.strip() }
            elif stderr.strip().startswith('Command line option error'):
                version_json = { 'version' : '0.0.0' }
            else:
                raise Exception("Unknown mbacceleration response: %s" % stderr)

        self.version = version_json['version']
        
        self.branch = None
        self.commit = None
        self.commit_message = None
        self.tags = None

        # Load git information from an active repository
        if check_version and repo_dir:
            
            git_info = utils.get_git_info(repo_dir) 
            
            if self.commit is None:
                
                self.branch = git_info.branch
                self.commit = git_info.commit
                self.commit_message = git_info.commit_message
                self.tags = git_info.tags

            elif self.commit == git_info.commit:

                self.commit_message = git_info.commit_message
                all_tags = set(self.tags + git_info.tags)
                self.tags = list(all_tags)
        
        if not default_fwconfig_filename_or_bot:
            self.default_fwconfig = None

        else:
            default_fwconfig_filename = default_fwconfig_filename_or_bot
            
            # If we specify a default fwconfig, make sure we can load
            if not os.path.exists(default_fwconfig_filename_or_bot):
                default_fwconfig_filename = \
                    utils.find_fwconfig_for_bot(self.exe_filename,
                                                default_fwconfig_filename)
            
            if not default_fwconfig_filename:
                raise Exception("Could not find firmware configuration file "
                                "or bot type '%s'" %
                                default_fwconfig_filename_or_bot)

            self.default_fwconfig = \
                PrintEstimator.FWConfig(default_fwconfig_filename)

    class FWConfig:

        def __init__(self, json_or_filename):

            self.filename = json_or_filename
            self.md5 = None
            self.tempfile = None
        
            if not os.path.exists(json_or_filename):
                self.tempfile = utils.TemporaryFile()
                self.filename = self.tempfile.name
                with open(self.filename, 'w') as fwconfig_file:
                    json.dump(json_or_filename,
                              json_file, sort_keys=True, indent=2)
            
            self.md5 = utils.md5_hash(self.filename)
            
            self.bot_type = None
            self.use_attached_extruder = False
            
            # Figure out some firmware config properties
            with open(self.filename) as fwconfig_file:
                fwconfig_json = json.load(fwconfig_file)
                self.bot_type = fwconfig_json.get('bot_type')
                
                # The estimator needs to get these 'a' values from the attached
                # extruder if they aren't already present
                self.use_attached_extruder = \
                    'a' not in fwconfig_json['max_speed_mm_per_second']
    
    class Process(subprocess.Popen):

        """A mbaccelerate process with output and metadata files."""

        def __init__(self, 
                     print_estimator,
                     json_toolpath_filename,
                     fwconfig_filename,
                     args=[],
                     **kwargs):
            
            self.print_estimator = print_estimator
            self.json_toolpath_filename = json_toolpath_filename
            self.fwconfig_filename = fwconfig_filename
            
            self.argv = [self.print_estimator.exe_filename,
                         "--config", self.fwconfig_filename,
                         "--time"]
            
            self.argv.extend(args)
            
            self.argv.append(self.json_toolpath_filename)
            
            subprocess.Popen.__init__(self, self.argv, **kwargs)

            self.out = None
            self.err = None
    
    class EstimationError(subprocess.CalledProcessError):

        def __init__(self, rval, args, out, err):
            subprocess.CalledProcessError.__init__(self, rval, args, err)
            self.rval = rval
            self.args = args
            self.out = out
            self.err = err
    
    class Estimate:
        
        def __init__(self, print_time, fwconfig, process):
            
            self.print_time = print_time
            self.fwconfig = fwconfig
            self.process = process
    
    def estimate_print_time(self, toolpath, 
                            fwconfig_json_or_filename=None,
                            **kwargs):
        
        fwconfig = None
        
        if not fwconfig_json_or_filename:
            fwconfig = self.default_fwconfig
        
        if not fwconfig:
            raise Exception("No firmware config or default firmware config "
                            "was specified.")

        toolpath_filename = None
        toolpath_tempfile = None
        
        if toolpath.filename and toolpath.toolpath_type == 'jsontoolpath':
            toolpath_filename = toolpath.filename
        else:
            toolpath_tempfile = utils.TemporaryFile(suffix=".jsontoolpath")
            toolpath_filename = toolpath_tempfile.name
            with open(toolpath_filename, 'w') as toolpath_file:
                toolpath.dump_json_commands(toolpath_file)
        
        kwargs['env'] = os.environ
        kwargs['stdout'] = subprocess.PIPE
        kwargs['stderr'] = subprocess.PIPE

        args = []
        # Always use real-world-time
        args.append("--real-world-time")

        if fwconfig.use_attached_extruder:
            args.append("--update-extruder-params")
        
        process = PrintEstimator.Process(self, 
                                         toolpath_filename,
                                         fwconfig.filename,
                                         args,
                                         **kwargs)
        
        process.out, process.err = process.communicate()
        rval = process.wait()

        if rval != 0:
            raise PrintEstimator.EstimationError(rval, process.argv, 
                                                 process.out, process.err)
        
        return PrintEstimator.Estimate(float(process.out.strip()),
                                       fwconfig,
                                       process)
