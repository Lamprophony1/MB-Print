// Copyright 2012 MakerBot Industries

#ifndef INCLUDE_GEOMUTILS_OPENPATH_H_
#define INCLUDE_GEOMUTILS_OPENPATH_H_

#include <boost/iterator/iterator_facade.hpp>
#include <boost/iterator/iterator_adaptor.hpp>
#include <boost/type_traits.hpp>

#include <algorithm>
#include <deque>
#include <list>
#include <ostream>  // NOLINT
#include <vector>

#include "geomutils/LineSegment2.h"

namespace geomutils {

/// An open ended path
///
/// A 2d path of points with a defined beginning and end, with no assumption of
/// an interior.
///
/// This is a read-write object, meant for both constructing a path as well as
/// following it.
class GEOMUTILS_API OpenPath : public std::deque<Vector2> {
  public:
    // To make sure we have access to all 6 of std::deque's constructors, we
    // need to impliment them here.
    //
    // If we ever update to VS, we should be able to use the `using` key word
    // to inherit all of the std::deque constructors.  Until that day though,
    // this will have to remain hidden from the compiler behind a set of forward
    // slashes :(
    //
    // using std::deque<Vector2>::deque;
    //
    // Another option is to use variadic templates and perfect forwarding, like
    // what follows, but I'm personally scared of any code this clever.
    // std::deque for OpenPath.
    //
    // template <typename ... ARGS>
    // OpenPath(ARGS&& ...  args) :
    //    std::deque<Vector2>(std::forward<ARGS>(args)...) { }
    //
    // That leaves us explicity writing out all of the constructors:

    /// Constructs an empty path, with no points.
    OpenPath() : std::deque<Vector2>() { }

    /// Constructs a path with n points.
    explicit OpenPath(size_t n) : std::deque<Vector2>(n) { }

    /// Constructs a path with all the points between first and second.
    ///
    /// Each point is emplace-constructed from its corresponding element in that
    /// range, in the same order.
    template <class InputIterator>
    OpenPath(InputIterator first, InputIterator second)
      : std::deque<Vector2>(first, second) { }

    /// Constructs an OpenPath with a copy of each point in d, in order
    explicit OpenPath(const std::deque<Vector2>& d)
      : std::deque<Vector2>(d) { }

    /// Constructs an OpenPath that acquires the points of d
    ///
    /// d is left in an unspecified but valid state.
    explicit OpenPath(std::deque<Vector2>&& d)
      : std::deque<Vector2>(std::move(d)) { }

    /// Retrieve the LineSegment2 in the path that starts with a provided point.
    ///
    /// @param location iterator pointing to the first endpoint of the segment
    /// @return a new line segment starting with the point at location and in
    /// the same direction as the iterator, or a zero length segment if this is
    /// the end point in the path.
    LineSegment2 segmentAfterPoint(const_iterator location) const;

    /// Retrieve the LineSegment2 in the path that starts with a provided point.
    ///
    /// @param location iterator pointing to the first endpoint of the segment
    /// @return a new line segment starting with the point at location and in
    /// the same direction as the iterator, or a zero length segment if this is
    /// the end point in the path.
    LineSegment2 segmentAfterPoint(const_reverse_iterator location) const;

    /// Distance traversed by this path. 0 for empty path.
    Scalar distance() const;
};

GEOMUTILS_API std::ostream& operator<<(std::ostream& ostream,
                                       const OpenPath& path);

}  // namespace geomutils

namespace boost {
namespace serialization {

template <typename Archive>
void serialize(Archive& ar, geomutils::OpenPath& dest, const unsigned int) {
  if (typename Archive::is_loading()) {
    dest.clear();
    size_t count;
    ar & count;
    for (; count > 0; --count) {
      geomutils::Vector2 pt;
      ar & pt;
      dest.push_back(pt);
    }
  } else {
    size_t count = dest.size();
    ar & count;
    for (geomutils::Vector2& pt : dest) {
      ar & pt;
    }
  }
}

}  // namespace serialization
}  // namespace boost

#endif  // INCLUDE_GEOMUTILS_OPENPATH_H_
