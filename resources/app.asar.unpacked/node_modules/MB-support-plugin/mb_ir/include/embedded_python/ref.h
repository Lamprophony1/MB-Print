// Copyright 2015 MakerBot Industries

#ifndef INCLUDE_EMBEDDED_PYTHON_REF_H_
#define INCLUDE_EMBEDDED_PYTHON_REF_H_

// Allow clients to handle opaque pointers to PyObjects
// instead of including Python.h
struct _object;
typedef struct _object PyObject;

namespace embedded_python {

/// A Ref object encapsulates the concept of a (non-borrowed) python
/// reference to a python object.  It is designed to operate directly
/// with python C API calls, so it is constructed from and can be
/// implicitly casted to PyObject pointers.  In particular, the only
/// time this should ever be constructed from a PyObject pointer that
/// might be null is when it is being directly constructed from the
/// result of a C API call, as doing so will invoke Error.
///
/// Most C API calls return a new reference, which is what this class
/// expects.  If you need to use a function that returns a borrowed
/// reference, you should wrap the call in takeRef to convert it to a
/// new reference.
///
/// Most arguments to C API do not steal a reference, which is what this
/// class assumes when it is implicitly casted to PyObject*.  If this
/// needs to be passed to an API function which steals a reference, it
/// should be given a stealable copy with .copy(), or you can let it
/// actually steal the reference with .move(), after which the Ref
/// object will be default constructed.
///
/// It is assumed that the python GIL is locked when the object is
/// constructed from a python C API call, but this is not assumed at any
/// other time.  Destruction and copying of Ref objects can be
/// relatively expensive operations, if the GIL has not already been
/// acquired.
class EMBEDDED_PYTHON_API Ref {
  public:
    Ref();
    Ref(PyObject *);
    Ref(const Ref &);
    Ref(Ref &&);
    ~Ref();
    Ref & operator =(const Ref &);
    Ref & operator =(Ref &&);
    operator bool() const;

    // Object access for borrowed refs
    operator PyObject*() const;
    PyObject *lend() const;

    // Object access for new/stolen refs
    PyObject *copy() const;
    PyObject *move();

    /// Return the ref to a default constructed state
    void clear();

  private:
    void check() const;
    PyObject *m_obj;
};

// Wrapper for python API functions that return borrowed references,
// converting the PyObject to a new reference.  This should be
// immediately passed to Ref to ensure that the reference
// will be correctly cleared on destruction.
EMBEDDED_PYTHON_API PyObject * takeRef(PyObject *borrowed_obj);

}  // namespace embedded_python

#endif  // INCLUDE_EMBEDDED_PYTHON_REF_H_

