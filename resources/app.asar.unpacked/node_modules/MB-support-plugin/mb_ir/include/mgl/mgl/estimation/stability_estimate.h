
#pragma once

#include <map>
#include <vector>

#include <geomutils/Region.h>
#include <geomutils/Vector3.h>

namespace mgl {

/**
 * (Very) rough stability estimation of a print based on the plated region and
 * COM.
 * 
 * Approximates the model as a (hollow) flexible rod, checks deflection based on
 * input forces.
 */
class MGL_API StabilityEstimate {
public:
    StabilityEstimate();

    StabilityEstimate(const geomutils::Region& plated_hull,
                      Scalar plate_z,
                      const geomutils::Vector3& center_of_mass);

    // Helpful constants for PLA
    // Can be used to generate weight in kg to multiply by G=10m/s^2 => Newtons
    static const Scalar kPLADensity_kg_mm3;
    // Compatible with forces in Newtons
    static const Scalar kPLAElasticModulus_N_mm2;

    /**
     * Computes hypothetical max deflection on the COM of the sliced model.
     *
     * Distance units are implicitly mm^2, so the elastic modulus must be
     * expressed in these terms.  Force units are arbitrary so long as they
     * are all the same.
     */
    Scalar getMaxCOMDeflection(
        Scalar wobble_force,
        Scalar downward_force,
        Scalar elastic_modulus_f_mm2,
        Scalar wall_thickness = std::numeric_limits<Scalar>::max()) const;

private:
    geomutils::Region m_plated_hull;
    Scalar m_plate_z;
    geomutils::Vector3 m_center_of_mass;
};
}
