// Copyright 2011 MakerBot Industries

#ifndef MIRACLE_H_
#define MIRACLE_H_

#include <iostream>
#include <string>
#include <atomic>

#include <geomutils/model.h>

#include "mgl/configuration.h"
#include "mgl/object_data/chunk_stack.h"

namespace mgl {

/// Miracle Grue output specification
///
/// Specify the desired outputs and their destinations by setting
/// the corresponding pointers of this struct to valid ostreams.
/// A null pointer indicates that the output is not desired and its
/// generation can be skipped. Otherwise, it is an ostream (or a derived type)
/// owned elsewhere and in scope for at least the duration of the call
/// to miracleGrue.
///
/// gcode - toolpath formatted as gcode, recognized by MakerBot's 3rd and 4th
///         generation printers, their clones, and with minor modifications
///         by most other open source firmwares.
/// jsontoolpath - toolpath formatted as json, for MakerBot's 5th generation
///                printers and onward.
/// metadatata - Information about the print formatted as json.
struct MGL_API MiracleOutputs {
    MiracleOutputs()
        : gcode(nullptr), jsontoolpath(nullptr), metadata(nullptr) {}
    std::ostream* gcode;
    std::ostream* jsontoolpath;
    std::ostream* metadata;
};

/// Miracle Grue translates a 3D model file and Configuration into a GCODE or
/// JSON toolpath for a 3D printer.
///
/// config - The configuration to use while generating the toolpath
/// layout - The layout to be sliced and toolpathed.
/// output - The output specification. Output will be written to
///          the non-null ostreams.
void MGL_API miracleGrue(const Configuration& config,
                         const std::shared_ptr<geomutils::Layout> layout,
                         const MiracleOutputs& output,
                         const std::atomic_bool & cancel,
                         std::ostream * out=&std::cout);

/// Slice a 3D model file into a number of chunks, do not generate commands.
ChunkStack MGL_API basicSlice(const Configuration& config,
                              std::shared_ptr<geomutils::Layout> layout,
                              const std::atomic_bool & cancel);

ChunkStack MGL_API regionedSlice(const Configuration& config,
                                 std::shared_ptr<geomutils::Layout> layout,
                                 const std::atomic_bool & cancel);

ChunkStack MGL_API filledSlice(const Configuration& config,
                               std::shared_ptr<geomutils::Layout> layout,
                               const std::atomic_bool & cancel);

/// Read the config and write it back out to the outputStream.
/// The written config should match exactly what is seen by all the stages,
/// with unused values removed and unset values set to either null or the
/// appropriate default.
void MGL_API regurgitateMiracleConfig(const Configuration& config,
                                      std::ostream& outputStream);

Json::Value MGL_API metaData(const Configuration& configuration_obj,
                             const std::shared_ptr<geomutils::Layout> layout,
                             const std::atomic_bool & cancel);
}

#endif
