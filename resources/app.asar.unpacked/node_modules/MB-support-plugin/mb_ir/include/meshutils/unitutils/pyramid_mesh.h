#pragma once

#include <memory>
#include <vector>

#include <Eigen/Geometry>

#include "geomutils/Vector2.h"
#include "geomutils/Vector3.h"
#include "meshutils/connected_mesh.h"

namespace unitutils {

/**
 * A pyramid mesh - a two-triangle mesh base with a peak vertex centered a
 * certain height above the base.
 *
 *  peak   _
 *   /\    |
 *  /  \   | height
 * /____\  _
 *   ^
 *   base
 *
 * TODO: Test-only?  Expose elsewhere for other library testing?
 */
class MESHUTILS_API PyramidMesh {
public:
    typedef geomutils::Vector3 Vector3;
    typedef geomutils::Vector2 Vector2;
    typedef LibThing::ConnectedMesh ConnectedMesh;
    typedef Eigen::Vector2i Vector2i;

    /**
     * Create a PyramidMesh with cell (0, 0) starting from position (lower-left)
     * with base of size base_size and height.
     */
    PyramidMesh(const Vector3& position,
                const Vector2& base_size,
                Scalar height);

    ConnectedMesh& getMesh() { return *m_mesh; }

    enum class Direction {
        Bottom = 0,
        Right = 1,
        Top = 2,
        Left = 3,
        LowerLeft = 4,
        UpperLeft = 5,
        LowerRight = 6,
        UpperRight = 7
    };

    /**
     * Return the vertex on the base of the pyramid.
     */
    ConnectedMesh::VertexHandle getBaseVertex(Direction direction) const;

    /**
     * Return a vertex at the peak of the pyramid.
     */
    ConnectedMesh::VertexHandle getPeakVertex() const;

    /**
     * Return the edge on the base of the pyramid.
     */
    ConnectedMesh::EdgeHandle getBaseEdge(Direction direction) const;

    /**
     * Return the edge to the peak of the pyramid.
     */
    ConnectedMesh::EdgeHandle getPeakEdge(Direction direction) const;

    typedef std::pair<ConnectedMesh::FaceHandle, ConnectedMesh::FaceHandle>
        FaceHandlePair;

    /**
     * Return the pair of triangle faces of the pyramid base.
     */
    FaceHandlePair getBaseFaces() const;

    /**
     * Return the peak face at the given direction.
     */
    ConnectedMesh::FaceHandle getPeakFace(Direction direction) const;

private:
    void init();

    const Vector3 m_position;
    const Vector2 m_base_size;
    const Scalar m_height;

    std::shared_ptr<ConnectedMesh> m_mesh;

    ConnectedMesh::VertexHandle m_peak_vertex;
    std::vector<ConnectedMesh::VertexHandle> m_base_vertices;

    std::vector<ConnectedMesh::FaceHandle> m_peak_faces;
    FaceHandlePair m_base_faces;

    std::vector<ConnectedMesh::EdgeHandle> m_peak_edges;
    std::vector<ConnectedMesh::EdgeHandle> m_base_edges;
};
}
