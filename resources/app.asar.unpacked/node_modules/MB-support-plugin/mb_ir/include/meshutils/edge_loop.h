#pragma once

#include <memory>
#include <vector>

#include "geomutils/Vector3.h"
#include "connected_mesh.h"

#include <iostream>

namespace LibThing {

/**
 * EdgeLoops are self-connecting sequences of halfedges on a ConnectedMesh.  
 */
class MESHUTILS_API EdgeLoop {
public:
    typedef std::vector<ConnectedMesh::HalfedgeHandle> HalfedgeHandles;
    typedef std::vector<ConnectedMesh::VertexHandle> VertexHandles;
    typedef std::vector<ConnectedMesh::Point> Points;

    EdgeLoop(const ConnectedMesh& mesh, const HalfedgeHandles& halfedges);

    const ConnectedMesh& getMesh() const { return *m_mesh; }

    const HalfedgeHandles& getHalfedges() const { return m_halfedges; }

    VertexHandles toVertices() const;

    Points toPoints() const;

    /**
     * Useful for determinstic testing, sorts the halfedges by the Points they
     * refer to.
     */
    void normalize();

    /**
     * Useful for deterministic testing, normalizes and sorts all the loops by
     * the points they contain in lexographic order. 
     */
    static void normalize(std::vector<EdgeLoop>& loops);

    size_t size() const;

    HalfedgeHandles::const_iterator begin() const;

    HalfedgeHandles::const_iterator end() const;

    /**
     * Returns the minimum 3D distance between two loops of halfedges, treating
     * the EdgeLoops as a sequence of 3D line segments.
     *
     * Implemented in the dumbest possible n^2 way.
     */
    static Scalar minDistance(const EdgeLoop& loop_a, const EdgeLoop& loop_b);

    typedef std::pair<geomutils::Vector3, geomutils::Vector3> LineSegment3;

    /**
     * Compute the minimum distance between two 3D line segments.
     * Exposed for testing.
     */
    static Scalar minSegmentDistance(const LineSegment3& segment_a,
                                     const LineSegment3& segment_b);

    friend std::ostream& operator<<(std::ostream& os, const EdgeLoop& loop);

    friend std::ostream& operator<<(std::ostream& os,
                                    const std::vector<EdgeLoop>& loops);

private:
    ConnectedMesh const* m_mesh;
    HalfedgeHandles m_halfedges;
};

std::ostream& operator<<(std::ostream& ostream, const EdgeLoop& loop);
std::ostream& operator<<(std::ostream& ostream,
                         const std::vector<EdgeLoop>& loops);

}  // namespace LibThing
