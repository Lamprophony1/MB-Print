// Copyright 2013 MakerBot Industries

#ifndef INCLUDE_THING_INSTANCE_H_
#define INCLUDE_THING_INSTANCE_H_

#include <Eigen/StdVector>

#include <list>
#include <memory>
#include <string>
#include <vector>

#include "geomutils/Scalar.h"
#include "geomutils/Loop.h"
#include "geomutils/limits.h"
#include "geomutils/OpenPath.h"
#include "thing/transform.h"
#include "thing/mesh.h"

namespace LibThing {

/// Representation of an STL mesh on a buildplate
///
/// Each instance must have a shared pointer to a Mesh object. Additionally, it
/// may have a Transformation that rescales, moves, and rotates the mesh and a
/// material string  that describes which material to print that Mesh with.
class THING_API Instance {
 public:
  /// Mesh cannot be NULL
  Instance(const std::shared_ptr<Mesh>,
           const Transform &transform,
           const std::string materialString);

  Instance(const Instance &instance);

  ~Instance();

  void operator=(const Instance &instance);

  /// Accessors for the instances mesh, transform, and material string
  const std::shared_ptr<Mesh> mesh() const;
  const Transform &transform() const;
  const std::string materialString() const;

  /// is the mesh watertight
  bool isWatertight() const;

  /// Prepare the instance for slicing
  ///
  /// Actually performs the mesh transformations to allow limit and loop
  /// calculations.
  void prepareForSlicing();

  /// Calculate the limits (bounding box) of the Instance
  geomutils::Limits calculateLimits() const;

  /// chande the z height of the instance by Scalar z
  void changeZHeight(const Scalar z);

  /// Returns the internally stored vector of transformed meshes.
  ///
  /// Must be called after prepareForSlicing().
  const std::vector<ConnectedMesh>& getTransformedMeshes();

  /// Retrieve loops at the specified z-height
  ///
  /// Using the specified z-action for points that lie exactly or within some
  /// specified proximity of the zHeight. At this time zAction will involve
  /// bumping vertices on the intersecting plane up.
  std::list<geomutils::Loop> getLoops(const Scalar zHeight);

  /// m_transformedMeshes is holding a vector of ConnectedMeshes that are all
  /// holding on to a basic interval tree, with a node for each face (which is
  /// expensive!). After we're done slicing loops, we do not need those meshes
  /// or the interval trees.
  void clearSlicingData();

  /// counters for the faces and verts of the transformed mesh in this instance
  int numberFaces() const;
  int numberVerts() const;

  void updateScale(float x, float y, float z);

 private:
  /// the contents of the instance
  std::shared_ptr<Mesh> m_mesh;
  Transform m_transform;
  std::string m_materialString;

  /// vector of transformed indexed meshes used for slicing - not populated
  /// immediately
  std::vector<ConnectedMesh> m_transformed_meshes;
};

}  // namespace LibThing

#endif  // INCLUDE_THING_INSTANCE_H_
