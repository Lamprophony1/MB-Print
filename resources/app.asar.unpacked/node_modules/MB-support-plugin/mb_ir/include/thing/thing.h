// Copyright 2013 Makerbot Industries

#ifndef INCLUDE_THING_THING_H_
#define INCLUDE_THING_THING_H_

// See MW-2333
// remove when upgrading eigen
#if defined(__unix__) || defined(__unix)
#include <unistd.h>
#endif

#include <Eigen/StdVector>

#include <list>
#include <map>
#include <memory>
#include <set>
#include <string>
#include <utility>
#include <vector>

#include "geomutils/limits.h"
#include "geomutils/model.h"
#include "geomutils/Loop.h"
#include "geomutils/limits.h"
#include "thing/transform.h"
#include "thing/gaggle.h"
#include "thing/mesh.h"

namespace LibThing {

struct FileFormat;

// Takes a 4x4 matrix and converts it into a Transform object
Transform THING_API convertMatrix4x4ToAffine3f(const Eigen::Matrix4f &in);

/// A collection of Instances representing a mesh model on a buildplate
class THING_API Thing : public geomutils::Layout {
 public:
  /// Create an empty Thing
  /// Usually things have been put on a build plate already, but if not, we can
  /// put the loaded thing on the plate ourselves.
  /// TODO: This is kind of awkward, loadLayout() probably doesn't belong in the
  /// Model interface, which would let this be a load param.
  Thing();

  ~Thing();

  /// Clear any existing data and load in either a thing or a mesh.
  ///
  /// First calls the private method read, which will only work for valid dot
  /// thing files. If read throws an exception, call load(), which  attmpts to
  /// load the file as a mesh.
  bool loadLayout(const std::string& filepath);

  /// Output Thing to 'filename' using 'format'
  ///
  /// An exception will be thrown if format is not a valid export format.
  void write(const std::string &filename, const FileFormat *format);

  /// Write out all of the meshes in this thing as a single STL file.
  ///
  /// TODO(zap) - used in Prototype/src/scan/thingiverse_private_sync.cpp. I
  /// would like it to be a private method if we can.
  void writeStlBinary(std::ostream *out) const;
  void writeStlAscii(std::ostream *out) const;

  /// accessor for vector of models in this Thing
  ///
  /// note: in a thing, the models are gaggles aka, collections of instances.
  const std::vector<std::shared_ptr<geomutils::Model> > getModels() const;

  geomutils::Limits getLimits() const;

  // An utility function that returns a vecotr of slices for a given layer resolution
  std::vector<geomutils::ZSlice> getZSlices(Scalar layerResolution);

  void addInstance(
      const std::string& gaggleName,
      const std::string& meshFilePath,
      const Transform& identity,
      const std::string& material);

  void addInstance(
      const std::string& gaggleName,
      const std::shared_ptr<Mesh> mesh,
      const Transform& identity,
      const std::string& material);

 private:
  std::vector<std::shared_ptr<Gaggle>> m_gaggles;
  std::map<std::string, std::shared_ptr<Mesh>> m_meshes;

  /// Import a thing from the file located at filepath
  void read(const std::string &filepath);

  /// Exporters
  void writeThing(const std::string &filename) const;
  void writeFromOpenMesh(
    const std::string &filename, bool binary = false) const;
};
}

#endif  // INCLUDE_THING_THING_H_
