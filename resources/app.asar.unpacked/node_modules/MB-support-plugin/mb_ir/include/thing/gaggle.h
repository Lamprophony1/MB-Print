// Copyright 2016 Makerbot Industries

#ifndef INCLUDE_THING_GAGGLE_H_
#define INCLUDE_THING_GAGGLE_H_

#include <string>
#include <vector>

#include "geomutils/limits.h"
#include "geomutils/model.h"
#include "thing/instance.h"

namespace LibThing {

class Mesh;
class Transform;

// "If I remember correctly, eigen types require a certain alignment larger than
// what you would get by default on a 32 bit system, but probably works fine on
// a 64 bit system"
// fillip
typedef Eigen::aligned_allocator<Instance> InstanceAllocator;
typedef std::vector<Instance, InstanceAllocator> InstanceVector;

/// A collection of Instances representing a mesh model on a buildplate
class THING_API Gaggle : public geomutils::Model {
 public:
  Gaggle(std::string name, bool isPlated);

  ~Gaggle();

  /// Add an instance to this Thing's vector of instances
  void addInstance(
      const std::shared_ptr<Mesh> mesh,
      const Transform &transform,
      const std::string toolheadString);

  /// Prepare each instance in m_instances for slicing
  void prepareForSlicing();

  void clearSlicingData();

  /// Get the limits that bound this thing
  geomutils::Limits getLimits() const;

  /// Is this thing watertight w.r.t. the buildplate
  bool isWatertight() const;

  /// Check if all meshes within thing file are manifold.
  bool isManifold() const;

  /// Create a representation of the bounding region of the gaggle at a zHeight
  const geomutils::ZSlice getSlice(Scalar zHeight);

  /// get the vector of instances in this gaggle
  const InstanceVector& instances() const;

  void updateScale(float x, float y, float z);

 private:
  bool m_isPlated;
  InstanceVector m_instances;
  geomutils::Limits m_limits;
};  // end of class Gaggle
}  // end of libthing namespace

#endif  // INCLUDE_THING_GAGGLE_H_
