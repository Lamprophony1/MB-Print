// Copyright 2016 MakerBot Industries

#ifndef FIRMWARE_PARSER_SRC_FILE_READER_HH_
#define FIRMWARE_PARSER_SRC_FILE_READER_HH_

#include <tinything/TinyThingReader.hh>

#include <string>
#include <vector>

#include "machine_errors.hh"  // Codegen'd in MBCoreUtils

// forward declare the yajl_handle typedef so we donâ€™t have to include
// yajl/yajl_parse here
extern "C" {
  struct yajl_handle_t;
  typedef yajl_handle_t * yajl_handle;
}

namespace BirdWing {

enum callbackStatus {
    kCallbackError = 0,
    kCallbackOk = 1,
    kCallbackNothing = 2,
};

/* Base implementation for all filereaders.
 * Concrete subclasses must implement OpenFile and FillBuffer.
*/
class FileReader {
  public:
    FileReader(yajl_handle handle);
    virtual ~FileReader();

    /* Initializes the parser.  Must be called prior to parsing.
     * Returns machine::kOk on success, other appropriate machine
     * error code (kFileNotFound, kInvalidFileType, etc.) on failure.
     */
    machine::Error Initialize();

    /* Parses until DoneParsing() is called (returns kCallbackOk), until
     * we get a parse error (returns kCallbackError), or until the end of
     * the file (returns kCallbackNothing).
     */
    callbackStatus ParseNext();

    /* Called by the parser to interrupt a ParseNext() call. */
    void DoneParsing();

    /* Called by the parser to provide verbose
     * information when a parsing error has occured.
     */
    std::string GetContext();

  protected:
    /* Should either sucessfully open the file being read and return
     * machine::kOk or return an appropriate error code describing
     * why we failed to open the file.
     */
    virtual machine::Error OpenFile() = 0;

    /* Should fill in as much of buffer_ as possible with data read
     * from the open file, and set valid_length_ to the amount of
     * data read.  Should only set valid_length_ to 0 if we hit the
     * end of the file, but for lack of any other error handling
     * mechanism, read errors may also set valid_length_ to 0.
     */
    virtual void FillBuffer() = 0;

    /* Subclasses should not resize this */
    std::vector<char> buffer_;

    size_t valid_length_;

  private:
    unsigned char * next_char_;
    yajl_handle handle_;
    bool parsing_;
};

/* The standard method for creating a filereader.  Opens the file found
 * at filepath for parsing, and uses the file extension to determine
 * what type of reader to create.  A file descriptor can be passed in
 * to allow an already open file to be parsed -- only some reader
 * classes support this.  To support unit tests, a json blob followed
 * by ".unittest" can be passed in as the filepath, which will cause
 * the reader to just parse the given json blob.
 */
FileReader * CreateFileReader(std::string const & filepath,
                              yajl_handle handle, int fd = -1);

}  // namespace BirdWing

#endif  // FIRMWARE_PARSER_SRC_FILE_READER_HH_
