// Copyright 2014 MakerBot Industries

#ifndef INCLUDE_CROISSANT_ASYNCHRONOUS_METHOD_H_
#define INCLUDE_CROISSANT_ASYNCHRONOUS_METHOD_H_

#include <memory>
#include <string>

#include "croissant/future.h"

#include <jsonrpc/jsonrpc.h>

namespace croissant {

/// Generic JSON-RPC with asynchronous response handling via futures
///
/// The command has a name and a set of parameters. It is sent to the
/// server by calling the invoke() method.
///
/// Note that every response will automatically be logged, no need to
/// do that again in the response handler.
///
/// It's safe to destruct an AsynchronousMethod at any time.  This will
/// not affect any futures returned by invoke.
class CROISSANT_API AsynchronousMethod {
  public:
    /// If true (the default), the invoke() logs itself
    bool logInvoke;

    /// If true (the default), valid responses are logged
    bool logValidResponse;

    /// If true (the default), invalid responses are logged
    bool logErrorResponse;

  protected:
    /// Construct a command object with the given method name
    explicit AsynchronousMethod(const std::string &methodName);

    virtual ~AsynchronousMethod();

    /// Invoke a remote method call via JSON-RPC
    ///
    /// An error will be thrown if the 'params' argument is not a JSON
    /// object.
    boost::future<Json::Value> invoke(
            JsonRpc &jsonRpc,
            const Json::Value &params);
    boost::future<Json::Value> invokeRaw(
            JsonRpc &jsonRpc,
            const Json::Value &params,
            const char * block,
            const size_t length);
    void notify(
            JsonRpc &jsonRpc,
            const Json::Value &params);

  private:
    // Disabled copy constructor
    AsynchronousMethod(const AsynchronousMethod &other);

    // Disabled assignment operator
    void operator=(const AsynchronousMethod &other);

    // We make this shared to avoid the overhead of copying this string
    // on every method call.
    std::shared_ptr<std::string> methodName;
};
}

#endif  // INCLUDE_CROISSANT_ASYNCHRONOUS_METHOD_H_
