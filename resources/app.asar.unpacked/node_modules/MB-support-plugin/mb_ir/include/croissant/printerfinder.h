// Copyright 2015 MakerBot Industries

#ifndef INCLUDE_CROISSANT_PRINTERFINDER_H_
#define INCLUDE_CROISSANT_PRINTERFINDER_H_

#include <string>
#include <memory>
#include <utility>

#include <jsoncpp/json/value.h>
#include "croissant/printer.h"
#include "croissant/future.h"

namespace croissant {

/// A lightweight object describing a printer that we can connect to.
/// A single physical printer may have multiple PrinterInfo objects
/// if we are able to connect to it in multiple ways.
class CROISSANT_API PrinterInfo {
  public:
    enum ConnectionType {
      Invalid,
      Network,
      Usb,
      Reflector
    };

    /// The one true and immutable unique identifier for this printer.
    /// This and this alone should be used for determining whether
    /// different PrinterInfo objects are simply different interfaces
    /// to the same physical printer, for storing printer authentication
    /// info, and for caching any per printer state/statistics/etc.
    std::string uid;

    /// The address to connect to for this printer.
    std::string address;

    /// The display name for this printer.  This may include unicode
    /// characters, which will be utf-8 encoded.
    std::string name;

    /// Type of connection for which this printerInfo represents
    ConnectionType connType;

    /// A dictionary of other information about this printer and or
    /// printer connection interface.  Subject to change without notice.
    Json::Value info;

    static std::string connTypeToString(const ConnectionType & connType);
    static ConnectionType connTypeFromString(const std::string & connType);
};

/// Create an object for finding printers and creating printer objects
class CROISSANT_API PrinterFinder {
  public:
    PrinterFinder();
    ~PrinterFinder();

    /// Set the client secret used for network authentication.  This
    /// should be generated randomly once by the client when it is
    /// first installed and should not be subsequently changed.
    /// This must be set before connecting to any printers.
    void setClientSecret(const std::string &secret);

    /// Set the thingiverse username and auth token for this client.
    /// These will be applied to all subsequently created Printers
    void setThingiverseInfo(const std::string &username,
                            const std::string &token);
    void clearThingiverseInfo();

    /// Set only the username displayed when first authenticating to a
    /// network bot.  This will clear any thingiverse account set.
    void setUsernameOnly(const std::string &username);

    /// Start finding printers.  The callback passed as an argument will
    /// be invoked sequentially, once per located printer interface.
    /// This callback may be invoked at any time until findPrinters is
    /// invoked again with a new callback or stopFindingPrinters is
    /// invoked.  Printers that were not online when findPrinters() was
    /// invoked may or may not invoke the callback when they come online.
    ///
    /// The returned future will become ready when we stop listening for
    /// printers, and may contain an exception if listening errored out.
    boost::future<void> findPrinters(
        std::function<void(PrinterInfo &&)> foundCallback);

    /// Find a printer by IP.  Connect to it, handshake it, then disconnect.
    /// Return its info as a PrinterInfo object.
    boost::future<PrinterInfo> findByIp(const std::string ip);

    /// Stop listening for new printers and stop invoking the last callback
    /// passed to findPrinters.
    boost::future<void> stopFindingPrinters();

    /// Connect to a printer for the first time.  In addition to a printer
    /// object, this returns authentication info needed to reconnect to the
    /// printer as a json value.  The json value will be null if no
    /// authentication is needed, and is wrapped in a future that will not
    /// return until authentication is complete.
    std::pair<
        PrinterFuture,
        boost::future<boost::optional<Json::Value> >
    > connectPrinter(const PrinterInfo &info);

    /// Reconnect to a printer that this client has previously connected to.
    /// This should be considered mandatory for any printer that returned
    /// non-null authentication info on the first connection attempt, and can
    /// also be used for priters that do not need authentication.
    ///
    /// TODO: This needs to somehow report back when auth_info was rejected
    PrinterFuture reconnectPrinter(const PrinterInfo &info,
                                   const Json::Value &auth_info);

    class Private;
  private:
    std::shared_ptr<Private> m_private;
};

}  // namespace croissant

#endif  // INCLUDE_CROISSANT_PRINTERFINDER_H_
