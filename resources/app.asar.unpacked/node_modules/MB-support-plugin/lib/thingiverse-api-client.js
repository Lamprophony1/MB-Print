'use strict';

const Eagle = require('eagle-print');

const TypeCheck = Eagle.util.TypeCheck;

const EventEmitter = require('eventemitter3');

const q = require('q');

const url = require('url');

const request = require('request');

const fs = require('fs-extra');

const path = require('path');

const util = require('./util');

const ErrorsEnum = require('./thingiverse-api-errors').ErrorsEnum;

const TVApiError = require('./thingiverse-api-errors').ThingiverseApiError;

const client_id = '23c5eabe7a566d3a53c0';
const client_secret = 'c30f532bcc67bb65d3476daedc0e60f4';
const redirectUri = 'makerbotprint://callback';
const baseOauthUrl = 'https://login.makerbot.com'; // TODO: Move this out to default-config to support staging URL in the future

const reflectorUrl = 'https://reflector.makerbot.com';

class ThingiverseApiClient extends EventEmitter {
  /**
   * @param {string} serverConfig
   * @param {LoggingService} loggerService
   */
  constructor(serverConfig, loggerService, trackingService, configService) {
    TypeCheck.isType(serverConfig, Object);
    TypeCheck.isType(loggerService, Object);
    TypeCheck.isType(trackingService, Object);
    TypeCheck.isType(configService, Object);
    super();
    this._trackingService = trackingService;
    this._configService = configService;
    this.serverConfig = serverConfig;
    this.log = loggerService;
    this.suppressedHeaders = ['Authorization'];
  }

  _sanitizeForLogging(headers) {
    //Suppressed headers will be replaced with 'omitted' in debug logs
    const sanitizedHeaders = Object.assign({}, headers);
    this.suppressedHeaders.map(function (headerField) {
      if (sanitizedHeaders[headerField]) {
        sanitizedHeaders[headerField] = 'omitted';
      }
    });
    return sanitizedHeaders;
  }

  _request(token, options) {
    return q.Promise((resolve, reject) => {
      options.url = options.url || this.getUrl(options.path);
      delete options.path;
      options.headers = options.headers || {};

      if (token) {
        options.headers['Authorization'] = `Bearer ${token}`;
        options.headers['Content-Type'] = 'application/json';
      }

      const proxySettings = this._configService.get('proxySettings');

      if (proxySettings) {
        let hostInfo;
        let userInfo = '';

        if (proxySettings.address && proxySettings.port) {
          hostInfo = `${proxySettings.address}:${proxySettings.port}`; // Username and Password can be optional!

          if (proxySettings.username && proxySettings.password) {
            userInfo = `${proxySettings.username}:${proxySettings.password}@`;
          }

          options.proxy = proxySettings.protocol + userInfo + hostInfo;
        }
      }

      this.log.info('Thingiverse Api request: ', {
        url: options.url,
        method: options.method,
        headers: this._sanitizeForLogging(options.headers),
        encoding: options.encoding,
        body: options.body
      }); // clarity for future selves -> this is using the imported 'request' library here inside _request()

      request(options, (error, response, body) => {
        const parsedError = this._parseErrorResponse(options, error, response, body);

        if (parsedError) {
          this._handleError(reject, parsedError);

          this.log.info('Thingiverse Api request error: ', parsedError);
        } else {
          this._handleSuccessfulResponse(resolve, response, body);

          this.log.debug('Thingiverse Api request success: ', response.status_code);
        }
      });
    });
  }

  _parseErrorResponse(options, error, response, body) {
    // add more error codes if we know of them
    if (error) {
      console.log(`Connection Error ${error.message}`);
      return new TVApiError(error.message, ErrorsEnum.ConnectionError);
    } else if (response.statusCode == 403) {
      return new TVApiError('Access Denied', ErrorsEnum.AccessDenied);
    } else if (response.statusCode == 404) {
      return new TVApiError('Not Found', ErrorsEnum.FileNotFound);
    } else if (response.statusCode == 405) {
      return new TVApiError('Method Not Allowed', ErrorsEnum.MethodNotAllowed);
    } else if (response.statusCode >= 500) {
      return new TVApiError('Server Error', ErrorsEnum.ServerError);
    } else if (response.statusCode >= 400) {
      return new TVApiError('Client Error', ErrorsEnum.ClientError);
    }
  }

  _handleSuccessfulResponse(resolve, response, body) {
    let parsedResponse;

    if (response.headers['content-type'] && response.headers['content-type'].indexOf('json') > -1) {
      parsedResponse = JSON.parse(body);
    } else {
      parsedResponse = body; // if the response is url-encoded, access_token is sent in the body
      // and is of the format ^access_token=<token>&token_type=Bearer.
      // token will need to be extracted out of that

      const access_token = /^access_token=.*&token_type=Bearer$/.test(body) ? body.match(/^access_token\=([\S\s]*?)\&/)[1] : null;
      if (access_token) parsedResponse = access_token;
    }

    resolve(parsedResponse);
    this.emit('successfulResponse', parsedResponse);
  }

  _handleError(reject, error) {
    this.emit('error', error);
    reject(error);
  }

  getUrl(path) {
    // for auth (login), we user the auth url
    // after successful auth, further api calls are with the api url
    if (path) {
      const serverUrl = /\.*login\.*/.test(path) ? this.serverConfig['server']['auth_url'] : this.serverConfig['server']['api_url'];
      return url.resolve(serverUrl, path);
    }

    return undefined;
  }
  /**
   * Authenticate user on server and return token to be used in other requests.
   * @param {string} username
   * @param {string} password
   * @returns {Promise} resolves to {string} token or one of errors
   */


  authenticate(username, password) {
    return this._request(null, {
      method: 'POST',
      path: `login/oauth/access_token`,
      form: {
        grant_type: 'password',
        client_id,
        client_secret,
        username,
        password
      }
    });
  }
  /**
   * Invalidate token on server. NB: this method will fail if token is invalid,
   * so you might need to ignore its result if you just need to log user out.
   * @param {string} token
   * @returns {Promise}
   */


  logout(token) {
    return this._request(token, {
      method: 'DELETE',
      path: `sessions`
    });
  }

  getUser(token) {
    return this._request(token, {
      path: `users/me`
    });
  }

  getAvatar(token, url) {
    /* Ideally, I should have used the request call we have for all the api requests
       but, it doesn't work with the current way request is setup.
       Can't have a callback as well as pipe to stream...besides, I'm not sure
       I want the response always piped to a file.
     */
    let remote, app;

    try {
      remote = require('electron').remote;
      app = remote.app;
    } catch (err) {
      // if this is being run from the main process, then 'remote' doesn't exist and will throw an error
      // in that case, simply require app
      try {
        app = require('electron').app;
      } catch (err) {// this can happen if running in unit test environment
      }
    }

    const userDataPath = app ? app.getPath('userData') : '';
    const avatarFile = path.resolve(userDataPath, 'avatar.jpg');
    return q.Promise((resolve, reject) => {
      const avatarFileStream = fs.createWriteStream(avatarFile);
      avatarFileStream.on('finish', function () {
        resolve(avatarFile);
      });
      request.get(url).on('error', err => this._handleError(reject, err)).pipe(avatarFileStream).on('error', err => this._handleError(reject, err));
    });
  }

  getUserPrintersFromReflector(token) {
    const options = {
      url: `${reflectorUrl}/printers`
    };
    return this._request(token, options);
  }

  getClientId() {
    return client_id;
  }

  getRedirectUri() {
    return redirectUri;
  }

  getBaseOauthUrl() {
    return baseOauthUrl;
  }

}

module.exports = ThingiverseApiClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRoaW5naXZlcnNlLWFwaS1jbGllbnQuanMiXSwibmFtZXMiOlsiRWFnbGUiLCJyZXF1aXJlIiwiVHlwZUNoZWNrIiwidXRpbCIsIkV2ZW50RW1pdHRlciIsInEiLCJ1cmwiLCJyZXF1ZXN0IiwiZnMiLCJwYXRoIiwiRXJyb3JzRW51bSIsIlRWQXBpRXJyb3IiLCJUaGluZ2l2ZXJzZUFwaUVycm9yIiwiY2xpZW50X2lkIiwiY2xpZW50X3NlY3JldCIsInJlZGlyZWN0VXJpIiwiYmFzZU9hdXRoVXJsIiwicmVmbGVjdG9yVXJsIiwiVGhpbmdpdmVyc2VBcGlDbGllbnQiLCJjb25zdHJ1Y3RvciIsInNlcnZlckNvbmZpZyIsImxvZ2dlclNlcnZpY2UiLCJ0cmFja2luZ1NlcnZpY2UiLCJjb25maWdTZXJ2aWNlIiwiaXNUeXBlIiwiT2JqZWN0IiwiX3RyYWNraW5nU2VydmljZSIsIl9jb25maWdTZXJ2aWNlIiwibG9nIiwic3VwcHJlc3NlZEhlYWRlcnMiLCJfc2FuaXRpemVGb3JMb2dnaW5nIiwiaGVhZGVycyIsInNhbml0aXplZEhlYWRlcnMiLCJhc3NpZ24iLCJtYXAiLCJoZWFkZXJGaWVsZCIsIl9yZXF1ZXN0IiwidG9rZW4iLCJvcHRpb25zIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJnZXRVcmwiLCJwcm94eVNldHRpbmdzIiwiZ2V0IiwiaG9zdEluZm8iLCJ1c2VySW5mbyIsImFkZHJlc3MiLCJwb3J0IiwidXNlcm5hbWUiLCJwYXNzd29yZCIsInByb3h5IiwicHJvdG9jb2wiLCJpbmZvIiwibWV0aG9kIiwiZW5jb2RpbmciLCJib2R5IiwiZXJyb3IiLCJyZXNwb25zZSIsInBhcnNlZEVycm9yIiwiX3BhcnNlRXJyb3JSZXNwb25zZSIsIl9oYW5kbGVFcnJvciIsIl9oYW5kbGVTdWNjZXNzZnVsUmVzcG9uc2UiLCJkZWJ1ZyIsInN0YXR1c19jb2RlIiwiY29uc29sZSIsIm1lc3NhZ2UiLCJDb25uZWN0aW9uRXJyb3IiLCJzdGF0dXNDb2RlIiwiQWNjZXNzRGVuaWVkIiwiRmlsZU5vdEZvdW5kIiwiTWV0aG9kTm90QWxsb3dlZCIsIlNlcnZlckVycm9yIiwiQ2xpZW50RXJyb3IiLCJwYXJzZWRSZXNwb25zZSIsImluZGV4T2YiLCJKU09OIiwicGFyc2UiLCJhY2Nlc3NfdG9rZW4iLCJ0ZXN0IiwibWF0Y2giLCJlbWl0Iiwic2VydmVyVXJsIiwidW5kZWZpbmVkIiwiYXV0aGVudGljYXRlIiwiZm9ybSIsImdyYW50X3R5cGUiLCJsb2dvdXQiLCJnZXRVc2VyIiwiZ2V0QXZhdGFyIiwicmVtb3RlIiwiYXBwIiwiZXJyIiwidXNlckRhdGFQYXRoIiwiZ2V0UGF0aCIsImF2YXRhckZpbGUiLCJhdmF0YXJGaWxlU3RyZWFtIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJvbiIsInBpcGUiLCJnZXRVc2VyUHJpbnRlcnNGcm9tUmVmbGVjdG9yIiwiZ2V0Q2xpZW50SWQiLCJnZXRSZWRpcmVjdFVyaSIsImdldEJhc2VPYXV0aFVybCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLGFBQUQsQ0FBckI7O0FBQ0EsTUFBTUMsU0FBUyxHQUFHRixLQUFLLENBQUNHLElBQU4sQ0FBV0QsU0FBN0I7O0FBQ0EsTUFBTUUsWUFBWSxHQUFHSCxPQUFPLENBQUMsZUFBRCxDQUE1Qjs7QUFDQSxNQUFNSSxDQUFDLEdBQUdKLE9BQU8sQ0FBQyxHQUFELENBQWpCOztBQUNBLE1BQU1LLEdBQUcsR0FBR0wsT0FBTyxDQUFDLEtBQUQsQ0FBbkI7O0FBQ0EsTUFBTU0sT0FBTyxHQUFHTixPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFDQSxNQUFNTyxFQUFFLEdBQUdQLE9BQU8sQ0FBQyxVQUFELENBQWxCOztBQUNBLE1BQU1RLElBQUksR0FBR1IsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBRUEsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsUUFBRCxDQUFwQjs7QUFDQSxNQUFNUyxVQUFVLEdBQUdULE9BQU8sQ0FBQywwQkFBRCxDQUFQLENBQW9DUyxVQUF2RDs7QUFDQSxNQUFNQyxVQUFVLEdBQUdWLE9BQU8sQ0FBQywwQkFBRCxDQUFQLENBQW9DVyxtQkFBdkQ7O0FBRUEsTUFBTUMsU0FBUyxHQUFHLHNCQUFsQjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxrQ0FBdEI7QUFFQSxNQUFNQyxXQUFXLEdBQUcsMEJBQXBCO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLDRCQUFyQixDLENBRUE7O0FBQ0EsTUFBTUMsWUFBWSxHQUFHLGdDQUFyQjs7QUFFQSxNQUFNQyxvQkFBTixTQUFtQ2QsWUFBbkMsQ0FBZ0Q7QUFDNUM7QUFDSjtBQUNBO0FBQ0E7QUFDSWUsRUFBQUEsV0FBVyxDQUFDQyxZQUFELEVBQWVDLGFBQWYsRUFBOEJDLGVBQTlCLEVBQStDQyxhQUEvQyxFQUE4RDtBQUNyRXJCLElBQUFBLFNBQVMsQ0FBQ3NCLE1BQVYsQ0FBaUJKLFlBQWpCLEVBQStCSyxNQUEvQjtBQUNBdkIsSUFBQUEsU0FBUyxDQUFDc0IsTUFBVixDQUFpQkgsYUFBakIsRUFBZ0NJLE1BQWhDO0FBQ0F2QixJQUFBQSxTQUFTLENBQUNzQixNQUFWLENBQWlCRixlQUFqQixFQUFrQ0csTUFBbEM7QUFDQXZCLElBQUFBLFNBQVMsQ0FBQ3NCLE1BQVYsQ0FBaUJELGFBQWpCLEVBQWdDRSxNQUFoQztBQUNBO0FBQ0EsU0FBS0MsZ0JBQUwsR0FBd0JKLGVBQXhCO0FBQ0EsU0FBS0ssY0FBTCxHQUFzQkosYUFBdEI7QUFDQSxTQUFLSCxZQUFMLEdBQW9CQSxZQUFwQjtBQUNBLFNBQUtRLEdBQUwsR0FBV1AsYUFBWDtBQUNBLFNBQUtRLGlCQUFMLEdBQXlCLENBQUMsZUFBRCxDQUF6QjtBQUNIOztBQUVEQyxFQUFBQSxtQkFBbUIsQ0FBQ0MsT0FBRCxFQUFVO0FBQ3pCO0FBQ0EsVUFBTUMsZ0JBQWdCLEdBQUdQLE1BQU0sQ0FBQ1EsTUFBUCxDQUFjLEVBQWQsRUFBa0JGLE9BQWxCLENBQXpCO0FBQ0EsU0FBS0YsaUJBQUwsQ0FBdUJLLEdBQXZCLENBQTJCLFVBQVNDLFdBQVQsRUFBc0I7QUFDN0MsVUFBSUgsZ0JBQWdCLENBQUNHLFdBQUQsQ0FBcEIsRUFBbUM7QUFDL0JILFFBQUFBLGdCQUFnQixDQUFDRyxXQUFELENBQWhCLEdBQWdDLFNBQWhDO0FBQ0g7QUFDSixLQUpEO0FBS0EsV0FBT0gsZ0JBQVA7QUFDSDs7QUFFREksRUFBQUEsUUFBUSxDQUFDQyxLQUFELEVBQVFDLE9BQVIsRUFBaUI7QUFDckIsV0FBT2pDLENBQUMsQ0FBQ2tDLE9BQUYsQ0FBVSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDbENILE1BQUFBLE9BQU8sQ0FBQ2hDLEdBQVIsR0FBY2dDLE9BQU8sQ0FBQ2hDLEdBQVIsSUFBZSxLQUFLb0MsTUFBTCxDQUFZSixPQUFPLENBQUM3QixJQUFwQixDQUE3QjtBQUNBLGFBQU82QixPQUFPLENBQUM3QixJQUFmO0FBRUE2QixNQUFBQSxPQUFPLENBQUNQLE9BQVIsR0FBa0JPLE9BQU8sQ0FBQ1AsT0FBUixJQUFtQixFQUFyQzs7QUFDQSxVQUFJTSxLQUFKLEVBQVc7QUFDUEMsUUFBQUEsT0FBTyxDQUFDUCxPQUFSLENBQWdCLGVBQWhCLElBQW9DLFVBQVNNLEtBQU0sRUFBbkQ7QUFDQUMsUUFBQUEsT0FBTyxDQUFDUCxPQUFSLENBQWdCLGNBQWhCLElBQWtDLGtCQUFsQztBQUNIOztBQUNELFlBQU1ZLGFBQWEsR0FBRyxLQUFLaEIsY0FBTCxDQUFvQmlCLEdBQXBCLENBQXdCLGVBQXhCLENBQXRCOztBQUNBLFVBQUlELGFBQUosRUFBbUI7QUFDZixZQUFJRSxRQUFKO0FBQ0EsWUFBSUMsUUFBUSxHQUFHLEVBQWY7O0FBQ0EsWUFBSUgsYUFBYSxDQUFDSSxPQUFkLElBQXlCSixhQUFhLENBQUNLLElBQTNDLEVBQWlEO0FBQzdDSCxVQUFBQSxRQUFRLEdBQUksR0FBRUYsYUFBYSxDQUFDSSxPQUFRLElBQUdKLGFBQWEsQ0FBQ0ssSUFBSyxFQUExRCxDQUQ2QyxDQUU3Qzs7QUFDQSxjQUFJTCxhQUFhLENBQUNNLFFBQWQsSUFBMEJOLGFBQWEsQ0FBQ08sUUFBNUMsRUFBc0Q7QUFDbERKLFlBQUFBLFFBQVEsR0FBSSxHQUFFSCxhQUFhLENBQUNNLFFBQVMsSUFBR04sYUFBYSxDQUFDTyxRQUFTLEdBQS9EO0FBQ0g7O0FBQ0RaLFVBQUFBLE9BQU8sQ0FBQ2EsS0FBUixHQUFnQlIsYUFBYSxDQUFDUyxRQUFkLEdBQXlCTixRQUF6QixHQUFvQ0QsUUFBcEQ7QUFDSDtBQUNKOztBQUVELFdBQUtqQixHQUFMLENBQVN5QixJQUFULENBQWMsMkJBQWQsRUFBMkM7QUFDdkMvQyxRQUFBQSxHQUFHLEVBQUVnQyxPQUFPLENBQUNoQyxHQUQwQjtBQUV2Q2dELFFBQUFBLE1BQU0sRUFBRWhCLE9BQU8sQ0FBQ2dCLE1BRnVCO0FBR3ZDdkIsUUFBQUEsT0FBTyxFQUFFLEtBQUtELG1CQUFMLENBQXlCUSxPQUFPLENBQUNQLE9BQWpDLENBSDhCO0FBSXZDd0IsUUFBQUEsUUFBUSxFQUFFakIsT0FBTyxDQUFDaUIsUUFKcUI7QUFLdkNDLFFBQUFBLElBQUksRUFBRWxCLE9BQU8sQ0FBQ2tCO0FBTHlCLE9BQTNDLEVBdkJrQyxDQStCbEM7O0FBQ0FqRCxNQUFBQSxPQUFPLENBQUMrQixPQUFELEVBQVUsQ0FBQ21CLEtBQUQsRUFBUUMsUUFBUixFQUFrQkYsSUFBbEIsS0FBMkI7QUFDeEMsY0FBTUcsV0FBVyxHQUFHLEtBQUtDLG1CQUFMLENBQXlCdEIsT0FBekIsRUFBa0NtQixLQUFsQyxFQUF5Q0MsUUFBekMsRUFBbURGLElBQW5ELENBQXBCOztBQUNBLFlBQUlHLFdBQUosRUFBaUI7QUFDYixlQUFLRSxZQUFMLENBQWtCcEIsTUFBbEIsRUFBMEJrQixXQUExQjs7QUFDQSxlQUFLL0IsR0FBTCxDQUFTeUIsSUFBVCxDQUFjLGlDQUFkLEVBQWlETSxXQUFqRDtBQUNILFNBSEQsTUFHTztBQUNILGVBQUtHLHlCQUFMLENBQStCdEIsT0FBL0IsRUFBd0NrQixRQUF4QyxFQUFrREYsSUFBbEQ7O0FBQ0EsZUFBSzVCLEdBQUwsQ0FBU21DLEtBQVQsQ0FBZSxtQ0FBZixFQUFvREwsUUFBUSxDQUFDTSxXQUE3RDtBQUNIO0FBQ0osT0FUTSxDQUFQO0FBVUgsS0ExQ00sQ0FBUDtBQTJDSDs7QUFFREosRUFBQUEsbUJBQW1CLENBQUN0QixPQUFELEVBQVVtQixLQUFWLEVBQWlCQyxRQUFqQixFQUEyQkYsSUFBM0IsRUFBaUM7QUFDaEQ7QUFDQSxRQUFJQyxLQUFKLEVBQVc7QUFDUFEsTUFBQUEsT0FBTyxDQUFDckMsR0FBUixDQUFhLG9CQUFtQjZCLEtBQUssQ0FBQ1MsT0FBUSxFQUE5QztBQUNBLGFBQU8sSUFBSXZELFVBQUosQ0FBZThDLEtBQUssQ0FBQ1MsT0FBckIsRUFBOEJ4RCxVQUFVLENBQUN5RCxlQUF6QyxDQUFQO0FBQ0gsS0FIRCxNQUdPLElBQUlULFFBQVEsQ0FBQ1UsVUFBVCxJQUF1QixHQUEzQixFQUFnQztBQUNuQyxhQUFPLElBQUl6RCxVQUFKLENBQWUsZUFBZixFQUFnQ0QsVUFBVSxDQUFDMkQsWUFBM0MsQ0FBUDtBQUNILEtBRk0sTUFFQSxJQUFJWCxRQUFRLENBQUNVLFVBQVQsSUFBdUIsR0FBM0IsRUFBZ0M7QUFDbkMsYUFBTyxJQUFJekQsVUFBSixDQUFlLFdBQWYsRUFBNEJELFVBQVUsQ0FBQzRELFlBQXZDLENBQVA7QUFDSCxLQUZNLE1BRUEsSUFBSVosUUFBUSxDQUFDVSxVQUFULElBQXVCLEdBQTNCLEVBQWdDO0FBQ25DLGFBQU8sSUFBSXpELFVBQUosQ0FBZSxvQkFBZixFQUFxQ0QsVUFBVSxDQUFDNkQsZ0JBQWhELENBQVA7QUFDSCxLQUZNLE1BRUEsSUFBSWIsUUFBUSxDQUFDVSxVQUFULElBQXVCLEdBQTNCLEVBQWdDO0FBQ25DLGFBQU8sSUFBSXpELFVBQUosQ0FBZSxjQUFmLEVBQStCRCxVQUFVLENBQUM4RCxXQUExQyxDQUFQO0FBQ0gsS0FGTSxNQUVBLElBQUlkLFFBQVEsQ0FBQ1UsVUFBVCxJQUF1QixHQUEzQixFQUFnQztBQUNuQyxhQUFPLElBQUl6RCxVQUFKLENBQWUsY0FBZixFQUErQkQsVUFBVSxDQUFDK0QsV0FBMUMsQ0FBUDtBQUNIO0FBQ0o7O0FBRURYLEVBQUFBLHlCQUF5QixDQUFDdEIsT0FBRCxFQUFVa0IsUUFBVixFQUFvQkYsSUFBcEIsRUFBMEI7QUFDL0MsUUFBSWtCLGNBQUo7O0FBQ0EsUUFBSWhCLFFBQVEsQ0FBQzNCLE9BQVQsQ0FBaUIsY0FBakIsS0FBb0MyQixRQUFRLENBQUMzQixPQUFULENBQWlCLGNBQWpCLEVBQWlDNEMsT0FBakMsQ0FBeUMsTUFBekMsSUFBbUQsQ0FBQyxDQUE1RixFQUErRjtBQUMzRkQsTUFBQUEsY0FBYyxHQUFHRSxJQUFJLENBQUNDLEtBQUwsQ0FBV3JCLElBQVgsQ0FBakI7QUFDSCxLQUZELE1BRU87QUFDSGtCLE1BQUFBLGNBQWMsR0FBR2xCLElBQWpCLENBREcsQ0FFSDtBQUNBO0FBQ0E7O0FBQ0EsWUFBTXNCLFlBQVksR0FBRyxzQ0FBc0NDLElBQXRDLENBQTJDdkIsSUFBM0MsSUFDZkEsSUFBSSxDQUFDd0IsS0FBTCxDQUFXLDZCQUFYLEVBQTBDLENBQTFDLENBRGUsR0FFZixJQUZOO0FBR0EsVUFBSUYsWUFBSixFQUFrQkosY0FBYyxHQUFHSSxZQUFqQjtBQUNyQjs7QUFDRHRDLElBQUFBLE9BQU8sQ0FBQ2tDLGNBQUQsQ0FBUDtBQUNBLFNBQUtPLElBQUwsQ0FBVSxvQkFBVixFQUFnQ1AsY0FBaEM7QUFDSDs7QUFFRGIsRUFBQUEsWUFBWSxDQUFDcEIsTUFBRCxFQUFTZ0IsS0FBVCxFQUFnQjtBQUN4QixTQUFLd0IsSUFBTCxDQUFVLE9BQVYsRUFBbUJ4QixLQUFuQjtBQUNBaEIsSUFBQUEsTUFBTSxDQUFDZ0IsS0FBRCxDQUFOO0FBQ0g7O0FBRURmLEVBQUFBLE1BQU0sQ0FBQ2pDLElBQUQsRUFBTztBQUNUO0FBQ0E7QUFDQSxRQUFJQSxJQUFKLEVBQVU7QUFDTixZQUFNeUUsU0FBUyxHQUFHLGNBQWNILElBQWQsQ0FBbUJ0RSxJQUFuQixJQUNaLEtBQUtXLFlBQUwsQ0FBa0IsUUFBbEIsRUFBNEIsVUFBNUIsQ0FEWSxHQUVaLEtBQUtBLFlBQUwsQ0FBa0IsUUFBbEIsRUFBNEIsU0FBNUIsQ0FGTjtBQUdBLGFBQU9kLEdBQUcsQ0FBQ2tDLE9BQUosQ0FBWTBDLFNBQVosRUFBdUJ6RSxJQUF2QixDQUFQO0FBQ0g7O0FBQ0QsV0FBTzBFLFNBQVA7QUFDSDtBQUVEO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0lDLEVBQUFBLFlBQVksQ0FBQ25DLFFBQUQsRUFBV0MsUUFBWCxFQUFxQjtBQUM3QixXQUFPLEtBQUtkLFFBQUwsQ0FBYyxJQUFkLEVBQW9CO0FBQ3ZCa0IsTUFBQUEsTUFBTSxFQUFFLE1BRGU7QUFFdkI3QyxNQUFBQSxJQUFJLEVBQUcsMEJBRmdCO0FBR3ZCNEUsTUFBQUEsSUFBSSxFQUFFO0FBQ0ZDLFFBQUFBLFVBQVUsRUFBRSxVQURWO0FBRUZ6RSxRQUFBQSxTQUZFO0FBR0ZDLFFBQUFBLGFBSEU7QUFJRm1DLFFBQUFBLFFBSkU7QUFLRkMsUUFBQUE7QUFMRTtBQUhpQixLQUFwQixDQUFQO0FBV0g7QUFFRDtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQUNJcUMsRUFBQUEsTUFBTSxDQUFDbEQsS0FBRCxFQUFRO0FBQ1YsV0FBTyxLQUFLRCxRQUFMLENBQWNDLEtBQWQsRUFBcUI7QUFBRWlCLE1BQUFBLE1BQU0sRUFBRSxRQUFWO0FBQW9CN0MsTUFBQUEsSUFBSSxFQUFHO0FBQTNCLEtBQXJCLENBQVA7QUFDSDs7QUFFRCtFLEVBQUFBLE9BQU8sQ0FBQ25ELEtBQUQsRUFBUTtBQUNYLFdBQU8sS0FBS0QsUUFBTCxDQUFjQyxLQUFkLEVBQXFCO0FBQUU1QixNQUFBQSxJQUFJLEVBQUc7QUFBVCxLQUFyQixDQUFQO0FBQ0g7O0FBRURnRixFQUFBQSxTQUFTLENBQUNwRCxLQUFELEVBQVEvQixHQUFSLEVBQWE7QUFDbEI7QUFDUjtBQUNBO0FBQ0E7QUFDQTtBQUNRLFFBQUlvRixNQUFKLEVBQVlDLEdBQVo7O0FBQ0EsUUFBSTtBQUNBRCxNQUFBQSxNQUFNLEdBQUd6RixPQUFPLENBQUMsVUFBRCxDQUFQLENBQW9CeUYsTUFBN0I7QUFDQUMsTUFBQUEsR0FBRyxHQUFHRCxNQUFNLENBQUNDLEdBQWI7QUFDSCxLQUhELENBR0UsT0FBT0MsR0FBUCxFQUFZO0FBQ1Y7QUFDQTtBQUNBLFVBQUk7QUFDQUQsUUFBQUEsR0FBRyxHQUFHMUYsT0FBTyxDQUFDLFVBQUQsQ0FBUCxDQUFvQjBGLEdBQTFCO0FBQ0gsT0FGRCxDQUVFLE9BQU9DLEdBQVAsRUFBWSxDQUNWO0FBQ0g7QUFDSjs7QUFDRCxVQUFNQyxZQUFZLEdBQUdGLEdBQUcsR0FBR0EsR0FBRyxDQUFDRyxPQUFKLENBQVksVUFBWixDQUFILEdBQTZCLEVBQXJEO0FBRUEsVUFBTUMsVUFBVSxHQUFHdEYsSUFBSSxDQUFDK0IsT0FBTCxDQUFhcUQsWUFBYixFQUEyQixZQUEzQixDQUFuQjtBQUNBLFdBQU94RixDQUFDLENBQUNrQyxPQUFGLENBQVUsQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQ2xDLFlBQU11RCxnQkFBZ0IsR0FBR3hGLEVBQUUsQ0FBQ3lGLGlCQUFILENBQXFCRixVQUFyQixDQUF6QjtBQUNBQyxNQUFBQSxnQkFBZ0IsQ0FBQ0UsRUFBakIsQ0FBb0IsUUFBcEIsRUFBOEIsWUFBVztBQUNyQzFELFFBQUFBLE9BQU8sQ0FBQ3VELFVBQUQsQ0FBUDtBQUNILE9BRkQ7QUFHQXhGLE1BQUFBLE9BQU8sQ0FDRnFDLEdBREwsQ0FDU3RDLEdBRFQsRUFFSzRGLEVBRkwsQ0FFUSxPQUZSLEVBRWlCTixHQUFHLElBQUksS0FBSy9CLFlBQUwsQ0FBa0JwQixNQUFsQixFQUEwQm1ELEdBQTFCLENBRnhCLEVBR0tPLElBSEwsQ0FHVUgsZ0JBSFYsRUFJS0UsRUFKTCxDQUlRLE9BSlIsRUFJaUJOLEdBQUcsSUFBSSxLQUFLL0IsWUFBTCxDQUFrQnBCLE1BQWxCLEVBQTBCbUQsR0FBMUIsQ0FKeEI7QUFLSCxLQVZNLENBQVA7QUFXSDs7QUFFRFEsRUFBQUEsNEJBQTRCLENBQUMvRCxLQUFELEVBQVE7QUFDaEMsVUFBTUMsT0FBTyxHQUFHO0FBQUVoQyxNQUFBQSxHQUFHLEVBQUcsR0FBRVcsWUFBYTtBQUF2QixLQUFoQjtBQUNBLFdBQU8sS0FBS21CLFFBQUwsQ0FBY0MsS0FBZCxFQUFxQkMsT0FBckIsQ0FBUDtBQUNIOztBQUVEK0QsRUFBQUEsV0FBVyxHQUFHO0FBQ1YsV0FBT3hGLFNBQVA7QUFDSDs7QUFFRHlGLEVBQUFBLGNBQWMsR0FBRztBQUNiLFdBQU92RixXQUFQO0FBQ0g7O0FBRUR3RixFQUFBQSxlQUFlLEdBQUc7QUFDZCxXQUFPdkYsWUFBUDtBQUNIOztBQXBOMkM7O0FBc05oRHdGLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnZGLG9CQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbmNvbnN0IEVhZ2xlID0gcmVxdWlyZSgnZWFnbGUtcHJpbnQnKTtcclxuY29uc3QgVHlwZUNoZWNrID0gRWFnbGUudXRpbC5UeXBlQ2hlY2s7XHJcbmNvbnN0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50ZW1pdHRlcjMnKTtcclxuY29uc3QgcSA9IHJlcXVpcmUoJ3EnKTtcclxuY29uc3QgdXJsID0gcmVxdWlyZSgndXJsJyk7XHJcbmNvbnN0IHJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0Jyk7XHJcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuXHJcbmNvbnN0IHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTtcclxuY29uc3QgRXJyb3JzRW51bSA9IHJlcXVpcmUoJy4vdGhpbmdpdmVyc2UtYXBpLWVycm9ycycpLkVycm9yc0VudW07XHJcbmNvbnN0IFRWQXBpRXJyb3IgPSByZXF1aXJlKCcuL3RoaW5naXZlcnNlLWFwaS1lcnJvcnMnKS5UaGluZ2l2ZXJzZUFwaUVycm9yO1xyXG5cclxuY29uc3QgY2xpZW50X2lkID0gJzIzYzVlYWJlN2E1NjZkM2E1M2MwJztcclxuY29uc3QgY2xpZW50X3NlY3JldCA9ICdjMzBmNTMyYmNjNjdiYjY1ZDM0NzZkYWVkYzBlNjBmNCc7XHJcblxyXG5jb25zdCByZWRpcmVjdFVyaSA9ICdtYWtlcmJvdHByaW50Oi8vY2FsbGJhY2snO1xyXG5jb25zdCBiYXNlT2F1dGhVcmwgPSAnaHR0cHM6Ly9sb2dpbi5tYWtlcmJvdC5jb20nO1xyXG5cclxuLy8gVE9ETzogTW92ZSB0aGlzIG91dCB0byBkZWZhdWx0LWNvbmZpZyB0byBzdXBwb3J0IHN0YWdpbmcgVVJMIGluIHRoZSBmdXR1cmVcclxuY29uc3QgcmVmbGVjdG9yVXJsID0gJ2h0dHBzOi8vcmVmbGVjdG9yLm1ha2VyYm90LmNvbSc7XHJcblxyXG5jbGFzcyBUaGluZ2l2ZXJzZUFwaUNsaWVudCBleHRlbmRzIEV2ZW50RW1pdHRlciB7XHJcbiAgICAvKipcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzZXJ2ZXJDb25maWdcclxuICAgICAqIEBwYXJhbSB7TG9nZ2luZ1NlcnZpY2V9IGxvZ2dlclNlcnZpY2VcclxuICAgICAqL1xyXG4gICAgY29uc3RydWN0b3Ioc2VydmVyQ29uZmlnLCBsb2dnZXJTZXJ2aWNlLCB0cmFja2luZ1NlcnZpY2UsIGNvbmZpZ1NlcnZpY2UpIHtcclxuICAgICAgICBUeXBlQ2hlY2suaXNUeXBlKHNlcnZlckNvbmZpZywgT2JqZWN0KTtcclxuICAgICAgICBUeXBlQ2hlY2suaXNUeXBlKGxvZ2dlclNlcnZpY2UsIE9iamVjdCk7XHJcbiAgICAgICAgVHlwZUNoZWNrLmlzVHlwZSh0cmFja2luZ1NlcnZpY2UsIE9iamVjdCk7XHJcbiAgICAgICAgVHlwZUNoZWNrLmlzVHlwZShjb25maWdTZXJ2aWNlLCBPYmplY3QpO1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdGhpcy5fdHJhY2tpbmdTZXJ2aWNlID0gdHJhY2tpbmdTZXJ2aWNlO1xyXG4gICAgICAgIHRoaXMuX2NvbmZpZ1NlcnZpY2UgPSBjb25maWdTZXJ2aWNlO1xyXG4gICAgICAgIHRoaXMuc2VydmVyQ29uZmlnID0gc2VydmVyQ29uZmlnO1xyXG4gICAgICAgIHRoaXMubG9nID0gbG9nZ2VyU2VydmljZTtcclxuICAgICAgICB0aGlzLnN1cHByZXNzZWRIZWFkZXJzID0gWydBdXRob3JpemF0aW9uJ107XHJcbiAgICB9XHJcblxyXG4gICAgX3Nhbml0aXplRm9yTG9nZ2luZyhoZWFkZXJzKSB7XHJcbiAgICAgICAgLy9TdXBwcmVzc2VkIGhlYWRlcnMgd2lsbCBiZSByZXBsYWNlZCB3aXRoICdvbWl0dGVkJyBpbiBkZWJ1ZyBsb2dzXHJcbiAgICAgICAgY29uc3Qgc2FuaXRpemVkSGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe30sIGhlYWRlcnMpO1xyXG4gICAgICAgIHRoaXMuc3VwcHJlc3NlZEhlYWRlcnMubWFwKGZ1bmN0aW9uKGhlYWRlckZpZWxkKSB7XHJcbiAgICAgICAgICAgIGlmIChzYW5pdGl6ZWRIZWFkZXJzW2hlYWRlckZpZWxkXSkge1xyXG4gICAgICAgICAgICAgICAgc2FuaXRpemVkSGVhZGVyc1toZWFkZXJGaWVsZF0gPSAnb21pdHRlZCc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gc2FuaXRpemVkSGVhZGVycztcclxuICAgIH1cclxuXHJcbiAgICBfcmVxdWVzdCh0b2tlbiwgb3B0aW9ucykge1xyXG4gICAgICAgIHJldHVybiBxLlByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBvcHRpb25zLnVybCA9IG9wdGlvbnMudXJsIHx8IHRoaXMuZ2V0VXJsKG9wdGlvbnMucGF0aCk7XHJcbiAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLnBhdGg7XHJcblxyXG4gICAgICAgICAgICBvcHRpb25zLmhlYWRlcnMgPSBvcHRpb25zLmhlYWRlcnMgfHwge307XHJcbiAgICAgICAgICAgIGlmICh0b2tlbikge1xyXG4gICAgICAgICAgICAgICAgb3B0aW9ucy5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPSBgQmVhcmVyICR7dG9rZW59YDtcclxuICAgICAgICAgICAgICAgIG9wdGlvbnMuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSAnYXBwbGljYXRpb24vanNvbic7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgcHJveHlTZXR0aW5ncyA9IHRoaXMuX2NvbmZpZ1NlcnZpY2UuZ2V0KCdwcm94eVNldHRpbmdzJyk7XHJcbiAgICAgICAgICAgIGlmIChwcm94eVNldHRpbmdzKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgaG9zdEluZm87XHJcbiAgICAgICAgICAgICAgICBsZXQgdXNlckluZm8gPSAnJztcclxuICAgICAgICAgICAgICAgIGlmIChwcm94eVNldHRpbmdzLmFkZHJlc3MgJiYgcHJveHlTZXR0aW5ncy5wb3J0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaG9zdEluZm8gPSBgJHtwcm94eVNldHRpbmdzLmFkZHJlc3N9OiR7cHJveHlTZXR0aW5ncy5wb3J0fWA7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gVXNlcm5hbWUgYW5kIFBhc3N3b3JkIGNhbiBiZSBvcHRpb25hbCFcclxuICAgICAgICAgICAgICAgICAgICBpZiAocHJveHlTZXR0aW5ncy51c2VybmFtZSAmJiBwcm94eVNldHRpbmdzLnBhc3N3b3JkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJJbmZvID0gYCR7cHJveHlTZXR0aW5ncy51c2VybmFtZX06JHtwcm94eVNldHRpbmdzLnBhc3N3b3JkfUBgO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnByb3h5ID0gcHJveHlTZXR0aW5ncy5wcm90b2NvbCArIHVzZXJJbmZvICsgaG9zdEluZm87XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMubG9nLmluZm8oJ1RoaW5naXZlcnNlIEFwaSByZXF1ZXN0OiAnLCB7XHJcbiAgICAgICAgICAgICAgICB1cmw6IG9wdGlvbnMudXJsLFxyXG4gICAgICAgICAgICAgICAgbWV0aG9kOiBvcHRpb25zLm1ldGhvZCxcclxuICAgICAgICAgICAgICAgIGhlYWRlcnM6IHRoaXMuX3Nhbml0aXplRm9yTG9nZ2luZyhvcHRpb25zLmhlYWRlcnMpLFxyXG4gICAgICAgICAgICAgICAgZW5jb2Rpbmc6IG9wdGlvbnMuZW5jb2RpbmcsXHJcbiAgICAgICAgICAgICAgICBib2R5OiBvcHRpb25zLmJvZHksXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gY2xhcml0eSBmb3IgZnV0dXJlIHNlbHZlcyAtPiB0aGlzIGlzIHVzaW5nIHRoZSBpbXBvcnRlZCAncmVxdWVzdCcgbGlicmFyeSBoZXJlIGluc2lkZSBfcmVxdWVzdCgpXHJcbiAgICAgICAgICAgIHJlcXVlc3Qob3B0aW9ucywgKGVycm9yLCByZXNwb25zZSwgYm9keSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcGFyc2VkRXJyb3IgPSB0aGlzLl9wYXJzZUVycm9yUmVzcG9uc2Uob3B0aW9ucywgZXJyb3IsIHJlc3BvbnNlLCBib2R5KTtcclxuICAgICAgICAgICAgICAgIGlmIChwYXJzZWRFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhbmRsZUVycm9yKHJlamVjdCwgcGFyc2VkRXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmluZm8oJ1RoaW5naXZlcnNlIEFwaSByZXF1ZXN0IGVycm9yOiAnLCBwYXJzZWRFcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhbmRsZVN1Y2Nlc3NmdWxSZXNwb25zZShyZXNvbHZlLCByZXNwb25zZSwgYm9keSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoJ1RoaW5naXZlcnNlIEFwaSByZXF1ZXN0IHN1Y2Nlc3M6ICcsIHJlc3BvbnNlLnN0YXR1c19jb2RlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgX3BhcnNlRXJyb3JSZXNwb25zZShvcHRpb25zLCBlcnJvciwgcmVzcG9uc2UsIGJvZHkpIHtcclxuICAgICAgICAvLyBhZGQgbW9yZSBlcnJvciBjb2RlcyBpZiB3ZSBrbm93IG9mIHRoZW1cclxuICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coYENvbm5lY3Rpb24gRXJyb3IgJHtlcnJvci5tZXNzYWdlfWApO1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFRWQXBpRXJyb3IoZXJyb3IubWVzc2FnZSwgRXJyb3JzRW51bS5Db25uZWN0aW9uRXJyb3IpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PSA0MDMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBUVkFwaUVycm9yKCdBY2Nlc3MgRGVuaWVkJywgRXJyb3JzRW51bS5BY2Nlc3NEZW5pZWQpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PSA0MDQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBUVkFwaUVycm9yKCdOb3QgRm91bmQnLCBFcnJvcnNFbnVtLkZpbGVOb3RGb3VuZCk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09IDQwNSkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFRWQXBpRXJyb3IoJ01ldGhvZCBOb3QgQWxsb3dlZCcsIEVycm9yc0VudW0uTWV0aG9kTm90QWxsb3dlZCk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID49IDUwMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFRWQXBpRXJyb3IoJ1NlcnZlciBFcnJvcicsIEVycm9yc0VudW0uU2VydmVyRXJyb3IpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA+PSA0MDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBUVkFwaUVycm9yKCdDbGllbnQgRXJyb3InLCBFcnJvcnNFbnVtLkNsaWVudEVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgX2hhbmRsZVN1Y2Nlc3NmdWxSZXNwb25zZShyZXNvbHZlLCByZXNwb25zZSwgYm9keSkge1xyXG4gICAgICAgIGxldCBwYXJzZWRSZXNwb25zZTtcclxuICAgICAgICBpZiAocmVzcG9uc2UuaGVhZGVyc1snY29udGVudC10eXBlJ10gJiYgcmVzcG9uc2UuaGVhZGVyc1snY29udGVudC10eXBlJ10uaW5kZXhPZignanNvbicpID4gLTEpIHtcclxuICAgICAgICAgICAgcGFyc2VkUmVzcG9uc2UgPSBKU09OLnBhcnNlKGJvZHkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHBhcnNlZFJlc3BvbnNlID0gYm9keTtcclxuICAgICAgICAgICAgLy8gaWYgdGhlIHJlc3BvbnNlIGlzIHVybC1lbmNvZGVkLCBhY2Nlc3NfdG9rZW4gaXMgc2VudCBpbiB0aGUgYm9keVxyXG4gICAgICAgICAgICAvLyBhbmQgaXMgb2YgdGhlIGZvcm1hdCBeYWNjZXNzX3Rva2VuPTx0b2tlbj4mdG9rZW5fdHlwZT1CZWFyZXIuXHJcbiAgICAgICAgICAgIC8vIHRva2VuIHdpbGwgbmVlZCB0byBiZSBleHRyYWN0ZWQgb3V0IG9mIHRoYXRcclxuICAgICAgICAgICAgY29uc3QgYWNjZXNzX3Rva2VuID0gL15hY2Nlc3NfdG9rZW49LiomdG9rZW5fdHlwZT1CZWFyZXIkLy50ZXN0KGJvZHkpXHJcbiAgICAgICAgICAgICAgICA/IGJvZHkubWF0Y2goL15hY2Nlc3NfdG9rZW5cXD0oW1xcU1xcc10qPylcXCYvKVsxXVxyXG4gICAgICAgICAgICAgICAgOiBudWxsO1xyXG4gICAgICAgICAgICBpZiAoYWNjZXNzX3Rva2VuKSBwYXJzZWRSZXNwb25zZSA9IGFjY2Vzc190b2tlbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVzb2x2ZShwYXJzZWRSZXNwb25zZSk7XHJcbiAgICAgICAgdGhpcy5lbWl0KCdzdWNjZXNzZnVsUmVzcG9uc2UnLCBwYXJzZWRSZXNwb25zZSk7XHJcbiAgICB9XHJcblxyXG4gICAgX2hhbmRsZUVycm9yKHJlamVjdCwgZXJyb3IpIHtcclxuICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyb3IpO1xyXG4gICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VXJsKHBhdGgpIHtcclxuICAgICAgICAvLyBmb3IgYXV0aCAobG9naW4pLCB3ZSB1c2VyIHRoZSBhdXRoIHVybFxyXG4gICAgICAgIC8vIGFmdGVyIHN1Y2Nlc3NmdWwgYXV0aCwgZnVydGhlciBhcGkgY2FsbHMgYXJlIHdpdGggdGhlIGFwaSB1cmxcclxuICAgICAgICBpZiAocGF0aCkge1xyXG4gICAgICAgICAgICBjb25zdCBzZXJ2ZXJVcmwgPSAvXFwuKmxvZ2luXFwuKi8udGVzdChwYXRoKVxyXG4gICAgICAgICAgICAgICAgPyB0aGlzLnNlcnZlckNvbmZpZ1snc2VydmVyJ11bJ2F1dGhfdXJsJ11cclxuICAgICAgICAgICAgICAgIDogdGhpcy5zZXJ2ZXJDb25maWdbJ3NlcnZlciddWydhcGlfdXJsJ107XHJcbiAgICAgICAgICAgIHJldHVybiB1cmwucmVzb2x2ZShzZXJ2ZXJVcmwsIHBhdGgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQXV0aGVudGljYXRlIHVzZXIgb24gc2VydmVyIGFuZCByZXR1cm4gdG9rZW4gdG8gYmUgdXNlZCBpbiBvdGhlciByZXF1ZXN0cy5cclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1c2VybmFtZVxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHBhc3N3b3JkXHJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gcmVzb2x2ZXMgdG8ge3N0cmluZ30gdG9rZW4gb3Igb25lIG9mIGVycm9yc1xyXG4gICAgICovXHJcbiAgICBhdXRoZW50aWNhdGUodXNlcm5hbWUsIHBhc3N3b3JkKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3JlcXVlc3QobnVsbCwge1xyXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcclxuICAgICAgICAgICAgcGF0aDogYGxvZ2luL29hdXRoL2FjY2Vzc190b2tlbmAsXHJcbiAgICAgICAgICAgIGZvcm06IHtcclxuICAgICAgICAgICAgICAgIGdyYW50X3R5cGU6ICdwYXNzd29yZCcsXHJcbiAgICAgICAgICAgICAgICBjbGllbnRfaWQsXHJcbiAgICAgICAgICAgICAgICBjbGllbnRfc2VjcmV0LFxyXG4gICAgICAgICAgICAgICAgdXNlcm5hbWUsXHJcbiAgICAgICAgICAgICAgICBwYXNzd29yZCxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEludmFsaWRhdGUgdG9rZW4gb24gc2VydmVyLiBOQjogdGhpcyBtZXRob2Qgd2lsbCBmYWlsIGlmIHRva2VuIGlzIGludmFsaWQsXHJcbiAgICAgKiBzbyB5b3UgbWlnaHQgbmVlZCB0byBpZ25vcmUgaXRzIHJlc3VsdCBpZiB5b3UganVzdCBuZWVkIHRvIGxvZyB1c2VyIG91dC5cclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0b2tlblxyXG4gICAgICogQHJldHVybnMge1Byb21pc2V9XHJcbiAgICAgKi9cclxuICAgIGxvZ291dCh0b2tlbikge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9yZXF1ZXN0KHRva2VuLCB7IG1ldGhvZDogJ0RFTEVURScsIHBhdGg6IGBzZXNzaW9uc2AgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VXNlcih0b2tlbikge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9yZXF1ZXN0KHRva2VuLCB7IHBhdGg6IGB1c2Vycy9tZWAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QXZhdGFyKHRva2VuLCB1cmwpIHtcclxuICAgICAgICAvKiBJZGVhbGx5LCBJIHNob3VsZCBoYXZlIHVzZWQgdGhlIHJlcXVlc3QgY2FsbCB3ZSBoYXZlIGZvciBhbGwgdGhlIGFwaSByZXF1ZXN0c1xyXG4gICAgICAgICAgIGJ1dCwgaXQgZG9lc24ndCB3b3JrIHdpdGggdGhlIGN1cnJlbnQgd2F5IHJlcXVlc3QgaXMgc2V0dXAuXHJcbiAgICAgICAgICAgQ2FuJ3QgaGF2ZSBhIGNhbGxiYWNrIGFzIHdlbGwgYXMgcGlwZSB0byBzdHJlYW0uLi5iZXNpZGVzLCBJJ20gbm90IHN1cmVcclxuICAgICAgICAgICBJIHdhbnQgdGhlIHJlc3BvbnNlIGFsd2F5cyBwaXBlZCB0byBhIGZpbGUuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgbGV0IHJlbW90ZSwgYXBwO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHJlbW90ZSA9IHJlcXVpcmUoJ2VsZWN0cm9uJykucmVtb3RlO1xyXG4gICAgICAgICAgICBhcHAgPSByZW1vdGUuYXBwO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAvLyBpZiB0aGlzIGlzIGJlaW5nIHJ1biBmcm9tIHRoZSBtYWluIHByb2Nlc3MsIHRoZW4gJ3JlbW90ZScgZG9lc24ndCBleGlzdCBhbmQgd2lsbCB0aHJvdyBhbiBlcnJvclxyXG4gICAgICAgICAgICAvLyBpbiB0aGF0IGNhc2UsIHNpbXBseSByZXF1aXJlIGFwcFxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgYXBwID0gcmVxdWlyZSgnZWxlY3Ryb24nKS5hcHA7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgLy8gdGhpcyBjYW4gaGFwcGVuIGlmIHJ1bm5pbmcgaW4gdW5pdCB0ZXN0IGVudmlyb25tZW50XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgdXNlckRhdGFQYXRoID0gYXBwID8gYXBwLmdldFBhdGgoJ3VzZXJEYXRhJykgOiAnJztcclxuXHJcbiAgICAgICAgY29uc3QgYXZhdGFyRmlsZSA9IHBhdGgucmVzb2x2ZSh1c2VyRGF0YVBhdGgsICdhdmF0YXIuanBnJyk7XHJcbiAgICAgICAgcmV0dXJuIHEuUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGF2YXRhckZpbGVTdHJlYW0gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShhdmF0YXJGaWxlKTtcclxuICAgICAgICAgICAgYXZhdGFyRmlsZVN0cmVhbS5vbignZmluaXNoJywgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKGF2YXRhckZpbGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmVxdWVzdFxyXG4gICAgICAgICAgICAgICAgLmdldCh1cmwpXHJcbiAgICAgICAgICAgICAgICAub24oJ2Vycm9yJywgZXJyID0+IHRoaXMuX2hhbmRsZUVycm9yKHJlamVjdCwgZXJyKSlcclxuICAgICAgICAgICAgICAgIC5waXBlKGF2YXRhckZpbGVTdHJlYW0pXHJcbiAgICAgICAgICAgICAgICAub24oJ2Vycm9yJywgZXJyID0+IHRoaXMuX2hhbmRsZUVycm9yKHJlamVjdCwgZXJyKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VXNlclByaW50ZXJzRnJvbVJlZmxlY3Rvcih0b2tlbikge1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7IHVybDogYCR7cmVmbGVjdG9yVXJsfS9wcmludGVyc2AgfTtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcmVxdWVzdCh0b2tlbiwgb3B0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Q2xpZW50SWQoKSB7XHJcbiAgICAgICAgcmV0dXJuIGNsaWVudF9pZDtcclxuICAgIH1cclxuXHJcbiAgICBnZXRSZWRpcmVjdFVyaSgpIHtcclxuICAgICAgICByZXR1cm4gcmVkaXJlY3RVcmk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QmFzZU9hdXRoVXJsKCkge1xyXG4gICAgICAgIHJldHVybiBiYXNlT2F1dGhVcmw7XHJcbiAgICB9XHJcbn1cclxubW9kdWxlLmV4cG9ydHMgPSBUaGluZ2l2ZXJzZUFwaUNsaWVudDtcclxuIl19
