'use strict';

const R = require('ramda');

const tmp = require('tmp');

const q = require('q');

const fs = require('fs-extra');

const {
  getPrinter
} = require('../utils/printerDetails');

const {
  Actions
} = require('../constants/copyBotLogs');

const {
  getI18n,
  safeKey
} = require('../util');

const zipFilename = 'bot_logs.zip';

const defaultSavePath = printerId => `~/Documents/MakerbotLogs_${safeKey(printerId)}.zip`; // prevent calling zipLogs multiple times in a row


let debounce = [];
module.exports = Object.freeze({
  copyLogs(printerId) {
    const invoke = _invoke(this.flux, printerId);

    if (debounce.includes(printerId)) return;
    debounce = R.concat(printerId);
    this.dispatch(Actions.CopyStart, {
      printerId
    });
    return zipLogs(invoke, zipFilename).then(zipPath => {
      getLogs(invoke, zipPath).then(tmpPath => this.dispatch(Actions.CopySuccess, {
        printerId,
        tmpPath
      })).catch(err => this.dispatch(Actions.CopyFail, {
        printerId,
        err
      })).done();
    }).catch(err => this.dispatch(Actions.CopyFail, {
      printerId,
      err
    })).finally(() => debounce = R.without([printerId], debounce)).done();
  },

  sendToSupport(printerId) {
    const i18n = getI18n(this.flux);
    const tmpPath = getTmpPath(this.flux, printerId);
    const SupportPlugin = this.flux.getPlugin('Support');
    const ModalService = this.flux.getService('ModalService');
    if (!fs.existsSync(tmpPath)) return q().then(() => this.dispatch(Actions.NoFile, {
      printerId
    }));
    const supportModal = SupportPlugin.getModal(this.flux, {
      onMount: component => {
        if (component) filePathToObj(this.flux, tmpPath).then(component.manualAddFile).done();
      }
    }, () => this.dispatch(Actions.SendToSupportSuccess, {
      printerId
    }), err => this.dispatch(Actions.SendToSupportFail, {
      printerId,
      err
    }));
    ModalService.show(supportModal, {
      title: i18n.t('mb:copyBotLogs.send')
    });
  },

  saveLogs(printerId) {
    // have to do it this way because mb-plugin doesn't have electron
    // initalized, so requiring it at the top of the file, like a
    // normal person causes the tests to break
    const {
      dialog
    } = require('electron').remote;

    const i18n = getI18n(this.flux);
    const tmpPath = getTmpPath(this.flux, printerId);

    const dispatch = () => this.dispatch(Actions.Save, {
      printerId
    });

    if (!fs.existsSync(tmpPath)) {
      this.dispatch(Actions.NoFile, {
        printerId,
        tmpPath
      });
    } else {
      dialog.showSaveDialog({
        title: i18n.t('mb:copyBotLogs.save'),
        defaultPath: defaultSavePath(printerId)
      }, saveFile(dispatch, tmpPath));
    }
  },

  timeout(printerId, err) {
    this.dispatch(Actions.Timeout, {
      printerId,
      err
    });
  }

});

const getTmpPath = (flux, printerId) => flux.store('CopyBotLogs').getTmpPath(printerId);

const _invoke = R.curry((flux, printerId, method, params) => getPrinter(flux, printerId).invoke(method, params));

const zipLogs = R.curry((invoke, zipPath) => invoke('ZipLogs', [`/home/${zipPath}`]).then(() => zipPath));
const getLogs = R.curry((invoke, zipPath) => {
  const tmpPath = tmp.tmpNameSync({
    postfix: '.zip'
  });
  return invoke('Get', [zipPath, tmpPath]).then(() => {
    return tmpPath;
  });
});
const saveFile = R.curry((dispatch, tmpPath, path) => tmpPath && path ? fs.copy(tmpPath, path, {}, dispatch) : undefined);

const filePathToObj = (flux, filePath) => flux.getService('FileService').getFileStats(filePath).then(stats => ({
  filePath,
  size: stats['size'],
  error: null
}));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcHlCb3RMb2dzLmpzIl0sIm5hbWVzIjpbIlIiLCJyZXF1aXJlIiwidG1wIiwicSIsImZzIiwiZ2V0UHJpbnRlciIsIkFjdGlvbnMiLCJnZXRJMThuIiwic2FmZUtleSIsInppcEZpbGVuYW1lIiwiZGVmYXVsdFNhdmVQYXRoIiwicHJpbnRlcklkIiwiZGVib3VuY2UiLCJtb2R1bGUiLCJleHBvcnRzIiwiT2JqZWN0IiwiZnJlZXplIiwiY29weUxvZ3MiLCJpbnZva2UiLCJfaW52b2tlIiwiZmx1eCIsImluY2x1ZGVzIiwiY29uY2F0IiwiZGlzcGF0Y2giLCJDb3B5U3RhcnQiLCJ6aXBMb2dzIiwidGhlbiIsInppcFBhdGgiLCJnZXRMb2dzIiwidG1wUGF0aCIsIkNvcHlTdWNjZXNzIiwiY2F0Y2giLCJlcnIiLCJDb3B5RmFpbCIsImRvbmUiLCJmaW5hbGx5Iiwid2l0aG91dCIsInNlbmRUb1N1cHBvcnQiLCJpMThuIiwiZ2V0VG1wUGF0aCIsIlN1cHBvcnRQbHVnaW4iLCJnZXRQbHVnaW4iLCJNb2RhbFNlcnZpY2UiLCJnZXRTZXJ2aWNlIiwiZXhpc3RzU3luYyIsIk5vRmlsZSIsInN1cHBvcnRNb2RhbCIsImdldE1vZGFsIiwib25Nb3VudCIsImNvbXBvbmVudCIsImZpbGVQYXRoVG9PYmoiLCJtYW51YWxBZGRGaWxlIiwiU2VuZFRvU3VwcG9ydFN1Y2Nlc3MiLCJTZW5kVG9TdXBwb3J0RmFpbCIsInNob3ciLCJ0aXRsZSIsInQiLCJzYXZlTG9ncyIsImRpYWxvZyIsInJlbW90ZSIsIlNhdmUiLCJzaG93U2F2ZURpYWxvZyIsImRlZmF1bHRQYXRoIiwic2F2ZUZpbGUiLCJ0aW1lb3V0IiwiVGltZW91dCIsInN0b3JlIiwiY3VycnkiLCJtZXRob2QiLCJwYXJhbXMiLCJ0bXBOYW1lU3luYyIsInBvc3RmaXgiLCJwYXRoIiwiY29weSIsInVuZGVmaW5lZCIsImZpbGVQYXRoIiwiZ2V0RmlsZVN0YXRzIiwic3RhdHMiLCJzaXplIiwiZXJyb3IiXSwibWFw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QURKIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgUiA9IHJlcXVpcmUoJ3JhbWRhJyk7XHJcbmNvbnN0IHRtcCA9IHJlcXVpcmUoJ3RtcCcpO1xyXG5jb25zdCBxID0gcmVxdWlyZSgncScpO1xyXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XHJcblxyXG5jb25zdCB7IGdldFByaW50ZXIgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL3ByaW50ZXJEZXRhaWxzJyk7XHJcbmNvbnN0IHsgQWN0aW9ucyB9ID0gcmVxdWlyZSgnLi4vY29uc3RhbnRzL2NvcHlCb3RMb2dzJyk7XHJcbmNvbnN0IHsgZ2V0STE4biwgc2FmZUtleSB9ID0gcmVxdWlyZSgnLi4vdXRpbCcpO1xyXG5cclxuY29uc3QgemlwRmlsZW5hbWUgPSAnYm90X2xvZ3MuemlwJztcclxuY29uc3QgZGVmYXVsdFNhdmVQYXRoID0gcHJpbnRlcklkID0+IGB+L0RvY3VtZW50cy9NYWtlcmJvdExvZ3NfJHtzYWZlS2V5KHByaW50ZXJJZCl9LnppcGA7XHJcblxyXG4vLyBwcmV2ZW50IGNhbGxpbmcgemlwTG9ncyBtdWx0aXBsZSB0aW1lcyBpbiBhIHJvd1xyXG5sZXQgZGVib3VuY2UgPSBbXTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gT2JqZWN0LmZyZWV6ZSh7XHJcbiAgICBjb3B5TG9ncyhwcmludGVySWQpIHtcclxuICAgICAgICBjb25zdCBpbnZva2UgPSBfaW52b2tlKHRoaXMuZmx1eCwgcHJpbnRlcklkKTtcclxuXHJcbiAgICAgICAgaWYgKGRlYm91bmNlLmluY2x1ZGVzKHByaW50ZXJJZCkpIHJldHVybjtcclxuXHJcbiAgICAgICAgZGVib3VuY2UgPSBSLmNvbmNhdChwcmludGVySWQpO1xyXG5cclxuICAgICAgICB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuQ29weVN0YXJ0LCB7IHByaW50ZXJJZCB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHppcExvZ3MoaW52b2tlLCB6aXBGaWxlbmFtZSlcclxuICAgICAgICAgICAgLnRoZW4oemlwUGF0aCA9PiB7XHJcbiAgICAgICAgICAgICAgICBnZXRMb2dzKGludm9rZSwgemlwUGF0aClcclxuICAgICAgICAgICAgICAgICAgICAudGhlbih0bXBQYXRoID0+IHRoaXMuZGlzcGF0Y2goQWN0aW9ucy5Db3B5U3VjY2VzcywgeyBwcmludGVySWQsIHRtcFBhdGggfSkpXHJcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuQ29weUZhaWwsIHsgcHJpbnRlcklkLCBlcnIgfSkpXHJcbiAgICAgICAgICAgICAgICAgICAgLmRvbmUoKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuQ29weUZhaWwsIHsgcHJpbnRlcklkLCBlcnIgfSkpXHJcbiAgICAgICAgICAgIC5maW5hbGx5KCgpID0+IChkZWJvdW5jZSA9IFIud2l0aG91dChbcHJpbnRlcklkXSwgZGVib3VuY2UpKSlcclxuICAgICAgICAgICAgLmRvbmUoKTtcclxuICAgIH0sXHJcblxyXG4gICAgc2VuZFRvU3VwcG9ydChwcmludGVySWQpIHtcclxuICAgICAgICBjb25zdCBpMThuID0gZ2V0STE4bih0aGlzLmZsdXgpO1xyXG4gICAgICAgIGNvbnN0IHRtcFBhdGggPSBnZXRUbXBQYXRoKHRoaXMuZmx1eCwgcHJpbnRlcklkKTtcclxuXHJcbiAgICAgICAgY29uc3QgU3VwcG9ydFBsdWdpbiA9IHRoaXMuZmx1eC5nZXRQbHVnaW4oJ1N1cHBvcnQnKTtcclxuICAgICAgICBjb25zdCBNb2RhbFNlcnZpY2UgPSB0aGlzLmZsdXguZ2V0U2VydmljZSgnTW9kYWxTZXJ2aWNlJyk7XHJcblxyXG4gICAgICAgIGlmICghZnMuZXhpc3RzU3luYyh0bXBQYXRoKSkgcmV0dXJuIHEoKS50aGVuKCgpID0+IHRoaXMuZGlzcGF0Y2goQWN0aW9ucy5Ob0ZpbGUsIHsgcHJpbnRlcklkIH0pKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc3VwcG9ydE1vZGFsID0gU3VwcG9ydFBsdWdpbi5nZXRNb2RhbChcclxuICAgICAgICAgICAgdGhpcy5mbHV4LFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBvbk1vdW50OiBjb21wb25lbnQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjb21wb25lbnQpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVQYXRoVG9PYmoodGhpcy5mbHV4LCB0bXBQYXRoKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oY29tcG9uZW50Lm1hbnVhbEFkZEZpbGUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZG9uZSgpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgKCkgPT4gdGhpcy5kaXNwYXRjaChBY3Rpb25zLlNlbmRUb1N1cHBvcnRTdWNjZXNzLCB7IHByaW50ZXJJZCB9KSxcclxuICAgICAgICAgICAgZXJyID0+IHRoaXMuZGlzcGF0Y2goQWN0aW9ucy5TZW5kVG9TdXBwb3J0RmFpbCwgeyBwcmludGVySWQsIGVyciB9KVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIE1vZGFsU2VydmljZS5zaG93KHN1cHBvcnRNb2RhbCwgeyB0aXRsZTogaTE4bi50KCdtYjpjb3B5Qm90TG9ncy5zZW5kJykgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIHNhdmVMb2dzKHByaW50ZXJJZCkge1xyXG4gICAgICAgIC8vIGhhdmUgdG8gZG8gaXQgdGhpcyB3YXkgYmVjYXVzZSBtYi1wbHVnaW4gZG9lc24ndCBoYXZlIGVsZWN0cm9uXHJcbiAgICAgICAgLy8gaW5pdGFsaXplZCwgc28gcmVxdWlyaW5nIGl0IGF0IHRoZSB0b3Agb2YgdGhlIGZpbGUsIGxpa2UgYVxyXG4gICAgICAgIC8vIG5vcm1hbCBwZXJzb24gY2F1c2VzIHRoZSB0ZXN0cyB0byBicmVha1xyXG4gICAgICAgIGNvbnN0IHsgZGlhbG9nIH0gPSByZXF1aXJlKCdlbGVjdHJvbicpLnJlbW90ZTtcclxuXHJcbiAgICAgICAgY29uc3QgaTE4biA9IGdldEkxOG4odGhpcy5mbHV4KTtcclxuICAgICAgICBjb25zdCB0bXBQYXRoID0gZ2V0VG1wUGF0aCh0aGlzLmZsdXgsIHByaW50ZXJJZCk7XHJcbiAgICAgICAgY29uc3QgZGlzcGF0Y2ggPSAoKSA9PiB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuU2F2ZSwgeyBwcmludGVySWQgfSk7XHJcblxyXG4gICAgICAgIGlmICghZnMuZXhpc3RzU3luYyh0bXBQYXRoKSkge1xyXG4gICAgICAgICAgICB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuTm9GaWxlLCB7IHByaW50ZXJJZCwgdG1wUGF0aCB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBkaWFsb2cuc2hvd1NhdmVEaWFsb2coXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IGkxOG4udCgnbWI6Y29weUJvdExvZ3Muc2F2ZScpLFxyXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHRQYXRoOiBkZWZhdWx0U2F2ZVBhdGgocHJpbnRlcklkKSxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBzYXZlRmlsZShkaXNwYXRjaCwgdG1wUGF0aClcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIHRpbWVvdXQocHJpbnRlcklkLCBlcnIpIHtcclxuICAgICAgICB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuVGltZW91dCwgeyBwcmludGVySWQsIGVyciB9KTtcclxuICAgIH0sXHJcbn0pO1xyXG5cclxuY29uc3QgZ2V0VG1wUGF0aCA9IChmbHV4LCBwcmludGVySWQpID0+IGZsdXguc3RvcmUoJ0NvcHlCb3RMb2dzJykuZ2V0VG1wUGF0aChwcmludGVySWQpO1xyXG5cclxuY29uc3QgX2ludm9rZSA9IFIuY3VycnkoKGZsdXgsIHByaW50ZXJJZCwgbWV0aG9kLCBwYXJhbXMpID0+IGdldFByaW50ZXIoZmx1eCwgcHJpbnRlcklkKS5pbnZva2UobWV0aG9kLCBwYXJhbXMpKTtcclxuXHJcbmNvbnN0IHppcExvZ3MgPSBSLmN1cnJ5KChpbnZva2UsIHppcFBhdGgpID0+IGludm9rZSgnWmlwTG9ncycsIFtgL2hvbWUvJHt6aXBQYXRofWBdKS50aGVuKCgpID0+IHppcFBhdGgpKTtcclxuXHJcbmNvbnN0IGdldExvZ3MgPSBSLmN1cnJ5KChpbnZva2UsIHppcFBhdGgpID0+IHtcclxuICAgIGNvbnN0IHRtcFBhdGggPSB0bXAudG1wTmFtZVN5bmMoeyBwb3N0Zml4OiAnLnppcCcgfSk7XHJcblxyXG4gICAgcmV0dXJuIGludm9rZSgnR2V0JywgW3ppcFBhdGgsIHRtcFBhdGhdKS50aGVuKCgpID0+IHtcclxuICAgICAgICByZXR1cm4gdG1wUGF0aDtcclxuICAgIH0pO1xyXG59KTtcclxuXHJcbmNvbnN0IHNhdmVGaWxlID0gUi5jdXJyeSgoZGlzcGF0Y2gsIHRtcFBhdGgsIHBhdGgpID0+XHJcbiAgICB0bXBQYXRoICYmIHBhdGggPyBmcy5jb3B5KHRtcFBhdGgsIHBhdGgsIHt9LCBkaXNwYXRjaCkgOiB1bmRlZmluZWRcclxuKTtcclxuXHJcbmNvbnN0IGZpbGVQYXRoVG9PYmogPSAoZmx1eCwgZmlsZVBhdGgpID0+XHJcbiAgICBmbHV4XHJcbiAgICAgICAgLmdldFNlcnZpY2UoJ0ZpbGVTZXJ2aWNlJylcclxuICAgICAgICAuZ2V0RmlsZVN0YXRzKGZpbGVQYXRoKVxyXG4gICAgICAgIC50aGVuKHN0YXRzID0+ICh7IGZpbGVQYXRoLCBzaXplOiBzdGF0c1snc2l6ZSddLCBlcnJvcjogbnVsbCB9KSk7XHJcbiJdfQ==
