'use strict';

const q = require('q');

const R = require('ramda');

const React = require('react');

const {
  Dispatch
} = require('../constants/printerDetails');

const {
  getPrinter,
  currentPrinterProcess
} = require('../utils/printerDetails');

const {
  getTracking,
  getLogging,
  getI18n,
  getModal,
  trackingInfoForPrinter,
  getConfig
} = require('../util');

const EETermsAndConditionsDialog = require('../ui/views/eeTermsAndConditionsDialog');

const firmwareUtils = require('../firmwareUtils');

const processMethod = (printer, method) => printer.invoke('ProcessMethod', [method]);

const acknowledgeError = printer => processMethod(printer, 'acknowledge_error');
/**
 * Updates the printer with either the latest version the printer knows about, or with
 * a custom firmware file that the user chooses.
 */


const handleUpdateFW = (printer, flux) => {
  /* including the tracking service in showFWCompatabilityModal() and
  passing as a param blows up the modal service, so doing it here ¯\_(ツ)_/¯ */
  const tracking = getTracking(flux);
  firmwareUtils.updateFirmware(printer, flux);
  tracking.addEvent({
    name: 'firmware_update_initialized'
  });
};

module.exports = {
  done(id) {
    const printer = getPrinter(this.flux, id);
    const dispatchMethod = Dispatch.AcknowledgeCompleted;
    this.dispatch(Dispatch.ButtonWait, {
      key: 'done',
      action: dispatchMethod
    });
    processMethod(printer, 'acknowledge_completed').then(() => this.dispatch(dispatchMethod, {
      printer
    }));
  },

  resume(id) {
    const printer = getPrinter(this.flux, id);

    if (printer.processMethodExists('suspend')) {
      const dispatchMethod = Dispatch.Suspend;
      this.dispatch(Dispatch.ButtonWait, {
        key: 'pause',
        action: dispatchMethod
      });
      return processMethod(printer, 'suspend').then(() => this.dispatch(dispatchMethod, {
        id,
        printer
      }));
    }

    if (printer.processMethodExists('resume')) {
      const dispatchMethod = Dispatch.Resume; // if there's an error, but the process is resumable,
      // clear the error first, then resume...

      if (printer.getLastError()) printer.acknowledgeLastError();
      this.dispatch(Dispatch.ButtonWait, {
        key: 'resume',
        action: dispatchMethod
      });
      return processMethod(printer, 'resume').then(() => this.dispatch(dispatchMethod, {
        id
      }));
    }
  },

  cancel(id) {
    const modalService = getModal(this.flux);
    const i18n = getI18n(this.flux);
    const printer = getPrinter(this.flux, id);
    const dispatchMethod = Dispatch.Cancel;

    const cancelProcess = () => {
      const currentProcess = currentPrinterProcess(printer).apply(R.identity);
      this.dispatch(Dispatch.ButtonWait, {
        key: 'cancel',
        action: dispatchMethod
      });
      return printer.cancel().then(() => this.dispatch(dispatchMethod, {
        printer,
        currentProcess
      }));
    };

    currentPrinterProcess(printer).apply(cp => {
      if (cp.name === 'PrintProcess') {
        modalService.confirm({
          title: i18n.t('mb:printCancelModal.title'),
          body: i18n.t('mb:printCancelModal.body'),
          cancelText: i18n.t('mb:printCancelModal.cancel'),
          confirmText: i18n.t('mb:printCancelModal.confirm'),
          modalClass: 'w400 warningModal',
          onConfirm: cancelProcess
        });
      } else {
        cancelProcess();
      }
    });
    return q();
  },

  stopFilament(id) {
    const printer = getPrinter(this.flux, id);
    const dispatchMethod = Dispatch.Cancel;
    this.dispatch(Dispatch.ButtonWait, {
      key: 'stopFilament',
      action: dispatchMethod
    });
    return printer.stopFilament().then(() => this.dispatch(dispatchMethod));
  },

  printAgain(id) {
    const printer = getPrinter(this.flux, id);
    const currentProcess = currentPrinterProcess(printer).check;
    const dispatchMethod = Dispatch.PrintAgain;
    const ackMethod = currentProcess(cp => cp.step === 'failed') ? 'acknowledge_failure' : 'acknowledge_completed';
    this.dispatch(Dispatch.ButtonWait, {
      key: 'printAgain',
      action: dispatchMethod,
      printer
    });
    return processMethod(printer, ackMethod).then(() => printer.invoke('PrintAgain').then(() => this.dispatch(dispatchMethod)));
  },

  acknowledgeError(id, errID) {
    const printer = getPrinter(this.flux, id);
    const dispatchMethod = Dispatch.AcknowledgeError;
    if (errID) printer.acknowledgeError(errID);else printer.acknowledgeLastError();
    this.dispatch(Dispatch.ButtonWait, {
      key: 'acknowledgeError',
      action: dispatchMethod
    });
    acknowledgeError(printer);
    return q().then(() => this.dispatch(dispatchMethod, {
      id
    }));
  },

  acknowledgeResumeError(id) {
    const printer = getPrinter(this.flux, id);
    const dispatchMethod = Dispatch.AcknowledgeResumeError;
    this.dispatch(Dispatch.ButtonWait, {
      key: 'acknowledgeResumeError',
      action: dispatchMethod
    });
    return acknowledgeError(printer).then(() => this.dispatch(dispatchMethod));
  },

  acknowledgeFailure(id) {
    const printer = getPrinter(this.flux, id);
    const dispatchMethod = Dispatch.AcknowledgeFailure;
    this.dispatch(Dispatch.ButtonWait, {
      key: 'acknowledgeFailure',
      action: dispatchMethod
    });
    return processMethod(printer, 'acknowledge_failure').then(() => this.dispatch(dispatchMethod));
  },

  acknowledgeSuccess(id) {
    const printer = getPrinter(this.flux, id);
    const dispatchMethod = Dispatch.AcknowledgeSuccess;
    this.dispatch(Dispatch.ButtonWait, {
      key: 'acknowledgeSuccess',
      action: dispatchMethod
    });
    return processMethod(printer, 'acknowledge_success').then(() => this.dispatch(dispatchMethod));
  },

  acknowledgeBuildPlateCleared(id) {
    const printer = getPrinter(this.flux, id);
    const tracking = getTracking(this.flux);
    const logging = getLogging(this.flux);
    return printer.acknowledgeBuildPlateCleared().then(() => tracking.addEvent(R.merge({
      name: 'Confirm Clear Build Plate'
    }, trackingInfoForPrinter(printer)))).catch(err => {
      if (err.type === 'UnauthenticatedError') logging.warn(err);
    });
  },

  attachExtruder(id) {
    const printer = getPrinter(this.flux, id);
    const lpt = 'load_print_tool';

    if (printer.processMethodExists(lpt)) {
      return processMethod(printer, lpt);
    }

    return printer.invoke('LoadPrintTool', [0]);
  },

  clearFilament(id) {
    const printer = getPrinter(this.flux, id);
    const logging = getLogging(this.flux); // right now ZCal is the only process that uses 'continue_process'
    // to continue to unload filament. if we add any other processes
    // that need to unload filament, we should clean this up

    return processMethod(printer, 'continue_process').catch(err => logging.warn(err));
  },

  zCalFilament(id) {
    const printer = getPrinter(this.flux, id);
    const logging = getLogging(this.flux);
    return processMethod(printer, 'continue_process').catch(err => logging.warn(err));
  },

  extruderChange(id, index, config) {
    return q(this.dispatch(Dispatch.ExtruderChange, {
      id,
      index,
      config
    }));
  },

  networkChange(id, state) {
    return q(this.dispatch(Dispatch.NetworkChange, {
      id,
      state
    }));
  },

  details() {
    return q().delay(0).then(() => this.dispatch(Dispatch.ShowPanelDetails));
  },

  filament() {
    return q(this.dispatch(Dispatch.ShowPanelFilament));
  },

  utilities() {
    return q(this.dispatch(Dispatch.ShowPanelUtilities));
  },

  system(id, info) {
    return this.dispatch(Dispatch.System, {
      id,
      info
    });
  },

  state(id, info) {
    return this.dispatch(Dispatch.State, {
      id,
      info
    });
  },

  status(id, info) {
    return this.dispatch(Dispatch.Status, {
      id,
      info
    });
  },

  // we're not handling this right now
  error() {
    return q();
  },

  buttonWait(key, action) {
    return this.dispatch(Dispatch.ButtonWait, {
      key,
      action
    });
  },

  showEETermsAndConditions() {
    const flux = this.flux;
    const modalService = getModal(flux);
    const configService = getConfig(flux);
    const i18n = getI18n(flux);

    if (!configService.get('eeTermsSeen')) {
      modalService.show( /*#__PURE__*/React.createElement(EETermsAndConditionsDialog, null), {
        title: i18n.t('mb:ee_terms_and_conditions.title'),
        hideClose: true,
        backdrop: 'static',
        keyboard: false
      });
    }
  },

  showFWCompatabilityModal(printer) {
    const flux = this.flux;
    const modalService = getModal(flux);
    const i18n = getI18n(flux);
    modalService.confirm({
      title: i18n.t('mb:firmware.compatability.title'),
      __html: i18n.t('mb:firmware.compatability.text', {
        printerName: printer._printerInfo.name
      }),
      confirmText: i18n.t('mb:firmware.compatability.update_button'),
      cancelText: i18n.t('mb:firmware.compatability.close_button'),
      modalClass: 'w400 warningModal',
      onConfirm: () => handleUpdateFW(printer, flux),
      onClose: modalService.hide()
    });
  }

};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByaW50ZXJEZXRhaWxzQWN0aW9ucy5qcyJdLCJuYW1lcyI6WyJxIiwicmVxdWlyZSIsIlIiLCJSZWFjdCIsIkRpc3BhdGNoIiwiZ2V0UHJpbnRlciIsImN1cnJlbnRQcmludGVyUHJvY2VzcyIsImdldFRyYWNraW5nIiwiZ2V0TG9nZ2luZyIsImdldEkxOG4iLCJnZXRNb2RhbCIsInRyYWNraW5nSW5mb0ZvclByaW50ZXIiLCJnZXRDb25maWciLCJFRVRlcm1zQW5kQ29uZGl0aW9uc0RpYWxvZyIsImZpcm13YXJlVXRpbHMiLCJwcm9jZXNzTWV0aG9kIiwicHJpbnRlciIsIm1ldGhvZCIsImludm9rZSIsImFja25vd2xlZGdlRXJyb3IiLCJoYW5kbGVVcGRhdGVGVyIsImZsdXgiLCJ0cmFja2luZyIsInVwZGF0ZUZpcm13YXJlIiwiYWRkRXZlbnQiLCJuYW1lIiwibW9kdWxlIiwiZXhwb3J0cyIsImRvbmUiLCJpZCIsImRpc3BhdGNoTWV0aG9kIiwiQWNrbm93bGVkZ2VDb21wbGV0ZWQiLCJkaXNwYXRjaCIsIkJ1dHRvbldhaXQiLCJrZXkiLCJhY3Rpb24iLCJ0aGVuIiwicmVzdW1lIiwicHJvY2Vzc01ldGhvZEV4aXN0cyIsIlN1c3BlbmQiLCJSZXN1bWUiLCJnZXRMYXN0RXJyb3IiLCJhY2tub3dsZWRnZUxhc3RFcnJvciIsImNhbmNlbCIsIm1vZGFsU2VydmljZSIsImkxOG4iLCJDYW5jZWwiLCJjYW5jZWxQcm9jZXNzIiwiY3VycmVudFByb2Nlc3MiLCJhcHBseSIsImlkZW50aXR5IiwiY3AiLCJjb25maXJtIiwidGl0bGUiLCJ0IiwiYm9keSIsImNhbmNlbFRleHQiLCJjb25maXJtVGV4dCIsIm1vZGFsQ2xhc3MiLCJvbkNvbmZpcm0iLCJzdG9wRmlsYW1lbnQiLCJwcmludEFnYWluIiwiY2hlY2siLCJQcmludEFnYWluIiwiYWNrTWV0aG9kIiwic3RlcCIsImVycklEIiwiQWNrbm93bGVkZ2VFcnJvciIsImFja25vd2xlZGdlUmVzdW1lRXJyb3IiLCJBY2tub3dsZWRnZVJlc3VtZUVycm9yIiwiYWNrbm93bGVkZ2VGYWlsdXJlIiwiQWNrbm93bGVkZ2VGYWlsdXJlIiwiYWNrbm93bGVkZ2VTdWNjZXNzIiwiQWNrbm93bGVkZ2VTdWNjZXNzIiwiYWNrbm93bGVkZ2VCdWlsZFBsYXRlQ2xlYXJlZCIsImxvZ2dpbmciLCJtZXJnZSIsImNhdGNoIiwiZXJyIiwidHlwZSIsIndhcm4iLCJhdHRhY2hFeHRydWRlciIsImxwdCIsImNsZWFyRmlsYW1lbnQiLCJ6Q2FsRmlsYW1lbnQiLCJleHRydWRlckNoYW5nZSIsImluZGV4IiwiY29uZmlnIiwiRXh0cnVkZXJDaGFuZ2UiLCJuZXR3b3JrQ2hhbmdlIiwic3RhdGUiLCJOZXR3b3JrQ2hhbmdlIiwiZGV0YWlscyIsImRlbGF5IiwiU2hvd1BhbmVsRGV0YWlscyIsImZpbGFtZW50IiwiU2hvd1BhbmVsRmlsYW1lbnQiLCJ1dGlsaXRpZXMiLCJTaG93UGFuZWxVdGlsaXRpZXMiLCJzeXN0ZW0iLCJpbmZvIiwiU3lzdGVtIiwiU3RhdGUiLCJzdGF0dXMiLCJTdGF0dXMiLCJlcnJvciIsImJ1dHRvbldhaXQiLCJzaG93RUVUZXJtc0FuZENvbmRpdGlvbnMiLCJjb25maWdTZXJ2aWNlIiwiZ2V0Iiwic2hvdyIsImhpZGVDbG9zZSIsImJhY2tkcm9wIiwia2V5Ym9hcmQiLCJzaG93RldDb21wYXRhYmlsaXR5TW9kYWwiLCJfX2h0bWwiLCJwcmludGVyTmFtZSIsIl9wcmludGVySW5mbyIsIm9uQ2xvc2UiLCJoaWRlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxNQUFNQSxDQUFDLEdBQUdDLE9BQU8sQ0FBQyxHQUFELENBQWpCOztBQUNBLE1BQU1DLENBQUMsR0FBR0QsT0FBTyxDQUFDLE9BQUQsQ0FBakI7O0FBQ0EsTUFBTUUsS0FBSyxHQUFHRixPQUFPLENBQUMsT0FBRCxDQUFyQjs7QUFFQSxNQUFNO0FBQUVHLEVBQUFBO0FBQUYsSUFBZUgsT0FBTyxDQUFDLDZCQUFELENBQTVCOztBQUNBLE1BQU07QUFBRUks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QUNKLEdBcFFZOztBQXNRYkMsRUFBQUEsd0JBQXdCLENBQUNsRyxPQUFELEVBQVU7QUFDOUIsVUFBTUssSUFBSSxHQUFHLEtBQUtBLElBQWxCO0FBQ0EsVUFBTXVCLFlBQVksR0FBR2xDLFFBQVEsQ0FBQ1csSUFBRCxDQUE3QjtBQUNBLFVBQU13QixJQUFJLEdBQUdwQyxPQUFPLENBQUNZLElBQUQsQ0FBcEI7QUFFQXVCLElBQUFBLFlBQVksQ0FBQ1EsT0FBYixDQUFxQjtBQUNqQkMsTUFBQUEsS0FBSyxFQUFFUixJQUFJLENBQUNTLENBQUwsQ0FBTyxpQ0FBUCxDQURVO0FBRWpCNkQsTUFBQUEsTUFBTSxFQUFFdEUsSUFBSSxDQUFDUyxDQUFMLENBQU8sZ0NBQVAsRUFBeUM7QUFBRThELFFBQUFBLFdBQVcsRUFBRXBHLE9BQU8sQ0FBQ3FHLFlBQVIsQ0FBcUI1RjtBQUFwQyxPQUF6QyxDQUZTO0FBR2pCZ0MsTUFBQUEsV0FBVyxFQUFFWixJQUFJLENBQUNTLENBQUwsQ0FBTyx5Q0FBUCxDQUhJO0FBSWpCRSxNQUFBQSxVQUFVLEVBQUVYLElBQUksQ0FBQ1MsQ0FBTCxDQUFPLHdDQUFQLENBSks7QUFLakJJLE1BQUFBLFVBQVUsRUFBRSxtQkFMSztBQU1qQkMsTUFBQUEsU0FBUyxFQUFFLE1BQU12QyxjQUFjLENBQUNKLE9BQUQsRUFBVUssSUFBVixDQU5kO0FBT2pCaUcsTUFBQUEsT0FBTyxFQUFFMUUsWUFBWSxDQUFDMkUsSUFBYjtBQVBRLEtBQXJCO0FBU0g7O0FBcFJZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgcSA9IHJlcXVpcmUoJ3EnKTtcclxuY29uc3QgUiA9IHJlcXVpcmUoJ3JhbWRhJyk7XHJcbmNvbnN0IFJlYWN0ID0gcmVxdWlyZSgncmVhY3QnKTtcclxuXHJcbmNvbnN0IHsgRGlzcGF0Y2ggfSA9IHJlcXVpcmUoJy4uL2NvbnN0YW50cy9wcmludGVyRGV0YWlscycpO1xyXG5jb25zdCB7IGdldFByaW50ZXIsIGN1cnJlbnRQcmludGVyUHJvY2VzcyB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvcHJpbnRlckRldGFpbHMnKTtcclxuY29uc3QgeyBnZXRUcmFja2luZywgZ2V0TG9nZ2luZywgZ2V0STE4biwgZ2V0TW9kYWwsIHRyYWNraW5nSW5mb0ZvclByaW50ZXIsIGdldENvbmZpZyB9ID0gcmVxdWlyZSgnLi4vdXRpbCcpO1xyXG5jb25zdCBFRVRlcm1zQW5kQ29uZGl0aW9uc0RpYWxvZyA9IHJlcXVpcmUoJy4uL3VpL3ZpZXdzL2VlVGVybXNBbmRDb25kaXRpb25zRGlhbG9nJyk7XHJcbmNvbnN0IGZpcm13YXJlVXRpbHMgPSByZXF1aXJlKCcuLi9maXJtd2FyZVV0aWxzJyk7XHJcblxyXG5jb25zdCBwcm9jZXNzTWV0aG9kID0gKHByaW50ZXIsIG1ldGhvZCkgPT4gcHJpbnRlci5pbnZva2UoJ1Byb2Nlc3NNZXRob2QnLCBbbWV0aG9kXSk7XHJcbmNvbnN0IGFja25vd2xlZGdlRXJyb3IgPSBwcmludGVyID0+IHByb2Nlc3NNZXRob2QocHJpbnRlciwgJ2Fja25vd2xlZGdlX2Vycm9yJyk7XHJcblxyXG4vKipcclxuICogVXBkYXRlcyB0aGUgcHJpbnRlciB3aXRoIGVpdGhlciB0aGUgbGF0ZXN0IHZlcnNpb24gdGhlIHByaW50ZXIga25vd3MgYWJvdXQsIG9yIHdpdGhcclxuICogYSBjdXN0b20gZmlybXdhcmUgZmlsZSB0aGF0IHRoZSB1c2VyIGNob29zZXMuXHJcbiAqL1xyXG5jb25zdCBoYW5kbGVVcGRhdGVGVyA9IChwcmludGVyLCBmbHV4KSA9PiB7XHJcbiAgICAvKiBpbmNsdWRpbmcgdGhlIHRyYWNraW5nIHNlcnZpY2UgaW4gc2hvd0ZXQ29tcGF0YWJpbGl0eU1vZGFsKCkgYW5kXHJcbiAgICBwYXNzaW5nIGFzIGEgcGFyYW0gYmxvd3MgdXAgdGhlIG1vZGFsIHNlcnZpY2UsIHNvIGRvaW5nIGl0IGhlcmUgwq9cXF8o44OEKV8vwq8gKi9cclxuICAgIGNvbnN0IHRyYWNraW5nID0gZ2V0VHJhY2tpbmcoZmx1eCk7XHJcbiAgICBmaXJtd2FyZVV0aWxzLnVwZGF0ZUZpcm13YXJlKHByaW50ZXIsIGZsdXgpO1xyXG4gICAgdHJhY2tpbmcuYWRkRXZlbnQoeyBuYW1lOiAnZmlybXdhcmVfdXBkYXRlX2luaXRpYWxpemVkJyB9KTtcclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gICAgZG9uZShpZCkge1xyXG4gICAgICAgIGNvbnN0IHByaW50ZXIgPSBnZXRQcmludGVyKHRoaXMuZmx1eCwgaWQpO1xyXG4gICAgICAgIGNvbnN0IGRpc3BhdGNoTWV0aG9kID0gRGlzcGF0Y2guQWNrbm93bGVkZ2VDb21wbGV0ZWQ7XHJcblxyXG4gICAgICAgIHRoaXMuZGlzcGF0Y2goRGlzcGF0Y2guQnV0dG9uV2FpdCwge1xyXG4gICAgICAgICAgICBrZXk6ICdkb25lJyxcclxuICAgICAgICAgICAgYWN0aW9uOiBkaXNwYXRjaE1ldGhvZCxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcHJvY2Vzc01ldGhvZChwcmludGVyLCAnYWNrbm93bGVkZ2VfY29tcGxldGVkJykudGhlbigoKSA9PiB0aGlzLmRpc3BhdGNoKGRpc3BhdGNoTWV0aG9kLCB7IHByaW50ZXIgfSkpO1xyXG4gICAgfSxcclxuXHJcbiAgICByZXN1bWUoaWQpIHtcclxuICAgICAgICBjb25zdCBwcmludGVyID0gZ2V0UHJpbnRlcih0aGlzLmZsdXgsIGlkKTtcclxuXHJcbiAgICAgICAgaWYgKHByaW50ZXIucHJvY2Vzc01ldGhvZEV4aXN0cygnc3VzcGVuZCcpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRpc3BhdGNoTWV0aG9kID0gRGlzcGF0Y2guU3VzcGVuZDtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2goRGlzcGF0Y2guQnV0dG9uV2FpdCwge1xyXG4gICAgICAgICAgICAgICAga2V5OiAncGF1c2UnLFxyXG4gICAgICAgICAgICAgICAgYWN0aW9uOiBkaXNwYXRjaE1ldGhvZCxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzTWV0aG9kKHByaW50ZXIsICdzdXNwZW5kJykudGhlbigoKSA9PiB0aGlzLmRpc3BhdGNoKGRpc3BhdGNoTWV0aG9kLCB7IGlkLCBwcmludGVyIH0pKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChwcmludGVyLnByb2Nlc3NNZXRob2RFeGlzdHMoJ3Jlc3VtZScpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRpc3BhdGNoTWV0aG9kID0gRGlzcGF0Y2guUmVzdW1lO1xyXG5cclxuICAgICAgICAgICAgLy8gaWYgdGhlcmUncyBhbiBlcnJvciwgYnV0IHRoZSBwcm9jZXNzIGlzIHJlc3VtYWJsZSxcclxuICAgICAgICAgICAgLy8gY2xlYXIgdGhlIGVycm9yIGZpcnN0LCB0aGVuIHJlc3VtZS4uLlxyXG4gICAgICAgICAgICBpZiAocHJpbnRlci5nZXRMYXN0RXJyb3IoKSkgcHJpbnRlci5hY2tub3dsZWRnZUxhc3RFcnJvcigpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kaXNwYXRjaChEaXNwYXRjaC5CdXR0b25XYWl0LCB7XHJcbiAgICAgICAgICAgICAgICBrZXk6ICdyZXN1bWUnLFxyXG4gICAgICAgICAgICAgICAgYWN0aW9uOiBkaXNwYXRjaE1ldGhvZCxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzTWV0aG9kKHByaW50ZXIsICdyZXN1bWUnKS50aGVuKCgpID0+IHRoaXMuZGlzcGF0Y2goZGlzcGF0Y2hNZXRob2QsIHsgaWQgfSkpO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgY2FuY2VsKGlkKSB7XHJcbiAgICAgICAgY29uc3QgbW9kYWxTZXJ2aWNlID0gZ2V0TW9kYWwodGhpcy5mbHV4KTtcclxuICAgICAgICBjb25zdCBpMThuID0gZ2V0STE4bih0aGlzLmZsdXgpO1xyXG4gICAgICAgIGNvbnN0IHByaW50ZXIgPSBnZXRQcmludGVyKHRoaXMuZmx1eCwgaWQpO1xyXG4gICAgICAgIGNvbnN0IGRpc3BhdGNoTWV0aG9kID0gRGlzcGF0Y2guQ2FuY2VsO1xyXG5cclxuICAgICAgICBjb25zdCBjYW5jZWxQcm9jZXNzID0gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50UHJvY2VzcyA9IGN1cnJlbnRQcmludGVyUHJvY2VzcyhwcmludGVyKS5hcHBseShSLmlkZW50aXR5KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2goRGlzcGF0Y2guQnV0dG9uV2FpdCwge1xyXG4gICAgICAgICAgICAgICAga2V5OiAnY2FuY2VsJyxcclxuICAgICAgICAgICAgICAgIGFjdGlvbjogZGlzcGF0Y2hNZXRob2QsXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHByaW50ZXIuY2FuY2VsKCkudGhlbigoKSA9PiB0aGlzLmRpc3BhdGNoKGRpc3BhdGNoTWV0aG9kLCB7IHByaW50ZXIsIGN1cnJlbnRQcm9jZXNzIH0pKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBjdXJyZW50UHJpbnRlclByb2Nlc3MocHJpbnRlcikuYXBwbHkoY3AgPT4ge1xyXG4gICAgICAgICAgICBpZiAoY3AubmFtZSA9PT0gJ1ByaW50UHJvY2VzcycpIHtcclxuICAgICAgICAgICAgICAgIG1vZGFsU2VydmljZS5jb25maXJtKHtcclxuICAgICAgICAgICAgICAgICAgICB0aXRsZTogaTE4bi50KCdtYjpwcmludENhbmNlbE1vZGFsLnRpdGxlJyksXHJcbiAgICAgICAgICAgICAgICAgICAgYm9keTogaTE4bi50KCdtYjpwcmludENhbmNlbE1vZGFsLmJvZHknKSxcclxuICAgICAgICAgICAgICAgICAgICBjYW5jZWxUZXh0OiBpMThuLnQoJ21iOnByaW50Q2FuY2VsTW9kYWwuY2FuY2VsJyksXHJcbiAgICAgICAgICAgICAgICAgICAgY29uZmlybVRleHQ6IGkxOG4udCgnbWI6cHJpbnRDYW5jZWxNb2RhbC5jb25maXJtJyksXHJcbiAgICAgICAgICAgICAgICAgICAgbW9kYWxDbGFzczogJ3c0MDAgd2FybmluZ01vZGFsJyxcclxuICAgICAgICAgICAgICAgICAgICBvbkNvbmZpcm06IGNhbmNlbFByb2Nlc3MsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNhbmNlbFByb2Nlc3MoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gcSgpO1xyXG4gICAgfSxcclxuXHJcbiAgICBzdG9wRmlsYW1lbnQoaWQpIHtcclxuICAgICAgICBjb25zdCBwcmludGVyID0gZ2V0UHJpbnRlcih0aGlzLmZsdXgsIGlkKTtcclxuICAgICAgICBjb25zdCBkaXNwYXRjaE1ldGhvZCA9IERpc3BhdGNoLkNhbmNlbDtcclxuXHJcbiAgICAgICAgdGhpcy5kaXNwYXRjaChEaXNwYXRjaC5CdXR0b25XYWl0LCB7XHJcbiAgICAgICAgICAgIGtleTogJ3N0b3BGaWxhbWVudCcsXHJcbiAgICAgICAgICAgIGFjdGlvbjogZGlzcGF0Y2hNZXRob2QsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHByaW50ZXIuc3RvcEZpbGFtZW50KCkudGhlbigoKSA9PiB0aGlzLmRpc3BhdGNoKGRpc3BhdGNoTWV0aG9kKSk7XHJcbiAgICB9LFxyXG5cclxuICAgIHByaW50QWdhaW4oaWQpIHtcclxuICAgICAgICBjb25zdCBwcmludGVyID0gZ2V0UHJpbnRlcih0aGlzLmZsdXgsIGlkKTtcclxuICAgICAgICBjb25zdCBjdXJyZW50UHJvY2VzcyA9IGN1cnJlbnRQcmludGVyUHJvY2VzcyhwcmludGVyKS5jaGVjaztcclxuICAgICAgICBjb25zdCBkaXNwYXRjaE1ldGhvZCA9IERpc3BhdGNoLlByaW50QWdhaW47XHJcblxyXG4gICAgICAgIGNvbnN0IGFja01ldGhvZCA9IGN1cnJlbnRQcm9jZXNzKGNwID0+IGNwLnN0ZXAgPT09ICdmYWlsZWQnKSA/ICdhY2tub3dsZWRnZV9mYWlsdXJlJyA6ICdhY2tub3dsZWRnZV9jb21wbGV0ZWQnO1xyXG5cclxuICAgICAgICB0aGlzLmRpc3BhdGNoKERpc3BhdGNoLkJ1dHRvbldhaXQsIHtcclxuICAgICAgICAgICAga2V5OiAncHJpbnRBZ2FpbicsXHJcbiAgICAgICAgICAgIGFjdGlvbjogZGlzcGF0Y2hNZXRob2QsXHJcbiAgICAgICAgICAgIHByaW50ZXIsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHByb2Nlc3NNZXRob2QocHJpbnRlciwgYWNrTWV0aG9kKS50aGVuKCgpID0+XHJcbiAgICAgICAgICAgIHByaW50ZXIuaW52b2tlKCdQcmludEFnYWluJykudGhlbigoKSA9PiB0aGlzLmRpc3BhdGNoKGRpc3BhdGNoTWV0aG9kKSlcclxuICAgICAgICApO1xyXG4gICAgfSxcclxuXHJcbiAgICBhY2tub3dsZWRnZUVycm9yKGlkLCBlcnJJRCkge1xyXG4gICAgICAgIGNvbnN0IHByaW50ZXIgPSBnZXRQcmludGVyKHRoaXMuZmx1eCwgaWQpO1xyXG4gICAgICAgIGNvbnN0IGRpc3BhdGNoTWV0aG9kID0gRGlzcGF0Y2guQWNrbm93bGVkZ2VFcnJvcjtcclxuXHJcbiAgICAgICAgaWYgKGVycklEKSBwcmludGVyLmFja25vd2xlZGdlRXJyb3IoZXJySUQpO1xyXG4gICAgICAgIGVsc2UgcHJpbnRlci5hY2tub3dsZWRnZUxhc3RFcnJvcigpO1xyXG5cclxuICAgICAgICB0aGlzLmRpc3BhdGNoKERpc3BhdGNoLkJ1dHRvbldhaXQsIHtcclxuICAgICAgICAgICAga2V5OiAnYWNrbm93bGVkZ2VFcnJvcicsXHJcbiAgICAgICAgICAgIGFjdGlvbjogZGlzcGF0Y2hNZXRob2QsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGFja25vd2xlZGdlRXJyb3IocHJpbnRlcik7XHJcbiAgICAgICAgcmV0dXJuIHEoKS50aGVuKCgpID0+IHRoaXMuZGlzcGF0Y2goZGlzcGF0Y2hNZXRob2QsIHsgaWQgfSkpO1xyXG4gICAgfSxcclxuXHJcbiAgICBhY2tub3dsZWRnZVJlc3VtZUVycm9yKGlkKSB7XHJcbiAgICAgICAgY29uc3QgcHJpbnRlciA9IGdldFByaW50ZXIodGhpcy5mbHV4LCBpZCk7XHJcbiAgICAgICAgY29uc3QgZGlzcGF0Y2hNZXRob2QgPSBEaXNwYXRjaC5BY2tub3dsZWRnZVJlc3VtZUVycm9yO1xyXG5cclxuICAgICAgICB0aGlzLmRpc3BhdGNoKERpc3BhdGNoLkJ1dHRvbldhaXQsIHtcclxuICAgICAgICAgICAga2V5OiAnYWNrbm93bGVkZ2VSZXN1bWVFcnJvcicsXHJcbiAgICAgICAgICAgIGFjdGlvbjogZGlzcGF0Y2hNZXRob2QsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGFja25vd2xlZGdlRXJyb3IocHJpbnRlcikudGhlbigoKSA9PiB0aGlzLmRpc3BhdGNoKGRpc3BhdGNoTWV0aG9kKSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGFja25vd2xlZGdlRmFpbHVyZShpZCkge1xyXG4gICAgICAgIGNvbnN0IHByaW50ZXIgPSBnZXRQcmludGVyKHRoaXMuZmx1eCwgaWQpO1xyXG4gICAgICAgIGNvbnN0IGRpc3BhdGNoTWV0aG9kID0gRGlzcGF0Y2guQWNrbm93bGVkZ2VGYWlsdXJlO1xyXG5cclxuICAgICAgICB0aGlzLmRpc3BhdGNoKERpc3BhdGNoLkJ1dHRvbldhaXQsIHtcclxuICAgICAgICAgICAga2V5OiAnYWNrbm93bGVkZ2VGYWlsdXJlJyxcclxuICAgICAgICAgICAgYWN0aW9uOiBkaXNwYXRjaE1ldGhvZCxcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gcHJvY2Vzc01ldGhvZChwcmludGVyLCAnYWNrbm93bGVkZ2VfZmFpbHVyZScpLnRoZW4oKCkgPT4gdGhpcy5kaXNwYXRjaChkaXNwYXRjaE1ldGhvZCkpO1xyXG4gICAgfSxcclxuXHJcbiAgICBhY2tub3dsZWRnZVN1Y2Nlc3MoaWQpIHtcclxuICAgICAgICBjb25zdCBwcmludGVyID0gZ2V0UHJpbnRlcih0aGlzLmZsdXgsIGlkKTtcclxuICAgICAgICBjb25zdCBkaXNwYXRjaE1ldGhvZCA9IERpc3BhdGNoLkFja25vd2xlZGdlU3VjY2VzcztcclxuXHJcbiAgICAgICAgdGhpcy5kaXNwYXRjaChEaXNwYXRjaC5CdXR0b25XYWl0LCB7XHJcbiAgICAgICAgICAgIGtleTogJ2Fja25vd2xlZGdlU3VjY2VzcycsXHJcbiAgICAgICAgICAgIGFjdGlvbjogZGlzcGF0Y2hNZXRob2QsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHByb2Nlc3NNZXRob2QocHJpbnRlciwgJ2Fja25vd2xlZGdlX3N1Y2Nlc3MnKS50aGVuKCgpID0+IHRoaXMuZGlzcGF0Y2goZGlzcGF0Y2hNZXRob2QpKTtcclxuICAgIH0sXHJcblxyXG4gICAgYWNrbm93bGVkZ2VCdWlsZFBsYXRlQ2xlYXJlZChpZCkge1xyXG4gICAgICAgIGNvbnN0IHByaW50ZXIgPSBnZXRQcmludGVyKHRoaXMuZmx1eCwgaWQpO1xyXG4gICAgICAgIGNvbnN0IHRyYWNraW5nID0gZ2V0VHJhY2tpbmcodGhpcy5mbHV4KTtcclxuICAgICAgICBjb25zdCBsb2dnaW5nID0gZ2V0TG9nZ2luZyh0aGlzLmZsdXgpO1xyXG5cclxuICAgICAgICByZXR1cm4gcHJpbnRlclxyXG4gICAgICAgICAgICAuYWNrbm93bGVkZ2VCdWlsZFBsYXRlQ2xlYXJlZCgpXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+XHJcbiAgICAgICAgICAgICAgICB0cmFja2luZy5hZGRFdmVudChcclxuICAgICAgICAgICAgICAgICAgICBSLm1lcmdlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnQ29uZmlybSBDbGVhciBCdWlsZCBQbGF0ZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNraW5nSW5mb0ZvclByaW50ZXIocHJpbnRlcilcclxuICAgICAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyLnR5cGUgPT09ICdVbmF1dGhlbnRpY2F0ZWRFcnJvcicpIGxvZ2dpbmcud2FybihlcnIpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH0sXHJcblxyXG4gICAgYXR0YWNoRXh0cnVkZXIoaWQpIHtcclxuICAgICAgICBjb25zdCBwcmludGVyID0gZ2V0UHJpbnRlcih0aGlzLmZsdXgsIGlkKTtcclxuICAgICAgICBjb25zdCBscHQgPSAnbG9hZF9wcmludF90b29sJztcclxuXHJcbiAgICAgICAgaWYgKHByaW50ZXIucHJvY2Vzc01ldGhvZEV4aXN0cyhscHQpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzTWV0aG9kKHByaW50ZXIsIGxwdCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcHJpbnRlci5pbnZva2UoJ0xvYWRQcmludFRvb2wnLCBbMF0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBjbGVhckZpbGFtZW50KGlkKSB7XHJcbiAgICAgICAgY29uc3QgcHJpbnRlciA9IGdldFByaW50ZXIodGhpcy5mbHV4LCBpZCk7XHJcbiAgICAgICAgY29uc3QgbG9nZ2luZyA9IGdldExvZ2dpbmcodGhpcy5mbHV4KTtcclxuXHJcbiAgICAgICAgLy8gcmlnaHQgbm93IFpDYWwgaXMgdGhlIG9ubHkgcHJvY2VzcyB0aGF0IHVzZXMgJ2NvbnRpbnVlX3Byb2Nlc3MnXHJcbiAgICAgICAgLy8gdG8gY29udGludWUgdG8gdW5sb2FkIGZpbGFtZW50LiBpZiB3ZSBhZGQgYW55IG90aGVyIHByb2Nlc3Nlc1xyXG4gICAgICAgIC8vIHRoYXQgbmVlZCB0byB1bmxvYWQgZmlsYW1lbnQsIHdlIHNob3VsZCBjbGVhbiB0aGlzIHVwXHJcbiAgICAgICAgcmV0dXJuIHByb2Nlc3NNZXRob2QocHJpbnRlciwgJ2NvbnRpbnVlX3Byb2Nlc3MnKS5jYXRjaChlcnIgPT4gbG9nZ2luZy53YXJuKGVycikpO1xyXG4gICAgfSxcclxuXHJcbiAgICB6Q2FsRmlsYW1lbnQoaWQpIHtcclxuICAgICAgICBjb25zdCBwcmludGVyID0gZ2V0UHJpbnRlcih0aGlzLmZsdXgsIGlkKTtcclxuICAgICAgICBjb25zdCBsb2dnaW5nID0gZ2V0TG9nZ2luZyh0aGlzLmZsdXgpO1xyXG5cclxuICAgICAgICByZXR1cm4gcHJvY2Vzc01ldGhvZChwcmludGVyLCAnY29udGludWVfcHJvY2VzcycpLmNhdGNoKGVyciA9PiBsb2dnaW5nLndhcm4oZXJyKSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGV4dHJ1ZGVyQ2hhbmdlKGlkLCBpbmRleCwgY29uZmlnKSB7XHJcbiAgICAgICAgcmV0dXJuIHEodGhpcy5kaXNwYXRjaChEaXNwYXRjaC5FeHRydWRlckNoYW5nZSwgeyBpZCwgaW5kZXgsIGNvbmZpZyB9KSk7XHJcbiAgICB9LFxyXG5cclxuICAgIG5ldHdvcmtDaGFuZ2UoaWQsIHN0YXRlKSB7XHJcbiAgICAgICAgcmV0dXJuIHEodGhpcy5kaXNwYXRjaChEaXNwYXRjaC5OZXR3b3JrQ2hhbmdlLCB7IGlkLCBzdGF0ZSB9KSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGRldGFpbHMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHEoKVxyXG4gICAgICAgICAgICAuZGVsYXkoMClcclxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5kaXNwYXRjaChEaXNwYXRjaC5TaG93UGFuZWxEZXRhaWxzKSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGZpbGFtZW50KCkge1xyXG4gICAgICAgIHJldHVybiBxKHRoaXMuZGlzcGF0Y2goRGlzcGF0Y2guU2hvd1BhbmVsRmlsYW1lbnQpKTtcclxuICAgIH0sXHJcblxyXG4gICAgdXRpbGl0aWVzKCkge1xyXG4gICAgICAgIHJldHVybiBxKHRoaXMuZGlzcGF0Y2goRGlzcGF0Y2guU2hvd1BhbmVsVXRpbGl0aWVzKSk7XHJcbiAgICB9LFxyXG5cclxuICAgIHN5c3RlbShpZCwgaW5mbykge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoKERpc3BhdGNoLlN5c3RlbSwgeyBpZCwgaW5mbyB9KTtcclxuICAgIH0sXHJcblxyXG4gICAgc3RhdGUoaWQsIGluZm8pIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kaXNwYXRjaChEaXNwYXRjaC5TdGF0ZSwgeyBpZCwgaW5mbyB9KTtcclxuICAgIH0sXHJcblxyXG4gICAgc3RhdHVzKGlkLCBpbmZvKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2goRGlzcGF0Y2guU3RhdHVzLCB7IGlkLCBpbmZvIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICAvLyB3ZSdyZSBub3QgaGFuZGxpbmcgdGhpcyByaWdodCBub3dcclxuICAgIGVycm9yKCkge1xyXG4gICAgICAgIHJldHVybiBxKCk7XHJcbiAgICB9LFxyXG5cclxuICAgIGJ1dHRvbldhaXQoa2V5LCBhY3Rpb24pIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kaXNwYXRjaChEaXNwYXRjaC5CdXR0b25XYWl0LCB7IGtleSwgYWN0aW9uIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBzaG93RUVUZXJtc0FuZENvbmRpdGlvbnMoKSB7XHJcbiAgICAgICAgY29uc3QgZmx1eCA9IHRoaXMuZmx1eDtcclxuICAgICAgICBjb25zdCBtb2RhbFNlcnZpY2UgPSBnZXRNb2RhbChmbHV4KTtcclxuICAgICAgICBjb25zdCBjb25maWdTZXJ2aWNlID0gZ2V0Q29uZmlnKGZsdXgpO1xyXG4gICAgICAgIGNvbnN0IGkxOG4gPSBnZXRJMThuKGZsdXgpO1xyXG5cclxuICAgICAgICBpZiAoIWNvbmZpZ1NlcnZpY2UuZ2V0KCdlZVRlcm1zU2VlbicpKSB7XHJcbiAgICAgICAgICAgIG1vZGFsU2VydmljZS5zaG93KDxFRVRlcm1zQW5kQ29uZGl0aW9uc0RpYWxvZyAvPiwge1xyXG4gICAgICAgICAgICAgICAgdGl0bGU6IGkxOG4udCgnbWI6ZWVfdGVybXNfYW5kX2NvbmRpdGlvbnMudGl0bGUnKSxcclxuICAgICAgICAgICAgICAgIGhpZGVDbG9zZTogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIGJhY2tkcm9wOiAnc3RhdGljJyxcclxuICAgICAgICAgICAgICAgIGtleWJvYXJkOiBmYWxzZSxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBzaG93RldDb21wYXRhYmlsaXR5TW9kYWwocHJpbnRlcikge1xyXG4gICAgICAgIGNvbnN0IGZsdXggPSB0aGlzLmZsdXg7XHJcbiAgICAgICAgY29uc3QgbW9kYWxTZXJ2aWNlID0gZ2V0TW9kYWwoZmx1eCk7XHJcbiAgICAgICAgY29uc3QgaTE4biA9IGdldEkxOG4oZmx1eCk7XHJcblxyXG4gICAgICAgIG1vZGFsU2VydmljZS5jb25maXJtKHtcclxuICAgICAgICAgICAgdGl0bGU6IGkxOG4udCgnbWI6ZmlybXdhcmUuY29tcGF0YWJpbGl0eS50aXRsZScpLFxyXG4gICAgICAgICAgICBfX2h0bWw6IGkxOG4udCgnbWI6ZmlybXdhcmUuY29tcGF0YWJpbGl0eS50ZXh0JywgeyBwcmludGVyTmFtZTogcHJpbnRlci5fcHJpbnRlckluZm8ubmFtZSB9KSxcclxuICAgICAgICAgICAgY29uZmlybVRleHQ6IGkxOG4udCgnbWI6ZmlybXdhcmUuY29tcGF0YWJpbGl0eS51cGRhdGVfYnV0dG9uJyksXHJcbiAgICAgICAgICAgIGNhbmNlbFRleHQ6IGkxOG4udCgnbWI6ZmlybXdhcmUuY29tcGF0YWJpbGl0eS5jbG9zZV9idXR0b24nKSxcclxuICAgICAgICAgICAgbW9kYWxDbGFzczogJ3c0MDAgd2FybmluZ01vZGFsJyxcclxuICAgICAgICAgICAgb25Db25maXJtOiAoKSA9PiBoYW5kbGVVcGRhdGVGVyhwcmludGVyLCBmbHV4KSxcclxuICAgICAgICAgICAgb25DbG9zZTogbW9kYWxTZXJ2aWNlLmhpZGUoKSxcclxuICAgICAgICB9KTtcclxuICAgIH0sXHJcbn07XHJcbiJdfQ==
