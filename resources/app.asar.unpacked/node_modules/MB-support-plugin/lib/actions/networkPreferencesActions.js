'use strict';

const q = require('q');

const _ = require('lodash');

const {
  getPrinter
} = require('../utils/printerDetails');

const {
  Actions,
  NetworkStateEnum,
  InvalidPassword
} = require('../constants/networkPreferences');

const ActionCreators = Object.freeze({
  networkChange(printerId) {
    return updateNetworkState(this.flux, this.dispatch, printerId);
  },

  enableWifi(printerId) {
    const printer = getPrinter(this.flux, printerId);
    this.dispatch(Actions.Waiting);
    return printer.invoke('WifiEnable').then(() => updateNetworkState(this.flux, this.dispatch, printerId)).catch(handleError(this.dispatch)).done();
  },

  disableWifi(printerId) {
    const printer = getPrinter(this.flux, printerId);
    this.dispatch(Actions.Waiting);
    return printer.invoke('WifiDisable').then(() => updateNetworkState(this.flux, this.dispatch, printerId)).catch(handleError(this.dispatch)).done();
  },

  connectToNetwork(printerId, path, pw) {
    const printer = getPrinter(this.flux, printerId);
    const trackEvent = trackingEvent(this.flux, printer);
    const forget = ActionCreators.forgetNetwork.bind(this);
    this.dispatch(Actions.Waiting);
    return connectToWifi(printer, path, pw).then(() => trackEvent('Printer Successfully Connected to Wifi')).then(() => updateNetworkState(this.flux, this.dispatch, printerId)).catch(e => {
      const err = JSON.parse(e.message).error;
      trackEvent('Printer Failed to Connect to Wifi');
      if (err.code === InvalidPassword) return forget(path);
      return handleError(this.dispatch)(err);
    }).done();
  },

  disconnectFromNetwork(printerId, path) {
    const printer = getPrinter(this.flux, printerId);
    const trackEvent = trackingEvent(this.flux, printer);
    return disconnectFromWifi(printer, path).then(() => trackEvent('Printer Successfully Disconnected from Wifi')).then(() => updateNetworkState(this.flux, this.dispatch, printerId)).catch(err => {
      trackEvent('Printer Failed to Disconnect from Wifi');
      return handleError(this.dispatch)(err);
    }).done();
  },

  forgetNetwork(printerId, path) {
    const printer = getPrinter(this.flux, printerId);
    return printer.invoke('WifiForget', [path]).then(() => this.dispatch(Actions.WifiForget)).then(() => updateNetworkState(this.flux, this.dispatch, printerId)).done();
  },

  setStaticIP(printerId, path, ip, netmask, gateway, dnsServers, use_static = true) {
    const printer = getPrinter(this.flux, printerId); // since many of the params for this function are optional in kaiten
    // I have to map over and make sure any that are not explictly set
    // to a real value are converted to `undefined`. Kaiten will handle
    // that appropriately.

    const args = _.map([ip, netmask, gateway, dnsServers, use_static], a => a === null ? undefined : a);

    return printer.invoke('SetStaticIpv4', [path, ...args]).then(() => this.dispatch(Actions.SetStaticIP, {
      dnsServers,
      enable: use_static
    })).catch(handleError(this.dispatch)).done();
  },

  prepopulateStaticIP(printerId, path) {
    //Clear current field values while waiting for update
    this.dispatch(Actions.PrepopulateStaticIPFields, {});

    if (path) {
      const printer = getPrinter(this.flux, printerId);
      printer.invoke('GetStaticIpv4', [path]).then(result => {
        if (result.use_static) {
          this.dispatch(Actions.PrepopulateStaticIPFields, Object.assign({}, result));
        }
      }).done();
    }
  },

  changeStaticIPAddress(ipAddress) {
    this.dispatch(Actions.ChangeStaticIPAddress, {
      ipAddress
    });
  },

  changeNetmask(netmask) {
    this.dispatch(Actions.ChangeNetmask, {
      netmask
    });
  },

  changeGateway(gateway) {
    this.dispatch(Actions.ChangeGateway, {
      gateway
    });
  },

  changeDNSServers(dnsServers) {
    this.dispatch(Actions.ChangeDNSServers, {
      dnsServers: _.unique(dnsServers)
    });
  },

  newDNSItem(item) {
    this.dispatch(Actions.NewDNSItem, {
      item
    });
  },

  selectDNSItem(item) {
    this.dispatch(Actions.SelectDNSItem, {
      item
    });
  },

  selectNetwork(path) {
    this.dispatch(Actions.SelectNetwork, {
      path
    });
  },

  changePasswordAttempt(password) {
    this.dispatch(Actions.ChangePasswordAttempt, {
      password
    });
  },

  togglePasswordVisibility() {
    this.dispatch(Actions.TogglePasswordVisibility);
  },

  clearError() {
    this.dispatch(Actions.ClearError);
  }

});
/*****************************************************************************/

/*                              HELPERS                                      */

/*****************************************************************************/

const handleError = dispatch => error => dispatch(Actions.Error, {
  error
});

const getTracking = flux => flux.getService('TrackingService');

const trackingEvent = (flux, printer) => name => getTracking(flux).addEvent(_.merge({
  name
}, printer.getTrackingInfo()));

const fetchAvailableNetworks = (flux, printerId) => getPrinter(flux, printerId).invoke('WifiScan');

const setAsWifi = action => (flux, dispatch, printerId, networkState) => fetchAvailableNetworks(flux, printerId).then(availableNetworks => dispatch(action, {
  printerId,
  availableNetworks,
  networkState
})).catch(handleError(dispatch)).done();

const setAsEthernetConnected = (flux, dispatch, printerId, networkState) => dispatch(Actions.EthernetConnected, {
  printerId,
  networkState
});

const setAsUnconnected = (flux, dispatch, printerId, networkState) => dispatch(Actions.Unconnected, {
  printerId,
  networkState
}); // Depending on the connection type, different behaviors are needed.
// Instead of having a long if-else tree, I thought a declarative dictionary
// would be easier on the eyes.


const networkStateFlow = Object.freeze({
  [NetworkStateEnum.state.WIFI]: setAsWifi(Actions.WifiConnected),
  [NetworkStateEnum.state.ETHERNET]: setAsEthernetConnected,
  [NetworkStateEnum.wifi.ENABLED]: setAsWifi(Actions.WifiReady),
  [NetworkStateEnum.wifi.DISABLED]: setAsUnconnected
}); // Grab the appropriate state updater for the connection type

const networkStateUpdater = (flux, dispatch, printerId) => networkState => {
  const connFunc = networkStateFlow[networkState.state] || networkStateFlow[networkState.wifi];
  return connFunc(flux, dispatch, printerId, networkState);
};

const updateNetworkState = (flux, dispatch, printerId) => {
  const printer = getPrinter(flux, printerId);
  const updateState = networkStateUpdater(flux, dispatch, printerId);
  if (printer.isAuthenticated()) return printer.invoke('NetworkState').then(updateState).catch(handleError(dispatch)).done();
  return q().then(() => dispatch(Actions.Waiting)).done();
};

const connectToWifi = (printer, path, pw) => _.size(pw) === 0 ? printer.invoke('WifiConnect', [path]) : printer.invoke('WifiConnect', [path, pw]);

const disconnectFromWifi = (printer, path) => printer.invoke('WifiDisconnect', [path]);

module.exports = ActionCreators;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5ldHdvcmtQcmVmZXJlbmNlc0FjdGlvbnMuanMiXSwibmFtZXMiOlsicSIsInJlcXVpcmUiLCJfIiwiZ2V0UHJpbnRlciIsIkFjdGlvbnMiLCJOZXR3b3JrU3RhdGVFbnVtIiwiSW52YWxpZFBhc3N3b3JkIiwiQWN0aW9uQ3JlYXRvcnMiLCJPYmplY3QiLCJmcmVlemUiLCJuZXR3b3JrQ2hhbmdlIiwicHJpbnRlcklkIiwidXBkYXRlTmV0d29ya1N0YXRlIiwiZmx1eCIsImRpc3BhdGNoIiwiZW5hYmxlV2lmaSIsInByaW50ZXIiLCJXYWl0aW5nIiwiaW52b2tlIiwidGhlbiIsImNhdGNoIiwiaGFuZGxlRXJyb3IiLCJkb25lIiwiZGlzYWJsZVdpZmkiLCJjb25uZWN0VG9OZXR3b3JrIiwicGF0aCIsInB3IiwidHJhY2tFdmVudCIsInRyYWNraW5nRXZlbnQiLCJmb3JnZXQiLCJmb3JnZXROZXR3b3JrIiwiYmluZCIsImNvbm5lY3RUb1dpZmkiLCJlIiwiZXJyIiwiSlNPTiIsInBhcnNlIiwibWVzc2FnZSIsImVycm9yIiwiY29kZSIsImRpc2Nvbm5lY3RGcm9tTmV0d29yayIsImRpc2Nvbm5lY3RGcm9tV2lmaSIsIldpZmlGb3JnZXQiLCJzZXRTdGF0aWNJUCIsImlwIiwibmV0bWFzayIsImdhdGV3YXkiLCJkbnNTZXJ2ZXJzIiwidXNlX3N0YXRpYyIsImFyZ3MiLCJtYXAiLCJhIiwidW5kZWZpbmVkIiwiU2V0U3RhdGljSVAiLCJlbmFibGUiLCJwcmVwb3B1bGF0ZVN0YXRpY0lQIiwiUHJlcG9wdWxhdGVTdGF0aWNJUEZpZWxkcyIsInJlc3VsdCIsImFzc2lnbiIsImNoYW5nZVN0YXRpY0lQQWRkcmVzcyIsImlwQWRkcmVzcyIsIkNoYW5nZVN0YXRpY0lQQWRkcmVzcyIsImNoYW5nZU5ldG1hc2siLCJDaGFuZ2VOZXRtYXNrIiwiY2hhbmdlR2F0ZXdheSIsIkNoYW5nZUdhdGV3YXkiLCJjaGFuZ2VETlNTZXJ2ZXJzIiwiQ2hhbmdlRE5TU2VydmVycyIsInVuaXF1ZSIsIm5ld0ROU0l0ZW0iLCJpdGVtIiwiTmV3RE5TSXRlbSIsInNlbGVjdEROU0l0ZW0iLCJTZWxlY3RETlNJdGVtIiwic2VsZWN0TmV0d29yayIsIlNlbGVjdE5ldHdvcmsiLCJjaGFuZ2VQYXNzd29yZEF0dGVtcHQiLCJwYXNzd29yZCIsIkNoYW5nZVBhc3N3b3JkQXR0ZW1wdCIsInRvZ2dsZVBhc3N3b3JkVmlzaWJpbGl0eSIsIlRvZ2dsZVBhc3N3b3JkVmlzaWJpbGl0eSIsImNsZWFyRXJyb3IiLCJDbGVhckVycm9yIiwiRXJyb3IiLCJnZXRUcmFja2luZyIsImdldFNlcnZpY2UiLCJuYW1lIiwiYWRkRXZlbnQiLCJtZXJnZSIsImdldFRyYWNraW5nSW5mbyIsImZldGNoQXZhaWxhYmxlTmV0d29ya3MiLCJzZXRBc1dpZmkiLCJhY3Rpb24iLCJuZXR3b3JrU3RhdGUiLCJhdmFpbGFibGVOZXR3b3JrcyIsInNldEFzRXRoZXJuZXRDb25uZWN0ZWQiLCJFdGhlcm5ldENvbm5lY3RlZCIsInNldEFzVW5jb25uZWN0ZWQiLCJVbmNvbm5lY3RlZCIsIm5ldHdvcmtTdGF0ZUZsb3ciLCJzdGF0ZSIsIldJRkkiLCJXaWZpQ29ubmVjdGVkIiwiRVRIRVJORVQiLCJ3aWZpIiwiRU5BQkxFRCIsIldpZmlSZWFkeSIsIkRJU0FCTEVEIiwibmV0d29ya1N0YXRlVXBkYXRlciIsImNvbm5GdW5jIiwidXBkYXRlU3RhdGUiLCJpc0F1dGhlbnRpY2F0ZWQiLCJzaXplIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsTUFBTUEsQ0FBQyxHQUFHQyxPQUFPLENBQUMsR0FBRCxDQUFqQjs7QUFDQSxNQUFNQyxDQUFDLEdBQUdELE9BQU8sQ0FBQyxRQUFELENBQWpCOztBQUVBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFpQkYsT0FBTyxDQUFDLHlCQUFELENBQTlCOztBQUNBLE1BQU07QUFBRUcsRUFBQUEsT0FBRjtBQUFXQyxFQUFBQSxnQkFBWDtBQUE2QkMsRUFBQUE7QUFB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QUFELEVBQU9DLEVBQVAsQ0FBOUIsQ0FEL0Q7O0FBR0EsTUFBTWUsa0JBQWtCLEdBQUcsQ0FBQ3pCLE9BQUQsRUFBVVMsSUFBVixLQUFtQlQsT0FBTyxDQUFDRSxNQUFSLENBQWUsZ0JBQWYsRUFBaUMsQ0FBQ08sSUFBRCxDQUFqQyxDQUE5Qzs7QUFFQXdGLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjNHLGNBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgcSA9IHJlcXVpcmUoJ3EnKTtcclxuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xyXG5cclxuY29uc3QgeyBnZXRQcmludGVyIH0gPSByZXF1aXJlKCcuLi91dGlscy9wcmludGVyRGV0YWlscycpO1xyXG5jb25zdCB7IEFjdGlvbnMsIE5ldHdvcmtTdGF0ZUVudW0sIEludmFsaWRQYXNzd29yZCB9ID0gcmVxdWlyZSgnLi4vY29uc3RhbnRzL25ldHdvcmtQcmVmZXJlbmNlcycpO1xyXG5cclxuY29uc3QgQWN0aW9uQ3JlYXRvcnMgPSBPYmplY3QuZnJlZXplKHtcclxuICAgIG5ldHdvcmtDaGFuZ2UocHJpbnRlcklkKSB7XHJcbiAgICAgICAgcmV0dXJuIHVwZGF0ZU5ldHdvcmtTdGF0ZSh0aGlzLmZsdXgsIHRoaXMuZGlzcGF0Y2gsIHByaW50ZXJJZCk7XHJcbiAgICB9LFxyXG5cclxuICAgIGVuYWJsZVdpZmkocHJpbnRlcklkKSB7XHJcbiAgICAgICAgY29uc3QgcHJpbnRlciA9IGdldFByaW50ZXIodGhpcy5mbHV4LCBwcmludGVySWQpO1xyXG5cclxuICAgICAgICB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuV2FpdGluZyk7XHJcblxyXG4gICAgICAgIHJldHVybiBwcmludGVyXHJcbiAgICAgICAgICAgIC5pbnZva2UoJ1dpZmlFbmFibGUnKVxyXG4gICAgICAgICAgICAudGhlbigoKSA9PiB1cGRhdGVOZXR3b3JrU3RhdGUodGhpcy5mbHV4LCB0aGlzLmRpc3BhdGNoLCBwcmludGVySWQpKVxyXG4gICAgICAgICAgICAuY2F0Y2goaGFuZGxlRXJyb3IodGhpcy5kaXNwYXRjaCkpXHJcbiAgICAgICAgICAgIC5kb25lKCk7XHJcbiAgICB9LFxyXG5cclxuICAgIGRpc2FibGVXaWZpKHByaW50ZXJJZCkge1xyXG4gICAgICAgIGNvbnN0IHByaW50ZXIgPSBnZXRQcmludGVyKHRoaXMuZmx1eCwgcHJpbnRlcklkKTtcclxuXHJcbiAgICAgICAgdGhpcy5kaXNwYXRjaChBY3Rpb25zLldhaXRpbmcpO1xyXG5cclxuICAgICAgICByZXR1cm4gcHJpbnRlclxyXG4gICAgICAgICAgICAuaW52b2tlKCdXaWZpRGlzYWJsZScpXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHVwZGF0ZU5ldHdvcmtTdGF0ZSh0aGlzLmZsdXgsIHRoaXMuZGlzcGF0Y2gsIHByaW50ZXJJZCkpXHJcbiAgICAgICAgICAgIC5jYXRjaChoYW5kbGVFcnJvcih0aGlzLmRpc3BhdGNoKSlcclxuICAgICAgICAgICAgLmRvbmUoKTtcclxuICAgIH0sXHJcblxyXG4gICAgY29ubmVjdFRvTmV0d29yayhwcmludGVySWQsIHBhdGgsIHB3KSB7XHJcbiAgICAgICAgY29uc3QgcHJpbnRlciA9IGdldFByaW50ZXIodGhpcy5mbHV4LCBwcmludGVySWQpO1xyXG4gICAgICAgIGNvbnN0IHRyYWNrRXZlbnQgPSB0cmFja2luZ0V2ZW50KHRoaXMuZmx1eCwgcHJpbnRlcik7XHJcbiAgICAgICAgY29uc3QgZm9yZ2V0ID0gQWN0aW9uQ3JlYXRvcnMuZm9yZ2V0TmV0d29yay5iaW5kKHRoaXMpO1xyXG5cclxuICAgICAgICB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuV2FpdGluZyk7XHJcblxyXG4gICAgICAgIHJldHVybiBjb25uZWN0VG9XaWZpKHByaW50ZXIsIHBhdGgsIHB3KVxyXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0cmFja0V2ZW50KCdQcmludGVyIFN1Y2Nlc3NmdWxseSBDb25uZWN0ZWQgdG8gV2lmaScpKVxyXG4gICAgICAgICAgICAudGhlbigoKSA9PiB1cGRhdGVOZXR3b3JrU3RhdGUodGhpcy5mbHV4LCB0aGlzLmRpc3BhdGNoLCBwcmludGVySWQpKVxyXG4gICAgICAgICAgICAuY2F0Y2goZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlcnIgPSBKU09OLnBhcnNlKGUubWVzc2FnZSkuZXJyb3I7XHJcbiAgICAgICAgICAgICAgICB0cmFja0V2ZW50KCdQcmludGVyIEZhaWxlZCB0byBDb25uZWN0IHRvIFdpZmknKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyLmNvZGUgPT09IEludmFsaWRQYXNzd29yZCkgcmV0dXJuIGZvcmdldChwYXRoKTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlRXJyb3IodGhpcy5kaXNwYXRjaCkoZXJyKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmRvbmUoKTtcclxuICAgIH0sXHJcblxyXG4gICAgZGlzY29ubmVjdEZyb21OZXR3b3JrKHByaW50ZXJJZCwgcGF0aCkge1xyXG4gICAgICAgIGNvbnN0IHByaW50ZXIgPSBnZXRQcmludGVyKHRoaXMuZmx1eCwgcHJpbnRlcklkKTtcclxuICAgICAgICBjb25zdCB0cmFja0V2ZW50ID0gdHJhY2tpbmdFdmVudCh0aGlzLmZsdXgsIHByaW50ZXIpO1xyXG5cclxuICAgICAgICByZXR1cm4gZGlzY29ubmVjdEZyb21XaWZpKHByaW50ZXIsIHBhdGgpXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHRyYWNrRXZlbnQoJ1ByaW50ZXIgU3VjY2Vzc2Z1bGx5IERpc2Nvbm5lY3RlZCBmcm9tIFdpZmknKSlcclxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdXBkYXRlTmV0d29ya1N0YXRlKHRoaXMuZmx1eCwgdGhpcy5kaXNwYXRjaCwgcHJpbnRlcklkKSlcclxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICB0cmFja0V2ZW50KCdQcmludGVyIEZhaWxlZCB0byBEaXNjb25uZWN0IGZyb20gV2lmaScpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUVycm9yKHRoaXMuZGlzcGF0Y2gpKGVycik7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5kb25lKCk7XHJcbiAgICB9LFxyXG5cclxuICAgIGZvcmdldE5ldHdvcmsocHJpbnRlcklkLCBwYXRoKSB7XHJcbiAgICAgICAgY29uc3QgcHJpbnRlciA9IGdldFByaW50ZXIodGhpcy5mbHV4LCBwcmludGVySWQpO1xyXG5cclxuICAgICAgICByZXR1cm4gcHJpbnRlclxyXG4gICAgICAgICAgICAuaW52b2tlKCdXaWZpRm9yZ2V0JywgW3BhdGhdKVxyXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuV2lmaUZvcmdldCkpXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHVwZGF0ZU5ldHdvcmtTdGF0ZSh0aGlzLmZsdXgsIHRoaXMuZGlzcGF0Y2gsIHByaW50ZXJJZCkpXHJcbiAgICAgICAgICAgIC5kb25lKCk7XHJcbiAgICB9LFxyXG5cclxuICAgIHNldFN0YXRpY0lQKHByaW50ZXJJZCwgcGF0aCwgaXAsIG5ldG1hc2ssIGdhdGV3YXksIGRuc1NlcnZlcnMsIHVzZV9zdGF0aWMgPSB0cnVlKSB7XHJcbiAgICAgICAgY29uc3QgcHJpbnRlciA9IGdldFByaW50ZXIodGhpcy5mbHV4LCBwcmludGVySWQpO1xyXG5cclxuICAgICAgICAvLyBzaW5jZSBtYW55IG9mIHRoZSBwYXJhbXMgZm9yIHRoaXMgZnVuY3Rpb24gYXJlIG9wdGlvbmFsIGluIGthaXRlblxyXG4gICAgICAgIC8vIEkgaGF2ZSB0byBtYXAgb3ZlciBhbmQgbWFrZSBzdXJlIGFueSB0aGF0IGFyZSBub3QgZXhwbGljdGx5IHNldFxyXG4gICAgICAgIC8vIHRvIGEgcmVhbCB2YWx1ZSBhcmUgY29udmVydGVkIHRvIGB1bmRlZmluZWRgLiBLYWl0ZW4gd2lsbCBoYW5kbGVcclxuICAgICAgICAvLyB0aGF0IGFwcHJvcHJpYXRlbHkuXHJcbiAgICAgICAgY29uc3QgYXJncyA9IF8ubWFwKFtpcCwgbmV0bWFzaywgZ2F0ZXdheSwgZG5zU2VydmVycywgdXNlX3N0YXRpY10sIGEgPT4gKGEgPT09IG51bGwgPyB1bmRlZmluZWQgOiBhKSk7XHJcblxyXG4gICAgICAgIHJldHVybiBwcmludGVyXHJcbiAgICAgICAgICAgIC5pbnZva2UoJ1NldFN0YXRpY0lwdjQnLCBbcGF0aCwgLi4uYXJnc10pXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuU2V0U3RhdGljSVAsIHtcclxuICAgICAgICAgICAgICAgICAgICBkbnNTZXJ2ZXJzLFxyXG4gICAgICAgICAgICAgICAgICAgIGVuYWJsZTogdXNlX3N0YXRpYyxcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgLmNhdGNoKGhhbmRsZUVycm9yKHRoaXMuZGlzcGF0Y2gpKVxyXG4gICAgICAgICAgICAuZG9uZSgpO1xyXG4gICAgfSxcclxuXHJcbiAgICBwcmVwb3B1bGF0ZVN0YXRpY0lQKHByaW50ZXJJZCwgcGF0aCkge1xyXG4gICAgICAgIC8vQ2xlYXIgY3VycmVudCBmaWVsZCB2YWx1ZXMgd2hpbGUgd2FpdGluZyBmb3IgdXBkYXRlXHJcbiAgICAgICAgdGhpcy5kaXNwYXRjaChBY3Rpb25zLlByZXBvcHVsYXRlU3RhdGljSVBGaWVsZHMsIHt9KTtcclxuICAgICAgICBpZiAocGF0aCkge1xyXG4gICAgICAgICAgICBjb25zdCBwcmludGVyID0gZ2V0UHJpbnRlcih0aGlzLmZsdXgsIHByaW50ZXJJZCk7XHJcbiAgICAgICAgICAgIHByaW50ZXJcclxuICAgICAgICAgICAgICAgIC5pbnZva2UoJ0dldFN0YXRpY0lwdjQnLCBbcGF0aF0pXHJcbiAgICAgICAgICAgICAgICAudGhlbihyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQudXNlX3N0YXRpYykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuUHJlcG9wdWxhdGVTdGF0aWNJUEZpZWxkcywgT2JqZWN0LmFzc2lnbih7fSwgcmVzdWx0KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5kb25lKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBjaGFuZ2VTdGF0aWNJUEFkZHJlc3MoaXBBZGRyZXNzKSB7XHJcbiAgICAgICAgdGhpcy5kaXNwYXRjaChBY3Rpb25zLkNoYW5nZVN0YXRpY0lQQWRkcmVzcywgeyBpcEFkZHJlc3MgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGNoYW5nZU5ldG1hc2sobmV0bWFzaykge1xyXG4gICAgICAgIHRoaXMuZGlzcGF0Y2goQWN0aW9ucy5DaGFuZ2VOZXRtYXNrLCB7IG5ldG1hc2sgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGNoYW5nZUdhdGV3YXkoZ2F0ZXdheSkge1xyXG4gICAgICAgIHRoaXMuZGlzcGF0Y2goQWN0aW9ucy5DaGFuZ2VHYXRld2F5LCB7IGdhdGV3YXkgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGNoYW5nZUROU1NlcnZlcnMoZG5zU2VydmVycykge1xyXG4gICAgICAgIHRoaXMuZGlzcGF0Y2goQWN0aW9ucy5DaGFuZ2VETlNTZXJ2ZXJzLCB7IGRuc1NlcnZlcnM6IF8udW5pcXVlKGRuc1NlcnZlcnMpIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBuZXdETlNJdGVtKGl0ZW0pIHtcclxuICAgICAgICB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuTmV3RE5TSXRlbSwgeyBpdGVtIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBzZWxlY3RETlNJdGVtKGl0ZW0pIHtcclxuICAgICAgICB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuU2VsZWN0RE5TSXRlbSwgeyBpdGVtIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBzZWxlY3ROZXR3b3JrKHBhdGgpIHtcclxuICAgICAgICB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuU2VsZWN0TmV0d29yaywgeyBwYXRoIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBjaGFuZ2VQYXNzd29yZEF0dGVtcHQocGFzc3dvcmQpIHtcclxuICAgICAgICB0aGlzLmRpc3BhdGNoKEFjdGlvbnMuQ2hhbmdlUGFzc3dvcmRBdHRlbXB0LCB7IHBhc3N3b3JkIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICB0b2dnbGVQYXNzd29yZFZpc2liaWxpdHkoKSB7XHJcbiAgICAgICAgdGhpcy5kaXNwYXRjaChBY3Rpb25zLlRvZ2dsZVBhc3N3b3JkVmlzaWJpbGl0eSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGNsZWFyRXJyb3IoKSB7XHJcbiAgICAgICAgdGhpcy5kaXNwYXRjaChBY3Rpb25zLkNsZWFyRXJyb3IpO1xyXG4gICAgfSxcclxufSk7XHJcblxyXG4vKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXHJcbi8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSEVMUEVSUyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi9cclxuLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xyXG5cclxuY29uc3QgaGFuZGxlRXJyb3IgPSBkaXNwYXRjaCA9PiBlcnJvciA9PiBkaXNwYXRjaChBY3Rpb25zLkVycm9yLCB7IGVycm9yIH0pO1xyXG5cclxuY29uc3QgZ2V0VHJhY2tpbmcgPSBmbHV4ID0+IGZsdXguZ2V0U2VydmljZSgnVHJhY2tpbmdTZXJ2aWNlJyk7XHJcblxyXG5jb25zdCB0cmFja2luZ0V2ZW50ID0gKGZsdXgsIHByaW50ZXIpID0+IG5hbWUgPT5cclxuICAgIGdldFRyYWNraW5nKGZsdXgpLmFkZEV2ZW50KF8ubWVyZ2UoeyBuYW1lIH0sIHByaW50ZXIuZ2V0VHJhY2tpbmdJbmZvKCkpKTtcclxuXHJcbmNvbnN0IGZldGNoQXZhaWxhYmxlTmV0d29ya3MgPSAoZmx1eCwgcHJpbnRlcklkKSA9PiBnZXRQcmludGVyKGZsdXgsIHByaW50ZXJJZCkuaW52b2tlKCdXaWZpU2NhbicpO1xyXG5cclxuY29uc3Qgc2V0QXNXaWZpID0gYWN0aW9uID0+IChmbHV4LCBkaXNwYXRjaCwgcHJpbnRlcklkLCBuZXR3b3JrU3RhdGUpID0+XHJcbiAgICBmZXRjaEF2YWlsYWJsZU5ldHdvcmtzKGZsdXgsIHByaW50ZXJJZClcclxuICAgICAgICAudGhlbihhdmFpbGFibGVOZXR3b3JrcyA9PiBkaXNwYXRjaChhY3Rpb24sIHsgcHJpbnRlcklkLCBhdmFpbGFibGVOZXR3b3JrcywgbmV0d29ya1N0YXRlIH0pKVxyXG4gICAgICAgIC5jYXRjaChoYW5kbGVFcnJvcihkaXNwYXRjaCkpXHJcbiAgICAgICAgLmRvbmUoKTtcclxuXHJcbmNvbnN0IHNldEFzRXRoZXJuZXRDb25uZWN0ZWQgPSAoZmx1eCwgZGlzcGF0Y2gsIHByaW50ZXJJZCwgbmV0d29ya1N0YXRlKSA9PlxyXG4gICAgZGlzcGF0Y2goQWN0aW9ucy5FdGhlcm5ldENvbm5lY3RlZCwgeyBwcmludGVySWQsIG5ldHdvcmtTdGF0ZSB9KTtcclxuXHJcbmNvbnN0IHNldEFzVW5jb25uZWN0ZWQgPSAoZmx1eCwgZGlzcGF0Y2gsIHByaW50ZXJJZCwgbmV0d29ya1N0YXRlKSA9PlxyXG4gICAgZGlzcGF0Y2goQWN0aW9ucy5VbmNvbm5lY3RlZCwgeyBwcmludGVySWQsIG5ldHdvcmtTdGF0ZSB9KTtcclxuXHJcbi8vIERlcGVuZGluZyBvbiB0aGUgY29ubmVjdGlvbiB0eXBlLCBkaWZmZXJlbnQgYmVoYXZpb3JzIGFyZSBuZWVkZWQuXHJcbi8vIEluc3RlYWQgb2YgaGF2aW5nIGEgbG9uZyBpZi1lbHNlIHRyZWUsIEkgdGhvdWdodCBhIGRlY2xhcmF0aXZlIGRpY3Rpb25hcnlcclxuLy8gd291bGQgYmUgZWFzaWVyIG9uIHRoZSBleWVzLlxyXG5jb25zdCBuZXR3b3JrU3RhdGVGbG93ID0gT2JqZWN0LmZyZWV6ZSh7XHJcbiAgICBbTmV0d29ya1N0YXRlRW51bS5zdGF0ZS5XSUZJXTogc2V0QXNXaWZpKEFjdGlvbnMuV2lmaUNvbm5lY3RlZCksXHJcbiAgICBbTmV0d29ya1N0YXRlRW51bS5zdGF0ZS5FVEhFUk5FVF06IHNldEFzRXRoZXJuZXRDb25uZWN0ZWQsXHJcbiAgICBbTmV0d29ya1N0YXRlRW51bS53aWZpLkVOQUJMRURdOiBzZXRBc1dpZmkoQWN0aW9ucy5XaWZpUmVhZHkpLFxyXG4gICAgW05ldHdvcmtTdGF0ZUVudW0ud2lmaS5ESVNBQkxFRF06IHNldEFzVW5jb25uZWN0ZWQsXHJcbn0pO1xyXG5cclxuLy8gR3JhYiB0aGUgYXBwcm9wcmlhdGUgc3RhdGUgdXBkYXRlciBmb3IgdGhlIGNvbm5lY3Rpb24gdHlwZVxyXG5jb25zdCBuZXR3b3JrU3RhdGVVcGRhdGVyID0gKGZsdXgsIGRpc3BhdGNoLCBwcmludGVySWQpID0+IG5ldHdvcmtTdGF0ZSA9PiB7XHJcbiAgICBjb25zdCBjb25uRnVuYyA9IG5ldHdvcmtTdGF0ZUZsb3dbbmV0d29ya1N0YXRlLnN0YXRlXSB8fCBuZXR3b3JrU3RhdGVGbG93W25ldHdvcmtTdGF0ZS53aWZpXTtcclxuXHJcbiAgICByZXR1cm4gY29ubkZ1bmMoZmx1eCwgZGlzcGF0Y2gsIHByaW50ZXJJZCwgbmV0d29ya1N0YXRlKTtcclxufTtcclxuXHJcbmNvbnN0IHVwZGF0ZU5ldHdvcmtTdGF0ZSA9IChmbHV4LCBkaXNwYXRjaCwgcHJpbnRlcklkKSA9PiB7XHJcbiAgICBjb25zdCBwcmludGVyID0gZ2V0UHJpbnRlcihmbHV4LCBwcmludGVySWQpO1xyXG4gICAgY29uc3QgdXBkYXRlU3RhdGUgPSBuZXR3b3JrU3RhdGVVcGRhdGVyKGZsdXgsIGRpc3BhdGNoLCBwcmludGVySWQpO1xyXG5cclxuICAgIGlmIChwcmludGVyLmlzQXV0aGVudGljYXRlZCgpKVxyXG4gICAgICAgIHJldHVybiBwcmludGVyXHJcbiAgICAgICAgICAgIC5pbnZva2UoJ05ldHdvcmtTdGF0ZScpXHJcbiAgICAgICAgICAgIC50aGVuKHVwZGF0ZVN0YXRlKVxyXG4gICAgICAgICAgICAuY2F0Y2goaGFuZGxlRXJyb3IoZGlzcGF0Y2gpKVxyXG4gICAgICAgICAgICAuZG9uZSgpO1xyXG5cclxuICAgIHJldHVybiBxKClcclxuICAgICAgICAudGhlbigoKSA9PiBkaXNwYXRjaChBY3Rpb25zLldhaXRpbmcpKVxyXG4gICAgICAgIC5kb25lKCk7XHJcbn07XHJcblxyXG5jb25zdCBjb25uZWN0VG9XaWZpID0gKHByaW50ZXIsIHBhdGgsIHB3KSA9PlxyXG4gICAgXy5zaXplKHB3KSA9PT0gMCA/IHByaW50ZXIuaW52b2tlKCdXaWZpQ29ubmVjdCcsIFtwYXRoXSkgOiBwcmludGVyLmludm9rZSgnV2lmaUNvbm5lY3QnLCBbcGF0aCwgcHddKTtcclxuXHJcbmNvbnN0IGRpc2Nvbm5lY3RGcm9tV2lmaSA9IChwcmludGVyLCBwYXRoKSA9PiBwcmludGVyLmludm9rZSgnV2lmaURpc2Nvbm5lY3QnLCBbcGF0aF0pO1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBBY3Rpb25DcmVhdG9ycztcclxuIl19
