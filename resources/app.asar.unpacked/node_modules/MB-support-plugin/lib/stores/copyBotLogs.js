'use strict';

const R = require('ramda');

const {
  createStore
} = require('fluxxor');

const {
  Actions,
  CHANGE_EVENT
} = require('../constants/copyBotLogs');

const {
  getLogging,
  safeKey,
  getSafeKeyProp,
  setSafeKeyProp,
  removeSafeKeyProp,
  appendSafeKey,
  removeSafeKey
} = require('../util'); // A map whose keys are a printer's id (string) and a path to a temp file on
// the user's computer (string) after the transfer from the bot.


let logsCache = {}; // A list of printer id's that are currently copying bot logs to the user's
// computer

let isCopyingList = []; // A map whose keys are a printer's id (string) and any error that occurred
// while zipping, transferring, saving or sending the bot logs

let errors = {};

const isCopying = printerId => isCopyingList.includes(safeKey(printerId));

module.exports = createStore({
  actions: {
    [Actions.CopyStart]: 'onCopyStart',
    [Actions.CopySuccess]: 'onCopySuccess',
    [Actions.CopyFail]: 'onCopyFail',
    [Actions.SendToSupportSuccess]: 'onSendToSupportSuccess',
    [Actions.SendToSupportFail]: 'onSendToSupportFail',
    [Actions.Save]: 'onSave',
    [Actions.NoFile]: 'onNoFile',
    [Actions.Timeout]: 'onTimeout'
  },

  getTmpPath(printerId) {
    return getSafeKeyProp(printerId, logsCache);
  },

  getState(printerId) {
    return {
      printerId,
      tmpPath: getSafeKeyProp(printerId, logsCache),
      isCopying: isCopying(printerId),
      error: getSafeKeyProp(printerId, errors)
    };
  },

  onCopyStart({
    printerId
  }) {
    isCopyingList = R.uniq(appendSafeKey(printerId, isCopyingList));
    errors = removeSafeKeyProp(printerId, errors);
    this.emit(CHANGE_EVENT);
  },

  onCopySuccess({
    printerId,
    tmpPath
  }) {
    logsCache = setSafeKeyProp(printerId, tmpPath, logsCache);
    isCopyingList = removeSafeKey(printerId, isCopyingList);
    errors = removeSafeKeyProp(printerId, errors);
    this.emit(CHANGE_EVENT);
  },

  onCopyFail({
    printerId,
    err
  }) {
    const logger = getLogging(this.flux);
    errors = setSafeKeyProp(printerId, err, errors);
    isCopyingList = removeSafeKey(printerId, isCopyingList);
    logger.error(err);
    this.emit(CHANGE_EVENT);
  },

  onSendToSupportSuccess({
    printerId
  }) {
    errors = removeSafeKeyProp(printerId, errors);
    this.emit(CHANGE_EVENT);
  },

  onSendToSupportFail({
    printerId,
    err
  }) {
    const logger = getLogging(this.flux);
    errors = setSafeKeyProp(printerId, err, errors);
    logger.error(err);
    this.emit(CHANGE_EVENT);
  },

  onSave({
    printerId
  }) {
    errors = removeSafeKeyProp(printerId, errors);
    this.emit(CHANGE_EVENT);
  },

  onNoFile({
    printerId,
    tmpPath
  }) {
    const logger = getLogging(this.flux);
    const err = new Error('The temporary file no longer exists. Try again.');
    logsCache = removeSafeKeyProp(printerId, logsCache);
    isCopyingList = removeSafeKey(printerId, isCopyingList);
    errors = setSafeKeyProp(printerId, err, errors);
    logger.error(err, tmpPath);
    this.emit(CHANGE_EVENT);
  },

  onTimeout({
    printerId,
    err
  }) {
    const logger = getLogging(this.flux); // If we're not currently copying for this printer, then just
    // move along. No reason to record the error here.

    if (!isCopying(printerId)) return;
    logsCache = removeSafeKeyProp(printerId, logsCache);
    isCopyingList = removeSafeKey(printerId, isCopyingList);
    errors = setSafeKeyProp(printerId, err, errors);
    logger.error(err);
    this.emit(CHANGE_EVENT);
  }

});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcHlCb3RMb2dzLmpzIl0sIm5hbWVzIjpbIlIiLCJyZXF1aXJlIiwiY3JlYXRlU3RvcmUiLCJBY3Rpb25zIiwiQ0hBTkdFX0VWRU5UIiwiZ2V0TG9nZ2luZyIsInNhZmVLZXkiLCJnZXRTYWZlS2V5UHJvcCIsInNldFNhZmVLZXlQcm9wIiwicmVtb3ZlU2FmZUtleVByb3AiLCJhcHBlbmRTYWZlS2V5IiwicmVtb3ZlU2FmZUtleSIsImxvZ3NDYWNoZSIsImlzQ29weWluZ0xpc3QiLCJlcnJvcnMiLCJpc0NvcHlpbmciLCJwcmludGVySWQiLCJpbmNsdWRlcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJhY3Rpb25zIiwiQ29weVN0YXJ0IiwiQ29weVN1Y2Nlc3MiLCJDb3B5RmFpbCIsIlNlbmRUb1N1cHBvcnRTdWNjZXNzIiwiU2VuZFRvU3VwcG9ydEZhaWwiLCJTYXZlIiwiTm9GaWxlIiwiVGltZW91dCIsImdldFRtcFBhdGgiLCJnZXRTdGF0ZSIsInRtcFBhdGgiLCJlcnJvciIsIm9uQ29weVN0YXJ0IiwidW5pcSIsImVtaXQiLCJvbkNvcHlTdWNjZXNzIiwib25Db3B5RmFpbCIsImVyciIsImxvZ2dlciIsImZsdXgiLCJvblNlbmRUb1N1cHBvcnRTdWNjZXNzIiwib25TZW5kVG9TdXBwb3J0RmFpbCIsIm9uU2F2ZSIsIm9uTm9GaWxlIiwiRXJyb3IiLCJvblRpbWVvdXQiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLENBQUMsR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FBakI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWtCRCxPQUFPLENBQUMsU0FBRCxDQUEvQjs7QUFFQSxNQUFNO0FBQUVFLEVBQUFBLE9BQUY7QUFBV0MsRUFBQUE7QUFBWCxJQUE0QkgsT0FBTyxDQUFDLDBCQUFELENBQXpDOztBQUNBLE1BQU07QUFDRkksRUFBQUEsVUFERTtBQUVGQyxFQUFBQSxPQUZFO0FBR0ZDLEVBQUFBLGNBSEU7QUFJRkMsRUFBQUEsY0FKRTtB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QVosQ0FBN0I7QUFDQUMsSUFBQUEsYUFBYSxHQUFHRixhQUFhLENBQUNLLFNBQUQsRUFBWUgsYUFBWixDQUE3QjtBQUNBQyxJQUFBQSxNQUFNLEdBQUdOLGNBQWMsQ0FBQ1EsU0FBRCxFQUFZc0IsR0FBWixFQUFpQnhCLE1BQWpCLENBQXZCO0FBRUF5QixJQUFBQSxNQUFNLENBQUNQLEtBQVAsQ0FBYU0sR0FBYixFQUFrQlAsT0FBbEI7QUFFQSxTQUFLSSxJQUFMLENBQVUvQixZQUFWO0FBQ0gsR0FsRndCOztBQW9GekIwQyxFQUFBQSxTQUFTLENBQUM7QUFBRTlCLElBQUFBLFNBQUY7QUFBYXNCLElBQUFBO0FBQWIsR0FBRCxFQUFxQjtBQUMxQixVQUFNQyxNQUFNLEdBQUdsQyxVQUFVLENBQUMsS0FBS21DLElBQU4sQ0FBekIsQ0FEMEIsQ0FHMUI7QUFDQTs7QUFDQSxRQUFJLENBQUN6QixTQUFTLENBQUNDLFNBQUQsQ0FBZCxFQUEyQjtBQUUzQkosSUFBQUEsU0FBUyxHQUFHSCxpQkFBaUIsQ0FBQ08sU0FBRCxFQUFZSixTQUFaLENBQTdCO0FBQ0FDLElBQUFBLGFBQWEsR0FBR0YsYUFBYSxDQUFDSyxTQUFELEVBQVlILGFBQVosQ0FBN0I7QUFDQUMsSUFBQUEsTUFBTSxHQUFHTixjQUFjLENBQUNRLFNBQUQsRUFBWXNCLEdBQVosRUFBaUJ4QixNQUFqQixDQUF2QjtBQUVBeUIsSUFBQUEsTUFBTSxDQUFDUCxLQUFQLENBQWFNLEdBQWI7QUFFQSxTQUFLSCxJQUFMLENBQVUvQixZQUFWO0FBQ0g7O0FBbEd3QixDQUFELENBQTVCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgUiA9IHJlcXVpcmUoJ3JhbWRhJyk7XHJcbmNvbnN0IHsgY3JlYXRlU3RvcmUgfSA9IHJlcXVpcmUoJ2ZsdXh4b3InKTtcclxuXHJcbmNvbnN0IHsgQWN0aW9ucywgQ0hBTkdFX0VWRU5UIH0gPSByZXF1aXJlKCcuLi9jb25zdGFudHMvY29weUJvdExvZ3MnKTtcclxuY29uc3Qge1xyXG4gICAgZ2V0TG9nZ2luZyxcclxuICAgIHNhZmVLZXksXHJcbiAgICBnZXRTYWZlS2V5UHJvcCxcclxuICAgIHNldFNhZmVLZXlQcm9wLFxyXG4gICAgcmVtb3ZlU2FmZUtleVByb3AsXHJcbiAgICBhcHBlbmRTYWZlS2V5LFxyXG4gICAgcmVtb3ZlU2FmZUtleSxcclxufSA9IHJlcXVpcmUoJy4uL3V0aWwnKTtcclxuXHJcbi8vIEEgbWFwIHdob3NlIGtleXMgYXJlIGEgcHJpbnRlcidzIGlkIChzdHJpbmcpIGFuZCBhIHBhdGggdG8gYSB0ZW1wIGZpbGUgb25cclxuLy8gdGhlIHVzZXIncyBjb21wdXRlciAoc3RyaW5nKSBhZnRlciB0aGUgdHJhbnNmZXIgZnJvbSB0aGUgYm90LlxyXG5sZXQgbG9nc0NhY2hlID0ge307XHJcblxyXG4vLyBBIGxpc3Qgb2YgcHJpbnRlciBpZCdzIHRoYXQgYXJlIGN1cnJlbnRseSBjb3B5aW5nIGJvdCBsb2dzIHRvIHRoZSB1c2VyJ3NcclxuLy8gY29tcHV0ZXJcclxubGV0IGlzQ29weWluZ0xpc3QgPSBbXTtcclxuXHJcbi8vIEEgbWFwIHdob3NlIGtleXMgYXJlIGEgcHJpbnRlcidzIGlkIChzdHJpbmcpIGFuZCBhbnkgZXJyb3IgdGhhdCBvY2N1cnJlZFxyXG4vLyB3aGlsZSB6aXBwaW5nLCB0cmFuc2ZlcnJpbmcsIHNhdmluZyBvciBzZW5kaW5nIHRoZSBib3QgbG9nc1xyXG5sZXQgZXJyb3JzID0ge307XHJcblxyXG5jb25zdCBpc0NvcHlpbmcgPSBwcmludGVySWQgPT4gaXNDb3B5aW5nTGlzdC5pbmNsdWRlcyhzYWZlS2V5KHByaW50ZXJJZCkpO1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBjcmVhdGVTdG9yZSh7XHJcbiAgICBhY3Rpb25zOiB7XHJcbiAgICAgICAgW0FjdGlvbnMuQ29weVN0YXJ0XTogJ29uQ29weVN0YXJ0JyxcclxuICAgICAgICBbQWN0aW9ucy5Db3B5U3VjY2Vzc106ICdvbkNvcHlTdWNjZXNzJyxcclxuICAgICAgICBbQWN0aW9ucy5Db3B5RmFpbF06ICdvbkNvcHlGYWlsJyxcclxuICAgICAgICBbQWN0aW9ucy5TZW5kVG9TdXBwb3J0U3VjY2Vzc106ICdvblNlbmRUb1N1cHBvcnRTdWNjZXNzJyxcclxuICAgICAgICBbQWN0aW9ucy5TZW5kVG9TdXBwb3J0RmFpbF06ICdvblNlbmRUb1N1cHBvcnRGYWlsJyxcclxuICAgICAgICBbQWN0aW9ucy5TYXZlXTogJ29uU2F2ZScsXHJcbiAgICAgICAgW0FjdGlvbnMuTm9GaWxlXTogJ29uTm9GaWxlJyxcclxuICAgICAgICBbQWN0aW9ucy5UaW1lb3V0XTogJ29uVGltZW91dCcsXHJcbiAgICB9LFxyXG5cclxuICAgIGdldFRtcFBhdGgocHJpbnRlcklkKSB7XHJcbiAgICAgICAgcmV0dXJuIGdldFNhZmVLZXlQcm9wKHByaW50ZXJJZCwgbG9nc0NhY2hlKTtcclxuICAgIH0sXHJcblxyXG4gICAgZ2V0U3RhdGUocHJpbnRlcklkKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgcHJpbnRlcklkLFxyXG4gICAgICAgICAgICB0bXBQYXRoOiBnZXRTYWZlS2V5UHJvcChwcmludGVySWQsIGxvZ3NDYWNoZSksXHJcbiAgICAgICAgICAgIGlzQ29weWluZzogaXNDb3B5aW5nKHByaW50ZXJJZCksXHJcbiAgICAgICAgICAgIGVycm9yOiBnZXRTYWZlS2V5UHJvcChwcmludGVySWQsIGVycm9ycyksXHJcbiAgICAgICAgfTtcclxuICAgIH0sXHJcblxyXG4gICAgb25Db3B5U3RhcnQoeyBwcmludGVySWQgfSkge1xyXG4gICAgICAgIGlzQ29weWluZ0xpc3QgPSBSLnVuaXEoYXBwZW5kU2FmZUtleShwcmludGVySWQsIGlzQ29weWluZ0xpc3QpKTtcclxuICAgICAgICBlcnJvcnMgPSByZW1vdmVTYWZlS2V5UHJvcChwcmludGVySWQsIGVycm9ycyk7XHJcblxyXG4gICAgICAgIHRoaXMuZW1pdChDSEFOR0VfRVZFTlQpO1xyXG4gICAgfSxcclxuXHJcbiAgICBvbkNvcHlTdWNjZXNzKHsgcHJpbnRlcklkLCB0bXBQYXRoIH0pIHtcclxuICAgICAgICBsb2dzQ2FjaGUgPSBzZXRTYWZlS2V5UHJvcChwcmludGVySWQsIHRtcFBhdGgsIGxvZ3NDYWNoZSk7XHJcbiAgICAgICAgaXNDb3B5aW5nTGlzdCA9IHJlbW92ZVNhZmVLZXkocHJpbnRlcklkLCBpc0NvcHlpbmdMaXN0KTtcclxuICAgICAgICBlcnJvcnMgPSByZW1vdmVTYWZlS2V5UHJvcChwcmludGVySWQsIGVycm9ycyk7XHJcblxyXG4gICAgICAgIHRoaXMuZW1pdChDSEFOR0VfRVZFTlQpO1xyXG4gICAgfSxcclxuXHJcbiAgICBvbkNvcHlGYWlsKHsgcHJpbnRlcklkLCBlcnIgfSkge1xyXG4gICAgICAgIGNvbnN0IGxvZ2dlciA9IGdldExvZ2dpbmcodGhpcy5mbHV4KTtcclxuXHJcbiAgICAgICAgZXJyb3JzID0gc2V0U2FmZUtleVByb3AocHJpbnRlcklkLCBlcnIsIGVycm9ycyk7XHJcbiAgICAgICAgaXNDb3B5aW5nTGlzdCA9IHJlbW92ZVNhZmVLZXkocHJpbnRlcklkLCBpc0NvcHlpbmdMaXN0KTtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoZXJyKTtcclxuXHJcbiAgICAgICAgdGhpcy5lbWl0KENIQU5HRV9FVkVOVCk7XHJcbiAgICB9LFxyXG5cclxuICAgIG9uU2VuZFRvU3VwcG9ydFN1Y2Nlc3MoeyBwcmludGVySWQgfSkge1xyXG4gICAgICAgIGVycm9ycyA9IHJlbW92ZVNhZmVLZXlQcm9wKHByaW50ZXJJZCwgZXJyb3JzKTtcclxuXHJcbiAgICAgICAgdGhpcy5lbWl0KENIQU5HRV9FVkVOVCk7XHJcbiAgICB9LFxyXG5cclxuICAgIG9uU2VuZFRvU3VwcG9ydEZhaWwoeyBwcmludGVySWQsIGVyciB9KSB7XHJcbiAgICAgICAgY29uc3QgbG9nZ2VyID0gZ2V0TG9nZ2luZyh0aGlzLmZsdXgpO1xyXG5cclxuICAgICAgICBlcnJvcnMgPSBzZXRTYWZlS2V5UHJvcChwcmludGVySWQsIGVyciwgZXJyb3JzKTtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoZXJyKTtcclxuXHJcbiAgICAgICAgdGhpcy5lbWl0KENIQU5HRV9FVkVOVCk7XHJcbiAgICB9LFxyXG5cclxuICAgIG9uU2F2ZSh7IHByaW50ZXJJZCB9KSB7XHJcbiAgICAgICAgZXJyb3JzID0gcmVtb3ZlU2FmZUtleVByb3AocHJpbnRlcklkLCBlcnJvcnMpO1xyXG5cclxuICAgICAgICB0aGlzLmVtaXQoQ0hBTkdFX0VWRU5UKTtcclxuICAgIH0sXHJcblxyXG4gICAgb25Ob0ZpbGUoeyBwcmludGVySWQsIHRtcFBhdGggfSkge1xyXG4gICAgICAgIGNvbnN0IGxvZ2dlciA9IGdldExvZ2dpbmcodGhpcy5mbHV4KTtcclxuICAgICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoJ1RoZSB0ZW1wb3JhcnkgZmlsZSBubyBsb25nZXIgZXhpc3RzLiBUcnkgYWdhaW4uJyk7XHJcblxyXG4gICAgICAgIGxvZ3NDYWNoZSA9IHJlbW92ZVNhZmVLZXlQcm9wKHByaW50ZXJJZCwgbG9nc0NhY2hlKTtcclxuICAgICAgICBpc0NvcHlpbmdMaXN0ID0gcmVtb3ZlU2FmZUtleShwcmludGVySWQsIGlzQ29weWluZ0xpc3QpO1xyXG4gICAgICAgIGVycm9ycyA9IHNldFNhZmVLZXlQcm9wKHByaW50ZXJJZCwgZXJyLCBlcnJvcnMpO1xyXG5cclxuICAgICAgICBsb2dnZXIuZXJyb3IoZXJyLCB0bXBQYXRoKTtcclxuXHJcbiAgICAgICAgdGhpcy5lbWl0KENIQU5HRV9FVkVOVCk7XHJcbiAgICB9LFxyXG5cclxuICAgIG9uVGltZW91dCh7IHByaW50ZXJJZCwgZXJyIH0pIHtcclxuICAgICAgICBjb25zdCBsb2dnZXIgPSBnZXRMb2dnaW5nKHRoaXMuZmx1eCk7XHJcblxyXG4gICAgICAgIC8vIElmIHdlJ3JlIG5vdCBjdXJyZW50bHkgY29weWluZyBmb3IgdGhpcyBwcmludGVyLCB0aGVuIGp1c3RcclxuICAgICAgICAvLyBtb3ZlIGFsb25nLiBObyByZWFzb24gdG8gcmVjb3JkIHRoZSBlcnJvciBoZXJlLlxyXG4gICAgICAgIGlmICghaXNDb3B5aW5nKHByaW50ZXJJZCkpIHJldHVybjtcclxuXHJcbiAgICAgICAgbG9nc0NhY2hlID0gcmVtb3ZlU2FmZUtleVByb3AocHJpbnRlcklkLCBsb2dzQ2FjaGUpO1xyXG4gICAgICAgIGlzQ29weWluZ0xpc3QgPSByZW1vdmVTYWZlS2V5KHByaW50ZXJJZCwgaXNDb3B5aW5nTGlzdCk7XHJcbiAgICAgICAgZXJyb3JzID0gc2V0U2FmZUtleVByb3AocHJpbnRlcklkLCBlcnIsIGVycm9ycyk7XHJcblxyXG4gICAgICAgIGxvZ2dlci5lcnJvcihlcnIpO1xyXG5cclxuICAgICAgICB0aGlzLmVtaXQoQ0hBTkdFX0VWRU5UKTtcclxuICAgIH0sXHJcbn0pO1xyXG4iXX0=
