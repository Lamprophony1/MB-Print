'use strict';

const q = require('q');

const path = require('path');

const _ = require('lodash');

const analyticUtils = require('eagle-print/util/analyticUtils');

const PrinterProvider = require('eagle-print/services/providers/printerProvider').default;

const PrinterManager = require('./printerManager');

const StoredPrintersManager = require('./stored_printers_manager');

const Errors = require('./errors');

const croissant = require('./croissant');

const constants = require('./constants');

const util = require('./util');

class MBPrinterProvider extends PrinterProvider {
  constructor(clientSecret) {
    super();
    this._logger = console;
    this._clientSecret = clientSecret;
    this._storedPrintersManager = new StoredPrintersManager();
    this._fluxMethods = {}; // because for a real start, we need the flux methods to have been set,
    // but that happens after start for printerProvider gets called...

    const self = this;
    this._initDoneDeferred = q.defer();

    this._initDoneDeferred.promise.then(function () {
      self._fluxMethods.clearPrintersMethod();

      return self._getPrinterManager().start(clientSecret);
    }).done();
  }

  _getPrinterManager() {
    if (!this._printerManager) {
      const printerManager = new PrinterManager(this._parameterService, this._logger, this._tvApiClient, this._trackingService, this._userInfo, this._userToken, this._storedPrintersManager);
      printerManager.on('add_printer', printer => {
        if (this._fluxMethods.addPrinterMethod) this._fluxMethods.addPrinterMethod(printer);
      });
      printerManager.on('remove_printer', printer => {
        if (this._fluxMethods.removePrinterMethod) this._fluxMethods.removePrinterMethod(printer);
      });
      printerManager.on('update_printer_list', () => {
        if (this._fluxMethods.getPrintersMethod) this._fluxMethods.getPrintersMethod();
      });
      this._printerManager = printerManager;
    }

    return this._printerManager;
  }

  setTvApiClient(tvApiClient) {
    this._tvApiClient = tvApiClient;
  }

  setParameterService(parameterService) {
    this._parameterService = parameterService;
  }

  setTrackingService(trackingService) {
    this._trackingService = trackingService;
  }

  stop() {
    // stop the stored printers manager; all write requests after this gets
    // called will be ignored.
    return this._storedPrintersManager.stop();
  }

  init(userInfo, token) {
    const self = this;
    this._userInfo = userInfo;
    this._userToken = token;
    return this._storedPrintersManager.loadSavedPrinters().then(function () {
      return self._getPrinterManager().init();
    });
  }

  userChanged(userInfo, token) {
    const self = this;
    this._userInfo = userInfo;
    this._userToken = token;
    const oldPrinterManager = this._printerManager;
    this._printerManager = null;

    this._fluxMethods.clearPrintersMethod();

    this._getPrinterManager().init().then(function () {
      if (oldPrinterManager) return oldPrinterManager.stop();
    }).then(function () {
      return self._printerManager.start(self._clientSecret);
    }).done();
  }

  finishInit(addPrinterMethod, removePrinterMethod, clearPrintersMethod, getPrintersMethod) {
    this._fluxMethods.addPrinterMethod = addPrinterMethod;
    this._fluxMethods.removePrinterMethod = removePrinterMethod;
    this._fluxMethods.clearPrintersMethod = clearPrintersMethod;
    this._fluxMethods.getPrintersMethod = getPrintersMethod;

    this._initDoneDeferred.resolve();
  }

  setLogger(logger) {
    this._logger = logger;

    this._storedPrintersManager.setLogger(logger);

    this._logger.info('MakerBot PrinterServiceProvider set logger'); // set log for croissant


    const logPath = this._logger.bunyanLogger.getLogFilePath(); // Note: path.dirname(undefined) === '.'
    // If inside asar -> can cause Croissant native code to crash


    const logDir = path.dirname(logPath);

    if (!logPath || !logDir || '.' === logDir) {
      // GC-30551 Avoid feeding values to native module that can crash it
      this._logger.error(`Cannot determine normal directory for Croissant logs.  Logs may be lost.  path=${logPath} dir=${logDir}`);
    } else {
      croissant.createLog(logDir);
    }
  }

  getPrinter(uid) {
    return q(this._printerManager.getPrinter(uid));
  }

  getPrinters(refresh, callback) {
    // looks like sometimes this gets called before start has finished...
    if (!this._printerManager) return q([]);
    return q(this._printerManager.getPrinters()).nodeify(callback);
  }
  /**
   * @param printerUrl {string} - URL to the printer that should be added to this provider, if acceptable.
   * @param callback {function}
   */


  addPrinter(ip, callback) {
    // this should be fixed somewhere else and not hacked into here.
    // please don't let this stay here :(
    ip = ip.replace('ip://', '');
    return this._printerManager.addByIp(ip).nodeify(callback);
  }

  addOfflinePrinter(vendorName, genderName, callback) {
    return this._printerManager.addArchetypePrinter(vendorName, genderName).nodeify(callback);
  }

  authenticate(printer) {
    // Remove any previous auth errors
    printer.removeError(Errors.MBPluginError.GeneralAuthError.error_id);
    return this._printerManager.authenticate(printer).then(authRes => {
      if (authRes.wasNewAuth && printer.getConnectionType() === constants.PrinterConnTypeEnum.NETWORK) {
        // we're not returning this guy because we don't care to wait for
        // this to pass or fail before reporting the result of auth
        printer.invoke('NetworkState').then(networkState => {
          const trackingInfo = util.trackingInfoForPrinter(printer);
          trackingInfo.name = 'Printer Authenticated ';

          if (networkState.state === constants.NetworkStateEnum.state.WIFI) {
            trackingInfo.name += 'Wi-Fi';
          } else if (networkState.state === constants.NetworkStateEnum.state.ETHERNET) {
            trackingInfo.name += 'Ethernet';
          }

          this._trackingService.addEvent(trackingInfo);
        }).done();
      }
    }).catch(function (err) {
      printer.addError(Errors.getPluginError(Errors.MBPluginError.GeneralAuthError));
      throw 'Authorization error or manually cancelled';
    });
  }

  deauthenticate(printer) {
    return this._printerManager.deauthenticate(printer);
  }

  print(printer, toolPath, progressCallback, cancelToken, flux = {}) {
    const trackingInfo = util.trackingInfoForPrinter(printer);
    const printSettings = analyticUtils.getPrintSettingsForAnalyticEvents(flux, printer);
    trackingInfo.name = 'Print File Transfer Started';

    this._trackingService.addEvent(_.merge(trackingInfo, printSettings));

    cancelToken.once('cancel', () => {});
    return printer.sendPrintFile(toolPath, progressCallback, cancelToken).then(() => {
      const trackingInfo = util.trackingInfoForPrinter(printer);
      trackingInfo.name = 'Print File Transfer Completed';

      this._trackingService.addEvent(_.merge(trackingInfo, printSettings));
    }).catch(err => {
      const trackingInfo = util.trackingInfoForPrinter(printer);
      trackingInfo.name = `Print File Transfer ${err.type === 'cancel' ? 'Cancelled' : 'Failed'}`;

      this._trackingService.addEvent(_.merge(trackingInfo, printSettings));

      throw err;
    });
  }
  /**
   * @param printerUrl {string} - URL to a printer.
   * @returns {boolean} - True  = The given printer URL can be added to this printer provider.
   *                      False = The given printer URL cannot be added to this printer provider.
   */


  accept(ip) {
    // check that it's a valid ip
    const splitIp = ip.split('.');
    if (splitIp.length != 4) return false;

    for (let i = 0; i < splitIp.length; i++) {
      if (parseInt(splitIp[i]) < 0 || parseInt(splitIp[i]) > 256) {
        return false;
      }
    }

    return true;
  }

  convertToArchetypeId(printerId) {
    const PID = printerId.split(':').slice(1, 2);
    const genderName = constants.PIDtoGenderName[PID];
    const vendorName = constants.VendorName;
    return `offline:${vendorName}:${genderName}:${genderName}`;
  }

}

module.exports = MBPrinterProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByaW50ZXItc2VydmljZS1wcm92aWRlci5qcyJdLCJuYW1lcyI6WyJxIiwicmVxdWlyZSIsInBhdGgiLCJfIiwiYW5hbHl0aWNVdGlscyIsIlByaW50ZXJQcm92aWRlciIsImRlZmF1bHQiLCJQcmludGVyTWFuYWdlciIsIlN0b3JlZFByaW50ZXJzTWFuYWdlciIsIkVycm9ycyIsImNyb2lzc2FudCIsImNvbnN0YW50cyIsInV0aWwiLCJNQlByaW50ZXJQcm92aWRlciIsImNvbnN0cnVjdG9yIiwiY2xpZW50U2VjcmV0IiwiX2xvZ2dlciIsImNvbnNvbGUiLCJfY2xpZW50U2VjcmV0IiwiX3N0b3JlZFByaW50ZXJzTWFuYWdlciIsIl9mbHV4TWV0aG9kcyIsInNlbGYiLCJfaW5pdERvbmVEZWZlcnJlZCIsImRlZmVyIiwicHJvbWlzZSIsInRoZW4iLCJjbGVhclByaW50ZXJzTWV0aG9kIiwiX2dldFByaW50ZXJNYW5hZ2VyIiwic3RhcnQiLCJkb25lIiwiX3ByaW50ZXJNYW5hZ2VyIiwicHJpbnRlck1hbmFnZXIiLCJfcGFyYW1ldGVyU2VydmljZSIsIl90dkFwaUNsaWVudCIsIl90cmFja2luZ1NlcnZpY2UiLCJfdXNlckluZm8iLCJfdXNlclRva2VuIiwib24iLCJwcmludGVyIiwiYWRkUHJpbnRlck1ldGhvZCIsInJlbW92ZVByaW50ZXJNZXRob2QiLCJnZXRQcmludGVyc01ldGhvZCIsInNldFR2QXBpQ2xpZW50IiwidHZBcGlDbGllbnQiLCJzZXRQYXJhbWV0ZXJTZXJ2aWNlIiwicGFyYW1ldGVyU2VydmljZSIsInNldFRyYWNraW5nU2VydmljZSIsInRyYWNraW5nU2VydmljZSIsInN0b3AiLCJpbml0IiwidXNlckluZm8iLCJ0b2tlbiIsImxvYWRTYXZlZFByaW50ZXJzIiwidXNlckNoYW5nZWQiLCJvbGRQcmludGVyTWFuYWdlciIsImZpbmlzaEluaXQiLCJyZXNvbHZlIiwic2V0TG9nZ2VyIiwibG9nZ2VyIiwiaW5mbyIsImxvZ1BhdGgiLCJidW55YW5Mb2dnZXIiLCJnZXRMb2dGaWxlUGF0aCIsImxvZ0RpciIsImRpcm5hbWUiLCJlcnJvciIsImNyZWF0ZUxvZyIsImdldFByaW50ZXIiLCJ1aWQiLCJnZXRQcmludGVycyIsInJlZnJlc2giLCJjYWxsYmFjayIsIm5vZGVpZnkiLCJhZGRQcmludGVyIiwiaXAiLCJyZXBsYWNlIiwiYWRkQnlJcCIsImFkZE9mZmxpbmVQcmludGVyIiwidmVuZG9yTmFtZSIsImdlbmRlck5hbWUiLCJhZGRBcmNoZXR5cGVQcmludGVyIiwiYXV0aGVudGljYXRlIiwicmVtb3ZlRXJyb3IiLCJNQlBsdWdpbkVycm9yIiwiR2VuZXJhbEF1dGhFcnJvciIsImVycm9yX2lkIiwiYXV0aFJlcyIsIndhc05ld0F1dGgiLCJnZXRDb25uZWN0aW9uVHlwZSIsIlByaW50ZXJDb25uVHlwZUVudW0iLCJORVRXT1JLIiwiaW52b2tlIiwibmV0d29ya1N0YXRlIiwidHJhY2tpbmdJbmZvIiwidHJhY2tpbmdJbmZvRm9yUHJpbnRlciIsIm5hbWUiLCJzdGF0ZSIsIk5ldHdvcmtTdGF0ZUVudW0iLCJXSUZJIiwiRVRIRVJORVQiLCJhZGRFdmVudCIsImNhdGNoIiwiZXJyIiwiYWRkRXJyb3IiLCJnZXRQbHVnaW5FcnJvciIsImRlYXV0aGVudGljYXRlIiwicHJpbnQiLCJ0b29sUGF0aCIsInByb2dyZXNzQ2FsbGJhY2siLCJjYW5jZWxUb2tlbiIsImZsdXgiLCJwcmludFNldHRpbmdzIiwiZ2V0UHJpbnRTZXR0aW5nc0ZvckFuYWx5dGljRXZlbnRzIiwibWVyZ2UiLCJvbmNlIiwic2VuZFByaW50RmlsZSIsInR5cGUiLCJhY2NlcHQiLCJzcGxpdElwIiwic3BsaXQiLCJsZW5ndGgiLCJpIiwicGFyc2VJbnQiLCJjb252ZXJ0VG9BcmNoZXR5cGVJZCIsInByaW50ZXJJZCIsIlBJRCIsInNsaWNlIiwiUElEdG9HZW5kZXJOYW1lIiwiVmVuZG9yTmFtZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1B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clxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xyXG5jb25zdCBhbmFseXRpY1V0aWxzID0gcmVxdWlyZSgnZWFnbGUtcHJpbnQvdXRpbC9hbmFseXRpY1V0aWxzJyk7XHJcbmNvbnN0IFByaW50ZXJQcm92aWRlciA9IHJlcXVpcmUoJ2VhZ2xlLXByaW50L3NlcnZpY2VzL3Byb3ZpZGVycy9wcmludGVyUHJvdmlkZXInKS5kZWZhdWx0O1xyXG5cclxuY29uc3QgUHJpbnRlck1hbmFnZXIgPSByZXF1aXJlKCcuL3ByaW50ZXJNYW5hZ2VyJyk7XHJcbmNvbnN0IFN0b3JlZFByaW50ZXJzTWFuYWdlciA9IHJlcXVpcmUoJy4vc3RvcmVkX3ByaW50ZXJzX21hbmFnZXInKTtcclxuY29uc3QgRXJyb3JzID0gcmVxdWlyZSgnLi9lcnJvcnMnKTtcclxuY29uc3QgY3JvaXNzYW50ID0gcmVxdWlyZSgnLi9jcm9pc3NhbnQnKTtcclxuY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKTtcclxuY29uc3QgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpO1xyXG5cclxuY2xhc3MgTUJQcmludGVyUHJvdmlkZXIgZXh0ZW5kcyBQcmludGVyUHJvdmlkZXIge1xyXG4gICAgY29uc3RydWN0b3IoY2xpZW50U2VjcmV0KSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICB0aGlzLl9sb2dnZXIgPSBjb25zb2xlO1xyXG4gICAgICAgIHRoaXMuX2NsaWVudFNlY3JldCA9IGNsaWVudFNlY3JldDtcclxuICAgICAgICB0aGlzLl9zdG9yZWRQcmludGVyc01hbmFnZXIgPSBuZXcgU3RvcmVkUHJpbnRlcnNNYW5hZ2VyKCk7XHJcblxyXG4gICAgICAgIHRoaXMuX2ZsdXhNZXRob2RzID0ge307XHJcblxyXG4gICAgICAgIC8vIGJlY2F1c2UgZm9yIGEgcmVhbCBzdGFydCwgd2UgbmVlZCB0aGUgZmx1eCBtZXRob2RzIHRvIGhhdmUgYmVlbiBzZXQsXHJcbiAgICAgICAgLy8gYnV0IHRoYXQgaGFwcGVucyBhZnRlciBzdGFydCBmb3IgcHJpbnRlclByb3ZpZGVyIGdldHMgY2FsbGVkLi4uXHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5faW5pdERvbmVEZWZlcnJlZCA9IHEuZGVmZXIoKTtcclxuICAgICAgICB0aGlzLl9pbml0RG9uZURlZmVycmVkLnByb21pc2VcclxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9mbHV4TWV0aG9kcy5jbGVhclByaW50ZXJzTWV0aG9kKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5fZ2V0UHJpbnRlck1hbmFnZXIoKS5zdGFydChjbGllbnRTZWNyZXQpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuZG9uZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIF9nZXRQcmludGVyTWFuYWdlcigpIHtcclxuICAgICAgICBpZiAoIXRoaXMuX3ByaW50ZXJNYW5hZ2VyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByaW50ZXJNYW5hZ2VyID0gbmV3IFByaW50ZXJNYW5hZ2VyKFxyXG4gICAgICAgICAgICAgICAgdGhpcy5fcGFyYW1ldGVyU2VydmljZSxcclxuICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlcixcclxuICAgICAgICAgICAgICAgIHRoaXMuX3R2QXBpQ2xpZW50LFxyXG4gICAgICAgICAgICAgICAgdGhpcy5fdHJhY2tpbmdTZXJ2aWNlLFxyXG4gICAgICAgICAgICAgICAgdGhpcy5fdXNlckluZm8sXHJcbiAgICAgICAgICAgICAgICB0aGlzLl91c2VyVG9rZW4sXHJcbiAgICAgICAgICAgICAgICB0aGlzLl9zdG9yZWRQcmludGVyc01hbmFnZXJcclxuICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgIHByaW50ZXJNYW5hZ2VyLm9uKCdhZGRfcHJpbnRlcicsIHByaW50ZXIgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2ZsdXhNZXRob2RzLmFkZFByaW50ZXJNZXRob2QpIHRoaXMuX2ZsdXhNZXRob2RzLmFkZFByaW50ZXJNZXRob2QocHJpbnRlcik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBwcmludGVyTWFuYWdlci5vbigncmVtb3ZlX3ByaW50ZXInLCBwcmludGVyID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9mbHV4TWV0aG9kcy5yZW1vdmVQcmludGVyTWV0aG9kKSB0aGlzLl9mbHV4TWV0aG9kcy5yZW1vdmVQcmludGVyTWV0aG9kKHByaW50ZXIpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcHJpbnRlck1hbmFnZXIub24oJ3VwZGF0ZV9wcmludGVyX2xpc3QnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fZmx1eE1ldGhvZHMuZ2V0UHJpbnRlcnNNZXRob2QpIHRoaXMuX2ZsdXhNZXRob2RzLmdldFByaW50ZXJzTWV0aG9kKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5fcHJpbnRlck1hbmFnZXIgPSBwcmludGVyTWFuYWdlcjtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ByaW50ZXJNYW5hZ2VyO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFR2QXBpQ2xpZW50KHR2QXBpQ2xpZW50KSB7XHJcbiAgICAgICAgdGhpcy5fdHZBcGlDbGllbnQgPSB0dkFwaUNsaWVudDtcclxuICAgIH1cclxuXHJcbiAgICBzZXRQYXJhbWV0ZXJTZXJ2aWNlKHBhcmFtZXRlclNlcnZpY2UpIHtcclxuICAgICAgICB0aGlzLl9wYXJhbWV0ZXJTZXJ2aWNlID0gcGFyYW1ldGVyU2VydmljZTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRUcmFja2luZ1NlcnZpY2UodHJhY2tpbmdTZXJ2aWNlKSB7XHJcbiAgICAgICAgdGhpcy5fdHJhY2tpbmdTZXJ2aWNlID0gdHJhY2tpbmdTZXJ2aWNlO1xyXG4gICAgfVxyXG5cclxuICAgIHN0b3AoKSB7XHJcbiAgICAgICAgLy8gc3RvcCB0aGUgc3RvcmVkIHByaW50ZXJzIG1hbmFnZXI7IGFsbCB3cml0ZSByZXF1ZXN0cyBhZnRlciB0aGlzIGdldHNcclxuICAgICAgICAvLyBjYWxsZWQgd2lsbCBiZSBpZ25vcmVkLlxyXG4gICAgICAgIHJldHVybiB0aGlzLl9zdG9yZWRQcmludGVyc01hbmFnZXIuc3RvcCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGluaXQodXNlckluZm8sIHRva2VuKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgICAgIHRoaXMuX3VzZXJJbmZvID0gdXNlckluZm87XHJcbiAgICAgICAgdGhpcy5fdXNlclRva2VuID0gdG9rZW47XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLl9zdG9yZWRQcmludGVyc01hbmFnZXIubG9hZFNhdmVkUHJpbnRlcnMoKS50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gc2VsZi5fZ2V0UHJpbnRlck1hbmFnZXIoKS5pbml0KCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdXNlckNoYW5nZWQodXNlckluZm8sIHRva2VuKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgICAgIHRoaXMuX3VzZXJJbmZvID0gdXNlckluZm87XHJcbiAgICAgICAgdGhpcy5fdXNlclRva2VuID0gdG9rZW47XHJcblxyXG4gICAgICAgIGNvbnN0IG9sZFByaW50ZXJNYW5hZ2VyID0gdGhpcy5fcHJpbnRlck1hbmFnZXI7XHJcbiAgICAgICAgdGhpcy5fcHJpbnRlck1hbmFnZXIgPSBudWxsO1xyXG4gICAgICAgIHRoaXMuX2ZsdXhNZXRob2RzLmNsZWFyUHJpbnRlcnNNZXRob2QoKTtcclxuXHJcbiAgICAgICAgdGhpcy5fZ2V0UHJpbnRlck1hbmFnZXIoKVxyXG4gICAgICAgICAgICAuaW5pdCgpXHJcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKG9sZFByaW50ZXJNYW5hZ2VyKSByZXR1cm4gb2xkUHJpbnRlck1hbmFnZXIuc3RvcCgpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9wcmludGVyTWFuYWdlci5zdGFydChzZWxmLl9jbGllbnRTZWNyZXQpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuZG9uZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGZpbmlzaEluaXQoYWRkUHJpbnRlck1ldGhvZCwgcmVtb3ZlUHJpbnRlck1ldGhvZCwgY2xlYXJQcmludGVyc01ldGhvZCwgZ2V0UHJpbnRlcnNNZXRob2QpIHtcclxuICAgICAgICB0aGlzLl9mbHV4TWV0aG9kcy5hZGRQcmludGVyTWV0aG9kID0gYWRkUHJpbnRlck1ldGhvZDtcclxuICAgICAgICB0aGlzLl9mbHV4TWV0aG9kcy5yZW1vdmVQcmludGVyTWV0aG9kID0gcmVtb3ZlUHJpbnRlck1ldGhvZDtcclxuICAgICAgICB0aGlzLl9mbHV4TWV0aG9kcy5jbGVhclByaW50ZXJzTWV0aG9kID0gY2xlYXJQcmludGVyc01ldGhvZDtcclxuICAgICAgICB0aGlzLl9mbHV4TWV0aG9kcy5nZXRQcmludGVyc01ldGhvZCA9IGdldFByaW50ZXJzTWV0aG9kO1xyXG5cclxuICAgICAgICB0aGlzLl9pbml0RG9uZURlZmVycmVkLnJlc29sdmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRMb2dnZXIobG9nZ2VyKSB7XHJcbiAgICAgICAgdGhpcy5fbG9nZ2VyID0gbG9nZ2VyO1xyXG4gICAgICAgIHRoaXMuX3N0b3JlZFByaW50ZXJzTWFuYWdlci5zZXRMb2dnZXIobG9nZ2VyKTtcclxuICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbygnTWFrZXJCb3QgUHJpbnRlclNlcnZpY2VQcm92aWRlciBzZXQgbG9nZ2VyJyk7XHJcbiAgICAgICAgLy8gc2V0IGxvZyBmb3IgY3JvaXNzYW50XHJcbiAgICAgICAgY29uc3QgbG9nUGF0aCA9IHRoaXMuX2xvZ2dlci5idW55YW5Mb2dnZXIuZ2V0TG9nRmlsZVBhdGgoKTtcclxuXHJcbiAgICAgICAgLy8gTm90ZTogcGF0aC5kaXJuYW1lKHVuZGVmaW5lZCkgPT09ICcuJ1xyXG4gICAgICAgIC8vIElmIGluc2lkZSBhc2FyIC0+IGNhbiBjYXVzZSBDcm9pc3NhbnQgbmF0aXZlIGNvZGUgdG8gY3Jhc2hcclxuICAgICAgICBjb25zdCBsb2dEaXIgPSBwYXRoLmRpcm5hbWUobG9nUGF0aCk7XHJcbiAgICAgICAgaWYgKCFsb2dQYXRoIHx8ICFsb2dEaXIgfHwgJy4nID09PSBsb2dEaXIpIHtcclxuICAgICAgICAgICAgLy8gR0MtMzA1NTEgQXZvaWQgZmVlZGluZyB2YWx1ZXMgdG8gbmF0aXZlIG1vZHVsZSB0aGF0IGNhbiBjcmFzaCBpdFxyXG4gICAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoXHJcbiAgICAgICAgICAgICAgICBgQ2Fubm90IGRldGVybWluZSBub3JtYWwgZGlyZWN0b3J5IGZvciBDcm9pc3NhbnQgbG9ncy4gIExvZ3MgbWF5IGJlIGxvc3QuICBwYXRoPSR7bG9nUGF0aH0gZGlyPSR7bG9nRGlyfWBcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjcm9pc3NhbnQuY3JlYXRlTG9nKGxvZ0Rpcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldFByaW50ZXIodWlkKSB7XHJcbiAgICAgICAgcmV0dXJuIHEodGhpcy5fcHJpbnRlck1hbmFnZXIuZ2V0UHJpbnRlcih1aWQpKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRQcmludGVycyhyZWZyZXNoLCBjYWxsYmFjaykge1xyXG4gICAgICAgIC8vIGxvb2tzIGxpa2Ugc29tZXRpbWVzIHRoaXMgZ2V0cyBjYWxsZWQgYmVmb3JlIHN0YXJ0IGhhcyBmaW5pc2hlZC4uLlxyXG4gICAgICAgIGlmICghdGhpcy5fcHJpbnRlck1hbmFnZXIpIHJldHVybiBxKFtdKTtcclxuICAgICAgICByZXR1cm4gcSh0aGlzLl9wcmludGVyTWFuYWdlci5nZXRQcmludGVycygpKS5ub2RlaWZ5KGNhbGxiYWNrKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBwYXJhbSBwcmludGVyVXJsIHtzdHJpbmd9IC0gVVJMIHRvIHRoZSBwcmludGVyIHRoYXQgc2hvdWxkIGJlIGFkZGVkIHRvIHRoaXMgcHJvdmlkZXIsIGlmIGFjY2VwdGFibGUuXHJcbiAgICAgKiBAcGFyYW0gY2FsbGJhY2sge2Z1bmN0aW9ufVxyXG4gICAgICovXHJcbiAgICBhZGRQcmludGVyKGlwLCBjYWxsYmFjaykge1xyXG4gICAgICAgIC8vIHRoaXMgc2hvdWxkIGJlIGZpeGVkIHNvbWV3aGVyZSBlbHNlIGFuZCBub3QgaGFja2VkIGludG8gaGVyZS5cclxuICAgICAgICAvLyBwbGVhc2UgZG9uJ3QgbGV0IHRoaXMgc3RheSBoZXJlIDooXHJcbiAgICAgICAgaXAgPSBpcC5yZXBsYWNlKCdpcDovLycsICcnKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ByaW50ZXJNYW5hZ2VyLmFkZEJ5SXAoaXApLm5vZGVpZnkoY2FsbGJhY2spO1xyXG4gICAgfVxyXG5cclxuICAgIGFkZE9mZmxpbmVQcmludGVyKHZlbmRvck5hbWUsIGdlbmRlck5hbWUsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ByaW50ZXJNYW5hZ2VyLmFkZEFyY2hldHlwZVByaW50ZXIodmVuZG9yTmFtZSwgZ2VuZGVyTmFtZSkubm9kZWlmeShjYWxsYmFjayk7XHJcbiAgICB9XHJcblxyXG4gICAgYXV0aGVudGljYXRlKHByaW50ZXIpIHtcclxuICAgICAgICAvLyBSZW1vdmUgYW55IHByZXZpb3VzIGF1dGggZXJyb3JzXHJcbiAgICAgICAgcHJpbnRlci5yZW1vdmVFcnJvcihFcnJvcnMuTUJQbHVnaW5FcnJvci5HZW5lcmFsQXV0aEVycm9yLmVycm9yX2lkKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ByaW50ZXJNYW5hZ2VyXHJcbiAgICAgICAgICAgIC5hdXRoZW50aWNhdGUocHJpbnRlcilcclxuICAgICAgICAgICAgLnRoZW4oYXV0aFJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoYXV0aFJlcy53YXNOZXdBdXRoICYmIHByaW50ZXIuZ2V0Q29ubmVjdGlvblR5cGUoKSA9PT0gY29uc3RhbnRzLlByaW50ZXJDb25uVHlwZUVudW0uTkVUV09SSykge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHdlJ3JlIG5vdCByZXR1cm5pbmcgdGhpcyBndXkgYmVjYXVzZSB3ZSBkb24ndCBjYXJlIHRvIHdhaXQgZm9yXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyB0byBwYXNzIG9yIGZhaWwgYmVmb3JlIHJlcG9ydGluZyB0aGUgcmVzdWx0IG9mIGF1dGhcclxuICAgICAgICAgICAgICAgICAgICBwcmludGVyXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5pbnZva2UoJ05ldHdvcmtTdGF0ZScpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKG5ldHdvcmtTdGF0ZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFja2luZ0luZm8gPSB1dGlsLnRyYWNraW5nSW5mb0ZvclByaW50ZXIocHJpbnRlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFja2luZ0luZm8ubmFtZSA9ICdQcmludGVyIEF1dGhlbnRpY2F0ZWQgJztcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV0d29ya1N0YXRlLnN0YXRlID09PSBjb25zdGFudHMuTmV0d29ya1N0YXRlRW51bS5zdGF0ZS5XSUZJKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tpbmdJbmZvLm5hbWUgKz0gJ1dpLUZpJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmV0d29ya1N0YXRlLnN0YXRlID09PSBjb25zdGFudHMuTmV0d29ya1N0YXRlRW51bS5zdGF0ZS5FVEhFUk5FVCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNraW5nSW5mby5uYW1lICs9ICdFdGhlcm5ldCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdHJhY2tpbmdTZXJ2aWNlLmFkZEV2ZW50KHRyYWNraW5nSW5mbyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5kb25lKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcclxuICAgICAgICAgICAgICAgIHByaW50ZXIuYWRkRXJyb3IoRXJyb3JzLmdldFBsdWdpbkVycm9yKEVycm9ycy5NQlBsdWdpbkVycm9yLkdlbmVyYWxBdXRoRXJyb3IpKTtcclxuICAgICAgICAgICAgICAgIHRocm93ICdBdXRob3JpemF0aW9uIGVycm9yIG9yIG1hbnVhbGx5IGNhbmNlbGxlZCc7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGRlYXV0aGVudGljYXRlKHByaW50ZXIpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcHJpbnRlck1hbmFnZXIuZGVhdXRoZW50aWNhdGUocHJpbnRlcik7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpbnQocHJpbnRlciwgdG9vbFBhdGgsIHByb2dyZXNzQ2FsbGJhY2ssIGNhbmNlbFRva2VuLCBmbHV4ID0ge30pIHtcclxuICAgICAgICBjb25zdCB0cmFja2luZ0luZm8gPSB1dGlsLnRyYWNraW5nSW5mb0ZvclByaW50ZXIocHJpbnRlcik7XHJcbiAgICAgICAgY29uc3QgcHJpbnRTZXR0aW5ncyA9IGFuYWx5dGljVXRpbHMuZ2V0UHJpbnRTZXR0aW5nc0ZvckFuYWx5dGljRXZlbnRzKGZsdXgsIHByaW50ZXIpO1xyXG4gICAgICAgIHRyYWNraW5nSW5mby5uYW1lID0gJ1ByaW50IEZpbGUgVHJhbnNmZXIgU3RhcnRlZCc7XHJcbiAgICAgICAgdGhpcy5fdHJhY2tpbmdTZXJ2aWNlLmFkZEV2ZW50KF8ubWVyZ2UodHJhY2tpbmdJbmZvLCBwcmludFNldHRpbmdzKSk7XHJcbiAgICAgICAgY2FuY2VsVG9rZW4ub25jZSgnY2FuY2VsJywgKCkgPT4ge30pO1xyXG5cclxuICAgICAgICByZXR1cm4gcHJpbnRlclxyXG4gICAgICAgICAgICAuc2VuZFByaW50RmlsZSh0b29sUGF0aCwgcHJvZ3Jlc3NDYWxsYmFjaywgY2FuY2VsVG9rZW4pXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRyYWNraW5nSW5mbyA9IHV0aWwudHJhY2tpbmdJbmZvRm9yUHJpbnRlcihwcmludGVyKTtcclxuICAgICAgICAgICAgICAgIHRyYWNraW5nSW5mby5uYW1lID0gJ1ByaW50IEZpbGUgVHJhbnNmZXIgQ29tcGxldGVkJztcclxuICAgICAgICAgICAgICAgIHRoaXMuX3RyYWNraW5nU2VydmljZS5hZGRFdmVudChfLm1lcmdlKHRyYWNraW5nSW5mbywgcHJpbnRTZXR0aW5ncykpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRyYWNraW5nSW5mbyA9IHV0aWwudHJhY2tpbmdJbmZvRm9yUHJpbnRlcihwcmludGVyKTtcclxuICAgICAgICAgICAgICAgIHRyYWNraW5nSW5mby5uYW1lID0gYFByaW50IEZpbGUgVHJhbnNmZXIgJHtlcnIudHlwZSA9PT0gJ2NhbmNlbCcgPyAnQ2FuY2VsbGVkJyA6ICdGYWlsZWQnfWA7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl90cmFja2luZ1NlcnZpY2UuYWRkRXZlbnQoXy5tZXJnZSh0cmFja2luZ0luZm8sIHByaW50U2V0dGluZ3MpKTtcclxuICAgICAgICAgICAgICAgIHRocm93IGVycjtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAcGFyYW0gcHJpbnRlclVybCB7c3RyaW5nfSAtIFVSTCB0byBhIHByaW50ZXIuXHJcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gLSBUcnVlICA9IFRoZSBnaXZlbiBwcmludGVyIFVSTCBjYW4gYmUgYWRkZWQgdG8gdGhpcyBwcmludGVyIHByb3ZpZGVyLlxyXG4gICAgICogICAgICAgICAgICAgICAgICAgICAgRmFsc2UgPSBUaGUgZ2l2ZW4gcHJpbnRlciBVUkwgY2Fubm90IGJlIGFkZGVkIHRvIHRoaXMgcHJpbnRlciBwcm92aWRlci5cclxuICAgICAqL1xyXG4gICAgYWNjZXB0KGlwKSB7XHJcbiAgICAgICAgLy8gY2hlY2sgdGhhdCBpdCdzIGEgdmFsaWQgaXBcclxuICAgICAgICBjb25zdCBzcGxpdElwID0gaXAuc3BsaXQoJy4nKTtcclxuICAgICAgICBpZiAoc3BsaXRJcC5sZW5ndGggIT0gNCkgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3BsaXRJcC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBpZiAocGFyc2VJbnQoc3BsaXRJcFtpXSkgPCAwIHx8IHBhcnNlSW50KHNwbGl0SXBbaV0pID4gMjU2KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgY29udmVydFRvQXJjaGV0eXBlSWQocHJpbnRlcklkKSB7XHJcbiAgICAgICAgY29uc3QgUElEID0gcHJpbnRlcklkLnNwbGl0KCc6Jykuc2xpY2UoMSwgMik7XHJcbiAgICAgICAgY29uc3QgZ2VuZGVyTmFtZSA9IGNvbnN0YW50cy5QSUR0b0dlbmRlck5hbWVbUElEXTtcclxuICAgICAgICBjb25zdCB2ZW5kb3JOYW1lID0gY29uc3RhbnRzLlZlbmRvck5hbWU7XHJcblxyXG4gICAgICAgIHJldHVybiBgb2ZmbGluZToke3ZlbmRvck5hbWV9OiR7Z2VuZGVyTmFtZX06JHtnZW5kZXJOYW1lfWA7XHJcbiAgICB9XHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0gTUJQcmludGVyUHJvdmlkZXI7XHJcbiJdfQ==
