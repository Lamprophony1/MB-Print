'use strict';

const _ = require('lodash');

const BirdWingError = require('./croissant').BirdWingError;

const {
  SketchErrorCodesToToPrettyStrings
} = require('./constants');

const MBPluginError = Object.freeze({
  GeneralAuthError: -9999,
  DisconnectWhileAuthingError: -9998
});
const MBPluginErrType = Object.freeze({
  MB_PLUGIN_ERROR: 'MB_PLUGIN_ERROR'
});
const MBPluginErrAction = Object.freeze({
  RETRY_AUTH: 'RETRY_AUTH',
  ACKNOWLEDGE_AND_CLOSE: 'ACKNOWLEDGE_AND_CLOSE',
  LOAD_FILAMENT: 'LOAD_FILAMENT',
  NONE: 'NONE'
});

function _getErrInfoOverrides(printer, err) {
  const bwErrors = BirdWingError.Error;

  switch (err.code) {
    case MBPluginError.GeneralAuthError:
      return {
        action: MBPluginErrAction.RETRY_AUTH
      };

    case MBPluginError.DisconnectWhileAuthingError:
      return {
        action: MBPluginErrAction.ACKNOWLEDGE_AND_CLOSE
      };

    case bwErrors.kOutOfFilament:
      return printer.currentProcess.methods.indexOf('load_filament') > -1 ? // the actual action for this error is BirdWingError.Action.CHANGE_FILAMENT
      // but that is shared with kNoFilamentLoaded and kFilamentSlip, for which we
      // don't necessarily want to change how we handle right now..? So this guy
      // gets a custom action until we maybe one day decide to handle them all
      // the same way
      {
        action: MBPluginErrAction.LOAD_FILAMENT
      } : {
        action: MBPluginErrAction.NONE
      };

    case bwErrors.kNoFilament:
    case bwErrors.kFilamentSlip:
    case bwErrors.kDoorInterlockTriggered:
    case bwErrors.kLidInterlockTriggered:
      return {
        action: MBPluginErrAction.NONE
      };

    default:
      return {};
  }
} // for making plugin-originated errors look like birdwing errors...


function getPluginError(errCode) {
  switch (errCode) {
    case MBPluginError.GeneralAuthError:
      return {
        // these have id's of -1 so as to avoid any possible collision with bw
        // error ids, and because we should never have more than one of this or
        // the other at once...
        error_id: -1,
        code: MBPluginError.GeneralAuthError,
        source: null
      };

    case MBPluginError.DisconnectWhileAuthingError:
      return {
        error_id: -1,
        code: MBPluginError.DisconnectWhileAuthingError,
        source: null
      };
  }
}

function errInfoFromPluginErr(err) {
  const errObj = {
    error: err.code,
    type: MBPluginErrType.MB_PLUGIN_ERROR
  };
  return errObj;
}

function errInfoFromBirdWingErr(err) {
  // ------------------------------------
  // PLEASE REMOVE THIS BEFORE RELEASING
  if (!err.source && err.code === 1048) {
    err.source = {
      file_tool: 'different extruder set',
      current_tool: ''
    };
  } // ------------------------------------


  return new BirdWingError(err.code, err.source);
}

function errInfoForSketchBot(err) {
  const errorCode = SketchErrorCodesToToPrettyStrings[err.code] ? err.code : 'default';
  const errObj = {
    title: `${SketchErrorCodesToToPrettyStrings[errorCode].title} Error`,
    message: SketchErrorCodesToToPrettyStrings[errorCode].message,
    // this is to avoid rendering a default 'OK' button in PrinterDetailsError.js -> _renderButtons()
    action: 'NONE'
  };
  return errObj;
}

function errIsFromPlugin(err) {
  return err.code < 0;
}

function getErrInfo(printer, err) {
  let errInfo;

  if (printer.isSketchPrinter()) {
    errInfo = errInfoForSketchBot(err);
  } else {
    errInfo = errIsFromPlugin(err) ? errInfoFromPluginErr(err) : errInfoFromBirdWingErr(err);
  }

  return _.extend(errInfo, _getErrInfoOverrides(printer, err));
}

module.exports = {
  MBPluginError,
  MBPluginErrType,
  MBPluginErrAction,
  getPluginError,
  errInfoFromPluginErr,
  errInfoFromBirdWingErr,
  getErrInfo,
  errIsFromPlugin
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVycm9ycy5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsIkJpcmRXaW5nRXJyb3IiLCJTa2V0Y2hFcnJvckNvZGVzVG9Ub1ByZXR0eVN0cmluZ3MiLCJNQlBsdWdpbkVycm9yIiwiT2JqZWN0IiwiZnJlZXplIiwiR2VuZXJhbEF1dGhFcnJvciIsIkRpc2Nvbm5lY3RXaGlsZUF1dGhpbmdFcnJvciIsIk1CUGx1Z2luRXJyVHlwZSIsIk1CX1BMVUdJTl9FUlJPUiIsIk1CUGx1Z2luRXJyQWN0aW9uIiwiUkVUUllfQVVUSCIsIkFDS05PV0xFREdFX0FORF9DTE9TRSIsIkxPQURfRklMQU1FTlQiLCJOT05FIiwiX2dldEVyckluZm9PdmVycmlkZXMiLCJwcmludGVyIiwiZXJyIiwiYndFcnJvcnMiLCJFcnJvciIsImNvZGUiLCJhY3Rpb24iLCJrT3V0T2ZGaWxhbWVudCIsImN1cnJlbnRQcm9jZXNzIiwibWV0aG9kcyIsImluZGV4T2YiLCJrTm9GaWxhbWVudCIsImtGaWxhbWVudFNsaXAiLCJrRG9vckludGVybG9ja1RyaWdnZXJlZCIsImtMaWRJbnRlcmxvY2tUcmlnZ2VyZWQiLCJnZXRQbHVnaW5FcnJvciIsImVyckNvZGUiLCJlcnJvcl9pZCIsInNvdXJjZSIsImVyckluZm9Gcm9tUGx1Z2luRXJyIiwiZXJyT2JqIiwiZXJyb3IiLCJ0eXBlIiwiZXJySW5mb0Zyb21CaXJkV2luZ0VyciIsImZpbGVfdG9vbCIsImN1cnJlbnRfdG9vbCIsImVyckluZm9Gb3JTa2V0Y2hCb3QiLCJlcnJvckNvZGUiLCJ0aXRsZSIsIm1lc3NhZ2UiLCJlcnJJc0Zyb21QbHVnaW4iLCJnZXRFcnJJbmZvIiwiZXJySW5mbyIsImlzU2tldGNoUHJpbnRlciIsImV4dGVuZCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLENBQUMsR0FBR0MsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBRUEsTUFBTUMsYUFBYSxHQUFHRCxPQUFPLENBQUMs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LENBQUM1QixHQUFELENBQWYsR0FBdUJpQixvQkFBb0IsQ0FBQ2pCLEdBQUQsQ0FBM0MsR0FBbURxQixzQkFBc0IsQ0FBQ3JCLEdBQUQsQ0FBbkY7QUFDSDs7QUFDRCxTQUFPbEIsQ0FBQyxDQUFDa0QsTUFBRixDQUFTRixPQUFULEVBQWtCaEMsb0JBQW9CLENBQUNDLE9BQUQsRUFBVUMsR0FBVixDQUF0QyxDQUFQO0FBQ0g7O0FBRURpQyxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDYmhELEVBQUFBLGFBRGE7QUFFYkssRUFBQUEsZUFGYTtBQUdiRSxFQUFBQSxpQkFIYTtBQUlib0IsRUFBQUEsY0FKYTtBQUtiSSxFQUFBQSxvQkFMYTtBQU1iSSxFQUFBQSxzQkFOYTtBQU9iUSxFQUFBQSxVQVBhO0FBUWJELEVBQUFBO0FBUmEsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XHJcblxyXG5jb25zdCBCaXJkV2luZ0Vycm9yID0gcmVxdWlyZSgnLi9jcm9pc3NhbnQnKS5CaXJkV2luZ0Vycm9yO1xyXG5jb25zdCB7IFNrZXRjaEVycm9yQ29kZXNUb1RvUHJldHR5U3RyaW5ncyB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKTtcclxuXHJcbmNvbnN0IE1CUGx1Z2luRXJyb3IgPSBPYmplY3QuZnJlZXplKHtcclxuICAgIEdlbmVyYWxBdXRoRXJyb3I6IC05OTk5LFxyXG4gICAgRGlzY29ubmVjdFdoaWxlQXV0aGluZ0Vycm9yOiAtOTk5OCxcclxufSk7XHJcblxyXG5jb25zdCBNQlBsdWdpbkVyclR5cGUgPSBPYmplY3QuZnJlZXplKHtcclxuICAgIE1CX1BMVUdJTl9FUlJPUjogJ01CX1BMVUdJTl9FUlJPUicsXHJcbn0pO1xyXG5cclxuY29uc3QgTUJQbHVnaW5FcnJBY3Rpb24gPSBPYmplY3QuZnJlZXplKHtcclxuICAgIFJFVFJZX0FVVEg6ICdSRVRSWV9BVVRIJyxcclxuICAgIEFDS05PV0xFREdFX0FORF9DTE9TRTogJ0FDS05PV0xFREdFX0FORF9DTE9TRScsXHJcbiAgICBMT0FEX0ZJTEFNRU5UOiAnTE9BRF9GSUxBTUVOVCcsXHJcbiAgICBOT05FOiAnTk9ORScsXHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gX2dldEVyckluZm9PdmVycmlkZXMocHJpbnRlciwgZXJyKSB7XHJcbiAgICBjb25zdCBid0Vycm9ycyA9IEJpcmRXaW5nRXJyb3IuRXJyb3I7XHJcbiAgICBzd2l0Y2ggKGVyci5jb2RlKSB7XHJcbiAgICAgICAgY2FzZSBNQlBsdWdpbkVycm9yLkdlbmVyYWxBdXRoRXJyb3I6XHJcbiAgICAgICAgICAgIHJldHVybiB7IGFjdGlvbjogTUJQbHVnaW5FcnJBY3Rpb24uUkVUUllfQVVUSCB9O1xyXG4gICAgICAgIGNhc2UgTUJQbHVnaW5FcnJvci5EaXNjb25uZWN0V2hpbGVBdXRoaW5nRXJyb3I6XHJcbiAgICAgICAgICAgIHJldHVybiB7IGFjdGlvbjogTUJQbHVnaW5FcnJBY3Rpb24uQUNLTk9XTEVER0VfQU5EX0NMT1NFIH07XHJcbiAgICAgICAgY2FzZSBid0Vycm9ycy5rT3V0T2ZGaWxhbWVudDpcclxuICAgICAgICAgICAgcmV0dXJuIHByaW50ZXIuY3VycmVudFByb2Nlc3MubWV0aG9kcy5pbmRleE9mKCdsb2FkX2ZpbGFtZW50JykgPiAtMVxyXG4gICAgICAgICAgICAgICAgPyAvLyB0aGUgYWN0dWFsIGFjdGlvbiBmb3IgdGhpcyBlcnJvciBpcyBCaXJkV2luZ0Vycm9yLkFjdGlvbi5DSEFOR0VfRklMQU1FTlRcclxuICAgICAgICAgICAgICAgICAgLy8gYnV0IHRoYXQgaXMgc2hhcmVkIHdpdGgga05vRmlsYW1lbnRMb2FkZWQgYW5kIGtGaWxhbWVudFNsaXAsIGZvciB3aGljaCB3ZVxyXG4gICAgICAgICAgICAgICAgICAvLyBkb24ndCBuZWNlc3NhcmlseSB3YW50IHRvIGNoYW5nZSBob3cgd2UgaGFuZGxlIHJpZ2h0IG5vdy4uPyBTbyB0aGlzIGd1eVxyXG4gICAgICAgICAgICAgICAgICAvLyBnZXRzIGEgY3VzdG9tIGFjdGlvbiB1bnRpbCB3ZSBtYXliZSBvbmUgZGF5IGRlY2lkZSB0byBoYW5kbGUgdGhlbSBhbGxcclxuICAgICAgICAgICAgICAgICAgLy8gdGhlIHNhbWUgd2F5XHJcbiAgICAgICAgICAgICAgICAgIHsgYWN0aW9uOiBNQlBsdWdpbkVyckFjdGlvbi5MT0FEX0ZJTEFNRU5UIH1cclxuICAgICAgICAgICAgICAgIDogeyBhY3Rpb246IE1CUGx1Z2luRXJyQWN0aW9uLk5PTkUgfTtcclxuICAgICAgICBjYXNlIGJ3RXJyb3JzLmtOb0ZpbGFtZW50OlxyXG4gICAgICAgIGNhc2UgYndFcnJvcnMua0ZpbGFtZW50U2xpcDpcclxuICAgICAgICBjYXNlIGJ3RXJyb3JzLmtEb29ySW50ZXJsb2NrVHJpZ2dlcmVkOlxyXG4gICAgICAgIGNhc2UgYndFcnJvcnMua0xpZEludGVybG9ja1RyaWdnZXJlZDpcclxuICAgICAgICAgICAgcmV0dXJuIHsgYWN0aW9uOiBNQlBsdWdpbkVyckFjdGlvbi5OT05FIH07XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgcmV0dXJuIHt9O1xyXG4gICAgfVxyXG59XHJcblxyXG4vLyBmb3IgbWFraW5nIHBsdWdpbi1vcmlnaW5hdGVkIGVycm9ycyBsb29rIGxpa2UgYmlyZHdpbmcgZXJyb3JzLi4uXHJcbmZ1bmN0aW9uIGdldFBsdWdpbkVycm9yKGVyckNvZGUpIHtcclxuICAgIHN3aXRjaCAoZXJyQ29kZSkge1xyXG4gICAgICAgIGNhc2UgTUJQbHVnaW5FcnJvci5HZW5lcmFsQXV0aEVycm9yOlxyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgLy8gdGhlc2UgaGF2ZSBpZCdzIG9mIC0xIHNvIGFzIHRvIGF2b2lkIGFueSBwb3NzaWJsZSBjb2xsaXNpb24gd2l0aCBid1xyXG4gICAgICAgICAgICAgICAgLy8gZXJyb3IgaWRzLCBhbmQgYmVjYXVzZSB3ZSBzaG91bGQgbmV2ZXIgaGF2ZSBtb3JlIHRoYW4gb25lIG9mIHRoaXMgb3JcclxuICAgICAgICAgICAgICAgIC8vIHRoZSBvdGhlciBhdCBvbmNlLi4uXHJcbiAgICAgICAgICAgICAgICBlcnJvcl9pZDogLTEsXHJcbiAgICAgICAgICAgICAgICBjb2RlOiBNQlBsdWdpbkVycm9yLkdlbmVyYWxBdXRoRXJyb3IsXHJcbiAgICAgICAgICAgICAgICBzb3VyY2U6IG51bGwsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgY2FzZSBNQlBsdWdpbkVycm9yLkRpc2Nvbm5lY3RXaGlsZUF1dGhpbmdFcnJvcjpcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGVycm9yX2lkOiAtMSxcclxuICAgICAgICAgICAgICAgIGNvZGU6IE1CUGx1Z2luRXJyb3IuRGlzY29ubmVjdFdoaWxlQXV0aGluZ0Vycm9yLFxyXG4gICAgICAgICAgICAgICAgc291cmNlOiBudWxsLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBlcnJJbmZvRnJvbVBsdWdpbkVycihlcnIpIHtcclxuICAgIGNvbnN0IGVyck9iaiA9IHtcclxuICAgICAgICBlcnJvcjogZXJyLmNvZGUsXHJcbiAgICAgICAgdHlwZTogTUJQbHVnaW5FcnJUeXBlLk1CX1BMVUdJTl9FUlJPUixcclxuICAgIH07XHJcbiAgICByZXR1cm4gZXJyT2JqO1xyXG59XHJcblxyXG5mdW5jdGlvbiBlcnJJbmZvRnJvbUJpcmRXaW5nRXJyKGVycikge1xyXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgICAvLyBQTEVBU0UgUkVNT1ZFIFRISVMgQkVGT1JFIFJFTEVBU0lOR1xyXG4gICAgaWYgKCFlcnIuc291cmNlICYmIGVyci5jb2RlID09PSAxMDQ4KSB7XHJcbiAgICAgICAgZXJyLnNvdXJjZSA9IHsgZmlsZV90b29sOiAnZGlmZmVyZW50IGV4dHJ1ZGVyIHNldCcsIGN1cnJlbnRfdG9vbDogJycgfTtcclxuICAgIH1cclxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gICAgcmV0dXJuIG5ldyBCaXJkV2luZ0Vycm9yKGVyci5jb2RlLCBlcnIuc291cmNlKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZXJySW5mb0ZvclNrZXRjaEJvdChlcnIpIHtcclxuICAgIGNvbnN0IGVycm9yQ29kZSA9IFNrZXRjaEVycm9yQ29kZXNUb1RvUHJldHR5U3RyaW5nc1tlcnIuY29kZV0gPyBlcnIuY29kZSA6ICdkZWZhdWx0JztcclxuXHJcbiAgICBjb25zdCBlcnJPYmogPSB7XHJcbiAgICAgICAgdGl0bGU6IGAke1NrZXRjaEVycm9yQ29kZXNUb1RvUHJldHR5U3RyaW5nc1tlcnJvckNvZGVdLnRpdGxlfSBFcnJvcmAsXHJcbiAgICAgICAgbWVzc2FnZTogU2tldGNoRXJyb3JDb2Rlc1RvVG9QcmV0dHlTdHJpbmdzW2Vycm9yQ29kZV0ubWVzc2FnZSxcclxuICAgICAgICAvLyB0aGlzIGlzIHRvIGF2b2lkIHJlbmRlcmluZyBhIGRlZmF1bHQgJ09LJyBidXR0b24gaW4gUHJpbnRlckRldGFpbHNFcnJvci5qcyAtPiBfcmVuZGVyQnV0dG9ucygpXHJcbiAgICAgICAgYWN0aW9uOiAnTk9ORScsXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGVyck9iajtcclxufVxyXG5cclxuZnVuY3Rpb24gZXJySXNGcm9tUGx1Z2luKGVycikge1xyXG4gICAgcmV0dXJuIGVyci5jb2RlIDwgMDtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0RXJySW5mbyhwcmludGVyLCBlcnIpIHtcclxuICAgIGxldCBlcnJJbmZvO1xyXG5cclxuICAgIGlmIChwcmludGVyLmlzU2tldGNoUHJpbnRlcigpKSB7XHJcbiAgICAgICAgZXJySW5mbyA9IGVyckluZm9Gb3JTa2V0Y2hCb3QoZXJyKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZXJySW5mbyA9IGVycklzRnJvbVBsdWdpbihlcnIpID8gZXJySW5mb0Zyb21QbHVnaW5FcnIoZXJyKSA6IGVyckluZm9Gcm9tQmlyZFdpbmdFcnIoZXJyKTtcclxuICAgIH1cclxuICAgIHJldHVybiBfLmV4dGVuZChlcnJJbmZvLCBfZ2V0RXJySW5mb092ZXJyaWRlcyhwcmludGVyLCBlcnIpKTtcclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgICBNQlBsdWdpbkVycm9yLFxyXG4gICAgTUJQbHVnaW5FcnJUeXBlLFxyXG4gICAgTUJQbHVnaW5FcnJBY3Rpb24sXHJcbiAgICBnZXRQbHVnaW5FcnJvcixcclxuICAgIGVyckluZm9Gcm9tUGx1Z2luRXJyLFxyXG4gICAgZXJySW5mb0Zyb21CaXJkV2luZ0VycixcclxuICAgIGdldEVyckluZm8sXHJcbiAgICBlcnJJc0Zyb21QbHVnaW4sXHJcbn07XHJcbiJdfQ==
