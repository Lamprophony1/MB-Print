'use strict';

const q = require('q');

const EventEmitter = require('eventemitter3');

const Printer = require('eagle-print/model/printer');

const util = require('./util.js');

const {
  PrinterStateEnum,
  PrinterConnTypeEnum,
  BotTypeEnum,
  GenderToType,
  FifthGenBots,
  SixthGenBots,
  PrinterGenderToDefaultExtruders
} = require('./constants'); // One of these days we'll make a unified interface for real printers and archetypes....


class ArchetypePrinter extends Printer {
  constructor(vendorName, gender) {
    const genderName = gender.getName();
    const printerId = `offline:${vendorName}:${genderName}:${genderName}`;
    const data = {
      id: printerId,
      ip_address: 'OFFLINE',
      name: genderName,
      connected: false,
      printer_status: {
        state: 'Offline',
        // TODO: real statuses here
        current_print_job: null
      },
      printer_info: {
        vendor: vendorName,
        model: genderName,
        modelName: genderName,
        firmware_version: '0.0.0'
      }
    };
    super(data, null, gender);
    const self = this;
    self._gender = gender;
    self._machineConfig = {}; // Notifications for critical updates (system, states, schema updates, etc..)

    self._updateNotifications = new EventEmitter(); // dumping things into this _info object for compatibility with
    // eagle print printer

    self._info = {
      get id() {
        return printerId;
      },

      get name() {
        return genderName;
      },

      get ip() {
        return 'OFFLINE';
      }

    }; // these are status properties generic to eagle-print's printer

    self._info.printer_status = data.printer_status;

    function getDefaultExtruders() {
      const botType = GenderToType[self.getModel()];
      return PrinterGenderToDefaultExtruders[botType];
    }

    self.attachedExtruders = getDefaultExtruders();
  }

  _initPrinter() {// Add machine config code here
    // self._getMachineConfig().done();
  }

  getLastError() {
    return undefined;
  }

  isMissingExtruder() {
    return false;
  }

  getChamberInfo() {
    return [];
  }

  getSpoolInfo() {
    if (this.isSixthGen()) {
      return q([{
        tag_uid: null
      }, {
        tag_uid: null
      }]);
    } else {
      return q(null);
    }
  }

  processMethodExists() {
    return false;
  }

  getTrackingInfo() {
    const data = {
      printer_id: this.getId(),
      printer_type: util.genderToCodeName(this.getInfo().model)
    };
    return data;
  }

  disconnect() {
    return true;
  }

  getInfo() {
    return {
      vendor: 'MakerBot',
      model: this._botGender,
      modelName: this._info.name,
      firmware_version: this.firmwareVersion
    };
  }

  getStatus() {
    return this._info.printer_status;
  }

  getDisplayStatus() {
    return 'ExportOnly';
  }

  isAuthenticated() {
    return true;
  }

  isConnected() {
    return false;
  }

  deauthenticate() {} /// The toolpath that gets here is probably an eagle-print/model/toolpath.js
  /// Toolpath object made from what is returned by 'build' in makerbot.js...


  print(toolPath) {
    const self = this;

    if (self.getStatus().state !== PrinterStateEnum.Idle) {
      // TODO: something something print queueing
      throw 'Unable to print to this printer at this time';
    } // TODO: new print flow support


    const localPath = toolPath.get('path');
    const filename = toolPath.get('name');
    const remotePath = `/current_thing/${filename}`;
    return q(self._printer.Put(localPath, remotePath).then(() => {
      self._printer.Print(filename);
    }));
  }

  cancel() {}

  _getMachineConfig() {
    const self = this;
    return q(self._printer.GetMachineConfig()).then(config => {
      self._machineConfig = config;
    });
  }

  _updateFromExtruderChange(index, config) {// TODO(shirley): make this work, when I actually figure out how to
    // get these notifications from the bot...
  }

  authenticate(authInfo) {}

  _fwVerDictToString(fwVerDict) {
    if (fwVerDict !== undefined) {
      return [fwVerDict.major, fwVerDict.minor, fwVerDict.bugfix, fwVerDict.build].join('.');
    }
  }

  getCodeName() {
    return util.genderToCodeName(this.getGender().getName());
  }

  getConnectionType() {
    return PrinterConnTypeEnum.ARCHETYPE;
  }

  getCameraFeed(cameraFrameCallback) {
    return undefined;
  }

  endCameraFeed() {} // extruderList should be an array, even if there is only one extruder


  setAttachedExtruders(extruderList, index = null) {
    if (index !== null) {
      this.attachedExtruders[index] = extruderList;
    } else {
      this.attachedExtruders = extruderList;
    }
  }

  getAttachedExtruders() {
    return this.attachedExtruders;
  } // doing this (just in case) until eagle-print's printer settles down...


  get rawData() {
    return this._info;
  }

  get machineConfig() {
    return undefined; //this._machineConfig;
  }

  get firmwareVersion() {
    return '0.0.0';
  }

  get apiVersion() {
    return '0.0.0';
  }

  get currentState() {
    return this._info;
  }

  get _botGender() {
    return this._gender.getName();
  }

  get updateNotifications() {
    return this._updateNotifications;
  }

  checkForUnsupportedExtruderConfigurations() {
    return {
      extruderSetupError: false
    };
  }

  hasExtruderMaterialMismatch() {
    return false;
  }

  isFifthGen() {
    const botType = GenderToType[this.getModel()];
    return FifthGenBots.includes(botType);
  }

  isSixthGen() {
    const botType = GenderToType[this.getModel()];
    return SixthGenBots.includes(botType);
  }

  isSketchPrinter() {
    const botType = GenderToType[this.getModel()];
    return botType === BotTypeEnum.sketch;
  }

}

module.exports = ArchetypePrinter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFyY2hldHlwZV9wcmludGVyLmpzIl0sIm5hbWVzIjpbInEiLCJyZXF1aXJlIiwiRXZlbnRFbWl0dGVyIiwiUHJpbnRlciIsInV0aWwiLCJQcmludGVyU3RhdGVFbnVtIiwiUHJpbnRlckNvbm5UeXBlRW51bSIsIkJvdFR5cGVFbnVtIiwiR2VuZGVyVG9UeXBlIiwiRmlmdGhHZW5Cb3RzIiwiU2l4dGhHZW5Cb3RzIiwiUHJpbnRlckdlbmRlclRvRGVmYXVsdEV4dHJ1ZGVycyIsIkFyY2hldHlwZVByaW50ZXIiLCJjb25zdHJ1Y3RvciIsInZlbmRvck5hbWUiLCJnZW5kZXIiLCJnZW5kZXJOYW1lIiwiZ2V0TmFtZSIsInByaW50ZXJJZCIsImRhdGEiLCJpZCIsImlwX2FkZHJlc3MiLCJuYW1lIiwiY29ubmVjdGVkIiwicHJpbnRlcl9zdGF0dXMiLCJzdGF0ZSIsImN1cnJlbnRfcHJpbnRfam9iIiwicHJpbnRlcl9pbmZvIiwidmVuZG9yIiwibW9kZWwiLCJtb2RlbE5hbWUiLCJmaXJtd2FyZV92ZXJzaW9uIiwic2VsZiIsIl9nZW5kZXIiLCJfbWFjaGluZUNvbmZpZyIsIl91cGRhdGVOb3RpZmljYXRpb25zIiwiX2luZm8iLCJpcCIsImdldERlZmF1bHRFeHRydWRlcnMiLCJib3RUeXBlIiwiZ2V0TW9kZWwiLCJhdHRhY2hlZEV4dHJ1ZGVycyIsIl9pbml0UHJpbnRlciIsImdldExhc3RFcnJvciIsInVuZGVmaW5lZCIsImlzTWlzc2luZ0V4dHJ1ZGVyIiwiZ2V0Q2hhbWJlckluZm8iLCJnZXRTcG9vbEluZm8iLCJpc1NpeHRoR2VuIiwidGFnX3VpZCIsInByb2Nlc3NNZXRob2RFeGlzdHMiLCJnZXRUcmFja2luZ0luZm8iLCJwcmludGVyX2lkIiwiZ2V0SWQiLCJwcmludGVyX3R5cGUiLCJnZW5kZXJUb0NvZGVOYW1lIiwiZ2V0SW5mbyIsImRpc2Nvbm5lY3QiLCJfYm90R2VuZGVyIiwiZmlybXdhcmVWZXJzaW9uIiwiZ2V0U3RhdHVzIiwiZ2V0RGlzcGxheVN0YXR1cyIsImlzQXV0aGVudGljYXRlZCIsImlzQ29ubmVjdGVkIiwiZGVhdXRoZW50aWNhdGUiLCJwcmludCIsInRvb2xQYXRoIiwiSWRsZSIsImxvY2FsUGF0aCIsImdldCIsImZpbGVuYW1lIiwicmVtb3RlUGF0aCIsIl9wcmludGVyIiwiUHV0IiwidGhlbiIsIlByaW50IiwiY2FuY2VsIiwiX2dldE1hY2hpbmVDb25maWciLCJHZXRNYWNoaW5lQ29uZmlnIiwiY29uZmlnIiwiX3VwZGF0ZUZyb21FeHRydWRlckNoYW5nZSIsImluZGV4IiwiYXV0aGVudGljYXRlIiwiYXV0aEluZm8iLCJfZndWZXJEaWN0VG9TdHJpbmciLCJmd1ZlckRpY3QiLCJtYWpvciIsIm1pbm9yIiwiYnVnZml4IiwiYnVpbGQiLCJqb2luIiwiZ2V0Q29kZU5hbWUiLCJnZXRHZW5kZXIiLCJnZXRDb25uZWN0aW9uVHlwZSIsIkFSQ0hFVFlQRSIsImdldENhbWVyYUZlZWQiLCJjYW1lcmFGcmFtZUNhbGxiYWNrIiwiZW5kQ2FtZXJhRmVlZCIsInNldEF0dGFjaGVkRXh0cnVkZXJzIiwiZXh0cnVkZXJMaXN0IiwiZ2V0QXR0YWNoZWRFeHRydWRlcnMiLCJyYXdEYXRhIiwibWFjaGluZUNvbmZpZyIsImFwaVZlcnNpb24iLCJjdXJyZW50U3RhdGUiLCJ1cGRhdGVOb3RpZmljYXRpb25zIiwiY2hlY2tGb3JVbnN1cHBvcnRlZEV4dHJ1ZGVyQ29uZmlndXJhdGlvbnMiLCJleHRydWRlclNldHVwRXJyb3IiLCJoYXNFeHRydWRlck1hdGVyaWFsTWlzbWF0Y2giLCJpc0ZpZnRoR2VuIiwiaW5jbHVkZXMiLCJpc1NrZXRjaFByaW50ZXIiLCJza2V0Y2giLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxNQUFNQSxDQUFDLEdBQUdDLE9BQU8sQ0FBQyxHQUFELENBQWpCOztBQUNBLE1BQU1DLFlBQVksR0FBR0QsT0FBTyxDQUFDLGVBQUQsQ0FBNUI7O0FBQ0EsTUFBTUUsT0FBTyxHQUFHRixPQUFPLENB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QjtBQUN0QixXQUFPLEtBQUt0RSxvQkFBWjtBQUNIOztBQUVEdUUsRUFBQUEseUNBQXlDLEdBQUc7QUFDeEMsV0FBTztBQUNIQyxNQUFBQSxrQkFBa0IsRUFBRTtBQURqQixLQUFQO0FBR0g7O0FBRURDLEVBQUFBLDJCQUEyQixHQUFHO0FBQzFCLFdBQU8sS0FBUDtBQUNIOztBQUVEQyxFQUFBQSxVQUFVLEdBQUc7QUFDVCxVQUFNdEUsT0FBTyxHQUFHL0IsWUFBWSxDQUFDLEtBQUtnQyxRQUFMLEVBQUQsQ0FBNUI7QUFDQSxXQUFPL0IsWUFBWSxDQUFDcUcsUUFBYixDQUFzQnZFLE9BQXRCLENBQVA7QUFDSDs7QUFFRFMsRUFBQUEsVUFBVSxHQUFHO0FBQ1QsVUFBTVQsT0FBTyxHQUFHL0IsWUFBWSxDQUFDLEtBQUtnQyxRQUFMLEVBQUQsQ0FBNUI7QUFDQSxXQUFPOUIsWUFBWSxDQUFDb0csUUFBYixDQUFzQnZFLE9BQXRCLENBQVA7QUFDSDs7QUFFRHdFLEVBQUFBLGVBQWUsR0FBRztBQUNkLFVBQU14RSxPQUFPLEdBQUcvQixZQUFZLENBQUMsS0FBS2dDLFFBQUwsRUFBRCxDQUE1QjtBQUNBLFdBQU9ELE9BQU8sS0FBS2hDLFdBQVcsQ0FBQ3lHLE1BQS9CO0FBQ0g7O0FBdlBrQzs7QUEwUHZDQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ0RyxnQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5jb25zdCBxID0gcmVxdWlyZSgncScpO1xyXG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudGVtaXR0ZXIzJyk7XHJcbmNvbnN0IFByaW50ZXIgPSByZXF1aXJlKCdlYWdsZS1wcmludC9tb2RlbC9wcmludGVyJyk7XHJcblxyXG5jb25zdCB1dGlsID0gcmVxdWlyZSgnLi91dGlsLmpzJyk7XHJcbmNvbnN0IHtcclxuICAgIFByaW50ZXJTdGF0ZUVudW0sXHJcbiAgICBQcmludGVyQ29ublR5cGVFbnVtLFxyXG4gICAgQm90VHlwZUVudW0sXHJcbiAgICBHZW5kZXJUb1R5cGUsXHJcbiAgICBGaWZ0aEdlbkJvdHMsXHJcbiAgICBTaXh0aEdlbkJvdHMsXHJcbiAgICBQcmludGVyR2VuZGVyVG9EZWZhdWx0RXh0cnVkZXJzLFxyXG59ID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKTtcclxuXHJcbi8vIE9uZSBvZiB0aGVzZSBkYXlzIHdlJ2xsIG1ha2UgYSB1bmlmaWVkIGludGVyZmFjZSBmb3IgcmVhbCBwcmludGVycyBhbmQgYXJjaGV0eXBlcy4uLi5cclxuXHJcbmNsYXNzIEFyY2hldHlwZVByaW50ZXIgZXh0ZW5kcyBQcmludGVyIHtcclxuICAgIGNvbnN0cnVjdG9yKHZlbmRvck5hbWUsIGdlbmRlcikge1xyXG4gICAgICAgIGNvbnN0IGdlbmRlck5hbWUgPSBnZW5kZXIuZ2V0TmFtZSgpO1xyXG4gICAgICAgIGNvbnN0IHByaW50ZXJJZCA9IGBvZmZsaW5lOiR7dmVuZG9yTmFtZX06JHtnZW5kZXJOYW1lfToke2dlbmRlck5hbWV9YDtcclxuICAgICAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAgICAgICBpZDogcHJpbnRlcklkLFxyXG4gICAgICAgICAgICBpcF9hZGRyZXNzOiAnT0ZGTElORScsXHJcbiAgICAgICAgICAgIG5hbWU6IGdlbmRlck5hbWUsXHJcbiAgICAgICAgICAgIGNvbm5lY3RlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIHByaW50ZXJfc3RhdHVzOiB7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZTogJ09mZmxpbmUnLCAvLyBUT0RPOiByZWFsIHN0YXR1c2VzIGhlcmVcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRfcHJpbnRfam9iOiBudWxsLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBwcmludGVyX2luZm86IHtcclxuICAgICAgICAgICAgICAgIHZlbmRvcjogdmVuZG9yTmFtZSxcclxuICAgICAgICAgICAgICAgIG1vZGVsOiBnZW5kZXJOYW1lLFxyXG4gICAgICAgICAgICAgICAgbW9kZWxOYW1lOiBnZW5kZXJOYW1lLFxyXG4gICAgICAgICAgICAgICAgZmlybXdhcmVfdmVyc2lvbjogJzAuMC4wJyxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBzdXBlcihkYXRhLCBudWxsLCBnZW5kZXIpO1xyXG5cclxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcclxuXHJcbiAgICAgICAgc2VsZi5fZ2VuZGVyID0gZ2VuZGVyO1xyXG4gICAgICAgIHNlbGYuX21hY2hpbmVDb25maWcgPSB7fTtcclxuXHJcbiAgICAgICAgLy8gTm90aWZpY2F0aW9ucyBmb3IgY3JpdGljYWwgdXBkYXRlcyAoc3lzdGVtLCBzdGF0ZXMsIHNjaGVtYSB1cGRhdGVzLCBldGMuLilcclxuICAgICAgICBzZWxmLl91cGRhdGVOb3RpZmljYXRpb25zID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG5cclxuICAgICAgICAvLyBkdW1waW5nIHRoaW5ncyBpbnRvIHRoaXMgX2luZm8gb2JqZWN0IGZvciBjb21wYXRpYmlsaXR5IHdpdGhcclxuICAgICAgICAvLyBlYWdsZSBwcmludCBwcmludGVyXHJcbiAgICAgICAgc2VsZi5faW5mbyA9IHtcclxuICAgICAgICAgICAgZ2V0IGlkKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHByaW50ZXJJZDtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0IG5hbWUoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZ2VuZGVyTmFtZTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0IGlwKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICdPRkZMSU5FJztcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvLyB0aGVzZSBhcmUgc3RhdHVzIHByb3BlcnRpZXMgZ2VuZXJpYyB0byBlYWdsZS1wcmludCdzIHByaW50ZXJcclxuICAgICAgICBzZWxmLl9pbmZvLnByaW50ZXJfc3RhdHVzID0gZGF0YS5wcmludGVyX3N0YXR1cztcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gZ2V0RGVmYXVsdEV4dHJ1ZGVycygpIHtcclxuICAgICAgICAgICAgY29uc3QgYm90VHlwZSA9IEdlbmRlclRvVHlwZVtzZWxmLmdldE1vZGVsKCldO1xyXG4gICAgICAgICAgICByZXR1cm4gUHJpbnRlckdlbmRlclRvRGVmYXVsdEV4dHJ1ZGVyc1tib3RUeXBlXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHNlbGYuYXR0YWNoZWRFeHRydWRlcnMgPSBnZXREZWZhdWx0RXh0cnVkZXJzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgX2luaXRQcmludGVyKCkge1xyXG4gICAgICAgIC8vIEFkZCBtYWNoaW5lIGNvbmZpZyBjb2RlIGhlcmVcclxuICAgICAgICAvLyBzZWxmLl9nZXRNYWNoaW5lQ29uZmlnKCkuZG9uZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldExhc3RFcnJvcigpIHtcclxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG5cclxuICAgIGlzTWlzc2luZ0V4dHJ1ZGVyKCkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRDaGFtYmVySW5mbygpIHtcclxuICAgICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U3Bvb2xJbmZvKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmlzU2l4dGhHZW4oKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gcShbeyB0YWdfdWlkOiBudWxsIH0sIHsgdGFnX3VpZDogbnVsbCB9XSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHEobnVsbCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByb2Nlc3NNZXRob2RFeGlzdHMoKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFRyYWNraW5nSW5mbygpIHtcclxuICAgICAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAgICAgICBwcmludGVyX2lkOiB0aGlzLmdldElkKCksXHJcbiAgICAgICAgICAgIHByaW50ZXJfdHlwZTogdXRpbC5nZW5kZXJUb0NvZGVOYW1lKHRoaXMuZ2V0SW5mbygpLm1vZGVsKSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBkYXRhO1xyXG4gICAgfVxyXG5cclxuICAgIGRpc2Nvbm5lY3QoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0SW5mbygpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB2ZW5kb3I6ICdNYWtlckJvdCcsXHJcbiAgICAgICAgICAgIG1vZGVsOiB0aGlzLl9ib3RHZW5kZXIsXHJcbiAgICAgICAgICAgIG1vZGVsTmFtZTogdGhpcy5faW5mby5uYW1lLFxyXG4gICAgICAgICAgICBmaXJtd2FyZV92ZXJzaW9uOiB0aGlzLmZpcm13YXJlVmVyc2lvbixcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGdldFN0YXR1cygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faW5mby5wcmludGVyX3N0YXR1cztcclxuICAgIH1cclxuXHJcbiAgICBnZXREaXNwbGF5U3RhdHVzKCkge1xyXG4gICAgICAgIHJldHVybiAnRXhwb3J0T25seSc7XHJcbiAgICB9XHJcblxyXG4gICAgaXNBdXRoZW50aWNhdGVkKCkge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGlzQ29ubmVjdGVkKCkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBkZWF1dGhlbnRpY2F0ZSgpIHt9XHJcblxyXG4gICAgLy8vIFRoZSB0b29scGF0aCB0aGF0IGdldHMgaGVyZSBpcyBwcm9iYWJseSBhbiBlYWdsZS1wcmludC9tb2RlbC90b29scGF0aC5qc1xyXG4gICAgLy8vIFRvb2xwYXRoIG9iamVjdCBtYWRlIGZyb20gd2hhdCBpcyByZXR1cm5lZCBieSAnYnVpbGQnIGluIG1ha2VyYm90LmpzLi4uXHJcbiAgICBwcmludCh0b29sUGF0aCkge1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG5cclxuICAgICAgICBpZiAoc2VsZi5nZXRTdGF0dXMoKS5zdGF0ZSAhPT0gUHJpbnRlclN0YXRlRW51bS5JZGxlKSB7XHJcbiAgICAgICAgICAgIC8vIFRPRE86IHNvbWV0aGluZyBzb21ldGhpbmcgcHJpbnQgcXVldWVpbmdcclxuICAgICAgICAgICAgdGhyb3cgJ1VuYWJsZSB0byBwcmludCB0byB0aGlzIHByaW50ZXIgYXQgdGhpcyB0aW1lJztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIFRPRE86IG5ldyBwcmludCBmbG93IHN1cHBvcnRcclxuICAgICAgICBjb25zdCBsb2NhbFBhdGggPSB0b29sUGF0aC5nZXQoJ3BhdGgnKTtcclxuICAgICAgICBjb25zdCBmaWxlbmFtZSA9IHRvb2xQYXRoLmdldCgnbmFtZScpO1xyXG4gICAgICAgIGNvbnN0IHJlbW90ZVBhdGggPSBgL2N1cnJlbnRfdGhpbmcvJHtmaWxlbmFtZX1gO1xyXG5cclxuICAgICAgICByZXR1cm4gcShcclxuICAgICAgICAgICAgc2VsZi5fcHJpbnRlci5QdXQobG9jYWxQYXRoLCByZW1vdGVQYXRoKS50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHNlbGYuX3ByaW50ZXIuUHJpbnQoZmlsZW5hbWUpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgY2FuY2VsKCkge31cclxuXHJcbiAgICBfZ2V0TWFjaGluZUNvbmZpZygpIHtcclxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcclxuICAgICAgICByZXR1cm4gcShzZWxmLl9wcmludGVyLkdldE1hY2hpbmVDb25maWcoKSkudGhlbihjb25maWcgPT4ge1xyXG4gICAgICAgICAgICBzZWxmLl9tYWNoaW5lQ29uZmlnID0gY29uZmlnO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIF91cGRhdGVGcm9tRXh0cnVkZXJDaGFuZ2UoaW5kZXgsIGNvbmZpZykge1xyXG4gICAgICAgIC8vIFRPRE8oc2hpcmxleSk6IG1ha2UgdGhpcyB3b3JrLCB3aGVuIEkgYWN0dWFsbHkgZmlndXJlIG91dCBob3cgdG9cclxuICAgICAgICAvLyBnZXQgdGhlc2Ugbm90aWZpY2F0aW9ucyBmcm9tIHRoZSBib3QuLi5cclxuICAgIH1cclxuXHJcbiAgICBhdXRoZW50aWNhdGUoYXV0aEluZm8pIHt9XHJcblxyXG4gICAgX2Z3VmVyRGljdFRvU3RyaW5nKGZ3VmVyRGljdCkge1xyXG4gICAgICAgIGlmIChmd1ZlckRpY3QgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gW2Z3VmVyRGljdC5tYWpvciwgZndWZXJEaWN0Lm1pbm9yLCBmd1ZlckRpY3QuYnVnZml4LCBmd1ZlckRpY3QuYnVpbGRdLmpvaW4oJy4nKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Q29kZU5hbWUoKSB7XHJcbiAgICAgICAgcmV0dXJuIHV0aWwuZ2VuZGVyVG9Db2RlTmFtZSh0aGlzLmdldEdlbmRlcigpLmdldE5hbWUoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Q29ubmVjdGlvblR5cGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIFByaW50ZXJDb25uVHlwZUVudW0uQVJDSEVUWVBFO1xyXG4gICAgfVxyXG5cclxuICAgIGdldENhbWVyYUZlZWQoY2FtZXJhRnJhbWVDYWxsYmFjaykge1xyXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgZW5kQ2FtZXJhRmVlZCgpIHt9XHJcblxyXG4gICAgLy8gZXh0cnVkZXJMaXN0IHNob3VsZCBiZSBhbiBhcnJheSwgZXZlbiBpZiB0aGVyZSBpcyBvbmx5IG9uZSBleHRydWRlclxyXG4gICAgc2V0QXR0YWNoZWRFeHRydWRlcnMoZXh0cnVkZXJMaXN0LCBpbmRleCA9IG51bGwpIHtcclxuICAgICAgICBpZiAoaW5kZXggIT09IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy5hdHRhY2hlZEV4dHJ1ZGVyc1tpbmRleF0gPSBleHRydWRlckxpc3Q7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5hdHRhY2hlZEV4dHJ1ZGVycyA9IGV4dHJ1ZGVyTGlzdDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QXR0YWNoZWRFeHRydWRlcnMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXR0YWNoZWRFeHRydWRlcnM7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gZG9pbmcgdGhpcyAoanVzdCBpbiBjYXNlKSB1bnRpbCBlYWdsZS1wcmludCdzIHByaW50ZXIgc2V0dGxlcyBkb3duLi4uXHJcbiAgICBnZXQgcmF3RGF0YSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faW5mbztcclxuICAgIH1cclxuXHJcbiAgICBnZXQgbWFjaGluZUNvbmZpZygpIHtcclxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkOyAvL3RoaXMuX21hY2hpbmVDb25maWc7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGZpcm13YXJlVmVyc2lvbigpIHtcclxuICAgICAgICByZXR1cm4gJzAuMC4wJztcclxuICAgIH1cclxuXHJcbiAgICBnZXQgYXBpVmVyc2lvbigpIHtcclxuICAgICAgICByZXR1cm4gJzAuMC4wJztcclxuICAgIH1cclxuXHJcbiAgICBnZXQgY3VycmVudFN0YXRlKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9pbmZvO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBfYm90R2VuZGVyKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9nZW5kZXIuZ2V0TmFtZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCB1cGRhdGVOb3RpZmljYXRpb25zKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVOb3RpZmljYXRpb25zO1xyXG4gICAgfVxyXG5cclxuICAgIGNoZWNrRm9yVW5zdXBwb3J0ZWRFeHRydWRlckNvbmZpZ3VyYXRpb25zKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGV4dHJ1ZGVyU2V0dXBFcnJvcjogZmFsc2UsXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBoYXNFeHRydWRlck1hdGVyaWFsTWlzbWF0Y2goKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGlzRmlmdGhHZW4oKSB7XHJcbiAgICAgICAgY29uc3QgYm90VHlwZSA9IEdlbmRlclRvVHlwZVt0aGlzLmdldE1vZGVsKCldO1xyXG4gICAgICAgIHJldHVybiBGaWZ0aEdlbkJvdHMuaW5jbHVkZXMoYm90VHlwZSk7XHJcbiAgICB9XHJcblxyXG4gICAgaXNTaXh0aEdlbigpIHtcclxuICAgICAgICBjb25zdCBib3RUeXBlID0gR2VuZGVyVG9UeXBlW3RoaXMuZ2V0TW9kZWwoKV07XHJcbiAgICAgICAgcmV0dXJuIFNpeHRoR2VuQm90cy5pbmNsdWRlcyhib3RUeXBlKTtcclxuICAgIH1cclxuXHJcbiAgICBpc1NrZXRjaFByaW50ZXIoKSB7XHJcbiAgICAgICAgY29uc3QgYm90VHlwZSA9IEdlbmRlclRvVHlwZVt0aGlzLmdldE1vZGVsKCldO1xyXG4gICAgICAgIHJldHVybiBib3RUeXBlID09PSBCb3RUeXBlRW51bS5za2V0Y2g7XHJcbiAgICB9XHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0gQXJjaGV0eXBlUHJpbnRlcjtcclxuIl19
