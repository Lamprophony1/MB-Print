"use strict";

const {
  BotTypeEnum,
  SixthGenBots
} = require('../../constants');

const PrintSettingsStore = require('../../stores/printSettingsStore');

describe('Print Settings Store Tests', () => {
  let printSettingsStoreInstance;
  beforeEach(() => {
    printSettingsStoreInstance = new PrintSettingsStore();
  });
  describe('Testing _getSelectedMaterials', () => {
    const getSelectedMaterialsTestCases = [{
      sombrero: {
        constants: {
          supportedMaterialsByExtruder: [['im-pla', 'pla'], ['pva']],
          extruders: ['mk14', 'mk14']
        },
        scenarios: [{
          // default material selection for archetype Method
          msg: 'should default selected materials to [im-pla, pva] for archetype Method bots',
          spoolMaterials: ['generic_model', 'pva'],
          selectedMaterials: ['generic_model', 'pva'],
          printerIsConnected: false,
          expectedSelectedMaterials: ['im-pla', 'pva']
        }, {
          // user selects pla on archetype Method
          msg: 'should assign selected materials to [pla, pva] when user selects it for archetype Method bots',
          spoolMaterials: ['generic_model', 'pva'],
          selectedMaterials: ['pla', 'pva'],
          printerIsConnected: false,
          expectedSelectedMaterials: ['pla', 'pva']
        }, {
          // live printer with nothing loaded in bay1
          msg: 'should assign selected materials to [generic_model, pva] with nothing loaded in Bay 1',
          spoolMaterials: ['generic_model', 'pva'],
          selectedMaterials: [],
          supportedMaterialsByExtruder: ['generic_model', 'pva'],
          printerIsConnected: true,
          expectedSelectedMaterials: ['generic_model', 'pva']
        }, {
          // live printer with im-pla loaded in bay1
          msg: 'should assign selected materials to [im-pla, pva] with im-pla loaded in the first bay',
          spoolMaterials: ['im-pla', 'pva'],
          selectedMaterials: ['im-pla', 'pva'],
          supportedMaterialsByExtruder: [['im-pla'], ['pva']],
          printerIsConnected: true,
          expectedSelectedMaterials: ['im-pla', 'pva']
        }]
      }
    }, {
      '5th gen Printers (includes Replicator 2)': {
        constants: {
          supportedMaterialsByExtruder: [['pla']],
          extruders: ['mk13']
        },
        scenarios: [{
          // Default material selection for 5th gen
          // and replicator 2
          msg: 'should default the selected materials to [pla]',
          spoolMaterials: [],
          selectedMaterials: [],
          expectedSelectedMaterials: ['pla']
        }]
      }
    }];

    const runTestCases = testCases => {
      let descriptionStr;
      return testCases.forEach(environment => {
        const printer = Object.keys(environment)[0];
        const {
          constants,
          scenarios
        } = environment[printer];
        const {
          extruders
        } = constants;
        descriptionStr = `with ${printer}`;
        return describe(descriptionStr, () => {
          scenarios.forEach(scenario => {
            const {
              spoolMaterials,
              selectedMaterials,
              supportedMaterialsByExtruder,
              printerIsConnected,
              printMode,
              expectedSelectedMaterials,
              msg
            } = scenario;
            const supportedMaterials = supportedMaterialsByExtruder || constants.supportedMaterialsByExtruder;
            return test(msg, () => {
              expect(printSettingsStoreInstance._getSelectedMaterials({
                spoolMaterials,
                selectedMaterials,
                supportedMaterialsByExtruder: supportedMaterials,
                printerIsConnected,
                printMode,
                extruders
              })).toEqual(expectedSelectedMaterials);
            });
          });
        });
      });
    };

    runTestCases(getSelectedMaterialsTestCases);
  });
  describe('Testing generateSupportedExtrudersInfo', () => {
    const {
      supportedConfigurations
    } = require('../../test_data/supportedConfigurations');

    const testCases = [{
      [BotTypeEnum.lava_f]: {
        extrudersPerIndex: [['mk14', 'mk14_hot'], ['mk14_s', 'mk14_hot_s']],
        extruderPairConfigs: [['mk14', 'mk14_s'], ['mk14_hot', 'mk14_hot_s']]
      }
    }, {
      [BotTypeEnum.fire_e]: {
        extrudersPerIndex: [['mk14'], ['mk14_s']],
        extruderPairConfigs: [['mk14', 'mk14_s']]
      }
    }, {
      [BotTypeEnum.z18_6]: {
        extrudersPerIndex: [['mk13', 'mk13_impla']]
      }
    }];

    const runTestCases = testCases => {
      return testCases.forEach(testCase => {
        // Setting up environment
        const [botType] = Object.keys(testCase);
        const {
          extrudersPerIndex
        } = testCase[botType];
        const {
          extruderPairConfigs
        } = SixthGenBots.includes(botType) ? testCase[botType] : {};
        const printer = {
          getGender: () => ({
            botType
          })
        };
        /**
         * **NOTE**
         * not sure why the beforeEach not initializing PrintSettingsStores,
         * but this is one way to get around it for now...
         */

        printSettingsStoreInstance = new PrintSettingsStore();
        return describe(`with ${botType}`, () => {
          const {
            supportedExtrudersPerIndex,
            supportedExtruderPairConfigs
          } = printSettingsStoreInstance.generateSupportedExtrudersInfo({
            printer,
            printMode: null,
            supportedConfigurations
          });
          test(`supportedExtruderPerIndex should return ${JSON.stringify(extrudersPerIndex)}`, () => {
            expect(supportedExtrudersPerIndex).toEqual(extrudersPerIndex);
          });
          extruderPairConfigs ? test(`supportedExtruderPairConfigs should return ${JSON.stringify(extruderPairConfigs)}`, () => {
            expect(supportedExtruderPairConfigs).toEqual(extruderPairConfigs);
          }) : null;
          return;
        });
      });
    };

    runTestCases(testCases);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByaW50U2V0dGluZ3NTdG9yZS5qcyJdLCJuYW1lcyI6WyJCb3RUeXBlRW51bSIsIlNpeHRoR2VuQm90cyIsInJlcXVpcmUiLCJQcmludFNldHRpbmdzU3RvcmUiLCJkZXNjcmliZSIsInByaW50U2V0dGluZ3NTdG9yZUluc3RhbmNlIiwiYmVmb3JlRWFjaCIsImdldFNlbGVjdGVkTWF0ZXJpYWxzVGVzdENhc2VzIiwic29tYnJlcm8iLCJjb25zdGFudHMiLCJzdXBwb3J0ZWRNYXRlcmlhbHNCeUV4dHJ1ZGVyIiwiZXh0cnVkZXJzIiwic2NlbmFyaW9zIiwibXNnIiwic3Bvb2xNYXRlcmlhbHMiLCJzZWxlY3RlZE1hdGVyaWFscyIsInByaW50ZXJJc0Nvbm5lY3RlZCIsImV4cGVjdGVkU2VsZWN0ZWRNYXRlcmlhbHMiLCJydW5UZXN0Q2FzZXMiLCJ0ZXN0Q2FzZXMiLCJkZXNjcmlwdGlvblN0ciIsImZvckVhY2giLCJlbnZpcm9ubWVudCIsInByaW50ZXIiLCJPYmplY3QiLCJrZXlzIiwic2NlbmFyaW8iLCJwcmludE1vZGUiLCJzdXBwb3J0ZWRNYXRlcmlhbHMiLCJ0ZXN0IiwiZXhwZWN0IiwiX2dldFNlbGVjdGVkTWF0ZXJpYWxzIiwidG9FcXVhbCIsInN1cHBvcnRlZENvbmZpZ3VyYXRpb25zIiwibGF2YV9mIiwiZXh0cnVkZXJzUGVySW5kZXgiLCJleHRydWRlclBhaXJDb25maWdzIiwiZmlyZV9lIiwiejE4XzYiLCJ0ZXN0Q2FzZSIsImJvdFR5cGUiLCJpbmNsdWRlcyIsImdldEdlbmRlciIsInN1cHBvcnRlZEV4dHJ1ZGVyc1BlckluZGV4Iiwic3VwcG9ydGVkRXh0cnVkZXJQYWlyQ29uZmlncyIsImdlbmVyYXRlU3VwcG9ydGVkRXh0cnVkZXJzSW5mbyIsIkpTT04iLCJzdHJpbmdpZnkiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQSxXQUFGO0FBQWVDLEVBQUFBO0FBQWYsSUFBZ0NDLE9BQU8sQ0FBQyxpQkFBRCxDQUE3Qzs7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QUFQO0FBd0NILEtBekNEOztBQTJDQWxCLElBQUFBLFlBQVksQ0FBQ0MsU0FBRCxDQUFaO0FBQ0gsR0FsRU8sQ0FBUjtBQW1FSCxDQTNMTyxDQUFSIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBCb3RUeXBlRW51bSwgU2l4dGhHZW5Cb3RzIH0gPSByZXF1aXJlKCcuLi8uLi9jb25zdGFudHMnKTtcclxuY29uc3QgUHJpbnRTZXR0aW5nc1N0b3JlID0gcmVxdWlyZSgnLi4vLi4vc3RvcmVzL3ByaW50U2V0dGluZ3NTdG9yZScpO1xyXG5cclxuZGVzY3JpYmUoJ1ByaW50IFNldHRpbmdzIFN0b3JlIFRlc3RzJywgKCkgPT4ge1xyXG4gICAgbGV0IHByaW50U2V0dGluZ3NTdG9yZUluc3RhbmNlO1xyXG5cclxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICAgIHByaW50U2V0dGluZ3NTdG9yZUluc3RhbmNlID0gbmV3IFByaW50U2V0dGluZ3NTdG9yZSgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ1Rlc3RpbmcgX2dldFNlbGVjdGVkTWF0ZXJpYWxzJywgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGdldFNlbGVjdGVkTWF0ZXJpYWxzVGVzdENhc2VzID0gW1xyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBzb21icmVybzoge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0YW50czoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdXBwb3J0ZWRNYXRlcmlhbHNCeUV4dHJ1ZGVyOiBbWydpbS1wbGEnLCAncGxhJ10sIFsncHZhJ11dLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBleHRydWRlcnM6IFsnbWsxNCcsICdtazE0J10sXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBzY2VuYXJpb3M6IFtcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGVmYXVsdCBtYXRlcmlhbCBzZWxlY3Rpb24gZm9yIGFyY2hldHlwZSBNZXRob2RcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZzogJ3Nob3VsZCBkZWZhdWx0IHNlbGVjdGVkIG1hdGVyaWFscyB0byBbaW0tcGxhLCBwdmFdIGZvciBhcmNoZXR5cGUgTWV0aG9kIGJvdHMnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Bvb2xNYXRlcmlhbHM6IFsnZ2VuZXJpY19tb2RlbCcsICdwdmEnXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkTWF0ZXJpYWxzOiBbJ2dlbmVyaWNfbW9kZWwnLCAncHZhJ10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludGVySXNDb25uZWN0ZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWRTZWxlY3RlZE1hdGVyaWFsczogWydpbS1wbGEnLCAncHZhJ10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVzZXIgc2VsZWN0cyBwbGEgb24gYXJjaGV0eXBlIE1ldGhvZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzaG91bGQgYXNzaWduIHNlbGVjdGVkIG1hdGVyaWFscyB0byBbcGxhLCBwdmFdIHdoZW4gdXNlciBzZWxlY3RzIGl0IGZvciBhcmNoZXR5cGUgTWV0aG9kIGJvdHMnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Bvb2xNYXRlcmlhbHM6IFsnZ2VuZXJpY19tb2RlbCcsICdwdmEnXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkTWF0ZXJpYWxzOiBbJ3BsYScsICdwdmEnXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ZXJJc0Nvbm5lY3RlZDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBlY3RlZFNlbGVjdGVkTWF0ZXJpYWxzOiBbJ3BsYScsICdwdmEnXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGl2ZSBwcmludGVyIHdpdGggbm90aGluZyBsb2FkZWQgaW4gYmF5MVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzaG91bGQgYXNzaWduIHNlbGVjdGVkIG1hdGVyaWFscyB0byBbZ2VuZXJpY19tb2RlbCwgcHZhXSB3aXRoIG5vdGhpbmcgbG9hZGVkIGluIEJheSAxJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwb29sTWF0ZXJpYWxzOiBbJ2dlbmVyaWNfbW9kZWwnLCAncHZhJ10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZE1hdGVyaWFsczogW10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdXBwb3J0ZWRNYXRlcmlhbHNCeUV4dHJ1ZGVyOiBbJ2dlbmVyaWNfbW9kZWwnLCAncHZhJ10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludGVySXNDb25uZWN0ZWQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBlY3RlZFNlbGVjdGVkTWF0ZXJpYWxzOiBbJ2dlbmVyaWNfbW9kZWwnLCAncHZhJ10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxpdmUgcHJpbnRlciB3aXRoIGltLXBsYSBsb2FkZWQgaW4gYmF5MVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzaG91bGQgYXNzaWduIHNlbGVjdGVkIG1hdGVyaWFscyB0byBbaW0tcGxhLCBwdmFdIHdpdGggaW0tcGxhIGxvYWRlZCBpbiB0aGUgZmlyc3QgYmF5JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwb29sTWF0ZXJpYWxzOiBbJ2ltLXBsYScsICdwdmEnXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkTWF0ZXJpYWxzOiBbJ2ltLXBsYScsICdwdmEnXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1cHBvcnRlZE1hdGVyaWFsc0J5RXh0cnVkZXI6IFtbJ2ltLXBsYSddLCBbJ3B2YSddXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ZXJJc0Nvbm5lY3RlZDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkU2VsZWN0ZWRNYXRlcmlhbHM6IFsnaW0tcGxhJywgJ3B2YSddLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAnNXRoIGdlbiBQcmludGVycyAoaW5jbHVkZXMgUmVwbGljYXRvciAyKSc6IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdGFudHM6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3VwcG9ydGVkTWF0ZXJpYWxzQnlFeHRydWRlcjogW1sncGxhJ11dLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBleHRydWRlcnM6IFsnbWsxMyddLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgc2NlbmFyaW9zOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmF1bHQgbWF0ZXJpYWwgc2VsZWN0aW9uIGZvciA1dGggZ2VuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgcmVwbGljYXRvciAyXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2c6ICdzaG91bGQgZGVmYXVsdCB0aGUgc2VsZWN0ZWQgbWF0ZXJpYWxzIHRvIFtwbGFdJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwb29sTWF0ZXJpYWxzOiBbXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkTWF0ZXJpYWxzOiBbXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkU2VsZWN0ZWRNYXRlcmlhbHM6IFsncGxhJ10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgXTtcclxuXHJcbiAgICAgICAgY29uc3QgcnVuVGVzdENhc2VzID0gdGVzdENhc2VzID0+IHtcclxuICAgICAgICAgICAgbGV0IGRlc2NyaXB0aW9uU3RyO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHRlc3RDYXNlcy5mb3JFYWNoKGVudmlyb25tZW50ID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHByaW50ZXIgPSBPYmplY3Qua2V5cyhlbnZpcm9ubWVudClbMF07XHJcbiAgICAgICAgICAgICAgICBjb25zdCB7IGNvbnN0YW50cywgc2NlbmFyaW9zIH0gPSBlbnZpcm9ubWVudFtwcmludGVyXTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHsgZXh0cnVkZXJzIH0gPSBjb25zdGFudHM7XHJcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvblN0ciA9IGB3aXRoICR7cHJpbnRlcn1gO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZShkZXNjcmlwdGlvblN0ciwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHNjZW5hcmlvcy5mb3JFYWNoKHNjZW5hcmlvID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Bvb2xNYXRlcmlhbHMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZE1hdGVyaWFscyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1cHBvcnRlZE1hdGVyaWFsc0J5RXh0cnVkZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludGVySXNDb25uZWN0ZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludE1vZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBlY3RlZFNlbGVjdGVkTWF0ZXJpYWxzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9ID0gc2NlbmFyaW87XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdXBwb3J0ZWRNYXRlcmlhbHMgPVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VwcG9ydGVkTWF0ZXJpYWxzQnlFeHRydWRlciB8fCBjb25zdGFudHMuc3VwcG9ydGVkTWF0ZXJpYWxzQnlFeHRydWRlcjtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZXN0KG1zZywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50U2V0dGluZ3NTdG9yZUluc3RhbmNlLl9nZXRTZWxlY3RlZE1hdGVyaWFscyh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwb29sTWF0ZXJpYWxzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZE1hdGVyaWFscyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VwcG9ydGVkTWF0ZXJpYWxzQnlFeHRydWRlcjogc3VwcG9ydGVkTWF0ZXJpYWxzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludGVySXNDb25uZWN0ZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50TW9kZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0cnVkZXJzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLnRvRXF1YWwoZXhwZWN0ZWRTZWxlY3RlZE1hdGVyaWFscyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJ1blRlc3RDYXNlcyhnZXRTZWxlY3RlZE1hdGVyaWFsc1Rlc3RDYXNlcyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnVGVzdGluZyBnZW5lcmF0ZVN1cHBvcnRlZEV4dHJ1ZGVyc0luZm8nLCAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgeyBzdXBwb3J0ZWRDb25maWd1cmF0aW9ucyB9ID0gcmVxdWlyZSgnLi4vLi4vdGVzdF9kYXRhL3N1cHBvcnRlZENvbmZpZ3VyYXRpb25zJyk7XHJcbiAgICAgICAgY29uc3QgdGVzdENhc2VzID0gW1xyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBbQm90VHlwZUVudW0ubGF2YV9mXToge1xyXG4gICAgICAgICAgICAgICAgICAgIGV4dHJ1ZGVyc1BlckluZGV4OiBbWydtazE0JywgJ21rMTRfaG90J10sIFsnbWsxNF9zJywgJ21rMTRfaG90X3MnXV0sXHJcbiAgICAgICAgICAgICAgICAgICAgZXh0cnVkZXJQYWlyQ29uZmlnczogW1snbWsxNCcsICdtazE0X3MnXSwgWydtazE0X2hvdCcsICdtazE0X2hvdF9zJ11dLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgW0JvdFR5cGVFbnVtLmZpcmVfZV06IHtcclxuICAgICAgICAgICAgICAgICAgICBleHRydWRlcnNQZXJJbmRleDogW1snbWsxNCddLCBbJ21rMTRfcyddXSxcclxuICAgICAgICAgICAgICAgICAgICBleHRydWRlclBhaXJDb25maWdzOiBbWydtazE0JywgJ21rMTRfcyddXSxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIFtCb3RUeXBlRW51bS56MThfNl06IHtcclxuICAgICAgICAgICAgICAgICAgICBleHRydWRlcnNQZXJJbmRleDogW1snbWsxMycsICdtazEzX2ltcGxhJ11dLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICBdO1xyXG5cclxuICAgICAgICBjb25zdCBydW5UZXN0Q2FzZXMgPSB0ZXN0Q2FzZXMgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gdGVzdENhc2VzLmZvckVhY2godGVzdENhc2UgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gU2V0dGluZyB1cCBlbnZpcm9ubWVudFxyXG4gICAgICAgICAgICAgICAgY29uc3QgW2JvdFR5cGVdID0gT2JqZWN0LmtleXModGVzdENhc2UpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgeyBleHRydWRlcnNQZXJJbmRleCB9ID0gdGVzdENhc2VbYm90VHlwZV07XHJcbiAgICAgICAgICAgICAgICBjb25zdCB7IGV4dHJ1ZGVyUGFpckNvbmZpZ3MgfSA9IFNpeHRoR2VuQm90cy5pbmNsdWRlcyhib3RUeXBlKSA/IHRlc3RDYXNlW2JvdFR5cGVdIDoge307XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwcmludGVyID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGdldEdlbmRlcjogKCkgPT4gKHsgYm90VHlwZSB9KSxcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAgICAgKiAqKk5PVEUqKlxyXG4gICAgICAgICAgICAgICAgICogbm90IHN1cmUgd2h5IHRoZSBiZWZvcmVFYWNoIG5vdCBpbml0aWFsaXppbmcgUHJpbnRTZXR0aW5nc1N0b3JlcyxcclxuICAgICAgICAgICAgICAgICAqIGJ1dCB0aGlzIGlzIG9uZSB3YXkgdG8gZ2V0IGFyb3VuZCBpdCBmb3Igbm93Li4uXHJcbiAgICAgICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgICAgIHByaW50U2V0dGluZ3NTdG9yZUluc3RhbmNlID0gbmV3IFByaW50U2V0dGluZ3NTdG9yZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZShgd2l0aCAke2JvdFR5cGV9YCwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3VwcG9ydGVkRXh0cnVkZXJzUGVySW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1cHBvcnRlZEV4dHJ1ZGVyUGFpckNvbmZpZ3MsXHJcbiAgICAgICAgICAgICAgICAgICAgfSA9IHByaW50U2V0dGluZ3NTdG9yZUluc3RhbmNlLmdlbmVyYXRlU3VwcG9ydGVkRXh0cnVkZXJzSW5mbyh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50TW9kZTogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3VwcG9ydGVkQ29uZmlndXJhdGlvbnMsXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRlc3QoYHN1cHBvcnRlZEV4dHJ1ZGVyUGVySW5kZXggc2hvdWxkIHJldHVybiAke0pTT04uc3RyaW5naWZ5KGV4dHJ1ZGVyc1BlckluZGV4KX1gLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzdXBwb3J0ZWRFeHRydWRlcnNQZXJJbmRleCkudG9FcXVhbChleHRydWRlcnNQZXJJbmRleCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGV4dHJ1ZGVyUGFpckNvbmZpZ3NcclxuICAgICAgICAgICAgICAgICAgICAgICAgPyB0ZXN0KGBzdXBwb3J0ZWRFeHRydWRlclBhaXJDb25maWdzIHNob3VsZCByZXR1cm4gJHtKU09OLnN0cmluZ2lmeShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0cnVkZXJQYWlyQ29uZmlnc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICl9YCwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc3VwcG9ydGVkRXh0cnVkZXJQYWlyQ29uZmlncykudG9FcXVhbChleHRydWRlclBhaXJDb25maWdzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJ1blRlc3RDYXNlcyh0ZXN0Q2FzZXMpO1xyXG4gICAgfSk7XHJcbn0pO1xyXG4iXX0=
