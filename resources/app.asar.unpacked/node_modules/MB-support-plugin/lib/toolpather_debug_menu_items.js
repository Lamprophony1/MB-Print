'use strict';

const fs = require('fs');

const MenuItemProvider = require('eagle-print').views.menu.MenuItemProvider;

const q = require('q');

const analyticUtils = require('eagle-print/util/analyticUtils');

const R = require('ramda');

const util = require('./util'); /// function for exporting files from @tmpPath to @dstPath, pretty much the
/// mb-plugin's export service
/// @returns a q.resolve or a q.reject depending on error status.
// eslint-disable-next-line no-unused-vars


const exportFile = function (tmpPath, dstPath) {
  // flag and function to log errors
  const done = function (err) {
    if (err) {
      return q.reject(err);
    }

    return q.resolve();
  }; // create a read stream from tmpPath, log on 'error'


  const rd = fs.createReadStream(tmpPath);
  rd.on('error', function (err) {
    done(err);
  }); // create write stream from dstPath, log on 'error'

  const wr = fs.createWriteStream(dstPath);
  wr.on('error', function (err) {
    done(err);
  });
  wr.on('close', function (ex) {
    done();
  }); // pipe the read path to the write path

  rd.pipe(wr);
}; /// function to log debug menu errors. for now just console log.


const logError = function (err) {
  console.error(err);
}; /// is @printer a makerbot printer


const isMakerbotPrinter = function (printer) {
  return printer && printer.getInfo().vendor.toLowerCase() === 'makerbot';
};

const progressReport = function (flux, fraction, action, actionLabel, actionCallback, closeAction, cursorStyle) {
  const idMessage = `project_${action}`;
  const textMessageProgress = `messages.project.${action}.progress`;
  const textMessageSuccess = `messages.project.${action}.success`;
  const i18n = flux.getService('TranslationService');

  if (fraction < 0) {
    // dismiss message (failed)
    flux.actions.message.dismissMessage(idMessage);
  } else if (fraction === 100) {
    // end message
    flux.actions.message.createSuccessMessage({
      id: idMessage,
      message: i18n.t(textMessageSuccess)
    });
  } else {
    // progress message
    flux.actions.message.updateProgress({
      progressPercentage: fraction,
      isIndeterminate: true,
      id: idMessage,
      message: i18n.t(textMessageProgress),
      actionLabel,
      actionCallback,
      closeAction,
      cursorStyle
    });
  }
};

module.exports = {
  /// the toolpather menu item, all other items will go inside of this one
  MBToolpathDebugMenu: MenuItemProvider.createSimpleMenuItemClass({
    displayName: 'DebugMBToolpath',
    label: 'MB Toolpather...'
  }, {
    unlocalized: true
  }),
  /// use a custom profile to slice the build plate and export the dot makerbot
  /// file. eventually, this should maybe be a print.
  MBCustomSliceMenuItem: MenuItemProvider.createSimpleMenuItemClass({
    displayName: 'MBCustomSlice',
    label: 'Custom MB Slice',

    action() {
      // use election.remote.dialogs to get the profile and save locations
      const remote = require('electron').remote;

      const flux = this.getFlux();
      const exportService = flux.getService('ExportService');
      const printer = flux.stores.PrinterStore.getSelectedPrinter(); // Must have selected an auth'ed printer.

      if (!isMakerbotPrinter(printer)) {
        flux.actions.message.createErrorMessage({
          message: 'This menu option requires selecting an authenticated MakerBot Printer'
        });
        logError('This menu option requires selecting a MakerBot Printer');
        return;
      } // ask the user for a config path, exit if not provided


      const configFilters = [{
        name: 'config',
        extensions: ['json']
      }];
      const configPath = remote.dialog.showOpenDialog(remote.getCurrentWindow(), {
        title: 'choose a profile',
        filters: configFilters
      });

      if (!configPath) {
        flux.actions.message.createErrorMessage({
          message: 'Please provide a valid profile path.'
        });
        return;
      } // Selected profile bot_type must match auth'ed printer bot_type.


      const parsedProfile = JSON.parse(fs.readFileSync(configPath[0], 'utf8'));

      if (printer.getGender().botType !== parsedProfile._bot) {
        flux.actions.message.createErrorMessage({
          message: 'Selected printer bot_type does not match profile bot_type.'
        });
        return;
      } // Ask the user for a save location, exit if not provided.


      const savePath = remote.dialog.showSaveDialog(remote.getCurrentWindow(), {
        title: 'choose a save location',
        filters: [exportService.getSupportedFormats(printer)]
      });

      if (!savePath) {
        flux.actions.message.createErrorMessage({
          message: 'Please provide a valid file save path.'
        });
        return;
      }

      const project = flux.stores.ProjectStore.getProject();
      const tray = project.getActiveTray();
      let customTray = null;
      const trayBodies = tray.getTrayBodies().toArray();
      trayBodies.forEach(trayBody => {
        const customOccurrence = trayBody.getOccurrence().setProperty('customProfilePath', configPath);
        const customBody = trayBody.setOccurrence(customOccurrence);
        customTray = tray.setTrayBody(customBody);
      }); // Wait for the current build to be cleared and then re-slice

      const buildStore = flux.stores.BuildStore;
      buildStore.once('change', () => {
        setImmediate(() => {
          flux.actions.printer.exportToFile(printer, customTray, project, savePath);
        });
      });
      flux.actions.printer.cancelBuildsForTray(customTray.getId());
    }

  }, {
    unlocalized: true
  }),
  /// export the current tray as a dot thing file
  ExportThingMenuItem: MenuItemProvider.createSimpleMenuItemClass({
    displayName: 'ExportThing',
    label: 'Export Thing',

    action() {
      // ask the user for an export path, exit if not provided
      const remote = require('electron').remote;

      const saveFilters = [{
        name: 'model',
        extensions: ['thing']
      }];
      const savePath = remote.dialog.showSaveDialog(remote.getCurrentWindow(), {
        title: 'choose a save location',
        filters: saveFilters
      });

      if (!savePath) {
        return;
      }
      /**
       * Use flux to get the current project and printer
       **/


      const flux = this.getFlux();
      const project = flux.stores.ProjectStore.getProject();
      const printer = flux.stores.PrinterStore.getSelectedPrinter();

      if (!isMakerbotPrinter(printer)) {
        logError('This menu option requires selecting a MakerBot Printer');
        return;
      }

      const ProjectService = flux.getService('ProjectService');
      return q().then(() => {
        progressReport(flux, 0, 'save');
      }).then(() => {
        ProjectService.save(project, savePath, flux);
      }).then(() => {
        progressReport(flux, 100, 'save');
      });
    }

  }, {
    unlocalized: true
  }),
  /// use the current settings and printer to generate / save a custom profile
  ExportCustomProfileMenuItem: MenuItemProvider.createSimpleMenuItemClass({
    displayName: 'ExportCustomProfile',
    label: 'Export Custom Profile',

    action() {
      // ask the user for an export path, exit if not provided
      const remote = require('electron').remote;

      const saveFilters = [{
        name: 'configuration',
        extensions: ['json']
      }];
      const savePath = remote.dialog.showSaveDialog(remote.getCurrentWindow(), {
        title: 'choose a save location',
        filters: saveFilters
      });

      if (!savePath) {
        return;
      } // use the flux stores to get the active tray and selected printer


      const flux = this.getFlux();
      const project = flux.stores.ProjectStore.getProject();
      const tray = project.getActiveTray();
      const printer = flux.stores.PrinterStore.getSelectedPrinter();

      if (!isMakerbotPrinter(printer)) {
        logError('This menu option requires selecting a MakerBot Printer');
        return;
      } // generate build info from the current project's active tray


      const rootOccurrences = project.getRootOccurrences();
      const tessellationMap = project.getTessellationMap();
      const buildInfo = tray.getBuildInfo(printer, {
        tessellationMap,
        rootOccurrences
      }); // turn the profile into a pretty json string and write it

      const saveProfile = function (profile) {
        const jsonString = JSON.stringify(profile, null, 2);
        fs.writeFileSync(savePath, jsonString);
      }; // use sliceconfig to generate a custom profile with the settings on the
      // current tray. save the resulting json to the desired save path


      const sliceconfig = require('./makerbot');

      sliceconfig.getProfile(buildInfo, printer, null, flux).then(saveProfile).catch(logError);
    }

  }, {
    unlocalized: true
  }),
  /// Opens dialog where user selects a dot makerbot (.makerbot) file to import
  /// and send to the selected printer.
  PrintFromToolpathMenuItem: MenuItemProvider.createSimpleMenuItemClass({
    displayName: 'PrintFromToolpath',
    label: 'Print from .makerbot',

    action() {
      // Make sure an authenticated (live) printer is selected.
      const remote = require('electron').remote;

      const flux = this.getFlux();
      const printer = flux.stores.PrinterStore.getSelectedPrinter();
      let loadPath = null; // A valid printer needs to be a makerbot printer, and not `Offline`

      const isValidPrinter = isMakerbotPrinter(printer) && printer.getStatus().state !== 'Offline';

      if (!isValidPrinter) {
        flux.actions.message.createErrorMessage({
          message: 'This menu option requires selecting an authenticated MakerBot Printer'
        });
        logError('This menu option requires selecting an authenticated MakerBot Printer');
        return;
      } // If printer is valid...


      return q() // Pop dialog, let user choose import dot makerbot file
      .then(() => {
        const loadFilters = [{
          name: 'makerbot',
          extensions: ['makerbot']
        }];
        loadPath = remote.dialog.showOpenDialog(remote.getCurrentWindow(), {
          title: 'choose a .makerbot file to print',
          filters: loadFilters
        });
        if (!loadPath) logError('No valid load path for .makerbot!');
        return;
      }).then(() => {
        const trackingService = this.props.flux.getService('TrackingService');
        const trackingInfo = util.trackingInfoForPrinter(printer);
        trackingInfo.extruder_type = printer.getCurrentExtruderType();
        const printSettings = analyticUtils.getPrintSettingsForAnalyticEvents(this.props.flux, printer);
        trackingService.addEvent(R.merge({
          name: 'Print Started From .makerbot'
        }, trackingInfo, printSettings));
      }) // Create a new project to clear the build plate.
      .then(() => flux.actions.file.newProject()) // Import toolpath, and send to selected printer.
      .then(() => flux.actions.file.importToolpath(loadPath[0])).catch(logError).done();
    }

  }, {
    unlocalized: true
  })
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRvb2xwYXRoZXJfZGVidWdfbWVudV9pdGVtcy5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJNZW51SXRlbVByb3ZpZGVyIiwidmlld3MiLCJtZW51IiwicSIsImFuYWx5dGljVXRpbHMiLCJSIiwidXRpbCIsImV4cG9ydEZpbGUiLCJ0bXBQYXRoIiwiZHN0UGF0aCIsImRvbmUiLCJlcnIiLCJyZWplY3QiLCJyZXNvbHZlIiwicmQiLCJjcmVhdGVSZWFkU3RyZWFtIiwib24iLCJ3ciIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiZXgiLCJwaXBlIiwibG9nRXJyb3IiLCJjb25zb2xlIiwiZXJyb3IiLCJpc01ha2VyYm90UHJpbnRlciIsInByaW50ZXIiLCJnZXRJbmZvIiwidmVuZG9yIiwidG9Mb3dlckNhc2UiLCJwcm9ncmVzc1JlcG9ydCIsImZsdXgiLCJmcmFjdGlvbiIsImFjdGlvbiIsImFjdGlvbkxhYmVsIiwiYWN0aW9uQ2FsbGJhY2siLCJjbG9zZUFjdGlvbiIsImN1cnNvclN0eWxlIiwiaWRNZXNzYWdlIiwidGV4dE1lc3NhZ2VQcm9ncmVzcyIsInRleHRNZXNzYWdlU3VjY2VzcyIsImkxOG4iLCJnZXRTZXJ2aWNlIiwiYWN0aW9ucyIsIm1lc3NhZ2UiLCJkaXNtaXNzTWVzc2FnZSIsImNyZWF0ZVN1Y2Nlc3NNZXNzYWdlIiwiaWQiLCJ0IiwidXBkYXRlUHJvZ3Jlc3MiLCJwcm9ncmVzc1BlcmNlbnRhZ2UiLCJpc0luZGV0ZXJtaW5hdGUiLCJtb2R1bGUiLCJleHBvcnRzIiwiTUJUb29scGF0aERlYnVnTWVudSIsImNyZWF0ZVNpbXBsZU1lbnVJdGVtQ2xhc3MiLCJkaXNwbGF5TmFtZSIsImxhYmVsIiwidW5sb2NhbGl6ZWQiLCJNQkN1c3RvbVNsaWNlTWVudUl0ZW0iLCJyZW1vdGUiLCJnZXRGbHV4IiwiZXhwb3J0U2VydmljZSIsInN0b3JlcyIsIlByaW50ZXJTdG9yZSIsImdldFNlbGVjdGVkUHJpbnRlciIsImNyZWF0ZUVycm9yTWVzc2FnZSIsImNvbmZpZ0ZpbHRlcnMiLCJuYW1lIiwiZXh0ZW5zaW9ucyIsImNvbmZpZ1BhdGgiLCJkaWFsb2ciLCJzaG93T3BlbkRpYWxvZyIsImdldEN1cnJlbnRXaW5kb3ciLCJ0aXRsZSIsImZpbHRlcnMiLCJwYXJzZWRQcm9maWxlIiwiSlNPTiIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwiZ2V0R2VuZGVyIiwiYm90VHlwZSIsIl9ib3QiLCJzYXZlUGF0aCIsInNob3dTYXZlRGlhbG9nIiwiZ2V0U3VwcG9ydGVkRm9ybWF0cyIsInByb2plY3QiLCJQcm9qZWN0U3RvcmUiLCJnZXRQcm9qZWN0IiwidHJheSIsImdldEFjdGl2ZVRyYXkiLCJjdXN0b21UcmF5IiwidHJheUJvZGllcyIsImdldFRyYXlCb2RpZXMiLCJ0b0FycmF5IiwiZm9yRWFjaCIsInRyYXlCb2R5IiwiY3VzdG9tT2NjdXJyZW5jZSIsImdldE9jY3VycmVuY2UiLCJzZXRQcm9wZXJ0eSIsImN1c3RvbUJvZHkiLCJzZXRPY2N1cnJlbmNlIiwic2V0VHJheUJvZHkiLCJidWlsZFN0b3JlIiwiQnVpbGRTdG9yZSIsIm9uY2UiLCJzZXRJbW1lZGlhdGUiLCJleHBvcnRUb0ZpbGUiLCJjYW5jZWxCdWlsZHNGb3JUcmF5IiwiZ2V0SWQiLCJFeHBvcnRUaGluZ01lbnVJdGVtIiwic2F2ZUZpbHRlcnMiLCJQcm9qZWN0U2VydmljZSIsInRoZW4iLCJzYXZlIiwiRXhwb3J0Q3VzdG9tUHJvZmlsZU1lbnVJdGVtIiwicm9vdE9jY3VycmVuY2VzIiwiZ2V0Um9vdE9jY3VycmVuY2VzIiwidGVzc2VsbGF0aW9uTWFwIiwiZ2V0VGVzc2VsbGF0aW9uTWFwIiwiYnVpbGRJbmZvIiwiZ2V0QnVpbGRJbmZvIiwic2F2ZVByb2ZpbGUiLCJwcm9maWxlIiwianNvblN0cmluZyIsInN0cmluZ2lmeSIsIndyaXRlRmlsZVN5bmMiLCJzbGljZWNvbmZpZyIsImdldFByb2ZpbGUiLCJjYXRjaCIsIlByaW50RnJvbVRvb2xwYXRoTWVudUl0ZW0iLCJsb2FkUGF0aCIsImlzVmFsaWRQcmludGVyIiwiZ2V0U3RhdHVzIiwic3RhdGUiLCJsb2FkRmlsdGVycyIsInRyYWNraW5nU2VydmljZSIsInByb3BzIiwidHJhY2tpbmdJbmZvIiwidHJhY2tpbmdJbmZvRm9yUHJpbnRlciIsImV4dHJ1ZGVyX3R5cGUiLCJnZXRDdXJyZW50RXh0cnVkZXJUeXBlIiwicHJpbnRTZXR0aW5ncyIsImdldFByaW50U2V0dGluZ3NGb3JBbmFseXRpY0V2ZW50cyIsImFkZEV2ZW50IiwibWVyZ2UiLCJmaWxlIiwibmV3UHJvamVjdCIsImltcG9ydFRvb2xwYXRoIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxJQUFELENBQWxCOztBQUNBLE1BQU1DLGdCQUFnQixHQUFHRCxPQUFPLENBQUMsYUFBRCxDQUFQLENBQXVCRSxLQUF2QixDQUE2QkMsSUFBN0IsQ0FBa0NGLGdCQUEzRDs7QUFDQSxNQUFNRyxDQUFDLEdBQUdKLE9BQU8sQ0FBQyxHQUFELENBQWpCOztBQUNBLE1BQU1LLGFBQWEsR0FBR0wsT0FBTyxDQUFDLGdDQUFELENBQTdCOztBQUNBLE1BQU1NLENBQUMsR0FBR04sT0FBTyxDQUFDLE9BQUQsQ0FBakI7O0FBRUEsTUFBTU8sSUFBSSxHQUFHUCxPQUFPLENBQUMsUUFBRCxDQUFwQixDLENBRUE7QUFDQTtBQUNBO0FBQ0E7OztBQUNBLE1BQU1RLFVBQVUsR0FBRyxVQUFTQyxPQUFULEVBQWtCQyxPQUFsQixFQUEyQjtBQUMxQztBQUNBLFFBQU1DLElBQUksR0FBRyxVQUFTQyxHQUFULEVBQWM7QUFDdkIsUUFBSUEsR0FBSixFQUFTO0FBQ0wsYUFBT1IsQ0FBQyxDQUFDUyxNQUFGLENBQVNELEdBQVQsQ0FBUDtBQUNIOztBQUNELFdBQU9SLENBQUMsQ0FBQ1UsT0FBRixFQUFQO0FBQ0gsR0FMRCxDQUYwQyxDQVMxQzs7O0FBQ0EsUUFBTUMsRUFBRSxHQUFHaEIsRUFBRSxDQUFDaUIsZ0JBQUgsQ0FBb0JQLE9BQXBCLENBQVg7QUFDQU0s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QUtDLEtBQUwsQ0FBVzFHLElBQVgsQ0FBZ0JXLFVBQWhCLENBQTJCLGlCQUEzQixDQUF4QjtBQUNBLGNBQU1nRyxZQUFZLEdBQUduSSxJQUFJLENBQUNvSSxzQkFBTCxDQUE0QmpILE9BQTVCLENBQXJCO0FBQ0FnSCxRQUFBQSxZQUFZLENBQUNFLGFBQWIsR0FBNkJsSCxPQUFPLENBQUNtSCxzQkFBUixFQUE3QjtBQUNBLGNBQU1DLGFBQWEsR0FBR3pJLGFBQWEsQ0FBQzBJLGlDQUFkLENBQ2xCLEtBQUtOLEtBQUwsQ0FBVzFHLElBRE8sRUFFbEJMLE9BRmtCLENBQXRCO0FBSUE4RyxRQUFBQSxlQUFlLENBQUNRLFFBQWhCLENBQ0kxSSxDQUFDLENBQUMySSxLQUFGLENBQVE7QUFBRTdFLFVBQUFBLElBQUksRUFBRTtBQUFSLFNBQVIsRUFBa0RzRSxZQUFsRCxFQUFnRUksYUFBaEUsQ0FESjtBQUdILE9BdkJMLEVBd0JJO0FBeEJKLE9BeUJLN0IsSUF6QkwsQ0F5QlUsTUFBTWxGLElBQUksQ0FBQ1ksT0FBTCxDQUFhdUcsSUFBYixDQUFrQkMsVUFBbEIsRUF6QmhCLEVBMEJJO0FBMUJKLE9BMkJLbEMsSUEzQkwsQ0EyQlUsTUFBTWxGLElBQUksQ0FBQ1ksT0FBTCxDQUFhdUcsSUFBYixDQUFrQkUsY0FBbEIsQ0FBaUNqQixRQUFRLENBQUMsQ0FBRCxDQUF6QyxDQTNCaEIsRUE0QktGLEtBNUJMLENBNEJXM0csUUE1QlgsRUE2QktYLElBN0JMLEVBREo7QUFnQ0g7O0FBdERMLEdBRHVCLEVBeUR2QjtBQUFFK0MsSUFBQUEsV0FBVyxFQUFFO0FBQWYsR0F6RHVCO0FBaE1kLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xyXG5jb25zdCBNZW51SXRlbVByb3ZpZGVyID0gcmVxdWlyZSgnZWFnbGUtcHJpbnQnKS52aWV3cy5tZW51Lk1lbnVJdGVtUHJvdmlkZXI7XHJcbmNvbnN0IHEgPSByZXF1aXJlKCdxJyk7XHJcbmNvbnN0IGFuYWx5dGljVXRpbHMgPSByZXF1aXJlKCdlYWdsZS1wcmludC91dGlsL2FuYWx5dGljVXRpbHMnKTtcclxuY29uc3QgUiA9IHJlcXVpcmUoJ3JhbWRhJyk7XHJcblxyXG5jb25zdCB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7XHJcblxyXG4vLy8gZnVuY3Rpb24gZm9yIGV4cG9ydGluZyBmaWxlcyBmcm9tIEB0bXBQYXRoIHRvIEBkc3RQYXRoLCBwcmV0dHkgbXVjaCB0aGVcclxuLy8vIG1iLXBsdWdpbidzIGV4cG9ydCBzZXJ2aWNlXHJcbi8vLyBAcmV0dXJucyBhIHEucmVzb2x2ZSBvciBhIHEucmVqZWN0IGRlcGVuZGluZyBvbiBlcnJvciBzdGF0dXMuXHJcbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtdmFyc1xyXG5jb25zdCBleHBvcnRGaWxlID0gZnVuY3Rpb24odG1wUGF0aCwgZHN0UGF0aCkge1xyXG4gICAgLy8gZmxhZyBhbmQgZnVuY3Rpb24gdG8gbG9nIGVycm9yc1xyXG4gICAgY29uc3QgZG9uZSA9IGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHEucmVqZWN0KGVycik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBxLnJlc29sdmUoKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gY3JlYXRlIGEgcmVhZCBzdHJlYW0gZnJvbSB0bXBQYXRoLCBsb2cgb24gJ2Vycm9yJ1xyXG4gICAgY29uc3QgcmQgPSBmcy5jcmVhdGVSZWFkU3RyZWFtKHRtcFBhdGgpO1xyXG4gICAgcmQub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgZG9uZShlcnIpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gY3JlYXRlIHdyaXRlIHN0cmVhbSBmcm9tIGRzdFBhdGgsIGxvZyBvbiAnZXJyb3InXHJcbiAgICBjb25zdCB3ciA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGRzdFBhdGgpO1xyXG4gICAgd3Iub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgZG9uZShlcnIpO1xyXG4gICAgfSk7XHJcbiAgICB3ci5vbignY2xvc2UnLCBmdW5jdGlvbihleCkge1xyXG4gICAgICAgIGRvbmUoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIHBpcGUgdGhlIHJlYWQgcGF0aCB0byB0aGUgd3JpdGUgcGF0aFxyXG4gICAgcmQucGlwZSh3cik7XHJcbn07XHJcblxyXG4vLy8gZnVuY3Rpb24gdG8gbG9nIGRlYnVnIG1lbnUgZXJyb3JzLiBmb3Igbm93IGp1c3QgY29uc29sZSBsb2cuXHJcbmNvbnN0IGxvZ0Vycm9yID0gZnVuY3Rpb24oZXJyKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKGVycik7XHJcbn07XHJcblxyXG4vLy8gaXMgQHByaW50ZXIgYSBtYWtlcmJvdCBwcmludGVyXHJcbmNvbnN0IGlzTWFrZXJib3RQcmludGVyID0gZnVuY3Rpb24ocHJpbnRlcikge1xyXG4gICAgcmV0dXJuIHByaW50ZXIgJiYgcHJpbnRlci5nZXRJbmZvKCkudmVuZG9yLnRvTG93ZXJDYXNlKCkgPT09ICdtYWtlcmJvdCc7XHJcbn07XHJcblxyXG5jb25zdCBwcm9ncmVzc1JlcG9ydCA9IGZ1bmN0aW9uKGZsdXgsIGZyYWN0aW9uLCBhY3Rpb24sIGFjdGlvbkxhYmVsLCBhY3Rpb25DYWxsYmFjaywgY2xvc2VBY3Rpb24sIGN1cnNvclN0eWxlKSB7XHJcbiAgICBjb25zdCBpZE1lc3NhZ2UgPSBgcHJvamVjdF8ke2FjdGlvbn1gO1xyXG4gICAgY29uc3QgdGV4dE1lc3NhZ2VQcm9ncmVzcyA9IGBtZXNzYWdlcy5wcm9qZWN0LiR7YWN0aW9ufS5wcm9ncmVzc2A7XHJcbiAgICBjb25zdCB0ZXh0TWVzc2FnZVN1Y2Nlc3MgPSBgbWVzc2FnZXMucHJvamVjdC4ke2FjdGlvbn0uc3VjY2Vzc2A7XHJcblxyXG4gICAgY29uc3QgaTE4biA9IGZsdXguZ2V0U2VydmljZSgnVHJhbnNsYXRpb25TZXJ2aWNlJyk7XHJcblxyXG4gICAgaWYgKGZyYWN0aW9uIDwgMCkge1xyXG4gICAgICAgIC8vIGRpc21pc3MgbWVzc2FnZSAoZmFpbGVkKVxyXG4gICAgICAgIGZsdXguYWN0aW9ucy5tZXNzYWdlLmRpc21pc3NNZXNzYWdlKGlkTWVzc2FnZSk7XHJcbiAgICB9IGVsc2UgaWYgKGZyYWN0aW9uID09PSAxMDApIHtcclxuICAgICAgICAvLyBlbmQgbWVzc2FnZVxyXG4gICAgICAgIGZsdXguYWN0aW9ucy5tZXNzYWdlLmNyZWF0ZVN1Y2Nlc3NNZXNzYWdlKHsgaWQ6IGlkTWVzc2FnZSwgbWVzc2FnZTogaTE4bi50KHRleHRNZXNzYWdlU3VjY2VzcykgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIHByb2dyZXNzIG1lc3NhZ2VcclxuICAgICAgICBmbHV4LmFjdGlvbnMubWVzc2FnZS51cGRhdGVQcm9ncmVzcyh7XHJcbiAgICAgICAgICAgIHByb2dyZXNzUGVyY2VudGFnZTogZnJhY3Rpb24sXHJcbiAgICAgICAgICAgIGlzSW5kZXRlcm1pbmF0ZTogdHJ1ZSxcclxuICAgICAgICAgICAgaWQ6IGlkTWVzc2FnZSxcclxuICAgICAgICAgICAgbWVzc2FnZTogaTE4bi50KHRleHRNZXNzYWdlUHJvZ3Jlc3MpLFxyXG4gICAgICAgICAgICBhY3Rpb25MYWJlbCxcclxuICAgICAgICAgICAgYWN0aW9uQ2FsbGJhY2ssXHJcbiAgICAgICAgICAgIGNsb3NlQWN0aW9uLFxyXG4gICAgICAgICAgICBjdXJzb3JTdHlsZSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gICAgLy8vIHRoZSB0b29scGF0aGVyIG1lbnUgaXRlbSwgYWxsIG90aGVyIGl0ZW1zIHdpbGwgZ28gaW5zaWRlIG9mIHRoaXMgb25lXHJcbiAgICBNQlRvb2xwYXRoRGVidWdNZW51OiBNZW51SXRlbVByb3ZpZGVyLmNyZWF0ZVNpbXBsZU1lbnVJdGVtQ2xhc3MoXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBkaXNwbGF5TmFtZTogJ0RlYnVnTUJUb29scGF0aCcsXHJcbiAgICAgICAgICAgIGxhYmVsOiAnTUIgVG9vbHBhdGhlci4uLicsXHJcbiAgICAgICAgfSxcclxuICAgICAgICB7IHVubG9jYWxpemVkOiB0cnVlIH1cclxuICAgICksXHJcblxyXG4gICAgLy8vIHVzZSBhIGN1c3RvbSBwcm9maWxlIHRvIHNsaWNlIHRoZSBidWlsZCBwbGF0ZSBhbmQgZXhwb3J0IHRoZSBkb3QgbWFrZXJib3RcclxuICAgIC8vLyBmaWxlLiBldmVudHVhbGx5LCB0aGlzIHNob3VsZCBtYXliZSBiZSBhIHByaW50LlxyXG4gICAgTUJDdXN0b21TbGljZU1lbnVJdGVtOiBNZW51SXRlbVByb3ZpZGVyLmNyZWF0ZVNpbXBsZU1lbnVJdGVtQ2xhc3MoXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBkaXNwbGF5TmFtZTogJ01CQ3VzdG9tU2xpY2UnLFxyXG4gICAgICAgICAgICBsYWJlbDogJ0N1c3RvbSBNQiBTbGljZScsXHJcbiAgICAgICAgICAgIGFjdGlvbigpIHtcclxuICAgICAgICAgICAgICAgIC8vIHVzZSBlbGVjdGlvbi5yZW1vdGUuZGlhbG9ncyB0byBnZXQgdGhlIHByb2ZpbGUgYW5kIHNhdmUgbG9jYXRpb25zXHJcbiAgICAgICAgICAgICAgICBjb25zdCByZW1vdGUgPSByZXF1aXJlKCdlbGVjdHJvbicpLnJlbW90ZTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZsdXggPSB0aGlzLmdldEZsdXgoKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBleHBvcnRTZXJ2aWNlID0gZmx1eC5nZXRTZXJ2aWNlKCdFeHBvcnRTZXJ2aWNlJyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwcmludGVyID0gZmx1eC5zdG9yZXMuUHJpbnRlclN0b3JlLmdldFNlbGVjdGVkUHJpbnRlcigpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIE11c3QgaGF2ZSBzZWxlY3RlZCBhbiBhdXRoJ2VkIHByaW50ZXIuXHJcbiAgICAgICAgICAgICAgICBpZiAoIWlzTWFrZXJib3RQcmludGVyKHByaW50ZXIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmx1eC5hY3Rpb25zLm1lc3NhZ2UuY3JlYXRlRXJyb3JNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ1RoaXMgbWVudSBvcHRpb24gcmVxdWlyZXMgc2VsZWN0aW5nIGFuIGF1dGhlbnRpY2F0ZWQgTWFrZXJCb3QgUHJpbnRlcicsXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IoJ1RoaXMgbWVudSBvcHRpb24gcmVxdWlyZXMgc2VsZWN0aW5nIGEgTWFrZXJCb3QgUHJpbnRlcicpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvLyBhc2sgdGhlIHVzZXIgZm9yIGEgY29uZmlnIHBhdGgsIGV4aXQgaWYgbm90IHByb3ZpZGVkXHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb25maWdGaWx0ZXJzID0gW3sgbmFtZTogJ2NvbmZpZycsIGV4dGVuc2lvbnM6IFsnanNvbiddIH1dO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29uZmlnUGF0aCA9IHJlbW90ZS5kaWFsb2cuc2hvd09wZW5EaWFsb2cocmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKSwge1xyXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiAnY2hvb3NlIGEgcHJvZmlsZScsXHJcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyczogY29uZmlnRmlsdGVycyxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFjb25maWdQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmx1eC5hY3Rpb25zLm1lc3NhZ2UuY3JlYXRlRXJyb3JNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ1BsZWFzZSBwcm92aWRlIGEgdmFsaWQgcHJvZmlsZSBwYXRoLicsXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIFNlbGVjdGVkIHByb2ZpbGUgYm90X3R5cGUgbXVzdCBtYXRjaCBhdXRoJ2VkIHByaW50ZXIgYm90X3R5cGUuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJzZWRQcm9maWxlID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoY29uZmlnUGF0aFswXSwgJ3V0ZjgnKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHByaW50ZXIuZ2V0R2VuZGVyKCkuYm90VHlwZSAhPT0gcGFyc2VkUHJvZmlsZS5fYm90KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmx1eC5hY3Rpb25zLm1lc3NhZ2UuY3JlYXRlRXJyb3JNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ1NlbGVjdGVkIHByaW50ZXIgYm90X3R5cGUgZG9lcyBub3QgbWF0Y2ggcHJvZmlsZSBib3RfdHlwZS4nLFxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvLyBBc2sgdGhlIHVzZXIgZm9yIGEgc2F2ZSBsb2NhdGlvbiwgZXhpdCBpZiBub3QgcHJvdmlkZWQuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBzYXZlUGF0aCA9IHJlbW90ZS5kaWFsb2cuc2hvd1NhdmVEaWFsb2cocmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKSwge1xyXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiAnY2hvb3NlIGEgc2F2ZSBsb2NhdGlvbicsXHJcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyczogW2V4cG9ydFNlcnZpY2UuZ2V0U3VwcG9ydGVkRm9ybWF0cyhwcmludGVyKV0sXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGlmICghc2F2ZVBhdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBmbHV4LmFjdGlvbnMubWVzc2FnZS5jcmVhdGVFcnJvck1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnUGxlYXNlIHByb3ZpZGUgYSB2YWxpZCBmaWxlIHNhdmUgcGF0aC4nLFxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9qZWN0ID0gZmx1eC5zdG9yZXMuUHJvamVjdFN0b3JlLmdldFByb2plY3QoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRyYXkgPSBwcm9qZWN0LmdldEFjdGl2ZVRyYXkoKTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgY3VzdG9tVHJheSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0cmF5Qm9kaWVzID0gdHJheS5nZXRUcmF5Qm9kaWVzKCkudG9BcnJheSgpO1xyXG5cclxuICAgICAgICAgICAgICAgIHRyYXlCb2RpZXMuZm9yRWFjaCh0cmF5Qm9keSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3VzdG9tT2NjdXJyZW5jZSA9IHRyYXlCb2R5LmdldE9jY3VycmVuY2UoKS5zZXRQcm9wZXJ0eSgnY3VzdG9tUHJvZmlsZVBhdGgnLCBjb25maWdQYXRoKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXN0b21Cb2R5ID0gdHJheUJvZHkuc2V0T2NjdXJyZW5jZShjdXN0b21PY2N1cnJlbmNlKTtcclxuICAgICAgICAgICAgICAgICAgICBjdXN0b21UcmF5ID0gdHJheS5zZXRUcmF5Qm9keShjdXN0b21Cb2R5KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIFdhaXQgZm9yIHRoZSBjdXJyZW50IGJ1aWxkIHRvIGJlIGNsZWFyZWQgYW5kIHRoZW4gcmUtc2xpY2VcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJ1aWxkU3RvcmUgPSBmbHV4LnN0b3Jlcy5CdWlsZFN0b3JlO1xyXG4gICAgICAgICAgICAgICAgYnVpbGRTdG9yZS5vbmNlKCdjaGFuZ2UnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0SW1tZWRpYXRlKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmx1eC5hY3Rpb25zLnByaW50ZXIuZXhwb3J0VG9GaWxlKHByaW50ZXIsIGN1c3RvbVRyYXksIHByb2plY3QsIHNhdmVQYXRoKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGZsdXguYWN0aW9ucy5wcmludGVyLmNhbmNlbEJ1aWxkc0ZvclRyYXkoY3VzdG9tVHJheS5nZXRJZCgpKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHsgdW5sb2NhbGl6ZWQ6IHRydWUgfVxyXG4gICAgKSxcclxuXHJcbiAgICAvLy8gZXhwb3J0IHRoZSBjdXJyZW50IHRyYXkgYXMgYSBkb3QgdGhpbmcgZmlsZVxyXG4gICAgRXhwb3J0VGhpbmdNZW51SXRlbTogTWVudUl0ZW1Qcm92aWRlci5jcmVhdGVTaW1wbGVNZW51SXRlbUNsYXNzKFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgZGlzcGxheU5hbWU6ICdFeHBvcnRUaGluZycsXHJcbiAgICAgICAgICAgIGxhYmVsOiAnRXhwb3J0IFRoaW5nJyxcclxuICAgICAgICAgICAgYWN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgLy8gYXNrIHRoZSB1c2VyIGZvciBhbiBleHBvcnQgcGF0aCwgZXhpdCBpZiBub3QgcHJvdmlkZWRcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlbW90ZSA9IHJlcXVpcmUoJ2VsZWN0cm9uJykucmVtb3RlO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2F2ZUZpbHRlcnMgPSBbeyBuYW1lOiAnbW9kZWwnLCBleHRlbnNpb25zOiBbJ3RoaW5nJ10gfV07XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzYXZlUGF0aCA9IHJlbW90ZS5kaWFsb2cuc2hvd1NhdmVEaWFsb2cocmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKSwge1xyXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiAnY2hvb3NlIGEgc2F2ZSBsb2NhdGlvbicsXHJcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyczogc2F2ZUZpbHRlcnMsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGlmICghc2F2ZVBhdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAgICAgKiBVc2UgZmx1eCB0byBnZXQgdGhlIGN1cnJlbnQgcHJvamVjdCBhbmQgcHJpbnRlclxyXG4gICAgICAgICAgICAgICAgICoqL1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmx1eCA9IHRoaXMuZ2V0Rmx1eCgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdCA9IGZsdXguc3RvcmVzLlByb2plY3RTdG9yZS5nZXRQcm9qZWN0KCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwcmludGVyID0gZmx1eC5zdG9yZXMuUHJpbnRlclN0b3JlLmdldFNlbGVjdGVkUHJpbnRlcigpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghaXNNYWtlcmJvdFByaW50ZXIocHJpbnRlcikpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcignVGhpcyBtZW51IG9wdGlvbiByZXF1aXJlcyBzZWxlY3RpbmcgYSBNYWtlckJvdCBQcmludGVyJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IFByb2plY3RTZXJ2aWNlID0gZmx1eC5nZXRTZXJ2aWNlKCdQcm9qZWN0U2VydmljZScpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHEoKVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3NSZXBvcnQoZmx1eCwgMCwgJ3NhdmUnKTtcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgUHJvamVjdFNlcnZpY2Uuc2F2ZShwcm9qZWN0LCBzYXZlUGF0aCwgZmx1eCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzUmVwb3J0KGZsdXgsIDEwMCwgJ3NhdmUnKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHsgdW5sb2NhbGl6ZWQ6IHRydWUgfVxyXG4gICAgKSxcclxuXHJcbiAgICAvLy8gdXNlIHRoZSBjdXJyZW50IHNldHRpbmdzIGFuZCBwcmludGVyIHRvIGdlbmVyYXRlIC8gc2F2ZSBhIGN1c3RvbSBwcm9maWxlXHJcbiAgICBFeHBvcnRDdXN0b21Qcm9maWxlTWVudUl0ZW06IE1lbnVJdGVtUHJvdmlkZXIuY3JlYXRlU2ltcGxlTWVudUl0ZW1DbGFzcyhcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGRpc3BsYXlOYW1lOiAnRXhwb3J0Q3VzdG9tUHJvZmlsZScsXHJcbiAgICAgICAgICAgIGxhYmVsOiAnRXhwb3J0IEN1c3RvbSBQcm9maWxlJyxcclxuICAgICAgICAgICAgYWN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgLy8gYXNrIHRoZSB1c2VyIGZvciBhbiBleHBvcnQgcGF0aCwgZXhpdCBpZiBub3QgcHJvdmlkZWRcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlbW90ZSA9IHJlcXVpcmUoJ2VsZWN0cm9uJykucmVtb3RlO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2F2ZUZpbHRlcnMgPSBbeyBuYW1lOiAnY29uZmlndXJhdGlvbicsIGV4dGVuc2lvbnM6IFsnanNvbiddIH1dO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2F2ZVBhdGggPSByZW1vdGUuZGlhbG9nLnNob3dTYXZlRGlhbG9nKHJlbW90ZS5nZXRDdXJyZW50V2luZG93KCksIHtcclxuICAgICAgICAgICAgICAgICAgICB0aXRsZTogJ2Nob29zZSBhIHNhdmUgbG9jYXRpb24nLFxyXG4gICAgICAgICAgICAgICAgICAgIGZpbHRlcnM6IHNhdmVGaWx0ZXJzLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXNhdmVQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIHVzZSB0aGUgZmx1eCBzdG9yZXMgdG8gZ2V0IHRoZSBhY3RpdmUgdHJheSBhbmQgc2VsZWN0ZWQgcHJpbnRlclxyXG4gICAgICAgICAgICAgICAgY29uc3QgZmx1eCA9IHRoaXMuZ2V0Rmx1eCgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdCA9IGZsdXguc3RvcmVzLlByb2plY3RTdG9yZS5nZXRQcm9qZWN0KCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0cmF5ID0gcHJvamVjdC5nZXRBY3RpdmVUcmF5KCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwcmludGVyID0gZmx1eC5zdG9yZXMuUHJpbnRlclN0b3JlLmdldFNlbGVjdGVkUHJpbnRlcigpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghaXNNYWtlcmJvdFByaW50ZXIocHJpbnRlcikpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcignVGhpcyBtZW51IG9wdGlvbiByZXF1aXJlcyBzZWxlY3RpbmcgYSBNYWtlckJvdCBQcmludGVyJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIGdlbmVyYXRlIGJ1aWxkIGluZm8gZnJvbSB0aGUgY3VycmVudCBwcm9qZWN0J3MgYWN0aXZlIHRyYXlcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJvb3RPY2N1cnJlbmNlcyA9IHByb2plY3QuZ2V0Um9vdE9jY3VycmVuY2VzKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXNzZWxsYXRpb25NYXAgPSBwcm9qZWN0LmdldFRlc3NlbGxhdGlvbk1hcCgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYnVpbGRJbmZvID0gdHJheS5nZXRCdWlsZEluZm8ocHJpbnRlciwgeyB0ZXNzZWxsYXRpb25NYXAsIHJvb3RPY2N1cnJlbmNlcyB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyB0dXJuIHRoZSBwcm9maWxlIGludG8gYSBwcmV0dHkganNvbiBzdHJpbmcgYW5kIHdyaXRlIGl0XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzYXZlUHJvZmlsZSA9IGZ1bmN0aW9uKHByb2ZpbGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBqc29uU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkocHJvZmlsZSwgbnVsbCwgMik7XHJcbiAgICAgICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhzYXZlUGF0aCwganNvblN0cmluZyk7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIHVzZSBzbGljZWNvbmZpZyB0byBnZW5lcmF0ZSBhIGN1c3RvbSBwcm9maWxlIHdpdGggdGhlIHNldHRpbmdzIG9uIHRoZVxyXG4gICAgICAgICAgICAgICAgLy8gY3VycmVudCB0cmF5LiBzYXZlIHRoZSByZXN1bHRpbmcganNvbiB0byB0aGUgZGVzaXJlZCBzYXZlIHBhdGhcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNsaWNlY29uZmlnID0gcmVxdWlyZSgnLi9tYWtlcmJvdCcpO1xyXG4gICAgICAgICAgICAgICAgc2xpY2Vjb25maWdcclxuICAgICAgICAgICAgICAgICAgICAuZ2V0UHJvZmlsZShidWlsZEluZm8sIHByaW50ZXIsIG51bGwsIGZsdXgpXHJcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oc2F2ZVByb2ZpbGUpXHJcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGxvZ0Vycm9yKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHsgdW5sb2NhbGl6ZWQ6IHRydWUgfVxyXG4gICAgKSxcclxuXHJcbiAgICAvLy8gT3BlbnMgZGlhbG9nIHdoZXJlIHVzZXIgc2VsZWN0cyBhIGRvdCBtYWtlcmJvdCAoLm1ha2VyYm90KSBmaWxlIHRvIGltcG9ydFxyXG4gICAgLy8vIGFuZCBzZW5kIHRvIHRoZSBzZWxlY3RlZCBwcmludGVyLlxyXG4gICAgUHJpbnRGcm9tVG9vbHBhdGhNZW51SXRlbTogTWVudUl0ZW1Qcm92aWRlci5jcmVhdGVTaW1wbGVNZW51SXRlbUNsYXNzKFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgZGlzcGxheU5hbWU6ICdQcmludEZyb21Ub29scGF0aCcsXHJcbiAgICAgICAgICAgIGxhYmVsOiAnUHJpbnQgZnJvbSAubWFrZXJib3QnLFxyXG4gICAgICAgICAgICBhY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgYW4gYXV0aGVudGljYXRlZCAobGl2ZSkgcHJpbnRlciBpcyBzZWxlY3RlZC5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlbW90ZSA9IHJlcXVpcmUoJ2VsZWN0cm9uJykucmVtb3RlO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmx1eCA9IHRoaXMuZ2V0Rmx1eCgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcHJpbnRlciA9IGZsdXguc3RvcmVzLlByaW50ZXJTdG9yZS5nZXRTZWxlY3RlZFByaW50ZXIoKTtcclxuICAgICAgICAgICAgICAgIGxldCBsb2FkUGF0aCA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gQSB2YWxpZCBwcmludGVyIG5lZWRzIHRvIGJlIGEgbWFrZXJib3QgcHJpbnRlciwgYW5kIG5vdCBgT2ZmbGluZWBcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlzVmFsaWRQcmludGVyID0gaXNNYWtlcmJvdFByaW50ZXIocHJpbnRlcikgJiYgcHJpbnRlci5nZXRTdGF0dXMoKS5zdGF0ZSAhPT0gJ09mZmxpbmUnO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghaXNWYWxpZFByaW50ZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICBmbHV4LmFjdGlvbnMubWVzc2FnZS5jcmVhdGVFcnJvck1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnVGhpcyBtZW51IG9wdGlvbiByZXF1aXJlcyBzZWxlY3RpbmcgYW4gYXV0aGVudGljYXRlZCBNYWtlckJvdCBQcmludGVyJyxcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcignVGhpcyBtZW51IG9wdGlvbiByZXF1aXJlcyBzZWxlY3RpbmcgYW4gYXV0aGVudGljYXRlZCBNYWtlckJvdCBQcmludGVyJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIElmIHByaW50ZXIgaXMgdmFsaWQuLi5cclxuICAgICAgICAgICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgICAgICAgICAgcSgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBvcCBkaWFsb2csIGxldCB1c2VyIGNob29zZSBpbXBvcnQgZG90IG1ha2VyYm90IGZpbGVcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9hZEZpbHRlcnMgPSBbeyBuYW1lOiAnbWFrZXJib3QnLCBleHRlbnNpb25zOiBbJ21ha2VyYm90J10gfV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkUGF0aCA9IHJlbW90ZS5kaWFsb2cuc2hvd09wZW5EaWFsb2cocmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKSwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiAnY2hvb3NlIGEgLm1ha2VyYm90IGZpbGUgdG8gcHJpbnQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcnM6IGxvYWRGaWx0ZXJzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsb2FkUGF0aCkgbG9nRXJyb3IoJ05vIHZhbGlkIGxvYWQgcGF0aCBmb3IgLm1ha2VyYm90IScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFja2luZ1NlcnZpY2UgPSB0aGlzLnByb3BzLmZsdXguZ2V0U2VydmljZSgnVHJhY2tpbmdTZXJ2aWNlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFja2luZ0luZm8gPSB1dGlsLnRyYWNraW5nSW5mb0ZvclByaW50ZXIocHJpbnRlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFja2luZ0luZm8uZXh0cnVkZXJfdHlwZSA9IHByaW50ZXIuZ2V0Q3VycmVudEV4dHJ1ZGVyVHlwZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJpbnRTZXR0aW5ncyA9IGFuYWx5dGljVXRpbHMuZ2V0UHJpbnRTZXR0aW5nc0ZvckFuYWx5dGljRXZlbnRzKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJvcHMuZmx1eCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludGVyXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tpbmdTZXJ2aWNlLmFkZEV2ZW50KFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFIubWVyZ2UoeyBuYW1lOiAnUHJpbnQgU3RhcnRlZCBGcm9tIC5tYWtlcmJvdCcgfSwgdHJhY2tpbmdJbmZvLCBwcmludFNldHRpbmdzKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGEgbmV3IHByb2plY3QgdG8gY2xlYXIgdGhlIGJ1aWxkIHBsYXRlLlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiBmbHV4LmFjdGlvbnMuZmlsZS5uZXdQcm9qZWN0KCkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEltcG9ydCB0b29scGF0aCwgYW5kIHNlbmQgdG8gc2VsZWN0ZWQgcHJpbnRlci5cclxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gZmx1eC5hY3Rpb25zLmZpbGUuaW1wb3J0VG9vbHBhdGgobG9hZFBhdGhbMF0pKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2gobG9nRXJyb3IpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5kb25lKClcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgICB7IHVubG9jYWxpemVkOiB0cnVlIH1cclxuICAgICksXHJcbn07XHJcbiJdfQ==
