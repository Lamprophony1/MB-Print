'use strict';

const R = require('ramda');

const ProjectValidatorProvider = require('eagle-print/services/providers/projectValidatorProvider');

const {
  SettingsKeys,
  ValidatorSettingsTypes: SettingsTypes
} = require('./constants/print_settings');

class MBProjectValidatorProvider extends ProjectValidatorProvider {
  constructor() {
    super();
  }

  getPluginKey() {
    return 'mb';
  }

  getPropertyValidationSchema(schemaVersion, versions) {
    const mbPropertySchema = {};
    const basicSettings = ['Extruder', 'PrintModes', 'Supports', 'InfillDensity', 'LayerHeight', 'NumShells', 'Rafts'];
    /** If a new print settings option's type was not listed in
     * SettingsTypes, then getOptionalPluginRef will default to
     * 'GeneralElemNumber' which there is a high chance that
     * is correct type.
     */

    const getOptionalPluginRef = setting => {
      let type;

      switch (R.prop(setting, SettingsTypes)) {
        case 'boolean':
          type = 'GeneralElemBoolean';
          break;

        case 'string':
          type = 'GeneralElemString';
          break;

        case 'unsigned_integer':
          type = 'GeneralElemNumber';
          break;

        case 'array':
          type = 'GeneralElemArray';
          break;

        default:
          type = 'GeneralElemNumber';
      }

      return this.optionalPluginRef('print', type);
    };

    if (schemaVersion >= versions.INITIAL_VERSION.schema) {
      mbPropertySchema.rootOccurrence = R.zipObj(R.map(key => key === 'InfillDensity' ? 'infillDensity' : SettingsKeys[key], basicSettings), R.map(key => getOptionalPluginRef(SettingsKeys[key]), basicSettings));
    }

    if (schemaVersion >= versions.R1_9_DEVELOPMENT_START.schema) {
      mbPropertySchema.rootOccurrence = R.zipObj(R.map(key => {
        switch (key) {
          case SettingsKeys.Extruders:
            return 'attached_extruder0';

          case SettingsKeys.ExtruderTemp:
            return 'extruderTemp0';

          case SettingsKeys.OutlineFeedRate:
            return 'extrusionProfiles>outlines>feedrate';

          case SettingsKeys.InfillFillThickness:
            return 'extruderProfiles>0>maxSparseFillThickness';

          case SettingsKeys.SparseFeedRate0:
            return 'extrusionProfiles>infill>feedrate';

          case SettingsKeys.RaftBaseFeedRate:
            return 'extrusionProfiles>raftBase>feedrate';

          case SettingsKeys.RaftBaseFanSpeed:
            return 'extrusionProfiles>raftBase>fanSpeed';

          case SettingsKeys.BaseLayerSurfaceFeedRate0:
            return 'extrusionProfiles>firstModelLayer>feedrate';

          case SettingsKeys.FirstModelLayerCoolingFanSpeed:
            return 'extrusionProfiles>firstModelLayer>fanSpeed';

          default:
            return key;
        }
      }, R.values(SettingsKeys)), R.map(getOptionalPluginRef, R.values(SettingsKeys)));
      mbPropertySchema.rootOccurrence.attached_extruder0 = this.optionalPluginRef('print', 'GeneralElemString');
    }

    if (schemaVersion >= versions.R2_6_DEVELOPMENT_START.schema) {
      mbPropertySchema.rootOccurrence = R.zipObj(R.values(SettingsKeys), R.map(getOptionalPluginRef, R.values(SettingsKeys)));
    }

    if (schemaVersion >= versions.R2_9_DEVELOPMENT_START.schema) {
      mbPropertySchema.rootOccurrence = R.zipObj(R.values(SettingsKeys), R.map(getOptionalPluginRef, R.values(SettingsKeys)));
    }

    return mbPropertySchema;
  }

  getValidationSchema(schemaVersion, versions, properties) {
    const mbProjectSchema = {
      properties: {},
      definitions: {}
    };
    return mbProjectSchema;
  }

}

module.exports = MBProjectValidatorProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1iLXByb2plY3QtdmFsaWRhdG9yLXByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbIlIiLCJyZXF1aXJlIiwiUHJvamVjdFZhbGlkYXRvclByb3ZpZGVyIiwiU2V0dGluZ3NLZXlzIiwiVmFsaWRhdG9yU2V0dGluZ3NUeXBlcyIsIlNldHRpbmdzVHlwZXMiLCJNQlByb2plY3RWYWxpZGF0b3JQcm92aWRlciIsImNvbnN0cnVjdG9yIiwiZ2V0UGx1Z2luS2V5IiwiZ2V0UHJvcGVydHlWYWxpZGF0aW9uU2NoZW1hIiwic2NoZW1hVmVyc2lvbiIsInZlcnNpb25zIiwibWJQcm9wZXJ0eVNjaGVtYSIsImJhc2ljU2V0dGluZ3MiLCJnZXRPcHRpb25hbFBsdWdpblJlZiIsInNldHRpbmciLCJ0eXBlIiwicHJvcCIsIm9wdGlvbmFsUGx1Z2luUmVmIiwiSU5JVElBTF9WRVJTSU9OIiwic2NoZW1hIiwicm9vdE9jY3VycmVuY2UiLCJ6aXBPYmoiLCJtYXAiLCJrZXkiLCJSMV85X0RFVkVMT1BNRU5UX1NUQVJUIiwiRXh0cnVkZXJzIiwiRXh0cnVkZXJUZW1wIiwiT3V0bGluZUZlZWRSYXRlIiwiSW5maWxsRmlsbFRoaWNrbmVzcyIsIlNwYXJzZUZlZWRSYXRlMCIsIlJhZnRCYXNlRmVlZFJhdGUiLCJSYWZ0QmFzZUZhblNwZWVkIiwiQmFzZUxheWVyU3VyZmFjZUZlZWRSYXRlMCIsIkZpcnN0TW9kZWxMYXllckNvb2xpbmdGYW5TcGVlZCIsInZhbHVlcyIsImF0dGFjaGVkX2V4dHJ1ZGVyMCIsIlIyXzZfREVWRUxPUE1FTlRfU1RBUlQiLCJSMl85X0RFVkVMT1BNRU5UX1NUQVJUIiwiZ2V0VmFsaWRhdGlvblNjaGVtYSIsInByb3BlcnRpZXMiLCJtYlByb2plY3RTY2hlbWEiLCJkZWZpbml0aW9ucyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLENBQUMsR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FBakI7O0FBQ0EsTUFBTUMsd0JB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QztBQUNyRCxVQUFNQyxlQUFlLEdBQUc7QUFBRUQsTUFBQUEsVUFBVSxFQUFFLEVBQWQ7QUFBa0JFLE1BQUFBLFdBQVcsRUFBRTtBQUEvQixLQUF4QjtBQUVBLFdBQU9ELGVBQVA7QUFDSDs7QUExRzZEOztBQTZHbEVFLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnRDLDBCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbmNvbnN0IFIgPSByZXF1aXJlKCdyYW1kYScpO1xyXG5jb25zdCBQcm9qZWN0VmFsaWRhdG9yUHJvdmlkZXIgPSByZXF1aXJlKCdlYWdsZS1wcmludC9zZXJ2aWNlcy9wcm92aWRlcnMvcHJvamVjdFZhbGlkYXRvclByb3ZpZGVyJyk7XHJcblxyXG5jb25zdCB7IFNldHRpbmdzS2V5cywgVmFsaWRhdG9yU2V0dGluZ3NUeXBlczogU2V0dGluZ3NUeXBlcyB9ID0gcmVxdWlyZSgnLi9jb25zdGFudHMvcHJpbnRfc2V0dGluZ3MnKTtcclxuXHJcbmNsYXNzIE1CUHJvamVjdFZhbGlkYXRvclByb3ZpZGVyIGV4dGVuZHMgUHJvamVjdFZhbGlkYXRvclByb3ZpZGVyIHtcclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UGx1Z2luS2V5KCkge1xyXG4gICAgICAgIHJldHVybiAnbWInO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFByb3BlcnR5VmFsaWRhdGlvblNjaGVtYShzY2hlbWFWZXJzaW9uLCB2ZXJzaW9ucykge1xyXG4gICAgICAgIGNvbnN0IG1iUHJvcGVydHlTY2hlbWEgPSB7fTtcclxuXHJcbiAgICAgICAgY29uc3QgYmFzaWNTZXR0aW5ncyA9IFtcclxuICAgICAgICAgICAgJ0V4dHJ1ZGVyJyxcclxuICAgICAgICAgICAgJ1ByaW50TW9kZXMnLFxyXG4gICAgICAgICAgICAnU3VwcG9ydHMnLFxyXG4gICAgICAgICAgICAnSW5maWxsRGVuc2l0eScsXHJcbiAgICAgICAgICAgICdMYXllckhlaWdodCcsXHJcbiAgICAgICAgICAgICdOdW1TaGVsbHMnLFxyXG4gICAgICAgICAgICAnUmFmdHMnLFxyXG4gICAgICAgIF07XHJcblxyXG4gICAgICAgIC8qKiBJZiBhIG5ldyBwcmludCBzZXR0aW5ncyBvcHRpb24ncyB0eXBlIHdhcyBub3QgbGlzdGVkIGluXHJcbiAgICAgICAgICogU2V0dGluZ3NUeXBlcywgdGhlbiBnZXRPcHRpb25hbFBsdWdpblJlZiB3aWxsIGRlZmF1bHQgdG9cclxuICAgICAgICAgKiAnR2VuZXJhbEVsZW1OdW1iZXInIHdoaWNoIHRoZXJlIGlzIGEgaGlnaCBjaGFuY2UgdGhhdFxyXG4gICAgICAgICAqIGlzIGNvcnJlY3QgdHlwZS5cclxuICAgICAgICAgKi9cclxuICAgICAgICBjb25zdCBnZXRPcHRpb25hbFBsdWdpblJlZiA9IHNldHRpbmcgPT4ge1xyXG4gICAgICAgICAgICBsZXQgdHlwZTtcclxuICAgICAgICAgICAgc3dpdGNoIChSLnByb3Aoc2V0dGluZywgU2V0dGluZ3NUeXBlcykpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2Jvb2xlYW4nOlxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnR2VuZXJhbEVsZW1Cb29sZWFuJztcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdHZW5lcmFsRWxlbVN0cmluZyc7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlICd1bnNpZ25lZF9pbnRlZ2VyJzpcclxuICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ0dlbmVyYWxFbGVtTnVtYmVyJztcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2FycmF5JzpcclxuICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ0dlbmVyYWxFbGVtQXJyYXknO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ0dlbmVyYWxFbGVtTnVtYmVyJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25hbFBsdWdpblJlZigncHJpbnQnLCB0eXBlKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAoc2NoZW1hVmVyc2lvbiA+PSB2ZXJzaW9ucy5JTklUSUFMX1ZFUlNJT04uc2NoZW1hKSB7XHJcbiAgICAgICAgICAgIG1iUHJvcGVydHlTY2hlbWEucm9vdE9jY3VycmVuY2UgPSBSLnppcE9iaihcclxuICAgICAgICAgICAgICAgIFIubWFwKGtleSA9PiAoa2V5ID09PSAnSW5maWxsRGVuc2l0eScgPyAnaW5maWxsRGVuc2l0eScgOiBTZXR0aW5nc0tleXNba2V5XSksIGJhc2ljU2V0dGluZ3MpLFxyXG4gICAgICAgICAgICAgICAgUi5tYXAoa2V5ID0+IGdldE9wdGlvbmFsUGx1Z2luUmVmKFNldHRpbmdzS2V5c1trZXldKSwgYmFzaWNTZXR0aW5ncylcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChzY2hlbWFWZXJzaW9uID49IHZlcnNpb25zLlIxXzlfREVWRUxPUE1FTlRfU1RBUlQuc2NoZW1hKSB7XHJcbiAgICAgICAgICAgIG1iUHJvcGVydHlTY2hlbWEucm9vdE9jY3VycmVuY2UgPSBSLnppcE9iaihcclxuICAgICAgICAgICAgICAgIFIubWFwKGtleSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChrZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBTZXR0aW5nc0tleXMuRXh0cnVkZXJzOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdhdHRhY2hlZF9leHRydWRlcjAnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFNldHRpbmdzS2V5cy5FeHRydWRlclRlbXA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ2V4dHJ1ZGVyVGVtcDAnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFNldHRpbmdzS2V5cy5PdXRsaW5lRmVlZFJhdGU6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ2V4dHJ1c2lvblByb2ZpbGVzPm91dGxpbmVzPmZlZWRyYXRlJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBTZXR0aW5nc0tleXMuSW5maWxsRmlsbFRoaWNrbmVzczpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnZXh0cnVkZXJQcm9maWxlcz4wPm1heFNwYXJzZUZpbGxUaGlja25lc3MnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFNldHRpbmdzS2V5cy5TcGFyc2VGZWVkUmF0ZTA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ2V4dHJ1c2lvblByb2ZpbGVzPmluZmlsbD5mZWVkcmF0ZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgU2V0dGluZ3NLZXlzLlJhZnRCYXNlRmVlZFJhdGU6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ2V4dHJ1c2lvblByb2ZpbGVzPnJhZnRCYXNlPmZlZWRyYXRlJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBTZXR0aW5nc0tleXMuUmFmdEJhc2VGYW5TcGVlZDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnZXh0cnVzaW9uUHJvZmlsZXM+cmFmdEJhc2U+ZmFuU3BlZWQnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFNldHRpbmdzS2V5cy5CYXNlTGF5ZXJTdXJmYWNlRmVlZFJhdGUwOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdleHRydXNpb25Qcm9maWxlcz5maXJzdE1vZGVsTGF5ZXI+ZmVlZHJhdGUnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFNldHRpbmdzS2V5cy5GaXJzdE1vZGVsTGF5ZXJDb29saW5nRmFuU3BlZWQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ2V4dHJ1c2lvblByb2ZpbGVzPmZpcnN0TW9kZWxMYXllcj5mYW5TcGVlZCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ga2V5O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sIFIudmFsdWVzKFNldHRpbmdzS2V5cykpLFxyXG4gICAgICAgICAgICAgICAgUi5tYXAoZ2V0T3B0aW9uYWxQbHVnaW5SZWYsIFIudmFsdWVzKFNldHRpbmdzS2V5cykpXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIG1iUHJvcGVydHlTY2hlbWEucm9vdE9jY3VycmVuY2UuYXR0YWNoZWRfZXh0cnVkZXIwID0gdGhpcy5vcHRpb25hbFBsdWdpblJlZigncHJpbnQnLCAnR2VuZXJhbEVsZW1TdHJpbmcnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChzY2hlbWFWZXJzaW9uID49IHZlcnNpb25zLlIyXzZfREVWRUxPUE1FTlRfU1RBUlQuc2NoZW1hKSB7XHJcbiAgICAgICAgICAgIG1iUHJvcGVydHlTY2hlbWEucm9vdE9jY3VycmVuY2UgPSBSLnppcE9iaihcclxuICAgICAgICAgICAgICAgIFIudmFsdWVzKFNldHRpbmdzS2V5cyksXHJcbiAgICAgICAgICAgICAgICBSLm1hcChnZXRPcHRpb25hbFBsdWdpblJlZiwgUi52YWx1ZXMoU2V0dGluZ3NLZXlzKSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChzY2hlbWFWZXJzaW9uID49IHZlcnNpb25zLlIyXzlfREVWRUxPUE1FTlRfU1RBUlQuc2NoZW1hKSB7XHJcbiAgICAgICAgICAgIG1iUHJvcGVydHlTY2hlbWEucm9vdE9jY3VycmVuY2UgPSBSLnppcE9iaihcclxuICAgICAgICAgICAgICAgIFIudmFsdWVzKFNldHRpbmdzS2V5cyksXHJcbiAgICAgICAgICAgICAgICBSLm1hcChnZXRPcHRpb25hbFBsdWdpblJlZiwgUi52YWx1ZXMoU2V0dGluZ3NLZXlzKSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG1iUHJvcGVydHlTY2hlbWE7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VmFsaWRhdGlvblNjaGVtYShzY2hlbWFWZXJzaW9uLCB2ZXJzaW9ucywgcHJvcGVydGllcykge1xyXG4gICAgICAgIGNvbnN0IG1iUHJvamVjdFNjaGVtYSA9IHsgcHJvcGVydGllczoge30sIGRlZmluaXRpb25zOiB7fSB9O1xyXG5cclxuICAgICAgICByZXR1cm4gbWJQcm9qZWN0U2NoZW1hO1xyXG4gICAgfVxyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IE1CUHJvamVjdFZhbGlkYXRvclByb3ZpZGVyO1xyXG4iXX0=
