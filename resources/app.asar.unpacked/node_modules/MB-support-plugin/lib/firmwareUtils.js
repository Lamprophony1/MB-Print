'use strict';

const MessageIDs = Object.freeze({
  Waiting: 'firmware waiting message',
  Error: 'firmware error message',
  Progress: 'firmware progress message'
});

const firmwareDownloadMessages = flux => {
  const i18n = flux.getService('TranslationService');
  const message = flux.actions.message;
  return {
    error: id => {
      message.createErrorMessage({
        message: i18n.t('mb:firmware.download_error'),
        id
      });
    },
    progress: (id, percent, onCancel) => {
      message.updateProgress({
        message: i18n.t('mb:firmware.downloading'),
        id,
        progressPercentage: percent,
        isIndeterminate: false,
        actionLabel: i18n.t('updater.cancel_download'),
        actionCallback: onCancel
      });
    },
    dismiss: message.dismissMessage.bind(message)
  };
};

const updateFirmware = (printer, flux) => {
  const logger = flux.getService('LoggingService');
  const message = firmwareDownloadMessages(flux);
  printer.firmware.update().then(resp => {
    logger.info(resp);
    message.dismiss(MessageIDs.Progress);
  }, err => {
    logger.warn(err);
    message.error(MessageIDs.Error);
  }, prog => {
    if (prog.percentage >= 1) {
      message.dismiss(MessageIDs.Progress);
      return;
    }

    message.progress(MessageIDs.Progress, Math.round(prog.percentage * 100), () => {
      prog.cancel();
      message.dismiss(MessageIDs.Progress);
    });
  });
};

module.exports = {
  firmwareDownloadMessages,
  updateFirmware
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpcm13YXJlVXRpbHMuanMiXSwibmFtZXMiOlsiTWVzc2FnZUlEcyIsIk9iamVjdCIsImZyZWV6ZSIsIldhaXRpbmciLCJFcnJvciIsIlByb2dyZXNzIiwiZmlybXdhcmVEb3dubG9hZE1lc3NhZ2VzIiwiZmx1eCIsImkxOG4iLCJnZXRTZXJ2aWNlIiwibWVzc2FnZSIsImFjdGlvbnMiLCJlcnJvciIsImlkIiwiY3JlYXRlRXJyb3JNZXNzYWdlIiwidCIsInByb2dyZXNzIiwicGVyY2VudCIsIm9uQ2FuY2VsIiwidXBkYXRlUHJvZ3Jlc3MiLCJwcm9ncmVzc1BlcmNlbnRhZ2UiLCJpc0luZGV0ZXJtaW5hdGUiLCJhY3Rpb25MYWJlbCIsImFjdGlvbkNhbGxiYWNrIiwiZGlzbWlzcyIsImRpc21pc3NNZXNzYWdlIiwiYmluZCIsInVwZGF0ZUZpcm13YXJlIiwicHJpbnRlciIsImxvZ2dlciIsImZpcm13YXJlIiwidXBkYXRlIiwidGhlbiIsInJlc3AiLCJpbmZvIiwiZXJyIiwid2FybiIsInByb2ciLCJwZXJjZW50YWdlIiwiTWF0aCIsInJvdW5kIiwiY2FuY2VsIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsTUFBTUEsVUFBVSxHQUFHQyxNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUM3QkMsRUFBQUEsT0FBTyxFQUFFLDBCQURvQjtBQUU3QkMsRUFBQUEsS0FBSyxFQUFFLHdCQUZzQjtBQUc3QkMsRUFBQUEsUUFBUSxFQUFFO0FBSG1CLENBQWQsQ0FBbkI7O0FBTUEsTUFBTUMsd0JBQXdCLEdBQUdDLElBQUksSUFBSTtBQUNyQyxRQUFNQyxJQUFJLEdBQUdELElBQUksQ0FBQ0UsVUFBTCxDQUFnQixvQkFBaEIsQ0FBYjtBQUNBLFFBQU1DLE9BQU8sR0FBR0gsSUFBSSxDQUFDSSxPQUFMLENBQWFELE9BQTdCO0FBRUEsU0FBTztBQUNIRSxJQUFBQSxLQUFLLEVBQUVDLEVBQUUsSUFBSTtBQUNUSCxNQUFBQSxPQUFPLENBQUNJLGtCQUFSLENBQTJCO0FBQUVKLFFBQUFBLE9BQU8sRUFBRUYsSUFBSSxDQUFDTyxDQUFMLENBQU8sNEJBQVAsQ0FBWDtBQUFpREYsUUFBQUE7QUFBakQsT0FBM0I7QUFDSCxLQUhFO0FBSUhHLElBQUFBLFFBQVEsRUFBRSxDQUFDSCxFQUFELEVBQUtJLE9BQUwsRUFBY0MsUUFBZCxLQUEyQjtBQUNqQ1IsTUFBQUEsT0FBTyxDQUFDUyxjQUFSLENBQXVCO0FBQ25CVCxRQUFBQSxPQUFPLEVBQUVGLElBQUksQ0FBQ08sQ0FBTCxDQUFPLHlCQUFQLENBRFU7QUFFbkJGLFFBQUFBLEVBRm1CO0FBR25CTyxRQUFBQSxrQkFBa0IsRUFBRUgsT0FIRDtBQUluQkksUUFBQUEsZUFBZSxFQUFFLEtBSkU7QUFLbkJDLFFBQUFBLFdBQVcsRUFBRWQsSUFBSSxDQUFDTyxDQUFMLENBQU8seUJBQVAsQ0FMTTtBQU1uQlEsUUFBQUEsY0FBYyxFQUFFTDtBQU5HLE9BQXZCO0FBUUgsS0FiRTtBQWNITSxJQUFBQSxPQUFPLEVBQUVkLE9BQU8sQ0FBQ2UsY0FBUixDQUF1QkMsSUFBdkIsQ0FBNEJoQixPQUE1QjtBQWROLEdBQVA7QUFnQkgsQ0FwQkQ7O0FBc0JBLE1BQU1pQixjQUFjLEdBQUcsQ0FBQ0MsT0FBRCxFQUFVckIsSUFBVixLQUFtQjtBQUN0QyxRQUFNc0IsTUFBTSxHQUFHdEIsSUFBSSxDQUFDRSxVQUFMLENBQWdCLGdCQUFoQixDQUFmO0FBQ0EsUUFBTUMsT0FBTyxHQUFHSix3QkFBd0IsQ0FBQ0MsSUFBRCxDQUF4QztBQUVBcUIsRUFBQUEsT0FBTyxDQUFDRSxRQUFSLENBQWlCQyxNQUFqQixHQUEwQkMsSUFBMUIsQ0FDSUMsSUFBSSxJQUFJO0FBQ0pKLElBQUFBLE1BQU0sQ0FBQ0ssSUFBUCxDQUFZRCxJQUFaO0FBQ0F2QixJQUFBQSxPQUFPLENBQUNjLE9BQVIsQ0FBZ0J4QixVQUFVLENBQUNLLFFBQTNCO0FBQ0gsR0FKTCxFQUtJOEIsR0FBRyxJQUFJO0FBQ0hOLElBQUFBLE1BQU0sQ0FBQ08sSUFBUCxDQUFZRCxHQUFaO0FBQ0F6QixJQUFBQSxPQUFPLENBQUNFLEtBQVIsQ0FBY1osVUFBVSxDQUFDSSxLQUF6QjtBQUNILEdBUkwsRUFTSWlDLElBQUksSUFBSTtBQUNKLFFBQUlBLElBQUksQ0FBQ0MsVUFBTCxJQUFtQixDQUF2QixFQUEwQjtBQUN0QjVCLE1BQUFBLE9BQU8sQ0FBQ2MsT0FBUixDQUFnQnhCLFVBQVUsQ0FBQ0ssUUFBM0I7QUFDQTtBQUNIOztBQUVESyxJQUFBQSxPQUFPLENBQUNNLFFBQVIsQ0FBaUJoQixVQUFVLENBQUNLLFFBQTVCLEVBQXNDa0MsSUFBSSxDQUFDQyxLQUFMLENBQVdILElBQUksQ0FBQ0MsVUFBTCxHQUFrQixHQUE3QixDQUF0QyxFQUF5RSxNQUFNO0FBQzNFRCxNQUFBQSxJQUFJLENBQUNJLE1BQUw7QUFDQS9CLE1BQUFBLE9BQU8sQ0FBQ2MsT0FBUixDQUFnQnhCLFVBQVUsQ0FBQ0ssUUFBM0I7QUFDSCxLQUhEO0FBSUgsR0FuQkw7QUFxQkgsQ0F6QkQ7O0FBMkJBcUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCO0FBQ2JyQyxFQUFBQSx3QkFEYTtBQUVicUIsRUFBQUE7QUFGYSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbmNvbnN0IE1lc3NhZ2VJRHMgPSBPYmplY3QuZnJlZXplKHtcclxuICAgIFdhaXRpbmc6ICdmaXJtd2FyZSB3YWl0aW5nIG1lc3NhZ2UnLFxyXG4gICAgRXJyb3I6ICdmaXJtd2FyZSBlcnJvciBtZXNzYWdlJyxcclxuICAgIFByb2dyZXNzOiAnZmlybXdhcmUgcHJvZ3Jlc3MgbWVzc2FnZScsXHJcbn0pO1xyXG5cclxuY29uc3QgZmlybXdhcmVEb3dubG9hZE1lc3NhZ2VzID0gZmx1eCA9PiB7XHJcbiAgICBjb25zdCBpMThuID0gZmx1eC5nZXRTZXJ2aWNlKCdUcmFuc2xhdGlvblNlcnZpY2UnKTtcclxuICAgIGNvbnN0IG1lc3NhZ2UgPSBmbHV4LmFjdGlvbnMubWVzc2FnZTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGVycm9yOiBpZCA9PiB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UuY3JlYXRlRXJyb3JNZXNzYWdlKHsgbWVzc2FnZTogaTE4bi50KCdtYjpmaXJtd2FyZS5kb3dubG9hZF9lcnJvcicpLCBpZCB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHByb2dyZXNzOiAoaWQsIHBlcmNlbnQsIG9uQ2FuY2VsKSA9PiB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UudXBkYXRlUHJvZ3Jlc3Moe1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogaTE4bi50KCdtYjpmaXJtd2FyZS5kb3dubG9hZGluZycpLFxyXG4gICAgICAgICAgICAgICAgaWQsXHJcbiAgICAgICAgICAgICAgICBwcm9ncmVzc1BlcmNlbnRhZ2U6IHBlcmNlbnQsXHJcbiAgICAgICAgICAgICAgICBpc0luZGV0ZXJtaW5hdGU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgYWN0aW9uTGFiZWw6IGkxOG4udCgndXBkYXRlci5jYW5jZWxfZG93bmxvYWQnKSxcclxuICAgICAgICAgICAgICAgIGFjdGlvbkNhbGxiYWNrOiBvbkNhbmNlbCxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBkaXNtaXNzOiBtZXNzYWdlLmRpc21pc3NNZXNzYWdlLmJpbmQobWVzc2FnZSksXHJcbiAgICB9O1xyXG59O1xyXG5cclxuY29uc3QgdXBkYXRlRmlybXdhcmUgPSAocHJpbnRlciwgZmx1eCkgPT4ge1xyXG4gICAgY29uc3QgbG9nZ2VyID0gZmx1eC5nZXRTZXJ2aWNlKCdMb2dnaW5nU2VydmljZScpO1xyXG4gICAgY29uc3QgbWVzc2FnZSA9IGZpcm13YXJlRG93bmxvYWRNZXNzYWdlcyhmbHV4KTtcclxuXHJcbiAgICBwcmludGVyLmZpcm13YXJlLnVwZGF0ZSgpLnRoZW4oXHJcbiAgICAgICAgcmVzcCA9PiB7XHJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKHJlc3ApO1xyXG4gICAgICAgICAgICBtZXNzYWdlLmRpc21pc3MoTWVzc2FnZUlEcy5Qcm9ncmVzcyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlcnIgPT4ge1xyXG4gICAgICAgICAgICBsb2dnZXIud2FybihlcnIpO1xyXG4gICAgICAgICAgICBtZXNzYWdlLmVycm9yKE1lc3NhZ2VJRHMuRXJyb3IpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcHJvZyA9PiB7XHJcbiAgICAgICAgICAgIGlmIChwcm9nLnBlcmNlbnRhZ2UgPj0gMSkge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZS5kaXNtaXNzKE1lc3NhZ2VJRHMuUHJvZ3Jlc3MpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBtZXNzYWdlLnByb2dyZXNzKE1lc3NhZ2VJRHMuUHJvZ3Jlc3MsIE1hdGgucm91bmQocHJvZy5wZXJjZW50YWdlICogMTAwKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcHJvZy5jYW5jZWwoKTtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2UuZGlzbWlzcyhNZXNzYWdlSURzLlByb2dyZXNzKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgKTtcclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gICAgZmlybXdhcmVEb3dubG9hZE1lc3NhZ2VzLFxyXG4gICAgdXBkYXRlRmlybXdhcmUsXHJcbn07XHJcbiJdfQ==
