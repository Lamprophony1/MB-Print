"use strict";

const fs = require('fs');

const JSZip = require('jszip');

const path = require('path');

const q = require('q');

const tmp = require('tmp');

const THREE = require('three');

const constants = require('./constants'); // Configure temp directory behavior


tmp.setGracefulCleanup(); // setup thing extension

const THING_EXTENSION = '.thing';
/**
 * Helper function to split a single dimension array into
 * bite size chunks
 *
 * @param (array) the array you want to break down
 * @param (size) the size of the chunks
 *
 * @return an array x by x size
 */

const createMultiChunksArray = (array, size) => {
  const result = [];

  for (let i = 0; i < array.length; i += size) {
    result.push(Array.from(array.slice(i, i + size)));
  }

  return result;
};
/**
 * Take the single dimension 16-element array representation of THREE.Matrix4
 * transform and convert it into a usable 4x4 array for libThing. The scaling
 * factor needs to be in mm.
 *
 * @param transform (array) single dimension 16-element array that is row-major
 *  Check trayBody.getBuildTransform() => transform.toArray()
 *
 * @return transform formatted into 4 x 4 array
 * [
 *   [ A11, A12, A13, A14 ],
 *   [ A21, A22, A23, A24 ],
 *   [ A31, A32, A33, A34 ],
 *   [ A41, A42, A43, A44 ]
 * ]
 */


const modifyTransformForManifest = transform => {
  /**
   * THREE.Matrix4().fromArray expects array set to be column-major. The
   * transform return from trayBodies.getBuildTransform() returns row-major
   * single dimension array.
   *
   * It requires a transpose() after creating the transform matrix using
   * row-major array input (@param transform).
   *
   */
  const threeTransform = new THREE.Matrix4().fromArray(transform).transpose(); // extract rotation, position, and scale matricies from the transformation

  const position = new THREE.Vector3();
  const quaternion = new THREE.Quaternion();
  const scale = new THREE.Vector3();
  threeTransform.decompose(position, quaternion, scale); // all eagle-desktop transforms are in meters, but libthing deals in
  // millimeters, so scale everything up by 1000

  position.multiplyScalar(1000);
  scale.multiplyScalar(1000);
  const scaledTransform = new THREE.Matrix4().compose(position, quaternion, scale);
  /**
   * --NOTES--
   * To build the proper represenation of the Manifest Transformation matrix,
   * output array needs to be row-major, then chunk into 4 x 4 array.
   *
   * From [ A11, A12, A13, A14, A21, A22, A23, A24 ,A31, A32, A33, A34,
   *   A41, A42, A43, A44 ]
   *
   * To [
   *   [ A11, A12, A13, A14 ],
   *   [ A21, A22, A23, A24 ],
   *   [ A31, A32, A33, A34 ],
   *   [ A41, A42, A43, A44 ]
   * ]
   *
   * THREE.Matrix4().set takes in row-major array, but .elements display
   * column-major array. To return row-major array from .elements, transpose
   * the matrix before returning the array:
   *
   * - scaledTransform.elements will return col-major array
   * - scaledTransform.transpose().elements will return row-major array
   *
   */

  return createMultiChunksArray(scaledTransform.transpose().elements, 4);
};

const createThingFile = (stlFiles, extruderList, transforms, outputFileName, callback) => {
  // check that we have stl files and that its the same size as transforms
  if (!stlFiles || stlFiles.length === 0) {
    return q.Promise.reject(new Error('No STL files to create dot thing!'));
  } else if (!transforms || transforms.length !== stlFiles.length) {
    return q.Promise.reject(new Error('Invalid transforms supplied to STL merge'));
  } // create the empty manifest


  const manifest = {
    // where to find the spec
    namespace: 'http://spec.makerbot.com/ns/thing.0.1.1.1',
    // we can probably kill this section
    attribution: {
      author: 'Unknown',
      license: 'Unknown'
    },
    // this is where we'll put the stl file names
    objects: {},
    // this is where we'll store info on each instance of our objects
    instances: {},
    // this is where we'll store the transformations for each instance
    transformations: {},
    // this is where we store the settings to use on our instances
    // for now, we're only printing on single extrusion machines with uniform
    // settings, so we'll leave it at just the traditional plastic a
    construction: ['PlasticA', 'PlasticB']
  }; // spin up a tmp directory and a tmp filepath for the thing

  const tempDir = tmp.dirSync();
  const outputFilePath = path.join(tempDir.name, outputFileName + THING_EXTENSION);
  const zipFile = new JSZip(); // setup an array to keep track of what stl's have already been processed

  const alreadyZipped = [];
  const zipPromises = []; // method to add transforms for each instance to the thing manifest

  const addTransformToManifest = (id, transform) => {
    const transformName = `transform${id}`;
    const matrix = modifyTransformForManifest(transform);
    manifest.transformations[transformName] = {
      matrix
    };
    return transformName;
  }; // function to add a mesh file to the zip folder. returns a promise.


  const addFileToZip = (filePath, fileName) => {
    // create a defered object
    const d = q.defer(); // in the readfile callback function, use the deferred object

    fs.readFile(filePath, (err, data) => {
      if (err) d.reject(err);
      zipFile.file(fileName, data);
      d.resolve();
    }); // return the deferred object's promise

    return d.promise;
  }; // function to add the thing manifest to the sip folder. returns a promise.


  const addManifest = () => {
    return q.Promise(resolve => {
      zipFile.file('manifest.json', JSON.stringify(manifest, null, 2));
      resolve();
    });
  }; // compress the thing file. return promise to compress the zipped file


  const compressZipFile = () => {
    // create a defered object
    const d = q.defer(); // options for zipping the file

    const zipOptions = {
      type: 'nodebuffer',
      compression: 'DEFLATE',
      compressionOptions: {
        level: 6
      },
      platform: 'UNIX'
    }; // generate the zipped content and write it to our output file

    zipFile.generateNodeStream(zipOptions).pipe(fs.createWriteStream(outputFilePath)).on('finish', () => {
      d.resolve(outputFilePath);
    }); // return the deffered object's promise

    return d.promise;
  }; // translate from extruderA/B to PlasticA/B


  const translateExtruder = extruder => {
    return constants.ExtruderTranslation[extruder] ? constants.ExtruderTranslation[extruder] : 'PlasticA';
  }; // process each model file


  stlFiles.forEach((stlFile, i) => {
    // get the filepath and transform for this mesh
    const meshFilepath = stlFile;
    const meshBasename = path.basename(meshFilepath);
    const meshTransform = transforms[i];
    const instanceName = `instance${i}`;
    const transformName = addTransformToManifest(i, meshTransform);
    const plasticSelection = translateExtruder(extruderList[i]); // add the instance to the manifest with the correct values

    manifest.instances[instanceName] = {
      construction: plasticSelection,
      object: meshBasename,
      scale: 'mm',
      xform: transformName
    };
    /**
     * if this mesh hasn't been added to the zip file yet, then create a
     * promise to do so and add it to the array of zip promises.
     */

    if (alreadyZipped.indexOf(meshBasename) === -1) {
      alreadyZipped.push(meshBasename);
      zipPromises.push(addFileToZip(meshFilepath, meshBasename));
      manifest.objects[meshBasename] = {};
    }
  }); // settle all the adding promises, then add the meta data, then zip up the dot
  // thing file

  return q.allSettled(zipPromises).then(addManifest).then(compressZipFile).nodeify(callback);
};

module.exports = {
  createThingFile
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRoaW5nLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsIkpTWmlwIiwicGF0aCIsInEiLCJ0bXAiLCJUSFJFRSIsImNvbnN0YW50cyIsInNldEdyYWNlZnVsQ2xlYW51cCIsIlRISU5HX0VYVEVOU0lPTiIsImNyZWF0ZU11bHRpQ2h1bmtzQXJyYXkiLCJhcnJheSIsInNpemUiLCJyZXN1bHQiLCJpIiwibGVuZ3RoIiwicHVzaCIsIkFycmF5IiwiZnJvbSIsInNsaWNlIiwibW9kaWZ5VHJhbnNmb3JtRm9yTWFuaWZlc3QiLCJ0cmFuc2Zvcm0iLCJ0aHJlZVRyYW5zZm9ybSIsIk1hdHJpeDQiLCJmcm9tQXJyYXkiLCJ0cmFuc3Bvc2UiLCJwb3NpdGlvbiIsIlZlY3RvcjMiLCJxdWF0ZXJuaW9uIiwiUXVhdGVybmlvbiIsInNjYWxlIiwiZGVjb21wb3NlIiwibXVsdGlwbHlTY2FsYXIiLCJzY2FsZWRUcmFuc2Zvcm0iLCJjb21wb3NlIiwiZWxlbWVudHMiLCJjcmVhdGVUaGluZ0ZpbGUiLCJzdGxGaWxlcyIsImV4dHJ1ZGVyTGlzdCIsInRyYW5zZm9ybXMiLCJvdXRwdXRGaWxlTmFtZSIsImNhbGxiYWNrIiwiUHJvbWlzZSIsInJlamVjdCIsIkVycm9yIiwibWFuaWZlc3QiLCJuYW1lc3BhY2UiLCJhdHRyaWJ1dGlvbiIsImF1dGhvciIsImxpY2Vuc2UiLCJvYmplY3RzIiwiaW5zdGFuY2VzIiwidHJhbnNmb3JtYXRpb25zIiwiY29uc3RydWN0aW9uIiwidGVtcERpciIsImRpclN5bmMiLCJvdXRwdXRGaWxlUGF0aCIsImpvaW4iLCJuYW1lIiwiemlwRmlsZSIsImFscmVhZHlaaXBwZWQiLCJ6aXBQcm9taXNlcyIsImFkZFRyYW5zZm9ybVRvTWFuaWZlc3QiLCJpZCIsInRyYW5zZm9ybU5hbWUiLCJtYXRyaXgiLCJhZGRGaWxlVG9aaXAiLCJmaWxlUGF0aCIsImZpbGVOYW1lIiwiZCIsImRlZmVyIiwicmVhZEZpbGUiLCJlcnIiLCJkYXRhIiwiZmlsZSIsInJlc29sdmUiLCJwcm9taXNlIiwiYWRkTWFuaWZlc3QiLCJKU09OIiwic3RyaW5naWZ5IiwiY29tcHJlc3NaaXBGaWxlIiwiemlwT3B0aW9ucyIsInR5cGUiLCJjb21wcmVzc2lvbiIsImNvbXByZXNzaW9uT3B0aW9ucyIsImxldmVsIiwicGxhdGZvcm0iLCJnZW5lcmF0ZU5vZGVTdHJlYW0iLCJwaXBlIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJvbiIsInRyYW5zbGF0ZUV4dHJ1ZGVyIiwiZXh0cnVkZXIiLCJFeHRydWRlclRyYW5zbGF0aW9uIiwiZm9yRWFjaCIsInN0bEZpbGUiLCJtZXNoRmlsZXBhdGgiLCJtZXNoQmFzZW5hbWUiLCJiYXNlbmFtZSIsIm1lc2hUcmFuc2Zvcm0iLCJpbnN0YW5jZU5hbWUiLCJwbGFzdGljU2VsZWN0aW9uIiwib2JqZWN0IiwieGZvcm0iLCJpbmRleE9mIiwiYWxsU2V0dGxlZCIsInRoZW4iLCJub2RlaWZ5IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxJQUFELENBQWxCOztBQUNBLE1BQU1DLEtBQUssR0FBR0QsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNRyxDQUFDLEdBQUdILE9BQU8sQ0FBQyxHQUFELENBQWpCOztBQUNBLE1BQU1JLEdBQUcsR0FBR0osT0FBTyxDQUFDLEtBQUQsQ0FBbkI7O0FBQ0EsTUFBTUssS0FBSyxHQUFHTCxPQUFPLENBQUMsT0FBRCxDQUFyQjs7QUFFQSxNQUFNTSxTQUFTLEdBQUdOLE9BQU8sQ0FBQyxhQUFELENBQXpCLEMsQ0FFQTs7O0FBQ0FJLEdBQUcsQ0FBQ0csa0JBQUosRyxDQUVBOztBQUNBLE1BQU1DLGVBQWUsR0FBRyxRQUF4QjtBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFDQSxNQUFNQyxzQkFBc0IsR0FBRyxDQUFD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RCxFQUFlQyxZQUFmLENBQTdCO0FBQ0FwRCxNQUFBQSxRQUFRLENBQUNLLE9BQVQsQ0FBaUIrQyxZQUFqQixJQUFpQyxFQUFqQztBQUNIO0FBQ0osR0ExQkQsRUF2R3NGLENBbUl0RjtBQUNBOztBQUNBLFNBQU83RixDQUFDLENBQ0hxRyxVQURFLENBQ1M1QyxXQURULEVBRUY2QyxJQUZFLENBRUc3QixXQUZILEVBR0Y2QixJQUhFLENBR0cxQixlQUhILEVBSUYyQixPQUpFLENBSU1sRSxRQUpOLENBQVA7QUFLSCxDQTFJRDs7QUE0SUFtRSxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDYnpFLEVBQUFBO0FBRGEsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XHJcbmNvbnN0IEpTWmlwID0gcmVxdWlyZSgnanN6aXAnKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgcSA9IHJlcXVpcmUoJ3EnKTtcclxuY29uc3QgdG1wID0gcmVxdWlyZSgndG1wJyk7XHJcbmNvbnN0IFRIUkVFID0gcmVxdWlyZSgndGhyZWUnKTtcclxuXHJcbmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJyk7XHJcblxyXG4vLyBDb25maWd1cmUgdGVtcCBkaXJlY3RvcnkgYmVoYXZpb3JcclxudG1wLnNldEdyYWNlZnVsQ2xlYW51cCgpO1xyXG5cclxuLy8gc2V0dXAgdGhpbmcgZXh0ZW5zaW9uXHJcbmNvbnN0IFRISU5HX0VYVEVOU0lPTiA9ICcudGhpbmcnO1xyXG5cclxuLyoqXHJcbiAqIEhlbHBlciBmdW5jdGlvbiB0byBzcGxpdCBhIHNpbmdsZSBkaW1lbnNpb24gYXJyYXkgaW50b1xyXG4gKiBiaXRlIHNpemUgY2h1bmtzXHJcbiAqXHJcbiAqIEBwYXJhbSAoYXJyYXkpIHRoZSBhcnJheSB5b3Ugd2FudCB0byBicmVhayBkb3duXHJcbiAqIEBwYXJhbSAoc2l6ZSkgdGhlIHNpemUgb2YgdGhlIGNodW5rc1xyXG4gKlxyXG4gKiBAcmV0dXJuIGFuIGFycmF5IHggYnkgeCBzaXplXHJcbiAqL1xyXG5jb25zdCBjcmVhdGVNdWx0aUNodW5rc0FycmF5ID0gKGFycmF5LCBzaXplKSA9PiB7XHJcbiAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSArPSBzaXplKSB7XHJcbiAgICAgICAgcmVzdWx0LnB1c2goQXJyYXkuZnJvbShhcnJheS5zbGljZShpLCBpICsgc2l6ZSkpKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIFRha2UgdGhlIHNpbmdsZSBkaW1lbnNpb24gMTYtZWxlbWVudCBhcnJheSByZXByZXNlbnRhdGlvbiBvZiBUSFJFRS5NYXRyaXg0XHJcbiAqIHRyYW5zZm9ybSBhbmQgY29udmVydCBpdCBpbnRvIGEgdXNhYmxlIDR4NCBhcnJheSBmb3IgbGliVGhpbmcuIFRoZSBzY2FsaW5nXHJcbiAqIGZhY3RvciBuZWVkcyB0byBiZSBpbiBtbS5cclxuICpcclxuICogQHBhcmFtIHRyYW5zZm9ybSAoYXJyYXkpIHNpbmdsZSBkaW1lbnNpb24gMTYtZWxlbWVudCBhcnJheSB0aGF0IGlzIHJvdy1tYWpvclxyXG4gKiAgQ2hlY2sgdHJheUJvZHkuZ2V0QnVpbGRUcmFuc2Zvcm0oKSA9PiB0cmFuc2Zvcm0udG9BcnJheSgpXHJcbiAqXHJcbiAqIEByZXR1cm4gdHJhbnNmb3JtIGZvcm1hdHRlZCBpbnRvIDQgeCA0IGFycmF5XHJcbiAqIFtcclxuICogICBbIEExMSwgQTEyLCBBMTMsIEExNCBdLFxyXG4gKiAgIFsgQTIxLCBBMjIsIEEyMywgQTI0IF0sXHJcbiAqICAgWyBBMzEsIEEzMiwgQTMzLCBBMzQgXSxcclxuICogICBbIEE0MSwgQTQyLCBBNDMsIEE0NCBdXHJcbiAqIF1cclxuICovXHJcbmNvbnN0IG1vZGlmeVRyYW5zZm9ybUZvck1hbmlmZXN0ID0gdHJhbnNmb3JtID0+IHtcclxuICAgIC8qKlxyXG4gICAgICogVEhSRUUuTWF0cml4NCgpLmZyb21BcnJheSBleHBlY3RzIGFycmF5IHNldCB0byBiZSBjb2x1bW4tbWFqb3IuIFRoZVxyXG4gICAgICogdHJhbnNmb3JtIHJldHVybiBmcm9tIHRyYXlCb2RpZXMuZ2V0QnVpbGRUcmFuc2Zvcm0oKSByZXR1cm5zIHJvdy1tYWpvclxyXG4gICAgICogc2luZ2xlIGRpbWVuc2lvbiBhcnJheS5cclxuICAgICAqXHJcbiAgICAgKiBJdCByZXF1aXJlcyBhIHRyYW5zcG9zZSgpIGFmdGVyIGNyZWF0aW5nIHRoZSB0cmFuc2Zvcm0gbWF0cml4IHVzaW5nXHJcbiAgICAgKiByb3ctbWFqb3IgYXJyYXkgaW5wdXQgKEBwYXJhbSB0cmFuc2Zvcm0pLlxyXG4gICAgICpcclxuICAgICAqL1xyXG4gICAgY29uc3QgdGhyZWVUcmFuc2Zvcm0gPSBuZXcgVEhSRUUuTWF0cml4NCgpLmZyb21BcnJheSh0cmFuc2Zvcm0pLnRyYW5zcG9zZSgpO1xyXG5cclxuICAgIC8vIGV4dHJhY3Qgcm90YXRpb24sIHBvc2l0aW9uLCBhbmQgc2NhbGUgbWF0cmljaWVzIGZyb20gdGhlIHRyYW5zZm9ybWF0aW9uXHJcbiAgICBjb25zdCBwb3NpdGlvbiA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7XHJcbiAgICBjb25zdCBxdWF0ZXJuaW9uID0gbmV3IFRIUkVFLlF1YXRlcm5pb24oKTtcclxuICAgIGNvbnN0IHNjYWxlID0gbmV3IFRIUkVFLlZlY3RvcjMoKTtcclxuICAgIHRocmVlVHJhbnNmb3JtLmRlY29tcG9zZShwb3NpdGlvbiwgcXVhdGVybmlvbiwgc2NhbGUpO1xyXG5cclxuICAgIC8vIGFsbCBlYWdsZS1kZXNrdG9wIHRyYW5zZm9ybXMgYXJlIGluIG1ldGVycywgYnV0IGxpYnRoaW5nIGRlYWxzIGluXHJcbiAgICAvLyBtaWxsaW1ldGVycywgc28gc2NhbGUgZXZlcnl0aGluZyB1cCBieSAxMDAwXHJcbiAgICBwb3NpdGlvbi5tdWx0aXBseVNjYWxhcigxMDAwKTtcclxuICAgIHNjYWxlLm11bHRpcGx5U2NhbGFyKDEwMDApO1xyXG5cclxuICAgIGNvbnN0IHNjYWxlZFRyYW5zZm9ybSA9IG5ldyBUSFJFRS5NYXRyaXg0KCkuY29tcG9zZShcclxuICAgICAgICBwb3NpdGlvbixcclxuICAgICAgICBxdWF0ZXJuaW9uLFxyXG4gICAgICAgIHNjYWxlXHJcbiAgICApO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogLS1OT1RFUy0tXHJcbiAgICAgKiBUbyBidWlsZCB0aGUgcHJvcGVyIHJlcHJlc2VuYXRpb24gb2YgdGhlIE1hbmlmZXN0IFRyYW5zZm9ybWF0aW9uIG1hdHJpeCxcclxuICAgICAqIG91dHB1dCBhcnJheSBuZWVkcyB0byBiZSByb3ctbWFqb3IsIHRoZW4gY2h1bmsgaW50byA0IHggNCBhcnJheS5cclxuICAgICAqXHJcbiAgICAgKiBGcm9tIFsgQTExLCBBMTIsIEExMywgQTE0LCBBMjEsIEEyMiwgQTIzLCBBMjQgLEEzMSwgQTMyLCBBMzMsIEEzNCxcclxuICAgICAqICAgQTQxLCBBNDIsIEE0MywgQTQ0IF1cclxuICAgICAqXHJcbiAgICAgKiBUbyBbXHJcbiAgICAgKiAgIFsgQTExLCBBMTIsIEExMywgQTE0IF0sXHJcbiAgICAgKiAgIFsgQTIxLCBBMjIsIEEyMywgQTI0IF0sXHJcbiAgICAgKiAgIFsgQTMxLCBBMzIsIEEzMywgQTM0IF0sXHJcbiAgICAgKiAgIFsgQTQxLCBBNDIsIEE0MywgQTQ0IF1cclxuICAgICAqIF1cclxuICAgICAqXHJcbiAgICAgKiBUSFJFRS5NYXRyaXg0KCkuc2V0IHRha2VzIGluIHJvdy1tYWpvciBhcnJheSwgYnV0IC5lbGVtZW50cyBkaXNwbGF5XHJcbiAgICAgKiBjb2x1bW4tbWFqb3IgYXJyYXkuIFRvIHJldHVybiByb3ctbWFqb3IgYXJyYXkgZnJvbSAuZWxlbWVudHMsIHRyYW5zcG9zZVxyXG4gICAgICogdGhlIG1hdHJpeCBiZWZvcmUgcmV0dXJuaW5nIHRoZSBhcnJheTpcclxuICAgICAqXHJcbiAgICAgKiAtIHNjYWxlZFRyYW5zZm9ybS5lbGVtZW50cyB3aWxsIHJldHVybiBjb2wtbWFqb3IgYXJyYXlcclxuICAgICAqIC0gc2NhbGVkVHJhbnNmb3JtLnRyYW5zcG9zZSgpLmVsZW1lbnRzIHdpbGwgcmV0dXJuIHJvdy1tYWpvciBhcnJheVxyXG4gICAgICpcclxuICAgICAqL1xyXG4gICAgcmV0dXJuIGNyZWF0ZU11bHRpQ2h1bmtzQXJyYXkoc2NhbGVkVHJhbnNmb3JtLnRyYW5zcG9zZSgpLmVsZW1lbnRzLCA0KTtcclxufTtcclxuXHJcbmNvbnN0IGNyZWF0ZVRoaW5nRmlsZSA9IChzdGxGaWxlcywgZXh0cnVkZXJMaXN0LCB0cmFuc2Zvcm1zLCBvdXRwdXRGaWxlTmFtZSwgY2FsbGJhY2spID0+IHtcclxuICAgIC8vIGNoZWNrIHRoYXQgd2UgaGF2ZSBzdGwgZmlsZXMgYW5kIHRoYXQgaXRzIHRoZSBzYW1lIHNpemUgYXMgdHJhbnNmb3Jtc1xyXG4gICAgaWYgKCFzdGxGaWxlcyB8fCBzdGxGaWxlcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICByZXR1cm4gcS5Qcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ05vIFNUTCBmaWxlcyB0byBjcmVhdGUgZG90IHRoaW5nIScpKTtcclxuICAgIH0gZWxzZSBpZiAoIXRyYW5zZm9ybXMgfHwgdHJhbnNmb3Jtcy5sZW5ndGggIT09IHN0bEZpbGVzLmxlbmd0aCkge1xyXG4gICAgICAgIHJldHVybiBxLlByb21pc2UucmVqZWN0KG5ldyBFcnJvcignSW52YWxpZCB0cmFuc2Zvcm1zIHN1cHBsaWVkIHRvIFNUTCBtZXJnZScpKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBjcmVhdGUgdGhlIGVtcHR5IG1hbmlmZXN0XHJcbiAgICBjb25zdCBtYW5pZmVzdCA9IHtcclxuICAgICAgICAvLyB3aGVyZSB0byBmaW5kIHRoZSBzcGVjXHJcbiAgICAgICAgbmFtZXNwYWNlOiAnaHR0cDovL3NwZWMubWFrZXJib3QuY29tL25zL3RoaW5nLjAuMS4xLjEnLFxyXG4gICAgICAgIC8vIHdlIGNhbiBwcm9iYWJseSBraWxsIHRoaXMgc2VjdGlvblxyXG4gICAgICAgIGF0dHJpYnV0aW9uOiB7XHJcbiAgICAgICAgICAgIGF1dGhvcjogJ1Vua25vd24nLFxyXG4gICAgICAgICAgICBsaWNlbnNlOiAnVW5rbm93bicsXHJcbiAgICAgICAgfSxcclxuICAgICAgICAvLyB0aGlzIGlzIHdoZXJlIHdlJ2xsIHB1dCB0aGUgc3RsIGZpbGUgbmFtZXNcclxuICAgICAgICBvYmplY3RzOiB7fSxcclxuICAgICAgICAvLyB0aGlzIGlzIHdoZXJlIHdlJ2xsIHN0b3JlIGluZm8gb24gZWFjaCBpbnN0YW5jZSBvZiBvdXIgb2JqZWN0c1xyXG4gICAgICAgIGluc3RhbmNlczoge30sXHJcbiAgICAgICAgLy8gdGhpcyBpcyB3aGVyZSB3ZSdsbCBzdG9yZSB0aGUgdHJhbnNmb3JtYXRpb25zIGZvciBlYWNoIGluc3RhbmNlXHJcbiAgICAgICAgdHJhbnNmb3JtYXRpb25zOiB7fSxcclxuICAgICAgICAvLyB0aGlzIGlzIHdoZXJlIHdlIHN0b3JlIHRoZSBzZXR0aW5ncyB0byB1c2Ugb24gb3VyIGluc3RhbmNlc1xyXG4gICAgICAgIC8vIGZvciBub3csIHdlJ3JlIG9ubHkgcHJpbnRpbmcgb24gc2luZ2xlIGV4dHJ1c2lvbiBtYWNoaW5lcyB3aXRoIHVuaWZvcm1cclxuICAgICAgICAvLyBzZXR0aW5ncywgc28gd2UnbGwgbGVhdmUgaXQgYXQganVzdCB0aGUgdHJhZGl0aW9uYWwgcGxhc3RpYyBhXHJcbiAgICAgICAgY29uc3RydWN0aW9uOiBbJ1BsYXN0aWNBJywgJ1BsYXN0aWNCJ10sXHJcbiAgICB9O1xyXG5cclxuICAgIC8vIHNwaW4gdXAgYSB0bXAgZGlyZWN0b3J5IGFuZCBhIHRtcCBmaWxlcGF0aCBmb3IgdGhlIHRoaW5nXHJcbiAgICBjb25zdCB0ZW1wRGlyID0gdG1wLmRpclN5bmMoKTtcclxuICAgIGNvbnN0IG91dHB1dEZpbGVQYXRoID0gcGF0aC5qb2luKHRlbXBEaXIubmFtZSwgb3V0cHV0RmlsZU5hbWUgKyBUSElOR19FWFRFTlNJT04pO1xyXG4gICAgY29uc3QgemlwRmlsZSA9IG5ldyBKU1ppcCgpO1xyXG5cclxuICAgIC8vIHNldHVwIGFuIGFycmF5IHRvIGtlZXAgdHJhY2sgb2Ygd2hhdCBzdGwncyBoYXZlIGFscmVhZHkgYmVlbiBwcm9jZXNzZWRcclxuICAgIGNvbnN0IGFscmVhZHlaaXBwZWQgPSBbXTtcclxuICAgIGNvbnN0IHppcFByb21pc2VzID0gW107XHJcblxyXG4gICAgLy8gbWV0aG9kIHRvIGFkZCB0cmFuc2Zvcm1zIGZvciBlYWNoIGluc3RhbmNlIHRvIHRoZSB0aGluZyBtYW5pZmVzdFxyXG4gICAgY29uc3QgYWRkVHJhbnNmb3JtVG9NYW5pZmVzdCA9IChpZCwgdHJhbnNmb3JtKSA9PiB7XHJcbiAgICAgICAgY29uc3QgdHJhbnNmb3JtTmFtZSA9IGB0cmFuc2Zvcm0ke2lkfWA7XHJcbiAgICAgICAgY29uc3QgbWF0cml4ID0gbW9kaWZ5VHJhbnNmb3JtRm9yTWFuaWZlc3QodHJhbnNmb3JtKTtcclxuXHJcbiAgICAgICAgbWFuaWZlc3QudHJhbnNmb3JtYXRpb25zW3RyYW5zZm9ybU5hbWVdID0geyBtYXRyaXggfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRyYW5zZm9ybU5hbWU7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGZ1bmN0aW9uIHRvIGFkZCBhIG1lc2ggZmlsZSB0byB0aGUgemlwIGZvbGRlci4gcmV0dXJucyBhIHByb21pc2UuXHJcbiAgICBjb25zdCBhZGRGaWxlVG9aaXAgPSAoZmlsZVBhdGgsIGZpbGVOYW1lKSA9PiB7XHJcbiAgICAgICAgLy8gY3JlYXRlIGEgZGVmZXJlZCBvYmplY3RcclxuICAgICAgICBjb25zdCBkID0gcS5kZWZlcigpO1xyXG5cclxuICAgICAgICAvLyBpbiB0aGUgcmVhZGZpbGUgY2FsbGJhY2sgZnVuY3Rpb24sIHVzZSB0aGUgZGVmZXJyZWQgb2JqZWN0XHJcbiAgICAgICAgZnMucmVhZEZpbGUoZmlsZVBhdGgsIChlcnIsIGRhdGEpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgZC5yZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgemlwRmlsZS5maWxlKGZpbGVOYW1lLCBkYXRhKTtcclxuICAgICAgICAgICAgZC5yZXNvbHZlKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIHJldHVybiB0aGUgZGVmZXJyZWQgb2JqZWN0J3MgcHJvbWlzZVxyXG4gICAgICAgIHJldHVybiBkLnByb21pc2U7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGZ1bmN0aW9uIHRvIGFkZCB0aGUgdGhpbmcgbWFuaWZlc3QgdG8gdGhlIHNpcCBmb2xkZXIuIHJldHVybnMgYSBwcm9taXNlLlxyXG4gICAgY29uc3QgYWRkTWFuaWZlc3QgPSAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHEuUHJvbWlzZShyZXNvbHZlID0+IHtcclxuICAgICAgICAgICAgemlwRmlsZS5maWxlKCdtYW5pZmVzdC5qc29uJywgSlNPTi5zdHJpbmdpZnkobWFuaWZlc3QsIG51bGwsIDIpKTtcclxuICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBjb21wcmVzcyB0aGUgdGhpbmcgZmlsZS4gcmV0dXJuIHByb21pc2UgdG8gY29tcHJlc3MgdGhlIHppcHBlZCBmaWxlXHJcbiAgICBjb25zdCBjb21wcmVzc1ppcEZpbGUgPSAoKSA9PiB7XHJcbiAgICAgICAgLy8gY3JlYXRlIGEgZGVmZXJlZCBvYmplY3RcclxuICAgICAgICBjb25zdCBkID0gcS5kZWZlcigpO1xyXG5cclxuICAgICAgICAvLyBvcHRpb25zIGZvciB6aXBwaW5nIHRoZSBmaWxlXHJcbiAgICAgICAgY29uc3QgemlwT3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgdHlwZTogJ25vZGVidWZmZXInLFxyXG4gICAgICAgICAgICBjb21wcmVzc2lvbjogJ0RFRkxBVEUnLFxyXG4gICAgICAgICAgICBjb21wcmVzc2lvbk9wdGlvbnM6IHsgbGV2ZWw6IDYgfSxcclxuICAgICAgICAgICAgcGxhdGZvcm06ICdVTklYJyxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvLyBnZW5lcmF0ZSB0aGUgemlwcGVkIGNvbnRlbnQgYW5kIHdyaXRlIGl0IHRvIG91ciBvdXRwdXQgZmlsZVxyXG4gICAgICAgIHppcEZpbGVcclxuICAgICAgICAgICAgLmdlbmVyYXRlTm9kZVN0cmVhbSh6aXBPcHRpb25zKVxyXG4gICAgICAgICAgICAucGlwZShmcy5jcmVhdGVXcml0ZVN0cmVhbShvdXRwdXRGaWxlUGF0aCkpXHJcbiAgICAgICAgICAgIC5vbignZmluaXNoJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZC5yZXNvbHZlKG91dHB1dEZpbGVQYXRoKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIHJldHVybiB0aGUgZGVmZmVyZWQgb2JqZWN0J3MgcHJvbWlzZVxyXG4gICAgICAgIHJldHVybiBkLnByb21pc2U7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIHRyYW5zbGF0ZSBmcm9tIGV4dHJ1ZGVyQS9CIHRvIFBsYXN0aWNBL0JcclxuICAgIGNvbnN0IHRyYW5zbGF0ZUV4dHJ1ZGVyID0gZXh0cnVkZXIgPT4ge1xyXG4gICAgICAgIHJldHVybiBjb25zdGFudHMuRXh0cnVkZXJUcmFuc2xhdGlvbltleHRydWRlcl0gPyBjb25zdGFudHMuRXh0cnVkZXJUcmFuc2xhdGlvbltleHRydWRlcl0gOiAnUGxhc3RpY0EnO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBwcm9jZXNzIGVhY2ggbW9kZWwgZmlsZVxyXG4gICAgc3RsRmlsZXMuZm9yRWFjaCgoc3RsRmlsZSwgaSkgPT4ge1xyXG4gICAgICAgIC8vIGdldCB0aGUgZmlsZXBhdGggYW5kIHRyYW5zZm9ybSBmb3IgdGhpcyBtZXNoXHJcbiAgICAgICAgY29uc3QgbWVzaEZpbGVwYXRoID0gc3RsRmlsZTtcclxuICAgICAgICBjb25zdCBtZXNoQmFzZW5hbWUgPSBwYXRoLmJhc2VuYW1lKG1lc2hGaWxlcGF0aCk7XHJcbiAgICAgICAgY29uc3QgbWVzaFRyYW5zZm9ybSA9IHRyYW5zZm9ybXNbaV07XHJcbiAgICAgICAgY29uc3QgaW5zdGFuY2VOYW1lID0gYGluc3RhbmNlJHtpfWA7XHJcbiAgICAgICAgY29uc3QgdHJhbnNmb3JtTmFtZSA9IGFkZFRyYW5zZm9ybVRvTWFuaWZlc3QoaSwgbWVzaFRyYW5zZm9ybSk7XHJcbiAgICAgICAgY29uc3QgcGxhc3RpY1NlbGVjdGlvbiA9IHRyYW5zbGF0ZUV4dHJ1ZGVyKGV4dHJ1ZGVyTGlzdFtpXSk7XHJcblxyXG4gICAgICAgIC8vIGFkZCB0aGUgaW5zdGFuY2UgdG8gdGhlIG1hbmlmZXN0IHdpdGggdGhlIGNvcnJlY3QgdmFsdWVzXHJcbiAgICAgICAgbWFuaWZlc3QuaW5zdGFuY2VzW2luc3RhbmNlTmFtZV0gPSB7XHJcbiAgICAgICAgICAgIGNvbnN0cnVjdGlvbjogcGxhc3RpY1NlbGVjdGlvbixcclxuICAgICAgICAgICAgb2JqZWN0OiBtZXNoQmFzZW5hbWUsXHJcbiAgICAgICAgICAgIHNjYWxlOiAnbW0nLFxyXG4gICAgICAgICAgICB4Zm9ybTogdHJhbnNmb3JtTmFtZSxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBpZiB0aGlzIG1lc2ggaGFzbid0IGJlZW4gYWRkZWQgdG8gdGhlIHppcCBmaWxlIHlldCwgdGhlbiBjcmVhdGUgYVxyXG4gICAgICAgICAqIHByb21pc2UgdG8gZG8gc28gYW5kIGFkZCBpdCB0byB0aGUgYXJyYXkgb2YgemlwIHByb21pc2VzLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGlmIChhbHJlYWR5WmlwcGVkLmluZGV4T2YobWVzaEJhc2VuYW1lKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgYWxyZWFkeVppcHBlZC5wdXNoKG1lc2hCYXNlbmFtZSk7XHJcbiAgICAgICAgICAgIHppcFByb21pc2VzLnB1c2goYWRkRmlsZVRvWmlwKG1lc2hGaWxlcGF0aCwgbWVzaEJhc2VuYW1lKSk7XHJcbiAgICAgICAgICAgIG1hbmlmZXN0Lm9iamVjdHNbbWVzaEJhc2VuYW1lXSA9IHt9O1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIC8vIHNldHRsZSBhbGwgdGhlIGFkZGluZyBwcm9taXNlcywgdGhlbiBhZGQgdGhlIG1ldGEgZGF0YSwgdGhlbiB6aXAgdXAgdGhlIGRvdFxyXG4gICAgLy8gdGhpbmcgZmlsZVxyXG4gICAgcmV0dXJuIHFcclxuICAgICAgICAuYWxsU2V0dGxlZCh6aXBQcm9taXNlcylcclxuICAgICAgICAudGhlbihhZGRNYW5pZmVzdClcclxuICAgICAgICAudGhlbihjb21wcmVzc1ppcEZpbGUpXHJcbiAgICAgICAgLm5vZGVpZnkoY2FsbGJhY2spO1xyXG59O1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgICBjcmVhdGVUaGluZ0ZpbGUsXHJcbn07XHJcbiJdfQ==
