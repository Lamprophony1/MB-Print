'use strict';

const React = require('react');

const _ = require('lodash');

const path = require('path');

const analyticUtils = require('eagle-print/util/analyticUtils');

const MenuItemData = require('eagle-print/views/menu/menu_item_data');

const {
  ExtruderTypeEnum
} = require('../../constants');

const util = require('../../util');

const UnsupportedExtruderConfigurationsDialog = require('./unsupportedExtruderConfigurationsDialog');

class PrintButton extends React.Component {
  constructor(props) {
    super(props);
    this._boundOnClick = this.onClick.bind(this);
    this._exportPrint = this.exportPrint.bind(this);
  }

  exportPrint() {
    const remote = require('electron').remote;

    const dialog = remote.dialog;
    const self = this;
    const filters = this.props.flux.getService('ExportService').getSupportedFormats(this.props.printer);
    const defaultPath = localStorage.getItem('lastExportDialogPath');
    const i18n = this.props.flux.getService('TranslationService');
    const spoolMaterials = this.props.flux.store('PrintSettingsStore').getState().materials.spoolMaterials;
    const attachedExtruders = this.props.printer.getAttachedExtruders();
    const hasExtruderMaterialMismatch = this.props.printer.hasExtruderMaterialMismatch();
    const {
      // extruderSetupError pretains to the extruder loadout on
      // the carriage; missing, mismatched, or unsupported
      extruderSetupError,
      perExtruderErrorType,
      supportedConfigs
    } = this.props.printer.checkForUnsupportedExtruderConfigurations() ? this.props.printer.checkForUnsupportedExtruderConfigurations() : {};

    if (extruderSetupError) {
      const props = {
        machine_name: this.props.printer.getName(),
        perExtruderErrorType,
        supportedConfigs,
        i18n
      };
      return this.showExtruderSetupErrorWarning(props);
    } else if (hasExtruderMaterialMismatch) {
      this.showExtruderMaterialMismatchWarning();
    } else if ((spoolMaterials.includes(null) || spoolMaterials.includes(undefined)) && !attachedExtruders.includes(ExtruderTypeEnum.mk14_e)) {
      this.showNonLabsMaterialWarning();
    } else {
      const fileName = dialog.showSaveDialog(remote.getCurrentWindow(), {
        title: self.props.i18n('mb:printButton.export'),
        filters: [filters],
        defaultPath
      });

      if (fileName) {
        self.props.onClick(fileName);

        if (defaultPath) {
          localStorage.setItem('lastExportDialogPath', path.dirname(fileName));
        }
      }
    }
  }

  canPrint() {
    const status = this.props.printer.getStatus();
    return status && status.state && status.state.toLowerCase() !== 'offline' && status.state.toLowerCase() !== 'unauthenticated';
  }

  openContextMenu(event) {
    event.preventDefault();
    event.stopPropagation();
    const menuItem = [new MenuItemData({
      path: 'export',
      label: 'Export',
      action: () => this.exportPrint()
    })];
    this.props.flux.getService('MenuService').renderContextMenu(menuItem, event.clientX, event.clientY);
  }

  onClick() {
    const materials = this.props.flux.store('PrintSettingsStore').getState().materials; // Gotta put this null check in for the grunt tests. Ah well.

    const spoolMaterials = materials ? materials.spoolMaterials : null;
    const attachedExtruders = this.props.printer.getAttachedExtruders();
    const ModalService = this.props.flux.getService('ModalService');

    if ((spoolMaterials.includes(null) || spoolMaterials.includes(undefined)) && !attachedExtruders.includes(ExtruderTypeEnum.mk14_e)) {
      this.showNonLabsMaterialWarning();
    } else {
      this.handlePrintButtonClick();
    }
  }

  handlePrintButtonClick() {
    const printer = this.props.printer;
    const trackingService = this.props.flux.getService('TrackingService');
    const i18n = this.props.flux.getService('TranslationService');

    if (this.canPrint()) {
      const trackingInfo = util.trackingInfoForPrinter(printer);
      trackingInfo.extruder_type = printer.getCurrentExtruderType();
      const printSettings = analyticUtils.getPrintSettingsForAnalyticEvents(this.props.flux, printer);
      trackingService.addEvent(_.merge({
        name: 'Print Started'
      }, trackingInfo, printSettings));
      const {
        // extruderSetupError pretains to the extruder loadout on
        // the carriage; missing, mismatched, or unsupported
        extruderSetupError,
        perExtruderErrorType,
        supportedConfigs
      } = printer.checkForUnsupportedExtruderConfigurations() ? printer.checkForUnsupportedExtruderConfigurations() : {};
      const hasExtruderMaterialMismatch = printer.hasExtruderMaterialMismatch();

      if (extruderSetupError) {
        const props = {
          machine_name: printer.getName(),
          perExtruderErrorType,
          supportedConfigs,
          i18n
        };
        return this.showExtruderSetupErrorWarning(props);
      }

      if (hasExtruderMaterialMismatch) {
        return this.showExtruderMaterialMismatchWarning();
      }

      return this.props.onClick(undefined, true);
    } else {
      return this.exportPrint();
    }
  }

  showExtruderMaterialMismatchWarning() {
    const modalService = this.props.flux.getService('ModalService');
    return modalService.confirm({
      title: this.props.i18n('mb:extruderMaterialErrorModal.title'),
      body: this.props.i18n('mb:extruderMaterialErrorModal.body'),
      confirmText: this.props.i18n('mb:extruderMaterialErrorModal.confirmText'),
      modalClass: 'w400 warningModal',
      hideClose: true,
      backdrop: 'static',
      keyboard: false,
      onConfirm: () => {}
    });
  }

  showExtruderSetupErrorWarning(payload) {
    const modalService = this.props.flux.getService('ModalService');
    return modalService.show( /*#__PURE__*/React.createElement(UnsupportedExtruderConfigurationsDialog, payload), {
      title: this.props.i18n('mb:unsupported_extruder_configurations.title_modal', {
        machine_name: payload.machine_name
      }),
      backdrop: 'static',
      modalClass: 'w400 warningModal'
    });
  }

  showNonLabsMaterialWarning() {
    const modalService = this.props.flux.getService('ModalService');
    return modalService.confirm({
      title: this.props.i18n('mb:unknownMaterialWarningModal.title'),
      body: this.props.i18n('mb:unknownMaterialWarningModal.text'),
      confirmText: this.props.i18n('mb:unknownMaterialWarningModal.acknowledge'),
      modalClass: 'w400 warningModal',
      hideClose: true,
      backdrop: 'static',
      keyboard: false,
      onConfirm: () => {}
    });
  }

  getPrintLabel() {
    return this.canPrint() ? this.props.i18n('printer_list.print') : this.props.i18n('mb:printButton.export');
  }

  getDropdown(disabled) {
    return this.canPrint() ? /*#__PURE__*/React.createElement("div", {
      id: "dropdown",
      className: `printButtonDropdown${disabled ? ' disabled' : ''}`,
      onClick: disabled ? undefined : event => this.openContextMenu(event)
    }, /*#__PURE__*/React.createElement("div", {
      className: "printButtonDropdownLabel"
    }, "...")) : null;
  }

  render() {
    const state = this.props.printer.getStatus().state.toLowerCase();
    const busy = state !== 'idle';
    const validationStore = this.props.flux.store('ValidationStore');
    const trayInvalid = validationStore.getTrayBodiesOutsideBuildEnvelope().size > 0 || validationStore.getRaftsOutsideBuildEnvelope().length > 0 || validationStore.isPurgeTowerOutOfBounds();
    const disabled = trayInvalid || this.props.disabled || busy && state !== 'offline';
    const classes = this.props.printerPopupClasses + (disabled ? ' disabled' : '');
    return /*#__PURE__*/React.createElement("div", {
      className: "printButtonContainer"
    }, /*#__PURE__*/React.createElement("div", {
      id: this.canPrint() ? 'printButton' : 'exportButton',
      className: classes,
      onClick: disabled ? undefined : this._boundOnClick
    }, /*#__PURE__*/React.createElement("div", {
      className: "printButtonLabel"
    }, this.getPrintLabel())), this.getDropdown(disabled));
  }

}

PrintButton.displayName = 'PrintButton';
PrintButton.propTypes = {
  i18n: React.PropTypes.func.isRequired,
  flux: React.PropTypes.object.isRequired,
  onClick: React.PropTypes.func.isRequired,
  printer: React.PropTypes.object.isRequired,
  printerPopupClasses: React.PropTypes.string,
  disabled: React.PropTypes.bool
};
module.exports = PrintButton;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByaW50QnV0dG9uLmpzIl0sIm5hbWVzIjpbIlJlYWN0IiwicmVxdWlyZSIsIl8iLCJwYXRoIiwiYW5hbHl0aWNVdGlscyIsIk1lbnVJdGVtRGF0YSIsIkV4dHJ1ZGVyVHlwZUVudW0iLCJ1dGlsIiwiVW5zdXBwb3J0ZWRFeHRydWRlckNvbmZpZ3VyYXRpb25zRGlhbG9nIiwiUHJpbnRCdXR0b24iLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiX2JvdW5kT25DbGljayIsIm9uQ2xpY2siLCJiaW5kIiwiX2V4cG9ydFByaW50IiwiZXhwb3J0UHJpbnQiLCJyZW1vdGUiLCJkaWFsb2ciLCJzZWxmIiwiZmlsdGVycyIsImZsdXgiLCJnZXRTZXJ2aWNlIiwiZ2V0U3VwcG9ydGVkRm9ybWF0cyIsInByaW50ZXIiLCJkZWZhdWx0UGF0aCIsImxvY2FsU3RvcmFnZSIsImdldEl0ZW0iLCJpMThuIiwic3Bvb2xNYXRlcmlhbHMiLCJzdG9yZSIsImdldFN0YXRlIiwibWF0ZXJpYWxzIiwiYXR0YWNoZWRFeHRydWRlcnMiLCJnZXRBdHRhY2hlZEV4dHJ1ZGVycyIsImhhc0V4dHJ1ZGVyTWF0ZXJpYWxNaXNtYXRjaCIsImV4dHJ1ZGVyU2V0dXBFcnJvciIsInBlckV4dHJ1ZGVyRXJyb3JUeXBlIiwic3VwcG9ydGVkQ29uZmlncyIsImNoZWNrRm9yVW5zdXBwb3J0ZWRFeHRydWRlckNvbmZpZ3VyYXRpb25zIiwibWFjaGluZV9uYW1lIiwiZ2V0TmFtZSIsInNob3dFeHRydWRlclNldHVwRXJyb3JXYXJuaW5nIiwic2hvd0V4dHJ1ZGVyTWF0ZXJpYWxNaXNtYXRjaFdhcm5pbmciLCJpbmNsdWRlcyIsInVuZGVmaW5lZCIsIm1rMTRfZSIsInNob3dOb25MYWJzTWF0ZXJpYWxXYXJuaW5nIiwiZmlsZU5hbWUiLCJzaG93U2F2ZURpYWxvZyIsImdldEN1cnJlbnRXaW5kb3ciLCJ0aXRsZSIsInNldEl0ZW0iLCJkaXJuYW1lIiwiY2FuUHJpbnQiLCJzdGF0dXMiLCJnZXRTdGF0dXMiLCJzdGF0ZSIsInRvTG93ZXJDYXNlIiwib3BlbkNvbnRleHRNZW51IiwiZXZlbnQiLCJwcmV2ZW50RGVmYXVsdCIsInN0b3BQcm9wYWdhdGlvbiIsIm1lbnVJdGVtIiwibGFiZWwiLCJhY3Rpb24iLCJyZW5kZXJDb250ZXh0TWVudSIsImNsaWVudFgiLCJjbGllbnRZIiwiTW9kYWxTZXJ2aWNlIiwiaGFuZGxlUHJpbnRCdXR0b25DbGljayIsInRyYWNraW5nU2VydmljZSIsInRyYWNraW5nSW5mbyIsInRyYWNraW5nSW5mb0ZvclByaW50ZXIiLCJleHRydWRlcl90eXBlIiwiZ2V0Q3VycmVudEV4dHJ1ZGVyVHlwZSIsInByaW50U2V0dGluZ3MiLCJnZXRQcmludFNldHRpbmdzRm9yQW5hbHl0aWNFdmVudHMiLCJhZGRFdmVudCIsIm1lcmdlIiwibmFtZSIsIm1vZGFsU2VydmljZSIsImNvbmZpcm0iLCJib2R5IiwiY29uZmlybVRleHQiLCJtb2RhbENsYXNzIiwiaGlkZUNsb3NlIiwiYmFja2Ryb3AiLCJrZXlib2FyZCIsIm9uQ29uZmlybSIsInBheWxvYWQiLCJzaG93IiwiZ2V0UHJpbnRMYWJlbCIsImdldERyb3Bkb3duIiwiZGlzYWJsZWQiLCJyZW5kZXIiLCJidXN5IiwidmFsaWRhdGlvblN0b3JlIiwidHJheUludmFsaWQiLCJnZXRUcmF5Qm9kaWVzT3V0c2lkZUJ1aWxkRW52ZWxvcGUiLCJzaXplIiwiZ2V0UmFmdHNPdXRzaWRlQnVpbGRFbnZlbG9wZSIsImxlbmd0aCIsImlzUHVyZ2VUb3dlck91dE9mQm91bmRzIiwiY2xhc3NlcyIsInByaW50ZXJQb3B1cENsYXNzZXMiLCJkaXNwbGF5TmFtZSIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsImZ1bmMiLCJpc1JlcXVpcmVkIiwib2JqZWN0Iiwic3RyaW5nIiwiYm9vbCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsTUFBTUMsQ0FBQyxHQUFHRCxPQUFPLENBQUMsUUFBRCxDQUFqQjs7QUFDQSxNQUFNRSxJQUFJLEdBQUdGLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1HLGFBQWEsR0FBR0gsT0FBTyxDQUFDLGdDQUFELENBQTdCOztBQUNBLE1BQU1JLFlBQVksR0FBR0osT0FBTyxDQUFDLHVDQUFELENBQTVCOztBQUVBLE1BQU07QUFBRUssRUFBQUE7QUFBRixJQUF1QkwsT0FBTyxDQUFDLGlCQUFELENBQXBDOztBQUNBLE1BQU1NLElBQUksR0FBR04sT0FBTyxDQUFDLFlBQUQsQ0FBcEI7O0FBQ0EsTUFBTU8sdUNBQXVDLEdBQUdQLE9BQU8sQ0FBQywyQ0FBRCxDQUF2RDs7QUFFQSxNQUFNUSxXQUFOLFNBQTBCVCxLQUFLLENBQUNVLFNBQWhDLENBQTBDO0FBQ3RDQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBUTtBQUNmLFVBQU1BLEtBQU47QUFDQSxTQUFLQyxhQUFMLEdBQXFCLEtBQUtDLE9BQUwsQ0FBYUMsSUFBYixDQUFrQixJQUFsQixDQUFyQjtBQUNBLFNBQUtDLFlBQUwsR0FBb0IsS0FBS0MsV0FBTCxDQUFpQkYsSUFBakIsQ0FBc0IsSUFBdEIsQ0FBcEI7QUFDSDs7QUFFREUsRUFBQUEsV0FBVyxHQUFHO0FBQ1YsVUFBTUMsTUFBTSxHQUFHakIsT0FBTyxDQUFDLFVBQUQsQ0FBUCxDQUFvQmlCLE1BQW5DOztBQUNBLFVBQU1DLE1BQU0sR0FBR0QsTUFBTSxDQUFDQyxNQUF0QjtBQUNBLFVBQU1DLElBQUksR0FBRyxJQUFiO0FBQ0EsVUFBTUMsT0FBTyxHQUFHLEtBQUtULEtBQUwsQ0FBV1UsSUFBWCxDQUFnQkMsVUFBaEIsQ0FBMkIsZUFBM0IsRUFBNENDLG1CQUE1QyxDQUFnRSxLQUFLWixLQUFMLENBQVdhLE9BQTNFLENBQWhCO0FBQ0EsVUFBTUMsV0FBVyxHQUFHQyxZQUFZLENBQUNDLE9BQWIsQ0FBcUIsc0JBQXJCLENBQXBCO0FBQ0EsVUFBTUMsSUFBSSxHQUFHLEtBQUtqQixLQUFMLENBQVdVLElBQVgsQ0FBZ0JDLFVBQWhCLENBQTJCLG9CQUEzQixDQUFiO0FBQ0EsVUFBTU8sY0FBYyxHQUFHLEtBQUtsQixLQUFMLENBQVdVLElBQVgsQ0FBZ0JTLEtBQWhCLENBQXNCLG9CQUF0QixFQUE0Q0MsUUFBNUMsR0FBdURDLFNBQXZELENBQWlFSCxjQUF4RjtBQUNBLFVBQU1JLGlCQUFpQixHQUFHLEtBQUt0QixLQUFMLENBQVdhLE9BQVgsQ0FBbUJVLG9CQUFuQixFQUExQjtBQUVBLFVBQU1DLDJCQUEyQixHQUFHLEtBQUt4QixLQUFMLENBQVdhLE9BQVgsQ0FBbUJXLDJCQUFuQixFQUFwQztBQUNBLFVBQU07QUFDRjtBQUNBO0FBQ0FDLE1BQUFBLGtCQUhFO0FBSUZDLE1BQUFBLG9CQUpFO0FBS0ZDLE1BQUFBO0FBTEUsUUFNRixLQUFLM0IsS0FBTCxDQUFXYSxPQUFYLENBQW1CZSx5Q0FBbkIsS0FDRSxLQUFLNUIsS0FBTCxDQUFXYSxPQUFYLENBQW1CZSx5Q0FBbkIsRUFERixHQUVFLEVBUk47O0FBVUEsUUFBSUgsa0JBQUosRUFBd0I7QUFDcEIsWUFBTXpCLEtBQUssR0FBRztBQUNWNkIsUUFBQUEsWUFBWSxFQUFFLEtBQUs3QixLQUFMLENBQVdhLE9BQVgsQ0FBbUJpQixPQUFuQixFQURKO0FBRVZKLFFBQUFBLG9CQUZVO0FBR1ZDLFFBQUFBLGdCQUhVO0FBSVZWLFFBQUFBO0FBSlUsT0FBZDtBQU1BLGFBQU8sS0FBS2MsNkJBQUwsQ0FBbUMvQixLQUFuQyxDQUFQO0FBQ0gsS0FSRCxNQVFPLElBQUl3QiwyQkFBSixFQUFpQztBQUNwQyxXQUFLUSxtQ0FBTDtBQUNILEtBRk0sTUFFQSxJQUNILENBQUNkLGNBQWMsQ0FBQ2UsUUFBZixDQUF3QixJQUF4QixLQUFpQ2YsY0FBYyxDQUFDZSxRQUFmLENBQXdCQyxTQUF4QixDQUFsQyxLQUNBLENBQUNaLGlCQUFpQixDQUFDVyxRQUFsQixDQUEyQnZDLGdCQUFnQixDQUFDeUMsTUFBNUMsQ0FGRSxFQUdMO0FBQ0UsV0FBS0MsMEJBQUw7QUFDSCxLQUxNLE1BS0E7QUFDSCxZQUFNQyxRQUFRLEdBQUc5QixNQUFNLENBQUMrQixjQUFQLENBQXNCaEMsTUFBTSxDQUFDaUMsZ0JBQVAsRUFBdEIsRUFBaUQ7QUFDOURDLFFBQUFBLEtBQUssRUFBRWhDLElBQUksQ0FBQ1IsS0FBTCxDQUFXaUIsSUFBWCxDQUFnQix1QkFBaEIsQ0FEdUQ7QUFFOURSLFFBQUFBLE9BQU8sRUFBRSxDQUFDQSxPQUFELENBRnFEO0FBRzlESyxRQUFBQTtBQUg4RCxPQUFqRCxDQUFqQjs7QUFNQSxVQUFJdUIsUUFBSixFQUFjO0FBQ1Y3QixRQUFBQSxJQUFJLENBQUNSLEtBQUwsQ0FBV0UsT0FBWCxDQUFtQm1DLFFBQW5COztBQUNBLFlBQUl2QixXQUFKLEVBQWlCO0FBQ2JDLFVBQUFBLFlBQVksQ0FBQzBCLE9BQWIsQ0FBcUIsc0JBQXJCLEVBQTZDbEQsSUFBSSxDQUFDbUQsT0FBTCxDQUFhTCxRQUFiLENBQTdDO0FBQ0g7QUFDSjtBQUNKO0FBQ0o7O0FBRURNLEVBQUFBLFFBQVEsR0FBRztBQUNQLFVBQU1DLE1BQU0sR0FBRyxLQUFLNUMsS0FBTCxDQUFXYSxPQUFYLENBQW1CZ0MsU0FBbkIsRUFBZjtBQUNBLFdBQ0lELE1BQU0sSUFDTkEsTUFBTSxDQUFDRSxLQURQLElBRUFGLE1BQU0sQ0FBQ0UsS0FBUCxDQUFhQyxXQUFiLE9BQStCLFNBRi9CLElBR0FILE1BQU0sQ0FBQ0UsS0FBUCxDQUFhQyxXQUFiLE9BQStCLGlCQUpuQztBQU1IOztBQUVEQyxFQUFBQSxlQUFlLENBQUNDLEtBQUQsRUFBUTtBQUNuQkEsSUFBQUEsS0FBSyxDQUFDQyxjQUFOO0FBQ0FELElBQUFBLEtBQUssQ0FBQ0UsZUFBTjtBQUNBLFVBQU1DLFFBQVEsR0FBRyxDQUNiLElBQUkzRCxZQUFKLENBQWlCO0FBQ2JGLE1BQUFBLElBQUksRUFBRSxRQURPO0FBRWI4RCxNQUFBQSxLQUFLLEVBQUUsUUFGTTtBQUdiQyxNQUFBQSxNQUFNLEVBQUUsTUFBTSxLQUFLakQsV0FBTDtBQUhELEtBQWpCLENBRGEsQ0FBakI7QUFPQSxTQUFLTCxLQUFMLENBQVdVLElBQVgsQ0FBZ0JDLFVBQWhCLENBQTJCLGFBQTNCLEVBQTBDNEMsaUJBQTFDLENBQTRESCxRQUE1RCxFQUFzRUgsS0FBSyxDQUFDTyxPQUE1RSxFQUFxRlAsS0FBSyxDQUFDUSxPQUEzRjtBQUNIOztBQUVEdkQsRUFBQUEsT0FBTyxHQUFHO0FBQ04sVUFBTW1CLFNBQVMsR0FBRyxLQUFLckIsS0FBTCxDQUFXVSxJQUFYLENBQWdCUyxLQUFoQixDQUFzQixvQkFBdEIsRUFBNENDLFFBQTVDLEdBQXVEQyxTQUF6RSxDQURNLENBRU47O0FBQ0EsVUFBTUgsY0FBYyxHQUFHRyxTQUFTLEdBQUdBLFNBQVMsQ0FBQ0gsY0FBYixHQUE4QixJQUE5RDtBQUNBLFVBQU1JLGlCQUFpQixHQUFHLEtBQUt0QixLQUFMLENBQVdhLE9BQVgsQ0FBbUJVLG9CQUFuQixFQUExQjtBQUNBLFVBQU1tQyxZQUFZLEdBQUcsS0FBSzFELEtBQUwsQ0FBV1UsSUFBWCxDQUFnQkMsVUFBaEIsQ0FBMkIsY0FBM0IsQ0FBckI7O0FBQ0EsUUFDSSxDQUFDTyxjQUFjLENBQUNlLFFBQWYsQ0FBd0IsSUFBeEIsS0FBaUNmLGNBQWMsQ0FBQ2UsUUFBZixDQUF3QkMsU0FBeEIsQ0FBbEMsS0FDQSxDQUFDWixpQkFBaUIsQ0FBQ1csUUFBbEIsQ0FBMkJ2QyxnQkFBZ0IsQ0FBQ3lDLE1BQTVDLENBRkwsRUFHRTtBQUNFLFdBQUtDLDBCQUFMO0FBQ0gsS0FMRCxNQUtPO0FBQ0gsV0FBS3VCLHNCQUFMO0FBQ0g7QUFDSjs7QUFFREEsRUFBQUEsc0JBQXNCLEdBQUc7QUFDckIsVUFBTTlDLE9BQU8sR0FBRyxLQUFLYixLQUFMLENBQVdhLE9BQTNCO0FBQ0EsVUFBTStDLGVBQWUsR0FBRyxLQUFLNUQsS0FBTCxDQUFXVSxJQUFYLENBQWdCQyxVQUFoQixDQUEyQixpQkFBM0IsQ0FBeEI7QUFDQSxVQUFNTSxJQUFJLEdBQUcsS0FBS2pCLEtBQUwsQ0FBV1UsSUFBWCxDQUFnQkMsVUFBaEIsQ0FBMkIsb0JBQTNCLENBQWI7O0FBRUEsUUFBSSxLQUFLZ0MsUUFBTCxFQUFKLEVBQXFCO0FBQ2pCLFlBQU1rQixZQUFZLEdBQUdsRSxJQUFJLENBQUNtRSxzQkFBTCxDQUE0QmpELE9BQTVCLENBQXJCO0FBQ0FnRCxNQUFBQSxZQUFZLENBQUNFLGFBQWIsR0FBNkJsRCxPQUFPLENBQUNtRCxzQkFBUixFQUE3QjtBQUNBLFlBQU1DLGFBQWEsR0FBR3pFLGFBQWEsQ0FBQzBFLGlDQUFkLENBQWdELEtBQUtsRSxLQUFMLENBQVdVLElBQTNELEVBQWlFRyxPQUFqRSxDQUF0QjtBQUNBK0MsTUFBQUEsZUFBZSxDQUFDTyxRQUFoQixDQUF5QjdFLENBQUMsQ0FBQzhFLEtBQUYsQ0FBUTtBQUFFQyxRQUFBQSxJQUFJLEVBQUU7QUFBUixPQUFSLEVBQW1DUixZQUFuQyxFQUFpREksYUFBakQsQ0FBekI7QUFFQSxZQUFNO0FBQ0Y7QUFDQTtBQUNBeEMsUUFBQUEsa0JBSEU7QUFJRkMsUUFBQUEsb0JBSkU7QUFLRkMsUUFBQUE7QUFMRSxVQU1GZCxPQUFPLENBQUNlLHlDQUFSLEtBQ0VmLE9BQU8sQ0FBQ2UseUNBQVIsRUFERixHQUVFLEVBUk47QUFTQSxZQUFNSiwyQkFBMkIsR0FBR1gsT0FBTyxDQUFDVywyQkFBUixFQUFwQzs7QUFFQSxVQUFJQyxrQkFBSixFQUF3QjtBQUNwQixjQUFNekIsS0FBSyxHQUFHO0FBQ1Y2QixVQUFBQSxZQUFZLEVBQUVoQixPQUFPLENBQUNpQixPQUFSLEVBREo7QUFFVkosVUFBQUEsb0JBRlU7QUFHVkMsVUFBQUEsZ0JBSFU7QUFJVlYsVUFBQUE7QUFKVSxTQUFkO0FBT0EsZUFBTyxLQUFLYyw2QkFBTCxDQUFtQy9CLEtBQW5DLENBQVA7QUFDSDs7QUFDRCxVQUFJd0IsMkJBQUosRUFBaUM7QUFDN0IsZUFBTyxLQUFLUSxtQ0FBTCxFQUFQO0FBQ0g7O0FBQ0QsYUFBTyxLQUFLaEMsS0FBTCxDQUFXRSxPQUFYLENBQW1CZ0MsU0FBbkIsRUFBOEIsSUFBOUIsQ0FBUDtBQUNILEtBL0JELE1BK0JPO0FBQ0gsYUFBTyxLQUFLN0IsV0FBTCxFQUFQO0FBQ0g7QUFDSjs7QUFFRDJCLEVBQUFBLG1DQUFtQyxHQUFHO0FBQ2xDLFVBQU1zQyxZQUFZLEdBQUcsS0FBS3RFLEtBQUwsQ0FBV1UsSUFBWCxDQUFnQkMsVUFBaEIsQ0FBMkIsY0FBM0IsQ0FBckI7QUFDQSxXQUFPMkQsWUFBWSxDQUFDQyxPQUFiLENBQXFCO0FBQ3hCL0IsTUFBQUEsS0FBSyxFQUFFLEtBQUt4QyxLQUFMLENBQVdpQixJQUFYLENBQWdCLHFDQUFoQixDQURpQjtBQUV4QnVELE1BQUFBLElBQUksRUFBRSxLQUFLeEUsS0FBTCxDQUFXaUIsSUFBWCxDQUFnQixvQ0FBaEIsQ0FGa0I7QUFHeEJ3RCxNQUFBQSxXQUFXLEVBQUUsS0FBS3pFLEtBQUwsQ0FBV2lCLElBQVgsQ0FBZ0IsMkNBQWhCLENBSFc7QUFJeEJ5RCxNQUFBQSxVQUFVLEVBQUUsbUJBSlk7QUFLeEJDLE1BQUFBLFNBQVMsRUFBRSxJQUxhO0FBTXhCQyxNQUFBQSxRQUFRLEVBQUUsUUFOYztBQU94QkMsTUFBQUEsUUFBUSxFQUFFLEtBUGM7QUFReEJDLE1BQUFBLFNBQVMsRUFBRSxNQUFNLENBQUU7QUFSSyxLQUFyQixDQUFQO0FBVUg7O0FBRUQvQyxFQUFBQSw2QkFBNkIsQ0FBQ2dELE9BQUQsRUFBVTtBQUNuQyxVQUFNVCxZQUFZLEdBQUcsS0FBS3RFLEtBQUwsQ0FBV1UsSUFBWCxDQUFnQkMsVUFBaEIsQ0FBMkIsY0FBM0IsQ0FBckI7QUFFQSxXQUFPMkQsWUFBWSxDQUFDVSxJQUFiLGVBQWtCLG9CQUFDLHVDQUFELEVBQTZDRCxPQUE3QyxDQUFsQixFQUE0RTtBQUMvRXZDLE1BQUFBLEtBQUssRUFBRSxLQUFLeEMsS0FBTCxDQUFXaUIsSUFBWCxDQUFnQixvREFBaEIsRUFBc0U7QUFDekVZLFFBQUFBLFlBQVksRUFBRWtELE9BQU8sQ0FBQ2xEO0FBRG1ELE9BQXRFLENBRHdFO0FBSS9FK0MsTUFBQUEsUUFBUSxFQUFFLFFBSnFFO0FBSy9FRixNQUFBQSxVQUFVLEVBQUU7QUFMbUUsS0FBNUUsQ0FBUDtBQU9IOztBQUVEdEMsRUFBQUEsMEJBQTBCLEdBQUc7QUFDekIsVUFBTWtDLFlBQVksR0FBRyxLQUFLdEUsS0FBTCxDQUFXVSxJQUFYLENBQWdCQyxVQUFoQixDQUEyQixjQUEzQixDQUFyQjtBQUNBLFdBQU8yRCxZQUFZLENBQUNDLE9BQWIsQ0FBcUI7QUFDeEIvQixNQUFBQSxLQUFLLEVBQUUsS0FBS3hDLEtBQUwsQ0FBV2lCLElBQVgsQ0FBZ0Isc0NBQWhCLENBRGlCO0FBRXhCdUQsTUFBQUEsSUFBSSxFQUFFLEtBQUt4RSxLQUFMLENBQVdpQixJQUFYLENBQWdCLHFDQUFoQixDQUZrQjtBQUd4QndELE1BQUFBLFdBQVcsRUFBRSxLQUFLekUsS0FBTCxDQUFXaUIsSUFBWCxDQUFnQiw0Q0FBaEIsQ0FIVztBQUl4QnlELE1BQUFBLFVBQVUsRUFBRSxtQkFKWTtBQUt4QkMsTUFBQUEsU0FBUyxFQUFFLElBTGE7QUFNeEJDLE1BQUFBLFFBQVEsRUFBRSxRQU5jO0FBT3hCQyxNQUFBQSxRQUFRLEVBQUUsS0FQYztBQVF4QkMsTUFBQUEsU0FBUyxFQUFFLE1BQU0sQ0FBRTtBQVJLLEtBQXJCLENBQVA7QUFVSDs7QUFFREcsRUFBQUEsYUFBYSxHQUFHO0FBQ1osV0FBTyxLQUFLdEMsUUFBTCxLQUFrQixLQUFLM0MsS0FBTCxDQUFXaUIsSUFBWCxDQUFnQixvQkFBaEIsQ0FBbEIsR0FBMEQsS0FBS2pCLEtBQUwsQ0FBV2lCLElBQVgsQ0FBZ0IsdUJBQWhCLENBQWpFO0FBQ0g7O0FBRURpRSxFQUFBQSxXQUFXLENBQUNDLFFBQUQsRUFBVztBQUNsQixXQUFPLEtBQUt4QyxRQUFMLGtCQUNIO0FBQ0ksTUFBQSxFQUFFLEVBQUMsVUFEUDtBQUVJLE1BQUEsU0FBUyxFQUFHLHNCQUFxQndDLFFBQVEsR0FBRyxXQUFILEdBQWlCLEVBQUcsRUFGakU7QUFHSSxNQUFBLE9BQU8sRUFBRUEsUUFBUSxHQUFHakQsU0FBSCxHQUFlZSxLQUFLLElBQUksS0FBS0QsZUFBTCxDQUFxQkMsS0FBckI7QUFIN0Msb0JBS0k7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLGFBTEosQ0FERyxHQVFILElBUko7QUFTSDs7QUFFRG1DLEVBQUFBLE1BQU0sR0FBRztBQUNMLFVBQU10QyxLQUFLLEdBQUcsS0FBSzlDLEtBQUwsQ0FBV2EsT0FBWCxDQUFtQmdDLFNBQW5CLEdBQStCQyxLQUEvQixDQUFxQ0MsV0FBckMsRUFBZDtBQUNBLFVBQU1zQyxJQUFJLEdBQUd2QyxLQUFLLEtBQUssTUFBdkI7QUFDQSxVQUFNd0MsZUFBZSxHQUFHLEtBQUt0RixLQUFMLENBQVdVLElBQVgsQ0FBZ0JTLEtBQWhCLENBQXNCLGlCQUF0QixDQUF4QjtBQUNBLFVBQU1vRSxXQUFXLEdBQ2JELGVBQWUsQ0FBQ0UsaUNBQWhCLEdBQW9EQyxJQUFwRCxHQUEyRCxDQUEzRCxJQUNBSCxlQUFlLENBQUNJLDRCQUFoQixHQUErQ0MsTUFBL0MsR0FBd0QsQ0FEeEQsSUFFQUwsZUFBZSxDQUFDTSx1QkFBaEIsRUFISjtBQUlBLFVBQU1ULFFBQVEsR0FBR0ksV0FBVyxJQUFJLEtBQUt2RixLQUFMLENBQVdtRixRQUExQixJQUF1Q0UsSUFBSSxJQUFJdkMsS0FBSyxLQUFLLFNBQTFFO0FBQ0EsVUFBTStDLE9BQU8sR0FBRyxLQUFLN0YsS0FBTCxDQUFXOEYsbUJBQVgsSUFBa0NYLFFBQVEsR0FBRyxXQUFILEdBQWlCLEVBQTNELENBQWhCO0FBRUEsd0JBQ0k7QUFBSyxNQUFBLFNBQVMsRUFBQztBQUFmLG9CQUNJO0FBQ0ksTUFBQSxFQUFFLEVBQUUsS0FBS3hDLFFBQUwsS0FBa0IsYUFBbEIsR0FBa0MsY0FEMUM7QUFFSSxNQUFBLFNBQVMsRUFBRWtELE9BRmY7QUFHSSxNQUFBLE9BQU8sRUFBRVYsUUFBUSxHQUFHakQsU0FBSCxHQUFlLEtBQUtqQztBQUh6QyxvQkFLSTtBQUFLLE1BQUEsU0FBUyxFQUFDO0FBQWYsT0FBbUMsS0FBS2dGLGFBQUwsRUFBbkMsQ0FMSixDQURKLEVBUUssS0FBS0MsV0FBTCxDQUFpQkMsUUFBakIsQ0FSTCxDQURKO0FBWUg7O0FBMU5xQzs7QUE2TjFDdEYsV0FBVyxDQUFDa0csV0FBWixHQUEwQixhQUExQjtBQUNBbEcsV0FBVyxDQUFDbUcsU0FBWixHQUF3QjtBQUNwQi9FLEVBQUFBLElBQUksRUFBRTdCLEtBQUssQ0FBQzZHLFNBQU4sQ0FBZ0JDLElBQWhCLENBQXFCQyxVQURQO0FBRXBCekYsRUFBQUEsSUFBSSxFQUFFdEIsS0FBSyxDQUFDNkcsU0FBTixDQUFnQkcsTUFBaEIsQ0FBdUJELFVBRlQ7QUFHcEJqRyxFQUFBQSxPQUFPLEVBQUVkLEtBQUssQ0FBQzZHLFNBQU4sQ0FBZ0JDLElBQWhCLENBQXFCQyxVQUhWO0FBSXBCdEYsRUFBQUEsT0FBTyxFQUFFekIsS0FBSyxDQUFDNkcsU0FBTixDQUFnQkcsTUFBaEIsQ0FBdUJELFVBSlo7QUFLcEJMLEVBQUFBLG1CQUFtQixFQUFFMUcsS0FBSyxDQUFDNkcsU0FBTixDQUFnQkksTUFMakI7QUFNcEJsQixFQUFBQSxRQUFRLEVBQUUvRixLQUFLLENBQUM2RyxTQUFOLENBQWdCSztBQU5OLENBQXhCO0FBU0FDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjNHLFdBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgUmVhY3QgPSByZXF1aXJlKCdyZWFjdCcpO1xyXG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbmNvbnN0IGFuYWx5dGljVXRpbHMgPSByZXF1aXJlKCdlYWdsZS1wcmludC91dGlsL2FuYWx5dGljVXRpbHMnKTtcclxuY29uc3QgTWVudUl0ZW1EYXRhID0gcmVxdWlyZSgnZWFnbGUtcHJpbnQvdmlld3MvbWVudS9tZW51X2l0ZW1fZGF0YScpO1xyXG5cclxuY29uc3QgeyBFeHRydWRlclR5cGVFbnVtIH0gPSByZXF1aXJlKCcuLi8uLi9jb25zdGFudHMnKTtcclxuY29uc3QgdXRpbCA9IHJlcXVpcmUoJy4uLy4uL3V0aWwnKTtcclxuY29uc3QgVW5zdXBwb3J0ZWRFeHRydWRlckNvbmZpZ3VyYXRpb25zRGlhbG9nID0gcmVxdWlyZSgnLi91bnN1cHBvcnRlZEV4dHJ1ZGVyQ29uZmlndXJhdGlvbnNEaWFsb2cnKTtcclxuXHJcbmNsYXNzIFByaW50QnV0dG9uIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcclxuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XHJcbiAgICAgICAgc3VwZXIocHJvcHMpO1xyXG4gICAgICAgIHRoaXMuX2JvdW5kT25DbGljayA9IHRoaXMub25DbGljay5iaW5kKHRoaXMpO1xyXG4gICAgICAgIHRoaXMuX2V4cG9ydFByaW50ID0gdGhpcy5leHBvcnRQcmludC5iaW5kKHRoaXMpO1xyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydFByaW50KCkge1xyXG4gICAgICAgIGNvbnN0IHJlbW90ZSA9IHJlcXVpcmUoJ2VsZWN0cm9uJykucmVtb3RlO1xyXG4gICAgICAgIGNvbnN0IGRpYWxvZyA9IHJlbW90ZS5kaWFsb2c7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgY29uc3QgZmlsdGVycyA9IHRoaXMucHJvcHMuZmx1eC5nZXRTZXJ2aWNlKCdFeHBvcnRTZXJ2aWNlJykuZ2V0U3VwcG9ydGVkRm9ybWF0cyh0aGlzLnByb3BzLnByaW50ZXIpO1xyXG4gICAgICAgIGNvbnN0IGRlZmF1bHRQYXRoID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2xhc3RFeHBvcnREaWFsb2dQYXRoJyk7XHJcbiAgICAgICAgY29uc3QgaTE4biA9IHRoaXMucHJvcHMuZmx1eC5nZXRTZXJ2aWNlKCdUcmFuc2xhdGlvblNlcnZpY2UnKTtcclxuICAgICAgICBjb25zdCBzcG9vbE1hdGVyaWFscyA9IHRoaXMucHJvcHMuZmx1eC5zdG9yZSgnUHJpbnRTZXR0aW5nc1N0b3JlJykuZ2V0U3RhdGUoKS5tYXRlcmlhbHMuc3Bvb2xNYXRlcmlhbHM7XHJcbiAgICAgICAgY29uc3QgYXR0YWNoZWRFeHRydWRlcnMgPSB0aGlzLnByb3BzLnByaW50ZXIuZ2V0QXR0YWNoZWRFeHRydWRlcnMoKTtcclxuXHJcbiAgICAgICAgY29uc3QgaGFzRXh0cnVkZXJNYXRlcmlhbE1pc21hdGNoID0gdGhpcy5wcm9wcy5wcmludGVyLmhhc0V4dHJ1ZGVyTWF0ZXJpYWxNaXNtYXRjaCgpO1xyXG4gICAgICAgIGNvbnN0IHtcclxuICAgICAgICAgICAgLy8gZXh0cnVkZXJTZXR1cEVycm9yIHByZXRhaW5zIHRvIHRoZSBleHRydWRlciBsb2Fkb3V0IG9uXHJcbiAgICAgICAgICAgIC8vIHRoZSBjYXJyaWFnZTsgbWlzc2luZywgbWlzbWF0Y2hlZCwgb3IgdW5zdXBwb3J0ZWRcclxuICAgICAgICAgICAgZXh0cnVkZXJTZXR1cEVycm9yLFxyXG4gICAgICAgICAgICBwZXJFeHRydWRlckVycm9yVHlwZSxcclxuICAgICAgICAgICAgc3VwcG9ydGVkQ29uZmlncyxcclxuICAgICAgICB9ID0gdGhpcy5wcm9wcy5wcmludGVyLmNoZWNrRm9yVW5zdXBwb3J0ZWRFeHRydWRlckNvbmZpZ3VyYXRpb25zKClcclxuICAgICAgICAgICAgPyB0aGlzLnByb3BzLnByaW50ZXIuY2hlY2tGb3JVbnN1cHBvcnRlZEV4dHJ1ZGVyQ29uZmlndXJhdGlvbnMoKVxyXG4gICAgICAgICAgICA6IHt9O1xyXG5cclxuICAgICAgICBpZiAoZXh0cnVkZXJTZXR1cEVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByb3BzID0ge1xyXG4gICAgICAgICAgICAgICAgbWFjaGluZV9uYW1lOiB0aGlzLnByb3BzLnByaW50ZXIuZ2V0TmFtZSgpLFxyXG4gICAgICAgICAgICAgICAgcGVyRXh0cnVkZXJFcnJvclR5cGUsXHJcbiAgICAgICAgICAgICAgICBzdXBwb3J0ZWRDb25maWdzLFxyXG4gICAgICAgICAgICAgICAgaTE4bixcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2hvd0V4dHJ1ZGVyU2V0dXBFcnJvcldhcm5pbmcocHJvcHMpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoaGFzRXh0cnVkZXJNYXRlcmlhbE1pc21hdGNoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvd0V4dHJ1ZGVyTWF0ZXJpYWxNaXNtYXRjaFdhcm5pbmcoKTtcclxuICAgICAgICB9IGVsc2UgaWYgKFxyXG4gICAgICAgICAgICAoc3Bvb2xNYXRlcmlhbHMuaW5jbHVkZXMobnVsbCkgfHwgc3Bvb2xNYXRlcmlhbHMuaW5jbHVkZXModW5kZWZpbmVkKSkgJiZcclxuICAgICAgICAgICAgIWF0dGFjaGVkRXh0cnVkZXJzLmluY2x1ZGVzKEV4dHJ1ZGVyVHlwZUVudW0ubWsxNF9lKVxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgICB0aGlzLnNob3dOb25MYWJzTWF0ZXJpYWxXYXJuaW5nKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgZmlsZU5hbWUgPSBkaWFsb2cuc2hvd1NhdmVEaWFsb2cocmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKSwge1xyXG4gICAgICAgICAgICAgICAgdGl0bGU6IHNlbGYucHJvcHMuaTE4bignbWI6cHJpbnRCdXR0b24uZXhwb3J0JyksXHJcbiAgICAgICAgICAgICAgICBmaWx0ZXJzOiBbZmlsdGVyc10sXHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0UGF0aCxcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoZmlsZU5hbWUpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYucHJvcHMub25DbGljayhmaWxlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdFBhdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnbGFzdEV4cG9ydERpYWxvZ1BhdGgnLCBwYXRoLmRpcm5hbWUoZmlsZU5hbWUpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjYW5QcmludCgpIHtcclxuICAgICAgICBjb25zdCBzdGF0dXMgPSB0aGlzLnByb3BzLnByaW50ZXIuZ2V0U3RhdHVzKCk7XHJcbiAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgc3RhdHVzICYmXHJcbiAgICAgICAgICAgIHN0YXR1cy5zdGF0ZSAmJlxyXG4gICAgICAgICAgICBzdGF0dXMuc3RhdGUudG9Mb3dlckNhc2UoKSAhPT0gJ29mZmxpbmUnICYmXHJcbiAgICAgICAgICAgIHN0YXR1cy5zdGF0ZS50b0xvd2VyQ2FzZSgpICE9PSAndW5hdXRoZW50aWNhdGVkJ1xyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgb3BlbkNvbnRleHRNZW51KGV2ZW50KSB7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICBjb25zdCBtZW51SXRlbSA9IFtcclxuICAgICAgICAgICAgbmV3IE1lbnVJdGVtRGF0YSh7XHJcbiAgICAgICAgICAgICAgICBwYXRoOiAnZXhwb3J0JyxcclxuICAgICAgICAgICAgICAgIGxhYmVsOiAnRXhwb3J0JyxcclxuICAgICAgICAgICAgICAgIGFjdGlvbjogKCkgPT4gdGhpcy5leHBvcnRQcmludCgpLFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICBdO1xyXG4gICAgICAgIHRoaXMucHJvcHMuZmx1eC5nZXRTZXJ2aWNlKCdNZW51U2VydmljZScpLnJlbmRlckNvbnRleHRNZW51KG1lbnVJdGVtLCBldmVudC5jbGllbnRYLCBldmVudC5jbGllbnRZKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkNsaWNrKCkge1xyXG4gICAgICAgIGNvbnN0IG1hdGVyaWFscyA9IHRoaXMucHJvcHMuZmx1eC5zdG9yZSgnUHJpbnRTZXR0aW5nc1N0b3JlJykuZ2V0U3RhdGUoKS5tYXRlcmlhbHM7XHJcbiAgICAgICAgLy8gR290dGEgcHV0IHRoaXMgbnVsbCBjaGVjayBpbiBmb3IgdGhlIGdydW50IHRlc3RzLiBBaCB3ZWxsLlxyXG4gICAgICAgIGNvbnN0IHNwb29sTWF0ZXJpYWxzID0gbWF0ZXJpYWxzID8gbWF0ZXJpYWxzLnNwb29sTWF0ZXJpYWxzIDogbnVsbDtcclxuICAgICAgICBjb25zdCBhdHRhY2hlZEV4dHJ1ZGVycyA9IHRoaXMucHJvcHMucHJpbnRlci5nZXRBdHRhY2hlZEV4dHJ1ZGVycygpO1xyXG4gICAgICAgIGNvbnN0IE1vZGFsU2VydmljZSA9IHRoaXMucHJvcHMuZmx1eC5nZXRTZXJ2aWNlKCdNb2RhbFNlcnZpY2UnKTtcclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgIChzcG9vbE1hdGVyaWFscy5pbmNsdWRlcyhudWxsKSB8fCBzcG9vbE1hdGVyaWFscy5pbmNsdWRlcyh1bmRlZmluZWQpKSAmJlxyXG4gICAgICAgICAgICAhYXR0YWNoZWRFeHRydWRlcnMuaW5jbHVkZXMoRXh0cnVkZXJUeXBlRW51bS5tazE0X2UpXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvd05vbkxhYnNNYXRlcmlhbFdhcm5pbmcoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmhhbmRsZVByaW50QnV0dG9uQ2xpY2soKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaGFuZGxlUHJpbnRCdXR0b25DbGljaygpIHtcclxuICAgICAgICBjb25zdCBwcmludGVyID0gdGhpcy5wcm9wcy5wcmludGVyO1xyXG4gICAgICAgIGNvbnN0IHRyYWNraW5nU2VydmljZSA9IHRoaXMucHJvcHMuZmx1eC5nZXRTZXJ2aWNlKCdUcmFja2luZ1NlcnZpY2UnKTtcclxuICAgICAgICBjb25zdCBpMThuID0gdGhpcy5wcm9wcy5mbHV4LmdldFNlcnZpY2UoJ1RyYW5zbGF0aW9uU2VydmljZScpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5jYW5QcmludCgpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRyYWNraW5nSW5mbyA9IHV0aWwudHJhY2tpbmdJbmZvRm9yUHJpbnRlcihwcmludGVyKTtcclxuICAgICAgICAgICAgdHJhY2tpbmdJbmZvLmV4dHJ1ZGVyX3R5cGUgPSBwcmludGVyLmdldEN1cnJlbnRFeHRydWRlclR5cGUoKTtcclxuICAgICAgICAgICAgY29uc3QgcHJpbnRTZXR0aW5ncyA9IGFuYWx5dGljVXRpbHMuZ2V0UHJpbnRTZXR0aW5nc0ZvckFuYWx5dGljRXZlbnRzKHRoaXMucHJvcHMuZmx1eCwgcHJpbnRlcik7XHJcbiAgICAgICAgICAgIHRyYWNraW5nU2VydmljZS5hZGRFdmVudChfLm1lcmdlKHsgbmFtZTogJ1ByaW50IFN0YXJ0ZWQnIH0sIHRyYWNraW5nSW5mbywgcHJpbnRTZXR0aW5ncykpO1xyXG5cclxuICAgICAgICAgICAgY29uc3Qge1xyXG4gICAgICAgICAgICAgICAgLy8gZXh0cnVkZXJTZXR1cEVycm9yIHByZXRhaW5zIHRvIHRoZSBleHRydWRlciBsb2Fkb3V0IG9uXHJcbiAgICAgICAgICAgICAgICAvLyB0aGUgY2FycmlhZ2U7IG1pc3NpbmcsIG1pc21hdGNoZWQsIG9yIHVuc3VwcG9ydGVkXHJcbiAgICAgICAgICAgICAgICBleHRydWRlclNldHVwRXJyb3IsXHJcbiAgICAgICAgICAgICAgICBwZXJFeHRydWRlckVycm9yVHlwZSxcclxuICAgICAgICAgICAgICAgIHN1cHBvcnRlZENvbmZpZ3MsXHJcbiAgICAgICAgICAgIH0gPSBwcmludGVyLmNoZWNrRm9yVW5zdXBwb3J0ZWRFeHRydWRlckNvbmZpZ3VyYXRpb25zKClcclxuICAgICAgICAgICAgICAgID8gcHJpbnRlci5jaGVja0ZvclVuc3VwcG9ydGVkRXh0cnVkZXJDb25maWd1cmF0aW9ucygpXHJcbiAgICAgICAgICAgICAgICA6IHt9O1xyXG4gICAgICAgICAgICBjb25zdCBoYXNFeHRydWRlck1hdGVyaWFsTWlzbWF0Y2ggPSBwcmludGVyLmhhc0V4dHJ1ZGVyTWF0ZXJpYWxNaXNtYXRjaCgpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGV4dHJ1ZGVyU2V0dXBFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcHJvcHMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWFjaGluZV9uYW1lOiBwcmludGVyLmdldE5hbWUoKSxcclxuICAgICAgICAgICAgICAgICAgICBwZXJFeHRydWRlckVycm9yVHlwZSxcclxuICAgICAgICAgICAgICAgICAgICBzdXBwb3J0ZWRDb25maWdzLFxyXG4gICAgICAgICAgICAgICAgICAgIGkxOG4sXHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNob3dFeHRydWRlclNldHVwRXJyb3JXYXJuaW5nKHByb3BzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaGFzRXh0cnVkZXJNYXRlcmlhbE1pc21hdGNoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zaG93RXh0cnVkZXJNYXRlcmlhbE1pc21hdGNoV2FybmluZygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLm9uQ2xpY2sodW5kZWZpbmVkLCB0cnVlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5leHBvcnRQcmludCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzaG93RXh0cnVkZXJNYXRlcmlhbE1pc21hdGNoV2FybmluZygpIHtcclxuICAgICAgICBjb25zdCBtb2RhbFNlcnZpY2UgPSB0aGlzLnByb3BzLmZsdXguZ2V0U2VydmljZSgnTW9kYWxTZXJ2aWNlJyk7XHJcbiAgICAgICAgcmV0dXJuIG1vZGFsU2VydmljZS5jb25maXJtKHtcclxuICAgICAgICAgICAgdGl0bGU6IHRoaXMucHJvcHMuaTE4bignbWI6ZXh0cnVkZXJNYXRlcmlhbEVycm9yTW9kYWwudGl0bGUnKSxcclxuICAgICAgICAgICAgYm9keTogdGhpcy5wcm9wcy5pMThuKCdtYjpleHRydWRlck1hdGVyaWFsRXJyb3JNb2RhbC5ib2R5JyksXHJcbiAgICAgICAgICAgIGNvbmZpcm1UZXh0OiB0aGlzLnByb3BzLmkxOG4oJ21iOmV4dHJ1ZGVyTWF0ZXJpYWxFcnJvck1vZGFsLmNvbmZpcm1UZXh0JyksXHJcbiAgICAgICAgICAgIG1vZGFsQ2xhc3M6ICd3NDAwIHdhcm5pbmdNb2RhbCcsXHJcbiAgICAgICAgICAgIGhpZGVDbG9zZTogdHJ1ZSxcclxuICAgICAgICAgICAgYmFja2Ryb3A6ICdzdGF0aWMnLFxyXG4gICAgICAgICAgICBrZXlib2FyZDogZmFsc2UsXHJcbiAgICAgICAgICAgIG9uQ29uZmlybTogKCkgPT4ge30sXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2hvd0V4dHJ1ZGVyU2V0dXBFcnJvcldhcm5pbmcocGF5bG9hZCkge1xyXG4gICAgICAgIGNvbnN0IG1vZGFsU2VydmljZSA9IHRoaXMucHJvcHMuZmx1eC5nZXRTZXJ2aWNlKCdNb2RhbFNlcnZpY2UnKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIG1vZGFsU2VydmljZS5zaG93KDxVbnN1cHBvcnRlZEV4dHJ1ZGVyQ29uZmlndXJhdGlvbnNEaWFsb2cgey4uLnBheWxvYWR9IC8+LCB7XHJcbiAgICAgICAgICAgIHRpdGxlOiB0aGlzLnByb3BzLmkxOG4oJ21iOnVuc3VwcG9ydGVkX2V4dHJ1ZGVyX2NvbmZpZ3VyYXRpb25zLnRpdGxlX21vZGFsJywge1xyXG4gICAgICAgICAgICAgICAgbWFjaGluZV9uYW1lOiBwYXlsb2FkLm1hY2hpbmVfbmFtZSxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIGJhY2tkcm9wOiAnc3RhdGljJyxcclxuICAgICAgICAgICAgbW9kYWxDbGFzczogJ3c0MDAgd2FybmluZ01vZGFsJyxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBzaG93Tm9uTGFic01hdGVyaWFsV2FybmluZygpIHtcclxuICAgICAgICBjb25zdCBtb2RhbFNlcnZpY2UgPSB0aGlzLnByb3BzLmZsdXguZ2V0U2VydmljZSgnTW9kYWxTZXJ2aWNlJyk7XHJcbiAgICAgICAgcmV0dXJuIG1vZGFsU2VydmljZS5jb25maXJtKHtcclxuICAgICAgICAgICAgdGl0bGU6IHRoaXMucHJvcHMuaTE4bignbWI6dW5rbm93bk1hdGVyaWFsV2FybmluZ01vZGFsLnRpdGxlJyksXHJcbiAgICAgICAgICAgIGJvZHk6IHRoaXMucHJvcHMuaTE4bignbWI6dW5rbm93bk1hdGVyaWFsV2FybmluZ01vZGFsLnRleHQnKSxcclxuICAgICAgICAgICAgY29uZmlybVRleHQ6IHRoaXMucHJvcHMuaTE4bignbWI6dW5rbm93bk1hdGVyaWFsV2FybmluZ01vZGFsLmFja25vd2xlZGdlJyksXHJcbiAgICAgICAgICAgIG1vZGFsQ2xhc3M6ICd3NDAwIHdhcm5pbmdNb2RhbCcsXHJcbiAgICAgICAgICAgIGhpZGVDbG9zZTogdHJ1ZSxcclxuICAgICAgICAgICAgYmFja2Ryb3A6ICdzdGF0aWMnLFxyXG4gICAgICAgICAgICBrZXlib2FyZDogZmFsc2UsXHJcbiAgICAgICAgICAgIG9uQ29uZmlybTogKCkgPT4ge30sXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UHJpbnRMYWJlbCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jYW5QcmludCgpID8gdGhpcy5wcm9wcy5pMThuKCdwcmludGVyX2xpc3QucHJpbnQnKSA6IHRoaXMucHJvcHMuaTE4bignbWI6cHJpbnRCdXR0b24uZXhwb3J0Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0RHJvcGRvd24oZGlzYWJsZWQpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jYW5QcmludCgpID8gKFxyXG4gICAgICAgICAgICA8ZGl2XHJcbiAgICAgICAgICAgICAgICBpZD0nZHJvcGRvd24nXHJcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9e2BwcmludEJ1dHRvbkRyb3Bkb3duJHtkaXNhYmxlZCA/ICcgZGlzYWJsZWQnIDogJyd9YH1cclxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2Rpc2FibGVkID8gdW5kZWZpbmVkIDogZXZlbnQgPT4gdGhpcy5vcGVuQ29udGV4dE1lbnUoZXZlbnQpfVxyXG4gICAgICAgICAgICA+XHJcbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0ncHJpbnRCdXR0b25Ecm9wZG93bkxhYmVsJz4uLi48L2Rpdj5cclxuICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgKSA6IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcmVuZGVyKCkge1xyXG4gICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5wcm9wcy5wcmludGVyLmdldFN0YXR1cygpLnN0YXRlLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgY29uc3QgYnVzeSA9IHN0YXRlICE9PSAnaWRsZSc7XHJcbiAgICAgICAgY29uc3QgdmFsaWRhdGlvblN0b3JlID0gdGhpcy5wcm9wcy5mbHV4LnN0b3JlKCdWYWxpZGF0aW9uU3RvcmUnKTtcclxuICAgICAgICBjb25zdCB0cmF5SW52YWxpZCA9XHJcbiAgICAgICAgICAgIHZhbGlkYXRpb25TdG9yZS5nZXRUcmF5Qm9kaWVzT3V0c2lkZUJ1aWxkRW52ZWxvcGUoKS5zaXplID4gMCB8fFxyXG4gICAgICAgICAgICB2YWxpZGF0aW9uU3RvcmUuZ2V0UmFmdHNPdXRzaWRlQnVpbGRFbnZlbG9wZSgpLmxlbmd0aCA+IDAgfHxcclxuICAgICAgICAgICAgdmFsaWRhdGlvblN0b3JlLmlzUHVyZ2VUb3dlck91dE9mQm91bmRzKCk7XHJcbiAgICAgICAgY29uc3QgZGlzYWJsZWQgPSB0cmF5SW52YWxpZCB8fCB0aGlzLnByb3BzLmRpc2FibGVkIHx8IChidXN5ICYmIHN0YXRlICE9PSAnb2ZmbGluZScpO1xyXG4gICAgICAgIGNvbnN0IGNsYXNzZXMgPSB0aGlzLnByb3BzLnByaW50ZXJQb3B1cENsYXNzZXMgKyAoZGlzYWJsZWQgPyAnIGRpc2FibGVkJyA6ICcnKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3ByaW50QnV0dG9uQ29udGFpbmVyJz5cclxuICAgICAgICAgICAgICAgIDxkaXZcclxuICAgICAgICAgICAgICAgICAgICBpZD17dGhpcy5jYW5QcmludCgpID8gJ3ByaW50QnV0dG9uJyA6ICdleHBvcnRCdXR0b24nfVxyXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17Y2xhc3Nlc31cclxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXtkaXNhYmxlZCA/IHVuZGVmaW5lZCA6IHRoaXMuX2JvdW5kT25DbGlja31cclxuICAgICAgICAgICAgICAgID5cclxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0ncHJpbnRCdXR0b25MYWJlbCc+e3RoaXMuZ2V0UHJpbnRMYWJlbCgpfTwvZGl2PlxyXG4gICAgICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICAgICAgICB7dGhpcy5nZXREcm9wZG93bihkaXNhYmxlZCl9XHJcbiAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcbn1cclxuXHJcblByaW50QnV0dG9uLmRpc3BsYXlOYW1lID0gJ1ByaW50QnV0dG9uJztcclxuUHJpbnRCdXR0b24ucHJvcFR5cGVzID0ge1xyXG4gICAgaTE4bjogUmVhY3QuUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcclxuICAgIGZsdXg6IFJlYWN0LlByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcclxuICAgIG9uQ2xpY2s6IFJlYWN0LlByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXHJcbiAgICBwcmludGVyOiBSZWFjdC5Qcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXHJcbiAgICBwcmludGVyUG9wdXBDbGFzc2VzOiBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLFxyXG4gICAgZGlzYWJsZWQ6IFJlYWN0LlByb3BUeXBlcy5ib29sLFxyXG59O1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBQcmludEJ1dHRvbjtcclxuIl19
