'use strict';

var _react = _interopRequireDefault(require("react"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _flux_component = _interopRequireDefault(require("eagle-print/views/flux_component"));

var _styles = _interopRequireDefault(require("./styles"));

var _printerDetails = require("../../utils/printerDetails");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class PrintProgressBadge extends _flux_component.default {
  constructor(props, context) {
    super(props, context); // because GrabCAD
    // more specifically, GrabCAD's widget provider doesn't allow
    // us to add useful properties to this component. That's not a
    // big deal when we're in the PrinterDetailsPanel, but it's
    // a problem when we're in the PrinterList. So, we have to add
    // these useful objects in a kind of silly way, instead of just
    // getting them from the props.

    this.detailsStatus = (0, _printerDetails.printerDetailsStatus)(this.props.printer, this.props.overrideState);
    this.currentProcess = (0, _printerDetails.currentPrinterProcess)(this.props.printer, this.props.overrideState);
  }

  componentDidUpdate() {
    // also need to update it since we can't just use props for this
    this.detailsStatus = (0, _printerDetails.printerDetailsStatus)(this.props.printer, this.props.overrideState);
    this.currentProcess = (0, _printerDetails.currentPrinterProcess)(this.props.printer, this.props.overrideState);
  }

  _realRadius() {
    // pull them out to make code formatting nicer
    const {
      r,
      strokeWidth
    } = this.props;
    return r - (strokeWidth + strokeWidth / 2);
  }

  _realPercent() {
    return this.currentProcess.apply(cp => cp.progress);
  }

  _circleClass() {
    const {
      step,
      is,
      has
    } = this.detailsStatus;
    if (step.completed) return 'makerbot-blue-stroke';
    if (step.busy || step.transferring || step.updatingFirmware || step.wifiSetUp) return 'makerbot-light-grey-stroke';
    if (step.printing) return 'makerbot-red-stroke';
    if (step.paused || step.startPrint || step.error || step.clearFilament || is.authenticating || is.unauthenticated || has.error || !has.extruder) return 'makerbot-orange-stroke';
    return '';
  }

  _circleStyle() {
    const {
      step,
      has,
      is
    } = this.detailsStatus;
    if (step.busy || step.transferring || step.updatingFirmware || step.wifiSetUp) return _styles.default.dashedCircle(this._realRadius(), 4);
    if (step.printing) return Object.assign({}, _styles.default.roundedCapCircle(), {
      strokeDasharray: this.currentProcess.apply(() => dashArray(this._realRadius(), this._realPercent()))
    });
    if (step.error || has.error || step.startPrint || step.clearFilament || is.authenticating || is.unauthenticated || !has.extruder) return Object.assign({}, _styles.default.roundedCapCircle(), {
      animation: 'pulse 1.5s linear infinite'
    });
    if (step.paused) return _styles.default.dashedCircle(this._realRadius(), 2);
    if (is.idle || !has.process) return Object.assign({}, _styles.default.roundedCapCircle(), {
      stroke: 'none',
      opacity: 0
    });
    return _styles.default.roundedCapCircle();
  }

  getPrinterIcon() {
    const filePath = _path.default.resolve(__dirname, `images/BotIcon_${this.props.printer.getGender().botType}.svg`);

    if (_fsExtra.default.existsSync(filePath)) return filePath;
    return _path.default.resolve(__dirname, 'images/m_log_placeholder.svg');
  }

  getProgressCircle() {
    return /*#__PURE__*/_react.default.createElement("circle", {
      className: this._circleClass(),
      cx: this.props.r,
      cy: this.props.r,
      r: this._realRadius(),
      strokeWidth: `${this.props.strokeWidth}px`,
      style: this._circleStyle()
    });
  }

  getBackgroundCircle() {
    const {
      has,
      is
    } = this.detailsStatus;
    const style = {
      strokeWidth: '1px',
      fill: 'none',
      stroke: '#8c8c8c'
    };

    if (this.props.r <= 26 && (is.idle || !has.process)) {
      style.stroke = 'none';
      style.opacity = 0;
    }

    return /*#__PURE__*/_react.default.createElement("circle", {
      style: style,
      cx: this.props.r,
      cy: this.props.r,
      r: this.props.r - 1
    });
  }

  _printingText() {
    const {
      step
    } = this.detailsStatus;
    const isSmallIcon = this.props.r <= 15;
    const isMediumIcon = this.props.r <= 26;
    const smallStyle = {
      transform: 'rotate(0deg)'
    };
    const largeStyle = Object.assign({}, smallStyle, {
      fontSize: `${this.props.r * 2 / 3}px`
    });

    if (step.printing && isSmallIcon) {
      return /*#__PURE__*/_react.default.createElement("image", {
        xlinkHref: _path.default.resolve(__dirname, 'images/play.svg'),
        x: this.props.r / 2,
        y: this.props.r / 2,
        height: this.props.r,
        width: this.props.r,
        style: smallStyle
      });
    } // Medium size icons show percent complete but not '%' symbol


    return /*#__PURE__*/_react.default.createElement("text", {
      className: "makerbot-grey-fill",
      style: largeStyle,
      x: this.props.r,
      y: this.props.r,
      dy: ".4em",
      textAnchor: "middle"
    }, /*#__PURE__*/_react.default.createElement("tspan", {
      className: "value"
    }, this._realPercent()), /*#__PURE__*/_react.default.createElement("tspan", {
      className: "percent"
    }, isMediumIcon ? '' : '%'));
  }

  _progressIconProps() {
    const style = {
      transform: 'rotate(0deg)'
    };
    const {
      step,
      has,
      is
    } = this.detailsStatus;

    if (step.completed) {
      return {
        image: 'images/print-done.svg',
        style
      };
    }

    if (step.busy || step.transferring || step.updatingFirmware || step.wifiSetUp) {
      return {
        image: 'images/gears-icon.svg',
        style: {
          animation: 'spinner 30s linear infinite',
          animationDirection: 'reverse',
          transformOrigin: 'center center'
        }
      };
    }

    if (step.error || has.error || step.startPrint || step.clearFilament || is.authenticating || is.unauthenticated || !has.extruder) {
      return {
        image: 'images/alert-icon.svg',
        style
      };
    }

    if (step.paused) {
      return {
        image: 'images/pause-icon.svg',
        style
      };
    }

    if (is.idle || !has.process) {
      return {
        image: this.getPrinterIcon(),
        style: Object.assign({}, style, {
          transformOrigin: 'center',
          transform: `rotate(0deg) scale(2,2)`
        })
      };
    }

    return {
      image: this.getPrinterIcon(),
      style
    };
  }

  getProgressText() {
    if (this.detailsStatus.step.printing) return this._printingText();

    const {
      image,
      style
    } = this._progressIconProps();

    return /*#__PURE__*/_react.default.createElement("image", {
      xlinkHref: _path.default.resolve(__dirname, image),
      x: this.props.r / 2,
      y: this.props.r / 2,
      height: this.props.r,
      width: this.props.r,
      style: style
    });
  }

  render() {
    const width = this.props.r * 2;
    const height = this.props.r * 2;
    const viewBox = `0 0 ${width} ${height}`;
    return /*#__PURE__*/_react.default.createElement("svg", Object.assign({}, this.props, {
      className: 'CircularProgress',
      width,
      height,
      viewBox
    }), this.getBackgroundCircle(), this.getProgressCircle(), this.getProgressText());
  }

}

PrintProgressBadge.defaultProps = {
  r: 50,
  strokeWidth: 1
};
PrintProgressBadge.propTypes = Object.assign({}, PrintProgressBadge.propTypes, {
  printer: _react.default.PropTypes.object.isRequired,
  strokeWidth: _react.default.PropTypes.number,
  r: _react.default.PropTypes.number
});

const dashArray = (r, perc) => {
  const dash = r * Math.PI * 2 * (perc / 100);
  return `${dash}, ${r * Math.PI * 4}`;
};

module.exports = PrintProgressBadge;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByaW50UHJvZ3Jlc3NCYWRnZS5qcyJdLCJuYW1lcyI6WyJQcmludFByb2dyZXNzQmFkZ2UiLCJGbHV4Q29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImNvbnRleHQiLCJkZXRhaWxzU3RhdHVzIiwicHJpbnRlciIsIm92ZXJyaWRlU3RhdGUiLCJjdXJyZW50UHJvY2VzcyIsImNvbXBvbmVudERpZFVwZGF0ZSIsIl9yZWFsUmFkaXVzIiwiciIsInN0cm9rZVdpZHRoIiwiX3JlYWxQZXJjZW50IiwiYXBwbHkiLCJjcCIsInByb2dyZXNzIiwiX2NpcmNsZUNsYXNzIiwic3RlcCIsImlzIiwiaGFzIiwiY29tcGxldGVkIiwiYnVzeSIsInRyYW5zZmVycmluZyIsInVwZGF0aW5nRmlybXdhcmUiLCJ3aWZpU2V0VXAiLCJwcmludGluZyIsInBhdXNlZCIsInN0YXJ0UHJpbnQiLCJlcnJvciIsImNsZWFyRmlsYW1lbnQiLCJhdXRoZW50aWNhdGluZyIsInVuYXV0aGVudGljYXRlZCIsImV4dHJ1ZGVyIiwiX2NpcmNsZVN0eWxlIiwic3R5bGVzIiwiZGFzaGVkQ2lyY2xlIiwiT2JqZWN0IiwiYXNzaWduIiwicm91bmRlZENhcENpcmNsZSIsInN0cm9rZURhc2hhcnJheSIsImRhc2hBcnJheSIsImFuaW1hdGlvbiIsImlkbGUiLCJwcm9jZXNzIiwic3Ryb2tlIiwib3BhY2l0eSIsImdldFByaW50ZXJJY29uIiwiZmlsZVBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsImdldEdlbmRlciIsImJvdFR5cGUiLCJmcyIsImV4aXN0c1N5bmMiLCJnZXRQcm9ncmVzc0NpcmNsZSIsImdldEJhY2tncm91bmRDaXJjbGUiLCJzdHlsZSIsImZpbGwiLCJfcHJpbnRpbmdUZXh0IiwiaXNTbWFsbEljb24iLCJpc01lZGl1bUljb24iLCJzbWFsbFN0eWxlIiwidHJhbnNmb3JtIiwibGFyZ2VTdHlsZSIsImZvbnRTaXplIiwiX3Byb2dyZXNzSWNvblByb3BzIiwiaW1hZ2UiLCJhbmltYXRpb25EaXJlY3Rpb24iLCJ0cmFuc2Zvcm1PcmlnaW4iLCJnZXRQcm9ncmVzc1RleHQiLCJyZW5kZXIiLCJ3aWR0aCIsImhlaWdodCIsInZpZXdCb3giLCJjbGFzc05hbWUiLCJkZWZhdWx0UHJvcHMiLCJwcm9wVHlwZXMiLCJSZWFjdCIsIlByb3BUeXBlcyIsIm9iamVjdCIsImlzUmVxdWlyZWQiLCJudW1iZXIiLCJwZXJjIiwiZGFzaCIsIk1hdGgiLCJQSSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOzs7O0FBRUEsTUFBTUEsa0JBQU4sU0FBaUNDLHVCQUFqQyxDQUErQztBQUMzQ0MsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQVFDLE9BQVIsRUFBaUI7QUFDeEIsVUFBTUQsS0FBTixFQUFhQyxPQUFiLEVBRHdCLENBRXhCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUNBLFNBQUtDLGFBQUwsR0FBcUIsMENBQXFCLEtBQUtGLEtBQUwsQ0FBV0csT0FBaEMsRUFBeUMsS0FBS0gsS0FBTCxDQUFXSSxhQUFwRCxDQUFyQjtBQUNBLFNBQUtDLGNBQUwsR0FBc0IsMkNBQXNCLEtBQUtMLEtBQUwsQ0FBV0csT0FBakMsRUFBMEMsS0FBS0gsS0FBTCxDQUFXSSxhQUFyRCxDQUF0QjtBQUNIOztBQUVERSxFQUFBQSxrQkFBa0IsR0FBRztBQUNqQjtBQUNBLFNBQUtKLGFBQUwsR0FBcUIsMENBQXFCLEtBQUtGLEtBQUwsQ0FBV0csT0FBaEMsRUFBeUMsS0FBS0gsS0FBTCxDQUFXSSxhQUFwRCxDQUFyQjtBQUNBLFNBQUtDLGNBQUwsR0FBc0IsMkNBQXNCLEtBQUtMLEtBQUwsQ0FBV0csT0FBakMsRUFBMEMsS0FBS0gsS0FBTCxDQUFXSSxhQUFyRCxDQUF0QjtBQUNIOztBQUVERyxFQUFBQSxXQUFXLEdBQUc7QUFDVjtBQUNBLFVBQU07QUFBRUMsTUFBQUEsQ0FBRjtBQUFLQyxN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QStCekMsTUFBTSxDQUFDQyxNQUFQLENBQWMsRUFBZCxFQUFrQnRDLGtCQUFrQixDQUFDOEUsU0FBckMsRUFBZ0Q7QUFDM0V4RSxFQUFBQSxPQUFPLEVBQUV5RSxlQUFNQyxTQUFOLENBQWdCQyxNQUFoQixDQUF1QkMsVUFEMkM7QUFFM0V0RSxFQUFBQSxXQUFXLEVBQUVtRSxlQUFNQyxTQUFOLENBQWdCRyxNQUY4QztBQUczRXhFLEVBQUFBLENBQUMsRUFBRW9FLGVBQU1DLFNBQU4sQ0FBZ0JHO0FBSHdELENBQWhELENBQS9COztBQU1BLE1BQU0xQyxTQUFTLEdBQUcsQ0FBQzlCLENBQUQsRUFBSXlFLElBQUosS0FBYTtBQUMzQixRQUFNQyxJQUFJLEdBQUcxRSxDQUFDLEdBQUcyRSxJQUFJLENBQUNDLEVBQVQsR0FBYyxDQUFkLElBQW1CSCxJQUFJLEdBQUcsR0FBMUIsQ0FBYjtBQUNBLFNBQVEsR0FBRUMsSUFBSyxLQUFJMUUsQ0FBQyxHQUFHMkUsSUFBSSxDQUFDQyxFQUFULEdBQWMsQ0FBRSxFQUFuQztBQUNILENBSEQ7O0FBS0FDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnpGLGtCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XHJcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XHJcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgRmx1eENvbXBvbmVudCBmcm9tICdlYWdsZS1wcmludC92aWV3cy9mbHV4X2NvbXBvbmVudCc7XHJcblxyXG5pbXBvcnQgc3R5bGVzIGZyb20gJy4vc3R5bGVzJztcclxuaW1wb3J0IHsgY3VycmVudFByaW50ZXJQcm9jZXNzLCBwcmludGVyRGV0YWlsc1N0YXR1cyB9IGZyb20gJy4uLy4uL3V0aWxzL3ByaW50ZXJEZXRhaWxzJztcclxuXHJcbmNsYXNzIFByaW50UHJvZ3Jlc3NCYWRnZSBleHRlbmRzIEZsdXhDb21wb25lbnQge1xyXG4gICAgY29uc3RydWN0b3IocHJvcHMsIGNvbnRleHQpIHtcclxuICAgICAgICBzdXBlcihwcm9wcywgY29udGV4dCk7XHJcbiAgICAgICAgLy8gYmVjYXVzZSBHcmFiQ0FEXHJcbiAgICAgICAgLy8gbW9yZSBzcGVjaWZpY2FsbHksIEdyYWJDQUQncyB3aWRnZXQgcHJvdmlkZXIgZG9lc24ndCBhbGxvd1xyXG4gICAgICAgIC8vIHVzIHRvIGFkZCB1c2VmdWwgcHJvcGVydGllcyB0byB0aGlzIGNvbXBvbmVudC4gVGhhdCdzIG5vdCBhXHJcbiAgICAgICAgLy8gYmlnIGRlYWwgd2hlbiB3ZSdyZSBpbiB0aGUgUHJpbnRlckRldGFpbHNQYW5lbCwgYnV0IGl0J3NcclxuICAgICAgICAvLyBhIHByb2JsZW0gd2hlbiB3ZSdyZSBpbiB0aGUgUHJpbnRlckxpc3QuIFNvLCB3ZSBoYXZlIHRvIGFkZFxyXG4gICAgICAgIC8vIHRoZXNlIHVzZWZ1bCBvYmplY3RzIGluIGEga2luZCBvZiBzaWxseSB3YXksIGluc3RlYWQgb2YganVzdFxyXG4gICAgICAgIC8vIGdldHRpbmcgdGhlbSBmcm9tIHRoZSBwcm9wcy5cclxuICAgICAgICB0aGlzLmRldGFpbHNTdGF0dXMgPSBwcmludGVyRGV0YWlsc1N0YXR1cyh0aGlzLnByb3BzLnByaW50ZXIsIHRoaXMucHJvcHMub3ZlcnJpZGVTdGF0ZSk7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50UHJvY2VzcyA9IGN1cnJlbnRQcmludGVyUHJvY2Vzcyh0aGlzLnByb3BzLnByaW50ZXIsIHRoaXMucHJvcHMub3ZlcnJpZGVTdGF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xyXG4gICAgICAgIC8vIGFsc28gbmVlZCB0byB1cGRhdGUgaXQgc2luY2Ugd2UgY2FuJ3QganVzdCB1c2UgcHJvcHMgZm9yIHRoaXNcclxuICAgICAgICB0aGlzLmRldGFpbHNTdGF0dXMgPSBwcmludGVyRGV0YWlsc1N0YXR1cyh0aGlzLnByb3BzLnByaW50ZXIsIHRoaXMucHJvcHMub3ZlcnJpZGVTdGF0ZSk7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50UHJvY2VzcyA9IGN1cnJlbnRQcmludGVyUHJvY2Vzcyh0aGlzLnByb3BzLnByaW50ZXIsIHRoaXMucHJvcHMub3ZlcnJpZGVTdGF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgX3JlYWxSYWRpdXMoKSB7XHJcbiAgICAgICAgLy8gcHVsbCB0aGVtIG91dCB0byBtYWtlIGNvZGUgZm9ybWF0dGluZyBuaWNlclxyXG4gICAgICAgIGNvbnN0IHsgciwgc3Ryb2tlV2lkdGggfSA9IHRoaXMucHJvcHM7XHJcbiAgICAgICAgcmV0dXJuIHIgLSAoc3Ryb2tlV2lkdGggKyBzdHJva2VXaWR0aCAvIDIpO1xyXG4gICAgfVxyXG5cclxuICAgIF9yZWFsUGVyY2VudCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50UHJvY2Vzcy5hcHBseShjcCA9PiBjcC5wcm9ncmVzcyk7XHJcbiAgICB9XHJcblxyXG4gICAgX2NpcmNsZUNsYXNzKCkge1xyXG4gICAgICAgIGNvbnN0IHsgc3RlcCwgaXMsIGhhcyB9ID0gdGhpcy5kZXRhaWxzU3RhdHVzO1xyXG5cclxuICAgICAgICBpZiAoc3RlcC5jb21wbGV0ZWQpIHJldHVybiAnbWFrZXJib3QtYmx1ZS1zdHJva2UnO1xyXG5cclxuICAgICAgICBpZiAoc3RlcC5idXN5IHx8IHN0ZXAudHJhbnNmZXJyaW5nIHx8IHN0ZXAudXBkYXRpbmdGaXJtd2FyZSB8fCBzdGVwLndpZmlTZXRVcClcclxuICAgICAgICAgICAgcmV0dXJuICdtYWtlcmJvdC1saWdodC1ncmV5LXN0cm9rZSc7XHJcblxyXG4gICAgICAgIGlmIChzdGVwLnByaW50aW5nKSByZXR1cm4gJ21ha2VyYm90LXJlZC1zdHJva2UnO1xyXG5cclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgIHN0ZXAucGF1c2VkIHx8XHJcbiAgICAgICAgICAgIHN0ZXAuc3RhcnRQcmludCB8fFxyXG4gICAgICAgICAgICBzdGVwLmVycm9yIHx8XHJcbiAgICAgICAgICAgIHN0ZXAuY2xlYXJGaWxhbWVudCB8fFxyXG4gICAgICAgICAgICBpcy5hdXRoZW50aWNhdGluZyB8fFxyXG4gICAgICAgICAgICBpcy51bmF1dGhlbnRpY2F0ZWQgfHxcclxuICAgICAgICAgICAgaGFzLmVycm9yIHx8XHJcbiAgICAgICAgICAgICFoYXMuZXh0cnVkZXJcclxuICAgICAgICApXHJcbiAgICAgICAgICAgIHJldHVybiAnbWFrZXJib3Qtb3JhbmdlLXN0cm9rZSc7XHJcblxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICBfY2lyY2xlU3R5bGUoKSB7XHJcbiAgICAgICAgY29uc3QgeyBzdGVwLCBoYXMsIGlzIH0gPSB0aGlzLmRldGFpbHNTdGF0dXM7XHJcblxyXG4gICAgICAgIGlmIChzdGVwLmJ1c3kgfHwgc3RlcC50cmFuc2ZlcnJpbmcgfHwgc3RlcC51cGRhdGluZ0Zpcm13YXJlIHx8IHN0ZXAud2lmaVNldFVwKVxyXG4gICAgICAgICAgICByZXR1cm4gc3R5bGVzLmRhc2hlZENpcmNsZSh0aGlzLl9yZWFsUmFkaXVzKCksIDQpO1xyXG5cclxuICAgICAgICBpZiAoc3RlcC5wcmludGluZylcclxuICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHN0eWxlcy5yb3VuZGVkQ2FwQ2lyY2xlKCksIHtcclxuICAgICAgICAgICAgICAgIHN0cm9rZURhc2hhcnJheTogdGhpcy5jdXJyZW50UHJvY2Vzcy5hcHBseSgoKSA9PiBkYXNoQXJyYXkodGhpcy5fcmVhbFJhZGl1cygpLCB0aGlzLl9yZWFsUGVyY2VudCgpKSksXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgIHN0ZXAuZXJyb3IgfHxcclxuICAgICAgICAgICAgaGFzLmVycm9yIHx8XHJcbiAgICAgICAgICAgIHN0ZXAuc3RhcnRQcmludCB8fFxyXG4gICAgICAgICAgICBzdGVwLmNsZWFyRmlsYW1lbnQgfHxcclxuICAgICAgICAgICAgaXMuYXV0aGVudGljYXRpbmcgfHxcclxuICAgICAgICAgICAgaXMudW5hdXRoZW50aWNhdGVkIHx8XHJcbiAgICAgICAgICAgICFoYXMuZXh0cnVkZXJcclxuICAgICAgICApXHJcbiAgICAgICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBzdHlsZXMucm91bmRlZENhcENpcmNsZSgpLCB7XHJcbiAgICAgICAgICAgICAgICBhbmltYXRpb246ICdwdWxzZSAxLjVzIGxpbmVhciBpbmZpbml0ZScsXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAoc3RlcC5wYXVzZWQpIHJldHVybiBzdHlsZXMuZGFzaGVkQ2lyY2xlKHRoaXMuX3JlYWxSYWRpdXMoKSwgMik7XHJcblxyXG4gICAgICAgIGlmIChpcy5pZGxlIHx8ICFoYXMucHJvY2VzcylcclxuICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHN0eWxlcy5yb3VuZGVkQ2FwQ2lyY2xlKCksIHtcclxuICAgICAgICAgICAgICAgIHN0cm9rZTogJ25vbmUnLFxyXG4gICAgICAgICAgICAgICAgb3BhY2l0eTogMCxcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBzdHlsZXMucm91bmRlZENhcENpcmNsZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFByaW50ZXJJY29uKCkge1xyXG4gICAgICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgYGltYWdlcy9Cb3RJY29uXyR7dGhpcy5wcm9wcy5wcmludGVyLmdldEdlbmRlcigpLmJvdFR5cGV9LnN2Z2ApO1xyXG5cclxuICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkpIHJldHVybiBmaWxlUGF0aDtcclxuXHJcbiAgICAgICAgcmV0dXJuIHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdpbWFnZXMvbV9sb2dfcGxhY2Vob2xkZXIuc3ZnJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UHJvZ3Jlc3NDaXJjbGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgPGNpcmNsZVxyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPXt0aGlzLl9jaXJjbGVDbGFzcygpfVxyXG4gICAgICAgICAgICAgICAgY3g9e3RoaXMucHJvcHMucn1cclxuICAgICAgICAgICAgICAgIGN5PXt0aGlzLnByb3BzLnJ9XHJcbiAgICAgICAgICAgICAgICByPXt0aGlzLl9yZWFsUmFkaXVzKCl9XHJcbiAgICAgICAgICAgICAgICBzdHJva2VXaWR0aD17YCR7dGhpcy5wcm9wcy5zdHJva2VXaWR0aH1weGB9XHJcbiAgICAgICAgICAgICAgICBzdHlsZT17dGhpcy5fY2lyY2xlU3R5bGUoKX1cclxuICAgICAgICAgICAgLz5cclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEJhY2tncm91bmRDaXJjbGUoKSB7XHJcbiAgICAgICAgY29uc3QgeyBoYXMsIGlzIH0gPSB0aGlzLmRldGFpbHNTdGF0dXM7XHJcbiAgICAgICAgY29uc3Qgc3R5bGUgPSB7XHJcbiAgICAgICAgICAgIHN0cm9rZVdpZHRoOiAnMXB4JyxcclxuICAgICAgICAgICAgZmlsbDogJ25vbmUnLFxyXG4gICAgICAgICAgICBzdHJva2U6ICcjOGM4YzhjJyxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAodGhpcy5wcm9wcy5yIDw9IDI2ICYmIChpcy5pZGxlIHx8ICFoYXMucHJvY2VzcykpIHtcclxuICAgICAgICAgICAgc3R5bGUuc3Ryb2tlID0gJ25vbmUnO1xyXG4gICAgICAgICAgICBzdHlsZS5vcGFjaXR5ID0gMDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiA8Y2lyY2xlIHN0eWxlPXtzdHlsZX0gY3g9e3RoaXMucHJvcHMucn0gY3k9e3RoaXMucHJvcHMucn0gcj17dGhpcy5wcm9wcy5yIC0gMX0gLz47XHJcbiAgICB9XHJcblxyXG4gICAgX3ByaW50aW5nVGV4dCgpIHtcclxuICAgICAgICBjb25zdCB7IHN0ZXAgfSA9IHRoaXMuZGV0YWlsc1N0YXR1cztcclxuICAgICAgICBjb25zdCBpc1NtYWxsSWNvbiA9IHRoaXMucHJvcHMuciA8PSAxNTtcclxuICAgICAgICBjb25zdCBpc01lZGl1bUljb24gPSB0aGlzLnByb3BzLnIgPD0gMjY7XHJcbiAgICAgICAgY29uc3Qgc21hbGxTdHlsZSA9IHsgdHJhbnNmb3JtOiAncm90YXRlKDBkZWcpJyB9O1xyXG4gICAgICAgIGNvbnN0IGxhcmdlU3R5bGUgPSBPYmplY3QuYXNzaWduKHt9LCBzbWFsbFN0eWxlLCB7XHJcbiAgICAgICAgICAgIGZvbnRTaXplOiBgJHsodGhpcy5wcm9wcy5yICogMikgLyAzfXB4YCxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaWYgKHN0ZXAucHJpbnRpbmcgJiYgaXNTbWFsbEljb24pIHtcclxuICAgICAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgICAgIDxpbWFnZVxyXG4gICAgICAgICAgICAgICAgICAgIHhsaW5rSHJlZj17cGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ2ltYWdlcy9wbGF5LnN2ZycpfVxyXG4gICAgICAgICAgICAgICAgICAgIHg9e3RoaXMucHJvcHMuciAvIDJ9XHJcbiAgICAgICAgICAgICAgICAgICAgeT17dGhpcy5wcm9wcy5yIC8gMn1cclxuICAgICAgICAgICAgICAgICAgICBoZWlnaHQ9e3RoaXMucHJvcHMucn1cclxuICAgICAgICAgICAgICAgICAgICB3aWR0aD17dGhpcy5wcm9wcy5yfVxyXG4gICAgICAgICAgICAgICAgICAgIHN0eWxlPXtzbWFsbFN0eWxlfVxyXG4gICAgICAgICAgICAgICAgLz5cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIE1lZGl1bSBzaXplIGljb25zIHNob3cgcGVyY2VudCBjb21wbGV0ZSBidXQgbm90ICclJyBzeW1ib2xcclxuICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICA8dGV4dFxyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPSdtYWtlcmJvdC1ncmV5LWZpbGwnXHJcbiAgICAgICAgICAgICAgICBzdHlsZT17bGFyZ2VTdHlsZX1cclxuICAgICAgICAgICAgICAgIHg9e3RoaXMucHJvcHMucn1cclxuICAgICAgICAgICAgICAgIHk9e3RoaXMucHJvcHMucn1cclxuICAgICAgICAgICAgICAgIGR5PScuNGVtJ1xyXG4gICAgICAgICAgICAgICAgdGV4dEFuY2hvcj0nbWlkZGxlJ1xyXG4gICAgICAgICAgICA+XHJcbiAgICAgICAgICAgICAgICA8dHNwYW4gY2xhc3NOYW1lPSd2YWx1ZSc+e3RoaXMuX3JlYWxQZXJjZW50KCl9PC90c3Bhbj5cclxuICAgICAgICAgICAgICAgIDx0c3BhbiBjbGFzc05hbWU9J3BlcmNlbnQnPntpc01lZGl1bUljb24gPyAnJyA6ICclJ308L3RzcGFuPlxyXG4gICAgICAgICAgICA8L3RleHQ+XHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBfcHJvZ3Jlc3NJY29uUHJvcHMoKSB7XHJcbiAgICAgICAgY29uc3Qgc3R5bGUgPSB7IHRyYW5zZm9ybTogJ3JvdGF0ZSgwZGVnKScgfTtcclxuICAgICAgICBjb25zdCB7IHN0ZXAsIGhhcywgaXMgfSA9IHRoaXMuZGV0YWlsc1N0YXR1cztcclxuXHJcbiAgICAgICAgaWYgKHN0ZXAuY29tcGxldGVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBpbWFnZTogJ2ltYWdlcy9wcmludC1kb25lLnN2ZycsXHJcbiAgICAgICAgICAgICAgICBzdHlsZSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChzdGVwLmJ1c3kgfHwgc3RlcC50cmFuc2ZlcnJpbmcgfHwgc3RlcC51cGRhdGluZ0Zpcm13YXJlIHx8IHN0ZXAud2lmaVNldFVwKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBpbWFnZTogJ2ltYWdlcy9nZWFycy1pY29uLnN2ZycsXHJcbiAgICAgICAgICAgICAgICBzdHlsZToge1xyXG4gICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogJ3NwaW5uZXIgMzBzIGxpbmVhciBpbmZpbml0ZScsXHJcbiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uRGlyZWN0aW9uOiAncmV2ZXJzZScsXHJcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtT3JpZ2luOiAnY2VudGVyIGNlbnRlcicsXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKFxyXG4gICAgICAgICAgICBzdGVwLmVycm9yIHx8XHJcbiAgICAgICAgICAgIGhhcy5lcnJvciB8fFxyXG4gICAgICAgICAgICBzdGVwLnN0YXJ0UHJpbnQgfHxcclxuICAgICAgICAgICAgc3RlcC5jbGVhckZpbGFtZW50IHx8XHJcbiAgICAgICAgICAgIGlzLmF1dGhlbnRpY2F0aW5nIHx8XHJcbiAgICAgICAgICAgIGlzLnVuYXV0aGVudGljYXRlZCB8fFxyXG4gICAgICAgICAgICAhaGFzLmV4dHJ1ZGVyXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBpbWFnZTogJ2ltYWdlcy9hbGVydC1pY29uLnN2ZycsXHJcbiAgICAgICAgICAgICAgICBzdHlsZSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChzdGVwLnBhdXNlZCkge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgaW1hZ2U6ICdpbWFnZXMvcGF1c2UtaWNvbi5zdmcnLFxyXG4gICAgICAgICAgICAgICAgc3R5bGUsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoaXMuaWRsZSB8fCAhaGFzLnByb2Nlc3MpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGltYWdlOiB0aGlzLmdldFByaW50ZXJJY29uKCksXHJcbiAgICAgICAgICAgICAgICBzdHlsZTogT2JqZWN0LmFzc2lnbih7fSwgc3R5bGUsIHtcclxuICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1PcmlnaW46ICdjZW50ZXInLFxyXG4gICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogYHJvdGF0ZSgwZGVnKSBzY2FsZSgyLDIpYCxcclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgaW1hZ2U6IHRoaXMuZ2V0UHJpbnRlckljb24oKSxcclxuICAgICAgICAgICAgc3R5bGUsXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRQcm9ncmVzc1RleHQoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGV0YWlsc1N0YXR1cy5zdGVwLnByaW50aW5nKSByZXR1cm4gdGhpcy5fcHJpbnRpbmdUZXh0KCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHsgaW1hZ2UsIHN0eWxlIH0gPSB0aGlzLl9wcm9ncmVzc0ljb25Qcm9wcygpO1xyXG5cclxuICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICA8aW1hZ2VcclxuICAgICAgICAgICAgICAgIHhsaW5rSHJlZj17cGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgaW1hZ2UpfVxyXG4gICAgICAgICAgICAgICAgeD17dGhpcy5wcm9wcy5yIC8gMn1cclxuICAgICAgICAgICAgICAgIHk9e3RoaXMucHJvcHMuciAvIDJ9XHJcbiAgICAgICAgICAgICAgICBoZWlnaHQ9e3RoaXMucHJvcHMucn1cclxuICAgICAgICAgICAgICAgIHdpZHRoPXt0aGlzLnByb3BzLnJ9XHJcbiAgICAgICAgICAgICAgICBzdHlsZT17c3R5bGV9XHJcbiAgICAgICAgICAgIC8+XHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICByZW5kZXIoKSB7XHJcbiAgICAgICAgY29uc3Qgd2lkdGggPSB0aGlzLnByb3BzLnIgKiAyO1xyXG4gICAgICAgIGNvbnN0IGhlaWdodCA9IHRoaXMucHJvcHMuciAqIDI7XHJcbiAgICAgICAgY29uc3Qgdmlld0JveCA9IGAwIDAgJHt3aWR0aH0gJHtoZWlnaHR9YDtcclxuXHJcbiAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgPHN2Z1xyXG4gICAgICAgICAgICAgICAgey4uLk9iamVjdC5hc3NpZ24oe30sIHRoaXMucHJvcHMsIHtcclxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICdDaXJjdWxhclByb2dyZXNzJyxcclxuICAgICAgICAgICAgICAgICAgICB3aWR0aCxcclxuICAgICAgICAgICAgICAgICAgICBoZWlnaHQsXHJcbiAgICAgICAgICAgICAgICAgICAgdmlld0JveCxcclxuICAgICAgICAgICAgICAgIH0pfVxyXG4gICAgICAgICAgICA+XHJcbiAgICAgICAgICAgICAgICB7dGhpcy5nZXRCYWNrZ3JvdW5kQ2lyY2xlKCl9XHJcbiAgICAgICAgICAgICAgICB7dGhpcy5nZXRQcm9ncmVzc0NpcmNsZSgpfVxyXG4gICAgICAgICAgICAgICAge3RoaXMuZ2V0UHJvZ3Jlc3NUZXh0KCl9XHJcbiAgICAgICAgICAgIDwvc3ZnPlxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcbn1cclxuXHJcblByaW50UHJvZ3Jlc3NCYWRnZS5kZWZhdWx0UHJvcHMgPSB7XHJcbiAgICByOiA1MCxcclxuICAgIHN0cm9rZVdpZHRoOiAxLFxyXG59O1xyXG5cclxuUHJpbnRQcm9ncmVzc0JhZGdlLnByb3BUeXBlcyA9IE9iamVjdC5hc3NpZ24oe30sIFByaW50UHJvZ3Jlc3NCYWRnZS5wcm9wVHlwZXMsIHtcclxuICAgIHByaW50ZXI6IFJlYWN0LlByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcclxuICAgIHN0cm9rZVdpZHRoOiBSZWFjdC5Qcm9wVHlwZXMubnVtYmVyLFxyXG4gICAgcjogUmVhY3QuUHJvcFR5cGVzLm51bWJlcixcclxufSk7XHJcblxyXG5jb25zdCBkYXNoQXJyYXkgPSAociwgcGVyYykgPT4ge1xyXG4gICAgY29uc3QgZGFzaCA9IHIgKiBNYXRoLlBJICogMiAqIChwZXJjIC8gMTAwKTtcclxuICAgIHJldHVybiBgJHtkYXNofSwgJHtyICogTWF0aC5QSSAqIDR9YDtcclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gUHJpbnRQcm9ncmVzc0JhZGdlO1xyXG4iXX0=
