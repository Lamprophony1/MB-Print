'use strict';

const React = require('react');

const ce = React.createElement;
const DOM = React.DOM;

const R = require('ramda');

const TextInput = require('eagle-print/views/ui/input_text');

const Button = require('eagle-print/views/ui/button');

const FluxComponent = require('eagle-print/views/flux_component');

const {
  rangeStep,
  roundPrec
} = require('../../../util');

class Increment extends FluxComponent {
  constructor(props) {
    super(props);
  }

  _range() {
    return R.map(x => this._normalize(this.props.step, x), rangeStep(this.props.step, this.props.min, this.props.max + this.props.step));
  }

  _precision(step) {
    const log = -Math.log10(step);
    return log > 0 ? Math.ceil(log) : Math.floor(log);
  }

  _normalize(step, val) {
    return roundPrec(this._precision(step), val);
  }

  round(val) {
    // padding with a 0 in case use types '.2' intead of '0.2'
    if (isNaN(parseInt(`0${val}`))) {
      return this.props.value;
    }

    const rounded = this._normalize(this.props.step, val);

    if (rounded > this.props.max) {
      return this.props.max;
    }

    const gteList = R.filter(x => x >= rounded, this._range());

    if (gteList.length > 0) {
      return R.reduce(R.min, R.head(gteList), gteList);
    }

    return R.pipe(R.filter(x => x <= rounded), R.reduce(R.max, 0))(this._range());
  }

  _renderButton(positive) {
    return ce(Button, {
      tabIndex: -1,
      svgSrc: positive ? 'icons/plus-button.svg' : 'icons/minus-button.svg',
      disabled: this.props.disabled,
      onClick: () => {
        const oldVal = Number(this.props.value);
        let newVal;

        if (positive) {
          newVal = oldVal + this.props.step;
        } else {
          newVal = oldVal - this.props.step;
        }

        return this.props.onChange(this.round(newVal));
      }
    });
  }

  onBlur(val) {
    this.props.onChange(this.round(val));
  }

  render() {
    return DOM.div({
      className: 'increment-row'
    }, // DOM.span({}, this.props.title),
    ce(TextInput, {
      id: this.props.name,
      name: this.props.name,
      clearOnFocus: false,
      placeholder: `${this.props.format(this.props.value)}`,
      disabled: this.props.disabled,
      // onChange: (val) => this.props.onChange(this.round(val)),
      onFocus: (data, element) => {
        element.target.placeholder = '';
      },
      onBlur: (data, element) => {
        element.target.placeholder = `${this.props.format(this.props.value)}`;
      },
      onEnterKeyPress: (val, element) => {
        element.target.blur();
        const v = this.props.sanitize(val);
        this.props.onChange(this.round(v));
      },
      value: this.props.value // validate: (val) => !isNaN(val)

    }), this._renderButton(false), // - button
    this._renderButton(true) // + button
    );
  }

}

Increment.displayName = 'Increment';
Increment.propTypes = {
  name: React.PropTypes.string.isRequired,
  title: React.PropTypes.string.isRequired,
  value: React.PropTypes.number.isRequired,
  sanitize: React.PropTypes.func.isRequired,
  format: React.PropTypes.func.isRequired,
  step: React.PropTypes.number.isRequired,
  type: React.PropTypes.string.isRequired,
  min: React.PropTypes.number,
  max: React.PropTypes.number,
  units: React.PropTypes.string,
  onChange: React.PropTypes.func
};
Increment.defaultProps = {
  onChange: () => {}
};
module.exports = Increment;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluY3JlbWVudC5qcyJdLCJuYW1lcyI6WyJSZWFjdCIsInJlcXVpcmUiLCJjZSIsImNyZWF0ZUVsZW1lbnQiLCJET00iLCJSIiwiVGV4dElucHV0IiwiQnV0dG9uIiwiRmx1eENvbXBvbmVudCIsInJhbmdlU3RlcCIsInJvdW5kUHJlYyIsIkluY3JlbWVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJfcmFuZ2UiLCJtYXAiLCJ4IiwiX25vcm1hbGl6ZSIsInN0ZXAiLCJtaW4iLCJtYXgiLCJfcHJlY2lzaW9uIiwibG9nIiwiTWF0aCIsImxvZzEwIiwiY2VpbCIsImZsb29yIiwidmFsIiwicm91bmQiLCJpc05hTiIsInBhcnNlSW50IiwidmFsdWUiLCJyb3VuZGVkIiwiZ3RlTGlzdCIsImZpbHRlciIsImxlbmd0aCIsInJlZHVjZSIsImhlYWQiLCJwaXBlIiwiX3JlbmRlckJ1dHRvbiIsInBvc2l0aXZlIiwidGFiSW5kZXgiLCJzdmdTcmMiLCJkaXNhYmxlZCIsIm9uQ2xpY2siLCJvbGRWYWwiLCJOdW1iZXIiLCJuZXdWYWwiLCJvbkNoYW5nZSIsIm9uQmx1ciIsInJlbmRlciIsImRpdiIsImNsYXNzTmFtZSIsImlkIiwibmFtZSIsImNsZWFyT25Gb2N1cyIsInBsYWNlaG9sZGVyIiwiZm9ybWF0Iiwib25Gb2N1cyIsImRhdGEiLCJlbGVtZW50IiwidGFyZ2V0Iiwib25FbnRlcktleVByZXNzIiwiYmx1ciIsInYiLCJzYW5pdGl6ZSIsImRpc3BsYXlOYW1lIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwic3RyaW5nIiwiaXNSZXF1aXJlZCIsInRpdGxlIiwibnVtYmVyIiwiZnVuYyIsInR5cGUiLCJ1bml0cyIsImRlZmF1bHRQcm9wcyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsTUFBTUMsRUFBRSxHQUFHRixLQUFLLENBQUNHLGFBQWpCO0FB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LEtBQUssQ0FBQ29FLFNBQU4sQ0FBZ0JDLE1BQWhCLENBQXVCQyxVQURYO0FBRWxCQyxFQUFBQSxLQUFLLEVBQUV2RSxLQUFLLENBQUNvRSxTQUFOLENBQWdCQyxNQUFoQixDQUF1QkMsVUFGWjtBQUdsQnZDLEVBQUFBLEtBQUssRUFBRS9CLEtBQUssQ0FBQ29FLFNBQU4sQ0FBZ0JJLE1BQWhCLENBQXVCRixVQUhaO0FBSWxCTCxFQUFBQSxRQUFRLEVBQUVqRSxLQUFLLENBQUNvRSxTQUFOLENBQWdCSyxJQUFoQixDQUFxQkgsVUFKYjtBQUtsQmIsRUFBQUEsTUFBTSxFQUFFekQsS0FBSyxDQUFDb0UsU0FBTixDQUFnQkssSUFBaEIsQ0FBcUJILFVBTFg7QUFNbEJwRCxFQUFBQSxJQUFJLEVBQUVsQixLQUFLLENBQUNvRSxTQUFOLENBQWdCSSxNQUFoQixDQUF1QkYsVUFOWDtBQU9sQkksRUFBQUEsSUFBSSxFQUFFMUUsS0FBSyxDQUFDb0UsU0FBTixDQUFnQkMsTUFBaEIsQ0FBdUJDLFVBUFg7QUFRbEJuRCxFQUFBQSxHQUFHLEVBQUVuQixLQUFLLENBQUNvRSxTQUFOLENBQWdCSSxNQVJIO0FBU2xCcEQsRUFBQUEsR0FBRyxFQUFFcEIsS0FBSyxDQUFDb0UsU0FBTixDQUFnQkksTUFUSDtBQVVsQkcsRUFBQUEsS0FBSyxFQUFFM0UsS0FBSyxDQUFDb0UsU0FBTixDQUFnQkMsTUFWTDtBQVdsQnJCLEVBQUFBLFFBQVEsRUFBRWhELEtBQUssQ0FBQ29FLFNBQU4sQ0FBZ0JLO0FBWFIsQ0FBdEI7QUFjQTlELFNBQVMsQ0FBQ2lFLFlBQVYsR0FBeUI7QUFDckI1QixFQUFBQSxRQUFRLEVBQUUsTUFBTSxDQUFFO0FBREcsQ0FBekI7QUFJQTZCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQm5FLFNBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgUmVhY3QgPSByZXF1aXJlKCdyZWFjdCcpO1xyXG5jb25zdCBjZSA9IFJlYWN0LmNyZWF0ZUVsZW1lbnQ7XHJcbmNvbnN0IERPTSA9IFJlYWN0LkRPTTtcclxuY29uc3QgUiA9IHJlcXVpcmUoJ3JhbWRhJyk7XHJcbmNvbnN0IFRleHRJbnB1dCA9IHJlcXVpcmUoJ2VhZ2xlLXByaW50L3ZpZXdzL3VpL2lucHV0X3RleHQnKTtcclxuY29uc3QgQnV0dG9uID0gcmVxdWlyZSgnZWFnbGUtcHJpbnQvdmlld3MvdWkvYnV0dG9uJyk7XHJcbmNvbnN0IEZsdXhDb21wb25lbnQgPSByZXF1aXJlKCdlYWdsZS1wcmludC92aWV3cy9mbHV4X2NvbXBvbmVudCcpO1xyXG5cclxuY29uc3QgeyByYW5nZVN0ZXAsIHJvdW5kUHJlYyB9ID0gcmVxdWlyZSgnLi4vLi4vLi4vdXRpbCcpO1xyXG5cclxuY2xhc3MgSW5jcmVtZW50IGV4dGVuZHMgRmx1eENvbXBvbmVudCB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcm9wcykge1xyXG4gICAgICAgIHN1cGVyKHByb3BzKTtcclxuICAgIH1cclxuXHJcbiAgICBfcmFuZ2UoKSB7XHJcbiAgICAgICAgcmV0dXJuIFIubWFwKFxyXG4gICAgICAgICAgICB4ID0+IHRoaXMuX25vcm1hbGl6ZSh0aGlzLnByb3BzLnN0ZXAsIHgpLFxyXG4gICAgICAgICAgICByYW5nZVN0ZXAodGhpcy5wcm9wcy5zdGVwLCB0aGlzLnByb3BzLm1pbiwgdGhpcy5wcm9wcy5tYXggKyB0aGlzLnByb3BzLnN0ZXApXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBfcHJlY2lzaW9uKHN0ZXApIHtcclxuICAgICAgICBjb25zdCBsb2cgPSAtTWF0aC5sb2cxMChzdGVwKTtcclxuICAgICAgICByZXR1cm4gbG9nID4gMCA/IE1hdGguY2VpbChsb2cpIDogTWF0aC5mbG9vcihsb2cpO1xyXG4gICAgfVxyXG5cclxuICAgIF9ub3JtYWxpemUoc3RlcCwgdmFsKSB7XHJcbiAgICAgICAgcmV0dXJuIHJvdW5kUHJlYyh0aGlzLl9wcmVjaXNpb24oc3RlcCksIHZhbCk7XHJcbiAgICB9XHJcblxyXG4gICAgcm91bmQodmFsKSB7XHJcbiAgICAgICAgLy8gcGFkZGluZyB3aXRoIGEgMCBpbiBjYXNlIHVzZSB0eXBlcyAnLjInIGludGVhZCBvZiAnMC4yJ1xyXG4gICAgICAgIGlmIChpc05hTihwYXJzZUludChgMCR7dmFsfWApKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy52YWx1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHJvdW5kZWQgPSB0aGlzLl9ub3JtYWxpemUodGhpcy5wcm9wcy5zdGVwLCB2YWwpO1xyXG5cclxuICAgICAgICBpZiAocm91bmRlZCA+IHRoaXMucHJvcHMubWF4KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLm1heDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGd0ZUxpc3QgPSBSLmZpbHRlcih4ID0+IHggPj0gcm91bmRlZCwgdGhpcy5fcmFuZ2UoKSk7XHJcbiAgICAgICAgaWYgKGd0ZUxpc3QubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gUi5yZWR1Y2UoUi5taW4sIFIuaGVhZChndGVMaXN0KSwgZ3RlTGlzdCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gUi5waXBlKFxyXG4gICAgICAgICAgICBSLmZpbHRlcih4ID0+IHggPD0gcm91bmRlZCksXHJcbiAgICAgICAgICAgIFIucmVkdWNlKFIubWF4LCAwKVxyXG4gICAgICAgICkodGhpcy5fcmFuZ2UoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgX3JlbmRlckJ1dHRvbihwb3NpdGl2ZSkge1xyXG4gICAgICAgIHJldHVybiBjZShCdXR0b24sIHtcclxuICAgICAgICAgICAgdGFiSW5kZXg6IC0xLFxyXG4gICAgICAgICAgICBzdmdTcmM6IHBvc2l0aXZlID8gJ2ljb25zL3BsdXMtYnV0dG9uLnN2ZycgOiAnaWNvbnMvbWludXMtYnV0dG9uLnN2ZycsXHJcbiAgICAgICAgICAgIGRpc2FibGVkOiB0aGlzLnByb3BzLmRpc2FibGVkLFxyXG4gICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvbGRWYWwgPSBOdW1iZXIodGhpcy5wcm9wcy52YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBsZXQgbmV3VmFsO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChwb3NpdGl2ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld1ZhbCA9IG9sZFZhbCArIHRoaXMucHJvcHMuc3RlcDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3VmFsID0gb2xkVmFsIC0gdGhpcy5wcm9wcy5zdGVwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLm9uQ2hhbmdlKHRoaXMucm91bmQobmV3VmFsKSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgb25CbHVyKHZhbCkge1xyXG4gICAgICAgIHRoaXMucHJvcHMub25DaGFuZ2UodGhpcy5yb3VuZCh2YWwpKTtcclxuICAgIH1cclxuXHJcbiAgICByZW5kZXIoKSB7XHJcbiAgICAgICAgcmV0dXJuIERPTS5kaXYoXHJcbiAgICAgICAgICAgIHsgY2xhc3NOYW1lOiAnaW5jcmVtZW50LXJvdycgfSxcclxuICAgICAgICAgICAgLy8gRE9NLnNwYW4oe30sIHRoaXMucHJvcHMudGl0bGUpLFxyXG4gICAgICAgICAgICBjZShUZXh0SW5wdXQsIHtcclxuICAgICAgICAgICAgICAgIGlkOiB0aGlzLnByb3BzLm5hbWUsXHJcbiAgICAgICAgICAgICAgICBuYW1lOiB0aGlzLnByb3BzLm5hbWUsXHJcbiAgICAgICAgICAgICAgICBjbGVhck9uRm9jdXM6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6IGAke3RoaXMucHJvcHMuZm9ybWF0KHRoaXMucHJvcHMudmFsdWUpfWAsXHJcbiAgICAgICAgICAgICAgICBkaXNhYmxlZDogdGhpcy5wcm9wcy5kaXNhYmxlZCxcclxuICAgICAgICAgICAgICAgIC8vIG9uQ2hhbmdlOiAodmFsKSA9PiB0aGlzLnByb3BzLm9uQ2hhbmdlKHRoaXMucm91bmQodmFsKSksXHJcbiAgICAgICAgICAgICAgICBvbkZvY3VzOiAoZGF0YSwgZWxlbWVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudGFyZ2V0LnBsYWNlaG9sZGVyID0gJyc7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgb25CbHVyOiAoZGF0YSwgZWxlbWVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudGFyZ2V0LnBsYWNlaG9sZGVyID0gYCR7dGhpcy5wcm9wcy5mb3JtYXQodGhpcy5wcm9wcy52YWx1ZSl9YDtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBvbkVudGVyS2V5UHJlc3M6ICh2YWwsIGVsZW1lbnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnRhcmdldC5ibHVyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdiA9IHRoaXMucHJvcHMuc2FuaXRpemUodmFsKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb3BzLm9uQ2hhbmdlKHRoaXMucm91bmQodikpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLnByb3BzLnZhbHVlLFxyXG4gICAgICAgICAgICAgICAgLy8gdmFsaWRhdGU6ICh2YWwpID0+ICFpc05hTih2YWwpXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICB0aGlzLl9yZW5kZXJCdXR0b24oZmFsc2UpLCAvLyAtIGJ1dHRvblxyXG4gICAgICAgICAgICB0aGlzLl9yZW5kZXJCdXR0b24odHJ1ZSkgLy8gKyBidXR0b25cclxuICAgICAgICApO1xyXG4gICAgfVxyXG59XHJcblxyXG5JbmNyZW1lbnQuZGlzcGxheU5hbWUgPSAnSW5jcmVtZW50JztcclxuSW5jcmVtZW50LnByb3BUeXBlcyA9IHtcclxuICAgIG5hbWU6IFJlYWN0LlByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcclxuICAgIHRpdGxlOiBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXHJcbiAgICB2YWx1ZTogUmVhY3QuUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLFxyXG4gICAgc2FuaXRpemU6IFJlYWN0LlByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXHJcbiAgICBmb3JtYXQ6IFJlYWN0LlByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXHJcbiAgICBzdGVwOiBSZWFjdC5Qcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsXHJcbiAgICB0eXBlOiBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXHJcbiAgICBtaW46IFJlYWN0LlByb3BUeXBlcy5udW1iZXIsXHJcbiAgICBtYXg6IFJlYWN0LlByb3BUeXBlcy5udW1iZXIsXHJcbiAgICB1bml0czogUmVhY3QuUHJvcFR5cGVzLnN0cmluZyxcclxuICAgIG9uQ2hhbmdlOiBSZWFjdC5Qcm9wVHlwZXMuZnVuYyxcclxufTtcclxuXHJcbkluY3JlbWVudC5kZWZhdWx0UHJvcHMgPSB7XHJcbiAgICBvbkNoYW5nZTogKCkgPT4ge30sXHJcbn07XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IEluY3JlbWVudDtcclxuIl19
