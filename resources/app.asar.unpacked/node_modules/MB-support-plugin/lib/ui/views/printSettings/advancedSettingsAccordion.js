"use strict";

const React = require('react');

const Immutable = require('immutable');

const FluxComponent = require('eagle-print/views/flux_component');

const PrintSettingsConstants = require('../../../constants/print_settings');

const Transitions = Immutable.Map({
  WebkitTransition: 'webkitTransitionEnd',
  MozTransition: 'transitionend',
  OTransition: 'oTransitionEnd otransitionend',
  transition: 'transitionend'
});

class Accordion extends FluxComponent {
  constructor(props) {
    super(props);
    this.state = {
      isClosed: !this.props.open,
      shouldSwitchAutoOnNextCycle: false,
      height: 'auto',
      transition: 'none',
      hasBeenOpened: true
    };
  } // Taken from https://github.com/EvandroLG/transitionEnd/
  // Determines which prefixed event to listen for


  whichTransitionEnd(element) {
    return Transitions.filter((v, k) => element.style[k] != null).toArray();
  }

  componentDidMount() {
    this.refs.outer.addEventListener(this.whichTransitionEnd(this.refs.outer), this.onTransitionEnd.bind(this));
  }

  componentWillUnmount() {
    this.refs.outer.removeEventListener(this.whichTransitionEnd(this.refs.outer), this.onTransitionEnd.bind(this));
  }

  componentDidUpdate(prevProps) {
    if (this.state.shouldSwitchAutoOnNextCycle === true && this.state.isClosed === false) {
      //Set the height to auto to make compoenent re-render with the height set to auto.
      //This way the dropdown will be responsive and also change height if there is another dropdown within it.
      this.makeResponsive();
    }

    if (this.state.shouldSwitchAutoOnNextCycle === true && this.state.isClosed === true) {
      this.prepareToOpen();
    } //If there has been a change in the open prop (controlled by accordion)


    if (prevProps.open !== this.props.open) {
      console.log('Open state changed!', this.props.accordionPosition);

      if (this.props.open === true) {
        this.openAccordion();
      } else {
        this.closeAccordion();
      }
    }
  }

  onTransitionEnd() {
    if (!this.state.isClosed) {
      this.setState({
        shouldSwitchAutoOnNextCycle: true
      });
    }
  }

  handleTriggerClick(event) {
    event.preventDefault();

    if (this.props.handleTriggerClick) {
      this.props.handleTriggerClick(this.props.accordionPosition);
    } else {
      if (this.state.isClosed === true) {
        this.openAccordion();
      } else {
        this.closeAccordion();
      }
    }
  }

  closeAccordion() {
    this.setState({
      isClosed: true,
      shouldSwitchAutoOnNextCycle: true,
      height: this.refs.inner.offsetHeight
    });
  }

  openAccordion() {
    this.setState({
      height: this.refs.inner.offsetHeight,
      transition: `height ${this.props.transitionTime}ms ${this.props.easing}`,
      isClosed: false,
      hasBeenOpened: true
    });
  }

  makeResponsive() {
    this.setState({
      height: 'auto',
      transition: 'none',
      shouldSwitchAutoOnNextCycle: false
    });
  }

  prepareToOpen() {
    //The height has been changes back to fixed pixel, we set a small timeout to force the CSS transition back to 0 on the next tick.
    window.setTimeout(() => {
      this.setState({
        height: 0,
        shouldSwitchAutoOnNextCycle: false,
        transition: `height ${this.props.transitionTime}ms ${this.props.easing}`
      });
    }, 50);
  }

  handleSelectArrowToggle() {
    this.state.isClosed ? this.setState({
      isClosed: false
    }) : this.setState({
      isClosed: true
    });
  }

  renderArrow() {
    return /*#__PURE__*/React.createElement("div", {
      className: "Select-arrow",
      onClick: () => this.handleSelectArrowToggle()
    });
  }

  render() {
    const dropdownStyle = {
      height: this.state.height,
      WebkitTransition: this.state.transition,
      msTransition: this.state.transition,
      transition: this.state.transition,
      overflow: this.state.overflow
    };
    const openClass = this.state.isClosed ? 'is-closed' : 'is-open'; // If user wants different text when tray is open

    const trigger = this.state.isClosed === false && this.props.triggerWhenOpen !== undefined ? this.props.triggerWhenOpen : this.props.trigger; // Don't render children until the first opening of the Accordion if lazy rendering is enabled

    let children = this.props.children;

    if (this.props.lazyRender && !this.state.hasBeenOpened) {
      children = null;
    }

    return /*#__PURE__*/React.createElement("div", {
      className: `${this.props.classParentString}`
    }, /*#__PURE__*/React.createElement("div", {
      className: `${this.props.classParentString} panel-accordion__trigger ${openClass}`,
      onClick: event => this.handleTriggerClick(event)
    }, PrintSettingsConstants.DisplayKeys[trigger], this.renderArrow()), /*#__PURE__*/React.createElement("div", {
      className: `${this.props.classParentString} panel-accordion__contentOuter ${openClass}`,
      ref: "outer",
      style: dropdownStyle
    }, /*#__PURE__*/React.createElement("div", {
      className: `${this.props.classParentString} panel-accordion__contentInner`,
      ref: "inner"
    }, children)));
  }

}

Accordion.displayName = 'Accordion';
Accordion.propTypes = {
  transitionTime: React.PropTypes.number,
  easing: React.PropTypes.string,
  open: React.PropTypes.bool,
  classParentString: React.PropTypes.string,
  accordionPosition: React.PropTypes.number,
  handleTriggerClick: React.PropTypes.func,
  trigger: React.PropTypes.oneOfType([React.PropTypes.string, React.PropTypes.element]),
  triggerWhenOpen: React.PropTypes.oneOfType([React.PropTypes.string, React.PropTypes.element]),
  lazyRender: React.PropTypes.bool
};
Accordion.defaultProps = {
  transitionTime: 400,
  easing: 'linear',
  open: true,
  classParentString: 'Accordion',
  lazyRender: false
};
module.exports = Accordion;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFkdmFuY2VkU2V0dGluZ3NBY2NvcmRpb24uanMiXSwibmFtZXMiOlsiUmVhY3QiLCJyZXF1aXJlIiwiSW1tdXRhYmxlIiwiRmx1eENvbXBvbmVudCIsIlByaW50U2V0dGluZ3NDb25zdGFudHMiLCJUcmFuc2l0aW9ucyIsIk1hcCIsIldlYmtpdFRyYW5zaXRpb24iLCJNb3pUcmFuc2l0aW9uIiwiT1RyYW5zaXRpb24iLCJ0cmFuc2l0aW9uIiwiQWNjb3JkaW9uIiwiY29uc3RydWN0b3IiLCJwcm9wcyIsInN0YXRlIiwiaXNDbG9zZWQiLCJvcGVuIiwic2hvdWxkU3dpdGNoQXV0b09uTmV4dEN5Y2xlIiwiaGVpZ2h0IiwiaGFzQmVlbk9wZW5lZCIsIndoaWNoVHJhbnNpdGlvbkVuZCIsImVsZW1lbnQiLCJmaWx0ZXIiLCJ2IiwiayIsInN0eWxlIiwidG9BcnJheSIsImNvbXBvbmVudERpZE1vdW50IiwicmVmcyIsIm91dGVyIiwiYWRkRXZlbnRMaXN0ZW5lciIsIm9uVHJhbnNpdGlvbkVuZCIsImJpbmQiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJjb21wb25lbnREaWRVcGRhdGUiLCJwcmV2UHJvcHMiLCJtYWtlUmVzcG9uc2l2ZSIsInByZXBhcmVUb09wZW4iLCJjb25zb2xlIiwibG9nIiwiYWNjb3JkaW9uUG9zaXRpb24iLCJvcGVuQWNjb3JkaW9uIiwiY2xvc2VBY2NvcmRpb24iLCJzZXRTdGF0ZSIsImhhbmRsZVRyaWdnZXJDbGljayIsImV2ZW50IiwicHJldmVudERlZmF1bHQiLCJpbm5lciIsIm9mZnNldEhlaWdodCIsInRyYW5zaXRpb25UaW1lIiwiZWFzaW5nIiwid2luZG93Iiwic2V0VGltZW91dCIsImhhbmRsZVNlbGVjdEFycm93VG9nZ2xlIiwicmVuZGVyQXJyb3ciLCJyZW5kZXIiLCJkcm9wZG93blN0eWxlIiwibXNUcmFuc2l0aW9uIiwib3ZlcmZsb3ciLCJvcGVuQ2xhc3MiLCJ0cmlnZ2VyIiwidHJpZ2dlcldoZW5PcGVuIiwidW5kZWZpbmVkIiwiY2hpbGRyZW4iLCJsYXp5UmVuZGVyIiwiY2xhc3NQYXJlbnRTdHJpbmciLCJEaXNwbGF5S2V5cyIsImRpc3BsYXlOYW1lIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwibnVtYmVyIiwic3RyaW5nIiwiYm9vbCIsImZ1bmMiLCJvbmVPZlR5cGUiLCJkZWZhdWx0UHJvcHMiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsTUFBTUMsU0FBUyxHQUFHRCxPQUFPLENBQUMsV0FBRCxDQUF6Qjs7QUFDQSxNQUFNRSxhQUFhLEdBQUdGLE9BQU8sQ0FBQyxrQ0FBRCxDQUE3Qjs7QUFFQSxNQUFNRyxzQkFBc0IsR0FBR0gsT0FBTyxDQUFDLG1DQUFELENBQXRDOztBQUVBLE1BQU1JLFdBQVcsR0FBR0gsU0FBUyxDQUFDSSxHQUFWLENBQWM7QUFDOUJDLEVBQUFBLGdCQUFnQixFQUFFLHFCQURZO0FBRTlCQyxFQUFBQSxhQUFhLEVBQUUsZUFGZTtBQUc5QkMsRUFBQUEsV0FBVyxFQUFFLCtCQUhpQjtBQUk5QkMsRUFBQUEsVUFBVSxFQUFFO0FBSmtCLENBQWQsQ0FBcEI7O0FBT0EsTUFBTUMsU0FBTixTQUF3QlIsYUFBeEIsQ0FBc0M7QUFDbENTLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFRO0FBQ2YsVUFBTUEsS0FBTjtBQUNBLFNBQUtDLEtBQUwsR0FBYTtBQUNUQyxNQUFBQSxRQUFRLEVBQUUsQ0FBQyxLQUFLRixLQUFMLENBQVdHLElBRGI7QUFFVEMsTUFBQUEsMkJBQTJCLEVBQUUsS0FGcEI7QUFHVEMsTUFBQUEsTUFBTSxFQUFFLE1BSEM7QUFJVFIsTUFBQUEsVUFBVSxFQUFFLE1BSkg7QUFLVFMsTUFBQUEsYUFBYSxFQUFFO0FBTE4sS0FBYjtBQU9ILEdBVmlDLENBWWxDO0FBQ0E7OztBQUNBQyxFQUFBQSxrQkFBa0IsQ0FBQ0MsT0FBRCxFQUFV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Q0FSQztBQVNsQjRDLEVBQUFBLFVBQVUsRUFBRWpFLEtBQUssQ0FBQ3NFLFNBQU4sQ0FBZ0JHO0FBVFYsQ0FBdEI7QUFZQTlELFNBQVMsQ0FBQ2lFLFlBQVYsR0FBeUI7QUFDckIxQixFQUFBQSxjQUFjLEVBQUUsR0FESztBQUVyQkMsRUFBQUEsTUFBTSxFQUFFLFFBRmE7QUFHckJuQyxFQUFBQSxJQUFJLEVBQUUsSUFIZTtBQUlyQmtELEVBQUFBLGlCQUFpQixFQUFFLFdBSkU7QUFLckJELEVBQUFBLFVBQVUsRUFBRTtBQUxTLENBQXpCO0FBUUFZLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQm5FLFNBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgUmVhY3QgPSByZXF1aXJlKCdyZWFjdCcpO1xyXG5jb25zdCBJbW11dGFibGUgPSByZXF1aXJlKCdpbW11dGFibGUnKTtcclxuY29uc3QgRmx1eENvbXBvbmVudCA9IHJlcXVpcmUoJ2VhZ2xlLXByaW50L3ZpZXdzL2ZsdXhfY29tcG9uZW50Jyk7XHJcblxyXG5jb25zdCBQcmludFNldHRpbmdzQ29uc3RhbnRzID0gcmVxdWlyZSgnLi4vLi4vLi4vY29uc3RhbnRzL3ByaW50X3NldHRpbmdzJyk7XHJcblxyXG5jb25zdCBUcmFuc2l0aW9ucyA9IEltbXV0YWJsZS5NYXAoe1xyXG4gICAgV2Via2l0VHJhbnNpdGlvbjogJ3dlYmtpdFRyYW5zaXRpb25FbmQnLFxyXG4gICAgTW96VHJhbnNpdGlvbjogJ3RyYW5zaXRpb25lbmQnLFxyXG4gICAgT1RyYW5zaXRpb246ICdvVHJhbnNpdGlvbkVuZCBvdHJhbnNpdGlvbmVuZCcsXHJcbiAgICB0cmFuc2l0aW9uOiAndHJhbnNpdGlvbmVuZCcsXHJcbn0pO1xyXG5cclxuY2xhc3MgQWNjb3JkaW9uIGV4dGVuZHMgRmx1eENvbXBvbmVudCB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcm9wcykge1xyXG4gICAgICAgIHN1cGVyKHByb3BzKTtcclxuICAgICAgICB0aGlzLnN0YXRlID0ge1xyXG4gICAgICAgICAgICBpc0Nsb3NlZDogIXRoaXMucHJvcHMub3BlbixcclxuICAgICAgICAgICAgc2hvdWxkU3dpdGNoQXV0b09uTmV4dEN5Y2xlOiBmYWxzZSxcclxuICAgICAgICAgICAgaGVpZ2h0OiAnYXV0bycsXHJcbiAgICAgICAgICAgIHRyYW5zaXRpb246ICdub25lJyxcclxuICAgICAgICAgICAgaGFzQmVlbk9wZW5lZDogdHJ1ZSxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFRha2VuIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL0V2YW5kcm9MRy90cmFuc2l0aW9uRW5kL1xyXG4gICAgLy8gRGV0ZXJtaW5lcyB3aGljaCBwcmVmaXhlZCBldmVudCB0byBsaXN0ZW4gZm9yXHJcbiAgICB3aGljaFRyYW5zaXRpb25FbmQoZWxlbWVudCkge1xyXG4gICAgICAgIHJldHVybiBUcmFuc2l0aW9ucy5maWx0ZXIoKHYsIGspID0+IGVsZW1lbnQuc3R5bGVba10gIT0gbnVsbCkudG9BcnJheSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xyXG4gICAgICAgIHRoaXMucmVmcy5vdXRlci5hZGRFdmVudExpc3RlbmVyKHRoaXMud2hpY2hUcmFuc2l0aW9uRW5kKHRoaXMucmVmcy5vdXRlciksIHRoaXMub25UcmFuc2l0aW9uRW5kLmJpbmQodGhpcykpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xyXG4gICAgICAgIHRoaXMucmVmcy5vdXRlci5yZW1vdmVFdmVudExpc3RlbmVyKHRoaXMud2hpY2hUcmFuc2l0aW9uRW5kKHRoaXMucmVmcy5vdXRlciksIHRoaXMub25UcmFuc2l0aW9uRW5kLmJpbmQodGhpcykpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMpIHtcclxuICAgICAgICBpZiAodGhpcy5zdGF0ZS5zaG91bGRTd2l0Y2hBdXRvT25OZXh0Q3ljbGUgPT09IHRydWUgJiYgdGhpcy5zdGF0ZS5pc0Nsb3NlZCA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgLy9TZXQgdGhlIGhlaWdodCB0byBhdXRvIHRvIG1ha2UgY29tcG9lbmVudCByZS1yZW5kZXIgd2l0aCB0aGUgaGVpZ2h0IHNldCB0byBhdXRvLlxyXG4gICAgICAgICAgICAvL1RoaXMgd2F5IHRoZSBkcm9wZG93biB3aWxsIGJlIHJlc3BvbnNpdmUgYW5kIGFsc28gY2hhbmdlIGhlaWdodCBpZiB0aGVyZSBpcyBhbm90aGVyIGRyb3Bkb3duIHdpdGhpbiBpdC5cclxuICAgICAgICAgICAgdGhpcy5tYWtlUmVzcG9uc2l2ZSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuc2hvdWxkU3dpdGNoQXV0b09uTmV4dEN5Y2xlID09PSB0cnVlICYmIHRoaXMuc3RhdGUuaXNDbG9zZWQgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgdGhpcy5wcmVwYXJlVG9PcGVuKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL0lmIHRoZXJlIGhhcyBiZWVuIGEgY2hhbmdlIGluIHRoZSBvcGVuIHByb3AgKGNvbnRyb2xsZWQgYnkgYWNjb3JkaW9uKVxyXG4gICAgICAgIGlmIChwcmV2UHJvcHMub3BlbiAhPT0gdGhpcy5wcm9wcy5vcGVuKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdPcGVuIHN0YXRlIGNoYW5nZWQhJywgdGhpcy5wcm9wcy5hY2NvcmRpb25Qb3NpdGlvbik7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5wcm9wcy5vcGVuID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9wZW5BY2NvcmRpb24oKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VBY2NvcmRpb24oKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBvblRyYW5zaXRpb25FbmQoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLmlzQ2xvc2VkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xyXG4gICAgICAgICAgICAgICAgc2hvdWxkU3dpdGNoQXV0b09uTmV4dEN5Y2xlOiB0cnVlLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaGFuZGxlVHJpZ2dlckNsaWNrKGV2ZW50KSB7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMucHJvcHMuaGFuZGxlVHJpZ2dlckNsaWNrKSB7XHJcbiAgICAgICAgICAgIHRoaXMucHJvcHMuaGFuZGxlVHJpZ2dlckNsaWNrKHRoaXMucHJvcHMuYWNjb3JkaW9uUG9zaXRpb24pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLmlzQ2xvc2VkID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9wZW5BY2NvcmRpb24oKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VBY2NvcmRpb24oKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjbG9zZUFjY29yZGlvbigpIHtcclxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcclxuICAgICAgICAgICAgaXNDbG9zZWQ6IHRydWUsXHJcbiAgICAgICAgICAgIHNob3VsZFN3aXRjaEF1dG9Pbk5leHRDeWNsZTogdHJ1ZSxcclxuICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLnJlZnMuaW5uZXIub2Zmc2V0SGVpZ2h0LFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG9wZW5BY2NvcmRpb24oKSB7XHJcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XHJcbiAgICAgICAgICAgIGhlaWdodDogdGhpcy5yZWZzLmlubmVyLm9mZnNldEhlaWdodCxcclxuICAgICAgICAgICAgdHJhbnNpdGlvbjogYGhlaWdodCAke3RoaXMucHJvcHMudHJhbnNpdGlvblRpbWV9bXMgJHt0aGlzLnByb3BzLmVhc2luZ31gLFxyXG4gICAgICAgICAgICBpc0Nsb3NlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIGhhc0JlZW5PcGVuZWQ6IHRydWUsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgbWFrZVJlc3BvbnNpdmUoKSB7XHJcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XHJcbiAgICAgICAgICAgIGhlaWdodDogJ2F1dG8nLFxyXG4gICAgICAgICAgICB0cmFuc2l0aW9uOiAnbm9uZScsXHJcbiAgICAgICAgICAgIHNob3VsZFN3aXRjaEF1dG9Pbk5leHRDeWNsZTogZmFsc2UsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJlcGFyZVRvT3BlbigpIHtcclxuICAgICAgICAvL1RoZSBoZWlnaHQgaGFzIGJlZW4gY2hhbmdlcyBiYWNrIHRvIGZpeGVkIHBpeGVsLCB3ZSBzZXQgYSBzbWFsbCB0aW1lb3V0IHRvIGZvcmNlIHRoZSBDU1MgdHJhbnNpdGlvbiBiYWNrIHRvIDAgb24gdGhlIG5leHQgdGljay5cclxuICAgICAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xyXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiAwLFxyXG4gICAgICAgICAgICAgICAgc2hvdWxkU3dpdGNoQXV0b09uTmV4dEN5Y2xlOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIHRyYW5zaXRpb246IGBoZWlnaHQgJHt0aGlzLnByb3BzLnRyYW5zaXRpb25UaW1lfW1zICR7dGhpcy5wcm9wcy5lYXNpbmd9YCxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSwgNTApO1xyXG4gICAgfVxyXG5cclxuICAgIGhhbmRsZVNlbGVjdEFycm93VG9nZ2xlKCkge1xyXG4gICAgICAgIHRoaXMuc3RhdGUuaXNDbG9zZWQgPyB0aGlzLnNldFN0YXRlKHsgaXNDbG9zZWQ6IGZhbHNlIH0pIDogdGhpcy5zZXRTdGF0ZSh7IGlzQ2xvc2VkOiB0cnVlIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbmRlckFycm93KCkge1xyXG4gICAgICAgIHJldHVybiA8ZGl2IGNsYXNzTmFtZT0nU2VsZWN0LWFycm93JyBvbkNsaWNrPXsoKSA9PiB0aGlzLmhhbmRsZVNlbGVjdEFycm93VG9nZ2xlKCl9IC8+O1xyXG4gICAgfVxyXG5cclxuICAgIHJlbmRlcigpIHtcclxuICAgICAgICBjb25zdCBkcm9wZG93blN0eWxlID0ge1xyXG4gICAgICAgICAgICBoZWlnaHQ6IHRoaXMuc3RhdGUuaGVpZ2h0LFxyXG4gICAgICAgICAgICBXZWJraXRUcmFuc2l0aW9uOiB0aGlzLnN0YXRlLnRyYW5zaXRpb24sXHJcbiAgICAgICAgICAgIG1zVHJhbnNpdGlvbjogdGhpcy5zdGF0ZS50cmFuc2l0aW9uLFxyXG4gICAgICAgICAgICB0cmFuc2l0aW9uOiB0aGlzLnN0YXRlLnRyYW5zaXRpb24sXHJcbiAgICAgICAgICAgIG92ZXJmbG93OiB0aGlzLnN0YXRlLm92ZXJmbG93LFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvbnN0IG9wZW5DbGFzcyA9IHRoaXMuc3RhdGUuaXNDbG9zZWQgPyAnaXMtY2xvc2VkJyA6ICdpcy1vcGVuJztcclxuXHJcbiAgICAgICAgLy8gSWYgdXNlciB3YW50cyBkaWZmZXJlbnQgdGV4dCB3aGVuIHRyYXkgaXMgb3BlblxyXG4gICAgICAgIGNvbnN0IHRyaWdnZXIgPVxyXG4gICAgICAgICAgICB0aGlzLnN0YXRlLmlzQ2xvc2VkID09PSBmYWxzZSAmJiB0aGlzLnByb3BzLnRyaWdnZXJXaGVuT3BlbiAhPT0gdW5kZWZpbmVkXHJcbiAgICAgICAgICAgICAgICA/IHRoaXMucHJvcHMudHJpZ2dlcldoZW5PcGVuXHJcbiAgICAgICAgICAgICAgICA6IHRoaXMucHJvcHMudHJpZ2dlcjtcclxuXHJcbiAgICAgICAgLy8gRG9uJ3QgcmVuZGVyIGNoaWxkcmVuIHVudGlsIHRoZSBmaXJzdCBvcGVuaW5nIG9mIHRoZSBBY2NvcmRpb24gaWYgbGF6eSByZW5kZXJpbmcgaXMgZW5hYmxlZFxyXG4gICAgICAgIGxldCBjaGlsZHJlbiA9IHRoaXMucHJvcHMuY2hpbGRyZW47XHJcbiAgICAgICAgaWYgKHRoaXMucHJvcHMubGF6eVJlbmRlciAmJiAhdGhpcy5zdGF0ZS5oYXNCZWVuT3BlbmVkKSB7XHJcbiAgICAgICAgICAgIGNoaWxkcmVuID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtgJHt0aGlzLnByb3BzLmNsYXNzUGFyZW50U3RyaW5nfWB9PlxyXG4gICAgICAgICAgICAgICAgPGRpdlxyXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17YCR7dGhpcy5wcm9wcy5jbGFzc1BhcmVudFN0cmluZ30gcGFuZWwtYWNjb3JkaW9uX190cmlnZ2VyICR7b3BlbkNsYXNzfWB9XHJcbiAgICAgICAgICAgICAgICAgICAgb25DbGljaz17ZXZlbnQgPT4gdGhpcy5oYW5kbGVUcmlnZ2VyQ2xpY2soZXZlbnQpfVxyXG4gICAgICAgICAgICAgICAgPlxyXG4gICAgICAgICAgICAgICAgICAgIHtQcmludFNldHRpbmdzQ29uc3RhbnRzLkRpc3BsYXlLZXlzW3RyaWdnZXJdfVxyXG4gICAgICAgICAgICAgICAgICAgIHt0aGlzLnJlbmRlckFycm93KCl9XHJcbiAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgICAgIDxkaXZcclxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9e2Ake3RoaXMucHJvcHMuY2xhc3NQYXJlbnRTdHJpbmd9IHBhbmVsLWFjY29yZGlvbl9fY29udGVudE91dGVyICR7b3BlbkNsYXNzfWB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmVmPSdvdXRlcidcclxuICAgICAgICAgICAgICAgICAgICBzdHlsZT17ZHJvcGRvd25TdHlsZX1cclxuICAgICAgICAgICAgICAgID5cclxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT17YCR7dGhpcy5wcm9wcy5jbGFzc1BhcmVudFN0cmluZ30gcGFuZWwtYWNjb3JkaW9uX19jb250ZW50SW5uZXJgfSByZWY9J2lubmVyJz5cclxuICAgICAgICAgICAgICAgICAgICAgICAge2NoaWxkcmVufVxyXG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcbn1cclxuXHJcbkFjY29yZGlvbi5kaXNwbGF5TmFtZSA9ICdBY2NvcmRpb24nO1xyXG5BY2NvcmRpb24ucHJvcFR5cGVzID0ge1xyXG4gICAgdHJhbnNpdGlvblRpbWU6IFJlYWN0LlByb3BUeXBlcy5udW1iZXIsXHJcbiAgICBlYXNpbmc6IFJlYWN0LlByb3BUeXBlcy5zdHJpbmcsXHJcbiAgICBvcGVuOiBSZWFjdC5Qcm9wVHlwZXMuYm9vbCxcclxuICAgIGNsYXNzUGFyZW50U3RyaW5nOiBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLFxyXG4gICAgYWNjb3JkaW9uUG9zaXRpb246IFJlYWN0LlByb3BUeXBlcy5udW1iZXIsXHJcbiAgICBoYW5kbGVUcmlnZ2VyQ2xpY2s6IFJlYWN0LlByb3BUeXBlcy5mdW5jLFxyXG4gICAgdHJpZ2dlcjogUmVhY3QuUHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3QuUHJvcFR5cGVzLnN0cmluZywgUmVhY3QuUHJvcFR5cGVzLmVsZW1lbnRdKSxcclxuICAgIHRyaWdnZXJXaGVuT3BlbjogUmVhY3QuUHJvcFR5cGVzLm9uZU9mVHlwZShbUmVhY3QuUHJvcFR5cGVzLnN0cmluZywgUmVhY3QuUHJvcFR5cGVzLmVsZW1lbnRdKSxcclxuICAgIGxhenlSZW5kZXI6IFJlYWN0LlByb3BUeXBlcy5ib29sLFxyXG59O1xyXG5cclxuQWNjb3JkaW9uLmRlZmF1bHRQcm9wcyA9IHtcclxuICAgIHRyYW5zaXRpb25UaW1lOiA0MDAsXHJcbiAgICBlYXNpbmc6ICdsaW5lYXInLFxyXG4gICAgb3BlbjogdHJ1ZSxcclxuICAgIGNsYXNzUGFyZW50U3RyaW5nOiAnQWNjb3JkaW9uJyxcclxuICAgIGxhenlSZW5kZXI6IGZhbHNlLFxyXG59O1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBBY2NvcmRpb247XHJcbiJdfQ==
