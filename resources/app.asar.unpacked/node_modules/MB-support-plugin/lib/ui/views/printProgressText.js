/* eslint-disable react/jsx-key */
'use strict';

const React = require('react');

const Button = require('eagle-print/views/ui/button.js');

const FluxComponent = require('eagle-print/views/flux_component');

const PrinterDetailsError = require('./PrinterDetailsError');

const {
  maybe,
  just,
  nothing
} = require('../../utils/maybe');

class PrintProgressText extends FluxComponent {
  constructor(props, context) {
    super(props, context);
    const flux = this.getFlux();
    this._actions = flux.actions.PrinterDetailsActions;
    this._i18n = flux.getService('TranslationService');
    this._tracking = flux.getService('TrackingService');
  }

  getFormattedTime(time) {
    return maybe(time).flatMap(time => time > 0 ? just(time) : nothing()).map(seconds => {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds - hours * 3600) / 60);
      return /*#__PURE__*/React.createElement("span", {
        style: {
          fontWeight: 'bold'
        }
      }, `${hours}h ${minutes}m`);
    });
  } // Remove path and .makerbot extension from pathname if they exist


  getFileName(inFile) {
    if (inFile) {
      let returnFile = inFile;
      const backSlashIndex = returnFile.lastIndexOf('/');
      if (backSlashIndex >= 0) returnFile = returnFile.substr(backSlashIndex + 1);
      if (returnFile.lastIndexOf('.makerbot') >= 0) returnFile = returnFile.replace('.makerbot', '');
      return returnFile;
    }
  }

  _estimatedTime() {
    const label = this._i18n.t('mb:printerStatus.description.time_remaining');

    const {
      step
    } = this.props.detailsStatus;
    if (!(step.printing || step.paused)) return null;
    return this.props.currentProcess.apply(cp => {
      if (cp.progress < 100) {
        return this.getFormattedTime(cp.time_remaining).map(time => /*#__PURE__*/React.createElement("div", null, `${label}: `, time)).lift();
      }
    });
  }

  _extruderTemp(extruder, isDual) {
    if (this.props.detailsStatus.has.extruder) {
      const currentTemp = extruder.current_temperature;
      return /*#__PURE__*/React.createElement("div", null, isDual ? this._i18n.t('mb:printerStatus.description.extruder_index', {
        index: extruder.index + 1
      }) : this._i18n.t('mb:printerStatus.description.extruder'), /*#__PURE__*/React.createElement("span", {
        style: {
          fontWeight: 'bold'
        }
      }, ` ${currentTemp + this._targetExtruderTemp(extruder)}`), ' °C');
    }
  }

  _targetExtruderTemp(extruder) {
    const {
      step
    } = this.props.detailsStatus;
    if (step.printing || step.paused || step.zCalFilament || step.startPrint) return null;
    return this.props.currentProcess.apply(() => {
      const targetTemp = extruder.target_temperature;

      if (targetTemp > 0) {
        return ` | ${targetTemp}`;
      } else {
        return null;
      }
    });
  }

  _chamberTemp() {
    if (this.props.detailsStatus.has.chamber) {
      const currentTemp = this.props.printer.getChamberInfo()[0].current_temperature;
      return /*#__PURE__*/React.createElement("div", null, this._i18n.t('mb:printerStatus.description.chamber'), /*#__PURE__*/React.createElement("span", {
        style: {
          fontWeight: 'bold'
        }
      }, ` ${currentTemp + this._targetChamberTemp()}`), ' °C');
    }
  }

  _targetChamberTemp() {
    const {
      step
    } = this.props.detailsStatus;
    if (step.printing || step.paused || step.zCalFilament || step.startPrint) return null;

    if (this.props.detailsStatus.has.chamber) {
      const targetTemp = this.props.printer.getChamberInfo()[0].target_temperature;

      if (targetTemp > 0) {
        return ` | ${targetTemp}`;
      } else {
        return null;
      }
    }
  }

  _platformTemp() {
    if (this.props.detailsStatus.has.platform) {
      const currentTemp = this.props.printer.getPlatformInfo()[0].current_temperature;
      return /*#__PURE__*/React.createElement("div", null, this._i18n.t('mb:printerStatus.description.platform'), /*#__PURE__*/React.createElement("span", {
        style: {
          fontWeight: 'bold'
        }
      }, ` ${currentTemp + this._targetPlatformTemp()}`), " \xB0C");
    }
  }

  _targetPlatformTemp() {
    const {
      step
    } = this.props.detailsStatus;
    if (step.printing || step.paused || step.zCalFilament || step.startPrint) return null;

    if (this.props.detailsStatus.has.platform) {
      const targetTemp = this.props.printer.getPlatformInfo()[0].target_temperature;

      if (targetTemp > 0) {
        return ` | ${targetTemp}`;
      } else {
        return null;
      }
    }
  }

  renderText(button) {
    const {
      step,
      has
    } = this.props.detailsStatus;
    const {
      label,
      description
    } = this.props.progressText(this._i18n, this.props.printer);

    const estimatedTime = this._estimatedTime();

    const isDual = this.props.printer.getExtruderInfo().length > 1;

    const chamberTemp = this._chamberTemp();

    const platformTemp = this._platformTemp();

    const extruderTemp = [];
    this.props.printer.getExtruderInfo().map(extruder => {
      const tempInfo = this._extruderTemp(extruder, isDual);

      extruderTemp.push(tempInfo);
    });
    const fileName = this.props.currentProcess.apply(cp => {
      if ((step.printing || step.completed || step.paused) && has.extruder) {
        return /*#__PURE__*/React.createElement("div", {
          className: "printerStatus"
        }, this.getFileName(cp.filename));
      }
    });
    const progress = this.props.currentProcess.apply(cp => cp.progress != null && step.transferring ? /*#__PURE__*/React.createElement("div", null, `${cp.progress}%`) : null);
    return /*#__PURE__*/React.createElement("div", {
      id: "PrinterDetailsInfoContainer"
    }, /*#__PURE__*/React.createElement("div", {
      className: "printerStatus"
    }, label), fileName, progress, /*#__PURE__*/React.createElement("div", null, description, /*#__PURE__*/React.createElement("div", null, this.renderButton(button))), extruderTemp, chamberTemp, platformTemp, estimatedTime);
  }

  renderError() {
    return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement(PrinterDetailsError, {
      flux: this.props.flux,
      printer: this.props.printer,
      error: this.props.printer.getLastError(),
      closePanel: () => this.props.onBack()
    }));
  }

  renderButton(button) {
    if (!button) return null;
    const {
      label,
      onClick,
      primary
    } = button(this._i18n, this._actions);
    const buttonType = primary ? 'primary' : 'secondary';
    return /*#__PURE__*/React.createElement(Button, {
      type: buttonType,
      label: label,
      onClick: onClick
    });
  }

  render() {
    // const { step } = this.props.detailsStatus;
    const lastError = this.props.printer.getLastError();

    if (lastError) {
      return this.renderError();
    }

    return this.renderText(this.props.progressButtons);
  }

}

PrintProgressText.displayName = 'PrintProgressText';
PrintProgressText.propTypes = Object.assign({}, PrintProgressText.propsTypes, {
  currentProcess: React.PropTypes.object.isRequired,
  detailsStatus: React.PropTypes.object.isRequired,
  progressText: React.PropTypes.func,
  progressButtons: React.PropTypes.object
});
module.exports = PrintProgressText;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByaW50UHJvZ3Jlc3NUZXh0LmpzIl0sIm5hbWVzIjpbIlJlYWN0IiwicmVxdWlyZSIsIkJ1dHRvbiIsIkZsdXhDb21wb25lbnQiLCJQcmludGVyRGV0YWlsc0Vycm9yIiwibWF5YmUiLCJqdXN0Iiwibm90aGluZyIsIlByaW50UHJvZ3Jlc3NUZXh0IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImNvbnRleHQiLCJmbHV4IiwiZ2V0Rmx1eCIsIl9hY3Rpb25zIiwiYWN0aW9ucyIsIlByaW50ZXJEZXRhaWxzQWN0aW9ucyIsIl9pMThuIiwiZ2V0U2VydmljZSIsIl90cmFja2luZyIsImdldEZvcm1hdHRlZFRpbWUiLCJ0aW1lIiwiZmxhdE1hcCIsIm1hcCIsInNlY29uZHMiLCJob3VycyIsIk1hdGgiLCJmbG9vciIsIm1pbnV0ZXMiLCJmb250V2VpZ2h0IiwiZ2V0RmlsZU5hbWUiLCJpbkZpbGUiLCJyZXR1cm5GaWxlIiwiYmFja1NsYXNoSW5kZXgiLCJsYXN0SW5kZXhPZiIsInN1YnN0ciIsInJlcGxhY2UiLCJfZXN0aW1hdGVkVGltZSIsImxhYmVsIiwidCIsInN0ZXAiLCJkZXRhaWxzU3RhdHVzIiwicHJpbnRpbmciLCJwYXVzZWQiLCJjdXJyZW50UHJvY2VzcyIsImFwcGx5IiwiY3AiLCJwcm9ncmVzcyIsInRpbWVfcmVtYWluaW5nIiwibGlmdCIsIl9leHRydWRlclRlbXAiLCJleHRydWRlciIsImlzRHVhbCIsImhhcyIsImN1cnJlbnRUZW1wIiwiY3VycmVudF90ZW1wZXJhdHVyZSIsImluZGV4IiwiX3RhcmdldEV4dHJ1ZGVyVGVtcCIsInpDYWxGaWxhbWVudCIsInN0YXJ0UHJpbnQiLCJ0YXJnZXRUZW1wIiwidGFyZ2V0X3RlbXBlcmF0dXJlIiwiX2NoYW1iZXJUZW1wIiwiY2hhbWJlciIsInByaW50ZXIiLCJnZXRDaGFtYmVySW5mbyIsIl90YXJnZXRDaGFtYmVyVGVtcCIsIl9wbGF0Zm9ybVRlbXAiLCJwbGF0Zm9ybSIsImdldFBsYXRmb3JtSW5mbyIsIl90YXJnZXRQbGF0Zm9ybVRlbXAiLCJyZW5kZXJUZXh0IiwiYnV0dG9uIiwiZGVzY3JpcHRpb24iLCJwcm9ncmVzc1RleHQiLCJlc3RpbWF0ZWRUaW1lIiwiZ2V0RXh0cnVkZXJJbmZvIiwibGVuZ3RoIiwiY2hhbWJlclRlbXAiLCJwbGF0Zm9ybVRlbXAiLCJleHRydWRlclRlbXAiLCJ0ZW1wSW5mbyIsInB1c2giLCJmaWxlTmFtZSIsImNvbXBsZXRlZCIsImZpbGVuYW1lIiwidHJhbnNmZXJyaW5nIiwicmVuZGVyQnV0dG9uIiwicmVuZGVyRXJyb3IiLCJnZXRMYXN0RXJyb3IiLCJvbkJhY2siLCJvbkNsaWNrIiwicHJpbWFyeSIsImJ1dHRvblR5cGUiLCJyZW5kZXIiLCJsYXN0RXJyb3IiLCJwcm9ncmVzc0J1dHRvbnMiLCJkaXNwbGF5TmFtZSIsInByb3BUeXBlcyIsIk9iamVjdCIsImFzc2lnbiIsInByb3BzVHlwZXMiLCJQcm9wVHlwZXMiLCJvYmplY3QiLCJpc1JlcXVpcmVkIiwiZnVuYyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7O0FBRUEsTUFBTUEsS0FBSyxHQUFHQyxPQUFPLENBQUMsT0FBRCxDQUFyQjs7QUFDQSxNQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxnQ0FBRCxDQUF0Qjs7QUFDQSxNQUFNRSxhQUFhLEdBQUdGLE9BQU8sQ0FBQyxrQ0FBRCxDQUE3Qjs7QUFFQSxNQUFNRyxtQkFBbUIsR0FBR0gsT0FBTyxDQUFDLHVCQUFELENBQW5DOztBQUNBLE1BQU07QUFBRUksRUFBQUEsS0FBRjtBQUFTQyxFQUFBQSxJQUFUO0FBQWVDLEVBQUFBO0FBQWYsSUFBMkJOLE9BQU8sQ0FBQyxtQkFBRCxDQUF4Qzs7QUFFQSxNQUFNTyxpQkFBTixTQUFnQ0wsYUFBaEMsQ0FBOEM7QUFDMUNNLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFRQyxPQUFSLEVBQWlCO0FBQ3hCLFVBQU1ELEtBQU4sRUFBYUMsT0FBYjtBQUVBLFVBQU1DLElBQUksR0FBRyxL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QixDQUFQO0FBQ0g7O0FBak55Qzs7QUFvTjlDeEYsaUJBQWlCLENBQUN5RixXQUFsQixHQUFnQyxtQkFBaEM7QUFDQXpGLGlCQUFpQixDQUFDMEYsU0FBbEIsR0FBOEJDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0I1RixpQkFBaUIsQ0FBQzZGLFVBQXBDLEVBQWdEO0FBQzFFekQsRUFBQUEsY0FBYyxFQUFFNUMsS0FBSyxDQUFDc0csU0FBTixDQUFnQkMsTUFBaEIsQ0FBdUJDLFVBRG1DO0FBRTFFL0QsRUFBQUEsYUFBYSxFQUFFekMsS0FBSyxDQUFDc0csU0FBTixDQUFnQkMsTUFBaEIsQ0FBdUJDLFVBRm9DO0FBRzFFOUIsRUFBQUEsWUFBWSxFQUFFMUUsS0FBSyxDQUFDc0csU0FBTixDQUFnQkcsSUFINEM7QUFJMUVULEVBQUFBLGVBQWUsRUFBRWhHLEtBQUssQ0FBQ3NHLFNBQU4sQ0FBZ0JDO0FBSnlDLENBQWhELENBQTlCO0FBT0FHLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQm5HLGlCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHJlYWN0L2pzeC1rZXkgKi9cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgUmVhY3QgPSByZXF1aXJlKCdyZWFjdCcpO1xyXG5jb25zdCBCdXR0b24gPSByZXF1aXJlKCdlYWdsZS1wcmludC92aWV3cy91aS9idXR0b24uanMnKTtcclxuY29uc3QgRmx1eENvbXBvbmVudCA9IHJlcXVpcmUoJ2VhZ2xlLXByaW50L3ZpZXdzL2ZsdXhfY29tcG9uZW50Jyk7XHJcblxyXG5jb25zdCBQcmludGVyRGV0YWlsc0Vycm9yID0gcmVxdWlyZSgnLi9QcmludGVyRGV0YWlsc0Vycm9yJyk7XHJcbmNvbnN0IHsgbWF5YmUsIGp1c3QsIG5vdGhpbmcgfSA9IHJlcXVpcmUoJy4uLy4uL3V0aWxzL21heWJlJyk7XHJcblxyXG5jbGFzcyBQcmludFByb2dyZXNzVGV4dCBleHRlbmRzIEZsdXhDb21wb25lbnQge1xyXG4gICAgY29uc3RydWN0b3IocHJvcHMsIGNvbnRleHQpIHtcclxuICAgICAgICBzdXBlcihwcm9wcywgY29udGV4dCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGZsdXggPSB0aGlzLmdldEZsdXgoKTtcclxuICAgICAgICB0aGlzLl9hY3Rpb25zID0gZmx1eC5hY3Rpb25zLlByaW50ZXJEZXRhaWxzQWN0aW9ucztcclxuICAgICAgICB0aGlzLl9pMThuID0gZmx1eC5nZXRTZXJ2aWNlKCdUcmFuc2xhdGlvblNlcnZpY2UnKTtcclxuICAgICAgICB0aGlzLl90cmFja2luZyA9IGZsdXguZ2V0U2VydmljZSgnVHJhY2tpbmdTZXJ2aWNlJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Rm9ybWF0dGVkVGltZSh0aW1lKSB7XHJcbiAgICAgICAgcmV0dXJuIG1heWJlKHRpbWUpXHJcbiAgICAgICAgICAgIC5mbGF0TWFwKHRpbWUgPT4gKHRpbWUgPiAwID8ganVzdCh0aW1lKSA6IG5vdGhpbmcoKSkpXHJcbiAgICAgICAgICAgIC5tYXAoc2Vjb25kcyA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBob3VycyA9IE1hdGguZmxvb3Ioc2Vjb25kcyAvIDM2MDApO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbWludXRlcyA9IE1hdGguZmxvb3IoKHNlY29uZHMgLSBob3VycyAqIDM2MDApIC8gNjApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDxzcGFuIHN0eWxlPXt7IGZvbnRXZWlnaHQ6ICdib2xkJyB9fT57YCR7aG91cnN9aCAke21pbnV0ZXN9bWB9PC9zcGFuPjtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUmVtb3ZlIHBhdGggYW5kIC5tYWtlcmJvdCBleHRlbnNpb24gZnJvbSBwYXRobmFtZSBpZiB0aGV5IGV4aXN0XHJcbiAgICBnZXRGaWxlTmFtZShpbkZpbGUpIHtcclxuICAgICAgICBpZiAoaW5GaWxlKSB7XHJcbiAgICAgICAgICAgIGxldCByZXR1cm5GaWxlID0gaW5GaWxlO1xyXG4gICAgICAgICAgICBjb25zdCBiYWNrU2xhc2hJbmRleCA9IHJldHVybkZpbGUubGFzdEluZGV4T2YoJy8nKTtcclxuICAgICAgICAgICAgaWYgKGJhY2tTbGFzaEluZGV4ID49IDApIHJldHVybkZpbGUgPSByZXR1cm5GaWxlLnN1YnN0cihiYWNrU2xhc2hJbmRleCArIDEpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHJldHVybkZpbGUubGFzdEluZGV4T2YoJy5tYWtlcmJvdCcpID49IDApIHJldHVybkZpbGUgPSByZXR1cm5GaWxlLnJlcGxhY2UoJy5tYWtlcmJvdCcsICcnKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiByZXR1cm5GaWxlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBfZXN0aW1hdGVkVGltZSgpIHtcclxuICAgICAgICBjb25zdCBsYWJlbCA9IHRoaXMuX2kxOG4udCgnbWI6cHJpbnRlclN0YXR1cy5kZXNjcmlwdGlvbi50aW1lX3JlbWFpbmluZycpO1xyXG4gICAgICAgIGNvbnN0IHsgc3RlcCB9ID0gdGhpcy5wcm9wcy5kZXRhaWxzU3RhdHVzO1xyXG5cclxuICAgICAgICBpZiAoIShzdGVwLnByaW50aW5nIHx8IHN0ZXAucGF1c2VkKSkgcmV0dXJuIG51bGw7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLnByb3BzLmN1cnJlbnRQcm9jZXNzLmFwcGx5KGNwID0+IHtcclxuICAgICAgICAgICAgaWYgKGNwLnByb2dyZXNzIDwgMTAwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRGb3JtYXR0ZWRUaW1lKGNwLnRpbWVfcmVtYWluaW5nKVxyXG4gICAgICAgICAgICAgICAgICAgIC5tYXAodGltZSA9PiAoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7YCR7bGFiZWx9OiBgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge3RpbWV9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICAgICAgICAgICkpXHJcbiAgICAgICAgICAgICAgICAgICAgLmxpZnQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIF9leHRydWRlclRlbXAoZXh0cnVkZXIsIGlzRHVhbCkge1xyXG4gICAgICAgIGlmICh0aGlzLnByb3BzLmRldGFpbHNTdGF0dXMuaGFzLmV4dHJ1ZGVyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRUZW1wID0gZXh0cnVkZXIuY3VycmVudF90ZW1wZXJhdHVyZTtcclxuICAgICAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgICAgIDxkaXY+XHJcbiAgICAgICAgICAgICAgICAgICAge2lzRHVhbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICA/IHRoaXMuX2kxOG4udCgnbWI6cHJpbnRlclN0YXR1cy5kZXNjcmlwdGlvbi5leHRydWRlcl9pbmRleCcsIHsgaW5kZXg6IGV4dHJ1ZGVyLmluZGV4ICsgMSB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICA6IHRoaXMuX2kxOG4udCgnbWI6cHJpbnRlclN0YXR1cy5kZXNjcmlwdGlvbi5leHRydWRlcicpfVxyXG4gICAgICAgICAgICAgICAgICAgIDxzcGFuIHN0eWxlPXt7IGZvbnRXZWlnaHQ6ICdib2xkJyB9fT57YCAke2N1cnJlbnRUZW1wICsgdGhpcy5fdGFyZ2V0RXh0cnVkZXJUZW1wKGV4dHJ1ZGVyKX1gfTwvc3Bhbj5cclxuICAgICAgICAgICAgICAgICAgICB7JyDCsEMnfVxyXG4gICAgICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIF90YXJnZXRFeHRydWRlclRlbXAoZXh0cnVkZXIpIHtcclxuICAgICAgICBjb25zdCB7IHN0ZXAgfSA9IHRoaXMucHJvcHMuZGV0YWlsc1N0YXR1cztcclxuXHJcbiAgICAgICAgaWYgKHN0ZXAucHJpbnRpbmcgfHwgc3RlcC5wYXVzZWQgfHwgc3RlcC56Q2FsRmlsYW1lbnQgfHwgc3RlcC5zdGFydFByaW50KSByZXR1cm4gbnVsbDtcclxuICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5jdXJyZW50UHJvY2Vzcy5hcHBseSgoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldFRlbXAgPSBleHRydWRlci50YXJnZXRfdGVtcGVyYXR1cmU7XHJcbiAgICAgICAgICAgIGlmICh0YXJnZXRUZW1wID4gMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGAgfCAke3RhcmdldFRlbXB9YDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgX2NoYW1iZXJUZW1wKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnByb3BzLmRldGFpbHNTdGF0dXMuaGFzLmNoYW1iZXIpIHtcclxuICAgICAgICAgICAgY29uc3QgY3VycmVudFRlbXAgPSB0aGlzLnByb3BzLnByaW50ZXIuZ2V0Q2hhbWJlckluZm8oKVswXS5jdXJyZW50X3RlbXBlcmF0dXJlO1xyXG4gICAgICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICAgICAgPGRpdj5cclxuICAgICAgICAgICAgICAgICAgICB7dGhpcy5faTE4bi50KCdtYjpwcmludGVyU3RhdHVzLmRlc2NyaXB0aW9uLmNoYW1iZXInKX1cclxuICAgICAgICAgICAgICAgICAgICA8c3BhbiBzdHlsZT17eyBmb250V2VpZ2h0OiAnYm9sZCcgfX0+e2AgJHtjdXJyZW50VGVtcCArIHRoaXMuX3RhcmdldENoYW1iZXJUZW1wKCl9YH08L3NwYW4+XHJcbiAgICAgICAgICAgICAgICAgICAgeycgwrBDJ31cclxuICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBfdGFyZ2V0Q2hhbWJlclRlbXAoKSB7XHJcbiAgICAgICAgY29uc3QgeyBzdGVwIH0gPSB0aGlzLnByb3BzLmRldGFpbHNTdGF0dXM7XHJcbiAgICAgICAgaWYgKHN0ZXAucHJpbnRpbmcgfHwgc3RlcC5wYXVzZWQgfHwgc3RlcC56Q2FsRmlsYW1lbnQgfHwgc3RlcC5zdGFydFByaW50KSByZXR1cm4gbnVsbDtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMucHJvcHMuZGV0YWlsc1N0YXR1cy5oYXMuY2hhbWJlcikge1xyXG4gICAgICAgICAgICBjb25zdCB0YXJnZXRUZW1wID0gdGhpcy5wcm9wcy5wcmludGVyLmdldENoYW1iZXJJbmZvKClbMF0udGFyZ2V0X3RlbXBlcmF0dXJlO1xyXG4gICAgICAgICAgICBpZiAodGFyZ2V0VGVtcCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBgIHwgJHt0YXJnZXRUZW1wfWA7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBfcGxhdGZvcm1UZW1wKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnByb3BzLmRldGFpbHNTdGF0dXMuaGFzLnBsYXRmb3JtKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRUZW1wID0gdGhpcy5wcm9wcy5wcmludGVyLmdldFBsYXRmb3JtSW5mbygpWzBdLmN1cnJlbnRfdGVtcGVyYXR1cmU7XHJcbiAgICAgICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgICAgICA8ZGl2PlxyXG4gICAgICAgICAgICAgICAgICAgIHt0aGlzLl9pMThuLnQoJ21iOnByaW50ZXJTdGF0dXMuZGVzY3JpcHRpb24ucGxhdGZvcm0nKX1cclxuICAgICAgICAgICAgICAgICAgICA8c3BhbiBzdHlsZT17eyBmb250V2VpZ2h0OiAnYm9sZCcgfX0+e2AgJHtjdXJyZW50VGVtcCArIHRoaXMuX3RhcmdldFBsYXRmb3JtVGVtcCgpfWB9PC9zcGFuPiDCsENcclxuICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBfdGFyZ2V0UGxhdGZvcm1UZW1wKCkge1xyXG4gICAgICAgIGNvbnN0IHsgc3RlcCB9ID0gdGhpcy5wcm9wcy5kZXRhaWxzU3RhdHVzO1xyXG4gICAgICAgIGlmIChzdGVwLnByaW50aW5nIHx8IHN0ZXAucGF1c2VkIHx8IHN0ZXAuekNhbEZpbGFtZW50IHx8IHN0ZXAuc3RhcnRQcmludCkgcmV0dXJuIG51bGw7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnByb3BzLmRldGFpbHNTdGF0dXMuaGFzLnBsYXRmb3JtKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldFRlbXAgPSB0aGlzLnByb3BzLnByaW50ZXIuZ2V0UGxhdGZvcm1JbmZvKClbMF0udGFyZ2V0X3RlbXBlcmF0dXJlO1xyXG4gICAgICAgICAgICBpZiAodGFyZ2V0VGVtcCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBgIHwgJHt0YXJnZXRUZW1wfWA7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZW5kZXJUZXh0KGJ1dHRvbikge1xyXG4gICAgICAgIGNvbnN0IHsgc3RlcCwgaGFzIH0gPSB0aGlzLnByb3BzLmRldGFpbHNTdGF0dXM7XHJcbiAgICAgICAgY29uc3QgeyBsYWJlbCwgZGVzY3JpcHRpb24gfSA9IHRoaXMucHJvcHMucHJvZ3Jlc3NUZXh0KHRoaXMuX2kxOG4sIHRoaXMucHJvcHMucHJpbnRlcik7XHJcblxyXG4gICAgICAgIGNvbnN0IGVzdGltYXRlZFRpbWUgPSB0aGlzLl9lc3RpbWF0ZWRUaW1lKCk7XHJcbiAgICAgICAgY29uc3QgaXNEdWFsID0gdGhpcy5wcm9wcy5wcmludGVyLmdldEV4dHJ1ZGVySW5mbygpLmxlbmd0aCA+IDE7XHJcbiAgICAgICAgY29uc3QgY2hhbWJlclRlbXAgPSB0aGlzLl9jaGFtYmVyVGVtcCgpO1xyXG4gICAgICAgIGNvbnN0IHBsYXRmb3JtVGVtcCA9IHRoaXMuX3BsYXRmb3JtVGVtcCgpO1xyXG4gICAgICAgIGNvbnN0IGV4dHJ1ZGVyVGVtcCA9IFtdO1xyXG5cclxuICAgICAgICB0aGlzLnByb3BzLnByaW50ZXIuZ2V0RXh0cnVkZXJJbmZvKCkubWFwKGV4dHJ1ZGVyID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdGVtcEluZm8gPSB0aGlzLl9leHRydWRlclRlbXAoZXh0cnVkZXIsIGlzRHVhbCk7XHJcblxyXG4gICAgICAgICAgICBleHRydWRlclRlbXAucHVzaCh0ZW1wSW5mbyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGZpbGVOYW1lID0gdGhpcy5wcm9wcy5jdXJyZW50UHJvY2Vzcy5hcHBseShjcCA9PiB7XHJcbiAgICAgICAgICAgIGlmICgoc3RlcC5wcmludGluZyB8fCBzdGVwLmNvbXBsZXRlZCB8fCBzdGVwLnBhdXNlZCkgJiYgaGFzLmV4dHJ1ZGVyKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gPGRpdiBjbGFzc05hbWU9J3ByaW50ZXJTdGF0dXMnPnt0aGlzLmdldEZpbGVOYW1lKGNwLmZpbGVuYW1lKX08L2Rpdj47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSB0aGlzLnByb3BzLmN1cnJlbnRQcm9jZXNzLmFwcGx5KGNwID0+XHJcbiAgICAgICAgICAgIGNwLnByb2dyZXNzICE9IG51bGwgJiYgc3RlcC50cmFuc2ZlcnJpbmcgPyA8ZGl2PntgJHtjcC5wcm9ncmVzc30lYH08L2Rpdj4gOiBudWxsXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgPGRpdiBpZD0nUHJpbnRlckRldGFpbHNJbmZvQ29udGFpbmVyJz5cclxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdwcmludGVyU3RhdHVzJz57bGFiZWx9PC9kaXY+XHJcbiAgICAgICAgICAgICAgICB7ZmlsZU5hbWV9XHJcbiAgICAgICAgICAgICAgICB7cHJvZ3Jlc3N9XHJcbiAgICAgICAgICAgICAgICA8ZGl2PlxyXG4gICAgICAgICAgICAgICAgICAgIHtkZXNjcmlwdGlvbn1cclxuICAgICAgICAgICAgICAgICAgICA8ZGl2Pnt0aGlzLnJlbmRlckJ1dHRvbihidXR0b24pfTwvZGl2PlxyXG4gICAgICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICAgICAgICB7ZXh0cnVkZXJUZW1wfVxyXG4gICAgICAgICAgICAgICAge2NoYW1iZXJUZW1wfVxyXG4gICAgICAgICAgICAgICAge3BsYXRmb3JtVGVtcH1cclxuICAgICAgICAgICAgICAgIHtlc3RpbWF0ZWRUaW1lfVxyXG4gICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbmRlckVycm9yKCkge1xyXG4gICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgIDxkaXY+XHJcbiAgICAgICAgICAgICAgICA8UHJpbnRlckRldGFpbHNFcnJvclxyXG4gICAgICAgICAgICAgICAgICAgIGZsdXg9e3RoaXMucHJvcHMuZmx1eH1cclxuICAgICAgICAgICAgICAgICAgICBwcmludGVyPXt0aGlzLnByb3BzLnByaW50ZXJ9XHJcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I9e3RoaXMucHJvcHMucHJpbnRlci5nZXRMYXN0RXJyb3IoKX1cclxuICAgICAgICAgICAgICAgICAgICBjbG9zZVBhbmVsPXsoKSA9PiB0aGlzLnByb3BzLm9uQmFjaygpfVxyXG4gICAgICAgICAgICAgICAgLz5cclxuICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICByZW5kZXJCdXR0b24oYnV0dG9uKSB7XHJcbiAgICAgICAgaWYgKCFidXR0b24pIHJldHVybiBudWxsO1xyXG5cclxuICAgICAgICBjb25zdCB7IGxhYmVsLCBvbkNsaWNrLCBwcmltYXJ5IH0gPSBidXR0b24odGhpcy5faTE4biwgdGhpcy5fYWN0aW9ucyk7XHJcbiAgICAgICAgY29uc3QgYnV0dG9uVHlwZSA9IHByaW1hcnkgPyAncHJpbWFyeScgOiAnc2Vjb25kYXJ5JztcclxuXHJcbiAgICAgICAgcmV0dXJuIDxCdXR0b24gdHlwZT17YnV0dG9uVHlwZX0gbGFiZWw9e2xhYmVsfSBvbkNsaWNrPXtvbkNsaWNrfSAvPjtcclxuICAgIH1cclxuXHJcbiAgICByZW5kZXIoKSB7XHJcbiAgICAgICAgLy8gY29uc3QgeyBzdGVwIH0gPSB0aGlzLnByb3BzLmRldGFpbHNTdGF0dXM7XHJcbiAgICAgICAgY29uc3QgbGFzdEVycm9yID0gdGhpcy5wcm9wcy5wcmludGVyLmdldExhc3RFcnJvcigpO1xyXG5cclxuICAgICAgICBpZiAobGFzdEVycm9yKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlbmRlckVycm9yKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5yZW5kZXJUZXh0KHRoaXMucHJvcHMucHJvZ3Jlc3NCdXR0b25zKTtcclxuICAgIH1cclxufVxyXG5cclxuUHJpbnRQcm9ncmVzc1RleHQuZGlzcGxheU5hbWUgPSAnUHJpbnRQcm9ncmVzc1RleHQnO1xyXG5QcmludFByb2dyZXNzVGV4dC5wcm9wVHlwZXMgPSBPYmplY3QuYXNzaWduKHt9LCBQcmludFByb2dyZXNzVGV4dC5wcm9wc1R5cGVzLCB7XHJcbiAgICBjdXJyZW50UHJvY2VzczogUmVhY3QuUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxyXG4gICAgZGV0YWlsc1N0YXR1czogUmVhY3QuUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxyXG4gICAgcHJvZ3Jlc3NUZXh0OiBSZWFjdC5Qcm9wVHlwZXMuZnVuYyxcclxuICAgIHByb2dyZXNzQnV0dG9uczogUmVhY3QuUHJvcFR5cGVzLm9iamVjdCxcclxufSk7XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IFByaW50UHJvZ3Jlc3NUZXh0O1xyXG4iXX0=
