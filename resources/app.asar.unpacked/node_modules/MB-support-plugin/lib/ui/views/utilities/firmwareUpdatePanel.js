'use strict';

const React = require('react');

const FluxComponent = require('eagle-print/views/flux_component');

const DOM = React.DOM;
const ce = React.createElement;

const Isvg = require('react-inlinesvg');

const _ = require('lodash');

const dialog = require('electron').remote.dialog;

const Button = require('eagle-print/views/ui/button.js');

const firmwareUtils = require('../../../firmwareUtils');

const HeaderSelectButton = require('../headerSelectButton');

class FirmwareUpdatePanel extends FluxComponent {
  /** @constructor **/
  constructor(props, context) {
    super(props, context);
    this.i18n = this.getFlux().getService('TranslationService');
    this.tracking = this.getFlux().getService('TrackingService');
    this.logger = this.getFlux().getService('LoggingService');
    this.message = this.getFlux().actions.message;

    _.assign(this.state, {
      currentVersion: this.i18n.t('mb:firmware.checking'),
      availableVersion: this.i18n.t('mb:firmware.checking'),
      availableDescription: '',
      customFilename: null,
      customManifest: null,
      canUpdate: false,
      browsing: false
    });
  }

  componentDidMount() {
    const fw = this.props.printer.firmware.availableUpdate;
    this.setState({
      currentVersion: this.props.printer.getInfo().firmware_version
    });
    this.props.printer.firmware.listen(this._handleNotif.bind(this));

    if (this.props.printer.firmware.hasUpdate()) {
      this._handleNotif(fw);
    } else {
      this.props.printer.firmware.check();
    }
  }

  componentWillUnmount() {
    this.props.printer.firmware.remove(this._handleNotif.bind(this));
  }
  /**
   * Updates the printer with either the latest version the printer knows about, or with
   * a custom firmware file that the user chooses.
   * @returns {q.Promise}
   */


  handleUpdate() {
    const flux = this.getFlux();
    this.props.onUpdate(); // if the user hasn't chosen a specific firmware file to use, just tell the printer
    // to grab one from the web (or the one it already has)

    if (this.state.customFilename == null) {
      this.tracking.addEvent({
        name: 'firmware_update_initialized'
      });
      return firmwareUtils.updateFirmware(this.props.printer, flux);
    }

    this.tracking.addEvent({
      name: 'firmware_upload_initialized'
    });
    return this.props.printer.firmware.upload(this.state.customFilename).then(() => this.logger.info('uploading firmware')).catch(err => {
      this.message.createErrorMessage({
        id: 'firmware-update-error',
        message: err
      });
    });
  }
  /**
   * Opens a "Choose File" dialog to pick a custom firmware file that
   * can be uploaded to the printer. Those files should be .zip
   **/


  handleBrowse() {
    if (this.state.browsing) {
      return;
    }

    this.setState({
      browsing: true
    });
    dialog.showOpenDialog({}, f => {
      if (f) {
        return this.props.printer.firmware.verify(f[0]).then(manifest => {
          this.setState({
            customFilename: f[0],
            customManifest: manifest,
            canUpdate: true,
            browsing: false
          });
        }).catch(err => {
          this.setState({
            browsing: false
          });
          this.message.createErrorMessage({
            id: 'firmware-update-error',
            message: err
          });
        });
      }

      this.setState({
        browsing: false
      });
    });
  }
  /**
   * @private
   * If the provided firmware is a newer version than the current firmware, update the
   * component state and allow the user to initiate the update.
   * @param {Object} firmware - the most recent version of the firmware we found
   */


  _handleNotif(firmware) {
    if (this.props.printer.firmware.hasUpdate()) {
      this.setState({
        availableVersion: firmware.manifest.version.join('.'),
        availableDescription: firmware.manifest.description,
        canUpdate: true
      });
    } else {
      this.setState({
        availableVersion: this.i18n.t('mb:firmware.none'),
        availableDescription: this.i18n.t('mb:firmware.none'),
        canUpdate: false
      });
    }
  }

  _parseCustomFirmwareName() {
    if (this.state.customManifest) {
      const product = this.state.customManifest.product;
      const version = this.state.customManifest.version.join('.');
      return `${product} ${version}`;
    }

    return null;
  }

  renderHeader() {
    return DOM.div({
      className: 'printerPanelHeader'
    }, DOM.div({
      className: 'printerPanelBackButton',
      onClick: this.props.onBack
    }, ce(Isvg, {
      src: 'icons/back-arrow.svg'
    })), DOM.div({
      className: 'printerPanelHeaderLabel'
    }, DOM.h1({}, this.i18n.t('mb:firmware.header'))), ce(HeaderSelectButton, {
      flux: this.getFlux(),
      printer: this.props.printer
    }), DOM.div({
      className: 'printerPanelArrowDown',
      onClick: this.props.onClose
    }, ce(Isvg, {
      src: 'icons/back-arrow.svg'
    })));
  }

  renderCurrent() {
    return DOM.div({}, DOM.label({}, this.i18n.t('mb:firmware.current')), DOM.p({}, this.state.currentVersion));
  }

  renderUpdate() {
    const version = this._parseCustomFirmwareName() || this.state.availableVersion;
    return DOM.div({}, DOM.label({}, this.i18n.t('mb:firmware.update_to')), DOM.div({
      style: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginRight: '10px'
      }
    }, DOM.input({
      readOnly: true,
      value: version,
      className: 'input-text'
    }), ce(Button, {
      style: {
        margin: '0 12px',
        padding: '8px 12px'
      },
      type: `secondary ${!this.state.canUpdate ? 'disabled' : ''}`,
      disabled: !this.state.canUpdate,
      onClick: () => this.handleUpdate()
    }, DOM.span({}, this.i18n.t('mb:firmware.update')))), DOM.a({
      style: {
        color: 'red',
        margin: '10px 0',
        display: 'block'
      },
      onClick: () => this.handleBrowse()
    }, this.i18n.t('mb:firmware.browse')));
  }

  renderDescription() {
    return DOM.div({}, DOM.label({}, this.i18n.t('mb:firmware.description')), DOM.p({}, this.state.customManifest != null ? this.state.customManifest.description : this.state.availableDescription));
  }

  render() {
    return DOM.div(_.assign({}, this.props, {
      className: `${this.props.className || ''} printerPanel`
    }), this.renderHeader(), DOM.div({
      className: 'printerPanel'
    }, DOM.div({
      style: {
        marginBottom: 50
      }
    }, DOM.div({
      className: 'panel-body'
    }, this.renderCurrent(), this.renderUpdate(), this.renderDescription()))));
  }

}

FirmwareUpdatePanel.propTypes = _.assign({}, FluxComponent.propTypes, {
  onClose: React.PropTypes.func,
  onBack: React.PropTypes.func,
  printer: React.PropTypes.object.isRequired
});
FirmwareUpdatePanel.defaultProps = {
  onClose: () => {},
  onBack: () => {},
  onUpdate: () => {}
};
module.exports = FirmwareUpdatePanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpcm13YXJlVXBkYXRlUGFuZWwuanMiXSwibmFtZXMiOlsiUmVhY3QiLCJyZXF1aXJlIiwiRmx1eENvbXBvbmVudCIsIkRPTSIsImNlIiwiY3JlYXRlRWxlbWVudCIsIklzdmciLCJfIiwiZGlhbG9nIiwicmVtb3RlIiwiQnV0dG9uIiwiZmlybXdhcmVVdGlscyIsIkhlYWRlclNlbGVjdEJ1dHRvbiIsIkZpcm13YXJlVXBkYXRlUGFuZWwiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiY29udGV4dCIsImkxOG4iLCJnZXRGbHV4IiwiZ2V0U2VydmljZSIsInRyYWNraW5nIiwibG9nZ2VyIiwibWVzc2FnZSIsImFjdGlvbnMiLCJhc3NpZ24iLCJzdGF0ZSIsImN1cnJlbnRWZXJzaW9uIiwidCIsImF2YWlsYWJsZVZlcnNpb24iLCJhdmFpbGFibGVEZXNjcmlwdGlvbiIsImN1c3RvbUZpbGVuYW1lIiwiY3VzdG9tTWFuaWZlc3QiLCJjYW5VcGRhdGUiLCJicm93c2luZyIsImNvbXBvbmVudERpZE1vdW50IiwiZnciLCJwcmludGVyIiwiZmlybXdhcmUiLCJhdmFpbGFibGVVcGRhdGUiLCJzZXRTdGF0ZSIsImdldEluZm8iLCJmaXJtd2FyZV92ZXJzaW9uIiwibGlzdGVuIiwiX2hhbmRsZU5vdGlmIiwiYmluZCIsImhhc1VwZGF0ZSIsImNoZWNrIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJyZW1vdmUiLCJoYW5kbGVVcGRhdGUiLCJmbHV4Iiwib25VcGRhdGUiLCJhZGRFdmVudCIsIm5hbWUiLCJ1cGRhdGVGaXJtd2FyZSIsInVwbG9hZCIsInRoZW4iLCJpbmZvIiwiY2F0Y2giLCJlcnIiLCJjcmVhdGVFcnJvck1lc3NhZ2UiLCJpZCIsImhhbmRsZUJyb3dzZSIsInNob3dPcGVuRGlhbG9nIiwiZiIsInZlcmlmeSIsIm1hbmlmZXN0IiwidmVyc2lvbiIsImpvaW4iLCJkZXNjcmlwdGlvbiIsIl9wYXJzZUN1c3RvbUZpcm13YXJlTmFtZSIsInByb2R1Y3QiLCJyZW5kZXJIZWFkZXIiLCJkaXYiLCJjbGFzc05hbWUiLCJvbkNsaWNrIiwib25CYWNrIiwic3JjIiwiaDEiLCJvbkNsb3NlIiwicmVuZGVyQ3VycmVudCIsImxhYmVsIiwicCIsInJlbmRlclVwZGF0ZSIsInN0eWxlIiwiZGlzcGxheSIsImp1c3RpZnlDb250ZW50IiwiYWxpZ25JdGVtcyIsIm1hcmdpblJpZ2h0IiwiaW5wdXQiLCJyZWFkT25seSIsInZhbHVlIiwibWFyZ2luIiwicGFkZGluZyIsInR5cGUiLCJkaXNhYmxlZCIsInNwYW4iLCJhIiwiY29sb3IiLCJyZW5kZXJEZXNjcmlwdGlvbiIsInJlbmRlciIsIm1hcmdpbkJvdHRvbSIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsImZ1bmMiLCJvYmplY3QiLCJpc1JlcXVpcmVkIiwiZGVmYXVsdFByb3BzIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsTUFBTUEsS0FBSyxHQUFHQyxPQUFPLENBQUMsT0FBRCxDQUFyQjs7QUFDQSxNQUFNQyxhQUFhLEdBQUdELE9BQU8sQ0FBQyxrQ0FBRCxDQUE3Qjs7QUFDQSxNQUFNRSxHQUFHLEdBQUdILEtBQUssQ0FBQ0csR0FBbEI7QUFDQSxNQUFNQyxFQUFFLEdBQUdKLEtBQUssQ0FBQ0ssYUFBakI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHTCxPQUFPLENBQUMsaUJBQUQsQ0FBcEI7O0FBQ0EsTUFBTU0sQ0FBQyxHQUFHTixPQUFPLENBQUMsUUFBRCxDQUFqQjs7QUFDQSxNQUFNTyxNQUFNLEdBQUdQLE9BQU8sQ0FBQyxVQUFELENBQVAsQ0FBb0JRLE1BQXBCLENBQTJCRCxNQUExQzs7QUFDQSxNQUFNRSxNQUFNLEdBQUdULE9BQU8sQ0FBQyxnQ0FBRCxDQUF0Qjs7QUFFQSxNQUFNVSxhQUFhLEdBQUdWLE9BQU8sQ0FBQyx3QkFBRCxDQUE3Qjs7QUFDQSxNQUFNVyxrQkFBa0IsR0FBR1gsT0FBTyxDQUFDLHVCQUFELENBQWxDOztBQUVBLE1BQU1ZLG1CQUFOLFNBQWtDWCxhQUFsQyxDQUFnRDtBQUM1QztBQUNBWSxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBUUMsT0FBUixFQUFpQjtBQUN4QixVQUFNRCxLQUFOLEVBQWFDLE9BQWI7QUFFQSxTQUFLQyxJQUFMLEdBQVksS0FBS0MsT0FBTCxHQUFlQyxVQUFmLENBQTBCLG9CQUExQixDQUFaO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQixLQUFLRixPQUFMLEdBQWVDLFVBQWYsQ0FBMEIsaUJBQTFCLENBQWhCO0FBQ0EsU0FBS0UsTUFBTCxHQUFjLEtBQUtILE9BQUwsR0FBZUMsVUFBZixDQUEwQixnQkFBMUIsQ0FBZDtBQUNBLFNBQUtHLE9BQUwsR0FBZSxLQUFLSixPQUFMLEdBQWVLLE9BQWYsQ0FBdUJELE9BQXRDOztBQUVBZixJQUFBQSxDQUFDLENBQUNpQixNQUFGLENBQVMsS0FBS0MsS0FBZCxFQUFxQjtBQUNqQkMsTUFBQUEsY0FBYyxFQUFFLEtBQUtULElBQUwsQ0FBVVUsQ0FBVixDQUFZLHNCQUFaLENBREM7QUFFakJDLE1BQUFBLGdCQUFnQixFQUFFLEtBQUtYLElBQUwsQ0FBVVUsQ0FBVixDQUFZLHNCQUFaLENBRkQ7QUFHakJFLE1BQUFBLG9CQUFvQixFQUFFLEVBSEw7QUFJakJDLE1BQUFBLGNBQWMsRUFBRSxJQUpDO0FBS2pCQyxNQUFBQSxjQUFjLEVBQUUsSUFMQztBQU1qQkMsTUFBQUEsU0FBUyxFQUFFLEtBTk07QUFPakJDLE1BQUFBLFFBQVEsRUFBRTtBQVBPLEtBQXJCO0FBU0g7O0FBRURDLEVBQUFBLGlCQUFpQixHQUFHO0FBQ2hCLFVBQU1DLEVBQUUsR0FBRyxLQUFLcEIsS0FBTCxDQUFXcUIsT0FBWCxDQUFtQkMsUUFBbkIsQ0FBNEJDLGVBQXZDO0FBQ0EsU0FBS0MsUUFBTCxDQUFjO0FBQUViLE1BQUFBLGNBQWMsRUFBRSxLQUFLWCxLQUFMLENBQVdxQixPQUFYLENBQW1CSSxPQUFuQixHQUE2QkM7QUFBL0MsS0FBZDtBQUVBLFNBQUsxQixLQUFMLENBQVdxQixPQUFYLENBQW1CQyxRQUFuQixDQUE0QkssTUFBNUIsQ0FBbUMsS0FBS0MsWUFBTCxDQUFrQkMsSUFBbEIsQ0FBdUIsSUFBdkIsQ0FBbkM7O0FBQ0EsUUFBSSxLQUFLN0IsS0FBTCxDQUFXcUIsT0FBWCxDQUFtQkMsUUFBbkIsQ0FBNEJRLFNBQTVCLEVBQUosRUFBNkM7QUFDekMsV0FBS0YsWUFBTCxDQUFrQlIsRUFBbEI7QUFDSCxLQUZELE1BRU87QUFDSCxXQUFLcEIsS0FBTCxDQUFXcUIsT0FBWCxDQUFtQkMsUUFBbkIsQ0FBNEJTLEtBQTVCO0FBQ0g7QUFDSjs7QUFFREMsRUFBQUEsb0JBQW9CLEdBQUc7QUFDbkIsU0FBS2hDLEtBQUwsQ0FBV3FCLE9BQVgsQ0FBbUJDLFFBQW5CLENBQTRCVyxNQUE1QixDQUFtQyxLQUFLTCxZQUFMLENBQWtCQyxJQUFsQixDQUF1QixJQUF2QixDQUFuQztBQUNIO0FBRUQ7QUFDSjtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0lLLEVBQUFBLFlBQVksR0FBRztBQUNYLFVBQU1DLElBQUksR0FBRyxLQUFLaEMsT0FBTCxFQUFiO0FBQ0EsU0FBS0gsS0FBTCxDQUFXb0MsUUFBWCxHQUZXLENBSVg7QUFDQTs7QUFDQSxRQUFJLEtBQUsxQixLQUFMLENBQVdLLGNBQVgsSUFBNkIsSUFBakMsRUFBdUM7QUFDbkMsV0FBS1YsUUFBTCxDQUFjZ0MsUUFBZCxDQUF1QjtBQUFFQyxRQUFBQSxJQUFJLEVBQUU7QUFBUixPQUF2QjtBQUNBLGFBQU8xQyxhQUFhLENBQUMyQyxjQUFkLENBQTZCLEtBQUt2QyxLQUFMLENBQVdxQixPQUF4QyxFQUFpRGMsSUFBakQsQ0FBUDtBQUNIOztBQUVELFNBQUs5QixRQUFMLENBQWNnQyxRQUFkLENBQXVCO0FBQUVDLE1BQUFBLElBQUksRUFBRTtBQUFSLEtBQXZCO0FBQ0EsV0FBTyxLQUFLdEMsS0FBTCxDQUFXcUIsT0FBWCxDQUFtQkMsUUFBbkIsQ0FDRmtCLE1BREUsQ0FDSyxLQUFLOUIsS0FBTCxDQUFXSyxjQURoQixFQUVGMEIsSUFGRSxDQUVHLE1BQU0sS0FBS25DLE1BQUwsQ0FBWW9DLElBQVosQ0FBaUIsb0JBQWpCLENBRlQsRUFHRkMsS0FIRSxDQUdJQyxHQUFHLElBQUk7QUFDVixXQUFLckMsT0FBTCxDQUFhc0Msa0JBQWIsQ0FBZ0M7QUFDNUJDLFFBQUFBLEVBQUUsRUFBRSx1QkFEd0I7QUFFNUJ2QyxRQUFBQSxPQUFPLEVBQUVxQztBQUZtQixPQUFoQztBQUlILEtBUkUsQ0FBUDtBQVNIO0FBRUQ7QUFDSjtBQUNBO0FBQ0E7OztBQUNJRyxFQUFBQSxZQUFZLEdBQUc7QUFDWCxRQUFJLEtBQUtyQyxLQUFMLENBQVdRLFFBQWYsRUFBeUI7QUFDckI7QUFDSDs7QUFFRCxTQUFLTSxRQUFMLENBQWM7QUFBRU4sTUFBQUEsUUFBUSxFQUFFO0FBQVosS0FBZDtBQUNBekIsSUFBQUEsTUFBTSxDQUFDdUQsY0FBUCxDQUFzQixFQUF0QixFQUEwQkMsQ0FBQyxJQUFJO0FBQzNCLFVBQUlBLENBQUosRUFBTztBQUNILGVBQU8sS0FBS2pELEtBQUwsQ0FBV3FCLE9BQVgsQ0FBbUJDLFFBQW5CLENBQ0Y0QixNQURFLENBQ0tELENBQUMsQ0FBQyxDQUFELENBRE4sRUFFRlIsSUFGRSxDQUVHVSxRQUFRLElBQUk7QUFDZCxlQUFLM0IsUUFBTCxDQUFjO0FBQ1ZULFlBQUFBLGNBQWMsRUFBRWtDLENBQUMsQ0FBQyxDQUFELENBRFA7QUFFVmpDLFlBQUFBLGNBQWMsRUFBRW1DLFFBRk47QUFHVmxDLFlBQUFBLFNBQVMsRUFBRSxJQUhEO0FBSVZDLFlBQUFBLFFBQVEsRUFBRTtBQUpBLFdBQWQ7QUFNSCxTQVRFLEVBVUZ5QixLQVZFLENBVUlDLEdBQUcsSUFBSTtBQUNWLGVBQUtwQixRQUFMLENBQWM7QUFBRU4sWUFBQUEsUUFBUSxFQUFFO0FBQVosV0FBZDtBQUNBLGVBQUtYLE9BQUwsQ0FBYXNDLGtCQUFiLENBQWdDO0FBQzVCQyxZQUFBQSxFQUFFLEVBQUUsdUJBRHdCO0FBRTVCdkMsWUFBQUEsT0FBTyxFQUFFcUM7QUFGbUIsV0FBaEM7QUFJSCxTQWhCRSxDQUFQO0FBaUJIOztBQUVELFdBQUtwQixRQUFMLENBQWM7QUFBRU4sUUFBQUEsUUFBUSxFQUFFO0FBQVosT0FBZDtBQUNILEtBdEJEO0FBdUJIO0FBRUQ7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDSVUsRUFBQUEsWUFBWSxDQUFDTixRQUFELEVBQVc7QUFDbkIsUUFBSSxLQUFLdEIsS0FBTCxDQUFXcUIsT0FBWCxDQUFtQkMsUUFBbkIsQ0FBNEJRLFNBQTVCLEVBQUosRUFBNkM7QUFDekMsV0FBS04sUUFBTCxDQUFjO0FBQ1ZYLFFBQUFBLGdCQUFnQixFQUFFUyxRQUFRLENBQUM2QixRQUFULENBQWtCQyxPQUFsQixDQUEwQkMsSUFBMUIsQ0FBK0IsR0FBL0IsQ0FEUjtBQUVWdkMsUUFBQUEsb0JBQW9CLEVBQUVRLFFBQVEsQ0FBQzZCLFFBQVQsQ0FBa0JHLFdBRjlCO0FBR1ZyQyxRQUFBQSxTQUFTLEVBQUU7QUFIRCxPQUFkO0FBS0gsS0FORCxNQU1PO0FBQ0gsV0FBS08sUUFBTCxDQUFjO0FBQ1ZYLFFBQUFBLGdCQUFnQixFQUFFLEtBQUtYLElBQUwsQ0FBVVUsQ0FBVixDQUFZLGtCQUFaLENBRFI7QUFFVkUsUUFBQUEsb0JBQW9CLEVBQUUsS0FBS1osSUFBTCxDQUFVVSxDQUFWLENBQVksa0JBQVosQ0FGWjtBQUdWSyxRQUFBQSxTQUFTLEVBQUU7QUFIRCxPQUFkO0FBS0g7QUFDSjs7QUFFRHNDLEVBQUFBLHdCQUF3QixHQUFHO0FBQ3ZCLFFBQUksS0FBSzdDLEtBQUwsQ0FBV00sY0FBZixFQUErQjtBQUMzQixZQUFNd0MsT0FBTyxHQUFHLEtBQUs5QyxLQUFMLENBQVdNLGNBQVgsQ0FBMEJ3QyxPQUExQztBQUNBLFlBQU1KLE9BQU8sR0FBRyxLQUFLMUMsS0FBTCxDQUFXTSxjQUFYLENBQTBCb0MsT0FBMUIsQ0FBa0NDLElBQWxDLENBQXVDLEdBQXZDLENBQWhCO0FBQ0EsYUFBUSxHQUFFRyxPQUFRLElBQUdKLE9BQVEsRUFBN0I7QUFDSDs7QUFFRCxXQUFPLElBQVA7QUFDSDs7QUFFREssRUFBQUEsWUFBWSxHQUFHO0FBQ1gsV0FBT3JFLEdBQUcsQ0FBQ3NFLEdBQUosQ0FDSDtBQUFFQyxNQUFBQSxTQUFTLEVBQUU7QUFBYixLQURHLEVBRUh2RSxHQUFHLENBQUNzRSxHQUFKLENBQ0k7QUFDSUMsTUFBQUEsU0FBUyxFQUFFLHdCQURmO0FBRUlDLE1BQUFBLE9BQU8sRUFBRSxLQUFLNUQsS0FBTCxDQUFXNkQ7QUFGeEIsS0FESixFQUtJeEUsRUFBRSxDQUFDRSxJQUFELEVBQU87QUFBRXVFLE1BQUFBLEdBQUcsRUFBRTtBQUFQLEtBQVAsQ0FMTixDQUZHLEVBU0gxRSxHQUFHLENBQUNzRSxHQUFKLENBQVE7QUFBRUMsTUFBQUEsU0FBUyxFQUFFO0FBQWIsS0FBUixFQUFrRHZFLEdBQUcsQ0FBQzJFLEVBQUosQ0FBTyxFQUFQLEVBQVcsS0FBSzdELElBQUwsQ0FBVVUsQ0FBVixDQUFZLG9CQUFaLENBQVgsQ0FBbEQsQ0FURyxFQVVIdkIsRUFBRSxDQUFDUSxrQkFBRCxFQUFxQjtBQUFFc0MsTUFBQUEsSUFBSSxFQUFFLEtBQUtoQyxPQUFMLEVBQVI7QUFBd0JrQixNQUFBQSxPQUFPLEVBQUUsS0FBS3JCLEtBQUwsQ0FBV3FCO0FBQTVDLEtBQXJCLENBVkMsRUFXSGpDLEdBQUcsQ0FBQ3NFLEdBQUosQ0FDSTtBQUFFQyxNQUFBQSxTQUFTLEVBQUUsdUJBQWI7QUFBc0NDLE1BQUFBLE9BQU8sRUFBRSxLQUFLNUQsS0FBTCxDQUFXZ0U7QUFBMUQsS0FESixFQUVJM0UsRUFBRSxDQUFDRSxJQUFELEVBQU87QUFBRXVFLE1BQUFBLEdBQUcsRUFBRTtBQUFQLEtBQVAsQ0FGTixDQVhHLENBQVA7QUFnQkg7O0FBRURHLEVBQUFBLGFBQWEsR0FBRztBQUNaLFdBQU83RSxHQUFHLENBQUNzRSxHQUFKLENBQVEsRUFBUixFQUFZdEUsR0FBRyxDQUFDOEUsS0FBSixDQUFVLEVBQVYsRUFBYyxLQUFLaEUsSUFBTCxDQUFVVSxDQUFWLENBQVkscUJBQVosQ0FBZCxDQUFaLEVBQStEeEIsR0FBRyxDQUFDK0UsQ0FBSixDQUFNLEVBQU4sRUFBVSxLQUFLekQsS0FBTCxDQUFXQyxjQUFyQixDQUEvRCxDQUFQO0FBQ0g7O0FBRUR5RCxFQUFBQSxZQUFZLEdBQUc7QUFDWCxVQUFNaEIsT0FBTyxHQUFHLEtBQUtHLHdCQUFMLE1BQW1DLEtBQUs3QyxLQUFMLENBQVdHLGdCQUE5RDtBQUVBLFdBQU96QixHQUFHLENBQUNzRSxHQUFKLENBQ0gsRUFERyxFQUVIdEUsR0FBRyxDQUFDOEUsS0FBSixDQUFVLEVBQVYsRUFBYyxLQUFLaEUsSUFBTCxDQUFVVSxDQUFWLENBQVksdUJBQVosQ0FBZCxDQUZHLEVBR0h4QixHQUFHLENBQUNzRSxHQUFKLENBQ0k7QUFDSVcsTUFBQUEsS0FBSyxFQUFFO0FBQ0hDLFFBQUFBLE9BQU8sRUFBRSxNQUROO0FBRUhDLFFBQUFBLGNBQWMsRUFBRSxlQUZiO0FBR0hDLFFBQUFBLFVBQVUsRUFBRSxRQUhUO0FBSUhDLFFBQUFBLFdBQVcsRUFBRTtBQUpWO0FBRFgsS0FESixFQVNJckYsR0FBRyxDQUFDc0YsS0FBSixDQUFVO0FBQ05DLE1BQUFBLFFBQVEsRUFBRSxJQURKO0FBRU5DLE1BQUFBLEtBQUssRUFBRXhCLE9BRkQ7QUFHTk8sTUFBQUEsU0FBUyxFQUFFO0FBSEwsS0FBVixDQVRKLEVBY0l0RSxFQUFFLENBQ0VNLE1BREYsRUFFRTtBQUNJMEUsTUFBQUEsS0FBSyxFQUFFO0FBQUVRLFFBQUFBLE1BQU0sRUFBRSxRQUFWO0FBQW9CQyxRQUFBQSxPQUFPLEVBQUU7QUFBN0IsT0FEWDtBQUVJQyxNQUFBQSxJQUFJLEVBQUcsYUFBWSxDQUFDLEtBQUtyRSxLQUFMLENBQVdPLFNBQVosR0FBd0IsVUFBeEIsR0FBcUMsRUFBRyxFQUYvRDtBQUdJK0QsTUFBQUEsUUFBUSxFQUFFLENBQUMsS0FBS3RFLEtBQUwsQ0FBV08sU0FIMUI7QUFJSTJDLE1BQUFBLE9BQU8sRUFBRSxNQUFNLEtBQUsxQixZQUFMO0FBSm5CLEtBRkYsRUFRRTlDLEdBQUcsQ0FBQzZGLElBQUosQ0FBUyxFQUFULEVBQWEsS0FBSy9FLElBQUwsQ0FBVVUsQ0FBVixDQUFZLG9CQUFaLENBQWIsQ0FSRixDQWROLENBSEcsRUE0Qkh4QixHQUFHLENBQUM4RixDQUFKLENBQ0k7QUFBRWIsTUFBQUEsS0FBSyxFQUFFO0FBQUVjLFFBQUFBLEtBQUssRUFBRSxLQUFUO0FBQWdCTixRQUFBQSxNQUFNLEVBQUUsUUFBeEI7QUFBa0NQLFFBQUFBLE9BQU8sRUFBRTtBQUEzQyxPQUFUO0FBQStEVixNQUFBQSxPQUFPLEVBQUUsTUFBTSxLQUFLYixZQUFMO0FBQTlFLEtBREosRUFFSSxLQUFLN0MsSUFBTCxDQUFVVSxDQUFWLENBQVksb0JBQVosQ0FGSixDQTVCRyxDQUFQO0FBaUNIOztBQUVEd0UsRUFBQUEsaUJBQWlCLEdBQUc7QUFDaEIsV0FBT2hHLEdBQUcsQ0FBQ3NFLEdBQUosQ0FDSCxFQURHLEVBRUh0RSxHQUFHLENBQUM4RSxLQUFKLENBQVUsRUFBVixFQUFjLEtBQUtoRSxJQUFMLENBQVVVLENBQVYsQ0FBWSx5QkFBWixDQUFkLENBRkcsRUFHSHhCLEdBQUcsQ0FBQytFLENBQUosQ0FDSSxFQURKLEVBRUksS0FBS3pELEtBQUwsQ0FBV00sY0FBWCxJQUE2QixJQUE3QixHQUNNLEtBQUtOLEtBQUwsQ0FBV00sY0FBWCxDQUEwQnNDLFdBRGhDLEdBRU0sS0FBSzVDLEtBQUwsQ0FBV0ksb0JBSnJCLENBSEcsQ0FBUDtBQVVIOztBQUVEdUUsRUFBQUEsTUFBTSxHQUFHO0FBQ0wsV0FBT2pHLEdBQUcsQ0FBQ3NFLEdBQUosQ0FDSGxFLENBQUMsQ0FBQ2lCLE1BQUYsQ0FBUyxFQUFULEVBQWEsS0FBS1QsS0FBbEIsRUFBeUI7QUFBRTJELE1BQUFBLFNBQVMsRUFBRyxHQUFFLEtBQUszRCxLQUFMLENBQVcyRCxTQUFYLElBQXdCLEVBQUc7QUFBM0MsS0FBekIsQ0FERyxFQUVILEtBQUtGLFlBQUwsRUFGRyxFQUdIckUsR0FBRyxDQUFDc0UsR0FBSixDQUNJO0FBQUVDLE1BQUFBLFNBQVMsRUFBRTtBQUFiLEtBREosRUFFSXZFLEdBQUcsQ0FBQ3NFLEdBQUosQ0FDSTtBQUFFVyxNQUFBQSxLQUFLLEVBQUU7QUFBRWlCLFFBQUFBLFlBQVksRUFBRTtBQUFoQjtBQUFULEtBREosRUFFSWxHLEdBQUcsQ0FBQ3NFLEdBQUosQ0FDSTtBQUFFQyxNQUFBQSxTQUFTLEVBQUU7QUFBYixLQURKLEVBRUksS0FBS00sYUFBTCxFQUZKLEVBR0ksS0FBS0csWUFBTCxFQUhKLEVBSUksS0FBS2dCLGlCQUFMLEVBSkosQ0FGSixDQUZKLENBSEcsQ0FBUDtBQWdCSDs7QUEvTjJDOztBQWtPaER0RixtQkFBbUIsQ0FBQ3lGLFNBQXBCLEdBQWdDL0YsQ0FBQyxDQUFDaUIsTUFBRixDQUFTLEVBQVQsRUFBYXRCLGFBQWEsQ0FBQ29HLFNBQTNCLEVBQXNDO0FBQ2xFdkIsRUFBQUEsT0FBTyxFQUFFL0UsS0FBSyxDQUFDdUcsU0FBTixDQUFnQkMsSUFEeUM7QUFFbEU1QixFQUFBQSxNQUFNLEVBQUU1RSxLQUFLLENBQUN1RyxTQUFOLENBQWdCQyxJQUYwQztBQUdsRXBFLEVBQUFBLE9BQU8sRUFBRXBDLEtBQUssQ0FBQ3VHLFNBQU4sQ0FBZ0JFLE1BQWhCLENBQXVCQztBQUhrQyxDQUF0QyxDQUFoQztBQU1BN0YsbUJBQW1CLENBQUM4RixZQUFwQixHQUFtQztBQUMvQjVCLEVBQUFBLE9BQU8sRUFBRSxNQUFNLENBQUUsQ0FEYztBQUUvQkgsRUFBQUEsTUFBTSxFQUFFLE1BQU0sQ0FBRSxDQUZlO0FBRy9CekIsRUFBQUEsUUFBUSxFQUFFLE1BQU0sQ0FBRTtBQUhhLENBQW5DO0FBTUF5RCxNQUFNLENBQUNDLE9BQVAsR0FBaUJoRyxtQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5jb25zdCBSZWFjdCA9IHJlcXVpcmUoJ3JlYWN0Jyk7XHJcbmNvbnN0IEZsdXhDb21wb25lbnQgPSByZXF1aXJlKCdlYWdsZS1wcmludC92aWV3cy9mbHV4X2NvbXBvbmVudCcpO1xyXG5jb25zdCBET00gPSBSZWFjdC5ET007XHJcbmNvbnN0IGNlID0gUmVhY3QuY3JlYXRlRWxlbWVudDtcclxuY29uc3QgSXN2ZyA9IHJlcXVpcmUoJ3JlYWN0LWlubGluZXN2ZycpO1xyXG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XHJcbmNvbnN0IGRpYWxvZyA9IHJlcXVpcmUoJ2VsZWN0cm9uJykucmVtb3RlLmRpYWxvZztcclxuY29uc3QgQnV0dG9uID0gcmVxdWlyZSgnZWFnbGUtcHJpbnQvdmlld3MvdWkvYnV0dG9uLmpzJyk7XHJcblxyXG5jb25zdCBmaXJtd2FyZVV0aWxzID0gcmVxdWlyZSgnLi4vLi4vLi4vZmlybXdhcmVVdGlscycpO1xyXG5jb25zdCBIZWFkZXJTZWxlY3RCdXR0b24gPSByZXF1aXJlKCcuLi9oZWFkZXJTZWxlY3RCdXR0b24nKTtcclxuXHJcbmNsYXNzIEZpcm13YXJlVXBkYXRlUGFuZWwgZXh0ZW5kcyBGbHV4Q29tcG9uZW50IHtcclxuICAgIC8qKiBAY29uc3RydWN0b3IgKiovXHJcbiAgICBjb25zdHJ1Y3Rvcihwcm9wcywgY29udGV4dCkge1xyXG4gICAgICAgIHN1cGVyKHByb3BzLCBjb250ZXh0KTtcclxuXHJcbiAgICAgICAgdGhpcy5pMThuID0gdGhpcy5nZXRGbHV4KCkuZ2V0U2VydmljZSgnVHJhbnNsYXRpb25TZXJ2aWNlJyk7XHJcbiAgICAgICAgdGhpcy50cmFja2luZyA9IHRoaXMuZ2V0Rmx1eCgpLmdldFNlcnZpY2UoJ1RyYWNraW5nU2VydmljZScpO1xyXG4gICAgICAgIHRoaXMubG9nZ2VyID0gdGhpcy5nZXRGbHV4KCkuZ2V0U2VydmljZSgnTG9nZ2luZ1NlcnZpY2UnKTtcclxuICAgICAgICB0aGlzLm1lc3NhZ2UgPSB0aGlzLmdldEZsdXgoKS5hY3Rpb25zLm1lc3NhZ2U7XHJcblxyXG4gICAgICAgIF8uYXNzaWduKHRoaXMuc3RhdGUsIHtcclxuICAgICAgICAgICAgY3VycmVudFZlcnNpb246IHRoaXMuaTE4bi50KCdtYjpmaXJtd2FyZS5jaGVja2luZycpLFxyXG4gICAgICAgICAgICBhdmFpbGFibGVWZXJzaW9uOiB0aGlzLmkxOG4udCgnbWI6ZmlybXdhcmUuY2hlY2tpbmcnKSxcclxuICAgICAgICAgICAgYXZhaWxhYmxlRGVzY3JpcHRpb246ICcnLFxyXG4gICAgICAgICAgICBjdXN0b21GaWxlbmFtZTogbnVsbCxcclxuICAgICAgICAgICAgY3VzdG9tTWFuaWZlc3Q6IG51bGwsXHJcbiAgICAgICAgICAgIGNhblVwZGF0ZTogZmFsc2UsXHJcbiAgICAgICAgICAgIGJyb3dzaW5nOiBmYWxzZSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb21wb25lbnREaWRNb3VudCgpIHtcclxuICAgICAgICBjb25zdCBmdyA9IHRoaXMucHJvcHMucHJpbnRlci5maXJtd2FyZS5hdmFpbGFibGVVcGRhdGU7XHJcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGN1cnJlbnRWZXJzaW9uOiB0aGlzLnByb3BzLnByaW50ZXIuZ2V0SW5mbygpLmZpcm13YXJlX3ZlcnNpb24gfSk7XHJcblxyXG4gICAgICAgIHRoaXMucHJvcHMucHJpbnRlci5maXJtd2FyZS5saXN0ZW4odGhpcy5faGFuZGxlTm90aWYuYmluZCh0aGlzKSk7XHJcbiAgICAgICAgaWYgKHRoaXMucHJvcHMucHJpbnRlci5maXJtd2FyZS5oYXNVcGRhdGUoKSkge1xyXG4gICAgICAgICAgICB0aGlzLl9oYW5kbGVOb3RpZihmdyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5wcm9wcy5wcmludGVyLmZpcm13YXJlLmNoZWNrKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xyXG4gICAgICAgIHRoaXMucHJvcHMucHJpbnRlci5maXJtd2FyZS5yZW1vdmUodGhpcy5faGFuZGxlTm90aWYuYmluZCh0aGlzKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBVcGRhdGVzIHRoZSBwcmludGVyIHdpdGggZWl0aGVyIHRoZSBsYXRlc3QgdmVyc2lvbiB0aGUgcHJpbnRlciBrbm93cyBhYm91dCwgb3Igd2l0aFxyXG4gICAgICogYSBjdXN0b20gZmlybXdhcmUgZmlsZSB0aGF0IHRoZSB1c2VyIGNob29zZXMuXHJcbiAgICAgKiBAcmV0dXJucyB7cS5Qcm9taXNlfVxyXG4gICAgICovXHJcbiAgICBoYW5kbGVVcGRhdGUoKSB7XHJcbiAgICAgICAgY29uc3QgZmx1eCA9IHRoaXMuZ2V0Rmx1eCgpO1xyXG4gICAgICAgIHRoaXMucHJvcHMub25VcGRhdGUoKTtcclxuXHJcbiAgICAgICAgLy8gaWYgdGhlIHVzZXIgaGFzbid0IGNob3NlbiBhIHNwZWNpZmljIGZpcm13YXJlIGZpbGUgdG8gdXNlLCBqdXN0IHRlbGwgdGhlIHByaW50ZXJcclxuICAgICAgICAvLyB0byBncmFiIG9uZSBmcm9tIHRoZSB3ZWIgKG9yIHRoZSBvbmUgaXQgYWxyZWFkeSBoYXMpXHJcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuY3VzdG9tRmlsZW5hbWUgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLnRyYWNraW5nLmFkZEV2ZW50KHsgbmFtZTogJ2Zpcm13YXJlX3VwZGF0ZV9pbml0aWFsaXplZCcgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBmaXJtd2FyZVV0aWxzLnVwZGF0ZUZpcm13YXJlKHRoaXMucHJvcHMucHJpbnRlciwgZmx1eCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnRyYWNraW5nLmFkZEV2ZW50KHsgbmFtZTogJ2Zpcm13YXJlX3VwbG9hZF9pbml0aWFsaXplZCcgfSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMucHJpbnRlci5maXJtd2FyZVxyXG4gICAgICAgICAgICAudXBsb2FkKHRoaXMuc3RhdGUuY3VzdG9tRmlsZW5hbWUpXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMubG9nZ2VyLmluZm8oJ3VwbG9hZGluZyBmaXJtd2FyZScpKVxyXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZS5jcmVhdGVFcnJvck1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgIGlkOiAnZmlybXdhcmUtdXBkYXRlLWVycm9yJyxcclxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnIsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBPcGVucyBhIFwiQ2hvb3NlIEZpbGVcIiBkaWFsb2cgdG8gcGljayBhIGN1c3RvbSBmaXJtd2FyZSBmaWxlIHRoYXRcclxuICAgICAqIGNhbiBiZSB1cGxvYWRlZCB0byB0aGUgcHJpbnRlci4gVGhvc2UgZmlsZXMgc2hvdWxkIGJlIC56aXBcclxuICAgICAqKi9cclxuICAgIGhhbmRsZUJyb3dzZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5zdGF0ZS5icm93c2luZykge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgYnJvd3Npbmc6IHRydWUgfSk7XHJcbiAgICAgICAgZGlhbG9nLnNob3dPcGVuRGlhbG9nKHt9LCBmID0+IHtcclxuICAgICAgICAgICAgaWYgKGYpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLnByaW50ZXIuZmlybXdhcmVcclxuICAgICAgICAgICAgICAgICAgICAudmVyaWZ5KGZbMF0pXHJcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4obWFuaWZlc3QgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbUZpbGVuYW1lOiBmWzBdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tTWFuaWZlc3Q6IG1hbmlmZXN0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuVXBkYXRlOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJvd3Npbmc6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaChlcnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgYnJvd3Npbmc6IGZhbHNlIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2UuY3JlYXRlRXJyb3JNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAnZmlybXdhcmUtdXBkYXRlLWVycm9yJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVycixcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBicm93c2luZzogZmFsc2UgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICogSWYgdGhlIHByb3ZpZGVkIGZpcm13YXJlIGlzIGEgbmV3ZXIgdmVyc2lvbiB0aGFuIHRoZSBjdXJyZW50IGZpcm13YXJlLCB1cGRhdGUgdGhlXHJcbiAgICAgKiBjb21wb25lbnQgc3RhdGUgYW5kIGFsbG93IHRoZSB1c2VyIHRvIGluaXRpYXRlIHRoZSB1cGRhdGUuXHJcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gZmlybXdhcmUgLSB0aGUgbW9zdCByZWNlbnQgdmVyc2lvbiBvZiB0aGUgZmlybXdhcmUgd2UgZm91bmRcclxuICAgICAqL1xyXG4gICAgX2hhbmRsZU5vdGlmKGZpcm13YXJlKSB7XHJcbiAgICAgICAgaWYgKHRoaXMucHJvcHMucHJpbnRlci5maXJtd2FyZS5oYXNVcGRhdGUoKSkge1xyXG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcclxuICAgICAgICAgICAgICAgIGF2YWlsYWJsZVZlcnNpb246IGZpcm13YXJlLm1hbmlmZXN0LnZlcnNpb24uam9pbignLicpLFxyXG4gICAgICAgICAgICAgICAgYXZhaWxhYmxlRGVzY3JpcHRpb246IGZpcm13YXJlLm1hbmlmZXN0LmRlc2NyaXB0aW9uLFxyXG4gICAgICAgICAgICAgICAgY2FuVXBkYXRlOiB0cnVlLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcclxuICAgICAgICAgICAgICAgIGF2YWlsYWJsZVZlcnNpb246IHRoaXMuaTE4bi50KCdtYjpmaXJtd2FyZS5ub25lJyksXHJcbiAgICAgICAgICAgICAgICBhdmFpbGFibGVEZXNjcmlwdGlvbjogdGhpcy5pMThuLnQoJ21iOmZpcm13YXJlLm5vbmUnKSxcclxuICAgICAgICAgICAgICAgIGNhblVwZGF0ZTogZmFsc2UsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBfcGFyc2VDdXN0b21GaXJtd2FyZU5hbWUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuY3VzdG9tTWFuaWZlc3QpIHtcclxuICAgICAgICAgICAgY29uc3QgcHJvZHVjdCA9IHRoaXMuc3RhdGUuY3VzdG9tTWFuaWZlc3QucHJvZHVjdDtcclxuICAgICAgICAgICAgY29uc3QgdmVyc2lvbiA9IHRoaXMuc3RhdGUuY3VzdG9tTWFuaWZlc3QudmVyc2lvbi5qb2luKCcuJyk7XHJcbiAgICAgICAgICAgIHJldHVybiBgJHtwcm9kdWN0fSAke3ZlcnNpb259YDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbmRlckhlYWRlcigpIHtcclxuICAgICAgICByZXR1cm4gRE9NLmRpdihcclxuICAgICAgICAgICAgeyBjbGFzc05hbWU6ICdwcmludGVyUGFuZWxIZWFkZXInIH0sXHJcbiAgICAgICAgICAgIERPTS5kaXYoXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAncHJpbnRlclBhbmVsQmFja0J1dHRvbicsXHJcbiAgICAgICAgICAgICAgICAgICAgb25DbGljazogdGhpcy5wcm9wcy5vbkJhY2ssXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgY2UoSXN2ZywgeyBzcmM6ICdpY29ucy9iYWNrLWFycm93LnN2ZycgfSlcclxuICAgICAgICAgICAgKSxcclxuICAgICAgICAgICAgRE9NLmRpdih7IGNsYXNzTmFtZTogJ3ByaW50ZXJQYW5lbEhlYWRlckxhYmVsJyB9LCBET00uaDEoe30sIHRoaXMuaTE4bi50KCdtYjpmaXJtd2FyZS5oZWFkZXInKSkpLFxyXG4gICAgICAgICAgICBjZShIZWFkZXJTZWxlY3RCdXR0b24sIHsgZmx1eDogdGhpcy5nZXRGbHV4KCksIHByaW50ZXI6IHRoaXMucHJvcHMucHJpbnRlciB9KSxcclxuICAgICAgICAgICAgRE9NLmRpdihcclxuICAgICAgICAgICAgICAgIHsgY2xhc3NOYW1lOiAncHJpbnRlclBhbmVsQXJyb3dEb3duJywgb25DbGljazogdGhpcy5wcm9wcy5vbkNsb3NlIH0sXHJcbiAgICAgICAgICAgICAgICBjZShJc3ZnLCB7IHNyYzogJ2ljb25zL2JhY2stYXJyb3cuc3ZnJyB9KVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICByZW5kZXJDdXJyZW50KCkge1xyXG4gICAgICAgIHJldHVybiBET00uZGl2KHt9LCBET00ubGFiZWwoe30sIHRoaXMuaTE4bi50KCdtYjpmaXJtd2FyZS5jdXJyZW50JykpLCBET00ucCh7fSwgdGhpcy5zdGF0ZS5jdXJyZW50VmVyc2lvbikpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbmRlclVwZGF0ZSgpIHtcclxuICAgICAgICBjb25zdCB2ZXJzaW9uID0gdGhpcy5fcGFyc2VDdXN0b21GaXJtd2FyZU5hbWUoKSB8fCB0aGlzLnN0YXRlLmF2YWlsYWJsZVZlcnNpb247XHJcblxyXG4gICAgICAgIHJldHVybiBET00uZGl2KFxyXG4gICAgICAgICAgICB7fSxcclxuICAgICAgICAgICAgRE9NLmxhYmVsKHt9LCB0aGlzLmkxOG4udCgnbWI6ZmlybXdhcmUudXBkYXRlX3RvJykpLFxyXG4gICAgICAgICAgICBET00uZGl2KFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdmbGV4JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICdzcGFjZS1iZXR3ZWVuJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ25JdGVtczogJ2NlbnRlcicsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpblJpZ2h0OiAnMTBweCcsXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBET00uaW5wdXQoe1xyXG4gICAgICAgICAgICAgICAgICAgIHJlYWRPbmx5OiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiB2ZXJzaW9uLFxyXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogJ2lucHV0LXRleHQnLFxyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICBjZShcclxuICAgICAgICAgICAgICAgICAgICBCdXR0b24sXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogeyBtYXJnaW46ICcwIDEycHgnLCBwYWRkaW5nOiAnOHB4IDEycHgnIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGBzZWNvbmRhcnkgJHshdGhpcy5zdGF0ZS5jYW5VcGRhdGUgPyAnZGlzYWJsZWQnIDogJyd9YCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ6ICF0aGlzLnN0YXRlLmNhblVwZGF0ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gdGhpcy5oYW5kbGVVcGRhdGUoKSxcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIERPTS5zcGFuKHt9LCB0aGlzLmkxOG4udCgnbWI6ZmlybXdhcmUudXBkYXRlJykpXHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICksXHJcbiAgICAgICAgICAgIERPTS5hKFxyXG4gICAgICAgICAgICAgICAgeyBzdHlsZTogeyBjb2xvcjogJ3JlZCcsIG1hcmdpbjogJzEwcHggMCcsIGRpc3BsYXk6ICdibG9jaycgfSwgb25DbGljazogKCkgPT4gdGhpcy5oYW5kbGVCcm93c2UoKSB9LFxyXG4gICAgICAgICAgICAgICAgdGhpcy5pMThuLnQoJ21iOmZpcm13YXJlLmJyb3dzZScpXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbmRlckRlc2NyaXB0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiBET00uZGl2KFxyXG4gICAgICAgICAgICB7fSxcclxuICAgICAgICAgICAgRE9NLmxhYmVsKHt9LCB0aGlzLmkxOG4udCgnbWI6ZmlybXdhcmUuZGVzY3JpcHRpb24nKSksXHJcbiAgICAgICAgICAgIERPTS5wKFxyXG4gICAgICAgICAgICAgICAge30sXHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLmN1c3RvbU1hbmlmZXN0ICE9IG51bGxcclxuICAgICAgICAgICAgICAgICAgICA/IHRoaXMuc3RhdGUuY3VzdG9tTWFuaWZlc3QuZGVzY3JpcHRpb25cclxuICAgICAgICAgICAgICAgICAgICA6IHRoaXMuc3RhdGUuYXZhaWxhYmxlRGVzY3JpcHRpb25cclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVuZGVyKCkge1xyXG4gICAgICAgIHJldHVybiBET00uZGl2KFxyXG4gICAgICAgICAgICBfLmFzc2lnbih7fSwgdGhpcy5wcm9wcywgeyBjbGFzc05hbWU6IGAke3RoaXMucHJvcHMuY2xhc3NOYW1lIHx8ICcnfSBwcmludGVyUGFuZWxgIH0pLFxyXG4gICAgICAgICAgICB0aGlzLnJlbmRlckhlYWRlcigpLFxyXG4gICAgICAgICAgICBET00uZGl2KFxyXG4gICAgICAgICAgICAgICAgeyBjbGFzc05hbWU6ICdwcmludGVyUGFuZWwnIH0sXHJcbiAgICAgICAgICAgICAgICBET00uZGl2KFxyXG4gICAgICAgICAgICAgICAgICAgIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiA1MCB9IH0sXHJcbiAgICAgICAgICAgICAgICAgICAgRE9NLmRpdihcclxuICAgICAgICAgICAgICAgICAgICAgICAgeyBjbGFzc05hbWU6ICdwYW5lbC1ib2R5JyB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckN1cnJlbnQoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJVcGRhdGUoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJEZXNjcmlwdGlvbigpXHJcbiAgICAgICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxufVxyXG5cclxuRmlybXdhcmVVcGRhdGVQYW5lbC5wcm9wVHlwZXMgPSBfLmFzc2lnbih7fSwgRmx1eENvbXBvbmVudC5wcm9wVHlwZXMsIHtcclxuICAgIG9uQ2xvc2U6IFJlYWN0LlByb3BUeXBlcy5mdW5jLFxyXG4gICAgb25CYWNrOiBSZWFjdC5Qcm9wVHlwZXMuZnVuYyxcclxuICAgIHByaW50ZXI6IFJlYWN0LlByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcclxufSk7XHJcblxyXG5GaXJtd2FyZVVwZGF0ZVBhbmVsLmRlZmF1bHRQcm9wcyA9IHtcclxuICAgIG9uQ2xvc2U6ICgpID0+IHt9LFxyXG4gICAgb25CYWNrOiAoKSA9PiB7fSxcclxuICAgIG9uVXBkYXRlOiAoKSA9PiB7fSxcclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gRmlybXdhcmVVcGRhdGVQYW5lbDtcclxuIl19
