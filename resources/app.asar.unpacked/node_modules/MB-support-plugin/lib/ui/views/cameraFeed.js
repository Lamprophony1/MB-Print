'use strict';

const React = require('react');

const ce = React.createElement;
const DOM = React.DOM;

const ReactDOM = require('react-dom');

const path = require('path');

const styles = require('./styles');

const PrinterStateEnum = require('../../constants').PrinterStateEnum;

const BotTypeEnum = require('../../constants').BotTypeEnum; // width:height of unrotated camera frame


const ASPECT_RATIO = 4 / 3;
module.exports = React.createClass({
  displayName: 'CameraFeed',
  propTypes: {
    printer: React.PropTypes.object.isRequired,
    props: React.PropTypes.object
  },

  cameraFrameCallback() {},

  getInitialState() {
    const self = this;
    return {
      width: 360,

      get height() {
        return this.width * 1 / ASPECT_RATIO;
      },

      get rotatedHeight() {
        return this.width * ASPECT_RATIO;
      },

      get shouldRotate() {
        return self.props.printer.getGender().botType === BotTypeEnum.z18_6;
      }

    };
  },

  componentDidMount() {
    const width = ReactDOM.findDOMNode(this).offsetWidth;
    this.setState({
      width
    });
  },

  componentWillReceiveProps(nextProps) {
    const self = this;

    if (nextProps.printer !== self.props.printer || !nextProps.printer.cameraFeedActive) {
      self.cameraFrameCallback = function (cameraImageData) {
        self.setState({
          cameraImage: cameraImageData
        });
      };

      if (nextProps.printer.isAuthenticated()) {
        nextProps.printer.getCameraFeed(function (cameraImageData) {
          self.cameraFrameCallback(cameraImageData);
        });
      }
    }
  },

  componentWillUnmount() {
    const self = this; // make this do nothing so that frames we receive between invoking
    // end camera stream and the bot actually stopping sending frames does
    // not trigger setState

    self.cameraFrameCallback = function () {};

    if (this.props.printer.isAuthenticated()) {
      this.props.printer.endCameraFeed();
    }
  },

  _getLoadingSpinner() {
    // magic numbers; should be the same as the busy printer badge...
    const radius = 50;
    const drawRadius = 41;
    const style = styles.dashedCircle(drawRadius, 4);
    return DOM.div({
      style: {
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        backgroundColor: styles.offWhite(),
        width: this.state.width,
        height: this.state.shouldRotate ? this.state.rotatedHeight : this.state.height,
        overflow: 'hidden'
      }
    }, ce('svg', {
      style: {
        width: 2 * radius,
        height: 2 * radius
      }
    }, ce('circle', {
      cx: radius,
      cy: radius,
      r: drawRadius,
      strokeWidth: '6px',
      className: 'makerbot-grey-stroke',
      style
    })));
  },

  _getCameraImage() {
    const style = {
      width: '100%'
    };

    if (this.props.printer.getGender().botType === BotTypeEnum.sketch) {
      style.height = '100%';
    }

    if (this.state.shouldRotate) {
      style.transform = `${'rotate(-90deg) ' + 'translate('}${0.5 * (this.state.height - this.state.rotatedHeight)}px) ` + `scale(${ASPECT_RATIO})`;
    }

    return DOM.img({
      src: this.state.cameraImage,
      style
    });
  },

  _getAuthImage() {
    const botType = this.props.printer.getGender().botType;
    let imageSrc = 'images/authorize_rep5.png';

    if (botType === BotTypeEnum.mini_8) {
      imageSrc = 'images/authorize_mini.png';
    } else if (this.props.printer.isSixthGen()) {
      imageSrc = 'images/authorize_fire_e.png';
    }

    imageSrc = path.resolve(__dirname, imageSrc);
    const props = {
      id: 'printerImg',
      src: imageSrc
    };
    return /*#__PURE__*/React.createElement("img", props);
  },

  render() {
    const self = this;
    const selectedPrinter = this.props.printer;
    let printerState;
    if (selectedPrinter) printerState = selectedPrinter.getStatus().state;

    if (printerState === PrinterStateEnum.Authenticating) {
      return self._getAuthImage();
    } else if (selectedPrinter && self.state.cameraImage) {
      return DOM.div({
        style: {
          backgroundColor: 'white',
          height: self.state.shouldRotate ? self.state.rotatedHeight + 3 : self.state.height + 3,
          overflow: 'auto',
          draggable: false
        }
      }, self._getCameraImage());
    } else {
      return self._getLoadingSpinner();
    }
  }

});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhbWVyYUZlZWQuanMiXSwibmFtZXMiOlsiUmVhY3QiLCJyZXF1aXJlIiwiY2UiLCJjcmVhdGVFbGVtZW50IiwiRE9NIiwiUmVhY3RET00iLCJwYXRoIiwic3R5bGVzIiwiUHJpbnRlclN0YXRlRW51bSIsIkJvdFR5cGVFbnVtIiwiQVNQRUNUX1JBVElPIiwibW9kdWxlIiwiZXhwb3J0cyIsImNyZWF0ZUNsYXNzIiwiZGlzcGxheU5hbWUiLCJwcm9wVHlwZXMiLCJwcmludGVyIiwiUHJvcFR5cGVzIiwib2JqZWN0IiwiaXNSZXF1aXJlZCIsInByb3BzIiwiY2FtZXJhRnJhbWVDYWxsYmFjayIsImdldEluaXRpYWxTdGF0ZSIsInNlbGYiLCJ3aWR0aCIsImhlaWdodCIsInJvdGF0ZWRIZWlnaHQiLCJzaG91bGRSb3RhdGUiLCJnZXRHZW5kZXIiLCJib3RUeXBlIiwiejE4XzYiLCJjb21wb25lbnREaWRNb3VudCIsImZpbmRET01Ob2RlIiwib2Zmc2V0V2lkdGgiLCJzZXRTdGF0ZSIsImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiLCJuZXh0UHJvcHMiLCJjYW1lcmFGZWVkQWN0aXZlIiwiY2FtZXJhSW1hZ2VEYXRhIiwiY2FtZXJhSW1hZ2UiLCJpc0F1dGhlbnRpY2F0ZWQiLCJnZXRDYW1lcmFGZWVkIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJlbmRDYW1lcmFGZWVkIiwiX2dldExvYWRpbmdTcGlubmVyIiwicmFkaXVzIiwiZHJhd1JhZGl1cyIsInN0eWxlIiwiZGFzaGVkQ2lyY2xlIiwiZGl2IiwiZGlzcGxheSIsImFsaWduSXRlbXMiLCJqdXN0aWZ5Q29udGVudCIsImJhY2tncm91bmRDb2xvciIsIm9mZldoaXRlIiwic3RhdGUiLCJvdmVyZmxvdyIsImN4IiwiY3kiLCJyIiwic3Ryb2tlV2lkdGgiLCJjbGFzc05hbWUiLCJfZ2V0Q2FtZXJhSW1hZ2UiLCJza2V0Y2giLCJ0cmFuc2Zvcm0iLCJpbWciLCJzcmMiLCJfZ2V0QXV0aEltYWdlIiwiaW1hZ2VTcmMiLCJtaW5pXzgiLCJpc1NpeHRoR2VuIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsImlkIiwicmVuZGVyIiwic2VsZWN0ZWRQcmludGVyIiwicHJpbnRlclN0YXRlIiwiZ2V0U3RhdHVzIiwiQXV0aGVudGljYXRpbmciLCJkcmFnZ2FibGUiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsTUFBTUMsRUFBRSxHQUFHRixLQUFLLENBQUNHLGFBQWpCO0FBQ0EsTUFBTUMsR0FBRyxHQUFHSixLQUFLLENBQUNJLEdBQWxCOztBQUNBLE1BQU1DLFFBQVEsR0FBR0osT0FBTyxDQUFDLFdBQUQsQ0FBeEI7O0FBQ0EsTUFBTUssSUFBSSxHQUFHTCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFFQSxNQUFNTSxNQUFNLEdBQUdOLE9BQU8sQ0FBQyxVQUFELENBQXRCOztBQUNBLE1BQU1PLGdCQUFnQixHQUFHUCxPQUFPLENBQUMsaUJBQUQsQ0FBUCxDQUEyQk8sZ0JBQXBEOztBQUNBLE1BQU1DLFdBQVcsR0FBR1IsT0FBTyxDQUFDLGlCQUFELENBQVAsQ0FBMkJRLFdBQS9DLEMsQ0FFQTs7O0FBQ0EsTUFBTUMsWUFBWSxHQUFHLElBQUksQ0FBekI7QUFFQUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCWixLQUFLLENBQUNhLFdBQU4sQ0FBa0I7QUFDL0JDLEVBQUFBLFdBQVcsRUFBRSxZQURrQjtBQUcvQkMsRUFBQUEsU0FBUyxFQUFFO0FBQ1BDLElBQUFBLE9BQU8sRUFBRWhCLEtBQUssQ0FBQ2lCLFNBQU4sQ0FBZ0JDLE1BQWhCLENBQXVCQyxVQUR6QjtBQUVQQyxJQUFBQSxLQUFLLEVBQUVwQixLQUFLLENBQUNpQixTQUFOLENBQWdCQztBQUZoQixHQUhvQjs7QUFRL0JHLEVBQUFBLG1CQUFtQixHQUFHLENBQUUsQ0FSTzs7QUFVL0JDLEVBQUFBLGVBQWUsR0FBRztBQUNkLFVBQU1DLElBQUksR0FBRyxJQUFiO0FBQ0EsV0FBTztBQUNIQyxNQUFBQSxLQUFLLEVBQUUsR0FESjs7QUFFSCxVQUFJQyxNQUFKLEdBQWE7QUFDVCxlQUFRLEtBQUtELEtBQUwsR0FBYSxDQUFkLEdBQW1CZCxZQUExQjtBQUNILE9BSkU7O0FBS0gsVUFBSWdCLGFBQUosR0FBb0I7QUFDaEIsZUFBTyxLQUFLRixLQUFMLEdBQWFkLFlBQXBCO0FBQ0gsT0FQRTs7QUFRSCxVQUFJaUIsWUFBSixHQUFtQjtBQUNmLGVBQU9KLElBQUksQ0FBQ0gsS0FBTCxDQUFXSixPQUFYLENBQW1CWSxTQUFuQixHQUErQkMsT0FBL0IsS0FBMkNwQixXQUFXLENBQUNxQixLQUE5RDtBQUNIOztBQVZFLEtBQVA7QUFZSCxHQXhCOEI7O0FBMEIvQkMsRUFBQUEsaUJBQWlCLEdBQUc7QUFDaEIsVUFBTVAsS0FBSyxHQUFHbkIsUUFBUSxDQUFDMkIsV0FBVCxDQUFxQixJQUFyQixFQUEyQkMsV0FBekM7QUFDQSxTQUFLQyxRQUFMLENBQWM7QUFBRVYsTUFBQUE7QUFBRixLQUFkO0FBQ0gsR0E3QjhCOztBQStCL0JXLEVBQUFBLHlCQUF5QixDQUFDQyxTQUFELEVBQVk7QUFDakMsVUFBTWIsSUFBSSxHQUFHLElBQWI7O0FBRUEsUUFBSWEsU0FBUyxDQUFDcEIsT0FBVixLQUFzQk8sSUFBSSxDQUFDSCxLQUFMLENBQVdKLE9BQWpDLElBQTRDLENBQUNvQixTQUFTLENBQUNwQixPQUFWLENBQWtCcUIsZ0JBQW5FLEVBQXFGO0FBQ2pGZCxNQUFBQSxJQUFJLENBQUNGLG1CQUFMLEdBQTJCLFVBQVNpQixlQUFULEVBQTBCO0FBQ2pEZixRQUFBQSxJQUFJLENBQUNXLFFBQUwsQ0FBYztBQUFFSyxVQUFBQSxXQUFXLEVBQUVEO0FBQWYsU0FBZDtBQUNILE9BRkQ7O0FBSUEsVUFBSUYsU0FBUyxDQUFDcEIsT0FBVixDQUFrQndCLGVBQWxCLEVBQUosRUFBeUM7QUFDckNKLFFBQUFBLFNBQVMsQ0FBQ3BCLE9BQVYsQ0FBa0J5QixhQUFsQixDQUFnQyxVQUFTSCxlQUFULEVBQTBCO0FBQ3REZixVQUFBQSxJQUFJLENBQUNGLG1CQUFMLENBQXlCaUIsZUFBekI7QUFDSCxTQUZEO0FBR0g7QUFDSjtBQUNKLEdBN0M4Qjs7QUErQy9CSSxFQUFBQSxvQkFBb0IsR0FBRztBQUNuQixVQUFNbkIsSUFBSSxHQUFHLElBQWIsQ0FEbUIsQ0FFbkI7QUFDQTtBQUNBOztBQUNBQSxJQUFBQSxJQUFJLENBQUNGLG1CQUFMLEdBQTJCLFlBQVcsQ0FBRSxDQUF4Qzs7QUFFQSxRQUFJLEtBQUtELEtBQUwsQ0FBV0osT0FBWCxDQUFtQndCLGVBQW5CLEVBQUosRUFBMEM7QUFDdEMsV0FBS3BCLEtBQUwsQ0FBV0osT0FBWCxDQUFtQjJCLGFBQW5CO0FBQ0g7QUFDSixHQXpEOEI7O0FBMkQvQkMsRUFBQUEsa0JBQWtCLEdBQUc7QUFDakI7QUFDQSxVQUFNQyxNQUFNLEdBQUcsRUFBZjtBQUNBLFVBQU1DLFVBQVUsR0FBRyxFQUFuQjtBQUNBLFVBQU1DLEtBQUssR0FBR3hDLE1BQU0sQ0FBQ3lDLFlBQVAsQ0FBb0JGLFVBQXBCLEVBQWdDLENBQWhDLENBQWQ7QUFFQSxXQUFPMUMsR0FBRyxDQUFDNkMsR0FBSixDQUNIO0FBQ0lGLE1BQUFBLEtBQUssRUFBRTtBQUNIRyxRQUFBQSxPQUFPLEVBQUUsTUFETjtBQUVIQyxRQUFBQSxVQUFVLEVBQUUsUUFGVDtBQUdIQyxRQUFBQSxjQUFjLEVBQUUsUUFIYjtBQUlIQyxRQUFBQSxlQUFlLEVBQUU5QyxNQUFNLENBQUMrQyxRQUFQLEVBSmQ7QUFLSDlCLFFBQUFBLEtBQUssRUFBRSxLQUFLK0IsS0FBTCxDQUFXL0IsS0FMZjtBQU1IQyxRQUFBQSxNQUFNLEVBQUUsS0FBSzhCLEtBQUwsQ0FBVzVCLFlBQVgsR0FBMEIsS0FBSzRCLEtBQUwsQ0FBVzdCLGFBQXJDLEdBQXFELEtBQUs2QixLQUFMLENBQVc5QixNQU5yRTtBQU9IK0IsUUFBQUEsUUFBUSxFQUFFO0FBUFA7QUFEWCxLQURHLEVBWUh0RCxFQUFFLENBQ0UsS0FERixFQUVFO0FBQ0k2QyxNQUFBQSxLQUFLLEVBQUU7QUFDSHZCLFFBQUFBLEtBQUssRUFBRSxJQUFJcUIsTUFEUjtBQUVIcEIsUUFBQUEsTUFBTSxFQUFFLElBQUlvQjtBQUZUO0FBRFgsS0FGRixFQVFFM0MsRUFBRSxDQUFDLFFBQUQsRUFBVztBQUNUdUQsTUFBQUEsRUFBRSxFQUFFWixNQURLO0FBRVRhLE1BQUFBLEVBQUUsRUFBRWIsTUFGSztBQUdUYyxNQUFBQSxDQUFDLEVBQUViLFVBSE07QUFJVGMsTUFBQUEsV0FBVyxFQUFFLEtBSko7QUFLVEMsTUFBQUEsU0FBUyxFQUFFLHNCQUxGO0FBTVRkLE1BQUFBO0FBTlMsS0FBWCxDQVJKLENBWkMsQ0FBUDtBQThCSCxHQS9GOEI7O0FBaUcvQmUsRUFBQUEsZUFBZSxHQUFHO0FBQ2QsVUFBTWYsS0FBSyxHQUFHO0FBQ1Z2QixNQUFBQSxLQUFLLEVBQUU7QUFERyxLQUFkOztBQUdBLFFBQUksS0FBS0osS0FBTCxDQUFXSixPQUFYLENBQW1CWSxTQUFuQixHQUErQkMsT0FBL0IsS0FBMkNwQixXQUFXLENBQUNzRCxNQUEzRCxFQUFtRTtBQUMvRGhCLE1BQUFBLEtBQUssQ0FBQ3RCLE1BQU4sR0FBZSxNQUFmO0FBQ0g7O0FBQ0QsUUFBSSxLQUFLOEIsS0FBTCxDQUFXNUIsWUFBZixFQUE2QjtBQUN6Qm9CLE1BQUFBLEtBQUssQ0FBQ2lCLFNBQU4sR0FDSyxHQUFFLG9CQUFvQixZQUFhLEdBQUUsT0FBTyxLQUFLVCxLQUFMLENBQVc5QixNQUFYLEdBQW9CLEtBQUs4QixLQUFMLENBQVc3QixhQUF0QyxDQUFxRCxNQUEzRixHQUNDLFNBQVFoQixZQUFhLEdBRjFCO0FBR0g7O0FBRUQsV0FBT04sR0FBRyxDQUFDNkQsR0FBSixDQUFRO0FBQ1hDLE1BQUFBLEdBQUcsRUFBRSxLQUFLWCxLQUFMLENBQVdoQixXQURMO0FBRVhRLE1BQUFBO0FBRlcsS0FBUixDQUFQO0FBSUgsR0FsSDhCOztBQW9IL0JvQixFQUFBQSxhQUFhLEdBQUc7QUFDWixVQUFNdEMsT0FBTyxHQUFHLEtBQUtULEtBQUwsQ0FBV0osT0FBWCxDQUFtQlksU0FBbkIsR0FBK0JDLE9BQS9DO0FBQ0EsUUFBSXVDLFFBQVEsR0FBRywyQkFBZjs7QUFDQSxRQUFJdkMsT0FBTyxLQUFLcEIsV0FBVyxDQUFDNEQsTUFBNUIsRUFBb0M7QUFDaENELE1BQUFBLFFBQVEsR0FBRywyQkFBWDtBQUNILEtBRkQsTUFFTyxJQUFJLEtBQUtoRCxLQUFMLENBQVdKLE9BQVgsQ0FBbUJzRCxVQUFuQixFQUFKLEVBQXFDO0FBQ3hDRixNQUFBQSxRQUFRLEdBQUcsNkJBQVg7QUFDSDs7QUFDREEsSUFBQUEsUUFBUSxHQUFHOUQsSUFBSSxDQUFDaUUsT0FBTCxDQUFhQyxTQUFiLEVBQXdCSixRQUF4QixDQUFYO0FBQ0EsVUFBTWhELEtBQUssR0FBRztBQUFFcUQsTUFBQUEsRUFBRSxFQUFFLFlBQU47QUFBb0JQLE1BQUFBLEdBQUcsRUFBRUU7QUFBekIsS0FBZDtBQUVBLHdCQUFPLDJCQUFTaEQsS0FBVCxDQUFQO0FBQ0gsR0FoSThCOztBQWtJL0JzRCxFQUFBQSxNQUFNLEdBQUc7QUFDTCxVQUFNbkQsSUFBSSxHQUFHLElBQWI7QUFDQSxVQUFNb0QsZUFBZSxHQUFHLEtBQUt2RCxLQUFMLENBQVdKLE9BQW5DO0FBRUEsUUFBSTRELFlBQUo7QUFDQSxRQUFJRCxlQUFKLEVBQXFCQyxZQUFZLEdBQUdELGVBQWUsQ0FBQ0UsU0FBaEIsR0FBNEJ0QixLQUEzQzs7QUFFckIsUUFBSXFCLFlBQVksS0FBS3BFLGdCQUFnQixDQUFDc0UsY0FBdEMsRUFBc0Q7QUFDbEQsYUFBT3ZELElBQUksQ0FBQzRDLGFBQUwsRUFBUDtBQUNILEtBRkQsTUFFTyxJQUFJUSxlQUFlLElBQUlwRCxJQUFJLENBQUNnQyxLQUFMLENBQVdoQixXQUFsQyxFQUErQztBQUNsRCxhQUFPbkMsR0FBRyxDQUFDNkMsR0FBSixDQUNIO0FBQ0lGLFFBQUFBLEtBQUssRUFBRTtBQUNITSxVQUFBQSxlQUFlLEVBQUUsT0FEZDtBQUVINUIsVUFBQUEsTUFBTSxFQUFFRixJQUFJLENBQUNnQyxLQUFMLENBQVc1QixZQUFYLEdBQTBCSixJQUFJLENBQUNnQyxLQUFMLENBQVc3QixhQUFYLEdBQTJCLENBQXJELEdBQXlESCxJQUFJLENBQUNnQyxLQUFMLENBQVc5QixNQUFYLEdBQW9CLENBRmxGO0FBR0grQixVQUFBQSxRQUFRLEVBQUUsTUFIUDtBQUlIdUIsVUFBQUEsU0FBUyxFQUFFO0FBSlI7QUFEWCxPQURHLEVBU0h4RCxJQUFJLENBQUN1QyxlQUFMLEVBVEcsQ0FBUDtBQVdILEtBWk0sTUFZQTtBQUNILGFBQU92QyxJQUFJLENBQUNxQixrQkFBTCxFQUFQO0FBQ0g7QUFDSjs7QUExSjhCLENBQWxCLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgUmVhY3QgPSByZXF1aXJlKCdyZWFjdCcpO1xyXG5jb25zdCBjZSA9IFJlYWN0LmNyZWF0ZUVsZW1lbnQ7XHJcbmNvbnN0IERPTSA9IFJlYWN0LkRPTTtcclxuY29uc3QgUmVhY3RET00gPSByZXF1aXJlKCdyZWFjdC1kb20nKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuXHJcbmNvbnN0IHN0eWxlcyA9IHJlcXVpcmUoJy4vc3R5bGVzJyk7XHJcbmNvbnN0IFByaW50ZXJTdGF0ZUVudW0gPSByZXF1aXJlKCcuLi8uLi9jb25zdGFudHMnKS5QcmludGVyU3RhdGVFbnVtO1xyXG5jb25zdCBCb3RUeXBlRW51bSA9IHJlcXVpcmUoJy4uLy4uL2NvbnN0YW50cycpLkJvdFR5cGVFbnVtO1xyXG5cclxuLy8gd2lkdGg6aGVpZ2h0IG9mIHVucm90YXRlZCBjYW1lcmEgZnJhbWVcclxuY29uc3QgQVNQRUNUX1JBVElPID0gNCAvIDM7XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IFJlYWN0LmNyZWF0ZUNsYXNzKHtcclxuICAgIGRpc3BsYXlOYW1lOiAnQ2FtZXJhRmVlZCcsXHJcblxyXG4gICAgcHJvcFR5cGVzOiB7XHJcbiAgICAgICAgcHJpbnRlcjogUmVhY3QuUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxyXG4gICAgICAgIHByb3BzOiBSZWFjdC5Qcm9wVHlwZXMub2JqZWN0LFxyXG4gICAgfSxcclxuXHJcbiAgICBjYW1lcmFGcmFtZUNhbGxiYWNrKCkge30sXHJcblxyXG4gICAgZ2V0SW5pdGlhbFN0YXRlKCkge1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHdpZHRoOiAzNjAsXHJcbiAgICAgICAgICAgIGdldCBoZWlnaHQoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gKHRoaXMud2lkdGggKiAxKSAvIEFTUEVDVF9SQVRJTztcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0IHJvdGF0ZWRIZWlnaHQoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy53aWR0aCAqIEFTUEVDVF9SQVRJTztcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0IHNob3VsZFJvdGF0ZSgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLnByb3BzLnByaW50ZXIuZ2V0R2VuZGVyKCkuYm90VHlwZSA9PT0gQm90VHlwZUVudW0uejE4XzY7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfTtcclxuICAgIH0sXHJcblxyXG4gICAgY29tcG9uZW50RGlkTW91bnQoKSB7XHJcbiAgICAgICAgY29uc3Qgd2lkdGggPSBSZWFjdERPTS5maW5kRE9NTm9kZSh0aGlzKS5vZmZzZXRXaWR0aDtcclxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgd2lkdGggfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgICAgIGlmIChuZXh0UHJvcHMucHJpbnRlciAhPT0gc2VsZi5wcm9wcy5wcmludGVyIHx8ICFuZXh0UHJvcHMucHJpbnRlci5jYW1lcmFGZWVkQWN0aXZlKSB7XHJcbiAgICAgICAgICAgIHNlbGYuY2FtZXJhRnJhbWVDYWxsYmFjayA9IGZ1bmN0aW9uKGNhbWVyYUltYWdlRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5zZXRTdGF0ZSh7IGNhbWVyYUltYWdlOiBjYW1lcmFJbWFnZURhdGEgfSk7XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBpZiAobmV4dFByb3BzLnByaW50ZXIuaXNBdXRoZW50aWNhdGVkKCkpIHtcclxuICAgICAgICAgICAgICAgIG5leHRQcm9wcy5wcmludGVyLmdldENhbWVyYUZlZWQoZnVuY3Rpb24oY2FtZXJhSW1hZ2VEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5jYW1lcmFGcmFtZUNhbGxiYWNrKGNhbWVyYUltYWdlRGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgLy8gbWFrZSB0aGlzIGRvIG5vdGhpbmcgc28gdGhhdCBmcmFtZXMgd2UgcmVjZWl2ZSBiZXR3ZWVuIGludm9raW5nXHJcbiAgICAgICAgLy8gZW5kIGNhbWVyYSBzdHJlYW0gYW5kIHRoZSBib3QgYWN0dWFsbHkgc3RvcHBpbmcgc2VuZGluZyBmcmFtZXMgZG9lc1xyXG4gICAgICAgIC8vIG5vdCB0cmlnZ2VyIHNldFN0YXRlXHJcbiAgICAgICAgc2VsZi5jYW1lcmFGcmFtZUNhbGxiYWNrID0gZnVuY3Rpb24oKSB7fTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMucHJvcHMucHJpbnRlci5pc0F1dGhlbnRpY2F0ZWQoKSkge1xyXG4gICAgICAgICAgICB0aGlzLnByb3BzLnByaW50ZXIuZW5kQ2FtZXJhRmVlZCgpO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgX2dldExvYWRpbmdTcGlubmVyKCkge1xyXG4gICAgICAgIC8vIG1hZ2ljIG51bWJlcnM7IHNob3VsZCBiZSB0aGUgc2FtZSBhcyB0aGUgYnVzeSBwcmludGVyIGJhZGdlLi4uXHJcbiAgICAgICAgY29uc3QgcmFkaXVzID0gNTA7XHJcbiAgICAgICAgY29uc3QgZHJhd1JhZGl1cyA9IDQxO1xyXG4gICAgICAgIGNvbnN0IHN0eWxlID0gc3R5bGVzLmRhc2hlZENpcmNsZShkcmF3UmFkaXVzLCA0KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIERPTS5kaXYoXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHN0eWxlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogJ2ZsZXgnLFxyXG4gICAgICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICdjZW50ZXInLFxyXG4gICAgICAgICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAnY2VudGVyJyxcclxuICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IHN0eWxlcy5vZmZXaGl0ZSgpLFxyXG4gICAgICAgICAgICAgICAgICAgIHdpZHRoOiB0aGlzLnN0YXRlLndpZHRoLFxyXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5zdGF0ZS5zaG91bGRSb3RhdGUgPyB0aGlzLnN0YXRlLnJvdGF0ZWRIZWlnaHQgOiB0aGlzLnN0YXRlLmhlaWdodCxcclxuICAgICAgICAgICAgICAgICAgICBvdmVyZmxvdzogJ2hpZGRlbicsXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBjZShcclxuICAgICAgICAgICAgICAgICdzdmcnLFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAyICogcmFkaXVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDIgKiByYWRpdXMsXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBjZSgnY2lyY2xlJywge1xyXG4gICAgICAgICAgICAgICAgICAgIGN4OiByYWRpdXMsXHJcbiAgICAgICAgICAgICAgICAgICAgY3k6IHJhZGl1cyxcclxuICAgICAgICAgICAgICAgICAgICByOiBkcmF3UmFkaXVzLFxyXG4gICAgICAgICAgICAgICAgICAgIHN0cm9rZVdpZHRoOiAnNnB4JyxcclxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICdtYWtlcmJvdC1ncmV5LXN0cm9rZScsXHJcbiAgICAgICAgICAgICAgICAgICAgc3R5bGUsXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgIH0sXHJcblxyXG4gICAgX2dldENhbWVyYUltYWdlKCkge1xyXG4gICAgICAgIGNvbnN0IHN0eWxlID0ge1xyXG4gICAgICAgICAgICB3aWR0aDogJzEwMCUnLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgaWYgKHRoaXMucHJvcHMucHJpbnRlci5nZXRHZW5kZXIoKS5ib3RUeXBlID09PSBCb3RUeXBlRW51bS5za2V0Y2gpIHtcclxuICAgICAgICAgICAgc3R5bGUuaGVpZ2h0ID0gJzEwMCUnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5zdGF0ZS5zaG91bGRSb3RhdGUpIHtcclxuICAgICAgICAgICAgc3R5bGUudHJhbnNmb3JtID1cclxuICAgICAgICAgICAgICAgIGAkeydyb3RhdGUoLTkwZGVnKSAnICsgJ3RyYW5zbGF0ZSgnfSR7MC41ICogKHRoaXMuc3RhdGUuaGVpZ2h0IC0gdGhpcy5zdGF0ZS5yb3RhdGVkSGVpZ2h0KX1weCkgYCArXHJcbiAgICAgICAgICAgICAgICBgc2NhbGUoJHtBU1BFQ1RfUkFUSU99KWA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gRE9NLmltZyh7XHJcbiAgICAgICAgICAgIHNyYzogdGhpcy5zdGF0ZS5jYW1lcmFJbWFnZSxcclxuICAgICAgICAgICAgc3R5bGUsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIF9nZXRBdXRoSW1hZ2UoKSB7XHJcbiAgICAgICAgY29uc3QgYm90VHlwZSA9IHRoaXMucHJvcHMucHJpbnRlci5nZXRHZW5kZXIoKS5ib3RUeXBlO1xyXG4gICAgICAgIGxldCBpbWFnZVNyYyA9ICdpbWFnZXMvYXV0aG9yaXplX3JlcDUucG5nJztcclxuICAgICAgICBpZiAoYm90VHlwZSA9PT0gQm90VHlwZUVudW0ubWluaV84KSB7XHJcbiAgICAgICAgICAgIGltYWdlU3JjID0gJ2ltYWdlcy9hdXRob3JpemVfbWluaS5wbmcnO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5wcm9wcy5wcmludGVyLmlzU2l4dGhHZW4oKSkge1xyXG4gICAgICAgICAgICBpbWFnZVNyYyA9ICdpbWFnZXMvYXV0aG9yaXplX2ZpcmVfZS5wbmcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpbWFnZVNyYyA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIGltYWdlU3JjKTtcclxuICAgICAgICBjb25zdCBwcm9wcyA9IHsgaWQ6ICdwcmludGVySW1nJywgc3JjOiBpbWFnZVNyYyB9O1xyXG5cclxuICAgICAgICByZXR1cm4gPGltZyB7Li4ucHJvcHN9IC8+O1xyXG4gICAgfSxcclxuXHJcbiAgICByZW5kZXIoKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRQcmludGVyID0gdGhpcy5wcm9wcy5wcmludGVyO1xyXG5cclxuICAgICAgICBsZXQgcHJpbnRlclN0YXRlO1xyXG4gICAgICAgIGlmIChzZWxlY3RlZFByaW50ZXIpIHByaW50ZXJTdGF0ZSA9IHNlbGVjdGVkUHJpbnRlci5nZXRTdGF0dXMoKS5zdGF0ZTtcclxuXHJcbiAgICAgICAgaWYgKHByaW50ZXJTdGF0ZSA9PT0gUHJpbnRlclN0YXRlRW51bS5BdXRoZW50aWNhdGluZykge1xyXG4gICAgICAgICAgICByZXR1cm4gc2VsZi5fZ2V0QXV0aEltYWdlKCk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChzZWxlY3RlZFByaW50ZXIgJiYgc2VsZi5zdGF0ZS5jYW1lcmFJbWFnZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gRE9NLmRpdihcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBzdHlsZToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICd3aGl0ZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogc2VsZi5zdGF0ZS5zaG91bGRSb3RhdGUgPyBzZWxmLnN0YXRlLnJvdGF0ZWRIZWlnaHQgKyAzIDogc2VsZi5zdGF0ZS5oZWlnaHQgKyAzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVyZmxvdzogJ2F1dG8nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkcmFnZ2FibGU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgc2VsZi5fZ2V0Q2FtZXJhSW1hZ2UoKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBzZWxmLl9nZXRMb2FkaW5nU3Bpbm5lcigpO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbn0pO1xyXG4iXX0=
