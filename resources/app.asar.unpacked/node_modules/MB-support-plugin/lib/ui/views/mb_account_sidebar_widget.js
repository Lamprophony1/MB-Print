'use strict';

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const React = require('react');

const Isvg = require('react-inlinesvg');

const _ = require('lodash');

const path = require('path');

const listensToClickOutside = require('react-onclickoutside/decorator');

const PluginComponent = require('eagle-print').views.PluginComponent;

const pluginName = require('../../../index').pluginName;

class MBAccountSidebarWidget extends PluginComponent {
  constructor(...args) {
    super(...args);

    _defineProperty(this, "state", {
      showUserPanel: false
    });

    _defineProperty(this, "getPluginNames", () => {
      return [pluginName];
    });

    _defineProperty(this, "getStateFromFlux", () => {
      const plugin = this.getFlux().getPlugin(pluginName);
      const userInfo = plugin.getUserInfo();
      let showUserPanel = this.state ? this.state.showUserPanel : undefined;

      if (!userInfo) {
        showUserPanel = false;
      }

      return {
        userInfo,
        showUserPanel
      };
    });

    _defineProperty(this, "componentDidMount", () => {
      super.componentDidMount();
      const plugin = this.getFlux().getPlugin(pluginName);
      const userInfo = plugin.getUserInfo();
      this.state.userInfo = userInfo;
    });

    _defineProperty(this, "handleClickOutside", event => {
      if (this.state.showUserPanel) {
        this.setState({
          showUserPanel: false
        });
      }
    });

    _defineProperty(this, "handleIconClick", () => {
      if (this.state.userInfo) {
        // TODO Add code for displaying slide out panel
        this.setState({
          showUserPanel: !this.state.showUserPanel
        });
      } else {
        this._renderLoginModal();
      }
    });

    _defineProperty(this, "handleLogOut", () => {
      const flux = this.getFlux();
      const plugin = flux.getPlugin(pluginName);
      plugin.remove_auth_info();
      if (plugin.shouldPromptForLogin()) this._renderLoginModal(true);
    });

    _defineProperty(this, "_renderUserInfoPopup", () => {
      const i18n = this.getFlux().getService('TranslationService');
      const plugin = this.getFlux().getPlugin(pluginName);
      const userInfo = plugin.getUserInfo();
      const userName = userInfo.full_name.trim().length > 0 ? userInfo.full_name : userInfo.name;
      return /*#__PURE__*/React.createElement("div", {
        ref: "popout",
        className: "accountPanel"
      }, /*#__PURE__*/React.createElement("div", this.props, /*#__PURE__*/React.createElement("div", {
        className: "closeButton closePanel",
        onClick: this.handleIconClick
      }, /*#__PURE__*/React.createElement(Isvg, {
        src: "icons/x-button.svg"
      })), /*#__PURE__*/React.createElement("div", {
        className: "userContainer"
      }, /*#__PURE__*/React.createElement("img", {
        src: this.state.userInfo.userAvatar,
        className: "avatar"
      }), /*#__PURE__*/React.createElement("span", {
        className: "userInfo"
      }, /*#__PURE__*/React.createElement("span", {
        className: "header"
      }, i18n.t('mb:accountSignIn.loggedInAs')), /*#__PURE__*/React.createElement("div", {
        className: "userName"
      }, userName))), /*#__PURE__*/React.createElement("div", {
        className: "buttonGroup"
      }, /*#__PURE__*/React.createElement("button", {
        ref: "logoutButton",
        className: "button secondary",
        onClick: this.handleLogOut
      }, i18n.t('mb:accountSignIn.logout')))));
    });

    _defineProperty(this, "_renderLoginModal", isMandatory => {
      const flux = this.getFlux();
      const mbPlugin = flux.getPlugin(pluginName);
      mbPlugin.showLoginPopup(this.getFlux(), isMandatory);
    });

    _defineProperty(this, "render", () => {
      const plugin = this.getFlux().getPlugin(pluginName);
      const logger = this.getFlux().getService('LoggingService');
      plugin.initializeUserInfoForPendo().then(result => {
        if (result) {
          pendo.loadGuides(); // Attempting to reload guides

          logger.info(`PENDO::Pendo configured with Visitor ID: ${pendo.getVisitorId()}`);
        }
      });
      const isLoginDisabled = this.getFlux().getService('ConfigService').get('disableLogin', false);

      if (!isLoginDisabled) {
        const avatarSrc = this.state.userInfo ? path.resolve(__dirname, this.state.userInfo.userAvatar) : path.resolve(__dirname, 'images/nav-login-icon.svg');
        return /*#__PURE__*/React.createElement("div", _.assign({}, this.props, {
          className: `${this.props.className || ''} item account`,
          key: 'UserPanel'
        }), /*#__PURE__*/React.createElement("img", {
          src: avatarSrc,
          ref: "accountWidget",
          className: "loginButton",
          onClick: this.handleIconClick
        }), this.state.showUserPanel && this.state.userInfo ? this._renderUserInfoPopup() : null);
      }

      return null;
    });
  }

}

MBAccountSidebarWidget.displayName = 'MBAccountSidebarWidget';
module.exports = listensToClickOutside(MBAccountSidebarWidget);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1iX2FjY291bnRfc2lkZWJhcl93aWRnZXQuanMiXSwibmFtZXMiOlsiUmVhY3QiLCJyZXF1aXJlIiwiSXN2ZyIsIl8iLCJwYXRoIiwibGlzdGVuc1RvQ2xpY2tPdXRzaWRlIiwiUGx1Z2luQ29tcG9uZW50Iiwidmlld3MiLCJwbHVnaW5OYW1lIiwiTUJBY2NvdW50U2lkZWJhcldpZGdldCIsInNob3dVc2VyUGFuZWwiLCJwbHVnaW4iLCJnZXRGbHV4IiwiZ2V0UGx1Z2luIiwidXNlckluZm8iLCJnZXRVc2VySW5mbyIsInN0YXRlIiwidW5kZWZpbmVkIiwiY29tcG9uZW50RGlkTW91bnQiLCJldmVudCIsInNldFN0YXRlIiwiX3JlbmRlckxvZ2luTW9kYWwiLCJmbHV4IiwicmVtb3ZlX2F1dGhfaW5mbyIsInNob3VsZFByb21wdEZvckxvZ2luIiwiaTE4biIsImdldFNlcnZpY2UiLCJ1c2VyTmFtZSIsImZ1bGxfbmFtZSIsInRyaW0iLCJsZW5ndGgiLCJuYW1lIiwicHJvcHMiLCJoYW5kbGVJY29uQ2xpY2siLCJ1c2VyQXZhdGFyIiwidCIsImhhbmRsZUxvZ091dCIsImlzTWFuZGF0b3J5IiwibWJQbHVnaW4iLCJzaG93TG9naW5Qb3B1cCIsImxvZ2dlciIsImluaXRpYWxpemVVc2VySW5mb0ZvclBlbmRvIiwidGhlbiIsInJlc3VsdCIsInBlbmRvIiwibG9hZEd1aWRlcyIsImluZm8iLCJnZXRWaXNpdG9ySWQiLCJpc0xvZ2luRGlzYWJsZWQiLCJnZXQiLCJhdmF0YXJTcmMiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiYXNzaWduIiwiY2xhc3NOYW1lIiwia2V5IiwiX3JlbmRlclVzZXJJbmZvUG9wdXAiLCJkaXNwbGF5TmFtZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsS0FBSyxHQUFHQyxPQUFPLENBQUMsT0FBRCxDQUFyQjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxpQkFBRCxDQUFwQjs7QUFDQSxNQUFNRSxDQUFDLEdBQUdGLE9BQU8sQ0FBQyxRQUFELENBQWpCOztBQUNBLE1BQU1HLElBQUksR0FBR0gsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUkscUJBQXFCLEdBQUdKLE9BQU8sQ0FBQyxnQ0FBRCxDQUFyQzs7QUFDQSxNQUFNSyxlQUFlLEdBQUdMLE9BQU8sQ0FBQyxhQUFELENBQVAsQ0FBdUJNLEtBQXZCLENBQTZCRCxlQUFyRDs7QUFFQSxNQUFNRSxVQUFVLEdBQUdQLE9BQU8sQ0FBQyxnQkFBRCxDQUFQLENBQTBCTyxVQUE3Qzs7QUFFQSxNQUFNQyxzQkFBTixTQUFxQ0gsZUFBckMsQ0FBcUQ7QUFBQTtBQUFBOztBQUFBLG1DQUN6QztBQUNKSSxNQUFBQSxhQUFhLEVBQUU7QUFEWCxLQUR5Qzs7QUFBQSw0Q0FLaEMsTUFBTTtBQUNuQixhQUFPLENBQUNGLFVBQUQsQ0FBUDtBQUNILEtBUGdEOztBQUFBLDhDQVM5QixNQUFNO0FBQ3JCLFlBQU1HLE1BQU0sR0FBRyxLQUFLQyxPQUFMLEdBQWVDLFNBQWYsQ0FBeUJMLFVBQXpCLENBQWY7QUFDQSxZQUFNTSxRQUFRLEdBQUdILE1BQU0sQ0FBQ0ksV0FBUCxFQUFqQjtBQUNBLFVBQUlMLGFBQWEsR0FBRyxLQUFLTSxLQUFMLEdBQWEsS0FBS0EsS0FBTCxDQUFXTixhQUF4QixHQUF3Q08sU0FBNUQ7O0FBQ0EsVUFBSSxDQUFDSCxRQUFMLEVBQWU7QUFDWEosUUFBQUEsYUFBYSxHQUFHLEtBQWhCO0FBQ0g7O0FBQ0QsYUFBTztBQUFFSSxRQUFBQSxRQUFGO0FBQVlKLFFBQUFBO0FBQVosT0FBUDtBQUNILEtBakJnRDs7QUFBQSwrQ0FtQjdCLE1BQU07QUFDdEIsWUFBTVEsaUJBQU47QUFDQSxZQUFNUCxNQUFNLEdBQUcsS0FBS0MsT0FBTCxHQUFlQyxTQUFmLENBQXlCTCxVQUF6QixDQUFmO0FBQ0EsWUFBTU0sUUFBUSxHQUFHSCxNQUFNLENBQUNJLFdBQVAsRUFBakI7QUFDQSxXQUFLQyxLQUFMLENBQVdGLFFBQVgsR0FBc0JBLFFBQXRCO0FBQ0gsS0F4QmdEOztBQUFBLGdEQTJCNUJLLEtBQUssSUFBSTtBQUMxQixVQUFJLEtBQUtILEtBQUwsQ0FBV04sYUFBZixFQUE4QjtBQUMxQixhQUFLVSxRQUFMLENBQWM7QUFBRVYsVUFBQUEsYUFBYSxFQUFFO0FBQWpCLFNBQWQ7QUFDSDtBQUNKLEtBL0JnRDs7QUFBQSw2Q0FpQy9CLE1BQU07QUFDcEIsVUFBSSxLQUFLTSxLQUFMLENBQVdGLFFBQWYsRUFBeUI7QUFDckI7QUFDQSxhQUFLTSxRQUFMLENBQWM7QUFBRVYsVUFBQUEsYUFBYSxFQUFFLENBQUMsS0FBS00sS0FBTCxDQUFXTjtBQUE3QixTQUFkO0FBQ0gsT0FIRCxNQUdPO0FBQ0gsYUFBS1csaUJBQUw7QUFDSDtBQUNKLEtBeENnRDs7QUFBQSwwQ0EwQ2xDLE1BQU07QUFDakIsWUFBTUMsSUFBSSxHQUFHLEtBQUtWLE9BQUwsRUFBYjtBQUNBLFlBQU1ELE1BQU0sR0FBR1csSUFBSSxDQUFDVCxTQUFMLENBQWVMLFVBQWYsQ0FBZjtBQUNBRyxNQUFBQSxNQUFNLENBQUNZLGdCQUFQO0FBRUEsVUFBSVosTUFBTSxDQUFDYSxvQkFBUCxFQUFKLEVBQW1DLEtBQUtILGlCQUFMLENBQXVCLElBQXZCO0FBQ3RDLEtBaERnRDs7QUFBQSxrREFrRDFCLE1BQU07QUFDekIsWUFBTUksSUFBSSxHQUFHLEtBQUtiLE9BQUwsR0FBZWMsVUFBZixDQUEwQixvQkFBMUIsQ0FBYjtBQUNBLFlBQU1mLE1BQU0sR0FBRyxLQUFLQyxPQUFMLEdBQWVDLFNBQWYsQ0FBeUJMLFVBQXpCLENBQWY7QUFDQSxZQUFNTSxRQUFRLEdBQUdILE1BQU0sQ0FBQ0ksV0FBUCxFQUFqQjtBQUNBLFlBQU1ZLFFBQVEsR0FBR2IsUUFBUSxDQUFDYyxTQUFULENBQW1CQyxJQUFuQixHQUEwQkMsTUFBMUIsR0FBbUMsQ0FBbkMsR0FBdUNoQixRQUFRLENBQUNjLFNBQWhELEdBQTREZCxRQUFRLENBQUNpQixJQUF0RjtBQUVBLDBCQUNJO0FBQUssUUFBQSxHQUFHLEVBQUMsUUFBVDtBQUFrQixRQUFBLFNBQVMsRUFBQztBQUE1QixzQkFDSSwyQkFBUyxLQUFLQyxLQUFkLGVBQ0k7QUFBSyxRQUFBLFNBQVMsRUFBQyx3QkFBZjtBQUF3QyxRQUFBLE9BQU8sRUFBRSxLQUFLQztBQUF0RCxzQkFDSSxvQkFBQyxJQUFEO0FBQU0sUUFBQSxHQUFHLEVBQUM7QUFBVixRQURKLENBREosZUFJSTtBQUFLLFFBQUEsU0FBUyxFQUFDO0FBQWYsc0JBQ0k7QUFBSyxRQUFBLEdBQUcsRUFBRSxLQUFLakIsS0FBTCxDQUFXRixRQUFYLENBQW9Cb0IsVUFBOUI7QUFBMEMsUUFBQSxTQUFTLEVBQUM7QUFBcEQsUUFESixlQUVJO0FBQU0sUUFBQSxTQUFTLEVBQUM7QUFBaEIsc0JBQ0k7QUFBTSxRQUFBLFNBQVMsRUFBQztBQUFoQixTQUEwQlQsSUFBSSxDQUFDVSxDQUFMLENBQU8sNkJBQVAsQ0FBMUIsQ0FESixlQUVJO0FBQUssUUFBQSxTQUFTLEVBQUM7QUFBZixTQUEyQlIsUUFBM0IsQ0FGSixDQUZKLENBSkosZUFXSTtBQUFLLFFBQUEsU0FBUyxFQUFDO0FBQWYsc0JBQ0k7QUFBUSxRQUFBLEdBQUcsRUFBQyxjQUFaO0FBQTJCLFFBQUEsU0FBUyxFQUFDLGtCQUFyQztBQUF3RCxRQUFBLE9BQU8sRUFBRSxLQUFLUztBQUF0RSxTQUNLWCxJQUFJLENBQUNVLENBQUwsQ0FBTyx5QkFBUCxDQURMLENBREosQ0FYSixDQURKLENBREo7QUFxQkgsS0E3RWdEOztBQUFBLCtDQStFN0JFLFdBQVcsSUFBSTtBQUMvQixZQUFNZixJQUFJLEdBQUcsS0FBS1YsT0FBTCxFQUFiO0FBQ0EsWUFBTTBCLFFBQVEsR0FBR2hCLElBQUksQ0FBQ1QsU0FBTCxDQUFlTCxVQUFmLENBQWpCO0FBQ0E4QixNQUFBQSxRQUFRLENBQUNDLGNBQVQsQ0FBd0IsS0FBSzNCLE9BQUwsRUFBeEIsRUFBd0N5QixXQUF4QztBQUNILEtBbkZnRDs7QUFBQSxvQ0FxRnhDLE1BQU07QUFDWCxZQUFNMUIsTUFBTSxHQUFHLEtBQUtDLE9BQUwsR0FBZUMsU0FBZixDQUF5QkwsVUFBekIsQ0FBZjtBQUNBLFlBQU1nQyxNQUFNLEdBQUcsS0FBSzVCLE9BQUwsR0FBZWMsVUFBZixDQUEwQixnQkFBMUIsQ0FBZjtBQUNBZixNQUFBQSxNQUFNLENBQUM4QiwwQkFBUCxHQUFvQ0MsSUFBcEMsQ0FBeUNDLE1BQU0sSUFBSTtBQUMvQyxZQUFJQSxNQUFKLEVBQVk7QUFDUkMsVUFBQUEsS0FBSyxDQUFDQyxVQUFOLEdBRFEsQ0FDWTs7QUFDcEJMLFVBQUFBLE1BQU0sQ0FBQ00sSUFBUCxDQUFhLDRDQUEyQ0YsS0FBSyxDQUFDRyxZQUFOLEVBQXFCLEVBQTdFO0FBQ0g7QUFDSixPQUxEO0FBTUEsWUFBTUMsZUFBZSxHQUFHLEtBQUtwQyxPQUFMLEdBQ25CYyxVQURtQixDQUNSLGVBRFEsRUFFbkJ1QixHQUZtQixDQUVmLGNBRmUsRUFFQyxLQUZELENBQXhCOztBQUlBLFVBQUksQ0FBQ0QsZUFBTCxFQUFzQjtBQUNsQixjQUFNRSxTQUFTLEdBQUcsS0FBS2xDLEtBQUwsQ0FBV0YsUUFBWCxHQUNaVixJQUFJLENBQUMrQyxPQUFMLENBQWFDLFNBQWIsRUFBd0IsS0FBS3BDLEtBQUwsQ0FBV0YsUUFBWCxDQUFvQm9CLFVBQTVDLENBRFksR0FFWjlCLElBQUksQ0FBQytDLE9BQUwsQ0FBYUMsU0FBYixFQUF3QiwyQkFBeEIsQ0FGTjtBQUdBLDRCQUNJLDJCQUNRakQsQ0FBQyxDQUFDa0QsTUFBRixDQUFTLEVBQVQsRUFBYSxLQUFLckIsS0FBbEIsRUFBeUI7QUFDekJzQixVQUFBQSxTQUFTLEVBQUcsR0FBRSxLQUFLdEIsS0FBTCxDQUFXc0IsU0FBWCxJQUF3QixFQUFHLGVBRGhCO0FBRXpCQyxVQUFBQSxHQUFHLEVBQUU7QUFGb0IsU0FBekIsQ0FEUixlQU1JO0FBQUssVUFBQSxHQUFHLEVBQUVMLFNBQVY7QUFBcUIsVUFBQSxHQUFHLEVBQUMsZUFBekI7QUFBeUMsVUFBQSxTQUFTLEVBQUMsYUFBbkQ7QUFBaUUsVUFBQSxPQUFPLEVBQUUsS0FBS2pCO0FBQS9FLFVBTkosRUFPSyxLQUFLakIsS0FBTCxDQUFXTixhQUFYLElBQTRCLEtBQUtNLEtBQUwsQ0FBV0YsUUFBdkMsR0FBa0QsS0FBSzBDLG9CQUFMLEVBQWxELEdBQWdGLElBUHJGLENBREo7QUFXSDs7QUFDRCxhQUFPLElBQVA7QUFDSCxLQW5IZ0Q7QUFBQTs7QUFBQTs7QUFzSHJEL0Msc0JBQXNCLENBQUNnRCxXQUF2QixHQUFxQyx3QkFBckM7QUFFQUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdEQscUJBQXFCLENBQUNJLHNCQUFELENBQXRDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgUmVhY3QgPSByZXF1aXJlKCdyZWFjdCcpO1xyXG5jb25zdCBJc3ZnID0gcmVxdWlyZSgncmVhY3QtaW5saW5lc3ZnJyk7XHJcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgbGlzdGVuc1RvQ2xpY2tPdXRzaWRlID0gcmVxdWlyZSgncmVhY3Qtb25jbGlja291dHNpZGUvZGVjb3JhdG9yJyk7XHJcbmNvbnN0IFBsdWdpbkNvbXBvbmVudCA9IHJlcXVpcmUoJ2VhZ2xlLXByaW50Jykudmlld3MuUGx1Z2luQ29tcG9uZW50O1xyXG5cclxuY29uc3QgcGx1Z2luTmFtZSA9IHJlcXVpcmUoJy4uLy4uLy4uL2luZGV4JykucGx1Z2luTmFtZTtcclxuXHJcbmNsYXNzIE1CQWNjb3VudFNpZGViYXJXaWRnZXQgZXh0ZW5kcyBQbHVnaW5Db21wb25lbnQge1xyXG4gICAgc3RhdGUgPSB7XHJcbiAgICAgICAgc2hvd1VzZXJQYW5lbDogZmFsc2UsXHJcbiAgICB9O1xyXG5cclxuICAgIGdldFBsdWdpbk5hbWVzID0gKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiBbcGx1Z2luTmFtZV07XHJcbiAgICB9O1xyXG5cclxuICAgIGdldFN0YXRlRnJvbUZsdXggPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcGx1Z2luID0gdGhpcy5nZXRGbHV4KCkuZ2V0UGx1Z2luKHBsdWdpbk5hbWUpO1xyXG4gICAgICAgIGNvbnN0IHVzZXJJbmZvID0gcGx1Z2luLmdldFVzZXJJbmZvKCk7XHJcbiAgICAgICAgbGV0IHNob3dVc2VyUGFuZWwgPSB0aGlzLnN0YXRlID8gdGhpcy5zdGF0ZS5zaG93VXNlclBhbmVsIDogdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmICghdXNlckluZm8pIHtcclxuICAgICAgICAgICAgc2hvd1VzZXJQYW5lbCA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4geyB1c2VySW5mbywgc2hvd1VzZXJQYW5lbCB9O1xyXG4gICAgfTtcclxuXHJcbiAgICBjb21wb25lbnREaWRNb3VudCA9ICgpID0+IHtcclxuICAgICAgICBzdXBlci5jb21wb25lbnREaWRNb3VudCgpO1xyXG4gICAgICAgIGNvbnN0IHBsdWdpbiA9IHRoaXMuZ2V0Rmx1eCgpLmdldFBsdWdpbihwbHVnaW5OYW1lKTtcclxuICAgICAgICBjb25zdCB1c2VySW5mbyA9IHBsdWdpbi5nZXRVc2VySW5mbygpO1xyXG4gICAgICAgIHRoaXMuc3RhdGUudXNlckluZm8gPSB1c2VySW5mbztcclxuICAgIH07XHJcblxyXG4gICAgLy8gbWV0aG9kIGdldHMgY2FsbGVkIGJ5IGxpc3RlbnNUb0NsaWNrT3V0c2lkZSB3cmFwcGVyXHJcbiAgICBoYW5kbGVDbGlja091dHNpZGUgPSBldmVudCA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuc2hvd1VzZXJQYW5lbCkge1xyXG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgc2hvd1VzZXJQYW5lbDogZmFsc2UgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBoYW5kbGVJY29uQ2xpY2sgPSAoKSA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudXNlckluZm8pIHtcclxuICAgICAgICAgICAgLy8gVE9ETyBBZGQgY29kZSBmb3IgZGlzcGxheWluZyBzbGlkZSBvdXQgcGFuZWxcclxuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHNob3dVc2VyUGFuZWw6ICF0aGlzLnN0YXRlLnNob3dVc2VyUGFuZWwgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5fcmVuZGVyTG9naW5Nb2RhbCgpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgaGFuZGxlTG9nT3V0ID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZsdXggPSB0aGlzLmdldEZsdXgoKTtcclxuICAgICAgICBjb25zdCBwbHVnaW4gPSBmbHV4LmdldFBsdWdpbihwbHVnaW5OYW1lKTtcclxuICAgICAgICBwbHVnaW4ucmVtb3ZlX2F1dGhfaW5mbygpO1xyXG5cclxuICAgICAgICBpZiAocGx1Z2luLnNob3VsZFByb21wdEZvckxvZ2luKCkpIHRoaXMuX3JlbmRlckxvZ2luTW9kYWwodHJ1ZSk7XHJcbiAgICB9O1xyXG5cclxuICAgIF9yZW5kZXJVc2VySW5mb1BvcHVwID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGkxOG4gPSB0aGlzLmdldEZsdXgoKS5nZXRTZXJ2aWNlKCdUcmFuc2xhdGlvblNlcnZpY2UnKTtcclxuICAgICAgICBjb25zdCBwbHVnaW4gPSB0aGlzLmdldEZsdXgoKS5nZXRQbHVnaW4ocGx1Z2luTmFtZSk7XHJcbiAgICAgICAgY29uc3QgdXNlckluZm8gPSBwbHVnaW4uZ2V0VXNlckluZm8oKTtcclxuICAgICAgICBjb25zdCB1c2VyTmFtZSA9IHVzZXJJbmZvLmZ1bGxfbmFtZS50cmltKCkubGVuZ3RoID4gMCA/IHVzZXJJbmZvLmZ1bGxfbmFtZSA6IHVzZXJJbmZvLm5hbWU7XHJcblxyXG4gICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgIDxkaXYgcmVmPSdwb3BvdXQnIGNsYXNzTmFtZT0nYWNjb3VudFBhbmVsJz5cclxuICAgICAgICAgICAgICAgIDxkaXYgey4uLnRoaXMucHJvcHN9PlxyXG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdjbG9zZUJ1dHRvbiBjbG9zZVBhbmVsJyBvbkNsaWNrPXt0aGlzLmhhbmRsZUljb25DbGlja30+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDxJc3ZnIHNyYz0naWNvbnMveC1idXR0b24uc3ZnJyAvPlxyXG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSd1c2VyQ29udGFpbmVyJz5cclxuICAgICAgICAgICAgICAgICAgICAgICAgPGltZyBzcmM9e3RoaXMuc3RhdGUudXNlckluZm8udXNlckF2YXRhcn0gY2xhc3NOYW1lPSdhdmF0YXInIC8+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT0ndXNlckluZm8nPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPSdoZWFkZXInPntpMThuLnQoJ21iOmFjY291bnRTaWduSW4ubG9nZ2VkSW5BcycpfTwvc3Bhbj5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSd1c2VyTmFtZSc+e3VzZXJOYW1lfTwvZGl2PlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8L3NwYW4+XHJcbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J2J1dHRvbkdyb3VwJz5cclxuICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiByZWY9J2xvZ291dEJ1dHRvbicgY2xhc3NOYW1lPSdidXR0b24gc2Vjb25kYXJ5JyBvbkNsaWNrPXt0aGlzLmhhbmRsZUxvZ091dH0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7aTE4bi50KCdtYjphY2NvdW50U2lnbkluLmxvZ291dCcpfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj5cclxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICApO1xyXG4gICAgfTtcclxuXHJcbiAgICBfcmVuZGVyTG9naW5Nb2RhbCA9IGlzTWFuZGF0b3J5ID0+IHtcclxuICAgICAgICBjb25zdCBmbHV4ID0gdGhpcy5nZXRGbHV4KCk7XHJcbiAgICAgICAgY29uc3QgbWJQbHVnaW4gPSBmbHV4LmdldFBsdWdpbihwbHVnaW5OYW1lKTtcclxuICAgICAgICBtYlBsdWdpbi5zaG93TG9naW5Qb3B1cCh0aGlzLmdldEZsdXgoKSwgaXNNYW5kYXRvcnkpO1xyXG4gICAgfTtcclxuXHJcbiAgICByZW5kZXIgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcGx1Z2luID0gdGhpcy5nZXRGbHV4KCkuZ2V0UGx1Z2luKHBsdWdpbk5hbWUpO1xyXG4gICAgICAgIGNvbnN0IGxvZ2dlciA9IHRoaXMuZ2V0Rmx1eCgpLmdldFNlcnZpY2UoJ0xvZ2dpbmdTZXJ2aWNlJyk7XHJcbiAgICAgICAgcGx1Z2luLmluaXRpYWxpemVVc2VySW5mb0ZvclBlbmRvKCkudGhlbihyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICBwZW5kby5sb2FkR3VpZGVzKCk7IC8vIEF0dGVtcHRpbmcgdG8gcmVsb2FkIGd1aWRlc1xyXG4gICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oYFBFTkRPOjpQZW5kbyBjb25maWd1cmVkIHdpdGggVmlzaXRvciBJRDogJHtwZW5kby5nZXRWaXNpdG9ySWQoKX1gKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IGlzTG9naW5EaXNhYmxlZCA9IHRoaXMuZ2V0Rmx1eCgpXHJcbiAgICAgICAgICAgIC5nZXRTZXJ2aWNlKCdDb25maWdTZXJ2aWNlJylcclxuICAgICAgICAgICAgLmdldCgnZGlzYWJsZUxvZ2luJywgZmFsc2UpO1xyXG5cclxuICAgICAgICBpZiAoIWlzTG9naW5EaXNhYmxlZCkge1xyXG4gICAgICAgICAgICBjb25zdCBhdmF0YXJTcmMgPSB0aGlzLnN0YXRlLnVzZXJJbmZvXHJcbiAgICAgICAgICAgICAgICA/IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIHRoaXMuc3RhdGUudXNlckluZm8udXNlckF2YXRhcilcclxuICAgICAgICAgICAgICAgIDogcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ2ltYWdlcy9uYXYtbG9naW4taWNvbi5zdmcnKTtcclxuICAgICAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgICAgIDxkaXZcclxuICAgICAgICAgICAgICAgICAgICB7Li4uXy5hc3NpZ24oe30sIHRoaXMucHJvcHMsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOiBgJHt0aGlzLnByb3BzLmNsYXNzTmFtZSB8fCAnJ30gaXRlbSBhY2NvdW50YCxcclxuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiAnVXNlclBhbmVsJyxcclxuICAgICAgICAgICAgICAgICAgICB9KX1cclxuICAgICAgICAgICAgICAgID5cclxuICAgICAgICAgICAgICAgICAgICA8aW1nIHNyYz17YXZhdGFyU3JjfSByZWY9J2FjY291bnRXaWRnZXQnIGNsYXNzTmFtZT0nbG9naW5CdXR0b24nIG9uQ2xpY2s9e3RoaXMuaGFuZGxlSWNvbkNsaWNrfSAvPlxyXG4gICAgICAgICAgICAgICAgICAgIHt0aGlzLnN0YXRlLnNob3dVc2VyUGFuZWwgJiYgdGhpcy5zdGF0ZS51c2VySW5mbyA/IHRoaXMuX3JlbmRlclVzZXJJbmZvUG9wdXAoKSA6IG51bGx9XHJcbiAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9O1xyXG59XHJcblxyXG5NQkFjY291bnRTaWRlYmFyV2lkZ2V0LmRpc3BsYXlOYW1lID0gJ01CQWNjb3VudFNpZGViYXJXaWRnZXQnO1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBsaXN0ZW5zVG9DbGlja091dHNpZGUoTUJBY2NvdW50U2lkZWJhcldpZGdldCk7XHJcbiJdfQ==
