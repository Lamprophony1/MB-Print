'use strict';

const path = require('path');

const R = require('ramda');

const {
  DOM
} = require('react');

const constants = require('./constants');

const jpegSOI = 'ffd8'; // starting bytes indicating the data is a jpeg

const jpegEOI = 'ffd9'; // ending bytes

function checkJpeg(frameBuf) {
  // assume that if the start and end are good, the middle is okay too
  return (frameBuf.slice(0, 2).toString('hex') === jpegSOI && frameBuf.slice(frameBuf.length - 2, frameBuf.length).toString('hex')) === jpegEOI;
}

function getPathForIsvg(path) {
  // some stupid code to fix paths before passing them to react-inlinesvg--
  // react-inlinesvg is using a module called httpplease that will url-encode
  // incoming paths, which breaks with windows' backslash-separated paths...
  // Luckily, these paths will be handled correctly if we change the backslashes
  // to forward slashes though....
  const os_type = require('os').type();

  if (os_type === 'Windows_NT') return path.split('\\').join('/');
  return path;
}

function fullIconPath(uri) {
  return getPathForIsvg(path.resolve('node_modules/MB-support-plugin/', uri));
}

function botTypeToGender(botType) {
  return constants.PrinterGenderString.get(botType);
}

function genderToCodeName(gender) {
  return constants.PrinterCodeNames.get(gender);
}

function printerIDtoSerial(id) {
  return id.split(':')[2];
}

function connTypeToString(connType) {
  switch (connType) {
    case constants.PrinterConnTypeEnum.USB:
      return 'USB';

    case constants.PrinterConnTypeEnum.NETWORK:
      return 'Network';

    case constants.PrinterConnTypeEnum.REFLECTOR:
      return 'Reflector';

    case constants.PrinterConnTypeEnum.ARCHETYPE:
      return 'Archetype';
  }
}

function trackingInfoForPrinter(printer) {
  return {
    printer_id: printerIDtoSerial(printer.getId()),
    printer_type: genderToCodeName(printer.getGender().getName()),
    connection_type: printer.getConnectionType()
  };
}

function sendPrinterAnalytics(flux, event) {
  const trackingService = flux.getService('TrackingService');
  const printer = flux.store('PrinterStore').getSelectedPrinter();
  const trackingInfo = printer ? printer.getTrackingInfo() : null;
  const trackingData = R.merge({
    name: event
  }, trackingInfo);
  trackingService.addEvent(trackingData);
}
/**
 * A wrapper for `request` to allow progress reporting during
 * a large download.
 *
 * @example
 * progress(request("http://example.com/example"))
 *  .on('progress', prog => console.log(`Downloading: ${prog.percentage}%`))
 *  .catch(err => console.log('something went wrong:', err));
 *
 * @returns {Request} the same request object passed as a parameter, but with extra listeners attached
 */


function progress(request, options) {
  // prevent us from wrapping it twice
  if (request.progressContext) {
    return request;
  }

  if (request.response) {
    throw new Error("Request has already responded. Can't get progress");
  }

  const context = {};
  options = options || {};
  context.request = request;
  context.options = {};
  context.options.lengthHeader = options.lengthHeader || 'content-length'; // we've initiated a request

  const onRequest = context => {
    context.state = context.request.progressState;
  }; // server responeded in entirety


  const onResponse = (context, response) => {
    // zero out everything
    context.state = context.request.progressState = {
      cancel: context.request.abort.bind(context.request),
      percentage: 0,
      size: {
        total: Number(response.headers[context.options.lengthHeader]) || null,
        transferred: 0
      }
    };
  }; // data has come down, report the progress


  const onData = (context, data) => {
    context.state.size.transferred += data.length;
    reportState(context);
  }; // clean up everything


  const onEnd = context => {
    context.request.progressState = context.request.progressContext = null;
  }; // actually report the state of the download


  const reportState = context => {
    if (!context.request.progressState) {
      return;
    }

    const state = context.state;

    if (state.size.total != null) {
      state.percentage = Math.min(state.size.transferred, state.size.total) / state.size.total;
    }

    context.request.emit('progress', state);
  };

  request.on('request', () => onRequest(context)).on('response', res => onResponse(context, res)).on('data', data => onData(context, data)).on('end', () => onEnd(context));
  return request;
}

function getMaterialPrettyStringFromCode(materialName) {
  return constants.SliceConfigStringsToPrettyStrings[materialName];
}

function getMaterialSliceConfigStringFromCode(materialType) {
  return constants.MaterialCodesToSliceConfigStrings[materialType];
}

function filamentLengthToMass(length, linearDensity) {
  return length * linearDensity;
}

const getTracking = flux => flux.getService('TrackingService');

const getLogging = flux => flux.getService('LoggingService');

const getI18n = flux => flux.getService('TranslationService');

const getModal = flux => flux.getService('ModalService');

const getConfig = flux => flux.getService('ConfigService'); // Converts an unsave JS string (with ':' and '.') into a safe JS string for
// object keys.
// ex: safeKey('a.b:c') // returns 'a_b_c'
// safeKey :: String -> String


const safeKey = R.replace(/[:|.]/g, '_'); // Gets a value from an object whose keys have been converted to safe keys.
// You can use an unsafe key to search and it will be converted
// getSafeKeyProp :: String -> {k: v} -> a

const getSafeKeyProp = R.uncurryN(2, R.pipe(safeKey, R.prop)); // Sets a value in an object whose keys have been converted to safe keys.
// You can use an unsafe key to search and it will be converted
// setSafeKeyProp :: String -> a -> {k: v} -> {k: v}

const setSafeKeyProp = R.uncurryN(3, R.pipe(safeKey, R.assoc)); // removeSafeKeyProp :: String -> {k: v} -> {k: v}

const removeSafeKeyProp = R.uncurryN(2, R.pipe(safeKey, R.dissoc)); // appendSafeKey :: String -> [String] -> [String]

const appendSafeKey = R.uncurryN(2, R.pipe(safeKey, R.append)); // removeSafeKey :: String -> [String] -> [String]

const removeSafeKey = (elem, array) => R.without([safeKey(elem)], array); // split into paragraph tags on newlines
// pSplit :: String -> [React.Element]


const pSplit = R.pipe(R.split('\n'), R.map(R.partial(DOM.p, [{}])));

const rangeStep = (step, start, stop) => {
  return R.map(n => start + step * n, R.range(0, 1 + (stop - start) / step >>> 0));
}; // createRound :: (Num -> Num) -> Num -> Num -> Num


const createRound = R.curry((f, precision, num) => {
  const p = Math.pow(10, precision);
  return f(num * p) / p;
}); // roundPrec :: Num -> Num -> Num

const roundPrec = createRound(Math.round); // this gives R.map access to collection's index like native Array.prototype.map

const mapIndexed = R.addIndex(R.map);
const reduceIndexed = R.addIndex(R.reduce);
const mergeLists = R.curry((a, b) => reduceIndexed((acc, v, i) => {
  const acc_ = acc;
  acc_[i] = v;
  return acc_;
}, a || [], b));
const fileSafeString = R.pipe(R.trim, R.toLower, R.split(/[^a-zA-Z0-9]/g), R.filter(R.prop('length')), R.join('_'));
const truncate = R.curry((suffix, length, s) => s.length > length ? s.substring(0, length) + suffix : s);

const escapeRegExp = string => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

module.exports = {
  checkJpeg,
  getPathForIsvg,
  fullIconPath,
  botTypeToGender,
  genderToCodeName,
  printerIDtoSerial,
  connTypeToString,
  trackingInfoForPrinter,
  sendPrinterAnalytics,
  progress,
  getMaterialPrettyStringFromCode,
  getMaterialSliceConfigStringFromCode,
  filamentLengthToMass,
  getTracking,
  getLogging,
  getI18n,
  getModal,
  getConfig,
  safeKey,
  getSafeKeyProp,
  setSafeKeyProp,
  removeSafeKeyProp,
  appendSafeKey,
  removeSafeKey,
  pSplit,
  rangeStep,
  roundPrec,
  mapIndexed,
  fileSafeString,
  truncate,
  escapeRegExp,
  reduceIndexed,
  mergeLists
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWwuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJSIiwiRE9NIiwiY29uc3RhbnRzIiwianBlZ1NPSSIsImpwZWdFT0kiLCJjaGVja0pwZWciLCJmcmFtZUJ1ZiIsInNsaWNlIiwidG9TdHJpbmciLCJsZW5ndGgiLCJnZXRQYXRoRm9ySXN2ZyIsIm9zX3R5cGUiLCJ0eXBlIiwic3BsaXQiLCJqb2luIiwiZnVsbEljb25QYXRoIiwidXJpIiwicmVzb2x2ZSIsImJvdFR5cGVUb0dlbmRlciIsImJvdFR5cGUiLCJQcmludGVyR2VuZGVyU3RyaW5nIiwiZ2V0IiwiZ2VuZGVyVG9Db2RlTmFtZSIsImdlbmRlciIsIlByaW50ZXJDb2RlTmFtZXMiLCJwcmludGVySUR0b1NlcmlhbCIsImlkIiwiY29ublR5cGVUb1N0cmluZyIsImNvbm5UeXBlIiwiUHJpbnRlckNvbm5UeXBlRW51bSIsIlVTQiIsIk5FVFdPUksiLCJSRUZMRUNUT1IiLCJBUkNIRVRZUEUiLCJ0cmFja2luZ0luZm9Gb3JQcmludGVyIiwicHJpbnRlciIsInByaW50ZXJfaWQiLCJnZXRJZCIsInByaW50ZXJfdHlwZSIsImdldEdlbmRlciIsImdldE5hbWUiLCJjb25uZWN0aW9uX3R5cGUiLCJnZXRDb25uZWN0aW9uVHlwZSIsInNlbmRQcmludGVyQW5hbHl0aWNzIiwiZmx1eCIsImV2ZW50IiwidHJhY2tpbmdTZXJ2aWNlIiwiZ2V0U2VydmljZSIsInN0b3JlIiwiZ2V0U2VsZWN0ZWRQcmludGVyIiwidHJhY2tpbmdJbmZvIiwiZ2V0VHJhY2tpbmdJbmZvIiwidHJhY2tpbmdEYXRhIiwibWVyZ2UiLCJuYW1lIiwiYWRkRXZlbnQiLCJwcm9ncmVzcyIsInJlcXVlc3QiLCJvcHRpb25zIiwicHJvZ3Jlc3NDb250ZXh0IiwicmVzcG9uc2UiLCJFcnJvciIsImNvbnRleHQiLCJsZW5ndGhIZWFkZXIiLCJvblJlcXVlc3QiLCJzdGF0ZSIsInByb2dyZXNzU3RhdGUiLCJvblJlc3BvbnNlIiwiY2FuY2VsIiwiYWJvcnQiLCJiaW5kIiwicGVyY2VudGFnZSIsInNpemUiLCJ0b3RhbCIsIk51bWJlciIsImhlYWRlcnMiLCJ0cmFuc2ZlcnJlZCIsIm9uRGF0YSIsImRhdGEiLCJyZXBvcnRTdGF0ZSIsIm9uRW5kIiwiTWF0aCIsIm1pbiIsImVtaXQiLCJvbiIsInJlcyIsImdldE1hdGVyaWFsUHJldHR5U3RyaW5nRnJvbUNvZGUiLCJtYXRlcmlhbE5hbWUiLCJTbGljZUNvbmZpZ1N0cmluZ3NUb1ByZXR0eVN0cmluZ3MiLCJnZXRNYXRlcmlhbFNsaWNlQ29uZmlnU3RyaW5nRnJvbUNvZGUiLCJtYXRlcmlhbFR5cGUiLCJNYXRlcmlhbENvZGVzVG9TbGljZUNvbmZpZ1N0cmluZ3MiLCJmaWxhbWVudExlbmd0aFRvTWFzcyIsImxpbmVhckRlbnNpdHkiLCJnZXRUcmFja2luZyIsImdldExvZ2dpbmciLCJnZXRJMThuIiwiZ2V0TW9kYWwiLCJnZXRDb25maWciLCJzYWZlS2V5IiwicmVwbGFjZSIsImdldFNhZmVLZXlQcm9wIiwidW5jdXJyeU4iLCJwaXBlIiwicHJvcCIsInNldFNhZmVLZXlQcm9wIiwiYXNzb2MiLCJyZW1vdmVTYWZlS2V5UHJvcCIsImRpc3NvYyIsImFwcGVuZFNhZmVLZXkiLCJhcHBlbmQiLCJyZW1vdmVTYWZlS2V5IiwiZWxlbSIsImFycmF5Iiwid2l0aG91dCIsInBTcGxpdCIsIm1hcCIsInBhcnRpYWwiLCJwIiwicmFuZ2VTdGVwIiwic3RlcCIsInN0YXJ0Iiwic3RvcCIsIm4iLCJyYW5nZSIsImNyZWF0ZVJvdW5kIiwiY3VycnkiLCJmIiwicHJlY2lzaW9uIiwibnVtIiwicG93Iiwicm91bmRQcmVjIiwicm91bmQiLCJtYXBJbmRleGVkIiwiYWRkSW5kZXgiLCJyZWR1Y2VJbmRleGVkIiwicmVkdWNlIiwibWVyZ2VMaXN0cyIsImEiLCJiIiwiYWNjIiwidiIsImkiLCJhY2NfIiwiZmlsZVNhZmVTdHJpbmciLCJ0cmltIiwidG9Mb3dlciIsImZpbHRlciIsInRydW5jYXRlIiwic3VmZml4IiwicyIsInN1YnN0cmluZyIsImVzY2FwZVJlZ0V4cCIsInN0cmluZyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUMsQ0FBQyxHQUFHRCxPQUFPLENBQUMsT0FBRCxDQUFqQjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBO0FBQUYsSUFBVUYsT0FBTyxDQUFDLE9BQUQsQ0FBdkI7O0FBRUEsTUFBTUcsU0FBUyxHQUFHSCxPQUFPLENBQUMsYUFBRCxDQUF6Qjs7QUFFQSxNQUFNSSxPQUFPLEdBQUcsTUFBaEIsQyxDQUF3Qjs7QUFDeEIsTUFBTUMsT0FBTyxHQUFHLE1BQWhCLEMsQ0FBd0I7O0FBRXhCLFNBQVNDLFNBQVQsQ0FBbUJDLFFBQW5CLEVBQTZCO0FBQ3pCO0FBQ0EsU0FDSSxDQUFDQSxRQUFRLENBQUNDLEtBQVQsQ0FBZSxDQUFmLEVBQWtCLENBQWxCLEVBQXFCQyxRQUFyQixDQUE4QixLQUE5QixNQUF5Q0wsT0FBekMsSUFDR0csUUFBUSxDQUFDQyxLQUFULENBQWVELFFBQVEsQ0FBQ0csTUFBVCxHQUFrQixDQUFqQyxFQUFvQ0gsUUFBUSxDQUFDRyxNQUE3QyxFQUFxREQsUUFBckQsQ0FBOEQsS0FBOUQsQ0FESixNQUM4RUosT0FGbEY7QUFJSDs7QUFFRCxTQUFTTSxjQUFULENBQXdCWixJQUF4QixFQUE4QjtBQUMxQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsUUFBTWEsT0FBTyxHQUFHWixPQUFPLENBQUMsSUFBRCxDQUFQLENBQWNhLElBQWQsRUFBaEI7O0FBQ0EsTUFBSUQsT0FBTyxLQUFLLFlBQWhCLEVBQThCLE9BQU9iLElBQUksQ0FBQ2UsS0FBTCxDQUFXLElBQVgsRUFBaUJDLElBQWpCLENBQXNCLEdBQXRCLENBQVA7QUFDOUIsU0FBT2hCLElBQVA7QUFDSDs7QUFFRCxTQUFTaUIsWUFBVCxDQUFzQkMsR0FBdEIsRUFBMkI7QUFDdkIsU0FBT04sY0FB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cGF0aCcpO1xyXG5jb25zdCBSID0gcmVxdWlyZSgncmFtZGEnKTtcclxuY29uc3QgeyBET00gfSA9IHJlcXVpcmUoJ3JlYWN0Jyk7XHJcblxyXG5jb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpO1xyXG5cclxuY29uc3QganBlZ1NPSSA9ICdmZmQ4JzsgLy8gc3RhcnRpbmcgYnl0ZXMgaW5kaWNhdGluZyB0aGUgZGF0YSBpcyBhIGpwZWdcclxuY29uc3QganBlZ0VPSSA9ICdmZmQ5JzsgLy8gZW5kaW5nIGJ5dGVzXHJcblxyXG5mdW5jdGlvbiBjaGVja0pwZWcoZnJhbWVCdWYpIHtcclxuICAgIC8vIGFzc3VtZSB0aGF0IGlmIHRoZSBzdGFydCBhbmQgZW5kIGFyZSBnb29kLCB0aGUgbWlkZGxlIGlzIG9rYXkgdG9vXHJcbiAgICByZXR1cm4gKFxyXG4gICAgICAgIChmcmFtZUJ1Zi5zbGljZSgwLCAyKS50b1N0cmluZygnaGV4JykgPT09IGpwZWdTT0kgJiZcclxuICAgICAgICAgICAgZnJhbWVCdWYuc2xpY2UoZnJhbWVCdWYubGVuZ3RoIC0gMiwgZnJhbWVCdWYubGVuZ3RoKS50b1N0cmluZygnaGV4JykpID09PSBqcGVnRU9JXHJcbiAgICApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRQYXRoRm9ySXN2ZyhwYXRoKSB7XHJcbiAgICAvLyBzb21lIHN0dXBpZCBjb2RlIHRvIGZpeCBwYXRocyBiZWZvcmUgcGFzc2luZyB0aGVtIHRvIHJlYWN0LWlubGluZXN2Zy0tXHJcbiAgICAvLyByZWFjdC1pbmxpbmVzdmcgaXMgdXNpbmcgYSBtb2R1bGUgY2FsbGVkIGh0dHBwbGVhc2UgdGhhdCB3aWxsIHVybC1lbmNvZGVcclxuICAgIC8vIGluY29taW5nIHBhdGhzLCB3aGljaCBicmVha3Mgd2l0aCB3aW5kb3dzJyBiYWNrc2xhc2gtc2VwYXJhdGVkIHBhdGhzLi4uXHJcbiAgICAvLyBMdWNraWx5LCB0aGVzZSBwYXRocyB3aWxsIGJlIGhhbmRsZWQgY29ycmVjdGx5IGlmIHdlIGNoYW5nZSB0aGUgYmFja3NsYXNoZXNcclxuICAgIC8vIHRvIGZvcndhcmQgc2xhc2hlcyB0aG91Z2guLi4uXHJcbiAgICBjb25zdCBvc190eXBlID0gcmVxdWlyZSgnb3MnKS50eXBlKCk7XHJcbiAgICBpZiAob3NfdHlwZSA9PT0gJ1dpbmRvd3NfTlQnKSByZXR1cm4gcGF0aC5zcGxpdCgnXFxcXCcpLmpvaW4oJy8nKTtcclxuICAgIHJldHVybiBwYXRoO1xyXG59XHJcblxyXG5mdW5jdGlvbiBmdWxsSWNvblBhdGgodXJpKSB7XHJcbiAgICByZXR1cm4gZ2V0UGF0aEZvcklzdmcocGF0aC5yZXNvbHZlKCdub2RlX21vZHVsZXMvTUItc3VwcG9ydC1wbHVnaW4vJywgdXJpKSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGJvdFR5cGVUb0dlbmRlcihib3RUeXBlKSB7XHJcbiAgICByZXR1cm4gY29uc3RhbnRzLlByaW50ZXJHZW5kZXJTdHJpbmcuZ2V0KGJvdFR5cGUpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZW5kZXJUb0NvZGVOYW1lKGdlbmRlcikge1xyXG4gICAgcmV0dXJuIGNvbnN0YW50cy5QcmludGVyQ29kZU5hbWVzLmdldChnZW5kZXIpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwcmludGVySUR0b1NlcmlhbChpZCkge1xyXG4gICAgcmV0dXJuIGlkLnNwbGl0KCc6JylbMl07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbm5UeXBlVG9TdHJpbmcoY29ublR5cGUpIHtcclxuICAgIHN3aXRjaCAoY29ublR5cGUpIHtcclxuICAgICAgICBjYXNlIGNvbnN0YW50cy5QcmludGVyQ29ublR5cGVFbnVtLlVTQjpcclxuICAgICAgICAgICAgcmV0dXJuICdVU0InO1xyXG4gICAgICAgIGNhc2UgY29uc3RhbnRzLlByaW50ZXJDb25uVHlwZUVudW0uTkVUV09SSzpcclxuICAgICAgICAgICAgcmV0dXJuICdOZXR3b3JrJztcclxuICAgICAgICBjYXNlIGNvbnN0YW50cy5QcmludGVyQ29ublR5cGVFbnVtLlJFRkxFQ1RPUjpcclxuICAgICAgICAgICAgcmV0dXJuICdSZWZsZWN0b3InO1xyXG4gICAgICAgIGNhc2UgY29uc3RhbnRzLlByaW50ZXJDb25uVHlwZUVudW0uQVJDSEVUWVBFOlxyXG4gICAgICAgICAgICByZXR1cm4gJ0FyY2hldHlwZSc7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRyYWNraW5nSW5mb0ZvclByaW50ZXIocHJpbnRlcikge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBwcmludGVyX2lkOiBwcmludGVySUR0b1NlcmlhbChwcmludGVyLmdldElkKCkpLFxyXG4gICAgICAgIHByaW50ZXJfdHlwZTogZ2VuZGVyVG9Db2RlTmFtZShwcmludGVyLmdldEdlbmRlcigpLmdldE5hbWUoKSksXHJcbiAgICAgICAgY29ubmVjdGlvbl90eXBlOiBwcmludGVyLmdldENvbm5lY3Rpb25UeXBlKCksXHJcbiAgICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZW5kUHJpbnRlckFuYWx5dGljcyhmbHV4LCBldmVudCkge1xyXG4gICAgY29uc3QgdHJhY2tpbmdTZXJ2aWNlID0gZmx1eC5nZXRTZXJ2aWNlKCdUcmFja2luZ1NlcnZpY2UnKTtcclxuICAgIGNvbnN0IHByaW50ZXIgPSBmbHV4LnN0b3JlKCdQcmludGVyU3RvcmUnKS5nZXRTZWxlY3RlZFByaW50ZXIoKTtcclxuICAgIGNvbnN0IHRyYWNraW5nSW5mbyA9IHByaW50ZXIgPyBwcmludGVyLmdldFRyYWNraW5nSW5mbygpIDogbnVsbDtcclxuICAgIGNvbnN0IHRyYWNraW5nRGF0YSA9IFIubWVyZ2UoeyBuYW1lOiBldmVudCB9LCB0cmFja2luZ0luZm8pO1xyXG4gICAgdHJhY2tpbmdTZXJ2aWNlLmFkZEV2ZW50KHRyYWNraW5nRGF0YSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBIHdyYXBwZXIgZm9yIGByZXF1ZXN0YCB0byBhbGxvdyBwcm9ncmVzcyByZXBvcnRpbmcgZHVyaW5nXHJcbiAqIGEgbGFyZ2UgZG93bmxvYWQuXHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIHByb2dyZXNzKHJlcXVlc3QoXCJodHRwOi8vZXhhbXBsZS5jb20vZXhhbXBsZVwiKSlcclxuICogIC5vbigncHJvZ3Jlc3MnLCBwcm9nID0+IGNvbnNvbGUubG9nKGBEb3dubG9hZGluZzogJHtwcm9nLnBlcmNlbnRhZ2V9JWApKVxyXG4gKiAgLmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZygnc29tZXRoaW5nIHdlbnQgd3Jvbmc6JywgZXJyKSk7XHJcbiAqXHJcbiAqIEByZXR1cm5zIHtSZXF1ZXN0fSB0aGUgc2FtZSByZXF1ZXN0IG9iamVjdCBwYXNzZWQgYXMgYSBwYXJhbWV0ZXIsIGJ1dCB3aXRoIGV4dHJhIGxpc3RlbmVycyBhdHRhY2hlZFxyXG4gKi9cclxuZnVuY3Rpb24gcHJvZ3Jlc3MocmVxdWVzdCwgb3B0aW9ucykge1xyXG4gICAgLy8gcHJldmVudCB1cyBmcm9tIHdyYXBwaW5nIGl0IHR3aWNlXHJcbiAgICBpZiAocmVxdWVzdC5wcm9ncmVzc0NvbnRleHQpIHtcclxuICAgICAgICByZXR1cm4gcmVxdWVzdDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAocmVxdWVzdC5yZXNwb25zZSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIlJlcXVlc3QgaGFzIGFscmVhZHkgcmVzcG9uZGVkLiBDYW4ndCBnZXQgcHJvZ3Jlc3NcIik7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY29udGV4dCA9IHt9O1xyXG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XHJcbiAgICBjb250ZXh0LnJlcXVlc3QgPSByZXF1ZXN0O1xyXG4gICAgY29udGV4dC5vcHRpb25zID0ge307XHJcbiAgICBjb250ZXh0Lm9wdGlvbnMubGVuZ3RoSGVhZGVyID0gb3B0aW9ucy5sZW5ndGhIZWFkZXIgfHwgJ2NvbnRlbnQtbGVuZ3RoJztcclxuXHJcbiAgICAvLyB3ZSd2ZSBpbml0aWF0ZWQgYSByZXF1ZXN0XHJcbiAgICBjb25zdCBvblJlcXVlc3QgPSBjb250ZXh0ID0+IHtcclxuICAgICAgICBjb250ZXh0LnN0YXRlID0gY29udGV4dC5yZXF1ZXN0LnByb2dyZXNzU3RhdGU7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIHNlcnZlciByZXNwb25lZGVkIGluIGVudGlyZXR5XHJcbiAgICBjb25zdCBvblJlc3BvbnNlID0gKGNvbnRleHQsIHJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgLy8gemVybyBvdXQgZXZlcnl0aGluZ1xyXG4gICAgICAgIGNvbnRleHQuc3RhdGUgPSBjb250ZXh0LnJlcXVlc3QucHJvZ3Jlc3NTdGF0ZSA9IHtcclxuICAgICAgICAgICAgY2FuY2VsOiBjb250ZXh0LnJlcXVlc3QuYWJvcnQuYmluZChjb250ZXh0LnJlcXVlc3QpLFxyXG4gICAgICAgICAgICBwZXJjZW50YWdlOiAwLFxyXG4gICAgICAgICAgICBzaXplOiB7XHJcbiAgICAgICAgICAgICAgICB0b3RhbDogTnVtYmVyKHJlc3BvbnNlLmhlYWRlcnNbY29udGV4dC5vcHRpb25zLmxlbmd0aEhlYWRlcl0pIHx8IG51bGwsXHJcbiAgICAgICAgICAgICAgICB0cmFuc2ZlcnJlZDogMCxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBkYXRhIGhhcyBjb21lIGRvd24sIHJlcG9ydCB0aGUgcHJvZ3Jlc3NcclxuICAgIGNvbnN0IG9uRGF0YSA9IChjb250ZXh0LCBkYXRhKSA9PiB7XHJcbiAgICAgICAgY29udGV4dC5zdGF0ZS5zaXplLnRyYW5zZmVycmVkICs9IGRhdGEubGVuZ3RoO1xyXG4gICAgICAgIHJlcG9ydFN0YXRlKGNvbnRleHQpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBjbGVhbiB1cCBldmVyeXRoaW5nXHJcbiAgICBjb25zdCBvbkVuZCA9IGNvbnRleHQgPT4ge1xyXG4gICAgICAgIGNvbnRleHQucmVxdWVzdC5wcm9ncmVzc1N0YXRlID0gY29udGV4dC5yZXF1ZXN0LnByb2dyZXNzQ29udGV4dCA9IG51bGw7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGFjdHVhbGx5IHJlcG9ydCB0aGUgc3RhdGUgb2YgdGhlIGRvd25sb2FkXHJcbiAgICBjb25zdCByZXBvcnRTdGF0ZSA9IGNvbnRleHQgPT4ge1xyXG4gICAgICAgIGlmICghY29udGV4dC5yZXF1ZXN0LnByb2dyZXNzU3RhdGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3Qgc3RhdGUgPSBjb250ZXh0LnN0YXRlO1xyXG5cclxuICAgICAgICBpZiAoc3RhdGUuc2l6ZS50b3RhbCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLnBlcmNlbnRhZ2UgPSBNYXRoLm1pbihzdGF0ZS5zaXplLnRyYW5zZmVycmVkLCBzdGF0ZS5zaXplLnRvdGFsKSAvIHN0YXRlLnNpemUudG90YWw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb250ZXh0LnJlcXVlc3QuZW1pdCgncHJvZ3Jlc3MnLCBzdGF0ZSk7XHJcbiAgICB9O1xyXG5cclxuICAgIHJlcXVlc3RcclxuICAgICAgICAub24oJ3JlcXVlc3QnLCAoKSA9PiBvblJlcXVlc3QoY29udGV4dCkpXHJcbiAgICAgICAgLm9uKCdyZXNwb25zZScsIHJlcyA9PiBvblJlc3BvbnNlKGNvbnRleHQsIHJlcykpXHJcbiAgICAgICAgLm9uKCdkYXRhJywgZGF0YSA9PiBvbkRhdGEoY29udGV4dCwgZGF0YSkpXHJcbiAgICAgICAgLm9uKCdlbmQnLCAoKSA9PiBvbkVuZChjb250ZXh0KSk7XHJcblxyXG4gICAgcmV0dXJuIHJlcXVlc3Q7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldE1hdGVyaWFsUHJldHR5U3RyaW5nRnJvbUNvZGUobWF0ZXJpYWxOYW1lKSB7XHJcbiAgICByZXR1cm4gY29uc3RhbnRzLlNsaWNlQ29uZmlnU3RyaW5nc1RvUHJldHR5U3RyaW5nc1ttYXRlcmlhbE5hbWVdO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRNYXRlcmlhbFNsaWNlQ29uZmlnU3RyaW5nRnJvbUNvZGUobWF0ZXJpYWxUeXBlKSB7XHJcbiAgICByZXR1cm4gY29uc3RhbnRzLk1hdGVyaWFsQ29kZXNUb1NsaWNlQ29uZmlnU3RyaW5nc1ttYXRlcmlhbFR5cGVdO1xyXG59XHJcblxyXG5mdW5jdGlvbiBmaWxhbWVudExlbmd0aFRvTWFzcyhsZW5ndGgsIGxpbmVhckRlbnNpdHkpIHtcclxuICAgIHJldHVybiBsZW5ndGggKiBsaW5lYXJEZW5zaXR5O1xyXG59XHJcblxyXG5jb25zdCBnZXRUcmFja2luZyA9IGZsdXggPT4gZmx1eC5nZXRTZXJ2aWNlKCdUcmFja2luZ1NlcnZpY2UnKTtcclxuY29uc3QgZ2V0TG9nZ2luZyA9IGZsdXggPT4gZmx1eC5nZXRTZXJ2aWNlKCdMb2dnaW5nU2VydmljZScpO1xyXG5jb25zdCBnZXRJMThuID0gZmx1eCA9PiBmbHV4LmdldFNlcnZpY2UoJ1RyYW5zbGF0aW9uU2VydmljZScpO1xyXG5jb25zdCBnZXRNb2RhbCA9IGZsdXggPT4gZmx1eC5nZXRTZXJ2aWNlKCdNb2RhbFNlcnZpY2UnKTtcclxuY29uc3QgZ2V0Q29uZmlnID0gZmx1eCA9PiBmbHV4LmdldFNlcnZpY2UoJ0NvbmZpZ1NlcnZpY2UnKTtcclxuXHJcbi8vIENvbnZlcnRzIGFuIHVuc2F2ZSBKUyBzdHJpbmcgKHdpdGggJzonIGFuZCAnLicpIGludG8gYSBzYWZlIEpTIHN0cmluZyBmb3JcclxuLy8gb2JqZWN0IGtleXMuXHJcbi8vIGV4OiBzYWZlS2V5KCdhLmI6YycpIC8vIHJldHVybnMgJ2FfYl9jJ1xyXG4vLyBzYWZlS2V5IDo6IFN0cmluZyAtPiBTdHJpbmdcclxuY29uc3Qgc2FmZUtleSA9IFIucmVwbGFjZSgvWzp8Ll0vZywgJ18nKTtcclxuXHJcbi8vIEdldHMgYSB2YWx1ZSBmcm9tIGFuIG9iamVjdCB3aG9zZSBrZXlzIGhhdmUgYmVlbiBjb252ZXJ0ZWQgdG8gc2FmZSBrZXlzLlxyXG4vLyBZb3UgY2FuIHVzZSBhbiB1bnNhZmUga2V5IHRvIHNlYXJjaCBhbmQgaXQgd2lsbCBiZSBjb252ZXJ0ZWRcclxuLy8gZ2V0U2FmZUtleVByb3AgOjogU3RyaW5nIC0+IHtrOiB2fSAtPiBhXHJcbmNvbnN0IGdldFNhZmVLZXlQcm9wID0gUi51bmN1cnJ5TigyLCBSLnBpcGUoc2FmZUtleSwgUi5wcm9wKSk7XHJcblxyXG4vLyBTZXRzIGEgdmFsdWUgaW4gYW4gb2JqZWN0IHdob3NlIGtleXMgaGF2ZSBiZWVuIGNvbnZlcnRlZCB0byBzYWZlIGtleXMuXHJcbi8vIFlvdSBjYW4gdXNlIGFuIHVuc2FmZSBrZXkgdG8gc2VhcmNoIGFuZCBpdCB3aWxsIGJlIGNvbnZlcnRlZFxyXG4vLyBzZXRTYWZlS2V5UHJvcCA6OiBTdHJpbmcgLT4gYSAtPiB7azogdn0gLT4ge2s6IHZ9XHJcbmNvbnN0IHNldFNhZmVLZXlQcm9wID0gUi51bmN1cnJ5TigzLCBSLnBpcGUoc2FmZUtleSwgUi5hc3NvYykpO1xyXG5cclxuLy8gcmVtb3ZlU2FmZUtleVByb3AgOjogU3RyaW5nIC0+IHtrOiB2fSAtPiB7azogdn1cclxuY29uc3QgcmVtb3ZlU2FmZUtleVByb3AgPSBSLnVuY3VycnlOKDIsIFIucGlwZShzYWZlS2V5LCBSLmRpc3NvYykpO1xyXG5cclxuLy8gYXBwZW5kU2FmZUtleSA6OiBTdHJpbmcgLT4gW1N0cmluZ10gLT4gW1N0cmluZ11cclxuY29uc3QgYXBwZW5kU2FmZUtleSA9IFIudW5jdXJyeU4oMiwgUi5waXBlKHNhZmVLZXksIFIuYXBwZW5kKSk7XHJcblxyXG4vLyByZW1vdmVTYWZlS2V5IDo6IFN0cmluZyAtPiBbU3RyaW5nXSAtPiBbU3RyaW5nXVxyXG5jb25zdCByZW1vdmVTYWZlS2V5ID0gKGVsZW0sIGFycmF5KSA9PiBSLndpdGhvdXQoW3NhZmVLZXkoZWxlbSldLCBhcnJheSk7XHJcblxyXG4vLyBzcGxpdCBpbnRvIHBhcmFncmFwaCB0YWdzIG9uIG5ld2xpbmVzXHJcbi8vIHBTcGxpdCA6OiBTdHJpbmcgLT4gW1JlYWN0LkVsZW1lbnRdXHJcbmNvbnN0IHBTcGxpdCA9IFIucGlwZShSLnNwbGl0KCdcXG4nKSwgUi5tYXAoUi5wYXJ0aWFsKERPTS5wLCBbe31dKSkpO1xyXG5cclxuY29uc3QgcmFuZ2VTdGVwID0gKHN0ZXAsIHN0YXJ0LCBzdG9wKSA9PiB7XHJcbiAgICByZXR1cm4gUi5tYXAobiA9PiBzdGFydCArIHN0ZXAgKiBuLCBSLnJhbmdlKDAsICgxICsgKHN0b3AgLSBzdGFydCkgLyBzdGVwKSA+Pj4gMCkpO1xyXG59O1xyXG5cclxuLy8gY3JlYXRlUm91bmQgOjogKE51bSAtPiBOdW0pIC0+IE51bSAtPiBOdW0gLT4gTnVtXHJcbmNvbnN0IGNyZWF0ZVJvdW5kID0gUi5jdXJyeSgoZiwgcHJlY2lzaW9uLCBudW0pID0+IHtcclxuICAgIGNvbnN0IHAgPSBNYXRoLnBvdygxMCwgcHJlY2lzaW9uKTtcclxuICAgIHJldHVybiBmKG51bSAqIHApIC8gcDtcclxufSk7XHJcblxyXG4vLyByb3VuZFByZWMgOjogTnVtIC0+IE51bSAtPiBOdW1cclxuY29uc3Qgcm91bmRQcmVjID0gY3JlYXRlUm91bmQoTWF0aC5yb3VuZCk7XHJcblxyXG4vLyB0aGlzIGdpdmVzIFIubWFwIGFjY2VzcyB0byBjb2xsZWN0aW9uJ3MgaW5kZXggbGlrZSBuYXRpdmUgQXJyYXkucHJvdG90eXBlLm1hcFxyXG5jb25zdCBtYXBJbmRleGVkID0gUi5hZGRJbmRleChSLm1hcCk7XHJcblxyXG5jb25zdCByZWR1Y2VJbmRleGVkID0gUi5hZGRJbmRleChSLnJlZHVjZSk7XHJcblxyXG5jb25zdCBtZXJnZUxpc3RzID0gUi5jdXJyeSgoYSwgYikgPT5cclxuICAgIHJlZHVjZUluZGV4ZWQoXHJcbiAgICAgICAgKGFjYywgdiwgaSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBhY2NfID0gYWNjO1xyXG4gICAgICAgICAgICBhY2NfW2ldID0gdjtcclxuICAgICAgICAgICAgcmV0dXJuIGFjY187XHJcbiAgICAgICAgfSxcclxuICAgICAgICBhIHx8IFtdLFxyXG4gICAgICAgIGJcclxuICAgIClcclxuKTtcclxuXHJcbmNvbnN0IGZpbGVTYWZlU3RyaW5nID0gUi5waXBlKFIudHJpbSwgUi50b0xvd2VyLCBSLnNwbGl0KC9bXmEtekEtWjAtOV0vZyksIFIuZmlsdGVyKFIucHJvcCgnbGVuZ3RoJykpLCBSLmpvaW4oJ18nKSk7XHJcblxyXG5jb25zdCB0cnVuY2F0ZSA9IFIuY3VycnkoKHN1ZmZpeCwgbGVuZ3RoLCBzKSA9PiAocy5sZW5ndGggPiBsZW5ndGggPyBzLnN1YnN0cmluZygwLCBsZW5ndGgpICsgc3VmZml4IDogcykpO1xyXG5cclxuY29uc3QgZXNjYXBlUmVnRXhwID0gc3RyaW5nID0+IHN0cmluZy5yZXBsYWNlKC9bLiorP14ke30oKXxbXFxdXFxcXF0vZywgJ1xcXFwkJicpO1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgICBjaGVja0pwZWcsXHJcbiAgICBnZXRQYXRoRm9ySXN2ZyxcclxuICAgIGZ1bGxJY29uUGF0aCxcclxuICAgIGJvdFR5cGVUb0dlbmRlcixcclxuICAgIGdlbmRlclRvQ29kZU5hbWUsXHJcbiAgICBwcmludGVySUR0b1NlcmlhbCxcclxuICAgIGNvbm5UeXBlVG9TdHJpbmcsXHJcbiAgICB0cmFja2luZ0luZm9Gb3JQcmludGVyLFxyXG4gICAgc2VuZFByaW50ZXJBbmFseXRpY3MsXHJcbiAgICBwcm9ncmVzcyxcclxuICAgIGdldE1hdGVyaWFsUHJldHR5U3RyaW5nRnJvbUNvZGUsXHJcbiAgICBnZXRNYXRlcmlhbFNsaWNlQ29uZmlnU3RyaW5nRnJvbUNvZGUsXHJcbiAgICBmaWxhbWVudExlbmd0aFRvTWFzcyxcclxuICAgIGdldFRyYWNraW5nLFxyXG4gICAgZ2V0TG9nZ2luZyxcclxuICAgIGdldEkxOG4sXHJcbiAgICBnZXRNb2RhbCxcclxuICAgIGdldENvbmZpZyxcclxuICAgIHNhZmVLZXksXHJcbiAgICBnZXRTYWZlS2V5UHJvcCxcclxuICAgIHNldFNhZmVLZXlQcm9wLFxyXG4gICAgcmVtb3ZlU2FmZUtleVByb3AsXHJcbiAgICBhcHBlbmRTYWZlS2V5LFxyXG4gICAgcmVtb3ZlU2FmZUtleSxcclxuICAgIHBTcGxpdCxcclxuICAgIHJhbmdlU3RlcCxcclxuICAgIHJvdW5kUHJlYyxcclxuICAgIG1hcEluZGV4ZWQsXHJcbiAgICBmaWxlU2FmZVN0cmluZyxcclxuICAgIHRydW5jYXRlLFxyXG4gICAgZXNjYXBlUmVnRXhwLFxyXG4gICAgcmVkdWNlSW5kZXhlZCxcclxuICAgIG1lcmdlTGlzdHMsXHJcbn07XHJcbiJdfQ==
