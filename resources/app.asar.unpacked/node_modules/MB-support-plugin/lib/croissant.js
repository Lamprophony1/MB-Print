'use strict'; // Wrapper around our native croissant module to locate and
// import the correct module.

const path = require('path');

const fs = require('fs');

const paths = require('./paths');

const _croissant = paths.requireNativeCroissant();
const DIAGNOSTIC_TAG = '[croissant-diagnostic]';
const DIAGNOSTIC_WRAPPED = '__croissantDiagnosticWrapped';

function isPlainObject(value) {
  return Object.prototype.toString.call(value) === '[object Object]';
}

function redactString(value) {
  if (typeof value !== 'string') return value;
  if (/^Bearer\s+/i.test(value)) return 'Bearer [REDACTED]';
  return value;
}

function sanitize(value, depth = 0) {
  if (depth > 4) return '[MaxDepth]';
  if (value === null || value === undefined) return value;
  if (Array.isArray(value)) return value.map(item => sanitize(item, depth + 1));

  if (isPlainObject(value)) {
    const sanitized = {};
    Object.keys(value).forEach(key => {
      if (/(token|secret|password|authorization|authinfo|auth_code|code)/i.test(key)) {
        sanitized[key] = '[REDACTED]';
      } else {
        sanitized[key] = sanitize(value[key], depth + 1);
      }
    });
    return sanitized;
  }

  return redactString(value);
}

function getMappedErrorState(err) {
  if (!err) return null;
  if (_croissant.UnauthorizedError && err instanceof _croissant.UnauthorizedError) return 'UnauthorizedError';
  if (_croissant.AuthRejectedError && err instanceof _croissant.AuthRejectedError) return 'AuthRejectedError';
  if (_croissant.AuthTimedOutError && err instanceof _croissant.AuthTimedOutError) return 'AuthTimedOutError';
  return null;
}

function diagnosticLog(payload) {
  try {
    console.log(`${DIAGNOSTIC_TAG} ${JSON.stringify(payload)}`);
  } catch (err) {
    console.log(`${DIAGNOSTIC_TAG} ${payload.type || 'log_error'}`);
  }
}

function wrapPrinterAuthMethods(printer) {
  if (!printer || printer[DIAGNOSTIC_WRAPPED]) return printer;

  ['Authorize', 'Authenticate', 'Reauthorize'].forEach(methodName => {
    if (typeof printer[methodName] !== 'function') return;
    const original = printer[methodName].bind(printer);

    printer[methodName] = function () {
      const startedAt = Date.now();
      const args = Array.from(arguments);

      diagnosticLog({
        type: 'croissant_call',
        method: methodName,
        stage: 'input',
        args: sanitize(args)
      });

      const result = original.apply(null, args);

      if (result && typeof result.then === 'function') {
        return result.then(res => {
          diagnosticLog({
            type: 'croissant_call',
            method: methodName,
            stage: 'output',
            durationMs: Date.now() - startedAt,
            result: sanitize(res)
          });
          return res;
        }).catch(err => {
          diagnosticLog({
            type: 'croissant_call',
            method: methodName,
            stage: 'error',
            durationMs: Date.now() - startedAt,
            mappedErrorState: getMappedErrorState(err),
            errorName: err && err.name,
            errorMessage: err && err.message
          });
          throw err;
        });
      }

      diagnosticLog({
        type: 'croissant_call',
        method: methodName,
        stage: 'output',
        durationMs: Date.now() - startedAt,
        result: sanitize(result)
      });
      return result;
    };
  });

  printer[DIAGNOSTIC_WRAPPED] = true;
  return printer;
}

function wrapCroissantMethod(methodName, options = {}) {
  if (typeof _croissant[methodName] !== 'function') return;
  const original = _croissant[methodName].bind(_croissant);

  _croissant[methodName] = function () {
    const startedAt = Date.now();
    const args = Array.from(arguments);
    diagnosticLog({
      type: 'croissant_call',
      method: methodName,
      stage: 'input',
      args: sanitize(args)
    });

    const result = original.apply(null, args);

    if (result && typeof result.then === 'function') {
      return result.then(res => {
        const wrappedResult = options.wrapPrinter ? wrapPrinterAuthMethods(res) : res;
        diagnosticLog({
          type: 'croissant_call',
          method: methodName,
          stage: 'output',
          durationMs: Date.now() - startedAt,
          result: sanitize(wrappedResult)
        });
        return wrappedResult;
      }).catch(err => {
        diagnosticLog({
          type: 'croissant_call',
          method: methodName,
          stage: 'error',
          durationMs: Date.now() - startedAt,
          mappedErrorState: getMappedErrorState(err),
          errorName: err && err.name,
          errorMessage: err && err.message
        });
        throw err;
      });
    }

    const wrappedResult = options.wrapPrinter ? wrapPrinterAuthMethods(result) : result;
    diagnosticLog({
      type: 'croissant_call',
      method: methodName,
      stage: 'output',
      durationMs: Date.now() - startedAt,
      result: sanitize(wrappedResult)
    });
    return wrappedResult;
  };
}

wrapCroissantMethod('connectPrinter', {
  wrapPrinter: true
});
wrapCroissantMethod('reconnectPrinter', {
  wrapPrinter: true
});

_croissant.createLog = function (logsDir) {
  // set log for croissant
  fs.stat(logsDir, function (err, stats) {
    if (err) {
      // Logs dir does not exist; make it
      try {
        console.log(`Making logs dir ${logsDir}`);
        fs.mkdirSync(logsDir);
      } catch (err) {
        console.log(err);
        return;
      }
    } // check contents of dir; if it has too many croissant logs,
    // delete the oldest


    fs.readdir(logsDir, function (err, files) {
      if (err) {
        console.log(err);
        return;
      }

      try {
        let croissantLogName = `Croissant-${new Date().toISOString()}.log`;
        croissantLogName = croissantLogName.replace(/:/g, '-');

        _croissant.setLog(path.join(logsDir, croissantLogName));

        console.log(`Creating Croissant logs at ${path.join(logsDir, croissantLogName)}`);
        const logFiles = files.filter(function (filename) {
          return filename.startsWith('Croissant');
        });

        if (logFiles.length > 5) {
          logFiles.sort(function (f1, f2) {
            return fs.statSync(path.join(logsDir, f1)).birthtime < fs.statSync(path.join(logsDir, f2)).birthtime;
          });
          fs.unlink(path.join(logsDir, logFiles[logFiles.length - 1]));
        }
      } catch (err) {
        console.log(err);
        return;
      }
    });
  });
};

module.exports = _croissant;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNyb2lzc2FudC5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsImZzIiwicGF0aHMiLCJfY3JvaXNzYW50IiwicmVxdWlyZU5hdGl2ZUNyb2lzc2FudCIsImNyZWF0ZUxvZyIsImxvZ3NEaXIiLCJzdGF0IiwiZXJyIiwic3RhdHMiLCJjb25zb2xlIiwibG9nIiwibWtkaXJTeW5jIiwicmVhZGRpciIsImZpbGVzIiwiY3JvaXNzYW50TG9nTmFtZSIsIkRhdGUiLCJ0b0lTT1N0cmluZyIsInJlcGxhY2UiLCJzZXRMb2ciLCJqb2luIiwibG9nRmlsZXMiLCJmaWx0ZXIiLCJmaWxlbmFtZSIsInN0YXJ0c1dpdGgiLCJsZW5ndGgiLCJzb3J0IiwiZjEiLCJmMiIsInN0YXRTeW5jIiwiYmlydGh0aW1lIiwidW5saW5rIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUEsYSxDQUVBO0FBQ0E7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNQyxFQUFFLEdBQUdELE9BQU8sQ0FBQyxJQUFELENBQWxCOztBQUVBLE1BQU1FLEtBQUssR0FBR0YsT0FBTyxDQUFDLFNBQUQsQ0FBckI7O0FBRUEsTUFBTUcsVUFBVSxHQUFHRCxLQUFLLENBQUNFLHNCQUFOLEVBQW5COztBQUVBRCxVQUFVLENBQUNFLFNBQVgsR0FBdUIsVUFBU0MsT0FBVCxFQUFrQjtBQUNyQztBQUNBTCxFQUFBQSxFQUFFLENBQUNNLElBQUgsQ0FBUUQsT0FBUixFQUFpQixVQUFTRSxHQUFULEVBQWNDLEtBQWQsRUFBcUI7QUFDbEMsUUFBSUQsR0FBSixFQUFTO0FBQ0w7QUFDQSxVQUFJO0FBQ0FFLFFBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLG1CQUFrQkwsT0FBUSxFQUF2QztBQUNBTCxRQUFBQSxFQUFFLENBQUNXLFNBQUgsQ0FBYU4sT0FBYjtBQUNILE9BSEQsQ0FHRSxPQUFPRSxHQUFQLEVBQVk7QUFDVkUsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlILEdBQVo7QUFDQTtBQUNIO0FBQ0osS0FWaUMsQ0FZbEM7QUFDQTs7O0FBQ0FQLElBQUFBLEVBQUUsQ0FBQ1ksT0FBSCxDQUFXUCxPQUFYLEVBQW9CLFVBQVNFLEdBQVQsRUFBY00sS0FBZCxFQUFxQjtBQUNyQyxVQUFJTixHQUFKLEVBQVM7QUFDTEUsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlILEdBQVo7QUFDQTtBQUNIOztBQUVELFVBQUk7QUFDQSxZQUFJTyxnQkFBZ0IsR0FBSSxhQUFZLElBQUlDLElBQUosR0FBV0MsV0FBWCxFQUF5QixNQUE3RDtBQUNBRixRQUFBQSxnQkFBZ0IsR0FBR0EsZ0JBQWdCLENBQUNHLE9BQWpCLENBQXlCLElBQXpCLEVBQStCLEdBQS9CLENBQW5COztBQUNBZixRQUFBQSxVQUFVLENBQUNnQixNQUFYLENBQWtCcEIsSUFBSSxDQUFDcUIsSUFBTCxDQUFVZCxPQUFWLEVBQW1CUyxnQkFBbkIsQ0FBbEI7O0FBQ0FMLFFBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLDhCQUE2QlosSUFBSSxDQUFDcUIsSUFBTCxDQUFVZCxPQUFWLEVBQW1CUyxnQkFBbkIsQ0FBcUMsRUFBL0U7QUFFQSxjQUFNTSxRQUFRLEdBQUdQLEtBQUssQ0FBQ1EsTUFBTixDQUFhLFVBQVNDLFFBQVQsRUFBbUI7QUFDN0MsaUJBQU9BLFFBQVEsQ0FBQ0MsVUFBVCxDQUFvQixXQUFwQixDQUFQO0FBQ0gsU0FGZ0IsQ0FBakI7O0FBSUEsWUFBSUgsUUFBUSxDQUFDSSxNQUFULEdBQWtCLENBQXRCLEVBQXlCO0FBQ3JCSixVQUFBQSxRQUFRLENBQUNLLElBQVQsQ0FBYyxVQUFTQyxFQUFULEVBQWFDLEVBQWIsRUFBaUI7QUFDM0IsbUJBQ0kzQixFQUFFLENBQUM0QixRQUFILENBQVk5QixJQUFJLENBQUNxQixJQUFMLENBQVVkLE9BQVYsRUFBbUJxQixFQUFuQixDQUFaLEVBQW9DRyxTQUFwQyxHQUNBN0IsRUFBRSxDQUFDNEIsUUFBSCxDQUFZOUIsSUFBSSxDQUFDcUIsSUFBTCxDQUFVZCxPQUFWLEVBQW1Cc0IsRUFBbkIsQ0FBWixFQUFvQ0UsU0FGeEM7QUFJSCxXQUxEO0FBT0E3QixVQUFBQSxFQUFFLENBQUM4QixNQUFILENBQVVoQyxJQUFJLENBQUNxQixJQUFMLENBQVVkLE9BQVYsRUFBbUJlLFFBQVEsQ0FBQ0EsUUFBUSxDQUFDSSxNQUFULEdBQWtCLENBQW5CLENBQTNCLENBQVY7QUFDSDtBQUNKLE9BcEJELENBb0JFLE9BQU9qQixHQUFQLEVBQVk7QUFDVkUsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlILEdBQVo7QUFDQTtBQUNIO0FBQ0osS0E5QkQ7QUErQkgsR0E3Q0Q7QUE4Q0gsQ0FoREQ7O0FBa0RBd0IsTUFBTSxDQUFDQyxPQUFQLEdBQWlCOUIsVUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG4vLyBXcmFwcGVyIGFyb3VuZCBvdXIgbmF0aXZlIGNyb2lzc2FudCBtb2R1bGUgdG8gbG9jYXRlIGFuZFxyXG4vLyBpbXBvcnQgdGhlIGNvcnJlY3QgbW9kdWxlLlxyXG5cclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xyXG5cclxuY29uc3QgcGF0aHMgPSByZXF1aXJlKCcuL3BhdGhzJyk7XHJcblxyXG5jb25zdCBfY3JvaXNzYW50ID0gcGF0aHMucmVxdWlyZU5hdGl2ZUNyb2lzc2FudCgpO1xyXG5cclxuX2Nyb2lzc2FudC5jcmVhdGVMb2cgPSBmdW5jdGlvbihsb2dzRGlyKSB7XHJcbiAgICAvLyBzZXQgbG9nIGZvciBjcm9pc3NhbnRcclxuICAgIGZzLnN0YXQobG9nc0RpciwgZnVuY3Rpb24oZXJyLCBzdGF0cykge1xyXG4gICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgLy8gTG9ncyBkaXIgZG9lcyBub3QgZXhpc3Q7IG1ha2UgaXRcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBNYWtpbmcgbG9ncyBkaXIgJHtsb2dzRGlyfWApO1xyXG4gICAgICAgICAgICAgICAgZnMubWtkaXJTeW5jKGxvZ3NEaXIpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGNoZWNrIGNvbnRlbnRzIG9mIGRpcjsgaWYgaXQgaGFzIHRvbyBtYW55IGNyb2lzc2FudCBsb2dzLFxyXG4gICAgICAgIC8vIGRlbGV0ZSB0aGUgb2xkZXN0XHJcbiAgICAgICAgZnMucmVhZGRpcihsb2dzRGlyLCBmdW5jdGlvbihlcnIsIGZpbGVzKSB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY3JvaXNzYW50TG9nTmFtZSA9IGBDcm9pc3NhbnQtJHtuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCl9LmxvZ2A7XHJcbiAgICAgICAgICAgICAgICBjcm9pc3NhbnRMb2dOYW1lID0gY3JvaXNzYW50TG9nTmFtZS5yZXBsYWNlKC86L2csICctJyk7XHJcbiAgICAgICAgICAgICAgICBfY3JvaXNzYW50LnNldExvZyhwYXRoLmpvaW4obG9nc0RpciwgY3JvaXNzYW50TG9nTmFtZSkpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYENyZWF0aW5nIENyb2lzc2FudCBsb2dzIGF0ICR7cGF0aC5qb2luKGxvZ3NEaXIsIGNyb2lzc2FudExvZ05hbWUpfWApO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGxvZ0ZpbGVzID0gZmlsZXMuZmlsdGVyKGZ1bmN0aW9uKGZpbGVuYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpbGVuYW1lLnN0YXJ0c1dpdGgoJ0Nyb2lzc2FudCcpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGxvZ0ZpbGVzLmxlbmd0aCA+IDUpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dGaWxlcy5zb3J0KGZ1bmN0aW9uKGYxLCBmMikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnMuc3RhdFN5bmMocGF0aC5qb2luKGxvZ3NEaXIsIGYxKSkuYmlydGh0aW1lIDxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZzLnN0YXRTeW5jKHBhdGguam9pbihsb2dzRGlyLCBmMikpLmJpcnRodGltZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBmcy51bmxpbmsocGF0aC5qb2luKGxvZ3NEaXIsIGxvZ0ZpbGVzW2xvZ0ZpbGVzLmxlbmd0aCAtIDFdKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn07XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IF9jcm9pc3NhbnQ7XHJcbiJdfQ==
