'use strict';

const path = require('path');

const q = require('q');

const PrinterStateEnum = require('./constants').PrinterStateEnum; // a little class to help us keep track of print jobs and their associated
// slicing and file-sending stuff...


class PrintJobHelper {
  constructor(printer) {
    const self = this;
    self._printer = printer;
    self._printStarted = false;
    self._cancelToken = undefined;
    self._managingJob = false;
    self._printId = 0;

    self._printer.updateNotifications.on('process_cancelled', function (info) {
      if (self.managingPrintJob() && info.current_process.name === 'PrintProcess') // do not call cancel again
        self._cancelToken.removeListener('cancel', self._cancelPrint, self); // cancel every/anything else

      self.cancel();

      self._cleanUp();
    });
  }

  managingPrintJob() {
    return this._managingJob;
  }

  startPrint(filename, cancelToken) {
    const self = this;
    self._managingJob = true;
    self._cancelToken = cancelToken; // set callback to clean up printprocess on cancel

    self._cancelToken.once('cancel', self._cancelPrint, self); // check if printprocess has been started already (ie. by slicing)


    let startPrintPromise = q();

    if (!self._printStarted) {
      if (self._printer.getStatus().state !== PrinterStateEnum.Idle) throw 'Unable to print to this printer at this time'; // Print args: filename, [ensure_build_plate_clear, transfer_wait]

      startPrintPromise = q(self._printer.invoke('Print', [filename, undefined, true])).then(function () {
        self._printStarted = true;
      });
    }

    return startPrintPromise;
  }

  sendPrintFile(localPath, remotePath, progressCallback, cancelToken) {
    const self = this;
    self._managingJob = true;
    self._cancelToken = cancelToken;
    const filename = path.basename(localPath);
    return self.startPrint(filename, cancelToken).then(function () {
      self._cancelToken.once('cancel', function () {
        self._printer.invoke('cancelPut', [self._printId]);
      });

      return self._printer.invoke('Put', [++self._printId, localPath, remotePath, undefined, progressCallback]);
    }).catch(function (err) {
      if (cancelToken.isCancelled()) {
        const cancelledErr = new Error('Cancelled');
        cancelledErr.type = 'cancel';
        throw cancelledErr;
      } else {
        // cancel printprocess if we somehow fail putting
        // (if put was in fact cancelled, the printprocess should
        // be getting cancelled by the cancelToken...
        self._cancelPrint();

        throw err;
      }
    }).finally(function () {
      // after print has sent (or failed), we no longer care about it
      self._cleanUp();
    });
  }

  _cancelPrint() {
    try {
      this._cancelToken.removeListener('cancel', this._cancelPrint, this);

      return q(this._printer.invoke('Cancel', []));
    } catch (err) {
      console.log('Failed to cancel print');
      if (err.type !== 'UnauthenticatedError') throw err;
    }
  }

  cancel() {
    if (this._cancelToken) this._cancelToken.cancel();
  }

  _cleanUp() {
    // reset states
    this._cancelToken = undefined;
    this._printStarted = false;
    this._managingJob = false;
  }

}

module.exports = PrintJobHelper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByaW50X2pvYl9oZWxwZXIuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJxIiwiUHJpbnRlclN0YXRlRW51bSIsIlByaW50Sm9iSGVscGVyIiwiY29uc3RydWN0b3IiLCJwcmludGVyIiwic2VsZiIsIl9wcmludGVyIiwiX3ByaW50U3RhcnRlZCIsIl9jYW5jZWxUb2tlbiIsInVuZGVmaW5lZCIsIl9tYW5hZ2luZ0pvYiIsIl9wcmludElkIiwidXBkYXRlTm90aWZpY2F0aW9ucyIsIm9uIiwiaW5mbyIsIm1hbmFnaW5nUHJpbnRKb2IiLCJjdXJyZW50X3Byb2Nlc3MiLCJuYW1lIiwicmVtb3ZlTGlzdGVuZXIiLCJfY2FuY2VsUHJpbnQiLCJjYW5jZWwiLCJfY2xlYW5VcCIsInN0YXJ0UHJpbnQiLCJmaWxlbmFtZSIsImNhbmNlbFRva2VuIiwib25jZSIsInN0YXJ0UHJpbnRQcm9taXNlIiwiZ2V0U3RhdHVzIiwic3RhdGUiLCJJZGxlIiwiaW52b2tlIiwidGhlbiIsInNlbmRQcmludEZpbGUiLCJsb2NhbFBhdGgiLCJyZW1vdGVQYXRoIiwicHJvZ3Jlc3NDYWxsYmFjayIsImJhc2VuYW1lIiwiY2F0Y2giLCJlcnIiLCJpc0NhbmNlbGxlZCIsImNhbmNlbGxlZEVyciIsIkVycm9yIiwidHlwZSIsImZpbmFsbHkiLCJjb25zb2xlIiwibG9nIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNQyxDQUFDLEdBQUdELE9BQU8sQ0FBQyxHQUFELENBQWpCOztBQUVBLE1BQU1FLGdCQUFnQixHQUFHRixPQUFPLENBQUMsYUFBRCxDQUFQLENBQXVCRSxnQkFBaEQsQyxDQUVBO0FBQ0E7OztBQUNBLE1BQU1DLGNBQU4sQ0FBcUI7QUFDakJDLEVBQUFBLFdBQVcsQ0FBQ0MsT0FBRCxFQUFVO0FBQ2pCLFVBQU1DLElBQUksR0FBRyxJQUFiO0FB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MUI7O0FBRURDLEVBQUFBLFFBQVEsR0FBRztBQUNQO0FBQ0EsU0FBS2IsWUFBTCxHQUFvQkMsU0FBcEI7QUFDQSxTQUFLRixhQUFMLEdBQXFCLEtBQXJCO0FBQ0EsU0FBS0csWUFBTCxHQUFvQixLQUFwQjtBQUNIOztBQTdHZ0I7O0FBZ0hyQm9DLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjdDLGNBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgcSA9IHJlcXVpcmUoJ3EnKTtcclxuXHJcbmNvbnN0IFByaW50ZXJTdGF0ZUVudW0gPSByZXF1aXJlKCcuL2NvbnN0YW50cycpLlByaW50ZXJTdGF0ZUVudW07XHJcblxyXG4vLyBhIGxpdHRsZSBjbGFzcyB0byBoZWxwIHVzIGtlZXAgdHJhY2sgb2YgcHJpbnQgam9icyBhbmQgdGhlaXIgYXNzb2NpYXRlZFxyXG4vLyBzbGljaW5nIGFuZCBmaWxlLXNlbmRpbmcgc3R1ZmYuLi5cclxuY2xhc3MgUHJpbnRKb2JIZWxwZXIge1xyXG4gICAgY29uc3RydWN0b3IocHJpbnRlcikge1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG5cclxuICAgICAgICBzZWxmLl9wcmludGVyID0gcHJpbnRlcjtcclxuICAgICAgICBzZWxmLl9wcmludFN0YXJ0ZWQgPSBmYWxzZTtcclxuICAgICAgICBzZWxmLl9jYW5jZWxUb2tlbiA9IHVuZGVmaW5lZDtcclxuICAgICAgICBzZWxmLl9tYW5hZ2luZ0pvYiA9IGZhbHNlO1xyXG5cclxuICAgICAgICBzZWxmLl9wcmludElkID0gMDtcclxuXHJcbiAgICAgICAgc2VsZi5fcHJpbnRlci51cGRhdGVOb3RpZmljYXRpb25zLm9uKCdwcm9jZXNzX2NhbmNlbGxlZCcsIGZ1bmN0aW9uKGluZm8pIHtcclxuICAgICAgICAgICAgaWYgKHNlbGYubWFuYWdpbmdQcmludEpvYigpICYmIGluZm8uY3VycmVudF9wcm9jZXNzLm5hbWUgPT09ICdQcmludFByb2Nlc3MnKVxyXG4gICAgICAgICAgICAgICAgLy8gZG8gbm90IGNhbGwgY2FuY2VsIGFnYWluXHJcbiAgICAgICAgICAgICAgICBzZWxmLl9jYW5jZWxUb2tlbi5yZW1vdmVMaXN0ZW5lcignY2FuY2VsJywgc2VsZi5fY2FuY2VsUHJpbnQsIHNlbGYpO1xyXG4gICAgICAgICAgICAvLyBjYW5jZWwgZXZlcnkvYW55dGhpbmcgZWxzZVxyXG4gICAgICAgICAgICBzZWxmLmNhbmNlbCgpO1xyXG4gICAgICAgICAgICBzZWxmLl9jbGVhblVwKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgbWFuYWdpbmdQcmludEpvYigpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fbWFuYWdpbmdKb2I7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhcnRQcmludChmaWxlbmFtZSwgY2FuY2VsVG9rZW4pIHtcclxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcclxuXHJcbiAgICAgICAgc2VsZi5fbWFuYWdpbmdKb2IgPSB0cnVlO1xyXG4gICAgICAgIHNlbGYuX2NhbmNlbFRva2VuID0gY2FuY2VsVG9rZW47XHJcblxyXG4gICAgICAgIC8vIHNldCBjYWxsYmFjayB0byBjbGVhbiB1cCBwcmludHByb2Nlc3Mgb24gY2FuY2VsXHJcbiAgICAgICAgc2VsZi5fY2FuY2VsVG9rZW4ub25jZSgnY2FuY2VsJywgc2VsZi5fY2FuY2VsUHJpbnQsIHNlbGYpO1xyXG5cclxuICAgICAgICAvLyBjaGVjayBpZiBwcmludHByb2Nlc3MgaGFzIGJlZW4gc3RhcnRlZCBhbHJlYWR5IChpZS4gYnkgc2xpY2luZylcclxuICAgICAgICBsZXQgc3RhcnRQcmludFByb21pc2UgPSBxKCk7XHJcbiAgICAgICAgaWYgKCFzZWxmLl9wcmludFN0YXJ0ZWQpIHtcclxuICAgICAgICAgICAgaWYgKHNlbGYuX3ByaW50ZXIuZ2V0U3RhdHVzKCkuc3RhdGUgIT09IFByaW50ZXJTdGF0ZUVudW0uSWRsZSlcclxuICAgICAgICAgICAgICAgIHRocm93ICdVbmFibGUgdG8gcHJpbnQgdG8gdGhpcyBwcmludGVyIGF0IHRoaXMgdGltZSc7XHJcblxyXG4gICAgICAgICAgICAvLyBQcmludCBhcmdzOiBmaWxlbmFtZSwgW2Vuc3VyZV9idWlsZF9wbGF0ZV9jbGVhciwgdHJhbnNmZXJfd2FpdF1cclxuICAgICAgICAgICAgc3RhcnRQcmludFByb21pc2UgPSBxKHNlbGYuX3ByaW50ZXIuaW52b2tlKCdQcmludCcsIFtmaWxlbmFtZSwgdW5kZWZpbmVkLCB0cnVlXSkpLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9wcmludFN0YXJ0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBzdGFydFByaW50UHJvbWlzZTtcclxuICAgIH1cclxuXHJcbiAgICBzZW5kUHJpbnRGaWxlKGxvY2FsUGF0aCwgcmVtb3RlUGF0aCwgcHJvZ3Jlc3NDYWxsYmFjaywgY2FuY2VsVG9rZW4pIHtcclxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcclxuXHJcbiAgICAgICAgc2VsZi5fbWFuYWdpbmdKb2IgPSB0cnVlO1xyXG4gICAgICAgIHNlbGYuX2NhbmNlbFRva2VuID0gY2FuY2VsVG9rZW47XHJcblxyXG4gICAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGF0aC5iYXNlbmFtZShsb2NhbFBhdGgpO1xyXG4gICAgICAgIHJldHVybiBzZWxmXHJcbiAgICAgICAgICAgIC5zdGFydFByaW50KGZpbGVuYW1lLCBjYW5jZWxUb2tlbilcclxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9jYW5jZWxUb2tlbi5vbmNlKCdjYW5jZWwnLCBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZWxmLl9wcmludGVyLmludm9rZSgnY2FuY2VsUHV0JywgW3NlbGYuX3ByaW50SWRdKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9wcmludGVyLmludm9rZSgnUHV0JywgW1xyXG4gICAgICAgICAgICAgICAgICAgICsrc2VsZi5fcHJpbnRJZCxcclxuICAgICAgICAgICAgICAgICAgICBsb2NhbFBhdGgsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVtb3RlUGF0aCxcclxuICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3NDYWxsYmFjayxcclxuICAgICAgICAgICAgICAgIF0pO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2FuY2VsVG9rZW4uaXNDYW5jZWxsZWQoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbmNlbGxlZEVyciA9IG5ldyBFcnJvcignQ2FuY2VsbGVkJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FuY2VsbGVkRXJyLnR5cGUgPSAnY2FuY2VsJztcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBjYW5jZWxsZWRFcnI7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNhbmNlbCBwcmludHByb2Nlc3MgaWYgd2Ugc29tZWhvdyBmYWlsIHB1dHRpbmdcclxuICAgICAgICAgICAgICAgICAgICAvLyAoaWYgcHV0IHdhcyBpbiBmYWN0IGNhbmNlbGxlZCwgdGhlIHByaW50cHJvY2VzcyBzaG91bGRcclxuICAgICAgICAgICAgICAgICAgICAvLyBiZSBnZXR0aW5nIGNhbmNlbGxlZCBieSB0aGUgY2FuY2VsVG9rZW4uLi5cclxuICAgICAgICAgICAgICAgICAgICBzZWxmLl9jYW5jZWxQcmludCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IGVycjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmZpbmFsbHkoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBhZnRlciBwcmludCBoYXMgc2VudCAob3IgZmFpbGVkKSwgd2Ugbm8gbG9uZ2VyIGNhcmUgYWJvdXQgaXRcclxuICAgICAgICAgICAgICAgIHNlbGYuX2NsZWFuVXAoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgX2NhbmNlbFByaW50KCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2NhbmNlbFRva2VuLnJlbW92ZUxpc3RlbmVyKCdjYW5jZWwnLCB0aGlzLl9jYW5jZWxQcmludCwgdGhpcyk7XHJcbiAgICAgICAgICAgIHJldHVybiBxKHRoaXMuX3ByaW50ZXIuaW52b2tlKCdDYW5jZWwnLCBbXSkpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIGNhbmNlbCBwcmludCcpO1xyXG4gICAgICAgICAgICBpZiAoZXJyLnR5cGUgIT09ICdVbmF1dGhlbnRpY2F0ZWRFcnJvcicpIHRocm93IGVycjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2FuY2VsKCkge1xyXG4gICAgICAgIGlmICh0aGlzLl9jYW5jZWxUb2tlbikgdGhpcy5fY2FuY2VsVG9rZW4uY2FuY2VsKCk7XHJcbiAgICB9XHJcblxyXG4gICAgX2NsZWFuVXAoKSB7XHJcbiAgICAgICAgLy8gcmVzZXQgc3RhdGVzXHJcbiAgICAgICAgdGhpcy5fY2FuY2VsVG9rZW4gPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgdGhpcy5fcHJpbnRTdGFydGVkID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5fbWFuYWdpbmdKb2IgPSBmYWxzZTtcclxuICAgIH1cclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBQcmludEpvYkhlbHBlcjtcclxuIl19
