'use strict';

const _ = require('lodash');

const q = require('q');

const ParameterProvider = require('eagle-print/services/providers/parameterProvider');

const EaglePrint = require('eagle-print');

const UNITS = EaglePrint.model.UNITS;
const Gender = EaglePrint.model.Gender;

const PrinterGenderString = require('./constants').PrinterGenderString;

const BotTypeEnum = require('./constants').BotTypeEnum;

const BASE_CAPABILITIES = {
  // Ignored by MakerBot Print. Irrelevant for GrabCAD Print as MakerBot printers are not supported.
  can_print: true,
  can_supply_progress: true,
  can_cancel_build: true,
  can_cancel_queueing: true
};
const printerData = {
  [BotTypeEnum.replicator_5]: {
    pid: 5,
    buildVolume: {
      envelopeSize: {
        x: 25.2 * UNITS.CM.factor,
        y: 19.9 * UNITS.CM.factor,
        z: 14.8 * UNITS.CM.factor
      }
    },
    capabilities: BASE_CAPABILITIES,
    isReleased: true
  },
  [BotTypeEnum.replicator_b]: {
    pid: 11,
    buildVolume: {
      envelopeSize: {
        x: 29.5 * UNITS.CM.factor,
        y: 19.5 * UNITS.CM.factor,
        z: 16.5 * UNITS.CM.factor
      }
    },
    capabilities: BASE_CAPABILITIES,
    isReleased: true
  },
  [BotTypeEnum.mini_8]: {
    pid: 8,
    buildVolume: {
      envelopeSize: {
        x: 10.1 * UNITS.CM.factor,
        y: 12.6 * UNITS.CM.factor,
        z: 12.6 * UNITS.CM.factor
      }
    },
    capabilities: BASE_CAPABILITIES,
    isReleased: true
  },
  [BotTypeEnum.z18_6]: {
    pid: 6,
    buildVolume: {
      envelopeSize: {
        x: 30 * UNITS.CM.factor,
        y: 30.5 * UNITS.CM.factor,
        z: 45.7 * UNITS.CM.factor
      }
    },
    capabilities: BASE_CAPABILITIES,
    isReleased: true
  },
  [BotTypeEnum.fire_e]: {
    pid: 8082,
    buildVolume: {
      envelopeSize: {
        x: 15.24 * UNITS.CM.factor,
        y: 19.05 * UNITS.CM.factor,
        z: 19.685 * UNITS.CM.factor
      }
    },
    capabilities: BASE_CAPABILITIES,
    isReleased: true
  },
  [BotTypeEnum.lava_f]: {
    pid: 8082,
    buildVolume: {
      envelopeSize: {
        x: 15.24 * UNITS.CM.factor,
        y: 19.05 * UNITS.CM.factor,
        z: 19.685 * UNITS.CM.factor
      }
    },
    capabilities: BASE_CAPABILITIES,
    isReleased: true
  },
  [BotTypeEnum.sketch]: {
    buildVolume: {
      envelopeSize: {
        x: 15 * UNITS.CM.factor,
        y: 15 * UNITS.CM.factor,
        z: 15 * UNITS.CM.factor
      }
    },
    capabilities: BASE_CAPABILITIES,
    // change this for public release for now
    isReleased: true
  },
  // generic bot type
  generic: {
    buildVolume: {
      envelopeSize: {
        x: 29.5 * UNITS.CM.factor,
        y: 19.5 * UNITS.CM.factor,
        z: 16.5 * UNITS.CM.factor
      }
    },
    capabilities: BASE_CAPABILITIES,
    isReleased: false
  }
};

class MBGender extends Gender {
  constructor(data, map) {
    super(data, map);
  }

  get botType() {
    return this.get('botType');
  }

  get pid() {
    // sketchy js is sketchy -- it seems for this parseInt, it will parse from the
    // beginning of the passed string up until the first non-hex char, and then
    // convert that to an int:
    // eg. parseInt('dafdgfdg', 16) === parseInt('dafd', 16) === 56061...
    //
    // so we may see something like, if we have a botType 'bot_bonobo', this would
    // end up telling us the pid is 11, which is the same as rep+...
    // we don't make any guarantees of behavior for bots with unknown botTypes
    // though, and currently we only use only use this pid to check compatibility
    // for fw update so it shouldn't be that much of a problem, but here's a warning
    // just in case...
    return this.get('pid') || parseInt(this.botType.split('_')[1], 16);
  }

}

function constructGender(name, botType) {
  const pData = printerData[botType] || printerData['generic'];
  let newGender = new MBGender(_.merge({
    vendor: 'MakerBot',
    name
  }, pData));
  newGender = newGender.set('botType', botType);
  return newGender;
}

class MakerbotParameterProvider extends ParameterProvider {
  constructor() {
    super(); // for now, store all parameters in memory.
    // this initialization of the set of printer models
    // is temporary until we obtain this data from insight

    this._genders = {};

    for (const botType in BotTypeEnum) {
      const name = PrinterGenderString.get(BotTypeEnum[botType]);
      this._genders[name] = constructGender(name, BotTypeEnum[botType]);
    }
  }

  setLogger(logger) {
    this._logger = logger;
  }

  accept(vendor) {
    return vendor.toLowerCase() === 'makerbot';
  }

  getGender(vendor, genderName, botType) {
    let genderObj = this._genders[genderName];

    if (!genderObj) {
      this._logger.warn(`Using generic gender for printer ${genderName}; ${botType}`);

      genderObj = constructGender('Printer', botType);
    }

    return q(genderObj);
  }

  getVendors() {
    const vendors = {};
    vendors['MakerBot'] = {
      displayName: 'MakerBot',
      genders: this._genders
    };
    return vendors;
  }

  getParamsByBotType(botType) {
    return printerData[botType];
  }

}

module.exports = MakerbotParameterProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhcmFtZXRlcnMuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJxIiwiUGFyYW1ldGVyUHJvdmlkZXIiLCJFYWdsZVByaW50IiwiVU5JVFMiLCJtb2RlbCIsIkdlbmRlciIsIlByaW50ZXJHZW5kZXJTdHJpbmciLCJCb3RUeXBlRW51bSIsIkJBU0VfQ0FQQUJJTElUSUVTIiwiY2FuX3ByaW50IiwiY2FuX3N1cHBseV9wcm9ncmVzcyIsImNhbl9jYW5jZWxfYnVpbGQiLCJjYW5fY2FuY2VsX3F1ZXVlaW5nIiwicHJpbnRlckRhdGEiLCJyZXBsaWNhdG9yXzUiLCJwaWQiLCJidWlsZFZvbHVtZSIsImVudmVsb3BlU2l6ZSIsIngiLCJDTSIsImZhY3RvciIsInkiLCJ6IiwiY2FwYWJpbGl0aWVzIiwiaXNSZWxlYXNlZCIsInJlcGxpY2F0b3JfYiIsIm1pbmlfOCIsInoxOF82IiwiZmlyZV9lIiwibGF2YV9mIiwic2tldGNoIiwiZ2VuZXJpYyIsIk1CR2VuZGVyIiwiY29uc3RydWN0b3IiLCJkYXRhIiwibWFwIiwiYm90VHlwZSIsImdldCIsInBhcnNlSW50Iiwic3BsaXQiLCJjb25zdHJ1Y3RHZW5kZXIiLCJuYW1lIiwicERhdGEiLCJuZXdHZW5kZXIiLCJtZXJnZSIsInZlbmRvciIsInNldCIsIk1ha2VyYm90UGFyYW1ldGVyUHJvdmlkZXIiLCJfZ2VuZGVycyIsInNldExvZ2dlciIsImxvZ2dlciIsIl9sb2dnZXIiLCJhY2NlcHQiLCJ0b0xvd2VyQ2FzZSIsImdldEdlbmRlciIsImdlbmRlck5hbWUiLCJnZW5kZXJPYmoiLCJ3YXJuIiwiZ2V0VmVuZG9ycyIsInZlbmRvcnMiLCJkaXNwbGF5TmFtZSIsImdlbmRlcnMiLCJnZXRQYXJhbXNCeUJvdFR5cGUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxNQUFNQSxDQUFDLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQWpCOztBQUNBLE1BQU1DLENBQUMsR0FBR0QsT0FBTyxD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QUVEQyxFQUFBQSxTQUFTLENBQUNULE1BQUQsRUFBU1UsVUFBVCxFQUFxQm5CLE9BQXJCLEVBQThCO0FBQ25DLFFBQUlvQixTQUFTLEdBQUcsS0FBS1IsUUFBTCxDQUFjTyxVQUFkLENBQWhCOztBQUNBLFFBQUksQ0FBQ0MsU0FBTCxFQUFnQjtBQUNaLFdBQUtMLE9BQUwsQ0FBYU0sSUFBYixDQUFtQixvQ0FBbUNGLFVBQVcsS0FBSW5CLE9BQVEsRUFBN0U7O0FBQ0FvQixNQUFBQSxTQUFTLEdBQUdoQixlQUFlLENBQUMsU0FBRCxFQUFZSixPQUFaLENBQTNCO0FBQ0g7O0FBQ0QsV0FBT3BDLENBQUMsQ0FBQ3dELFNBQUQsQ0FBUjtBQUNIOztBQUVERSxFQUFBQSxVQUFVLEdBQUc7QUFDVCxVQUFNQyxPQUFPLEdBQUcsRUFBaEI7QUFDQUEsSUFBQUEsT0FBTyxDQUFDLFVBQUQsQ0FBUCxHQUFzQjtBQUNsQkMsTUFBQUEsV0FBVyxFQUFFLFVBREs7QUFFbEJDLE1BQUFBLE9BQU8sRUFBRSxLQUFLYjtBQUZJLEtBQXRCO0FBSUEsV0FBT1csT0FBUDtBQUNIOztBQUVERyxFQUFBQSxrQkFBa0IsQ0FBQzFCLE9BQUQsRUFBVTtBQUN4QixXQUFPdkIsV0FBVyxDQUFDdUIsT0FBRCxDQUFsQjtBQUNIOztBQTNDcUQ7O0FBOEMxRDJCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQmpCLHlCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcclxuY29uc3QgcSA9IHJlcXVpcmUoJ3EnKTtcclxuY29uc3QgUGFyYW1ldGVyUHJvdmlkZXIgPSByZXF1aXJlKCdlYWdsZS1wcmludC9zZXJ2aWNlcy9wcm92aWRlcnMvcGFyYW1ldGVyUHJvdmlkZXInKTtcclxuY29uc3QgRWFnbGVQcmludCA9IHJlcXVpcmUoJ2VhZ2xlLXByaW50Jyk7XHJcblxyXG5jb25zdCBVTklUUyA9IEVhZ2xlUHJpbnQubW9kZWwuVU5JVFM7XHJcbmNvbnN0IEdlbmRlciA9IEVhZ2xlUHJpbnQubW9kZWwuR2VuZGVyO1xyXG5jb25zdCBQcmludGVyR2VuZGVyU3RyaW5nID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKS5QcmludGVyR2VuZGVyU3RyaW5nO1xyXG5jb25zdCBCb3RUeXBlRW51bSA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJykuQm90VHlwZUVudW07XHJcblxyXG5jb25zdCBCQVNFX0NBUEFCSUxJVElFUyA9IHtcclxuICAgIC8vIElnbm9yZWQgYnkgTWFrZXJCb3QgUHJpbnQuIElycmVsZXZhbnQgZm9yIEdyYWJDQUQgUHJpbnQgYXMgTWFrZXJCb3QgcHJpbnRlcnMgYXJlIG5vdCBzdXBwb3J0ZWQuXHJcbiAgICBjYW5fcHJpbnQ6IHRydWUsXHJcbiAgICBjYW5fc3VwcGx5X3Byb2dyZXNzOiB0cnVlLFxyXG4gICAgY2FuX2NhbmNlbF9idWlsZDogdHJ1ZSxcclxuICAgIGNhbl9jYW5jZWxfcXVldWVpbmc6IHRydWUsXHJcbn07XHJcblxyXG5jb25zdCBwcmludGVyRGF0YSA9IHtcclxuICAgIFtCb3RUeXBlRW51bS5yZXBsaWNhdG9yXzVdOiB7XHJcbiAgICAgICAgcGlkOiA1LFxyXG4gICAgICAgIGJ1aWxkVm9sdW1lOiB7XHJcbiAgICAgICAgICAgIGVudmVsb3BlU2l6ZToge1xyXG4gICAgICAgICAgICAgICAgeDogMjUuMiAqIFVOSVRTLkNNLmZhY3RvcixcclxuICAgICAgICAgICAgICAgIHk6IDE5LjkgKiBVTklUUy5DTS5mYWN0b3IsXHJcbiAgICAgICAgICAgICAgICB6OiAxNC44ICogVU5JVFMuQ00uZmFjdG9yLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY2FwYWJpbGl0aWVzOiBCQVNFX0NBUEFCSUxJVElFUyxcclxuICAgICAgICBpc1JlbGVhc2VkOiB0cnVlLFxyXG4gICAgfSxcclxuICAgIFtCb3RUeXBlRW51bS5yZXBsaWNhdG9yX2JdOiB7XHJcbiAgICAgICAgcGlkOiAxMSxcclxuICAgICAgICBidWlsZFZvbHVtZToge1xyXG4gICAgICAgICAgICBlbnZlbG9wZVNpemU6IHtcclxuICAgICAgICAgICAgICAgIHg6IDI5LjUgKiBVTklUUy5DTS5mYWN0b3IsXHJcbiAgICAgICAgICAgICAgICB5OiAxOS41ICogVU5JVFMuQ00uZmFjdG9yLFxyXG4gICAgICAgICAgICAgICAgejogMTYuNSAqIFVOSVRTLkNNLmZhY3RvcixcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGNhcGFiaWxpdGllczogQkFTRV9DQVBBQklMSVRJRVMsXHJcbiAgICAgICAgaXNSZWxlYXNlZDogdHJ1ZSxcclxuICAgIH0sXHJcbiAgICBbQm90VHlwZUVudW0ubWluaV84XToge1xyXG4gICAgICAgIHBpZDogOCxcclxuICAgICAgICBidWlsZFZvbHVtZToge1xyXG4gICAgICAgICAgICBlbnZlbG9wZVNpemU6IHtcclxuICAgICAgICAgICAgICAgIHg6IDEwLjEgKiBVTklUUy5DTS5mYWN0b3IsXHJcbiAgICAgICAgICAgICAgICB5OiAxMi42ICogVU5JVFMuQ00uZmFjdG9yLFxyXG4gICAgICAgICAgICAgICAgejogMTIuNiAqIFVOSVRTLkNNLmZhY3RvcixcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGNhcGFiaWxpdGllczogQkFTRV9DQVBBQklMSVRJRVMsXHJcbiAgICAgICAgaXNSZWxlYXNlZDogdHJ1ZSxcclxuICAgIH0sXHJcbiAgICBbQm90VHlwZUVudW0uejE4XzZdOiB7XHJcbiAgICAgICAgcGlkOiA2LFxyXG4gICAgICAgIGJ1aWxkVm9sdW1lOiB7XHJcbiAgICAgICAgICAgIGVudmVsb3BlU2l6ZToge1xyXG4gICAgICAgICAgICAgICAgeDogMzAgKiBVTklUUy5DTS5mYWN0b3IsXHJcbiAgICAgICAgICAgICAgICB5OiAzMC41ICogVU5JVFMuQ00uZmFjdG9yLFxyXG4gICAgICAgICAgICAgICAgejogNDUuNyAqIFVOSVRTLkNNLmZhY3RvcixcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGNhcGFiaWxpdGllczogQkFTRV9DQVBBQklMSVRJRVMsXHJcbiAgICAgICAgaXNSZWxlYXNlZDogdHJ1ZSxcclxuICAgIH0sXHJcbiAgICBbQm90VHlwZUVudW0uZmlyZV9lXToge1xyXG4gICAgICAgIHBpZDogODA4MixcclxuICAgICAgICBidWlsZFZvbHVtZToge1xyXG4gICAgICAgICAgICBlbnZlbG9wZVNpemU6IHtcclxuICAgICAgICAgICAgICAgIHg6IDE1LjI0ICogVU5JVFMuQ00uZmFjdG9yLFxyXG4gICAgICAgICAgICAgICAgeTogMTkuMDUgKiBVTklUUy5DTS5mYWN0b3IsXHJcbiAgICAgICAgICAgICAgICB6OiAxOS42ODUgKiBVTklUUy5DTS5mYWN0b3IsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgICBjYXBhYmlsaXRpZXM6IEJBU0VfQ0FQQUJJTElUSUVTLFxyXG4gICAgICAgIGlzUmVsZWFzZWQ6IHRydWUsXHJcbiAgICB9LFxyXG4gICAgW0JvdFR5cGVFbnVtLmxhdmFfZl06IHtcclxuICAgICAgICBwaWQ6IDgwODIsXHJcbiAgICAgICAgYnVpbGRWb2x1bWU6IHtcclxuICAgICAgICAgICAgZW52ZWxvcGVTaXplOiB7XHJcbiAgICAgICAgICAgICAgICB4OiAxNS4yNCAqIFVOSVRTLkNNLmZhY3RvcixcclxuICAgICAgICAgICAgICAgIHk6IDE5LjA1ICogVU5JVFMuQ00uZmFjdG9yLFxyXG4gICAgICAgICAgICAgICAgejogMTkuNjg1ICogVU5JVFMuQ00uZmFjdG9yLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY2FwYWJpbGl0aWVzOiBCQVNFX0NBUEFCSUxJVElFUyxcclxuICAgICAgICBpc1JlbGVhc2VkOiB0cnVlLFxyXG4gICAgfSxcclxuICAgIFtCb3RUeXBlRW51bS5za2V0Y2hdOiB7XHJcbiAgICAgICAgYnVpbGRWb2x1bWU6IHtcclxuICAgICAgICAgICAgZW52ZWxvcGVTaXplOiB7XHJcbiAgICAgICAgICAgICAgICB4OiAxNSAqIFVOSVRTLkNNLmZhY3RvcixcclxuICAgICAgICAgICAgICAgIHk6IDE1ICogVU5JVFMuQ00uZmFjdG9yLFxyXG4gICAgICAgICAgICAgICAgejogMTUgKiBVTklUUy5DTS5mYWN0b3IsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgICBjYXBhYmlsaXRpZXM6IEJBU0VfQ0FQQUJJTElUSUVTLFxyXG4gICAgICAgIC8vIGNoYW5nZSB0aGlzIGZvciBwdWJsaWMgcmVsZWFzZSBmb3Igbm93XHJcbiAgICAgICAgaXNSZWxlYXNlZDogdHJ1ZSxcclxuICAgIH0sXHJcbiAgICAvLyBnZW5lcmljIGJvdCB0eXBlXHJcbiAgICBnZW5lcmljOiB7XHJcbiAgICAgICAgYnVpbGRWb2x1bWU6IHtcclxuICAgICAgICAgICAgZW52ZWxvcGVTaXplOiB7XHJcbiAgICAgICAgICAgICAgICB4OiAyOS41ICogVU5JVFMuQ00uZmFjdG9yLFxyXG4gICAgICAgICAgICAgICAgeTogMTkuNSAqIFVOSVRTLkNNLmZhY3RvcixcclxuICAgICAgICAgICAgICAgIHo6IDE2LjUgKiBVTklUUy5DTS5mYWN0b3IsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgICBjYXBhYmlsaXRpZXM6IEJBU0VfQ0FQQUJJTElUSUVTLFxyXG4gICAgICAgIGlzUmVsZWFzZWQ6IGZhbHNlLFxyXG4gICAgfSxcclxufTtcclxuXHJcbmNsYXNzIE1CR2VuZGVyIGV4dGVuZHMgR2VuZGVyIHtcclxuICAgIGNvbnN0cnVjdG9yKGRhdGEsIG1hcCkge1xyXG4gICAgICAgIHN1cGVyKGRhdGEsIG1hcCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGJvdFR5cGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KCdib3RUeXBlJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHBpZCgpIHtcclxuICAgICAgICAvLyBza2V0Y2h5IGpzIGlzIHNrZXRjaHkgLS0gaXQgc2VlbXMgZm9yIHRoaXMgcGFyc2VJbnQsIGl0IHdpbGwgcGFyc2UgZnJvbSB0aGVcclxuICAgICAgICAvLyBiZWdpbm5pbmcgb2YgdGhlIHBhc3NlZCBzdHJpbmcgdXAgdW50aWwgdGhlIGZpcnN0IG5vbi1oZXggY2hhciwgYW5kIHRoZW5cclxuICAgICAgICAvLyBjb252ZXJ0IHRoYXQgdG8gYW4gaW50OlxyXG4gICAgICAgIC8vIGVnLiBwYXJzZUludCgnZGFmZGdmZGcnLCAxNikgPT09IHBhcnNlSW50KCdkYWZkJywgMTYpID09PSA1NjA2MS4uLlxyXG4gICAgICAgIC8vXHJcbiAgICAgICAgLy8gc28gd2UgbWF5IHNlZSBzb21ldGhpbmcgbGlrZSwgaWYgd2UgaGF2ZSBhIGJvdFR5cGUgJ2JvdF9ib25vYm8nLCB0aGlzIHdvdWxkXHJcbiAgICAgICAgLy8gZW5kIHVwIHRlbGxpbmcgdXMgdGhlIHBpZCBpcyAxMSwgd2hpY2ggaXMgdGhlIHNhbWUgYXMgcmVwKy4uLlxyXG4gICAgICAgIC8vIHdlIGRvbid0IG1ha2UgYW55IGd1YXJhbnRlZXMgb2YgYmVoYXZpb3IgZm9yIGJvdHMgd2l0aCB1bmtub3duIGJvdFR5cGVzXHJcbiAgICAgICAgLy8gdGhvdWdoLCBhbmQgY3VycmVudGx5IHdlIG9ubHkgdXNlIG9ubHkgdXNlIHRoaXMgcGlkIHRvIGNoZWNrIGNvbXBhdGliaWxpdHlcclxuICAgICAgICAvLyBmb3IgZncgdXBkYXRlIHNvIGl0IHNob3VsZG4ndCBiZSB0aGF0IG11Y2ggb2YgYSBwcm9ibGVtLCBidXQgaGVyZSdzIGEgd2FybmluZ1xyXG4gICAgICAgIC8vIGp1c3QgaW4gY2FzZS4uLlxyXG4gICAgICAgIHJldHVybiB0aGlzLmdldCgncGlkJykgfHwgcGFyc2VJbnQodGhpcy5ib3RUeXBlLnNwbGl0KCdfJylbMV0sIDE2KTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gY29uc3RydWN0R2VuZGVyKG5hbWUsIGJvdFR5cGUpIHtcclxuICAgIGNvbnN0IHBEYXRhID0gcHJpbnRlckRhdGFbYm90VHlwZV0gfHwgcHJpbnRlckRhdGFbJ2dlbmVyaWMnXTtcclxuICAgIGxldCBuZXdHZW5kZXIgPSBuZXcgTUJHZW5kZXIoXy5tZXJnZSh7IHZlbmRvcjogJ01ha2VyQm90JywgbmFtZSB9LCBwRGF0YSkpO1xyXG4gICAgbmV3R2VuZGVyID0gbmV3R2VuZGVyLnNldCgnYm90VHlwZScsIGJvdFR5cGUpO1xyXG5cclxuICAgIHJldHVybiBuZXdHZW5kZXI7XHJcbn1cclxuXHJcbmNsYXNzIE1ha2VyYm90UGFyYW1ldGVyUHJvdmlkZXIgZXh0ZW5kcyBQYXJhbWV0ZXJQcm92aWRlciB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIC8vIGZvciBub3csIHN0b3JlIGFsbCBwYXJhbWV0ZXJzIGluIG1lbW9yeS5cclxuICAgICAgICAvLyB0aGlzIGluaXRpYWxpemF0aW9uIG9mIHRoZSBzZXQgb2YgcHJpbnRlciBtb2RlbHNcclxuICAgICAgICAvLyBpcyB0ZW1wb3JhcnkgdW50aWwgd2Ugb2J0YWluIHRoaXMgZGF0YSBmcm9tIGluc2lnaHRcclxuXHJcbiAgICAgICAgdGhpcy5fZ2VuZGVycyA9IHt9O1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGJvdFR5cGUgaW4gQm90VHlwZUVudW0pIHtcclxuICAgICAgICAgICAgY29uc3QgbmFtZSA9IFByaW50ZXJHZW5kZXJTdHJpbmcuZ2V0KEJvdFR5cGVFbnVtW2JvdFR5cGVdKTtcclxuICAgICAgICAgICAgdGhpcy5fZ2VuZGVyc1tuYW1lXSA9IGNvbnN0cnVjdEdlbmRlcihuYW1lLCBCb3RUeXBlRW51bVtib3RUeXBlXSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNldExvZ2dlcihsb2dnZXIpIHtcclxuICAgICAgICB0aGlzLl9sb2dnZXIgPSBsb2dnZXI7XHJcbiAgICB9XHJcblxyXG4gICAgYWNjZXB0KHZlbmRvcikge1xyXG4gICAgICAgIHJldHVybiB2ZW5kb3IudG9Mb3dlckNhc2UoKSA9PT0gJ21ha2VyYm90JztcclxuICAgIH1cclxuXHJcbiAgICBnZXRHZW5kZXIodmVuZG9yLCBnZW5kZXJOYW1lLCBib3RUeXBlKSB7XHJcbiAgICAgICAgbGV0IGdlbmRlck9iaiA9IHRoaXMuX2dlbmRlcnNbZ2VuZGVyTmFtZV07XHJcbiAgICAgICAgaWYgKCFnZW5kZXJPYmopIHtcclxuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLndhcm4oYFVzaW5nIGdlbmVyaWMgZ2VuZGVyIGZvciBwcmludGVyICR7Z2VuZGVyTmFtZX07ICR7Ym90VHlwZX1gKTtcclxuICAgICAgICAgICAgZ2VuZGVyT2JqID0gY29uc3RydWN0R2VuZGVyKCdQcmludGVyJywgYm90VHlwZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBxKGdlbmRlck9iaik7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VmVuZG9ycygpIHtcclxuICAgICAgICBjb25zdCB2ZW5kb3JzID0ge307XHJcbiAgICAgICAgdmVuZG9yc1snTWFrZXJCb3QnXSA9IHtcclxuICAgICAgICAgICAgZGlzcGxheU5hbWU6ICdNYWtlckJvdCcsXHJcbiAgICAgICAgICAgIGdlbmRlcnM6IHRoaXMuX2dlbmRlcnMsXHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4gdmVuZG9ycztcclxuICAgIH1cclxuXHJcbiAgICBnZXRQYXJhbXNCeUJvdFR5cGUoYm90VHlwZSkge1xyXG4gICAgICAgIHJldHVybiBwcmludGVyRGF0YVtib3RUeXBlXTtcclxuICAgIH1cclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBNYWtlcmJvdFBhcmFtZXRlclByb3ZpZGVyO1xyXG4iXX0=
