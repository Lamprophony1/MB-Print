"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.compareConnType = exports.parseConnType = void 0;

const {
  PrinterConnTypeEnum
} = require('../constants');

const PRIORITY = [PrinterConnTypeEnum.USB, PrinterConnTypeEnum.NETWORK, PrinterConnTypeEnum.REFLECTOR]; // Connectivity string format for USB & Network connected printers
// ie. USB => tcp:127.0.0.1:45433
// ie. NETWORK => tcp:10.1.10.100:9999

const ipRegex = /^(tcp:)(?:[0-9]{1,3}\.){3}[0-9]{1,3}(:[0-9]{1,6})$/;
const localhost = '127.0.0.1';
const defaultPort = '9999';

const parseConnType = printerInfo => {
  let connType = PrinterConnTypeEnum.REFLECTOR;

  if (ipRegex.test(printerInfo.address)) {
    const [ipAddr, port] = printerInfo.address.split(':').slice(1);

    if (ipAddr === localhost && port !== defaultPort) {
      connType = PrinterConnTypeEnum.USB;
    } else {
      connType = PrinterConnTypeEnum.NETWORK;
    }
  }

  return connType;
};

exports.parseConnType = parseConnType;

const compareConnType = (cachedPrinter, printerInfo) => {
  /**
   * Compare the cached printer's connType w/ printerInfo's connType
   * based on the order of PRIORITY array.
   *
   *  1       2          3
   * USB > NETWORK > REFLECTOR
   *
   * If cached printer's connType greater than printerInfo, return 1
   * If printerInfo's connType greater than cached printer, return -1
   * If connTypes are the same, return 0.
   **/
  if (!cachedPrinter) return -1;
  const cachedConnTypeIndex = PRIORITY.findIndex(connType => connType === cachedPrinter.getConnectionType());
  const printerInfoConnTypeIndex = PRIORITY.findIndex(connType => connType === printerInfo.connType);

  if (cachedConnTypeIndex < printerInfoConnTypeIndex) {
    return 1;
  } else if (cachedConnTypeIndex > printerInfoConnTypeIndex) {
    return -1;
  } else {
    // With same connType, check if ip addresses match. If it matches,
    // use cachedPrinter, otherwise, use printerInfo to create a new
    // printer...
    const cachedIpAddr = cachedPrinter._printerInfo.address;
    const printerInfoIpAddr = printerInfo.address;
    return cachedIpAddr === printerInfoIpAddr ? 1 : 0;
  }
};

exports.compareConnType = compareConnType;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByaW50ZXJDb25uZWN0aW9uVXRpbC5qcyJdLCJuYW1lcyI6WyJQcmludGVyQ29ublR5cGVFbnVtIiwicmVxdWlyZSIsIlBSSU9SSVRZIiwiVVNCIiwiTkVUV09SSyIsIlJFRkxFQ1RPUiIsImlwUmVnZXgiLCJsb2NhbGhvc3QiLCJkZWZhdWx0UG9ydCIsInBhcnNlQ29ublR5cGUiLCJwcmludGVySW5mbyIsImNvbm5UeXBlIiwidGVzdCIsImFkZHJlc3MiLCJpcEFkZHIiLCJwb3J0Iiwic3BsaXQiLCJzbGljZSIsImNvbXBhcmVDb25uVHlwZSIsImNhY2hlZFByaW50ZXIiLCJjYWNoZWRDb25uVHlwZUluZGV4IiwiZmluZEluZGV4IiwiZ2V0Q29ubmVjdGlvblR5cGUiLCJwcmludGVySW5mb0Nvbm5UeXBlSW5kZXgiLCJjYWNoZWRJcEFkZHIiLCJfcHJpbnRlckluZm8iLCJwcmludGVySW5mb0lwQWRkciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUEwQkMsT0FBTyxDQUFDLGNBQUQsQ0FBdkM7O0FBQ0EsTUFBTUMsUUFBUSxHQUFHLENBQUNGLG1CQUFtQixDQUFDRyxHQUFyQixFQUEwQkgsbUJBQW1CLENBQUNJLE9BQTlDLEVBQXVESixtQkFBbUIsQ0FBQ0ssU0FBM0UsQ0FBakIsQyxDQUVBO0FBQ0E7QUFDQTs7QUFDQSxNQUFNQyxPQUFPLEdBQUcsb0RBQWhCO0FBQ0EsTUFBTUMsU0FBUyxHQUFHLFdBQWxCO0FBQ0EsTUFBTUMsV0FBVyxHQUFHLE1BQXBCOztBQUVBLE1BQU1DLGFBQWEsR0FBR0MsV0FBVyxJQUFJO0FBQ2pDLE1BQUlDLFFBQVEsR0FBR1gsbUJBQW1CLENBQUNLLFNBQW5DOztBQUVBLE1BQUlDLE9BQU8sQ0FBQ00sSUFBUixDQUFhRixXQUFXLENBQUNHLE9BQXpCLENBQUosRUFBdUM7QUFDbkMsVUFBTSxDQUFDQyxNQUFELEVBQVNDLElBQVQsSUFBaUJMLFdBQVcsQ0FBQ0csT0FBWixDQUFvQkcsS0FBcEIsQ0FBMEIsR0FBMUIsRUFBK0JDLEtBQS9CLENBQXFDLENBQXJDLENBQXZCOztBQUNBLFFBQUlILE1BQU0sS0FBS1AsU0FBWCxJQUF3QlEsSUFBSSxLQUFLUCxXQUFyQyxFQUFrRDtBQUM5Q0csTUFBQUEsUUFBUSxHQUFHWCxtQkFBbUIsQ0FBQ0csR0FBL0I7QUFDSCxLQUZELE1BRU87QUFDSFEsTUFBQUEsUUFBUSxHQUFHWCxtQkFBbUIsQ0FBQ0ksT0FBL0I7QUFDSDtBQUNKOztBQUVELFNBQU9PLFFBQVA7QUFDSCxDQWJEOzs7O0FBZUEsTUFBTU8sZUFBZSxHQUFHLENBQUNDLGFBQUQsRUFBZ0JULFdBQWhCLEtBQWdDO0FBQ3BEO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDSSxNQUFJLENBQUNTLGFBQUwsRUFBb0IsT0FBTyxDQUFDLENBQVI7QUFFcEIsUUFBTUMsbUJBQW1CLEdBQUdsQixRQUFRLENBQUNtQixTQUFULENBQW1CVixRQUFRLElBQUlBLFFBQVEsS0FBS1EsYUFBYSxDQUFDRyxpQkFBZCxFQUE1QyxDQUE1QjtBQUNBLFFBQU1DLHdCQUF3QixHQUFHckIsUUFBUSxDQUFDbUIsU0FBVCxDQUFtQlYsUUFBUSxJQUFJQSxRQUFRLEtBQUtELFdBQVcsQ0FBQ0MsUUFBeEQsQ0FBakM7O0FBRUEsTUFBSVMsbUJBQW1CLEdBQUdHLHdCQUExQixFQUFvRDtBQUNoRCxXQUFPLENBQVA7QUFDSCxHQUZELE1BRU8sSUFBSUgsbUJBQW1CLEdBQUdHLHdCQUExQixFQUFvRDtBQUN2RCxXQUFPLENBQUMsQ0FBUjtBQUNILEdBRk0sTUFFQTtBQUNIO0FBQ0E7QUFDQTtBQUNBLFVBQU1DLFlBQVksR0FBR0wsYUFBYSxDQUFDTSxZQUFkLENBQTJCWixPQUFoRDtBQUNBLFVBQU1hLGlCQUFpQixHQUFHaEIsV0FBVyxDQUFDRyxPQUF0QztBQUVBLFdBQU9XLFlBQVksS0FBS0UsaUJBQWpCLEdBQXFDLENBQXJDLEdBQXlDLENBQWhEO0FBQ0g7QUFDSixDQTlCRCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgUHJpbnRlckNvbm5UeXBlRW51bSB9ID0gcmVxdWlyZSgnLi4vY29uc3RhbnRzJyk7XHJcbmNvbnN0IFBSSU9SSVRZID0gW1ByaW50ZXJDb25uVHlwZUVudW0uVVNCLCBQcmludGVyQ29ublR5cGVFbnVtLk5FVFdPUkssIFByaW50ZXJDb25uVHlwZUVudW0uUkVGTEVDVE9SXTtcclxuXHJcbi8vIENvbm5lY3Rpdml0eSBzdHJpbmcgZm9ybWF0IGZvciBVU0IgJiBOZXR3b3JrIGNvbm5lY3RlZCBwcmludGVyc1xyXG4vLyBpZS4gVVNCID0+IHRjcDoxMjcuMC4wLjE6NDU0MzNcclxuLy8gaWUuIE5FVFdPUksgPT4gdGNwOjEwLjEuMTAuMTAwOjk5OTlcclxuY29uc3QgaXBSZWdleCA9IC9eKHRjcDopKD86WzAtOV17MSwzfVxcLil7M31bMC05XXsxLDN9KDpbMC05XXsxLDZ9KSQvO1xyXG5jb25zdCBsb2NhbGhvc3QgPSAnMTI3LjAuMC4xJztcclxuY29uc3QgZGVmYXVsdFBvcnQgPSAnOTk5OSc7XHJcblxyXG5jb25zdCBwYXJzZUNvbm5UeXBlID0gcHJpbnRlckluZm8gPT4ge1xyXG4gICAgbGV0IGNvbm5UeXBlID0gUHJpbnRlckNvbm5UeXBlRW51bS5SRUZMRUNUT1I7XHJcblxyXG4gICAgaWYgKGlwUmVnZXgudGVzdChwcmludGVySW5mby5hZGRyZXNzKSkge1xyXG4gICAgICAgIGNvbnN0IFtpcEFkZHIsIHBvcnRdID0gcHJpbnRlckluZm8uYWRkcmVzcy5zcGxpdCgnOicpLnNsaWNlKDEpO1xyXG4gICAgICAgIGlmIChpcEFkZHIgPT09IGxvY2FsaG9zdCAmJiBwb3J0ICE9PSBkZWZhdWx0UG9ydCkge1xyXG4gICAgICAgICAgICBjb25uVHlwZSA9IFByaW50ZXJDb25uVHlwZUVudW0uVVNCO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbm5UeXBlID0gUHJpbnRlckNvbm5UeXBlRW51bS5ORVRXT1JLO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gY29ublR5cGU7XHJcbn07XHJcblxyXG5jb25zdCBjb21wYXJlQ29ublR5cGUgPSAoY2FjaGVkUHJpbnRlciwgcHJpbnRlckluZm8pID0+IHtcclxuICAgIC8qKlxyXG4gICAgICogQ29tcGFyZSB0aGUgY2FjaGVkIHByaW50ZXIncyBjb25uVHlwZSB3LyBwcmludGVySW5mbydzIGNvbm5UeXBlXHJcbiAgICAgKiBiYXNlZCBvbiB0aGUgb3JkZXIgb2YgUFJJT1JJVFkgYXJyYXkuXHJcbiAgICAgKlxyXG4gICAgICogIDEgICAgICAgMiAgICAgICAgICAzXHJcbiAgICAgKiBVU0IgPiBORVRXT1JLID4gUkVGTEVDVE9SXHJcbiAgICAgKlxyXG4gICAgICogSWYgY2FjaGVkIHByaW50ZXIncyBjb25uVHlwZSBncmVhdGVyIHRoYW4gcHJpbnRlckluZm8sIHJldHVybiAxXHJcbiAgICAgKiBJZiBwcmludGVySW5mbydzIGNvbm5UeXBlIGdyZWF0ZXIgdGhhbiBjYWNoZWQgcHJpbnRlciwgcmV0dXJuIC0xXHJcbiAgICAgKiBJZiBjb25uVHlwZXMgYXJlIHRoZSBzYW1lLCByZXR1cm4gMC5cclxuICAgICAqKi9cclxuICAgIGlmICghY2FjaGVkUHJpbnRlcikgcmV0dXJuIC0xO1xyXG5cclxuICAgIGNvbnN0IGNhY2hlZENvbm5UeXBlSW5kZXggPSBQUklPUklUWS5maW5kSW5kZXgoY29ublR5cGUgPT4gY29ublR5cGUgPT09IGNhY2hlZFByaW50ZXIuZ2V0Q29ubmVjdGlvblR5cGUoKSk7XHJcbiAgICBjb25zdCBwcmludGVySW5mb0Nvbm5UeXBlSW5kZXggPSBQUklPUklUWS5maW5kSW5kZXgoY29ublR5cGUgPT4gY29ublR5cGUgPT09IHByaW50ZXJJbmZvLmNvbm5UeXBlKTtcclxuXHJcbiAgICBpZiAoY2FjaGVkQ29ublR5cGVJbmRleCA8IHByaW50ZXJJbmZvQ29ublR5cGVJbmRleCkge1xyXG4gICAgICAgIHJldHVybiAxO1xyXG4gICAgfSBlbHNlIGlmIChjYWNoZWRDb25uVHlwZUluZGV4ID4gcHJpbnRlckluZm9Db25uVHlwZUluZGV4KSB7XHJcbiAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBXaXRoIHNhbWUgY29ublR5cGUsIGNoZWNrIGlmIGlwIGFkZHJlc3NlcyBtYXRjaC4gSWYgaXQgbWF0Y2hlcyxcclxuICAgICAgICAvLyB1c2UgY2FjaGVkUHJpbnRlciwgb3RoZXJ3aXNlLCB1c2UgcHJpbnRlckluZm8gdG8gY3JlYXRlIGEgbmV3XHJcbiAgICAgICAgLy8gcHJpbnRlci4uLlxyXG4gICAgICAgIGNvbnN0IGNhY2hlZElwQWRkciA9IGNhY2hlZFByaW50ZXIuX3ByaW50ZXJJbmZvLmFkZHJlc3M7XHJcbiAgICAgICAgY29uc3QgcHJpbnRlckluZm9JcEFkZHIgPSBwcmludGVySW5mby5hZGRyZXNzO1xyXG5cclxuICAgICAgICByZXR1cm4gY2FjaGVkSXBBZGRyID09PSBwcmludGVySW5mb0lwQWRkciA/IDEgOiAwO1xyXG4gICAgfVxyXG59O1xyXG5cclxuZXhwb3J0IHsgcGFyc2VDb25uVHlwZSwgY29tcGFyZUNvbm5UeXBlIH07XHJcbiJdfQ==
