'use strict';

const q = require('q');

const fs = require('fs');

const _ = require('lodash');

const paths = require('./paths');

const ANON_TOKEN = 'ANON';
const PrinterType = {
  ARCHETYPE: 0,
  REAL: 1
};

class StoredPrintersManager {
  constructor() {
    this._savedPrinters = {};
    this._writingPromise = null;
    this._printersJsonNeedsUpdate = false;
    this._stopped = false;
  }

  setLogger(logger) {
    this._logger = logger;
  }

  getPrinter(uid) {
    return this._getRealPrinters()[uid] || this._getArchetypePrinters()[uid];
  }

  _isArchetype(uid) {
    return uid.split(':')[0] === 'offline';
  }

  _getRealPrinters() {
    return this._savedPrinters.realPrinters;
  }

  _getArchetypePrinters() {
    return this._savedPrinters.archetypes;
  }

  getUserPrinters(token) {
    return this._getPrintersForToken(token, PrinterType.REAL);
  }

  getAnonymousPrinters() {
    return this._getPrintersForToken(null, PrinterType.REAL);
  }

  getArchetypePrinters(token) {
    return this._getPrintersForToken(token, PrinterType.ARCHETYPE);
  }

  _getPrintersForToken(token, realOrArchetype) {
    const printerIds = [];

    if (!token) {
      if (realOrArchetype === PrinterType.REAL) {
        // real printers in printers.json that have an authInfo attached
        // to them, which should only be stored if they had been authenticated
        // to with no logged in user
        const printers = this._getRealPrinters();

        for (const uid in printers) {
          if (printers[uid].authInfo) printerIds.push(uid);
        }

        return printerIds;
      } else {
        token = ANON_TOKEN;
      }
    } // printers in printers.json that have the given user token attached to them


    const printers = realOrArchetype === PrinterType.REAL ? this._getRealPrinters() : this._getArchetypePrinters();

    for (const uid in printers) {
      const userTokens = printers[uid].userTokens;
      if (userTokens && userTokens.indexOf(token) !== -1) printerIds.push(uid);
    }

    return printerIds;
  }

  _getPrinterListFile() {
    const subFolder = paths.getConfigDir() + (process.platform == 'win32' ? '\\printers.json' : '/printers.json');
    return subFolder;
  }

  loadSavedPrinters() {
    const self = this;
    const readFile = q.denodeify(fs.readFile);
    return readFile(self._getPrinterListFile()).catch(function (err) {
      // If printer.json does not exist, return {};
      // warning here: We're banking on that the printers.json will
      // then get created when it gets written on upgrade -- ie. it
      // won't get created until the next request to write if it doesn't
      // upgrade. It is very unlikely that that will be the case, and
      // this._savedPrinters, which is what we actually care about, will
      // be correct, so it shouldn't be a problem -- but in case any
      // strange behavior crops up because of this...
      if (err.code !== 'ENOENT') throw err;
      return '{}';
    }).then(function (data) {
      try {
        self._savedPrinters = JSON.parse(data);
      } catch (err) {
        if (err.name === 'SyntaxError') self._logger.warn('Failed to parse printers.json');
      }

      if (self._upgradePrintersJson()) self._writeToPrinterJSON();
    });
  }

  _upgradePrintersJson() {
    // nice place to put all format changes to printers.json
    let updated = false; // as of PEN-1057: store both real printers and archetypes in printers.json

    if (!this._savedPrinters.realPrinters && !this._savedPrinters.archetypes) {
      this._savedPrinters = {
        realPrinters: this._savedPrinters,
        archetypes: {}
      };
      updated = true;
    }

    return updated;
  }

  _writeToPrinterJSON() {
    if (this._stopped) {
      this._logger.warn('Stored printers manager is stopped; ignoring write');

      return;
    }

    if (this._isWriting) throw 'Already writing to printers.json!';

    const file = this._getPrinterListFile();

    const writeFile = q.denodeify(fs.writeFile);

    const doWrite = () => {
      this._printersJsonNeedsUpdate = false;
      return writeFile(file, JSON.stringify(this._savedPrinters, null, '\t')).then(() => {
        this._logger.log('Updated stored printer data'); // if more updates got added while we were waiting for write to
        // finish, write again


        if (this._printersJsonNeedsUpdate) return doWrite();
      });
    };

    this._writingPromise = doWrite();
    return this._writingPromise;
  }

  _updatePrintersJson() {
    this._printersJsonNeedsUpdate = true;

    if (!this._isWriting) {
      try {
        fs.mkdirSync(paths.getConfigDir());
      } catch (e) {
        // Folder already existing is not a fail case, overlook
        if (e.code != 'EEXIST') throw e;
      }

      return this._writeToPrinterJSON();
    } else {
      return q();
    }
  }

  removePrinterForUser(uid, token) {
    let savedInfo;
    if (this._isArchetype(uid)) savedInfo = this._getArchetypePrinters()[uid];else savedInfo = this._getRealPrinters()[uid];

    if (savedInfo) {
      if (this._isArchetype(uid) && !token) token = ANON_TOKEN;

      if (token) {
        const tokens = savedInfo.userTokens;
        const index = tokens.indexOf(token);

        if (index != -1) {
          tokens.splice(index, 1);
        }
      } else {
        delete this._getRealPrinters()[uid].authInfo;
      } // remove from printers.json if this printer no longer belongs to anyone


      if ((!savedInfo.userTokens || !savedInfo.userTokens.length) && !savedInfo.authInfo) {
        // hopefully it will never be the case that we may have archetypes
        // and real printers with the same id...
        delete this._getRealPrinters()[uid];
        delete this._getArchetypePrinters()[uid];
      }

      this._updatePrintersJson().done();
    }
  }

  updateStoredInfo(printerInfo, machineConfig, authInfo, userToken) {
    // only write if something we're storing changed
    const savedInfo = this._getRealPrinters()[printerInfo.uid];

    const savedInfoCopy = Object.assign({}, savedInfo || {
      printer_info: {}
    }); // this is pretty janky looking, but I blame it on how js handles objects....

    savedInfoCopy.printer_info = {
      uid: printerInfo.uid || savedInfoCopy.printer_info.uid,
      name: printerInfo.name || savedInfoCopy.printer_info.name,
      address: printerInfo.address || savedInfoCopy.printer_info.address,
      info: printerInfo.info || savedInfoCopy.printer_info.info
    };
    if (machineConfig) savedInfoCopy.machineConfig = machineConfig;

    if (userToken) {
      savedInfoCopy.userTokens = _.union(savedInfoCopy.userTokens, [userToken]);
    } else if (authInfo) {
      savedInfoCopy.authInfo = authInfo;
    }

    if (JSON.stringify(savedInfo) !== JSON.stringify(savedInfoCopy)) {
      this._getRealPrinters()[printerInfo.uid] = savedInfoCopy;
      return this._updatePrintersJson();
    } else {
      return q();
    }
  }

  storeArchetype(printerId, vendor, gender, userToken) {
    let savedInfo = this._getArchetypePrinters()[printerId];

    if (!savedInfo) {
      savedInfo = {
        vendor,
        gender,
        userTokens: []
      };
      this._getArchetypePrinters()[printerId] = savedInfo;
    }

    if (!userToken) userToken = ANON_TOKEN;

    const tokens = _.union(savedInfo.userTokens, [userToken]);

    if (tokens.length != savedInfo.userTokens.length) {
      savedInfo.userTokens = tokens;
      return this._updatePrintersJson();
    } else {
      return q();
    }
  }

  stop() {
    return this._writingPromise.then(() => {
      this._stopped = true;
    });
  }

  get _isWriting() {
    return this._writingPromise && this._writingPromise.isPending();
  }

}

module.exports = StoredPrintersManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN0b3JlZF9wcmludGVyc19tYW5hZ2VyLmpzIl0sIm5hbWVzIjpbInEiLCJyZXF1aXJlIiwiZnMiLCJfIiwicGF0aHMiLCJBTk9OX1RPS0VOIiwiUHJpbnRlclR5cGUiLCJBUkNIRVRZUEUiLCJSRUFMIiwiU3RvcmVkUHJpbnRlcnNNYW5hZ2VyIiwiY29uc3RydWN0b3IiLCJfc2F2ZWRQcmludGVycyIsIl93cml0aW5nUHJvbWlzZSIsIl9wcmludGVyc0pzb25OZWVkc1VwZGF0ZSIsIl9zdG9wcGVkIiwic2V0TG9nZ2VyIiwibG9nZ2VyIiwiX2xvZ2dlciIsImdldFByaW50ZXIiLCJ1aWQiLCJfZ2V0UmVhbFByaW50ZXJzIiwiX2dldEFyY2hldHlwZVByaW50ZXJzIiwiX2lzQXJjaGV0eXBlIiwic3BsaXQiLCJyZWFsUHJpbnRlcnMiLCJhcmNoZXR5cGVzIiwiZ2V0VXNlclByaW50ZXJzIiwidG9rZW4iLCJfZ2V0UHJpbnRlcnNGb3JUb2tlbiIsImdldEFub255bW91c1ByaW50ZXJzIiwiZ2V0QXJjaGV0eXBlUHJpbnRlcnMiLCJyZWFsT3JBcmNoZXR5cGUiLCJwcmludGVySWRzIiwicHJpbnRlcnMiLCJhdXRoSW5mbyIsInB1c2giLCJ1c2VyVG9rZW5zIiwiaW5kZXhPZiIsIl9nZXRQcmludGVyTGlzdEZpbGUiLCJzdWJGb2xkZXIiLCJnZXRDb25maWdEaXIiLCJwcm9jZXNzIiwicGxhdGZvcm0iLCJsb2FkU2F2ZWRQcmludGVycyIsInNlbGYiLCJyZWFkRmlsZSIsImRlbm9kZWlmeSIsImNhdGNoIiwiZXJyIiwiY29kZSIsInRoZW4iLCJkYXRhIiwiSlNPTiIsInBhcnNlIiwibmFtZSIsIndhcm4iLCJfdXBncmFkZVByaW50ZXJzSnNvbiIsIl93cml0ZVRvUHJpbnRlckpTT04iLCJ1cGRhdGVkIiwiX2lzV3JpdGluZyIsImZpbGUiLCJ3cml0ZUZpbGUiLCJkb1dyaXRlIiwic3RyaW5naWZ5IiwibG9nIiwiX3VwZGF0ZVByaW50ZXJzSnNvbiIsIm1rZGlyU3luYyIsImUiLCJyZW1vdmVQcmludGVyRm9yVXNlciIsInNhdmVkSW5mbyIsInRva2VucyIsImluZGV4Iiwic3BsaWNlIiwibGVuZ3RoIiwiZG9uZSIsInVwZGF0ZVN0b3JlZEluZm8iLCJwcmludGVySW5mbyIsIm1hY2hpbmVDb25maWciLCJ1c2VyVG9rZW4iLCJzYXZlZEluZm9Db3B5IiwiT2JqZWN0IiwiYXNzaWduIiwicHJpbnRlcl9pbmZvIiwiYWRkcmVzcyIsImluZm8iLCJ1bmlvbiIsInN0b3JlQXJjaGV0eXBlIiwicHJpbnRlcklkIiwidmVuZG9yIiwiZ2VuZGVyIiwic3RvcCIsImlzUGVuZGluZyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLENBQUMsR0FBR0MsT0FBTyxDQUFDLEdBQUQsQ0FBakI7O0FBQ0EsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFDQSxNQUFNRSxDQUFDLEdBQUdGLE9BQU8sQ0FBQyxRQUFELENBQWpCOztBQUVBLE1BQU1HLEtBQUssR0FBR0gsT0FBTyxDQUFDLFNBQUQsQ0FBckI7O0FBRUEsTUFBTUksVUFBVSxHQUFHLE1BQW5CO0FBQ0EsTUFBTUMsV0FBVyxHQUFHO0FBQ2hCQyxFQUFBQSxTQUFTLEVBQUUsQ0FESztBQUVoQkMsRUFBQUEsSUFBSSxFQUFFO0FBRlUsQ0FBcEI7O0FBS0EsTUFBTUMscUJBQU4sQ0FBNEI7QUFDeEJDLEVBQUFBLFdBQVcsR0FBRztBQUNWLFNBQUtDLGNBQUwsR0FBc0IsRUFBdEI7QUFDQSxTQUFLQyxlQUFMLEdBQXVCLElBQXZCO0FBQ0EsU0FBS0Msd0JBQUwsR0FBZ0MsS0FBaEM7QUFFQSxTQUFLQyxRQUFMLEdBQWdCLEtBQWhCO0FBQ0g7O0FBRURDLEVBQUFBLFNBQVMsQ0FBQ0MsTUFBRCxFQUFTO0FBQ2QsU0FBS0MsT0FBTCxHQUFlRCxNQUFmO0FBQ0g7O0FBRURFLEVBQUFBLFVBQVUsQ0FBQ0MsR0FBRCxFQUFNO0FBQ1osV0FBTyxLQUFLQyxnQkFBTCxH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aWN0JztcclxuXHJcbmNvbnN0IHEgPSByZXF1aXJlKCdxJyk7XHJcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcclxuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xyXG5cclxuY29uc3QgcGF0aHMgPSByZXF1aXJlKCcuL3BhdGhzJyk7XHJcblxyXG5jb25zdCBBTk9OX1RPS0VOID0gJ0FOT04nO1xyXG5jb25zdCBQcmludGVyVHlwZSA9IHtcclxuICAgIEFSQ0hFVFlQRTogMCxcclxuICAgIFJFQUw6IDEsXHJcbn07XHJcblxyXG5jbGFzcyBTdG9yZWRQcmludGVyc01hbmFnZXIge1xyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5fc2F2ZWRQcmludGVycyA9IHt9O1xyXG4gICAgICAgIHRoaXMuX3dyaXRpbmdQcm9taXNlID0gbnVsbDtcclxuICAgICAgICB0aGlzLl9wcmludGVyc0pzb25OZWVkc1VwZGF0ZSA9IGZhbHNlO1xyXG5cclxuICAgICAgICB0aGlzLl9zdG9wcGVkID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0TG9nZ2VyKGxvZ2dlcikge1xyXG4gICAgICAgIHRoaXMuX2xvZ2dlciA9IGxvZ2dlcjtcclxuICAgIH1cclxuXHJcbiAgICBnZXRQcmludGVyKHVpZCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9nZXRSZWFsUHJpbnRlcnMoKVt1aWRdIHx8IHRoaXMuX2dldEFyY2hldHlwZVByaW50ZXJzKClbdWlkXTtcclxuICAgIH1cclxuXHJcbiAgICBfaXNBcmNoZXR5cGUodWlkKSB7XHJcbiAgICAgICAgcmV0dXJuIHVpZC5zcGxpdCgnOicpWzBdID09PSAnb2ZmbGluZSc7XHJcbiAgICB9XHJcblxyXG4gICAgX2dldFJlYWxQcmludGVycygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fc2F2ZWRQcmludGVycy5yZWFsUHJpbnRlcnM7XHJcbiAgICB9XHJcblxyXG4gICAgX2dldEFyY2hldHlwZVByaW50ZXJzKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9zYXZlZFByaW50ZXJzLmFyY2hldHlwZXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VXNlclByaW50ZXJzKHRva2VuKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFByaW50ZXJzRm9yVG9rZW4odG9rZW4sIFByaW50ZXJUeXBlLlJFQUwpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEFub255bW91c1ByaW50ZXJzKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9nZXRQcmludGVyc0ZvclRva2VuKG51bGwsIFByaW50ZXJUeXBlLlJFQUwpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEFyY2hldHlwZVByaW50ZXJzKHRva2VuKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFByaW50ZXJzRm9yVG9rZW4odG9rZW4sIFByaW50ZXJUeXBlLkFSQ0hFVFlQRSk7XHJcbiAgICB9XHJcblxyXG4gICAgX2dldFByaW50ZXJzRm9yVG9rZW4odG9rZW4sIHJlYWxPckFyY2hldHlwZSkge1xyXG4gICAgICAgIGNvbnN0IHByaW50ZXJJZHMgPSBbXTtcclxuXHJcbiAgICAgICAgaWYgKCF0b2tlbikge1xyXG4gICAgICAgICAgICBpZiAocmVhbE9yQXJjaGV0eXBlID09PSBQcmludGVyVHlwZS5SRUFMKSB7XHJcbiAgICAgICAgICAgICAgICAvLyByZWFsIHByaW50ZXJzIGluIHByaW50ZXJzLmpzb24gdGhhdCBoYXZlIGFuIGF1dGhJbmZvIGF0dGFjaGVkXHJcbiAgICAgICAgICAgICAgICAvLyB0byB0aGVtLCB3aGljaCBzaG91bGQgb25seSBiZSBzdG9yZWQgaWYgdGhleSBoYWQgYmVlbiBhdXRoZW50aWNhdGVkXHJcbiAgICAgICAgICAgICAgICAvLyB0byB3aXRoIG5vIGxvZ2dlZCBpbiB1c2VyXHJcbiAgICAgICAgICAgICAgICBjb25zdCBwcmludGVycyA9IHRoaXMuX2dldFJlYWxQcmludGVycygpO1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCB1aWQgaW4gcHJpbnRlcnMpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocHJpbnRlcnNbdWlkXS5hdXRoSW5mbykgcHJpbnRlcklkcy5wdXNoKHVpZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJpbnRlcklkcztcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRva2VuID0gQU5PTl9UT0tFTjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gcHJpbnRlcnMgaW4gcHJpbnRlcnMuanNvbiB0aGF0IGhhdmUgdGhlIGdpdmVuIHVzZXIgdG9rZW4gYXR0YWNoZWQgdG8gdGhlbVxyXG4gICAgICAgIGNvbnN0IHByaW50ZXJzID0gcmVhbE9yQXJjaGV0eXBlID09PSBQcmludGVyVHlwZS5SRUFMID8gdGhpcy5fZ2V0UmVhbFByaW50ZXJzKCkgOiB0aGlzLl9nZXRBcmNoZXR5cGVQcmludGVycygpO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IHVpZCBpbiBwcmludGVycykge1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyVG9rZW5zID0gcHJpbnRlcnNbdWlkXS51c2VyVG9rZW5zO1xyXG4gICAgICAgICAgICBpZiAodXNlclRva2VucyAmJiB1c2VyVG9rZW5zLmluZGV4T2YodG9rZW4pICE9PSAtMSkgcHJpbnRlcklkcy5wdXNoKHVpZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBwcmludGVySWRzO1xyXG4gICAgfVxyXG5cclxuICAgIF9nZXRQcmludGVyTGlzdEZpbGUoKSB7XHJcbiAgICAgICAgY29uc3Qgc3ViRm9sZGVyID0gcGF0aHMuZ2V0Q29uZmlnRGlyKCkgKyAocHJvY2Vzcy5wbGF0Zm9ybSA9PSAnd2luMzInID8gJ1xcXFxwcmludGVycy5qc29uJyA6ICcvcHJpbnRlcnMuanNvbicpO1xyXG4gICAgICAgIHJldHVybiBzdWJGb2xkZXI7XHJcbiAgICB9XHJcblxyXG4gICAgbG9hZFNhdmVkUHJpbnRlcnMoKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlYWRGaWxlID0gcS5kZW5vZGVpZnkoZnMucmVhZEZpbGUpO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVhZEZpbGUoc2VsZi5fZ2V0UHJpbnRlckxpc3RGaWxlKCkpXHJcbiAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcclxuICAgICAgICAgICAgICAgIC8vIElmIHByaW50ZXIuanNvbiBkb2VzIG5vdCBleGlzdCwgcmV0dXJuIHt9O1xyXG4gICAgICAgICAgICAgICAgLy8gd2FybmluZyBoZXJlOiBXZSdyZSBiYW5raW5nIG9uIHRoYXQgdGhlIHByaW50ZXJzLmpzb24gd2lsbFxyXG4gICAgICAgICAgICAgICAgLy8gdGhlbiBnZXQgY3JlYXRlZCB3aGVuIGl0IGdldHMgd3JpdHRlbiBvbiB1cGdyYWRlIC0tIGllLiBpdFxyXG4gICAgICAgICAgICAgICAgLy8gd29uJ3QgZ2V0IGNyZWF0ZWQgdW50aWwgdGhlIG5leHQgcmVxdWVzdCB0byB3cml0ZSBpZiBpdCBkb2Vzbid0XHJcbiAgICAgICAgICAgICAgICAvLyB1cGdyYWRlLiBJdCBpcyB2ZXJ5IHVubGlrZWx5IHRoYXQgdGhhdCB3aWxsIGJlIHRoZSBjYXNlLCBhbmRcclxuICAgICAgICAgICAgICAgIC8vIHRoaXMuX3NhdmVkUHJpbnRlcnMsIHdoaWNoIGlzIHdoYXQgd2UgYWN0dWFsbHkgY2FyZSBhYm91dCwgd2lsbFxyXG4gICAgICAgICAgICAgICAgLy8gYmUgY29ycmVjdCwgc28gaXQgc2hvdWxkbid0IGJlIGEgcHJvYmxlbSAtLSBidXQgaW4gY2FzZSBhbnlcclxuICAgICAgICAgICAgICAgIC8vIHN0cmFuZ2UgYmVoYXZpb3IgY3JvcHMgdXAgYmVjYXVzZSBvZiB0aGlzLi4uXHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyLmNvZGUgIT09ICdFTk9FTlQnKSB0aHJvdyBlcnI7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3t9JztcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBzZWxmLl9zYXZlZFByaW50ZXJzID0gSlNPTi5wYXJzZShkYXRhKTtcclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIubmFtZSA9PT0gJ1N5bnRheEVycm9yJykgc2VsZi5fbG9nZ2VyLndhcm4oJ0ZhaWxlZCB0byBwYXJzZSBwcmludGVycy5qc29uJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoc2VsZi5fdXBncmFkZVByaW50ZXJzSnNvbigpKSBzZWxmLl93cml0ZVRvUHJpbnRlckpTT04oKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgX3VwZ3JhZGVQcmludGVyc0pzb24oKSB7XHJcbiAgICAgICAgLy8gbmljZSBwbGFjZSB0byBwdXQgYWxsIGZvcm1hdCBjaGFuZ2VzIHRvIHByaW50ZXJzLmpzb25cclxuICAgICAgICBsZXQgdXBkYXRlZCA9IGZhbHNlO1xyXG5cclxuICAgICAgICAvLyBhcyBvZiBQRU4tMTA1Nzogc3RvcmUgYm90aCByZWFsIHByaW50ZXJzIGFuZCBhcmNoZXR5cGVzIGluIHByaW50ZXJzLmpzb25cclxuICAgICAgICBpZiAoIXRoaXMuX3NhdmVkUHJpbnRlcnMucmVhbFByaW50ZXJzICYmICF0aGlzLl9zYXZlZFByaW50ZXJzLmFyY2hldHlwZXMpIHtcclxuICAgICAgICAgICAgdGhpcy5fc2F2ZWRQcmludGVycyA9IHtcclxuICAgICAgICAgICAgICAgIHJlYWxQcmludGVyczogdGhpcy5fc2F2ZWRQcmludGVycyxcclxuICAgICAgICAgICAgICAgIGFyY2hldHlwZXM6IHt9LFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB1cGRhdGVkID0gdHJ1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB1cGRhdGVkO1xyXG4gICAgfVxyXG5cclxuICAgIF93cml0ZVRvUHJpbnRlckpTT04oKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX3N0b3BwZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLndhcm4oJ1N0b3JlZCBwcmludGVycyBtYW5hZ2VyIGlzIHN0b3BwZWQ7IGlnbm9yaW5nIHdyaXRlJyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLl9pc1dyaXRpbmcpIHRocm93ICdBbHJlYWR5IHdyaXRpbmcgdG8gcHJpbnRlcnMuanNvbiEnO1xyXG5cclxuICAgICAgICBjb25zdCBmaWxlID0gdGhpcy5fZ2V0UHJpbnRlckxpc3RGaWxlKCk7XHJcbiAgICAgICAgY29uc3Qgd3JpdGVGaWxlID0gcS5kZW5vZGVpZnkoZnMud3JpdGVGaWxlKTtcclxuXHJcbiAgICAgICAgY29uc3QgZG9Xcml0ZSA9ICgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5fcHJpbnRlcnNKc29uTmVlZHNVcGRhdGUgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB3cml0ZUZpbGUoZmlsZSwgSlNPTi5zdHJpbmdpZnkodGhpcy5fc2F2ZWRQcmludGVycywgbnVsbCwgJ1xcdCcpKS50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5sb2coJ1VwZGF0ZWQgc3RvcmVkIHByaW50ZXIgZGF0YScpO1xyXG4gICAgICAgICAgICAgICAgLy8gaWYgbW9yZSB1cGRhdGVzIGdvdCBhZGRlZCB3aGlsZSB3ZSB3ZXJlIHdhaXRpbmcgZm9yIHdyaXRlIHRvXHJcbiAgICAgICAgICAgICAgICAvLyBmaW5pc2gsIHdyaXRlIGFnYWluXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcHJpbnRlcnNKc29uTmVlZHNVcGRhdGUpIHJldHVybiBkb1dyaXRlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMuX3dyaXRpbmdQcm9taXNlID0gZG9Xcml0ZSgpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLl93cml0aW5nUHJvbWlzZTtcclxuICAgIH1cclxuXHJcbiAgICBfdXBkYXRlUHJpbnRlcnNKc29uKCkge1xyXG4gICAgICAgIHRoaXMuX3ByaW50ZXJzSnNvbk5lZWRzVXBkYXRlID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLl9pc1dyaXRpbmcpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGZzLm1rZGlyU3luYyhwYXRocy5nZXRDb25maWdEaXIoKSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIC8vIEZvbGRlciBhbHJlYWR5IGV4aXN0aW5nIGlzIG5vdCBhIGZhaWwgY2FzZSwgb3Zlcmxvb2tcclxuICAgICAgICAgICAgICAgIGlmIChlLmNvZGUgIT0gJ0VFWElTVCcpIHRocm93IGU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl93cml0ZVRvUHJpbnRlckpTT04oKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gcSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVQcmludGVyRm9yVXNlcih1aWQsIHRva2VuKSB7XHJcbiAgICAgICAgbGV0IHNhdmVkSW5mbztcclxuICAgICAgICBpZiAodGhpcy5faXNBcmNoZXR5cGUodWlkKSkgc2F2ZWRJbmZvID0gdGhpcy5fZ2V0QXJjaGV0eXBlUHJpbnRlcnMoKVt1aWRdO1xyXG4gICAgICAgIGVsc2Ugc2F2ZWRJbmZvID0gdGhpcy5fZ2V0UmVhbFByaW50ZXJzKClbdWlkXTtcclxuXHJcbiAgICAgICAgaWYgKHNhdmVkSW5mbykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5faXNBcmNoZXR5cGUodWlkKSAmJiAhdG9rZW4pIHRva2VuID0gQU5PTl9UT0tFTjtcclxuICAgICAgICAgICAgaWYgKHRva2VuKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0b2tlbnMgPSBzYXZlZEluZm8udXNlclRva2VucztcclxuICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdG9rZW5zLmluZGV4T2YodG9rZW4pO1xyXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ICE9IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fZ2V0UmVhbFByaW50ZXJzKClbdWlkXS5hdXRoSW5mbztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyByZW1vdmUgZnJvbSBwcmludGVycy5qc29uIGlmIHRoaXMgcHJpbnRlciBubyBsb25nZXIgYmVsb25ncyB0byBhbnlvbmVcclxuICAgICAgICAgICAgaWYgKCghc2F2ZWRJbmZvLnVzZXJUb2tlbnMgfHwgIXNhdmVkSW5mby51c2VyVG9rZW5zLmxlbmd0aCkgJiYgIXNhdmVkSW5mby5hdXRoSW5mbykge1xyXG4gICAgICAgICAgICAgICAgLy8gaG9wZWZ1bGx5IGl0IHdpbGwgbmV2ZXIgYmUgdGhlIGNhc2UgdGhhdCB3ZSBtYXkgaGF2ZSBhcmNoZXR5cGVzXHJcbiAgICAgICAgICAgICAgICAvLyBhbmQgcmVhbCBwcmludGVycyB3aXRoIHRoZSBzYW1lIGlkLi4uXHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fZ2V0UmVhbFByaW50ZXJzKClbdWlkXTtcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9nZXRBcmNoZXR5cGVQcmludGVycygpW3VpZF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5fdXBkYXRlUHJpbnRlcnNKc29uKCkuZG9uZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVTdG9yZWRJbmZvKHByaW50ZXJJbmZvLCBtYWNoaW5lQ29uZmlnLCBhdXRoSW5mbywgdXNlclRva2VuKSB7XHJcbiAgICAgICAgLy8gb25seSB3cml0ZSBpZiBzb21ldGhpbmcgd2UncmUgc3RvcmluZyBjaGFuZ2VkXHJcbiAgICAgICAgY29uc3Qgc2F2ZWRJbmZvID0gdGhpcy5fZ2V0UmVhbFByaW50ZXJzKClbcHJpbnRlckluZm8udWlkXTtcclxuICAgICAgICBjb25zdCBzYXZlZEluZm9Db3B5ID0gT2JqZWN0LmFzc2lnbih7fSwgc2F2ZWRJbmZvIHx8IHsgcHJpbnRlcl9pbmZvOiB7fSB9KTtcclxuXHJcbiAgICAgICAgLy8gdGhpcyBpcyBwcmV0dHkgamFua3kgbG9va2luZywgYnV0IEkgYmxhbWUgaXQgb24gaG93IGpzIGhhbmRsZXMgb2JqZWN0cy4uLi5cclxuICAgICAgICBzYXZlZEluZm9Db3B5LnByaW50ZXJfaW5mbyA9IHtcclxuICAgICAgICAgICAgdWlkOiBwcmludGVySW5mby51aWQgfHwgc2F2ZWRJbmZvQ29weS5wcmludGVyX2luZm8udWlkLFxyXG4gICAgICAgICAgICBuYW1lOiBwcmludGVySW5mby5uYW1lIHx8IHNhdmVkSW5mb0NvcHkucHJpbnRlcl9pbmZvLm5hbWUsXHJcbiAgICAgICAgICAgIGFkZHJlc3M6IHByaW50ZXJJbmZvLmFkZHJlc3MgfHwgc2F2ZWRJbmZvQ29weS5wcmludGVyX2luZm8uYWRkcmVzcyxcclxuICAgICAgICAgICAgaW5mbzogcHJpbnRlckluZm8uaW5mbyB8fCBzYXZlZEluZm9Db3B5LnByaW50ZXJfaW5mby5pbmZvLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmIChtYWNoaW5lQ29uZmlnKSBzYXZlZEluZm9Db3B5Lm1hY2hpbmVDb25maWcgPSBtYWNoaW5lQ29uZmlnO1xyXG4gICAgICAgIGlmICh1c2VyVG9rZW4pIHtcclxuICAgICAgICAgICAgc2F2ZWRJbmZvQ29weS51c2VyVG9rZW5zID0gXy51bmlvbihzYXZlZEluZm9Db3B5LnVzZXJUb2tlbnMsIFt1c2VyVG9rZW5dKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGF1dGhJbmZvKSB7XHJcbiAgICAgICAgICAgIHNhdmVkSW5mb0NvcHkuYXV0aEluZm8gPSBhdXRoSW5mbztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChKU09OLnN0cmluZ2lmeShzYXZlZEluZm8pICE9PSBKU09OLnN0cmluZ2lmeShzYXZlZEluZm9Db3B5KSkge1xyXG4gICAgICAgICAgICB0aGlzLl9nZXRSZWFsUHJpbnRlcnMoKVtwcmludGVySW5mby51aWRdID0gc2F2ZWRJbmZvQ29weTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByaW50ZXJzSnNvbigpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBxKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHN0b3JlQXJjaGV0eXBlKHByaW50ZXJJZCwgdmVuZG9yLCBnZW5kZXIsIHVzZXJUb2tlbikge1xyXG4gICAgICAgIGxldCBzYXZlZEluZm8gPSB0aGlzLl9nZXRBcmNoZXR5cGVQcmludGVycygpW3ByaW50ZXJJZF07XHJcbiAgICAgICAgaWYgKCFzYXZlZEluZm8pIHtcclxuICAgICAgICAgICAgc2F2ZWRJbmZvID0ge1xyXG4gICAgICAgICAgICAgICAgdmVuZG9yLFxyXG4gICAgICAgICAgICAgICAgZ2VuZGVyLFxyXG4gICAgICAgICAgICAgICAgdXNlclRva2VuczogW10sXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRoaXMuX2dldEFyY2hldHlwZVByaW50ZXJzKClbcHJpbnRlcklkXSA9IHNhdmVkSW5mbztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghdXNlclRva2VuKSB1c2VyVG9rZW4gPSBBTk9OX1RPS0VOO1xyXG5cclxuICAgICAgICBjb25zdCB0b2tlbnMgPSBfLnVuaW9uKHNhdmVkSW5mby51c2VyVG9rZW5zLCBbdXNlclRva2VuXSk7XHJcbiAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggIT0gc2F2ZWRJbmZvLnVzZXJUb2tlbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHNhdmVkSW5mby51c2VyVG9rZW5zID0gdG9rZW5zO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlUHJpbnRlcnNKc29uKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHEoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc3RvcCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fd3JpdGluZ1Byb21pc2UudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX3N0b3BwZWQgPSB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBfaXNXcml0aW5nKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl93cml0aW5nUHJvbWlzZSAmJiB0aGlzLl93cml0aW5nUHJvbWlzZS5pc1BlbmRpbmcoKTtcclxuICAgIH1cclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBTdG9yZWRQcmludGVyc01hbmFnZXI7XHJcbiJdfQ==
